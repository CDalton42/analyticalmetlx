<div class="lift:surround?with=unstyledDefaultWebMeTL;at=content">
	<script data-lift="with-resource-id" src="static/js/carota-debug.js"></script>
	<script data-lift="with-resource-id" src="static/js/historyRenderer.js"></script>
	<script data-lift="with-resource-id" src="static/js/InteractableCanvas.js"></script>
	<script src="static/js/stable/Tween.js"></script>
	<script type="text/javascript">
		var mockInk = {
			type:"ink",
			timestamp:2,
			identity:"2",
			thickness:5,
			points:[50,50,50,100,100,50,100,50,50,50,50,50],
			color:["000000",255],
			isHighlighter:false,
			target:"presentationSpace",
			author:"test",
			privacy:"PUBLIC"
		};
		var mockText = {
			type:"text",
			timestamp:1,
			identity:"1",
			x:20,
			y:20,
			width:100,
			height:30,
			color:["000000",255],
			text:"what about this",
			font:"arial",
			size:12,
			weight:"regular",
			style:"normal",
			target:"presentationSpace",
			author:"test",
			privacy:"PUBLIC"
		};
		var mockImage = {
			type:"image",
			timestamp:3,
			identity:"3",
			x:10,
			y:10,
			width:160,
			height:120,
			target:"presentationSpace",
			author:"test",
			privacy:"PUBLIC",
			source:"/static/images/insert.png"
		};
		var mockHistory = {
			type:"history",
			inks:{},
			highlighters:{},
			texts:{},
			multiWordTexts:{},
			images:{},
			videos:{}
		};
		mockHistory.inks[mockInk.identity] = mockInk;
		mockHistory.texts[mockText.identity] = mockText;
		mockHistory.images[mockImage.identity] = mockImage;
		var stanzas = [mockText,mockInk,mockImage];
		$(function(){
			var newCanvas = createInteractiveCanvas($("#board"));
			/*
			newCanvas.setImageSourceCalculationFunction(function(image){
				var slide = image.privacy.toUpperCase() == "PRIVATE" ? sprintf("%s%s",image.slide,image.author) : image.slide;
				return sprintf("/proxyImageUrl/%s?source=%s",urlEncodeSlideName(slide),encodeURIComponent(image.source.trim()));
			});
			newCanvas.setVideoSourceCalculationFunction(function(video){
				var slide = video.privacy.toUpperCase() == "PRIVATE" ? sprintf("%s%s",video.slide,video.author) : video.slide;
				return sprintf("/videoProxy/%s/%s",urlEncodeSlideName(slide),encodeURIComponent(video.identity.trim()));
			});
			*/
			newCanvas.onSelectionChanged(function(selected){
				MeTLBus.call("selectionChanged",[selected]);
			});
			newCanvas.onModeChanged(function(mode){
				$(".subTools").hide();
				$(".modeButton").removeClass("activeMode");
				switch (mode.name){
					case "zoom":
						$("#setZoomMode").addClass("activeMode");
						$("#zoomTools").show();
						break;
					case "pan":
						$("#setPanMode").addClass("activeMode");
						$("#panTools").show();
						break;
					case "draw":
						$("#setDrawMode").addClass("activeMode");
						var color = mode.getColor();
						var isHighlighter = mode.getIsHighlighter();
						var size = mode.getSize();
						$("#inkWidth").val(size);
						$("#inkColor").val(color);
						$("#isHighlighter").val(isHighlighter);
						$("#drawTools").show();
						break;
					case "pan":
						$("#setEraseMode").addClass("activeMode");
						$("#eraseTools").show();
						break;
					default:
						break;	 
				}
			});
			$("#setZoomMode").on("click",function(){
				newCanvas.setMode(_.find(newCanvas.getAvailableModes(),function(m){return m.name == "zoom";}));
			});
			$("#setPanMode").on("click",function(){
				newCanvas.setMode(_.find(newCanvas.getAvailableModes(),function(m){return m.name == "pan";}));
			});
			$("#setDrawMode").on("click",function(){
				newCanvas.setMode(_.find(newCanvas.getAvailableModes(),function(m){return m.name == "draw";}));
			});
			$("#inkColor").on("change",function(e){
				var value = $(this).val();
				console.log("changing color:",value,this,e);
				var drawMode = _.find(newCanvas.getAvailableModes(),function(m){return m.name == "draw"});
				drawMode.setColor(value);
				//newCanvas.setMode(drawMode);
			});
			$("#inkWidth").on("change",function(e){
				var value = $(this).val();
				console.log("changing size:",value,this,e);
				var drawMode = _.find(newCanvas.getAvailableModes(),function(m){return m.name == "draw"});
				drawMode.setSize(value);
				//newCanvas.setMode(drawMode);
			});
			$("#isHighlighter").on("click",function(e){
				var value = $(this).prop("checked");
				var drawMode = _.find(newCanvas.getAvailableModes(),function(m){return m.name == "draw"});
				drawMode.setIsHighlighter(value);
				//newCanvas.setMode(drawMode);
			});
			$("#setEraseMode").on("click",function(){
				newCanvas.setMode(_.find(newCanvas.getAvailableModes(),function(m){return m.name == "erase";}));
			});
			$("#zoomIn").on("click",function(){
				newCanvas.getZoomController().in();
			});
			$("#zoomOut").on("click",function(){
				newCanvas.getZoomController().out();
			});
			var panAmount = 50;
			$("#panLeft").on("click",function(){
				newCanvas.getPanController().pan(-1 * panAmount,0);
			});
			$("#panRight").on("click",function(){
				newCanvas.getPanController().pan(panAmount,0);
			});
			$("#panUp").on("click",function(){
				newCanvas.getPanController().pan(0,-1 * panAmount);
			});
			$("#panDown").on("click",function(){
				newCanvas.getPanController().pan(0,panAmount);
			});
			newCanvas.setMode(_.find(newCanvas.getAvailableModes(),function(m){return m.name == "draw";}));
			newCanvas.onStatistic(function(category,time,success,exception){
				if ("HealthChecker" in window){
					HealthChecker.addMeasure(category,time,success);
				}
			});
			newCanvas.onError(function(exception,caller,params){
				console.log("InteractiveCanvasException",caller,exception,params);
			});
			newCanvas.onPreRenderItem(function(item,ctx){
				return true;
			});
			newCanvas.onPostRenderItem(function(item,ctx){
			});
			window.InteractiveCanvas = newCanvas;
			newCanvas.onStanzaAvailable(function(stanza){
				stanza.author = "testUser";
				stanza.privacy = "PUBLIC";
				stanza.target = "presentationSpace";
				stanza.slide = "thisSlide";
				console.log("test.html stanza:",stanza);
				stanzas.push(stanza);
				newCanvas.addStanza(stanza);
			});
			newCanvas.setHistory(mockHistory);
			newCanvas.setDimensions(DeviceConfiguration.getMeasurements());
			MeTLBus.subscribe("beforeWorkQueueResume","test",function(){});
			MeTLBus.subscribe("afterWorkQueuePause","test",function(){});
			MeTLBus.subscribe("layoutUpdated","test",function(dims){
				newCanvas.setDimensions(dims);
			});
		});
		var popAudit = function(){
			var allStanzas = escape(JSON.stringify(stanzas));
			var windowContent = "<html><script src=\"/static/assets/js/vendor/jquery.min.js\"><\/script><script src=\"static/js/stable/sprintf-0.7-beta1.js\"><\/script><script src=\"static/js/stable/lodash.js\"><\/script><script src=\"static/js/carota-debug.js\"><\/script><script src=\"static/js/historyRenderer.js\"><\/script><script type=\"text/javascript\"> var renderer = undefined; var allStanzas = JSON.parse(unescape(\""+allStanzas+"\")); $(function(){renderer = createCanvasRenderer($(\"#view\")); renderer.setDimensions({width:640,height:480}); var reRender = function(stanzas){renderer.setHistory({ inks:{}, highlighters:{}, images:{}, videos:{}, texts:{}, multiWordTexts:{} }); _.forEach(stanzas,function(s){ renderer.addStanza(s); }); }; $(\"#slider\").attr(\"min\",0).attr(\"max\",_.size(allStanzas)).val(_.size(allStanzas)).on(\"change\",function(){ var val = $(this).val();  var stanzas = _.take(allStanzas,val); reRender(stanzas);}).focus(); reRender(allStanzas); console.log(\"rendered\",soFar,renderer); }); <\/script><body><input type=\"range\" width=\"640\" id=\"slider\"><\/input><canvas id=\"view\"><\/canvas><\/body><\/html>";
			var win = window.open();
			win.document.open();
			win.document.write(windowContent);
			win.document.close();
		};
	</script>
	<div class="lift:embed?what=_canvas"></div>
</div>
