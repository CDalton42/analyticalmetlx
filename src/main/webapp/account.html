<div class="lift:surround?with=unstyledDefaultWebMeTL;at=content">
  <script src="static/js/stable/sprintf-0.7-beta1.js"></script>
  <script src="static/js/stable/clipboard.min.js"></script>
  <script src="static/js/stable/lodash.js"></script>
  <script src="static/js/stable/jquery.ui.widget.js"></script>
  <script src="static/js/stable/jquery.iframe-transport.js"></script>
  <script src="static/js/stable/jquery.fileupload.js"></script>
  <script src="static/js/stable/d3.v4.min.js"></script>
  <script src="static/js/stable/d3.layout.cloud.js"></script>
  <link rel="stylesheet" href="static/css/jAlert.css"></link>
  <script src="static/js/stable/jAlert.min.js"></script>
  <script src="static/js/stable/jAlert-functions.min.js"></script>
  <script src="static/js/stable/jsgrid.min.js" data-lift="with-resource-id"></script>
  <link rel="stylesheet" href="static/css/jsgrid.min.css"></link>
  <link rel="stylesheet" href="static/css/jsgrid-theme.min.css"></link>
  <script data-lift="with-resource-id" src="static/js/stable/moment.min.js"></script>
  <script data-lift="with-resource-id" src="static/js/collections.js"></script>
  <script data-lift="with-resource-id" src="static/js/profile.js"></script>
	<script type="text/javascript">
		var Account = (function(){
			var profileContainer = undefined;
			var profileTemplate = undefined;
			var availableProfiles = [];
			var account = undefined;
			var currentProfile = undefined;
			var defaultProfile = undefined;

			var reRenderUI = function(){
				if (account){
					$("#accountProvider").text(account.accountProvider);
					$("#accountName").text(account.accountName);
				}
				profileContainer.html(_.map(availableProfiles,function(prof){
					var profId = prof.id;
					var rootElem = profileTemplate.clone();				
					rootElem.find(".profileName").text(prof.name);
					rootElem.find(".profileId").text(profId);
					rootElem.find(".isDefaultLabel").attr("for",profId + "_isDefaultCheckbox");
					rootElem.find(".isDefault").attr("id",profId + "_isDefaultCheckbox").prop("checked",profId == defaultProfile).change(function(){
						var newValue = $(this).is(":checked");
						if (newValue && profId != defaultProfile){
							setDefaultProfile(profId);
						} else {
							reRenderUI();
						}
					});
					rootElem.find(".isActiveLabel").attr("for",prof.id + "_isActiveCheckbox");
					rootElem.find(".isActive").attr("id",profId + "_isActiveCheckbox").prop("checked",profId == currentProfile).change(function(){
						var newValue = $(this).is(":checked");
						if (newValue && profId != currentProfile){
							switchToProfile(profId);
						} else {
							reRenderUI();
						}
					});
					rootElem.find(".editProfileLink").attr("href","/profile?profileId="+profId);
					var imageSrc = prof.attributes.avatarUrl;
					if (imageSrc === undefined || imageSrc == ""){
						imageSrc = sprintf("http://api.adorable.io/avatars/285/%s.png",profId); 
					}
					rootElem.find(".profileImage").attr("src",imageSrc);
					return rootElem;
				}));
			};
			$(function(){
				profileContainer = $("#profileContainer");
				profileTemplate = profileContainer.find(".profile").clone();
				profileContainer.empty();
				reRenderUI();
				$("#createProfile").bind("click",function(){createProfile();});
			});
			MeTLBus.subscribe("receiveCurrentProfile","account",function(prof){
				console.log("received current: ",prof);
				currentProfile = prof.id;
				reRenderUI();
			});
			MeTLBus.subscribe("receiveProfiles","account",function(profiles){
				availableProfiles = profiles;
				reRenderUI();
			});
			MeTLBus.subscribe("receiveDefaultProfile","account",function(profId){
				console.log("received default: ",profId);
				defaultProfile = profId;
				reRenderUI();
			});
			MeTLBus.subscribe("receiveAccount","account",function(acc){
				console.log("received account: ",acc);
				account = acc;
				reRenderUI();
			});
			return {
				getAvailableProfiles:function(){ return availableProfiles; },
				getCurrentProfile:function(){ return currentProfile; },											 
				getDefaultProfile:function(){ return defaultProfile; },											 
				getAccount:function(){ return account; }											 
			};
		})();

	</script>
	<style>
#accountContainer {
	background:white;
}
.profileImage {
	width:200px;
}
	</style>
	<div id="accountContainer">
		<div id="accountProvider"></div>
		<div id="accountName"></div>
		<div id="profileContainer">
			<div class="profile">
				<span class="profileName"></span>
				<span class="profileId"></span>
				<img class="profileImage"></span>
				<input type="checkbox" class="isActive"></input>
				<label class="isActiveLabel">active</label>
				<input type="checkbox" class="isDefault"></span>
				<label class="isDefaultLabel">default</label>
				<a class="editProfileLink">edit</a>
			</div>
		</div>
		<input type="button" id="createProfile"></input>
	</div>
	<div class="lift:Metl.account"></div>
</div>
