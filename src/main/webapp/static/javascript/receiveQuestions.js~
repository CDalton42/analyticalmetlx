var items = {}
var types = {}
var parents = {}
var standings = {}
var replayables = []
var replayableItems = {}
var replayableTypes = {}

function updateStandings(ss){
    for(var s in ss){
        standings[clean(s)] = ss[s];
    }
}
var voteCount = 0
function preProcessVotes(post){
    post.votes.forEach(function(v){
        v.id = v.time
        v.creationDate = v.time
        parents[v.id] = post.id
        replayableItems[v.id] = v
        replayableTypes[v.id] = "vote"
    })
}
function preProcessComment(c,a){
    preProcessVotes(c)
    parents[c.id] = a.id
    replayableItems[c.id] = c
    replayableTypes[c.id] = "comment"
    c.comments.map(function(_c){preProcessComment(_c,c)})
}
var receivePolicy = 0
function receiveQuestions(qs){
    _.defer(function(){
        switch(receivePolicy){
        case 0:
            $(document).off("previewOnQuestion")
            doReceiveQuestionsShort(qs)
            break;
        case 1:
            doReceiveQuestionsShort(qs)
            break;
        case 2:
            doReceiveQuestionsLong(qs)
            break;
        }
        renderBlendedTimeline();
    });
}
function doReceiveQuestionsShort(qs){
    qs.forEach(doReceiveQuestion)
    var seedType = "topic"
    trunk.pushAll(seedType,_.keys(categories[seedType]),seedType)
}
function doReceiveQuestionsLong(qs){
    replayableItems = {}
    replay = qs
    qs.forEach(function(q){
        preProcessVotes(q)
        replayableTypes[q.id] = "question"
        q.answers.forEach(function(a){
            preProcessVotes(a)
            replayableItems[a.id] = a
            parents[a.id] = q.id
            replayableTypes[a.id] = "answer"
            a.comments.forEach(function(c){
                preProcessComment(c,a)
            })
            a.comments = []
            a.votes = []
        })
        q.answers = []
        q.votes = []
        replayableItems[q.id] = q
    })
    sorted = _.values(replayableItems).sort(function(a,b){return a.creationDate - b.creationDate})
    sorted.reverse()
    function report(q){
        doReceiveQuestion(q)
    }
    setInterval(function(){
        if(sorted.length > 0){
            var s = sorted.pop()
            var t = replayableTypes[s.id]
            switch(t){
            case "question":
                report(s)
                break;
            case "answer":
                var q = replayableItems[parents[s.id]]
                q.answers.push(s)
                report(q)
                break;
            case "comment":
                var p = replayableItems[parents[s.id]]
                p.comments.push(s)
                while(p.id in parents && replayableTypes[p.id] != "question"){
                    p = replayableItems[parents[p.id]]
                }
                if(p){
                    report(p)
                }
                else{
                    console.log("Could not find parent for",s)
                }
                break;
            case "vote":
                var p = replayableItems[parents[s.id]]
                p.votes.push(s)
                sorted.push(p)
                break;
            }
        }
    },10)
}
function receiveQuestion(q){
    _.defer(function(){doReceiveQuestion(q)});
}
function recordAuthor(a){
    categoriesOfWork["author"](a,{id:a})
    items[a] = {
        integer:standings[a] || 0,
        standing:standing(standings[a]),
        id:a
    }
}
function doReceiveQuestion(q){
    $(document).trigger("previewOnQuestion",[q])
    items[q.id] = q;
    var recordVotes = function(post){
        post.votes.map(function(v){
            v.id = sprintf("%s%s",v.author,v.time)
            items[v.id] = v
            parents[v.id] = post.id
            categoriesOfWork["vote"](v.id,v)
            recordAuthor(v.author)
        })
    }
    var recordComments = function(c,parent){
        items[c.id] = c
        parents[c.id] = parent.id
        categoriesOfWork["comment"](c.id,c)
        recordAuthor(c.discussion.author)
        recordVotes(c)
        c.comments.map(function(c1){
            recordComments(c1,c)
        });
    }
    if(!(q.teachingEvent in items)){
        items[q.teachingEvent] = {
            id:q.teachingEvent,
            final:q,
            questions:[]
        }
    }
    else{
        items[q.teachingEvent].questions.push(q)
    }
    categoriesOfWork["topic"](q.teachingEvent,items[q.teachingEvent])
    categoriesOfWork["question"](q.id,q)
    recordAuthor(q.discussion.author)
    recordVotes(q)
    q.answers.map(function(a){
        items[a.id] = a
        parents[a.id] = q.id
        categoriesOfWork["answer"](a.id,a)
        recordAuthor(a.discussion.author)
        a.comments.map(function(c){recordComments(c,a)})
        recordVotes(a)
    })
    $(document).trigger("onQuestion",[q])
}
