var Plugins=function(){return{Chat:function(){var d={},k={},b={},r={},f=sprintf("chatbox_%s",_.uniqueId()),t=$("<div />",{id:f}),m=function(a,b,c,e){e=r.clone();UserSettings.getUsername();var l=e.find(".chatMessageAuthor");l.text(a.author);e.find(".chatMessageTimestamp").text((new Date(a.timestamp)).toISOString());var g=e.find(".chatMessageContent");switch(a.contentType){case "text":g.text(a.content);break;case "html":g.html(a.content)}if(b&&c)switch(b){case "whisperTo":g.addClass("whisper");l.text(sprintf("to %s",
c));break;case "whisperFrom":g.addClass("whisper");l.text(sprintf("from %s",c));break;case "groupChatTo":g.addClass("groupChat");l.text(sprintf("to %s",c));break;case "groupChatFrom":g.addClass("groupChat"),l.text(sprintf("from %s",c))}return e},h=function(a){if(a&&"type"in a&&"chatMessage"==a.type&&"identity"in a&&!(a.identity in d)){d[a.identity]=a;var n=UserSettings.getUsername(),c=_.flatten(_.flatten(_.map(Conversations.getCurrentConversation().slides,function(a){return _.map(a.groupSets,function(a){return a.groups})})));
boardContent.chatMessages.push(a);if(a.audiences.length){var e=_.find(a.audiences,function(a){return"user"==a.type||"group"==a.type});a.author==n?e&&"user"==e.type?(b.append(m(a,"whisperTo",e.name)),b.scrollTop(b[0].scrollHeight)):e&&"group"==e.type&&(b.append(m(a,"groupChatTo",e.name)),b.scrollTop(b[0].scrollHeight)):e&&"user"==e.type&&e.name==n?(b.append(m(a,"whisperFrom",a.author)),b.scrollTop(b[0].scrollHeight)):e&&"group"==e.type&&_.some(c,function(a){return a.name==e.name&&_.some(a.members,
function(a){return a.name==n})})&&(b.append(m(a,"groupChatFrom",a.author,e.name)),b.scrollTop(b[0].scrollHeight))}else b.append(m(a)),b.scrollTop(b[0].scrollHeight)}},p=function(a){_.forEach(a.chatMessages,h)},q=function(a){if(a&&a.length){var b=[],c;if(a.startsWith("/w"))if(c=a.split(" "),c.length&&2<=c.length)b.push({domain:"metl",name:c[1],type:"user",action:"read"}),c=_.drop(c,2).join(" ");else return a;else if(a.startsWith("/g"))if(c=a.split(" "),c.length&&2<=c.length)b.push({domain:"metl",name:c[1],
type:"group",action:"read"}),c=_.drop(c,2).join(" ");else return a;else c=a;a=sendStanza;var e=UserSettings.getUsername(),l=Conversations.getCurrentSlideJid(),g=(new Date).getTime(),d=sprintf("%s_%s_%s",e,l,g),b={type:"chatMessage",author:e,timestamp:g,identity:d,contentType:"text",content:c,context:l,audiences:b||[]};console.log("created chat message:",b);a(b);return""}return a};return{style:".chatMessage {color:white}.chatMessageContainer {background:black; overflow-y:auto; height:110px;}.chatContainer {width:320px;height:140px;}.chatMessageAuthor {color:gray; background:black;margin-right:1em;}.chatMessageTimestamp {color:red; background:black; font-size:small;display:none;}.chatMessageContent {background:black}.chatboxContainer {background:black}.chatbox {background:white; color:black; display:inline-block; padding:0px; margin:0px;}.chatboxSend {display:inline-block; background:white; color:black; padding:0px; margin:0px;}.groupChat {color:orange}.whisper {color:pink}",
load:function(a,b){a.stanzaReceived.Chatbox=h;a.historyReceived.Chatbox=p;t.append('<div class="chatContainer" ><div class="chatMessageContainer" ><div class="chatMessage" ><span class="chatMessageTimestamp" ></span><span class="chatMessageAuthor" ></span><span class="chatMessageContent"></span></div></div><div class="chatboxContainer"><input type="text" class="chatbox"></input><button class="chatboxSend">Send</button></div></div>');return t},initialize:function(){k=$("#"+f);b=k.find(".chatMessageContainer");
r=b.find(".chatMessage").clone();b.empty();var a=k.find(".chatboxContainer .chatbox").on("keydown",function(a){13==a.keyCode&&(a=$(this),a.val(q(a.val())))});k.find(".chatboxContainer .chatboxSend").on("click",function(){a.val(q(a.val()))})}}}(),"Face to face":function(){var d=$("<div />");return{style:".publishedStream {background:green;} .subscribedStream {background:red;} .videoConfStartButton, .videoConfSubscribeButton {background:white;margin:1px;} .videoConfSessionContainer, .videoConfStartButtonContainer, .videoConfContainer{display:flex;} .videoConfStartButtonContainer{flex-direction:row;} .videoConfStartButton{padding:0 1em;font-size:1rem;} #videoConfSessionsContainer{display:flex;} .videoConfSessionContainer{width:160px;flex-direction:column;} .context{font-size:1rem;} .broadcastContainer{display:none;}",
load:function(k,b){d.append('<span id="videoConfSessionsContainer"><div class="videoConfSessionContainer"><div class="videoConfStartButtonContainer"><button class="videoConfStartButton"><div>Start sending</div></button><span class="context"></span></div><div class="viewscreen"></div><div class="broadcastContainer"><a class="floatingToolbar btn-menu fa fa-television btn-icon broadcastLink"><div class="icon-txt">Watch class</div></a></div><div class="videoSubscriptionsContainer"></div><div class="videoConfContainer"><span class="videoContainer"><button class="floatingToolbar btn-menu fa fa-television btn-icon videoConfSubscribeButton"><div class="icon-txt">Receive</div></button></span></div></div></span>');
return d},initialize:TokBox.initialize}}(),Groups:function(){var d=$("<div />"),k=function(b,d,f){b=$("<button />",{"class":sprintf("%s btn-icon fa",b),click:f});$("<div />",{"class":"icon-txt",text:d}).appendTo(b);return b};return{style:".groupsPluginMember{margin-left:0.5em;} .groupsPluginGroupContainer{display:flex;margin-right:1em;} .groupsPluginGroupContainer .icon-txt, .groupsPluginAllGroupsControls .icon-txt, .groupsPluginAllGroupsControls .fa{color:white;} .groupsPluginGroup{display:inline-block;text-align:center;vertical-align:top;} .groupsPluginGroupGrade button, .groupsPluginGroupGrade .icon-txt{padding:0;color:white;margin-top:0;} .groupsPluginGroupControls button, .groupsPluginGroupControls .icon-txt{padding:0;color:white;margin-top:0;} .isolateGroup label{margin-top:1px;} .isolateGroup{margin-top:0.8em;} .memberCurrentGrade{color:black;background-color:white;margin-right:0.5em;padding:0 .5em;} .groupsPluginGroupControls{display:flex;} .groupsPluginGroupGrade{background-color:white;color:black;margin:2px;padding:0 0.3em;height:3em;display:inline;} .groupsPluginAllGroupsControls{margin-bottom:0.5em;border-bottom:0.5px solid white;padding-left:1em;display:flex;}",
load:function(b,r){var f=function(){try{d.empty();var b=Conversations.getCurrentGroups();if(Conversations.shouldModifyConversation()){var f=Conversations.getCurrentSlide();if(f&&b.length){var h=sprintf("groupWork_%s",f.id),p=_.find(Grades.getGrades(),function(a){return a.location==h});if(p)var q=Grades.getGradeValues()[p.id];$("<div />",{"class":"groupsPluginAllGroupsControls"}).append($("<input />",{type:"radio",name:"groupView",id:"showAll"}).click(function(){_.each(b,function(a){ContentFilter.setFilter(a.id,
!0)});ContentFilter.clearAudiences();blit()})).append($("<label />",{"for":"showAll"}).css({"flex-grow":0}).append($("<span />",{"class":"icon-txt",text:"Show all"}).css({"margin-top":"3px"}))).appendTo(d);var a=$("<div />").css({display:"flex"}).appendTo(d);_.each(b,function(c){var e=$("<div />",{"class":"groupsPluginGroupContainer"}).appendTo(a),d=$("<div />",{"class":"groupsPluginGroup"}).css({display:"block"});_.each(["A","B","C","D","F"],function(a){$("<div />",{text:a,"class":"groupsPluginGroupGrade"}).appendTo(d).on("click",
function(){void 0!=p&&_.each(c.members,function(b){b={type:"textGradeValue",gradeId:p.id,gradeValue:a,gradedUser:b,author:UserSettings.getUsername(),timestamp:0,audiences:[]};sendStanza(b)})})});var g=$("<div />").appendTo(e);$("<span />",{text:sprintf("Group %s",c.title),"class":"ml"}).appendTo(g);var f=$("<div />",{"class":"groupsPluginGroupControls"}).appendTo(g);k("fa-share-square","",function(){h.find("input").prop("checked",!0).change();console.log("Isolating and screenshotting",h);_.defer(Submissions.sendSubmission)}).appendTo(f);
var m=sprintf("isolateGroup_%s",c.title),h=$("<div />",{"class":"isolateGroup"}).append($("<input />",{type:"radio",name:"groupView",id:m}).change(function(){_.each(b,function(a){ContentFilter.setFilter(a.id,!1)});ContentFilter.setFilter(c.id,!0);ContentFilter.setAudience(c.id);blit()})).append($("<label />",{"for":m}).append($("<span />",{"class":"icon-txt",text:"Isolate"}).css({"margin-top":"5px"}))).appendTo(f),n=$("<div />",{"class":"groupsPluginGroup"}).prependTo(e);_.each(c.members,function(a){var b=
$("<div />",{text:a,"class":"groupsPluginMember"}).appendTo(n);q&&a in q&&$("<span />",{"class":"memberCurrentGrade",text:q[a].gradeValue}).prependTo(b)});d.appendTo(g)})}}else{var n=$("<div />").css({display:"flex"}).appendTo(d);console.log("Rendering student");_.each(b,function(a){console.log(a,Conversations.getCurrentGroup());if(_.find(Conversations.getCurrentGroup(),a)){var b=$("<div />",{"class":"groupsPluginGroupContainer"}).appendTo(n),d=$("<div />").appendTo(b);$("<span />",{text:sprintf("Group %s",
a.title),"class":"ml"}).appendTo(d);$("<div />",{"class":"groupsPluginGroupControls"}).appendTo(d);sprintf("isolateGroup_%s",a.title);var f=$("<div />",{"class":"groupsPluginGroup"}).prependTo(b);_.each(a.members,function(a){$("<div />",{text:a,"class":"groupsPluginMember"}).appendTo(f)})}})}}catch(c){console.log("Groups plugin render e",c)}};b.gradeValueReceived["Groups plugin"]=function(b){var d=sprintf("groupWork_%s",Conversations.getCurrentSlideJid()),h=_.find(Grades.getGrades(),function(b){return b.location==
d});h&&b.gradeId==h.id&&f()};b.currentSlideJidReceived["Groups plugin"]=f;b.conversationDetailsReceived["Groups plugin"]=f;return d},initialize:function(){}}}()}}();$(function(){var d=$("#pluginBar"),k=$("<style></style>").appendTo($("body"));_.each(Plugins,function(b,r){var f=$("<div />",{"class":"plugin"});b.load(Progress).appendTo(f);k.append(b.style);f.appendTo(d);b.initialize()})});
