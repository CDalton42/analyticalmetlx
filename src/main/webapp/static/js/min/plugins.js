var Plugins=function(){return{Chat:function(){var e={},h={},b={},m={},f=sprintf("chatbox_%s",_.uniqueId()),t=$("<div />",{id:f}),l=function(a,b,c,d){d=m.clone();UserSettings.getUsername();var k=d.find(".chatMessageAuthor");k.text(a.author);d.find(".chatMessageTimestamp").text((new Date(a.timestamp)).toISOString());var g=d.find(".chatMessageContent");switch(a.contentType){case "text":g.text(a.content);break;case "html":g.html(a.content)}if(b&&c)switch(b){case "whisperTo":g.addClass("whisper");k.text(sprintf("to %s",
c));break;case "whisperFrom":g.addClass("whisper");k.text(sprintf("from %s",c));break;case "groupChatTo":g.addClass("groupChat");k.text(sprintf("to %s",c));break;case "groupChatFrom":g.addClass("groupChat"),k.text(sprintf("from %s",c))}return d},n=function(a){if(a&&"type"in a&&"chatMessage"==a.type&&"identity"in a&&!(a.identity in e)){e[a.identity]=a;var r=UserSettings.getUsername(),c=_.flatten(_.flatten(_.map(Conversations.getCurrentConversation().slides,function(a){return _.map(a.groupSets,function(a){return a.groups})})));
boardContent.chatMessages.push(a);if(a.audiences.length){var d=_.find(a.audiences,function(a){return"user"==a.type||"group"==a.type});a.author==r?d&&"user"==d.type?(b.append(l(a,"whisperTo",d.name)),b.scrollTop(b[0].scrollHeight)):d&&"group"==d.type&&(b.append(l(a,"groupChatTo",d.name)),b.scrollTop(b[0].scrollHeight)):d&&"user"==d.type&&d.name==r?(b.append(l(a,"whisperFrom",a.author)),b.scrollTop(b[0].scrollHeight)):d&&"group"==d.type&&_.some(c,function(a){return a.name==d.name&&_.some(a.members,
function(a){return a.name==r})})&&(b.append(l(a,"groupChatFrom",a.author,d.name)),b.scrollTop(b[0].scrollHeight))}else b.append(l(a)),b.scrollTop(b[0].scrollHeight)}},p=function(a){_.forEach(a.chatMessages,n)},q=function(a){if(a&&a.length){var b=[],c;if(a.startsWith("/w"))if(c=a.split(" "),c.length&&2<=c.length)b.push({domain:"metl",name:c[1],type:"user",action:"read"}),c=_.drop(c,2).join(" ");else return a;else if(a.startsWith("/g"))if(c=a.split(" "),c.length&&2<=c.length)b.push({domain:"metl",name:c[1],
type:"group",action:"read"}),c=_.drop(c,2).join(" ");else return a;else c=a;a=sendStanza;var d=UserSettings.getUsername(),k=Conversations.getCurrentSlideJid(),g=(new Date).getTime(),u=sprintf("%s_%s_%s",d,k,g),b={type:"chatMessage",author:d,timestamp:g,identity:u,contentType:"text",content:c,context:k,audiences:b||[]};console.log("created chat message:",b);a(b);return""}return a};return{style:".chatMessageContainer {overflow-y:auto; flex-grow:1;}.chatContainer {margin-left:1em;width:320px;height:140px;display:flex;flex-direction:column;}.chatMessageAuthor {color:slategray;margin-right:1em;}.chatMessageTimestamp {color:red;font-size:small;display:none;}.chatboxContainer {display:flex;flex-direction:row;width:100%;flex-shrink:0;}.chatboxContainer input{flex-grow:1;}.chatbox {background-color:white;display:inline-block; padding:0px; margin:0px;}.chatboxSend {display:inline-block; background:white;padding:0px; margin:0px;}.groupChat {color:darkorange}.whisper {color:darkblue}",
load:function(a,b){a.stanzaReceived.Chatbox=n;a.historyReceived.Chatbox=p;t.append('<div class="chatContainer" ><div class="chatMessageContainer" ><div class="chatMessage" ><span class="chatMessageTimestamp" ></span><span class="chatMessageAuthor" ></span><span class="chatMessageContent"></span></div></div><div class="chatboxContainer"><input type="text" class="chatbox"></input><button class="chatboxSend">Send</button></div></div>');return t},initialize:function(){h=$("#"+f);b=h.find(".chatMessageContainer");
m=b.find(".chatMessage").clone();b.empty();var a=h.find(".chatboxContainer .chatbox").on("keydown",function(a){13==a.keyCode&&(a=$(this),a.val(q(a.val())))});h.find(".chatboxContainer .chatboxSend").on("click",function(){a.val(q(a.val()))})}}}(),"Face to face":function(){var e=$("<div />");return{style:".publishedStream {background:green;} .subscribedStream {background:red;} .videoConfStartButton, .videoConfSubscribeButton, .videoConfPermitStudentBroadcastButton {background:white;margin:1px 0;} .videoConfSessionContainer, .videoConfStartButtonContainer, .videoConfContainer, .videoConfPermitStudentBroadcastContainer{display:flex;} .videoConfStartButtonContainer, .videoConfPermitStudentBroadcastContainer{flex-direction:row;} .videoConfStartButton, .videoConfPermitStudentBroadcastButton{padding:0 1em;font-size:1rem;} #videoConfSessionsContainer{display:flex;} .videoContainer{display:flex;} .context, .publisherName{font-size:1rem;} .thumbWide{width:160px;} .broadcastContainer{display:none;}",
load:function(h,b){e.append('<span id="videoConfSessionsContainer"><div class="videoConfSessionContainer"><div><div class="videoConfStartButtonContainer" style="margin-bottom:-0.3em"><button class="videoConfStartButton"><div>Start sending</div></button><span class="context mr"></span><span style="display:none;" class="teacherControls mr"><input type="checkbox" id="canBroadcast"><label for="canBroadcast" class="checkbox-sim"><span class="icon-txt">Students can stream</span></label></span></div><div class="viewscreen"></div></div><div class="broadcastContainer"><a class="floatingToolbar btn-menu fa fa-television btn-icon broadcastLink"><div class="icon-txt">Watch class</div></a></div><div class="videoSubscriptionsContainer"></div><div class="videoConfContainer"><span class="videoContainer thumbWide"><button class="videoConfSubscribeButton"><div>Toggle</div></button><span class="publisherName"></span></span></div></div></span>');
return e},initialize:TokBox.initialize}}(),Groups:function(){var e=$("<div />"),h=function(b,e,f){b=$("<button />",{"class":sprintf("%s btn-icon fa",b),click:f});$("<div />",{"class":"icon-txt",text:e}).appendTo(b);return b};return{style:".groupsPluginMember{margin-left:0.5em;display:flex;} .groupsPluginGroupContainer{display:flex;margin-right:1em;} .groupsPluginGroup{display:inline-block;text-align:center;vertical-align:top;} .groupsPluginGroupGrade button, .groupsPluginGroupGrade .icon-txt{padding:0;margin-top:0;} .groupsPluginGroupControls button, .groupsPluginGroupControls .icon-txt{padding:0;margin-top:0;} .isolateGroup label{margin-top:1px;} .isolateGroup{margin-top:0.8em;} .memberCurrentGrade{background-color:white;margin-right:0.5em;padding:0 .5em;} .groupsPluginGroupControls{display:flex;} .groupsPluginGroupGrade{background-color:white;margin:2px;padding:0 0.3em;height:3em;display:inline;} .groupsPluginAllGroupsControls{margin-bottom:0.5em;border-bottom:0.5px solid white;padding-left:1em;display:flex;}",
load:function(b,m){var f=function(){try{e.empty();var b=Conversations.getCurrentGroups();if(Conversations.shouldModifyConversation()){var f=Conversations.getCurrentSlide();if(f&&b.length){var n=sprintf("groupWork_%s",f.id),p=_.find(Grades.getGrades(),function(a){return a.location==n});if(p)var q=Grades.getGradeValues()[p.id];var a=0;$("<div />",{"class":"groupsPluginAllGroupsControls"}).on("mousedown",function(){a=$("#masterFooter").scrollLeft()}).append($("<input />",{type:"radio",name:"groupView",
id:"showAll"}).prop("checked",!0).click(function(){_.each(b,function(a){ContentFilter.setFilter(a.id,!0)});ContentFilter.clearAudiences();blit();$("#masterFooter").scrollLeft(a)})).append($("<label />",{"for":"showAll"}).css({"flex-grow":0}).append($("<span />",{"class":"icon-txt",text:"Show all"}))).append(h("fa-share-square","Share all",function(){var a=_.map(ContentFilter.getFilters(),function(a){return _.cloneDeep(a)}),c=ContentFilter.getAudiences();_.forEach(b,function(a){ContentFilter.setFilter(a.id,
!1)});blit();var g=function(a,d){var c=a[0];c?(ContentFilter.setFilter(c.id,!0),ContentFilter.setAudience(c.id),blit(),_.defer(function(){Submissions.sendSubmission(function(b){b?(ContentFilter.setFilter(c.id,!1),blit(),_.defer(function(){g(_.drop(a,1),d)})):errorAlert("Submission failed","Storing this submission failed.")})})):(successAlert("Submissions sent",sprintf("%s group submissions stored.  You can check them in the submissions tab.",_.size(b))),d())};_.defer(function(){g(b,function(){_.forEach(a,
function(a){ContentFilter.setFilter(a.id,a.enabled)});c.length?ContentFilter.setAudience(c[0]):ContentFilter.clearAudiences();blit()})})}).css({"margin-top":0})).appendTo(e);var r=$("<div />").css({display:"flex"}).appendTo(e);_.each(b,function(d){var c=$("<div />",{"class":"groupsPluginGroupContainer"}).appendTo(r),g=$("<div />",{"class":"groupsPluginGroup"}).css({display:"block"});_.each(["A","B","C","D","F"],function(a){$("<div />",{text:a,"class":"groupsPluginGroupGrade"}).appendTo(g).on("click",
function(){void 0!=p&&_.each(d.members,function(b){b={type:"textGradeValue",gradeId:p.id,gradeValue:a,gradedUser:b,author:UserSettings.getUsername(),timestamp:0,audiences:[]};sendStanza(b)})})});var e=$("<div />").appendTo(c),f=$("<div />",{"class":"groupsPluginGroupControls"}).appendTo(e);$("<span />",{text:sprintf("Group %s",d.title),"class":"ml"}).appendTo(e);h("fa-share-square","Share",function(){n.find("input").prop("checked",!0).change();_.defer(Submissions.sendSubmission)}).appendTo(f);var l=
sprintf("isolateGroup_%s",d.title),n=$("<div />",{"class":"isolateGroup"}).on("mousedown",function(){a=$("#masterFooter").scrollLeft()}).append($("<input />",{type:"radio",name:"groupView",id:l}).change(function(){Progress.call("beforeChangingAudience",[d.id]);_.each(b,function(a){ContentFilter.setFilter(a.id,!1)});ContentFilter.setFilter(d.id,!0);ContentFilter.setAudience(d.id);Modes.select.activate();blit();$("#masterFooter").scrollLeft(a)})).append($("<label />",{"for":l}).append($("<span />",
{"class":"icon-txt",text:"Isolate"}).css({"margin-top":"2px"}))).appendTo(f),m=$("<div />",{"class":"groupsPluginGroup"}).prependTo(c);_.each(d.members,function(a){var b=$("<div />",{text:a,"class":"groupsPluginMember"}).appendTo(m);q&&a in q&&$("<span />",{"class":"memberCurrentGrade",text:q[a].gradeValue}).prependTo(b)});g.appendTo(e)})}}else{var c=$("<div />").css({display:"flex"}).appendTo(e);_.each(b,function(a){if(_.find(Conversations.getCurrentGroup(),a)){var b=$("<div />",{"class":"groupsPluginGroupContainer"}).appendTo(c);
sprintf("isolateGroup_%s",a.title);var e=$("<div />").appendTo(b);_.each(a.members,function(a){$("<div />",{text:a}).appendTo(e)});$("<div />",{text:sprintf("Group %s",a.title)}).prependTo(e)}})}}catch(d){console.log("Groups plugin render e",d)}};b.gradeValueReceived["Groups plugin"]=function(b){var e=sprintf("groupWork_%s",Conversations.getCurrentSlideJid()),h=_.find(Grades.getGrades(),function(b){return b.location==e});h&&b.gradeId==h.id&&f()};b.currentSlideJidReceived["Groups plugin"]=f;b.conversationDetailsReceived["Groups plugin"]=
f;return e},initialize:function(){}}}()}}();$(function(){var e=$("#pluginBar"),h=$("<style></style>").appendTo($("body"));_.each(Plugins,function(b,m){var f=$("<div />",{"class":"plugin"});b.load(Progress).appendTo(f);h.append(b.style);f.appendTo(e);b.initialize()})});
