var Conversations=function(){var b="",q=[],m=void 0,n=void 0,r="",g=[],h=[],k={},f=void 0,t=!1,u=!1,l=[];$(function(){var a=function(a){jsGrid.Field.call(this,a)},e=function(a){jsGrid.Field.call(this,a)},c=function(a){jsGrid.Field.call(this,a)};a.prototype=new jsGrid.Field({sorter:function(a,c){return new Date(a)-new Date(c)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});
$("#onlyMyConversations").click(function(){t=$(this).is(":checked");d()});$("#includeDeleted").click(function(){u=$(this).is(":checked");d()});e.prototype=new jsGrid.Field({sorter:function(a,c){return 0},itemTemplate:function(a,c){if("importing"in c){var v=c.stageProgress.numerator,e=c.stageProgress.denominator,d=c.stageProgress.name;return $("<div/>").append($("<progress/>",{value:v,max:e,text:sprintf("%s out of %s",v,e)})).append($("<div/>",{text:d}))}return c.author==b?$("<a/>",{href:sprintf("/editConversation?conversationJid=%s",
c.jid),text:"Edit"}):""},insertTemplate:function(a){return""},editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});c.prototype=new jsGrid.Field({sorter:function(a,c){return 0},itemTemplate:function(a,c){if("importing"in c){var b=c.overallProgress.numerator,e=c.overallProgress.denominator,d=c.overallProgress.name;return $("<div/>").append($("<progress/>",{value:b,max:e,text:sprintf("%s out of %s",b,e)})).append($("<div/>",{text:d}))}return a},insertTemplate:function(a){return""},
editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;jsGrid.fields.editConversationField=e;jsGrid.fields.joinConversationField=function(a){jsGrid.Field.call(this,a)};jsGrid.fields.conversationSharingField=c;f=$("#conversationsDataGrid");f.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No conversations match your query",rowClick:function(a){"jid"in a.item&&!("importing"in a.item)&&
(window.location.href=sprintf("/board?conversationJid=%s&unique=true",a.item.jid))},controller:{loadData:function(a){if("sortField"in a){var c=_.sortBy(l,function(c){return c[a.sortField]});t&&(c=_.filter(c,function(a){return a.author==b}));"sortOrder"in a&&"desc"==a.sortOrder&&(c=_.reverse(c));return c}return l}},pageLoading:!1,fields:[{name:"lifecycle",type:"text",title:"Lifecycle",readOnly:!0,itemTemplate:function(a,c){var b=$("<span/>");switch(a){case "deleted":b.addClass("deletedConversationTag").text("archived");
break;case "new":b.addClass("newConversationTag").text("new");break;default:b.text("")}return b}},{name:"title",type:"text",title:"Title",readOnly:!0,itemTemplate:function(a,c){if("newConversation"in c&&1==c.newConversation){var b=$("<span/>");b.append($("<span/>",{"class":"newConversation",text:"new"}));b.append($("<span/>",{html:a}));console.log("newTag:",b.html().toString());return b}return a}},{name:"creation",type:"dateField",title:"Created"},{name:"author",type:"text",title:"Author",readOnly:!0},
{name:"subject",type:"conversationSharingField",title:"Sharing",readOnly:!0},{name:"edit",type:"editConversationField",title:"Edit",sorting:!1,width:30,css:"gridAction"}]});f.jsGrid("sort",{field:"creation",order:"desc"});$("#activeImportsListing").hide();$("#importConversationInputElementContainer").hide();$("#showImportConversationWorkflow").click(function(){$("#importConversationInputElement").click()});$("#importConversationInputElement").fileupload({dataType:"json",add:function(a,c){$("#importConversationProgress").css("width",
"0%");$("#importConversationProgressBar").show();$("#activeImportsListing").show();c.submit()},progressall:function(a,c){var b=parseInt(c.loaded/c.total*100,10)+"%";$("#importConversationProgressBar").css("width",b)},done:function(a,c){$.each(c.files,function(a,c){$("<p/>").text(c.name).appendTo(document.body)});$("#importConversationProgress").fadeOut()}});m=$("#conversationContainerListing");m.find(".conversationContainer").clone();m.empty();n=$("#activeImportsListing");n.find(".importContainer").clone();
n.empty();a=$("#conversationSearchBox");k=$("<input/>",{type:"text",val:r});a.append(k);k.on("keydown",function(a){var c=$(this).val();query=c;13==a.keyCode&&p(c)});$("#createConversationButton").on("click",function(){var a=sprintf("%s at %s",b,(new Date).toString());createConversation(a)});$("#searchButton").on("click",function(){p(query)})});var w=function(a){return("deleted"!=a.subject.toLowerCase().trim()||u&&a.author==b)&&(a.author==b||_.some(q,function(b){return b.value.toLowerCase().trim()==
a.subject.toLowerCase().trim()}))},d=function(){var a=_.filter(_.map(h,function(a){return"result"in a&&"a"in a.result?{importing:!0,title:sprintf("%s - %s - %s","import failure",a.name,a.a),author:a.author,jid:a.id,newConversation:!0,creation:(new Date).getTime(),overallProgress:a.overallProgress,stageProgress:a.stageProgress}:"result"in a&&"b"in a.result?(a=a.result.b,!("creation"in a)&&"created"in a&&_.isNumber(a.created)&&(a.creation=a.created,a.created=new Date(a.creation)),a.newConversation=
!0,a):{lifecycle:"new",importing:!0,title:a.name,author:a.author,jid:a.id,newConversation:!0,creation:(new Date).getTime(),overallProgress:a.overallProgress,stageProgress:a.stageProgress}}),function(a){return"importing"in a&&1==a.importing||!_.some(g,function(b){return b.jid==a.jid})}),b=(new Date).getTime()-18E5;l=_.map(_.concat(a,_.filter(g,w)),function(a){a.lifecycle="deleted"==a.subject?"deleted":a.creation>b?"new":"available";return a});void 0!=f&&(f.jsGrid("loadData"),a=f.jsGrid("getSorting"),
"field"in a&&f.jsGrid("sort",a));a=l;a=sprintf("%s result%s",a.length,1==a.length?"":"s");$("#conversationListing").find(".aggregateContainer").find(".count").text(a)},p=function(a){r=a;getSearchResult(a)};return{receiveUsername:function(a){b=a},receiveUserGroups:function(a){q=a},receiveConversationDetails:function(a){g=_.map(g,function(b){return b.jid==a.jid?(a.newConversation=b.newConversation,a):b});d()},receiveSearchResults:function(a){g=a;d()},receiveNewConversationDetails:function(a){a.newConversation=
!0;g.push(a);d()},receiveImportDescription:function(a){h=_.filter(h,function(b){return b.id!=a.id});h.push(a);d()},receiveImportDescriptions:function(a){h=a;d()},receiveQuery:function(a){query=a;k.val(a);d()},getConversationListing:function(){return listing},getImportListing:function(){return h},getQuery:function(){return query},search:p,create:function(a){createConversation(a)}}}();function serverResponse(b){}function receiveUsername(b){Conversations.receiveUsername(b)}
function receiveUserGroups(b){Conversations.receiveUserGroups(b)}function receiveConversationDetails(b){Conversations.receiveConversationDetails(b)}function receiveConversations(b){Conversations.receiveSearchResults(b)}function receiveNewConversationDetails(b){Conversations.receiveNewConversationDetails(b)}function receiveImportDescription(b){Conversations.receiveImportDescription(b)}function receiveImportDescriptions(b){Conversations.receiveImportDescriptions(b)}
function receiveQuery(b){Conversations.receiveQuery(b)};
