var RichText=function(){var m={},b={selected:[]},p=$("<canvas />")[0].getContext("2d"),r=function(a,c){a=a||b.y;var d=0,e=0,f,h,k=_.concat(c.head,c.tail),l=[];for(f=0;f<k.length;f++)if(h=k[f],!(h.y<b.y)){if(h.y>b.y)break;l.push(h)}for(f=0;f<l.length;f++)h=l[f],e=Math.max(e,h.height),d+=h.width;return{x:0<d?l[0].x:0,y:a,height:e,width:d,chars:l}},v=function(a){return function(c){var d;d=scaleWorldToScreen(c.fontSize);d=sprintf("%spt %s",Math.floor(d),c.fontFamily);a.font=d;d=worldToScreen(c.x,c.y);
var e=scaleWorldToScreen(c.width),f=scaleWorldToScreen(c.height);_.includes(b.selected,c)&&(a.fillStyle="yellow",a.fillRect(d.x,d.y-f,e,f));a.fillStyle=c.color;a.fillText(c["char"],d.x,d.y)}},q=function(a){for(var c=a.x,d=c,e=a.y,f=b.box.head[b.box.head.length-1],h=0,k=0,l=_.concat(a.head,a.tail),g,m=0,p=m,q=l.length-1,n=0;n<l.length;n++)g=l[n],g.identity==f.identity&&(q=n,p=m),g.x=d,g.y=e,g.bounds=[g.x,g.y-g.height,g.x+g.width,g.y]," "==g["char"]&&(k=n),"\n"==g["char"]?(h=k,d=c,e+=1.8*r(g.y,a).height,
g.x=d,g.y=e):28<n-h&&k!=h?(h=k,e+=1.8*r(g.y,a).height,d=c,n=k,m=Math.min(n,q)):d+=g.width;return l.slice(p)},t=function(a){_.includes(b.selected,a)?_.pull(b.selected,a):b.selected.push(a)},u=function(a,c,b,e){a={identity:e,author:b,head:[],tail:[],x:a,y:c};return m[a.identity]=a},w=function(a,c){var b=function(a){return a.identity==c.identity};_.remove(a.head,b);_.remove(a.tail,b);return a};return{scaleSelection:function(a){_.each(b.selected,function(c){c.fontSize*=a});q();blit()},setAttributes:function(a){var c=
a.fontSize;b.fontFamily=a.fontFamily||b.fontFamily;b.fontSize=c||b.fontSize;b.color=a.color;b.bold=a.bold;b.italic=a.italic;b.underline=a.underline;blit()},click:function(a){delete b.box;var c=[a.x-1,a.y-1,a.x+1,a.y+1];_.each(m,function(a){var e=_.concat(a.head,a.tail),f=!1;_.each(e,function(h,k){intersectRect(c,h.bounds)&&(b.box=a,a.head=e.slice(0,k+1),a.tail=e.slice(k+1,e.length),f=!0,blit());return!f});return!f});b.box||(a=u(a.x,a.y,UserSettings.getUsername(),sprintf("%s_%s_%s",UserSettings.getUsername(),
Date.now(),_.uniqueId())),b.box=a,b.x=a.x,b.y=a.y,blit())},incorporate:function(a){_.isArray(a.color)&&(a.color=a.color[0]);var c=m[a.box];c||(c=u(a.x,a.y,a.author,a.box),c.head=[],c.tail=[]);c!=b.box&&(w(c,a),c.tail.push(a));blit()},listen:function(a){$("#textInputInvisibleHost").off("keydown").on("keydown",function(a){var d=a.key;switch(d){case "Shift":break;case "Alt":break;case "Control":break;case "CapsLock":break;case "ArrowLeft":b.box.head.length&&(d=b.box.head.pop(),b.box.tail.unshift(d),
a.shiftKey&&t(d),blit());break;case "ArrowRight":b.box.tail.length&&(d=b.box.tail.shift(),b.box.head.push(d),a.shiftKey&&t(d),blit());break;case "Backspace":b.box.head.length&&(b.box.head.pop(),d=q(b.box),blit(),sendChars(d,b.box.identity));break;case "Escape":b.selected=[];blit();break;case "Delete":b.box.tail.length&&(b.box.tail.shift(),d=q(b.box),blit(),sendChars(d,b.box.identity));break;default:if(d="Enter"==d?"\n":d,!(1<d.length)){a={"char":d,fontSize:b.fontSize,fontFamily:b.fontFamily,color:b.color,
x:b.x,y:b.y,box:b.box.identity};a.identity=sprintf("%s@%s,%s",a["char"],a.x,a.y);var e=b.box.head[b.box.head.length-1];b.box.head.push(a);p.font=sprintf("%spt %s",Math.floor(a.fontSize),a.fontFamily);d=Math.floor(parseFloat(a.fontSize));e=e?p.measureText([e["char"],a["char"]].join("")).width-p.measureText(e["char"]).width:p.measureText(a["char"]).width;switch(a["char"]){case "\n":e=0}a.width=e;a.height=d;d=q(b.box);b.x=a.bounds[2];b.y=a.bounds[3];blit();sendChars(d,b.box.identity)}}}).focus()},clear:function(){m=
{};blit()},render:function(a){_.each(m,function(c){var d=v(a);_.each(c.head,d);_.each(c.tail,d);if(c==b.box){a.fillStyle=b.color;var e=c.head.length?c.head[c.head.length-1]:{x:c.x,y:c.y,width:0,height:b.fontSize};c=worldToScreen(e.x,e.y);var d=scaleWorldToScreen(3),f=scaleWorldToScreen(e.width),e=scaleWorldToScreen(e.height);a.fillRect(c.x+f,c.y-e,d,1.5*e)}})},cursor:function(){return b}}}();
