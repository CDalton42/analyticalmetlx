(function(){(function(f){var l,g,d,m,e,b={".js":[],".json":[],".css":[],".html":[]},c="function"===typeof require?require:null;m=function(a){a=Error("Could not find module '"+a+"'");a.code="MODULE_NOT_FOUND";return a};e=function(a,c,k){var e,h;if("function"===typeof a[c+k])return c+k;for(e=0;h=b[k][e];++e)if("function"===typeof a[c+h])return c+h;return null};l=function(a,c,b,d,h,f){var p,u;b=b.split(/[\\/]/);p=b.pop();if("."===p||".."===p)b.push(p),p="";for(;null!=(u=b.shift());)if(u&&"."!==u&&(".."===
u?(a=c.pop(),f=f.slice(0,f.lastIndexOf("/"))):(c.push(a),a=a[u],f+="/"+u),!a))throw m(d);p&&"function"!==typeof a[p]&&((b=e(a,p,".js"))||(b=e(a,p,".json")),b||(b=e(a,p,".css")),b||(b=e(a,p,".html")),b?p=b:2!==h&&"object"===typeof a[p]&&(c.push(a),a=a[p],f+="/"+p,p=""));if(!p)return 1!==h&&a[":mainpath:"]?l(a,c,a[":mainpath:"],d,1,f):l(a,c,"index",d,2,f);h=a[p];if(!h)throw m(d);if(h.hasOwnProperty("module"))return h.module.exports;d={};h.module=p={exports:d,id:f+"/"+p};h.call(d,d,p,g(a,c,f));return p.exports};
d=function(a,b,k,e){var d,g=k;d=k.charAt(0);var p=0;if("/"===d){g=g.slice(1);a=f["/"];if(!a){if(c)return c(k);throw m(k);}e="/";b=[]}else if("."!==d){d=g.split("/",1)[0];a=f[d];if(!a){if(c)return c(k);throw m(k);}e=d;b=[];g=g.slice(d.length+1);g||((g=a[":mainpath:"])?p=1:(g="index",p=2))}return l(a,b,g,k,p,e)};g=function(a,c,b){return function(e){return d(a,[].concat(c),e,b)}};return g(f,[],"")})({carota:{src:{"carota.js":function(f,l,g){f=g("./node");var d=g("./editor"),m=g("./doc"),e=g("./dom"),
b=g("./runs"),c=g("./html"),a=g("./frame"),n=g("./text");g=g("./rect");g={node:f,editor:d,document:m,dom:e,runs:b,html:c,frame:a,text:n,rect:g};l.exports=g;if("undefined"!==typeof window&&window.document){if(window.carota)throw Error("Something else is called carota!");window.carota=g}},"characters.js":function(f,l,g){function d(a,b,k){return Object.create(c,{_runs:{value:a},_run:{value:b},_offset:{value:k},"char":{value:b>=a.length?null:e.getTextChar(a[b].text,k)}})}function m(a,c){for(;c<a.length;c++)if(0!=
e.getTextLength(a[c].text))return d(a,c,0);return d(a,a.length,0)}var e=g("./runs"),b=function(a,c){if(a._runs!==c._runs)throw Error("Characters for different documents");},c={equals:function(a){b(this,a);return this._run===a._run&&this._offset===a._offset},cut:function(a){b(this,a);var c=this;return function(b){for(var d=c._run;d<=a._run;d++){var h=c._runs[d];if(h){var f=d===c._run?c._offset:0,m=d===a._run?a._offset:e.getTextLength(h.text);f<m&&e.getSubText(function(a){var c=Object.create(h);c.text=
a;b(c)},h.text,f,m-f)}}}}};l.exports=function(a){return function(c){for(var b=m(a,0);!c(b)&&null!==b["char"];)b=b._offset+1<e.getTextLength(a[b._run].text)?d(a,b._run,b._offset+1):m(a,b._run+1)}}},"codes.js":function(f,l,g){var d=g("./text"),m=g("./frame"),e=g("./node"),b=g("./rect"),c=g("./util"),a=e.derive({parent:function(){return this._parent},draw:function(a){this.inline.draw(a,this.left,this.baseline,this.measured.width,this.measured.ascent,this.measured.descent,this.formatting)},position:function(a,
c,b){this.left=a;this.baseline=c;b&&(this._bounds=b)},bounds:function(){return this._bounds||b(this.left,this.baseline-this.measured.ascent,this.measured.width,this.measured.ascent+this.measured.descent)},byCoordinate:function(a,c){return a<=this.bounds().center().x?this:this.next()}}),n={number:function(a,c){var b=c+1+".";return{measure:function(a){return d.measure(b,a)},draw:function(a,c,e,k,q,t,x){d.draw(a,b,x,c,e,k,q,t)}}}};n.listNext=n.listEnd=function(a){return c.derive(a,{eof:!0,measure:function(a){return{width:18,
ascent:0,descent:0}},draw:function(a,c,b){}})};n.listStart=function(d,n,h){return c.derive(d,{block:function(c,n,f,g,q,t){var x=e.generic("list",q,c,n),w,r,y,A=function(b,t){w=e.generic("item",x);var q=h(b.marker||{$:"number"},x.children().length);if(!q.draw||!q.measure)throw Error();y=Object.create(a,{inline:{value:q},_parent:{value:w},ordinal:{value:g},length:{value:1},formatting:{value:t},measured:{value:q.measure(t)}});y.block=!0;r=m(c+50,n,f-50,g+1,w,function(a){return"listEnd"===a.$},y.measured.ascent)};
A(d,t);return function(a){r?r(function(a){g=a.ordinal+a.length;var t=a.bounds(),q=a.first(),d=c+50-10-y.measured.width,e=b(c,n,50,t.h);"baseline"in q?y.position(d,q.baseline,e):y.position(d,n+y.measured.ascent,e);n=t.t+t.h;w.children().push(y);w.children().push(a);w.finalize();x.children().push(w);w=r=y=null},a):g++;if(!r){var t=a.code();if(t){if("listEnd"==t.$)return x.finalize(),x;"listNext"==t.$&&A(t,a.codeFormatting())}}}}})};l.exports=f=function(a,c,b){var d=n[a.$];return d&&d(a,c,b)};f.editFilter=
function(a){var b=0;if(!a.words.some(function(d,e){var n=d.code();if(n)switch(n.$){case "listStart":b++;break;case "listNext":if(0===b)return a.spliceWordsWithRuns(e,1,[c.derive(d.codeFormatting(),{text:{$:"listStart",marker:n.marker}})]),!0;break;case "listEnd":0===b&&a.spliceWordsWithRuns(e,1,[]),b--}})&&0<b){for(var d=[];0<b;)b--,d.push({text:{$:"listEnd"}});a.spliceWordsWithRuns(a.words.length-1,0,d)}}},"doc.js":function(f,l,g){var d=g("per"),m=g("./characters"),e=g("./split"),b=g("./word");f=
g("./node");var c=g("./runs"),a=g("./range"),n=g("./util"),k=g("./frame"),r=g("./codes"),h=g("./rect"),z=function(a,c,b,d){var e=a.selection.start,n=a.selection.end;return function(k){a._wordOrdinals=[];var h=Array.prototype.splice.apply(a.words,[c,b].concat(d));k(z(a,c,d.length,h));a._nextSelection={start:e,end:n}}},p=function(a){var c=[],b=function(a){c.push(a);b.length=c.length};a(b);return function(a){a(p(function(a){for(;c.length;)c.pop()(a)}))}},u=function(a){if(a.isNewLine())return!0;a=a.code();
return!(!a||!a.block&&!a.eof)},v=f.derive({calculateBounds:function(){var a=this.frame.bounds(),c=this.position;return[c.x+a.l,c.y+a.t,c.x+this.frame.actualWidth(),c.y+a.h]},load:function(a){var c=this;this.undo=[];this.redo=[];this._wordOrdinals=[];this.words=d(m(a)).per(e(c.codes)).map(function(a){return b(a,c.codes)}).all();this.words.push(b());this.layout()},layout:function(){this.frame=null;try{this.frame=d(this.words).per(k(0,0,this._width,0,this)).first()}catch(a){console.error(a)}if(!this.frame)console.error("A bug somewhere has produced an invalid state - rolling back"),
this.performUndo();else if(this._nextSelection){var c=this._nextSelection;delete this._nextSelection;this.select(c.start,c.end)}},range:function(c,b){return a(this,c,b)},documentRange:function(){return this.range(0,this.frame.length-1)},selectedRange:function(){return this.range(this.selection.start,this.selection.end)},save:function(){return this.documentRange().save()},paragraphRange:function(a,c){var b;b=this.wordContainingOrdinal(a);a=0;if(b&&!u(b.word))for(b=b.index;0<b;b--)if(u(this.words[b-
1])){a=this.wordOrdinal(b);break}b=this.wordContainingOrdinal(c);c=this.frame.length-1;if(b&&!u(b.word))for(b=b.index;b<this.words.length;b++)if(u(this.words[b])){c=this.wordOrdinal(b);break}return this.range(a,c)},insert:function(a,c){this.select(this.selection.end+this.selectedRange().setText(a),null,c)},modifyInsertFormatting:function(a,c){this.nextInsertFormatting[a]=c;this.notifySelectionChanged()},applyInsertFormatting:function(a){var c=this.nextInsertFormatting,b=Object.keys(c);b.length&&a.forEach(function(a){b.forEach(function(b){a[b]=
c[b]})})},wordOrdinal:function(a){if(a<this.words.length){var c=this._wordOrdinals.length;if(c<a+1)for(var b=0<c?this._wordOrdinals[c-1]:0;c<=a;c++)this._wordOrdinals[c]=b,b+=this.words[c].length;return this._wordOrdinals[a]}},wordContainingOrdinal:function(a){var c,b=0;this.words.some(function(d,e){if(a>=b&&a<b+d.length)return c={word:d,ordinal:b,index:e,offset:a-b},!0;b+=d.length});return c},runs:function(a,c){var b=this.wordContainingOrdinal(Math.max(0,c.start)),d=this.wordContainingOrdinal(Math.min(c.end,
this.frame.length-1));if(b.index===d.index)b.word.runs(a,{start:b.offset,end:d.offset});else{b.word.runs(a,{start:b.offset});for(b=b.index+1;b<d.index;b++)this.words[b].runs(a);d.word.runs(a,{end:d.offset})}},spliceWordsWithRuns:function(a,c,n){var k=this,h=d(m(n)).per(e(k.codes)).truthy().map(function(a){return b(a,k.codes)}).all(),f=!1;if("_filtersRunning"in k)k._filtersRunning++;else{for(n=0;n<c;n++)this.words[a+n].code()&&(f=!0);f||(f=h.some(function(a){return!!a.code()}))}this.transaction(function(b){z(k,
a,c,h)(b);if(f){k._filtersRunning=0;try{for(;;){var d=k._filtersRunning;if(!k.editFilters.some(function(a){a(k);return d!==k._filtersRunning}))break}}finally{delete k._filtersRunning}}})},splice:function(a,b,e){if("string"===typeof e){var n=Math.max(0,a-1),n=d({start:n,end:n+1}).per(this.runs,this).first();e=[n?Object.create(n,{text:{value:e}}):{text:e}]}else Array.isArray(e)||(e=[{text:e}]);this.applyInsertFormatting(e);var n=this.wordContainingOrdinal(a),k=this.wordContainingOrdinal(b);a===n.ordinal?
0<n.index&&!u(this.words[n.index-1])?(n.index--,a=this.words[n.index],a=d({}).per(a.runs,a).all()):a=[]:a=d({end:n.offset}).per(n.word.runs,n.word).all();b===k.ordinal?b===this.frame.length-1||u(k.word)?(b=[],k.index--):b=d({}).per(k.word.runs,k.word).all():b=d({start:k.offset}).per(k.word.runs,k.word).all();var h=this.frame.length;this.spliceWordsWithRuns(n.index,k.index-n.index+1,d(a).concat(e).concat(b).per(c.consolidate()).all());return this.frame?this.frame.length-h:0},registerEditFilter:function(a){this.editFilters.push(a)},
width:function(a){if(0===arguments.length)return this._width;this._width=a;this.layout()},children:function(){return[this.frame]},toggleCaret:function(){var a=this.caretVisible;if(this.selection.start===this.selection.end){if(this.selectionJustChanged)return this.selectionJustChanged=!1,this.caretVisible=!0;this.caretVisible=!this.caretVisible}return this.caretVisible!==a},getCaretCoords:function(a){var b=this.byOrdinal(a);if(b)return b.block&&0<a?(b=this.byOrdinal(a-1),b.newLine?(a=b.bounds(),b=
b.parent().parent().bounds(),a=h(b.l,b.b,1,a.h)):(a=b.bounds(),a=h(a.r,a.t,1,a.h))):(a=b.bounds(),a=a.h?h(a.l,a.t,1,a.h):h(a.l,a.t,a.w,1)),a},byCoordinate:function(a,b){for(var c=this.frame.byCoordinate(a,b).ordinal,d=this.getCaretCoords(c);d.b<=b&&c<this.frame.length-1;)c++,d=this.getCaretCoords(c);for(;d.t>=b&&0<c;)c--,d=this.getCaretCoords(c);return this.byOrdinal(c)},drawSelection:function(a,b){if(this.selection.end===this.selection.start){if(this.selectionJustChanged||this.caretVisible){var c=
this.getCaretCoords(this.selection.start);c&&(a.save(),a.fillStyle="black",c.fill(a),a.restore())}}else a.save(),a.fillStyle=b?"rgba(0, 100, 200, 0.3)":"rgba(160, 160, 160, 0.3)",this.selectedRange().parts(function(b){b.bounds(!0).fill(a)}),a.restore()},notifySelectionChanged:function(a){var b=null,c=this;this.selectionChanged.fire(function(){b||(b=c.selectedRange().getFormatting());return b},a)},select:function(a,b,c){this.frame&&(this.selection.start=Math.max(0,a),this.selection.end=Math.min("number"===
typeof b?b:this.selection.start,this.frame.length-1),this.nextInsertFormatting={},this.notifySelectionChanged(c),this.selectionJustChanged=!0)},performUndo:function(a){var b=a?this.undo:this.redo;if(a=(a?this.redo:this.undo).pop())a(function(a){b.push(a)}),this.layout(),this.contentChanged.fire()},canUndo:function(a){return a?!!this.redo.length:!!this.undo.length},transaction:function(a){if(this._currentTransaction)a(this._currentTransaction);else{for(var b=this;50<this.undo.length;)b.undo.shift();
this.redo.length=0;var c=!1;this.undo.push(p(function(d){b._currentTransaction=d;try{a(d)}finally{c=0<d.length,b._currentTransaction=null}}));c&&(b.layout(),b.contentChanged.fire())}},type:"document"});l.exports=function(){var a=Object.create(v);a.identity=_.uniqueId();a.slide=Conversations.getCurrentSlideJid();a._width=0;a.selection={start:0,end:0};a.caretVisible=!0;a.customCodes=function(a,b,c){};a.codes=function(b,c){return r(b,c,a.codes)||a.customCodes(b,c,a.codes)};a.selectionChanged=n.event();
a.contentChanged=n.event();a.editFilters=[r.editFilter];a.load([]);return a}},"dom.js":function(f,l,g){f.isAttached=function(d){for(;d.parentNode;)d=d.parentNode;return!!d.body};f.clear=function(d){for(;d.firstChild;)d.removeChild(d.firstChild)};f.setText=function(d,g){f.clear(d);d.appendChild(document.createTextNode(g))};f.handleEvent=function(d,f,e){d.addEventListener(f,function(b){!1===e(b)&&b.preventDefault()})};f.handleMouseEvent=function(d,g,e){f.handleEvent(d,g,function(b){var c=d.getBoundingClientRect();
return e(b,b.clientX-c.left,b.clientY-c.top)})};f.effectiveStyle=function(d,f){return document.defaultView.getComputedStyle(d).getPropertyValue(f)}},"editor.js":function(f,l,g){g("per");var d=g("./doc"),m=g("./dom"),e=g("./rect"),b=null;Date.now();f.paint=function(c,a,d){var k=worldToScreen(a.position.x,a.position.y),f=c.width,h=c.height;c=c.getContext("2d");c.save();f=e(0,0,f,h);h=scale();c.translate(k.x,k.y);c.scale(h,h);a.draw(c,f);a.isActive&&Modes.currentMode==Modes.text&&a.drawSelection(c,b||
d);c.restore()};f.create=function(c,a,e){c.innerHTML='<div class="carotaTextArea" style="overflow: hidden; position: absolute; height: 0;"><textarea autocorrect="off" autocapitalize="off" spellcheck="false" tabindex="0" style="position: absolute; padding: 0px; width: 1000px; height: 1em; outline: none; font-size: 4px;"></textarea></div>';a=a||c.querySelector("canvas");var k=c.querySelector(".carotaTextArea"),f=c.querySelector("textarea"),h=d(),g=0,p=null,u=null,v=null,q="",t=null,x=null;h.width(a.clientWidth);
h.claimFocus=function(){$(f).focus()};var w={66:"bold",73:"italic",85:"underline",83:"strikeout"},l=function(a,b){var c=h.getCaretCoords(a),d;for(u=null!==p?p:c.l;!(0>b?0>=a:a>=h.frame.length-1)&&!(a+=b,d=h.getCaretCoords(a),d.b<=c.t||c.b<=d.t););for(c=d;!((0>b?0>=a:a>=h.frame.length-1)||0<b&&d.l>=u||0>b&&d.l<=u);)if(a+=b,d=h.getCaretCoords(a),d.b<=c.t||c.b<=d.t){a-=b;break}return a},y=function(a,b){for(var c=h.getCaretCoords(a),d;!(0>b?0>=a:a>=h.frame.length-1);)if(a+=b,d=h.getCaretCoords(a),d.b<=
c.t||c.b<=d.t){a-=b;break}return a},A=function(a,b,c){var d=h.selection.start,k=h.selection.end,f=h.frame.length-1,m=!1;u=null;if(!b)g=0;else if(!g)switch(a){case 37:case 38:case 36:case 33:g=-1;break;case 39:case 40:case 35:case 34:g=1}var r=1===g?k:d,q=!1;switch(a){case 37:b||d==k?0<r&&(c?(q=h.wordContainingOrdinal(r),r=q.ordinal===r?0<q.index?h.wordOrdinal(q.index-1):0:q.ordinal):r--):r=d;q=!0;break;case 39:b||d==k?r<f&&(c?(q=h.wordContainingOrdinal(r),r=q.ordinal+q.word.length):r++):r=k;q=!0;
break;case 40:r=l(r,1);q=!0;break;case 38:r=l(r,-1);q=!0;break;case 36:r=y(r,-1);q=!0;break;case 35:r=y(r,1);q=!0;break;case 33:r=0;q=!0;break;case 34:r=f;q=!0;break;case 8:d===k&&0<d&&(h.range(d-1,d).clear(),v=d-1,h.select(v,v),m=!0);break;case 46:d===k&&d<f&&(h.range(d,d+1).clear(),m=!0);break;case 90:c&&(m=!0,h.performUndo());break;case 89:c&&(m=!0,h.performUndo(!0));break;case 65:c&&(m=!0,h.select(0,f));break;case 67:case 88:c&&(t=h.selectedRange().save(),x=h.selectedRange().plainText())}a=w[a];
c&&a&&(c=h.selectedRange(),c.setFormatting(a,!0!==c.getFormatting()[a]),e(),m=!0);if(q){switch(g){case 0:d=k=r;break;case -1:d=r;break;case 1:k=r}d===k?g=0:d>k&&(g=-g,c=k,k=d,d=c);v=r;h.select(d,k);m=!0}p=u;return m};m.handleEvent(f,"keydown",function(a){if(A(a.keyCode,a.shiftKey,a.ctrlKey))return!1});h.setVerticalAlignment=function(a){e()};m.handleEvent(f,"input",function(){var a=f.value;q!=a&&(q="",f.value="",a===x&&(a=t),h.insert(a))});var D=function(){v=null===v?h.selection.end:v;var a=h.byOrdinal(v);
v=null;if(a){a=a.bounds();k.style.left=a.l+"px";k.style.top=a.t+"px";f.focus();var b=Math.max(0,a.t+a.h-(c.scrollTop+c.clientHeight));b&&(c.scrollTop+=b);if(b=Math.max(0,c.scrollTop-a.t))c.scrollTop-=b;if(b=Math.max(0,a.l-(c.scrollLeft+c.clientWidth)))c.scrollLeft+=b;if(a=Math.max(0,c.scrollLeft-a.l))c.scrollLeft-=a}q=h.selectedRange().plainText();f.value=q;f.select();setTimeout(function(){f.focus()},10)};h.selectionChanged(function(a,b){e();!1!==b&&D()});h.dblclickHandler=function(a){(a=a.parent())&&
h.select(a.ordinal,a.ordinal+(a.word?a.word.text.length:a.length))};h.mousedownHandler=function(a){C=0;b=a.ordinal;h.select(a.ordinal,a.ordinal);p=null};h.mousemoveHandler=function(a){null!==b&&a&&(v=a.ordinal,b>a.ordinal?h.select(a.ordinal,b):h.select(b,a.ordinal))};h.mouseupHandler=function(a){p=null;h.isActive=!0;D();h.update()};var C=(new Date).getTime();h.update=function(){if(Conversations.getCurrentSlideJid()==h.slide&&h.isActive){var a=(new Date).getTime();a>C&&(C=a+500,h.toggleCaret()&&e());
setTimeout(h.update,500)}};h.sendKey=A;return h}},"frame.js":function(f,l,g){f=g("./node");var d=g("./wrap"),m=g("./rect"),e=f.derive({bounds:function(){var b=this._bounds;if(!(b&&b.l&&b.t&&b.w&&b.h)){var c=b=0,a=0,d=0;this.lines&&this.lines.length&&(c=this.lines[0].bounds(),b=c.l,c=c.t,this.lines.forEach(function(b){b=b.bounds();a=Math.max(a,b.l+b.w);d=Math.max(d,b.t+b.h)}));this._bounds=m(b,c,a-b,this.height||d-c)}return this._bounds},actualWidth:function(){if(!this._actualWidth){var b=0;this.lines&&
this.lines.forEach(function(c){"number"===typeof c.actualWidth&&(b=Math.max(b,c.actualWidth))});this._actualWidth=b}return this._actualWidth},children:function(){return this.lines},parent:function(){return this._parent},draw:function(b,c){this.lines&&this.lines.some(function(a){a.draw(b,c)})},type:"frame"});l.exports=function(b,c,a,n,k,f,h,g){var m=[],u=Object.create(e,{lines:{value:m},_parent:{value:k},ordinal:{value:n}}),v=d(b,c,a,n,u,f,h,g),q=0,t=0;return function(a,b){if(v(function(a){"number"===
typeof a?t=a:(q=a.ordinal+a.length-n,m.push(a))},b))return Object.defineProperty(u,"length",{value:q}),Object.defineProperty(u,"height",{value:t}),a(u),!0}}},"html.js":function(f,l,g){var d=g("./runs"),m=g("per");l=function(a,b){return function(c,d){c.nodeName===a&&(d[b]=!0)}};var e=function(a,b,c,d){return function(e,k){var n=e[a]&&e[a][b];n&&(d&&(n=d(n)),k[c]=n)}};g=function(a,b,c){return e("attributes",a,b,c)};var b=function(a,b,c){return e("style",a,b,c)},c=function(a,b,c){return function(d,e){d.style&&
d.style[a]===b&&(e[c]=!0)}},a=[6,7,9,10,12,16,20,30],n={left:!0,center:!0,right:!0,justify:!0},k=function(a){return n[a]?a:"left"},r=function(a){var b=a.split(/\s*,\s*/g);if(0==b.length)return a;a=b[0];return(b=a.match(/^"(.*)"$/))?b[1].trim():(b=a.match(/^'(.*)'$/))?b[1].trim():a},h={H1:30,H2:20,H3:16,H4:14,H5:12},z=[l("B","bold"),l("STRONG","bold"),l("I","italic"),l("EM","italic"),l("U","underline"),l("S","strikeout"),l("STRIKE","strikeout"),l("DEL","strikeout"),c("fontWeight","bold","bold"),c("fontStyle",
"italic","italic"),c("textDecoration","underline","underline"),c("textDecoration","line-through","strikeout"),b("color","color"),b("fontFamily","font",r),b("fontSize","size",function(a){return(a=a.match(/^([\d\.]+)pt$/))?parseFloat(a[1]):10}),b("textAlign","align",k),function(a,b){"SUB"===a.nodeName&&(b.script="sub")},function(a,b){"SUPER"===a.nodeName&&(b.script="super")},function(a,b){"CODE"===a.nodeName&&(b.font="monospace")},function(a,b){var c=h[a.nodeName];c&&(b.size=c)},g("color","color"),
g("face","font",r),g("align","align",k),g("size","size",function(b){return a[b]||10})],p={};"BR P H1 H2 H3 H4 H5".split(" ").forEach(function(a){p[a]=!0});f.parse=function(a,b){function c(a,d){if(3==a.nodeType)h(a.nodeValue,d);else{d=Object.create(d);var e=a.attributes["class"];e&&e.value.split(" ").forEach(function(a){(a=b[a])&&Object.keys(a).forEach(function(b){d[b]=a[b]})});z.forEach(function(b){b(a,d)});if(a.childNodes)for(e=0;e<a.childNodes.length;e++)c(a.childNodes[e],d);p[a.nodeName]&&(f.submit(Object.create(d,
{text:{value:"\n"}})),n=!0)}}var e=a;"string"===typeof e&&(e=document.createElement("div"),e.innerHTML=a);var k=[],n=!0,f=m(d.consolidate()).into(k),h=function(a,b){a=a.replace(/\n+\s*/g," ");var c=a.length;a=a.replace(/^\s+/,"");n?n=!1:c!==a.length&&(a=" "+a);c=a.length;a=a.replace(/\s+$/,"");c!==a.length&&(n=!0,a+=" ");f.submit(Object.create(b,{text:{value:a}}))};c(e,{});return k}},"line.js":function(f,l,g){var d=g("./positionedword"),m=g("./rect");f=g("./node");g("./runs");var e=f.derive({bounds:function(b){if(b){b=
this.first().bounds();var c=this.last().bounds();return m(b.l,this.baseline-this.ascent,c.l+c.w-b.l,this.ascent+this.descent)}return m(this.left,this.baseline-this.ascent,this.width,this.ascent+this.descent)},parent:function(){return this.doc},children:function(){return this.positionedWords},type:"line"});l.exports=function(b,c,a,n,k,f,h,g){var m=h[0].align(),l=Object.create(e,{doc:{value:b},left:{value:c},width:{value:a},baseline:{value:n},ascent:{value:k},descent:{value:f},ordinal:{value:g},align:{value:m}}),
v=0;h.forEach(function(a){v+=a.width});var v=v-h[h.length-1].space.width,q=0,t=0;if(v<a)switch(m){case "right":q=a-v;break;case "center":q=(a-v)/2;break;case "justify":1<h.length&&!h[h.length-1].isNewLine()&&(t=(a-v)/(h.length-1))}Object.defineProperty(l,"positionedWords",{value:h.map(function(a){var b=q;q+=a.width+t;var c=g;g+=a.text.length+a.space.length;return d(a,l,b,c,a.width+t)})});Object.defineProperty(l,"actualWidth",{value:v});Object.defineProperty(l,"length",{value:g-l.ordinal});return l}},
"node.js":function(f,l,g){g("per");g("./runs");var d=g("./rect"),m=g("./util");f.prototype={children:function(){return[]},parent:function(){return null},first:function(){return this.children()[0]},last:function(){return this.children()[this.children().length-1]},next:function(){for(var b=this;;){var c=b.parent();if(!c)return null;var a=c.children();if(b=a[a.indexOf(b)+1]){for(;;){c=b.first();if(!c)break;b=c}return b}b=c}},previous:function(){var b=this.parent();if(!b)return null;var c=b.children();
return(c=c[c.indexOf(this)-1])?c:(b=b.previous())?b.last():null},byOrdinal:function(b){var c=null;return this.children().some(function(a){if(b>=a.ordinal&&b<a.ordinal+a.length&&(c=a.byOrdinal(b)))return!0})?c:this},byCoordinate:function(b,c){var a;this.children().some(function(d){if(d.bounds().contains(b,c)&&(a=d.byCoordinate(b,c)))return!0});if(!a){for(a=this.last();a;){var d=a.last();if(!d)break;a=d}(d=a.next())&&d.block&&(a=d)}return a},draw:function(b,c){this.children().forEach(function(a){a.draw(b,
c)})},parentOfType:function(b){var c=this.parent();return c&&(c.type===b?c:c.parentOfType(b))},bounds:function(){var b=this._left,c=this._top,a=0,e=0;this.children().forEach(function(d){d=d.bounds();b=Math.min(b,d.l);c=Math.min(c,d.t);a=Math.max(a,d.l+d.w);e=Math.max(e,d.t+d.h)});return d(b,c,a-b,e-c)}};f.derive=function(b){return m.derive(f.prototype,b)};var e=f.derive({children:function(){return this._children},parent:function(){return this._parent},finalize:function(b,c){var a=Number.MAX_VALUE,
d=0;this._children.forEach(function(b){a=Math.min(a,b.ordinal);d=Math.max(d,b.ordinal+b.length)});Object.defineProperty(this,"ordinal",{value:a-(b||0)});Object.defineProperty(this,"length",{value:(c||0)+d-a})}});f.generic=function(b,c,a,d){return Object.create(e,{type:{value:b},_children:{value:[]},_parent:{value:c},_left:{value:"number"===typeof a?a:Number.MAX_VALUE},_top:{value:"number"===typeof d?d:Number.MAX_VALUE}})}},"part.js":function(f,l,g){var d=g("./text"),m={measure:function(b){var c=c.measure("?",
b);return{width:c.width+4,ascent:c.width+2,descent:c.width+2}},draw:function(b,c,a,d,e,f){b.fillStyle="silver";b.fillRect(c,a-e,d,e+f);b.strokeRect(c,a-e,d,e+f);b.fillStyle="black";b.fillText("?",c+2,a)}},e={draw:function(b,c,a){"string"===typeof this.run.text?d.draw(b,this.run.text,this.run,c,a,this.width,this.ascent,this.descent):this.code&&this.code.draw&&(b.save(),this.code.draw(b,c,a,this.width,this.ascent,this.descent,this.run),b.restore())}};l.exports=function(b,c){var a,f,k;"string"===typeof b.text?
(f=1===b.text.length&&"\n"===b.text[0],a=d.measure(f?d.nbsp:b.text,b)):(k=c(b.text)||m,a=k.measure?k.measure(b):{width:0,ascent:0,descent:0});a=Object.create(e,{run:{value:b},isNewLine:{value:f},width:{value:f?0:a.width},ascent:{value:a.ascent},descent:{value:a.descent}});k&&Object.defineProperty(a,"code",{value:k});return a}},"positionedword.js":function(f,l,g){var d=g("./rect"),m=g("./part"),e=g("./text");f=g("./node");g("./word");var b=g("./runs"),c=f.derive({bounds:function(){var a=this.word.bounds(),
b=this.word.word.isNewLine()?e.measure(e.enter,this.word.word.run).width:this.width||this.part.width;return d(a.l+this.left,a.t,b,a.h)},parent:function(){return this.word},byOrdinal:function(){return this},byCoordinate:function(a,b){return a<=this.bounds().center().x?this:this.next()},type:"character"}),a=f.derive({draw:function(a){this.word.draw(a,this.line.left+this.left,this.line.baseline)},bounds:function(){return d(this.line.left+this.left,this.line.baseline-this.line.ascent,this.word.isNewLine()?
e.measure(e.enter,this.word.run).width:this.width,this.line.ascent+this.line.descent)},parts:function(a){this.word.text.parts.some(a)||this.word.space.parts.some(a)},realiseCharacters:function(){if(!this._characters){var a=[],d=0,e=this,f=this.ordinal,g=this.parentOfType("document").codes;this.parts(function(p){b.pieceCharacters(function(b){var l=Object.create(p.run);l.text=b;b=m(l,g);a.push(Object.create(c,{left:{value:d},part:{value:b},word:{value:e},ordinal:{value:f},length:{value:1}}));d+=b.width;
f++},p.run.text)});var p=a[a.length-1];p&&(Object.defineProperty(p,"width",{value:this.width-p.left}),(this.word.isNewLine()||this.word.code()&&this.word.code().eof)&&Object.defineProperty(p,"newLine",{value:!0}));this._characters=a}},children:function(){this.realiseCharacters();return this._characters},parent:function(){return this.line},type:"word"});l.exports=function(b,c,d,e,f){return Object.create(a,{word:{value:b},line:{value:c},left:{value:d},width:{value:f},ordinal:{value:e},length:{value:b.text.length+
b.space.length}})}},"range.js":function(f,l,g){function d(b,c,a){this.doc=b;this.start=c;this.end=a;c>a&&(this.start=a,this.end=c)}var m=g("per"),e=g("./runs");d.prototype.parts=function(b,c){c=c||this.doc.children();var a=this;c.some(function(c){if(c.ordinal+c.length<=a.start)return!1;if(c.ordinal>=a.end)return!0;c.ordinal>=a.start&&c.ordinal+c.length<=a.end?b(c):a.parts(b,c.children())})};d.prototype.clear=function(){return this.setText([])};d.prototype.setText=function(b){return this.doc.splice(this.start,
this.end,b)};d.prototype.runs=function(b){this.doc.runs(b,this)};d.prototype.plainText=function(){return m(this.runs,this).map(e.getPlainText).all().join("")};d.prototype.save=function(){return m(this.runs,this).per(e.consolidate()).all()};d.prototype.getFormatting=function(){if(this.start===this.end){var b=this.start;0<b&&b--;this.start=b;this.end=b+1}return m(this.runs,this).reduce(e.merge).last()||e.defaultFormatting};d.prototype.setFormatting=function(b,c){var a=this;"align"===b&&(a=a.doc.paragraphRange(a.start,
a.end));"color"===b&&"string"==typeof c&&(c=[c,255]);if(a.start===a.end)a.doc.modifyInsertFormatting(b,c);else{var d=a.save(),f={};f[b]=c;e.format(d,f);a.setText(d)}};l.exports=function(b,c,a){return new d(b,c,a)}},"rect.js":function(f,l,g){var d={contains:function(d,b){return d>=this.l&&d<this.l+this.w&&b>=this.t&&b<this.t+this.h},stroke:function(d){d.strokeRect(this.l,this.t,this.w,this.h)},fill:function(d){d.fillRect(this.l,this.t,this.w,this.h)},offset:function(d,b){return m(this.l+d,this.t+b,
this.w,this.h)},equals:function(d){return this.l===d.l&&this.t===d.t&&this.w===d.w&&this.h===d.h},center:function(){return{x:this.l+this.w/2,y:this.t+this.h/2}}},m=l.exports=function(e,b,c,a){return Object.create(d,{l:{value:e},t:{value:b},w:{value:c},h:{value:a},r:{value:e+c},b:{value:b+a}})}},"runs.js":function(f,l,g){f.formattingKeys="bold italic underline strikeout color font size align script".split(" ");f.defaultFormatting={size:30,font:"sans-serif",color:["#000000",255],bold:!1,italic:!1,underline:!1,
strikeout:!1,align:"left",script:"normal"};f.sameFormatting=function(d,g){return f.formattingKeys.every(function(e){return d[e]===g[e]})};f.clone=function(d){var g={text:d.text};f.formattingKeys.forEach(function(e){var b=d[e];b&&b!=f.defaultFormatting[e]&&(g[e]=b)});return g};f.multipleValues={};f.merge=function(d,g){if(1===arguments.length)return Array.isArray(d)?d.reduce(f.merge):d;if(2<arguments.length)return f.merge(Array.prototype.slice.call(arguments,0));var e={};f.formattingKeys.forEach(function(b){if(b in
d||b in g)e[b]=d[b]===g[b]?d[b]:f.multipleValues});return e};f.format=function(d,g){Array.isArray(d)?d.forEach(function(d){f.format(d,g)}):Object.keys(g).forEach(function(e){g[e]!==f.multipleValues&&(d[e]=g[e])})};f.consolidate=function(){var d;return function(g,e){d&&f.sameFormatting(d,e)&&"string"==typeof d.text&&"string"==typeof e.text?d.text+=e.text:(d=f.clone(e),g(d))}};f.getPlainText=function(d){if("string"===typeof d.text)return d.text;if(Array.isArray(d.text)){var g=[];d.text.forEach(function(d){g.push(f.getPiecePlainText(d))});
return g.join("")}return"_"};f.getPieceLength=function(d){return d.length||1};f.getPiecePlainText=function(d){return d.length?d:"_"};f.getTextLength=function(d){if("string"===typeof d)return d.length;if(Array.isArray(d)){var g=0;d.forEach(function(d){g+=f.getPieceLength(d)});return g}return 1};f.getSubText=function(d,g,e,b){if(0!==b)if("string"===typeof g)d(g.substr(e,b));else if(Array.isArray(g)){var c=0;g.some(function(a){if(0>=b)return!0;var g=f.getPieceLength(a);c+g>e&&(1===g?(d(a),--b):(a=a.substr(Math.max(0,
e-c),b),d(a),b-=a.length));c+=g})}else d(g)};f.getTextChar=function(d,g){var e;f.getSubText(function(b){e=b},d,g,1);return e};f.pieceCharacters=function(d,f){if("string"===typeof f)for(var e=0;e<f.length;e++)d(f[e]);else d(f)}},"split.js":function(f,l,g){l.exports=function(d){var f=null,e=null,b=!0;return function(c,a){var g;if(null===a["char"])g=!0;else if(b&&(g=!0,b=!1),"string"===typeof a["char"])switch(a["char"]){case " ":e||(e=a);break;case "\n":b=g=!0;break;default:e&&(g=!0)}else{var k=d(a["char"]);
if(k.block||k.eof)b=g=!0}if(g){if(f&&!f.equals(a)){if(!1===c({text:f,spaces:e||a,end:a}))return!1;e=null}null===a["char"]&&c(null);f=a}}}},"text.js":function(f,l,g){var d=g("./runs"),m=f.getFontString=function(b){var a=b&&b.size||d.defaultFormatting.size;if(b)switch(b.script){case "super":case "sub":a*=.8}return(b&&b.italic?"italic ":"")+(b&&b.bold?"bold ":"")+" "+a+"pt "+(b&&b.font||d.defaultFormatting.font)};f.applyRunStyle=function(b,a){b.fillStyle=a&&a.color&&a.color[0]||d.defaultFormatting.color[0];
b.font=m(a)};f.prepareContext=function(b){b.textAlign="left";b.textBaseline="alphabetic"};f.getRunStyle=function(b){var a=["font: ",m(b),"; color: ",b&&b.color&&b.color[0]||d.defaultFormatting.color[0]];if(b)switch(b.script){case "super":a.push("; vertical-align: super");break;case "sub":a.push("; vertical-align: sub")}return a.join("")};var e=f.nbsp=String.fromCharCode(160);f.enter=e;var b=f.measureText=function(b,a){var d,f,g;d=document.createElement("span");f=document.createElement("div");g=document.createElement("div");
f.style.display="inline-block";f.style.width="1px";f.style.height="0";g.style.visibility="hidden";g.style.position="absolute";g.style.top="0";g.style.left="0";g.style.width="500px";g.style.height="200px";g.appendChild(d);g.appendChild(f);document.body.appendChild(g);try{d.setAttribute("style",a);d.innerHTML="";d.appendChild(document.createTextNode(b.replace(/\s/g,e)));var h={};f.style.verticalAlign="baseline";h.ascent=f.offsetTop-d.offsetTop;f.style.verticalAlign="bottom";h.height=f.offsetTop-d.offsetTop;
h.descent=h.height-h.ascent;h.width=d.offsetWidth}finally{g.parentNode.removeChild(g)}return h};l=f.createCachedMeasureText=function(){var c={};return function(a,d){var e=d+"<>!&%"+a,f=c[e];f||(c[e]=f=b(a,d));return f}};f.cachedMeasureText=l();f.measure=function(b,a){return f.cachedMeasureText(b,f.getRunStyle(a))};f.draw=function(b,a,d,e,g,h,m,p){f.prepareContext(b);f.applyRunStyle(b,d);switch(d.script){case "super":g-=1/3*m;break;case "sub":g+=p/2}b.fillText("\n"===a?f.enter:a,e,g);d.underline&&
b.fillRect(e,1+g,h,1);d.strikeout&&b.fillRect(e,1+g-m/2,h,1)}},"util.js":function(f,l,g){f.event=function(){var d=[],f=function(e){d.push(e)};f.fire=function(){var e=Array.prototype.slice.call(arguments,0);d.forEach(function(b){b.apply(null,e)})};return f};f.derive=function(d,f){var e={};Object.keys(f).forEach(function(b){e[b]={value:f[b]}});return Object.create(d,e)}},"word.js":function(f,l,g){var d=g("per"),m=g("./part"),e=g("./runs"),b={isNewLine:function(){return 1==this.text.parts.length&&this.text.parts[0].isNewLine},
code:function(){return 1==this.text.parts.length&&this.text.parts[0].code},codeFormatting:function(){return 1==this.text.parts.length&&this.text.parts[0].run},draw:function(a,b,c){d(this.text.parts).concat(this.space.parts).forEach(function(d){d.draw(a,b,c);b+=d.width})},plainText:function(){return this.text.plainText+this.space.plainText},align:function(){var a=this.text.parts[0];return a?a.run.align:"left"},runs:function(a,b){var c=b&&b.start||0,d=b&&b.end;"number"!==typeof d&&(d=Number.MAX_VALUE);
[this.text,this.space].forEach(function(b){b.parts.some(function(b){if(c>=d||0>=d)return!0;var e=b.run;b=e.text;if("string"===typeof b){if(0>=c&&d>=b.length)a(e);else if(c<b.length){var e=Object.create(e),f=Math.max(0,c);e.text=b.substr(f,Math.min(b.length,d-f));a(e)}c-=b.length;d-=b.length}else 0>=c&&1<=d&&a(e),c--,d--})})}},c=function(a,b){var c={parts:d(a).map(function(a){return m(a,b)}).all(),ascent:0,descent:0,width:0,length:0,plainText:""};c.parts.forEach(function(a){c.ascent=Math.max(c.ascent,
a.ascent);c.descent=Math.max(c.descent,a.descent);c.width+=a.width;c.length+=e.getPieceLength(a.run.text);c.plainText+=e.getPiecePlainText(a.run.text)});return c};l.exports=function(a,d){var e,f;a?(e=a.text.cut(a.spaces),f=a.spaces.cut(a.end)):(e=[{text:"\n"}],f=[]);e=c(e,d);f=c(f,d);e=Object.create(b,{text:{value:e},space:{value:f},ascent:{value:Math.max(e.ascent,f.ascent)},descent:{value:Math.max(e.descent,f.descent)},width:{value:e.width+f.width,configurable:!0},length:{value:e.length+f.length}});
a||Object.defineProperty(e,"eof",{value:!0});return e}},"wrap.js":function(f,l,g){var d=g("./line");l.exports=function(f,e,b,c,a,g,k,l){var h=[],z=0,p=k||0,u=l||0,v,q=0,t=e,x=function(a,b){h.push(a);z+=a.width;p=Math.max(p,a.ascent);u=Math.max(u,a.descent);a.isNewLine()&&(w(b),q=a.ascent+a.descent)},w=function(e){if(!v&&0!==h.length){var g=d(a,f,b,t+p,p,u,h,c);c+=g.length;v=e(g);t+=p+u;z=p=u=h.length=0}},B=null;return function(d,k){if(B){q=0;var l=B(k);l&&(B=null,c+=l.length,t+=l.bounds().h,Object.defineProperty(l,
"block",{value:!0}),d(l))}else(l=k.code())&&l.block?(h.length?w(d):t+=q,B=l.block(f,t,b,c,a,k.codeFormatting()),q=0):l&&l.eof||k.eof?((!l||g&&g(l))&&x(k,d),h.length?(w(d),d(t-e)):d(t+q-e),v=!0):(q=0,h.length&&z+k.text.width>b&&w(d),x(k,d));return v}}}}},per:{":mainpath:":"per.js","per.js":function(f,l,g){(function(d){function f(a,b){return"function"!==typeof a?Array.isArray(a)?function(b){return a.some(b)}:function(b){return b(a)}:b?function(c,d){a.call(b,c,d)}:a}function e(a,b){this.forEach=f(a,
b)}function b(a,b){a(b)}function c(a,c){return 0===arguments.length?new e(b):a&&a instanceof e?a:new e(a,c)}function a(a){return"string"===typeof a?new Function("x","return "+a):a}function g(a,b){var c=a[b];return"function"===typeof c?c:function(c){a[b]=c}}function k(){}function l(a){return!!a}function h(a,b){return Math.min(a,b)}function z(a,b){return Math.max(a,b)}function p(a,b){return a+b}function u(a,b){return!(!a||!b)}function v(a,b){return!(!a&&!b)}function q(a){return!a}e.prototype.per=function(a,
b){var d=this.forEach,e=f(a&&a.forEach||a,b);return c(function(a,b){return d(function(b){return e(a,b)},b)})};e.prototype.map=function(b){b=a(b);return this.per(function(a,c){return a(b(c))})};e.prototype.filter=function(b){b=a(b);return this.per(function(a,c){if(b(c))return a(c)})};e.prototype.concat=function(a,b){a=a instanceof e?a.forEach:f(a,b);var d=this.forEach;return c(function(b,c){d(b,c);a(b,c)})};e.prototype.skip=function(a){return this.per(function(b,c){return 0<a?(a--,!1):b(c)})};e.prototype.take=
function(a){return this.per(function(b,c){if(0>=a)return!0;a--;return b(c)})};e.prototype.listen=function(a){return this.per(function(b,c){return a(c)?!0:b(c)})};e.prototype.flatten=function(){return this.per(function(a,b){return Array.isArray(b)?b.some(function(b){return a(b)}):a(b)})};e.prototype.reduce=function(a,b){var c=b,d=2==arguments.length;return this.per(function(b,e){c=d?a(c,e):e;b(c);d=!0})};e.prototype.multicast=function(a){1!==arguments.length&&(a=Array.prototype.slice.call(arguments,
0));a=a.map(function(a){return"function"===typeof a?a:a instanceof e?a.forEach:k});return this.listen(function(b){var c=!0;a.forEach(function(a){a(k,b)||(c=!1)});return c})};e.prototype.into=function(a,b){if(!Array.isArray(a))throw Error("into expects an array");b="number"!=typeof b?Number.MAX_VALUE:b;return this.listen(function(c){if(0>=b)return!0;a.push(c);b--})};e.prototype.monitor=function(a){var b=0,c=g(a,"count"),d=g(a,"first"),e=g(a,"last"),f=a.limit;"number"!=typeof f&&(f=Number.MAX_VALUE);
return 1>f?this:this.listen(function(a){0===b&&d(a);b++;c(b);e(a);if(b>=f)return!0})};e.prototype.submit=function(a){return this.forEach(k,a)};e.prototype.all=function(){var a=[];this.into(a).submit();return a};e.prototype.first=function(){var a={limit:1};this.monitor(a).submit();return 0<a.count?a.first:void 0};e.prototype.last=function(){var a={};this.monitor(a).submit();return 0<a.count?a.last:void 0};e.prototype.truthy=function(){return this.filter(l)};e.prototype.min=function(){return this.reduce(h,
Number.MAX_VALUE)};e.prototype.max=function(){return this.reduce(z,Number.MIN_VALUE)};e.prototype.sum=function(){return this.reduce(p,0)};e.prototype.and=function(){return this.reduce(u,!0)};e.prototype.or=function(){return this.reduce(v,!1)};e.prototype.not=function(){return this.map(q)};c.pulse=function(a){var b=0;return c(function(c){function d(){!0!==c(b++)&&setTimeout(d,a)}d()})};d(c)})(function(d){"undefined"===typeof f?this.per=d:l.exports=d})}}})("carota/src/carota")})();
