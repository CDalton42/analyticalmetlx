var GroupBuilder=function(){var g={},d=[],h={},l=function(b){return $("<div />",{"class":"groupBuilderMember",text:b})},q=function(){var b=$("#groupsPopup").find(".importGroups").empty();_.each(h,function(a){if(a=a.orgUnit){g[a.name]&&g[a.name].remove();var e=g[a.name]=$("<div />",{text:a.name}).appendTo(b),f=0;_.each(a.groupSets,function(a){var b=$("<div />",{}).appendTo(e);_.each(a.groups,function(a){f++;var e=$("<div />",{"class":"groupBuilderGroup"}).appendTo(b),c=sprintf("structuralGroup_%s",
f);$("<input />",{type:"checkbox",id:c}).on("click",function(){_.includes(d,a)?d=_.without(d,a):d.push(a);k()}).appendTo(e).prop("checked",_.includes(d,a));$("<label />",{"for":c}).append($("<span />",{"class":"icon-txt",text:"Copy"})).appendTo(e);_.each(a.members,function(a){l(a.name).appendTo(e)})})})}})},k=function(){var b=$("#groupsPopup"),a=$("#groupComposition").empty();b.find(".importGroups").empty();var e=Conversations.getCurrentSlide(),f=$("<select />",{id:"strategySelect"}).appendTo(a),
c=$("<select />",{id:"parameterSelect"}).appendTo(a),a=$("#doAllocation").off("click").on("click",function(){Conversations.addGroupSlide(f.val(),parseInt(c.val()),_.map(d,function(a){return _.map(a.members,"name")}));d=[]});_.each([["there are","byTotalGroups"],["each has","byMaximumSize"]],function(a){$("<option />",{text:a[0],value:a[1]}).appendTo(f)});f.on("change",function(){var a=$(this).val();c.empty();switch(a){case "byTotalGroups":_.each(_.range(2,10),function(a){$("<option />",{text:sprintf("%s groups in total",
a),value:a}).appendTo(c)});c.val(5);break;case "byMaximumSize":_.each(_.range(1,10),function(a){$("<option />",{text:1==a?"only one member":sprintf("at most %s members",a),value:a}).appendTo(c)}),c.val(4)}});f.val("byMaximumSize").change();var g=b.find(".allocatedMembers").empty(),h=b.find(".unallocatedMembers").empty(),n=b.find(".groups").empty(),m=_.clone(Participants.getParticipants());delete m[Conversations.getCurrentConversation.author];var p={};e&&(e.groupSets.length?(c.prop("disabled",!0),
f.prop("disabled",!0),a.prop("disabled",!0),$("#importContainer").hide()):$("#importContainer").show(),_.each(d,function(a){var e=$("<div />",{"class":"groupBuilderGroup ghost"});_.each(a.members,function(a){l(a.name).appendTo(e)});e.appendTo(n)}),_.each(e.groupSets,function(a){_.each(_.sortBy(a.groups,"title"),function(b){var c=$("<div />",{"class":"groupBuilderGroup"}).droppable({drop:function(c,d){var f=$(d.draggable).find(".groupBuilderMember");_.each(f,function(c){var d=$(c).text();_.includes(b.members,
d)||(_.each(a.groups,function(a){a.members=_.without(a.members,d)}),b.members.push(d),k(),Conversations.overrideAllocation(e))});c.preventDefault()}});_.each(b.members,function(a){delete m[a];p[a]=1;l(a).draggable().appendTo(c)});$("<div />",{"class":"title",text:sprintf("Group %s",b.title)}).prependTo(c);c.appendTo(n)})}));_.each(p,function(a,b){$("<div />",{text:b,"class":"member"}).appendTo(g)});_.each(m,function(a,b){$("<div />",{text:b,"class":"member"}).appendTo(h)});q()};Progress.groupProvidersReceived.GroupBuilder=
function(b){var a=$("#ouSelector").empty();$("<option />",{text:"no starting groups",value:"NONE",selected:!0}).appendTo(a);_.each(b.groupsProviders,function(b){$("<option />",{text:b,value:b}).appendTo(a)});a.on("change",function(){var a=$(this).val();"NONE"!=a&&getOrgUnitsFromGroupProviders(a)})};Progress.groupsReceived.GroupBuilder=function(b){h[b.orgUnit.name]=b;q()};Progress.currentSlideJidReceived.GroupBuilder=k;Progress.conversationDetailsReceived.GroupBuilder=function(){getGroupsProviders();
k()};return{}}();
