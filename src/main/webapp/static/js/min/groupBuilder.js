var GroupBuilder=function(){var k={},e={},l=[],d="byMaximumSize",r=!1,h={byTotalGroups:5,byMaximumSize:4},t=function(a){return $("<div />",{"class":"groupBuilderMember",text:a})},x=function(a){var c=a.foreignRelationship;return c?sprintf("%s@%s",c.key,c.system):a.name},u=function(){return _.flatMap(k,function(a){return _.map(a.groups,function(a){var b={};_.each(a.members,function(a){b[a.name]=!0});return b})})},y=function(){var a=$(".jAlert .groupSlideDialog").find(".importGroups").empty();$("<input />",
{type:"radio",name:"groupSetSelector",id:"clearGroups"}).on("click",function(){k={};l=[];m()}).appendTo(a).prop("checked",!0);$("<label />",{"for":"clearGroups"}).append($("<span />",{"class":"icon-txt",text:"No long-term groups"})).appendTo(a);var c=0;_.each(e,function(b){_.each(b,function(b){var g=b.orgUnit;if(g){var n=$("<div />",{}).appendTo(a),v=b.groupSet,d=$("<div />",{}).appendTo(n),n=$("<div />",{"class":"flex-container-responsive"}).appendTo(d),h=sprintf("structuralGroup_%s",c),e=x(v);$("<input />",
{type:"radio",name:"groupSetSelector",id:h}).on("click",function(){e in k?k={}:(k={},k[e]=v);l=[];m(u())}).appendTo(n).prop("checked",e in k);$("<label />",{"for":h}).append($("<span />",{"class":"icon-txt",text:sprintf("Copy %s from %s",v.name,g.name)})).appendTo(n);_.each(b.groups,function(a){var b=$("<div />",{"class":"groupBuilderGroup"}).appendTo(d);_.each(a.members,function(a){t(a.name).appendTo(b)})});c++}})})},z=function(a,c,b){console.log("Simulate",a,c,b);var f=u();console.log("flatInitialGroups",
f);switch(b){case "allPresent":b=Participants.getParticipants();break;default:b=Participants.getPossibleParticipants()}b=_.without(b,Conversations.getCurrentConversation().author);b=_.omitBy(b,function(a){return _.some(f,function(b){return a in b})});var g;switch(a){case "byTotalGroups":for(a=f.length;a<parseInt(c);a++)f.push({});g=function(a){_.sortBy(f,function(a){return _.keys(a).length})[0][a]=!0};break;case "byMaximumSize":g=function(a){var b=_.find(f,function(a){return _.keys(a).length<parseInt(c)});
b||(b={},f.push(b));b[a]=!0}}_.each(b,g);console.log(f);return _.map(f,_.keys)},A=function(a){_.each([["Show me all my enrolled students","allEnrolled"],["Only show me students who are here right now","allPresent"]],function(c){$("<option />",{text:c[0],value:c[1]}).appendTo(a)})},B=function(a){_.each([["there are","byTotalGroups"],["each has","byMaximumSize"]],function(c){$("<option />",{text:c[0],value:c[1]}).appendTo(a)})},p=function(){var a=$("#groupsPopup");$("#groupComposition");a.find(".importGroups").empty();
var c=a.find(".groups").empty(),b=Conversations.getCurrentSlide();b&&_.each(b.groupSets,function(a){_.each(_.sortBy(a.groups,"title"),function(g){var d=$("<div />",{"class":"groupBuilderGroup"}).appendTo(c).droppable({drop:function(c,d){var e=$(d.draggable).find(".groupBuilderMember").addBack(".groupBuilderMember");console.log("Dropped",$(d.draggable),e);_.each(e,function(c){var d=$(c).text();console.log("Drop member",d);_.includes(g.members,d)||(_.each(a.groups,function(a){a.members=_.without(a.members,
d)}),g.members.push(d),p(),Conversations.overrideAllocation(b))});c.preventDefault()}});$("<div />",{"class":"title",text:sprintf("Group %s",g.title)}).appendTo(d);_.each(g.members,function(a){t(a).appendTo(d).draggable()})})})},m=function(a){var c=$(".jAlert .groupSlideDialog").find(".groups");a=a||z(d,h[d],r);c.empty();_.each(a,function(b){var d=$("<div />",{"class":"groupBuilderGroup ghost"});_.each(b,function(a){t(a).draggable().appendTo(d)});d.droppable({drop:function(c,d){var e=$(d.draggable).text();
_.each(a,function(a){_.includes(a,e)&&a.splice(a.indexOf(e),1)});b.push(e);l=a;m(a);c.preventDefault()}});d.appendTo(c)});l=a},q=function(a){$(".groupsOu.blocker").toggle(a)},w=function(a){console.log(a);$("#groupSlideDialog .importGroups").text(a)};Progress.groupProvidersReceived.GroupBuilder=function(a){var c=$(".jAlert .ouSelector").empty();$("<option />",{text:"no starting groups",value:"NONE",selected:!0}).appendTo(c);_.each(a.groupsProviders,function(a){$("<option />",{text:a,value:a}).appendTo(c)});
c.on("change",function(){var a=$(this).val();"NONE"!=a&&(q(!0),getOrgUnitsFromGroupProviders(a))})};Progress.orgUnitsReceived.GroupBuilder=function(a){"orgUnits"in a&&a.orgUnits.length||(q(!1),w(sprintf("No Org Units found for user %s",UserSettings.getUsername())))};Progress.groupSetsReceived.GroupBuilder=function(a){"groupSets"in a&&a.groupSets.length||(q(!1),w(sprintf("No Group Sets found in Org Unit %s",a.groupSets.name)))};Progress.groupsReceived.GroupBuilder=function(a){var c=e[a.orgUnit.name];
void 0===c&&(c={},e[a.orgUnit.name]=c);c[a.groupSet.name]=a;y();q(!1)};Progress.onBackstageShow.GroupBuilder=function(a){"groups"==a&&p();a=$("#menuGroups");Conversations.shouldModifyConversation()?a.parent().show():a.parent().hide()};Progress.currentSlideJidReceived.GroupBuilder=function(){"groups"==currentBackstage&&p()};Progress.conversationDetailsReceived.GroupBuilder=function(){"groups"==currentBackstage&&p()};return{showAddGroupSlideDialog:function(){getGroupsProviders();var a=$("#groupSlideDialog").clone().show();
$.jAlert({title:"Add Group page",width:"75%",content:a[0].outerHTML,btns:[{text:"Add page",theme:"green",closeAlert:!0,onClick:function(){var a=0<l.length?l:_.map(u(),_.keys);Conversations.addGroupSlide(d,parseInt(h[d]),a);k={};l=[];e={}}}]});var a=$(".jAlert .groupSlideDialog"),c=a.find(".strategySelect"),b=a.find(".parameterSelect"),f=a.find(".presentStudentsOnly");a.find(".groups");B(c);A(f);a.on("change",".presentStudentsOnly",function(){r=$(this).val();console.log(r);m()});a.on("change",".strategySelect",
function(){d=$(this).val();console.log("Strategy set:",d);b.empty();switch(d){case "byTotalGroups":_.each(_.range(2,10),function(a){$("<option />",{text:sprintf("%s groups in total",a),value:a.toString()}).appendTo(b)});b.val(h[d]).change();break;case "byMaximumSize":_.each(_.range(1,10),function(a){$("<option />",{text:1==a?"only one member":sprintf("at most %s members",a),value:a.toString()}).appendTo(b)}),b.val(h[d]).change()}});a.on("change",".parameterSelect",function(){console.log("change parameter",
h);h[d]=$(this).val();m()});c.val(d).change()},getExternalGroups:function(){return e}}}();
