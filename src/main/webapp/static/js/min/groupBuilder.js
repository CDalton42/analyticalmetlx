var GroupBuilder=function(){var m={},f=[],h={},k=[],d="byMaximumSize",g={byTotalGroups:5,byMaximumSize:4},n=function(a){return $("<div />",{"class":"groupBuilderMember",text:a})},u=function(){var a=$(".jAlert .groupSlideDialog").find(".importGroups").empty();_.each(h,function(b){_.each(b,function(c){var b=c.orgUnit;if(b){m[b.name]&&m[b.name].remove();var b=m[b.name]=$("<div />",{text:b.name}).appendTo(a),e=0,t=c.groupSet,r=$("<div />",{}).appendTo(b);r.append("<div />",{"class":"groupCatName",text:t.name});
_.each(c.groups,function(a){e++;var b=$("<div />",{"class":"groupBuilderGroup",text:a.name}).appendTo(r),c=sprintf("structuralGroup_%s",e);$("<input />",{type:"checkbox",id:c}).on("click",function(){_.includes(f,a)?f=_.without(f,a):f.push(a);q()}).appendTo(b).prop("checked",_.includes(f,a));$("<label />",{"for":c}).append($("<span />",{"class":"icon-txt",text:"Copy"})).appendTo(b);_.each(a.members,function(a){n(a.name).appendTo(b)})})}})})},v=function(a,b){var c=_.map(f,function(a){var b={};_.each(a.members,
function(a){b[a.name]=!0});return b}),p=_.without(Participants.getPossibleParticipants(),Conversations.getCurrentConversation().author),p=_.omitBy(p,function(a){return _.some(c,function(b){return a in b})}),e;switch(a){case "byTotalGroups":for(e=c.length;e<parseInt(b);e++)c.push({});e=function(a){_.sortBy(c,function(a){return _.keys(a).length})[0][a]=!0};break;case "byMaximumSize":e=function(a){var e=_.find(c,function(a){return _.keys(a).length<parseInt(b)});e||(e={},c.push(e));e[a]=!0}}_.each(p,
e);console.log(c);return _.map(c,_.keys)},w=function(a){_.each([["there are","byTotalGroups"],["each has","byMaximumSize"]],function(b){$("<option />",{text:b[0],value:b[1]}).appendTo(a)})},l=function(){var a=$("#groupsPopup");$("#groupComposition");a.find(".importGroups").empty();var b=a.find(".groups").empty(),c=Conversations.getCurrentSlide();c&&_.each(c.groupSets,function(a){_.each(_.sortBy(a.groups,"title"),function(e){var d=$("<div />",{"class":"groupBuilderGroup"}).appendTo(b).droppable({drop:function(b,
d){var f=$(d.draggable).find(".groupBuilderMember").addBack(".groupBuilderMember");console.log("Dropped",$(d.draggable),f);_.each(f,function(b){var d=$(b).text();console.log("Drop member",d);_.includes(e.members,d)||(_.each(a.groups,function(a){a.members=_.without(a.members,d)}),e.members.push(d),l(),Conversations.overrideAllocation(c))});b.preventDefault()}});$("<div />",{"class":"title",text:sprintf("Group %s",e.title)}).appendTo(d);_.each(e.members,function(a){n(a).appendTo(d).draggable()})})})},
q=function(a){var b=$(".jAlert .groupSlideDialog"),c=b.find(".strategySelect"),d=b.find(".parameterSelect"),e=b.find(".groups");a=a||v(c.val(),d.val());e.empty();_.each(a,function(b){console.log(b);var c=$("<div />",{"class":"groupBuilderGroup ghost"});_.each(b,function(a){n(a).draggable().appendTo(c)});c.droppable({drop:function(c,e){var d=$(e.draggable).text();_.each(a,function(a){_.includes(a,d)&&a.splice(a.indexOf(d),1)});b.push(d);k=a;q(a);c.preventDefault()}});c.appendTo(e)})};Progress.groupProvidersReceived.GroupBuilder=
function(a){var b=$(".jAlert .ouSelector").empty();$("<option />",{text:"no starting groups",value:"NONE",selected:!0}).appendTo(b);_.each(a.groupsProviders,function(a){$("<option />",{text:a,value:a}).appendTo(b)});b.on("change",function(){var a=$(this).val();"NONE"!=a&&getOrgUnitsFromGroupProviders(a)})};Progress.groupsReceived.GroupBuilder=function(a){var b=h[a.orgUnit.name];void 0===b&&(b={},h[a.orgUnit.name]=b);b[a.groupSet.name]=a;u()};Progress.onBackstageShow.GroupBuilder=function(a){"groups"==
a&&l()};Progress.currentSlideJidReceived.GroupBuilder=function(){"groups"==currentBackstage&&l()};Progress.conversationDetailsReceived.GroupBuilder=function(){"groups"==currentBackstage&&l()};return{showAddGroupSlideDialog:function(){getGroupsProviders();var a=$("#groupSlideDialog").clone().show();$.jAlert({title:"Add Group page",width:"75%",content:a[0].outerHTML,btns:[{text:"Add page",theme:"green",closeAlert:!0,onClick:function(){var a=0<k.length?k:_.map(f,function(a){return _.map(a.members,"name")});
Conversations.addGroupSlide(d,parseInt(g[d]),a);k=[];h={}}}]});var a=$(".jAlert .groupSlideDialog"),b=a.find(".strategySelect"),c=a.find(".parameterSelect");a.find(".groups");w(b);a.on("change",".strategySelect",function(){d=$(this).val();console.log("Strategy set:",d);c.empty();switch(d){case "byTotalGroups":_.each(_.range(2,10),function(a){$("<option />",{text:sprintf("%s groups in total",a),value:a.toString()}).appendTo(c)});c.val(g[d]).change();break;case "byMaximumSize":_.each(_.range(1,10),
function(a){$("<option />",{text:1==a?"only one member":sprintf("at most %s members",a),value:a.toString()}).appendTo(c)}),c.val(g[d]).change()}});a.on("change",".parameterSelect",function(){console.log("change parameter",g);g[d]=$(this).val();q()});b.val(d).change()}}}();
