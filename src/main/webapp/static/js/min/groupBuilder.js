var GroupBuilder=function(){var g={},e=[],f={},m=function(b){return $("<div />",{"class":"groupBuilderMember",text:b})},q=function(){var b=$("#groupsPopup").find(".importGroups").empty();_.each(f,function(a){_.each(a,function(a){var c=a.orgUnit;if(c){g[c.name]&&g[c.name].remove();var c=g[c.name]=$("<div />",{text:c.name}).appendTo(b),d=0,f=a.groupSet,k=$("<div />",{}).appendTo(c);k.append("<div />",{"class":"groupCatName",text:f.name});_.each(a.groups,function(a){d++;var b=$("<div />",{"class":"groupBuilderGroup",
text:a.name}).appendTo(k),c=sprintf("structuralGroup_%s",d);$("<input />",{type:"checkbox",id:c}).on("click",function(){_.includes(e,a)?e=_.without(e,a):e.push(a);l()}).appendTo(b).prop("checked",_.includes(e,a));$("<label />",{"for":c}).append($("<span />",{"class":"icon-txt",text:"Copy"})).appendTo(b);_.each(a.members,function(a){m(a.name).appendTo(b)})})}})})},l=function(){var b=$("#groupsPopup"),a=$("#groupComposition").empty();b.find(".importGroups").empty();var h=Conversations.getCurrentSlide(),
c=$("<select />",{id:"strategySelect"}).appendTo(a),d=$("<select />",{id:"parameterSelect"}).appendTo(a),a=$("#doAllocation").off("click").on("click",function(){Conversations.addGroupSlide(c.val(),parseInt(d.val()),_.map(e,function(a){return _.map(a.members,"name")}));e=[]});_.each([["there are","byTotalGroups"],["each has","byMaximumSize"]],function(a){$("<option />",{text:a[0],value:a[1]}).appendTo(c)});c.on("change",function(){var a=$(this).val();d.empty();switch(a){case "byTotalGroups":_.each(_.range(2,
10),function(a){$("<option />",{text:sprintf("%s groups in total",a),value:a}).appendTo(d)});d.val(5);break;case "byMaximumSize":_.each(_.range(1,10),function(a){$("<option />",{text:1==a?"only one member":sprintf("at most %s members",a),value:a}).appendTo(d)}),d.val(4)}});c.val("byMaximumSize").change();var f=b.find(".allocatedMembers").empty(),k=b.find(".unallocatedMembers").empty(),g=b.find(".groups").empty(),n=_.clone(Participants.getParticipants());delete n[Conversations.getCurrentConversation.author];
var p={};h&&(h.groupSets.length?(d.prop("disabled",!0),c.prop("disabled",!0),a.prop("disabled",!0),$("#importContainer").hide()):$("#importContainer").show(),_.each(e,function(a){var b=$("<div />",{"class":"groupBuilderGroup ghost"});_.each(a.members,function(a){m(a.name).appendTo(b)});b.appendTo(g)}),_.each(h.groupSets,function(a){_.each(_.sortBy(a.groups,"title"),function(b){var c=$("<div />",{"class":"groupBuilderGroup"}).droppable({drop:function(c,d){var e=$(d.draggable).find(".groupBuilderMember");
_.each(e,function(c){var d=$(c).text();_.includes(b.members,d)||(_.each(a.groups,function(a){a.members=_.without(a.members,d)}),b.members.push(d),l(),Conversations.overrideAllocation(h))});c.preventDefault()}});_.each(b.members,function(a){delete n[a];p[a]=1;m(a).draggable().appendTo(c)});$("<div />",{"class":"title",text:sprintf("Group %s",b.title)}).prependTo(c);c.appendTo(g)})}));_.each(p,function(a,b){$("<div />",{text:b,"class":"member"}).appendTo(f)});_.each(n,function(a,b){$("<div />",{text:b,
"class":"member"}).appendTo(k)});q()};Progress.groupProvidersReceived.GroupBuilder=function(b){var a=$("#ouSelector").empty();$("<option />",{text:"no starting groups",value:"NONE",selected:!0}).appendTo(a);_.each(b.groupsProviders,function(b){$("<option />",{text:b,value:b}).appendTo(a)});a.on("change",function(){var a=$(this).val();"NONE"!=a&&getOrgUnitsFromGroupProviders(a)})};Progress.groupsReceived.GroupBuilder=function(b){var a=f[b.orgUnit.name];void 0===a&&(a={},f[b.orgUnit.name]=a);a[b.groupSet.name]=
b;q()};Progress.currentSlideJidReceived.GroupBuilder=l;Progress.conversationDetailsReceived.GroupBuilder=function(){getGroupsProviders();l()};return{}}();
