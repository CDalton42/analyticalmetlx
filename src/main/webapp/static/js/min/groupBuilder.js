var GroupBuilder=function(){var f={},l={},h=[],c="byMaximumSize",n="allPresent",k={byTotalGroups:5,byMaximumSize:4},t=function(a){return $("<div />",{"class":"groupBuilderMember",text:a})},z=function(a){var b=a.foreignRelationship;return b?sprintf("%s@%s",b.key,b.system):a.name},v=function(){return _.flatMap(f,function(a){return _.map(a.groups,function(a){var d={};_.each(a.members,function(a){d[a.name]=!0});return d})})},A=function(){var a=$(".jAlert .groupSlideDialog").find(".importGroups").empty();
$("<input />",{type:"radio",name:"groupSetSelector",id:"clearGroups"}).on("click",function(){f={};h=[];m()}).appendTo(a).prop("checked",!0);$("<label />",{"for":"clearGroups"}).append($("<span />",{"class":"icon-txt",text:"No long-term groups"})).appendTo(a);var b=0;_.each(l,function(d){_.each(d,function(d){var e=d.orgUnit;if(e){var p=$("<div />",{}).appendTo(a),u=d.groupSet,w=$("<div />",{}).appendTo(p),p=$("<div />",{"class":"flex-container-responsive"}).appendTo(w),x=sprintf("structuralGroup_%s",
b),c=z(u);$("<input />",{type:"radio",name:"groupSetSelector",id:x}).on("click",function(){c in f?f={}:(f={},f[c]=u);h=[];m(v())}).appendTo(p).prop("checked",c in f);$("<label />",{"for":x}).append($("<span />",{"class":"icon-txt",text:sprintf("Copy %s from %s",u.name,e.name)})).appendTo(p);_.each(d.groups,function(a){var b=$("<div />",{"class":"groupBuilderGroup"}).appendTo(w);_.each(a.members,function(a){t(a.name).appendTo(b)})});b++}})})},B=function(a,b,d){console.log("Simulate",a,b,d);var g=v();
console.log("flatInitialGroups",g);var e={};switch(d){case "allPresent":_.each(Participants.getParticipants(),function(a){e[a.name]=!0});break;case "allEnrolled":_.each(Participants.getPossibleParticipants(),function(a){e[a]=!0})}delete e[Conversations.getCurrentConversation().author];d=_.omitBy(e,function(a,b){return _.some(g,function(a){return b in a})});var c;switch(a){case "byTotalGroups":for(a=g.length;a<parseInt(b);a++)g.push({});c=function(a,b){_.sortBy(g,function(a){return _.keys(a).length})[0][b]=
!0};break;case "byMaximumSize":c=function(a,d){var e=_.find(g,function(a){return _.keys(a).length<parseInt(b)});e||(e={},g.push(e));e[d]=!0}}_.each(d,c);console.log("Simulation participants",e,d,g);return g},C=function(a){_.each([["Show me all my enrolled students","allEnrolled"],["Only show me students who are here right now","allPresent"]],function(b){$("<option />",{text:b[0],value:b[1]}).prop("selected",b[1]==n).appendTo(a)})},D=function(a){_.each([["there are","byTotalGroups"],["each has","byMaximumSize"]],
function(b){$("<option />",{text:b[0],value:b[1]}).appendTo(a)})},q=function(){var a=$("#groupsPopup");$("#groupComposition");a.find(".importGroups").empty();var b=a.find(".groups").empty(),d=Conversations.getCurrentSlide();d&&_.each(d.groupSets,function(a){_.each(_.sortBy(a.groups,"title"),function(e){var c=$("<div />",{"class":"groupBuilderGroup"}).appendTo(b).droppable({drop:function(b,c){var f=$(c.draggable).find(".groupBuilderMember").addBack(".groupBuilderMember");console.log("Dropped",$(c.draggable),
f);_.each(f,function(b){var c=$(b).text();console.log("Drop member",c);_.includes(e.members,c)||(_.each(a.groups,function(a){a.members=_.without(a.members,c)}),e.members.push(c),q(),Conversations.overrideAllocation(d))});b.preventDefault()}});$("<div />",{"class":"title",text:sprintf("Group %s",e.title)}).appendTo(c);_.each(e.members,function(a){t(a).appendTo(c).draggable()})})})},m=function(a){var b=$(".jAlert .groupSlideDialog").find(".groups");a=a||B(c,k[c],n);b.empty();_.each(a,function(d){var c=
$("<div />",{"class":"groupBuilderGroup ghost"});_.each(d,function(a,b){t(b).draggable().appendTo(c)});c.droppable({drop:function(b,c){var f=$(c.draggable).text();_.each(a,function(a){delete a[f]});d[f]=!0;h=a;m(a);b.preventDefault()}});c.appendTo(b)});h=a},r=function(a){$(".groupsOu.blocker").toggle(a)},y=function(a){console.log(a);$("#groupSlideDialog .importGroups").text(a)};Progress.groupProvidersReceived.GroupBuilder=function(a){var b=$(".jAlert .ouSelector").empty();$("<option />",{text:"no starting groups",
value:"NONE",selected:!0}).appendTo(b);_.each(a.groupsProviders,function(a){$("<option />",{text:a,value:a}).appendTo(b)});b.on("change",function(){var a=$(this).val();"NONE"!=a&&(r(!0),getOrgUnitsFromGroupProviders(a))})};Progress.orgUnitsReceived.GroupBuilder=function(a){"orgUnits"in a&&a.orgUnits.length||(r(!1),y(sprintf("No Org Units found for user %s",UserSettings.getUsername())))};Progress.groupSetsReceived.GroupBuilder=function(a){"groupSets"in a&&a.groupSets.length||(r(!1),y(sprintf("No Group Sets found in Org Unit %s",
a.groupSets.name)))};Progress.groupsReceived.GroupBuilder=function(a){var b=l[a.orgUnit.name];void 0===b&&(b={},l[a.orgUnit.name]=b);b[a.groupSet.name]=a;A();r(!1)};Progress.onBackstageShow.GroupBuilder=function(a){"groups"==a&&q();a=$("#menuGroups");Conversations.shouldModifyConversation()?a.parent().show():a.parent().hide()};Progress.currentSlideJidReceived.GroupBuilder=function(){"groups"==currentBackstage&&q()};Progress.conversationDetailsReceived.GroupBuilder=function(){"groups"==currentBackstage&&
q()};return{showAddGroupSlideDialog:function(){getGroupsProviders();var a=$("#groupSlideDialog").clone().show();$.jAlert({title:"Add Group page",width:"75%",content:a[0].outerHTML,btns:[{text:"Add page",theme:"green",closeAlert:!0,onClick:function(){var a=_.map(h,_.keys);console.log("IteratedGroups",h,a);Conversations.addGroupSlide(c,parseInt(k[c]),a);f={};h=[];l={}}}]});var a=$(".jAlert .groupSlideDialog"),b=a.find(".strategySelect"),d=a.find(".parameterSelect"),g=a.find(".groupScope");a.find(".groups");
D(b);C(g);a.on("change",".groupScope",function(){n=$(this).val();console.log(n);m()});a.on("change",".strategySelect",function(){c=$(this).val();console.log("Strategy set:",c);d.empty();switch(c){case "byTotalGroups":_.each(_.range(2,10),function(a){$("<option />",{text:sprintf("%s groups in total",a),value:a.toString()}).appendTo(d)});d.val(k[c]).change();break;case "byMaximumSize":_.each(_.range(1,10),function(a){$("<option />",{text:1==a?"only one member":sprintf("at most %s members",a),value:a.toString()}).appendTo(d)}),
d.val(k[c]).change()}});a.on("change",".parameterSelect",function(){console.log("change parameter",k);k[c]=$(this).val();m()});b.val(c).change()},getExternalGroups:function(){return l}}}();
