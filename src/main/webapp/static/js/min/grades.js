var Grades=function(){var c={},B={},k={},l={},E={},H={},I={},J={},C=[],t=function(){},a=function(L,a){$(L).prop("disabled",a);$(".grades.blocker").toggle(a)},K=function(){B={};k={};l={};t()},y=function(a,u){try{if("type"in a){switch(a.type){case "grade":var h=B[a.id];if(void 0==h||h.timestamp<a.timestamp)B[a.id]=a,!u&&h&&"visible"in h&&0==h.visible&&"visible"in a&&1==a.visible&&getHistory(Conversations.getCurrentSlideJid());break;case "numericGradeValue":case "booleanGradeValue":case "textGradeValue":var c=
k[a.gradeId]||{};k[a.gradeId]=c;var l=c[a.gradedUser];if(!l||l.timestamp<a.timestamp)c[a.gradedUser]=a,Progress.call("gradeValueReceived",[a])}u||t()}}catch(q){console.log("Grades.stanzaReceived",q)}};Progress.onConversationJoin.Grades=K;Progress.historyReceived.Grades=function(a){try{"type"in a&&"history"==a.type&&(K(),_.forEach(a.grades,function(a){y(a,!0)}),_.forEach(a.gradeValues,function(a){y(a,!0)}),t())}catch(c){console.log("Grades.historyReceivedFunction",c)}};Progress.stanzaReceived.Grades=
y;$(function(){$.getJSON("/getExternalGradebooks",function(a){C=a});console.log("Conv state:",Conversations.getCurrentConversationJid(),Conversations.shouldModifyConversation(),Conversations.getCurrentConversation());var y=function(){c=$("#gradesDatagrid");H=c.find(".gradeActionsContainer").clone();I=c.find(".gradeEditContainer").clone();J=c.find(".gradeAssessContainer").clone();c.empty();E=$("#createGradeButton");var h=function(a){jsGrid.Field.call(this,a)};h.prototype=new jsGrid.Field({sorter:function(a,
e){return new Date(a)-new Date(e)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=h;var h=[{name:"name",type:"text",title:"Name",readOnly:!0,sorting:!0},{name:"description",type:"text",title:"Description",readOnly:!0,sorting:!0},{name:"location",type:"text",title:"Location",readOnly:!0,sorting:!0},{name:"timestamp",type:"dateField",
title:"When",readOnly:!0,itemTemplate:function(a){return 0==a?"":moment(a).format("MMM Do YYYY, h:mm a")}}],u=[{name:"gradeType",type:"text",title:"Type",readOnly:!0,sorting:!0},{name:"identity",type:"text",title:"Actions",readOnly:!0,sorting:!1,itemTemplate:function(c,e){if(e.author==UserSettings.getUsername()){var h=H.clone(),b=_.cloneDeep(e),v=function(){var e=_.uniqueId(),c=$("<div/>",{id:e}),h=$.jAlert({title:"Edit grade",width:"50%",content:c[0].outerHTML}),g=I.clone(),c=sprintf("gradeName_%s",
e),q=g.find(".gradeNameInputBox");q.attr("id",c).on("blur",function(a){b.name=q.val()}).val(b.name);g.find(".gradeNameLabel").attr("for",c);var c=sprintf("gradeDesc_%s",e),k=g.find(".gradeDescriptionInputBox");k.attr("id",c).on("blur",function(a){b.description=k.val()}).val(b.description);g.find(".gradeDescriptionLabel").attr("for",c);var c=sprintf("gradeType_%s",e),F=g.find(".gradeTypeSelect"),G=g.find(".numericMinTextbox"),z=g.find(".numericMaxTextbox"),n=sprintf("numericMin_%s",e),x=sprintf("numericMax_%s",
e);g.find(".numericMinLabel").attr("for",n);g.find(".numericMaxLabel").attr("for",x);G.on("blur",function(a){"numeric"==b.gradeType?b.numericMinimum=parseFloat(G.val()):delete b.numericMinimum}).attr("id",n);z.on("blur",function(a){"numeric"==b.gradeType?b.numericMaximum=parseFloat(z.val()):delete b.numericMaximum}).attr("id",x);var l=function(){"foreignRelationship"in b&&(G.prop("disabled",!0),z.prop("disabled",!0),F.prop("disabled",!0));F.val(b.gradeType);switch(b.gradeType){case "numeric":g.find(".numericOptions").show();
void 0===b.numericMinimum&&(b.numericMinimum=0);void 0===b.numericMaximum&&(b.numericMaximum=100);G.val(b.numericMinimum);z.val(b.numericMaximum);break;default:g.find(".numericOptions").hide()}};F.attr("id",c).on("change",function(){b.gradeType=F.val();l()}).val(b.gradeType);l();g.find(".gradeTypeLabel").attr("for",c);c=sprintf("gradeVisible_%s",e);g.find(".gradeVisibleLabel").attr("for",c);var f=g.find(".gradeVisibleCheckbox");f.attr("id",c).prop("checked",b.visible).on("change",function(a){b.visible=
f.prop("checked")});var r=void 0,A=void 0,D=void 0,w=function(){var d=g.find(".associateController");a(d,!1);if("foreignRelationship"in b){d.find(".createAssociation").hide();var e=b.foreignRelationship.sys,c=b.foreignRelationship.key.split("_"),z=c[0],n=c[1];d.find(".associationSystem").text(e);d.find(".associationOrgUnit").text(z);d.find(".associationGradeId").text(n);d.find(".requestRefreshAssociation").unbind("click").on("click",function(){a(d,!0);$.getJSON(sprintf("/getExternalGrade/%s/%s/%s",
e,z,n),function(d){b.description=d.description;b.name=d.name;b.gradeType=d.gradeType;b.numericMinimum=d.numericMinimum;b.numericMaximum=d.numericMaximum;h.closeAlert();v();a(this,!1)}).fail(function(b,e,r){a(d,!1);console.log(e,r);alert(sprintf("Error: %s \r\n %s",e,r))})});d.find(".refreshAssociation").show()}else if(d.find(".refreshAssociation").hide(),d.find(".createAssociation").show(),d.find(".associationPhase").hide(),void 0===r)d.find(".requestAssocPhase1").show(),d.find(".requestAssociation").unbind("click").on("click",
function(){r=!0;1==C.length&&(A=C[0].id);w()});else if(void 0==A)A=C[0].id,d.find(".chooseGradebook").html(_.map(C,function(a){return $("<option/>",{value:a.id,text:a.name})})).unbind("change").on("change",function(a){A=$(this).val()}),d.find(".commitGradebook").unbind("click").on("click",function(){a(this,!0);w()}),d.find(".requestAssocPhase2").show();else if(void 0===D)a(d,!0),$.getJSON(sprintf("/getExternalGradebookOrgUnits/%s",A),function(b){console.log("requestedOrgUnits:",b);b&&b.length?(D=
b[0].foreignRelationship.key,d.find(".chooseOrgUnit").html(_.map(b,function(a){return $("<option/>",{value:a.foreignRelationship.key,text:a.name})})).unbind("change").on("change",function(a){D=$(this).val()}),d.find(".commitOrgUnit").unbind("click").on("click",function(){w()}),d.find(".requestAssocPhase3").show()):(console.log("found no data:",b),d.text("No gradebooks found"));a(d,!1)}).fail(function(b,e,r){a(d,!1);console(sprintf("error: %s \r\n %s",e,r));alert(sprintf("error: %s \r\n %s",e,r))});
else{d.find(".requestAssocPhase4").show();a(d,!0);var m=d.find(".linkGrade"),x=[],f=d.find("#chooseExistingGradeSelectBox"),p=void 0;m.unbind("click").on("click",function(){void 0!==p&&"foreignRelationship"in p&&"sys"in p.foreignRelationship&&"key"in p.foreignRelationship?(b.foreignRelationship={sys:p.foreignRelationship.sys,key:p.foreignRelationship.key},b.gradeType=p.gradeType,b.numericMinimum=p.numericMinimum,b.numericMaximum=p.numericMaximum,b.name=p.name,q.val(b.name),b.description=p.description,
k.val(b.description),sendStanza(b),w(),l()):alert("no pre-existing grade chosen")}).prop("disabled",!0);f.unbind("change").on("change",function(a){var d=$(this).val();void 0!==d&&"no-choice"!==d?(p=_.find(x,function(a){return"foreignRelationship"in a&&"key"in a.foreignRelationship&&a.foreignRelationship.key==d}),void 0!==p?m.prop("disabled",!1):m.prop("disabled",!0)):(p=void 0,m.prop("disabled",!0))});$.ajax({type:"GET",url:sprintf("/getExternalGrades/%s/%s",A,D),success:function(b){console.log("found external grades:",
b);x=b;b.length?f.html(_.map([{text:"",foreignRelationship:{system:"no-system",key:"no-choice"}}].concat(b),function(a){return $("<option/>",{text:a.name,value:a.foreignRelationship.key})})):(f.hide(),m.prop("disabled",!0),m.hide());a(d,!1)},dataType:"json"}).fail(function(b,e,r){a(d,!1);alert(sprintf("error - could not fetch existing grades from remote gradebook: %s \r\n %s",e,r))});d.find(".createGrade").unbind("click").on("click",function(){a(d,!0);$.ajax({type:"POST",url:sprintf("/createExternalGrade/%s/%s",
A,D),data:JSON.stringify(b),success:function(d){console.log("createdGrades:",b,d);b.foreignRelationship={sys:d.foreignRelationship.sys,key:d.foreignRelationship.key};sendStanza(b);w();a(this,!1)},contentType:"application/json",dataType:"json"}).fail(function(b,e,r){a(d,!1);alert("Could not create remote grade.  Please ensure that the grade has a non-blank name which will be unique within the remote system")})})}};w();g.find(".cancelGradeEdit").on("click",function(){h.closeAlert()});g.find(".submitGradeEdit").on("click",
function(){sendStanza(b);h.closeAlert()});$("#"+e).append(g)};h.find(".editGradeButton").on("click",v);h.find(".assessGradeButton").on("click",function(){var b=_.uniqueId(),c=$("<div/>",{id:b});$.jAlert({title:"Assess grade",width:"auto",content:c[0].outerHTML,onClose:function(){t()}});var h={},g=J.clone();$("#"+b).append(g);a(g,!0);var f=g.find(".gradebookDatagrid"),h=g.find(".gradeValueEditPopup").clone();f.find(".gradeUserContainer").clone();f.empty();var q=function(b){var c=k[e.id];void 0==c&&
(k[e.id]={},c={});var h=sprintf("%sGradeValue",e.gradeType),f=Participants.getPossibleParticipants();if("foreignRelationship"in e){var q=e.foreignRelationship.sys,v=e.foreignRelationship.key.split("_")[0];$.getJSON(sprintf("/getExternalGradebookOrgUnitClasslist/%s/%s",q,v),function(a){_.forEach(a,function(a){a=a.UserName;void 0!==a&&f.push(a)});f=_.uniq(f);_.forEach(f,function(a){void 0==c[a]&&(c[a]={type:h,gradeId:e.id,gradedUser:a,gradePrivateComment:"",gradeComment:"",author:e.author,timestamp:0,
audiences:[]})});console.log("possibleParticipants:",f,c);c=_.values(c);c=_.filter(c,function(a){return a.type==h});b(c)}).fail(function(b,e,c){a(g,!1);console.log("error",e,c)})}else _.forEach(f,function(a){void 0==c[a]&&(c[a]={type:h,gradeId:e.id,gradedUser:a,author:e.author,gradePrivateComment:"",gradeComment:"",timestamp:0,audiences:[]})}),c=_.values(c),c=_.filter(c,function(a){return a.type==h}),b(c)},v=function(b){var c=function(a){var b=sprintf("changeGvPopup_%s",_.uniqueId()),c=$("<div/>",
{id:b});console.log("gvPopup",a);var w=$.jAlert({type:"modal",content:c[0].outerHTML,title:sprintf("Change score for %s",a.gradedUser)}),b=$("#"+b),c=h.clone(),d=c.find(".changeGradeContainer"),f=d.find(".numericScore"),g=d.find(".booleanScore"),k=d.find(".booleanScoreLabel"),l=d.find(".textScore"),m=_.cloneDeep(a);switch(e.gradeType){case "numeric":d=function(a){m.gradeValue=parseFloat(f.val())};f.val(a.gradeValue).attr("min",e.numericMinimum).attr("max",e.numericMaximum).on("blur",d);g.remove();
k.remove();l.remove();break;case "text":f.remove();d=function(a){m.gradeValue=l.val()};l.val(a.gradeValue).on("blur",d);k.remove();g.remove();break;case "boolean":f.remove();var n=sprintf("booleanScoreId_%s",_.uniqueId()),d=function(a){m.gradeValue=g.prop("checked")};g.on("change",d).prop("checked",a.gradeValue).attr("id",n);k.attr("for",n);l.remove();break;default:f.remove(),g.remove(),k.remove(),l.remove()}k=sprintf("privateComment_%s",_.uniqueId);c.find(".gradeValueCommentTextbox").val(a.gradeComment).attr("id",
k).on("blur",function(){m.gradeComment=$(this).val()});c.find(".gradeValueCommentTextboxLabel").attr("for",k);k=sprintf("privateComment_%s",_.uniqueId);c.find(".gradeValuePrivateCommentTextbox").val(a.gradePrivateComment).attr("id",k).on("blur",function(){m.gradePrivateComment=$(this).val()});c.find(".gradeValuePrivateCommentTextboxLabel").attr("for",k);c.find(".submitGradeValueChange").on("click",function(){sendStanza(m);a.gradeValue=m.gradeValue;a.gradeComment=m.gradeComment;a.gradePrivateComment=
m.gradePrivateComment;console.log("sending:",m);w.closeAlert();q(v)});c.find(".cancelGradeValueChange").on("click",function(){w.closeAlert()});b.append(c)},n=[{name:"gradedUser",type:"text",title:"Who",readOnly:!0,sorting:!0},{name:"timestamp",type:"dateField",title:"When",readOnly:!0,itemTemplate:function(a){return 0==a?"":moment(a).format("MMM Do YYYY, h:mm a")}},{name:"gradeValue",type:"text",title:"Score",readOnly:!0,sorting:!0},{name:"gradeComment",type:"text",title:"Comment",readOnly:!0,sorting:!0},
{name:"gradePrivateComment",type:"text",title:"Private comment",readOnly:!0,sorting:!0}];"foreignRelationship"in e&&n.push({name:"remoteGrade",type:"text",title:"Remote score",readOnly:!0,sorting:!0},{name:"remoteComment",type:"text",title:"Remote comment",readOnly:!0,sorting:!0},{name:"remotePrivateComment",type:"text",title:"Remote private comment",readOnly:!0,sorting:!0});f.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,rowClick:function(a){c(a.item)},noDataContent:"No gradeable users",
controller:{loadData:function(a){var c=_.map(b,function(a){if("foreignRelationship"in e&&e.id in l){var b=l[e.id];"remoteGrade"in a||(b=_.find(b,function(b){return b.gradedUser==a.gradedUser}),void 0!=b&&(a.remoteGrade=b.gradeValue,a.remoteComment=b.gradeComment,a.remotePrivateComment=b.gradePrivateComment))}return a});"sortField"in a&&(c=_.sortBy(c,function(b){return b[a.sortField]}),"sortOrder"in a&&"desc"==a.sortOrder&&(c=_.reverse(c)));return c}},pageLoading:!1,fields:n});f.jsGrid("loadData");
f.jsGrid("sort",{field:"gradedUser",order:"desc"});if("foreignRelationship"in e){var x=e.foreignRelationship.sys,n=e.foreignRelationship.key.split("_"),t=n[0],u=n[1];g.find(".getRemoteData").on("click",function(){var b=this;a(b,!0);$.getJSON(sprintf("/getExternalGradeValues/%s/%s/%s",x,t,u),function(c){q(function(f){l[e.id]=f;_.forEach(f,function(e){var d=_.find(c,function(a){return a.gradedUser==e.gradedUser});void 0!==d&&(e.remoteGrade=d.gradeValue,e.remoteComment=d.gradeComment,e.remotePrivateComment=
d.gradePrivateComment);a(b,!1)});return v(f)})}).fail(function(c,e,f){a(b,!1);console.log("error",e,f)})});g.find(".sendGradesToRemote").on("click",function(){var b=this;a(b,!0,function(a){return $(a).find("span")});var c=_.filter(k[e.id],function(a){return void 0!=a.gradeValue});$.ajax({type:"POST",data:JSON.stringify(c),dataType:"json",success:function(c){q(function(f){l[e.id]=f;_.forEach(f,function(a){var b=_.find(c,function(b){return b.gradedUser==a.gradedUser});void 0!==b&&(a.remoteGrade=b.gradeValue,
a.remoteComment=b.gradeComment,a.remotePrivateComment=b.gradePrivateComment)});a(b,!1);return v(f)})},url:sprintf("/updateExternalGradeValues/%s/%s/%s",x,t,u),contentType:"application/json"}).fail(function(c,e,d){a(b,!1);console.log("error",e,d)})})}else g.find(".gradeSyncActions").remove();a(g,!1)};q(v)});return h}return $("<span/>")}}],y=[{name:"myGradeValue",type:"text",title:"Score",readOnly:!0,sorting:!0},{name:"myGradeComment",type:"text",title:"Comment",readOnly:!0,sorting:!0}],h=Conversations.shouldModifyConversation()?
_.concat(h,u):_.concat(h,y);c.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No grades",controller:{loadData:function(a){var c=Conversations.shouldModifyConversation(),f=_.map(_.filter(B,function(a){return c||a.visible}),function(a){var c=k[a.id];void 0!==c&&(c=c[UserSettings.getUsername()],void 0!==c&&(a.myGradeValue=c.gradeValue,a.myGradeComment=c.gradeComment));return a});"sortField"in a&&(f=_.sortBy(f,function(b){return b[a.sortField]}),"sortOrder"in
a&&"desc"==a.sortOrder&&(f=_.reverse(f)));return f}},pageLoading:!1,fields:h});c.jsGrid("sort",{field:"timestamp",order:"desc"});t=function(){WorkQueue.enqueue(function(){c.jsGrid("loadData");var a=c.jsGrid("getSorting");"field"in a&&c.jsGrid("sort",a);E.unbind("click");Conversations.shouldModifyConversation()?E.on("click",function(){console.log("clicked createButton");if(Conversations.shouldModifyConversation()){var a=Conversations.getCurrentSlideJid(),c=UserSettings.getUsername(),a={type:"grade",
name:"",description:"",audiences:[],author:c,location:a,id:sprintf("%s_%s_%s",a,c,(new Date).getTime().toString()),gradeType:"numeric",numericMinimum:0,numericMaximum:100,visible:!1,timestamp:0};sendStanza(a)}}).show():E.hide()})};t()},u=function(){"jid"in Conversations.getCurrentConversation()?y():_.delay(u,500)};u()});return{getGrades:function(){return B},getGradeValues:function(){return k},reRender:t}}();
