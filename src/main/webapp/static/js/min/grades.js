var Grades=function(){var d={},n={},g={},u={},y={},z={},A={},p=[],l=function(){WorkQueue.enqueue(function(){d.jsGrid("loadData");var a=d.jsGrid("getSorting");"field"in a&&d.jsGrid("sort",a);u.unbind("click");Conversations.shouldModifyConversation()?u.on("click",function(){console.log("clicked createButton");if(Conversations.shouldModifyConversation()){var a=Conversations.getCurrentSlideJid(),f=UserSettings.getUsername(),a={type:"grade",name:"",description:"",audiences:[],author:f,location:a,id:sprintf("%s_%s_%s",
a,f,(new Date).getTime().toString()),gradeType:"numeric",numericMinimum:0,numericMaximum:100,visible:!1,timestamp:0};sendStanza(a)}}).show():u.hide()})},B=function(){n={};g={};l()},r=function(a,d){try{if("type"in a){switch(a.type){case "grade":var f=n[a.id];if(void 0==f||f.timestamp<a.timestamp)n[a.id]=a;break;case "numericGradeValue":var c=g[a.gradeId];void 0==c&&(c={},g[a.gradeId]=c);f=c[a.gradedUser];if(void 0==f||f.timestamp<a.timestamp)c[a.gradedUser]=a;break;case "booleanGradeValue":c=g[a.gradeId];
void 0==c&&(c={},g[a.gradeId]=c);f=c[a.gradedUser];if(void 0==f||f.timestamp<a.timestamp)c[a.gradedUser]=a;break;case "textGradeValue":if(c=g[a.gradeId],void 0==c&&(c={},g[a.gradeId]=c),f=c[a.gradedUser],void 0==f||f.timestamp<a.timestamp)c[a.gradedUser]=a}d||l()}}catch(k){console.log("Grades.stanzaReceived",k)}};Progress.onConversationJoin.Grades=B;Progress.historyReceived.Grades=function(a){try{"type"in a&&"history"==a.type&&(B(),_.forEach(a.grades,function(a){r(a,!0)}),_.forEach(a.gradeValues,
function(a){r(a,!0)}),l())}catch(d){console.log("Grades.historyReceivedFunction",d)}};Progress.stanzaReceived.Grades=r;$(function(){$.getJSON("/getExternalGradebooks",function(a){p=a});d=$("#gradesDatagrid");y=d.find(".gradeActionsContainer").clone();z=d.find(".gradeEditContainer").clone();A=d.find(".gradeAssessContainer").clone();d.empty();u=$("#createGradeButton");var a=function(a){jsGrid.Field.call(this,a)};a.prototype=new jsGrid.Field({sorter:function(a,c){return new Date(a)-new Date(c)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},
insertTemplate:function(a){return""},editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;var a=[{name:"name",type:"text",title:"Name",readOnly:!0,sorting:!0},{name:"description",type:"text",title:"Description",readOnly:!0,sorting:!0},{name:"location",type:"text",title:"Location",readOnly:!0,sorting:!0},{name:"timestamp",type:"dateField",title:"When",readOnly:!0},{name:"gradeType",type:"text",title:"Type",readOnly:!0,sorting:!0},
{name:"author",type:"text",title:"Who",readOnly:!0,sorting:!0},{name:"identity",type:"text",title:"actions",readOnly:!0,sorting:!1,itemTemplate:function(a,c){if(c.author==UserSettings.getUsername()){var d=y.clone(),b=_.cloneDeep(c),m=function(){var a=_.uniqueId(),c=$("<div/>",{id:a}),f=$.jAlert({title:"edit grade",width:"50%",content:c[0].outerHTML}),e=z.clone(),c=sprintf("gradeName_%s",a),d=e.find(".gradeNameInputBox");d.attr("id",c).on("blur",function(a){b.name=d.val()}).val(b.name);e.find(".gradeNameLabel").attr("for",
c);var c=sprintf("gradeDesc_%s",a),g=e.find(".gradeDescriptionInputBox");g.attr("id",c).on("blur",function(a){b.description=g.val()}).val(b.description);e.find(".gradeDescriptionLabel").attr("for",c);var c=sprintf("gradeType_%s",a),k=e.find(".gradeTypeSelect"),C=e.find(".numericMinTextbox"),h=e.find(".numericMaxTextbox"),D=sprintf("numericMin_%s",a),E=sprintf("numericMax_%s",a);e.find(".numericMinLabel").attr("for",D);e.find(".numericMaxLabel").attr("for",E);C.on("blur",function(a){"numeric"==b.gradeType?
b.numericMinimum=parseFloat(h.val()):delete b.numericMinimum}).attr("id",D);h.on("blur",function(a){"numeric"==b.gradeType?b.numericMaximum=parseFloat(h.val()):delete b.numericMaximum}).attr("id",E);var F=function(){switch(b.gradeType){case "numeric":e.find(".numericOptions").show();void 0===b.numericMinimum&&(b.numericMinimum=0);void 0===b.numericMaximum&&(b.numericMaximum=100);C.val(b.numericMinimum);h.val(b.numericMaximum);break;default:e.find(".numericOptions").hide()}};k.attr("id",c).on("change",
function(){b.gradeType=k.val();F()}).val(b.gradeType);F();e.find(".gradeTypeLabel").attr("for",c);c=sprintf("gradeVisible_%s",a);e.find(".gradeVisibleLabel").attr("for",c);var v=e.find(".gradeVisibleCheckbox");v.attr("id",c).prop("checked",b.visible).on("change",function(a){b.visible=v.prop("checked")});var w=void 0,q=void 0,x=void 0,t=function(){var a=e.find(".associateController");if("foreignRelationship"in b){a.find(".createAssociation").hide();var c=b.foreignRelationship.sys,h=b.foreignRelationship.key.split("_"),
d=h[0],g=h[1];a.find(".associationSystem").text(c);a.find(".associationOrgUnit").text(d);a.find(".associationGradeId").text(g);a.find(".requestRefreshAssociation").unbind("click").on("click",function(){$.getJSON(sprintf("/getExternalGrade/%s/%s/%s",c,d,g),function(a){b.description=a.description;b.name=a.name;b.gradeType=a.gradeType;b.numericMinimum=a.numericMinimum;b.numericMaximum=a.numericMaximum;f.closeAlert();m()}).fail(function(a,c,b){alert(sprintf("error: %s \r\n %s",c,b))})});a.find(".refreshAssociation").show()}else a.find(".refreshAssociation").hide(),
a.find(".createAssociation").show(),a.find(".associationPhase").hide(),void 0===w?(a.find(".requestAssocPhase1").show(),a.find(".requestAssociation").unbind("click").on("click",function(){w=!0;1==p.length&&(q=p[0]);t()})):void 0==q?(q=p[0],a.find(".chooseGradebook").html(_.map(p,function(a){return $("<option/>",{value:a,text:a})})).unbind("change").on("change",function(a){q=$(this).val()}),a.find(".commitGradebook").unbind("click").on("click",function(){t()}),a.find(".requestAssocPhase2").show()):
void 0===x?$.getJSON(sprintf("/getExternalGradebookOrgUnits/%s",q),function(c){console.log("requestedOrgUnits:",c);x=c[0].foreignRelationship._2;a.find(".chooseOrgUnit").html(_.map(c,function(a){return $("<option/>",{value:a.foreignRelationship._2,text:a.name})})).unbind("change").on("change",function(a){x=$(this).val()});a.find(".commitOrgUnit").unbind("click").on("click",function(){t()});a.find(".requestAssocPhase3").show()}).fail(function(a,c,b){alert(sprintf("error: %s \r\n %s",c,b))}):(a.find(".requestAssocPhase4").show(),
a.find(".createGrade").unbind("click").on("click",function(){$.ajax({type:"POST",url:sprintf("/createExternalGrade/%s/%s",q,x),data:JSON.stringify(b),success:function(a){console.log("createdGrades:",b,a);b.foreignRelationship={sys:a.foreignRelationship.sys,key:a.foreignRelationship.key};sendStanza(b);t()},contentType:"application/json",dataType:"json"}).fail(function(a,c,b){alert(sprintf("error: %s \r\n %s",c,b))})}))};t();e.find(".cancelGradeEdit").on("click",function(){f.closeAlert()});e.find(".submitGradeEdit").on("click",
function(){sendStanza(b);f.closeAlert()});$("#"+a).append(e)};d.find(".editGradeButton").on("click",m);d.find(".assessGradeButton").on("click",function(){var a=_.uniqueId(),b=$("<div/>",{id:a});$.jAlert({title:"assess grade",width:"auto",content:b[0].outerHTML,onClose:function(){l()}});var d=A.clone(),e=d.find(".gradebookDatagrid"),f=e.find(".gradeUserContainer").clone();e.empty();var k=function(a){var b=g[c.id];void 0==b&&(g[c.id]={},b={});var d=sprintf("%sGradeValue",c.gradeType),f=Participants.getPossibleParticipants();
if("foreignRelationship"in c){var e=c.foreignRelationship.sys,v=c.foreignRelationship.key.split("_")[0];$.getJSON(sprintf("/getExternalGradebookOrgUnitClasslist/%s/%s",e,v),function(w){_.forEach(w,function(a){a=a.UserName;void 0!==a&&f.push(a)});f=_.uniq(f);_.forEach(f,function(a){void 0==b[a]&&(b[a]={type:d,gradeId:c.id,gradedUser:a,author:c.author,timestamp:0,audiences:[]})});console.log("possibleParticipants:",f,b);b=_.values(b);b=_.filter(b,function(a){return a.type==d});a(b)}).fail(function(a,
c,b){console.log("error",c,b)})}else _.forEach(f,function(a){void 0==b[a]&&(b[a]={type:d,gradeId:c.id,gradedUser:a,author:c.author,timestamp:0,audiences:[]})}),b=_.values(b),b=_.filter(b,function(a){return a.type==d}),a(b)},m=function(b){var h=[{name:"gradedUser",type:"text",title:"Who",readOnly:!0,sorting:!0},{name:"timestamp",type:"dateField",title:"When",readOnly:!0},{name:"gradeValue",type:"text",title:"Score",readOnly:!0,sorting:!0,itemTemplate:function(a,b){var d=f.clone(),e=d.find(".numericScore"),
g=d.find(".booleanScore"),k=d.find(".booleanScoreLabel"),h=d.find(".textScore");switch(c.gradeType){case "numeric":var m=function(a){b.gradeValue=parseFloat(e.val());sendStanza(b)};e.val(b.gradeValue).attr("min",c.numericMinimum).attr("max",c.numericMaximum).on("blur",m);g.remove();k.remove();h.remove();break;case "text":e.remove();m=function(a){b.gradeValue=h.val();sendStanza(b)};h.val(b.gradeValue).on("blur",m);k.remove();g.remove();break;case "boolean":e.remove();var l=sprintf("booleanScoreId_%s",
_.uniqueId()),m=function(a){b.gradeValue=g.prop("checked");sendStanza(b)};g.on("change",m).prop("checked",b.gradeValue).attr("id",l);k.attr("for",l);h.remove();break;default:e.remove(),g.remove(),k.remove(),h.remove()}return d}}];"foreignRelationship"in c&&h.push({name:"remoteGrade",type:"text",title:"Remote score",readOnly:!0,sorting:!0});$("#"+a).append(d);e.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No gradeable users",controller:{loadData:function(a){if("sortField"in
a){var c=_.sortBy(b,function(b){return b[a.sortField]});"sortOrder"in a&&"desc"==a.sortOrder&&(c=_.reverse(c));return c}return b}},pageLoading:!1,fields:h});e.jsGrid("loadData");e.jsGrid("sort",{field:"gradedUser",order:"desc"});if("foreignRelationship"in c){var l=c.foreignRelationship.sys,h=c.foreignRelationship.key.split("_"),n=h[0],p=h[1];d.find(".getRemoteData").on("click",function(){$.getJSON(sprintf("/getExternalGradeValues/%s/%s/%s",l,n,p),function(a){k(function(b){_.forEach(b,function(b){var c=
_.find(a,function(a){return a.gradedUser==b.gradedUser});void 0!==c&&(b.remoteGrade=c.gradeValue)});return m(b)})}).fail(function(a,b,c){console.log("error",b,c)})});d.find(".sendGradesToRemote").on("click",function(){var a=_.filter(g[c.id],function(a){return void 0!=a.gradeValue});$.ajax({type:"POST",data:JSON.stringify(a),dataType:"json",success:function(a){k(function(b){_.forEach(b,function(b){var c=_.find(a,function(a){return a.gradedUser==b.gradedUser});void 0!==c&&(b.remoteGrade=c.gradeValue)});
return m(b)})},url:sprintf("/updateExternalGradeValues/%s/%s/%s",l,n,p),contentType:"application/json"}).fail(function(a,b,c){console.log("error",b,c)})})}else d.find(".gradeSyncActions").remove()};k(m)});return d}return $("<span/>")}}],r=[{name:"myGradeValue",type:"text",title:"Score",readOnly:!0,sorting:!0}];Conversations.shouldModifyConversation()||(a=_.concat(a,r));d.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No grades",controller:{loadData:function(a){var c=
Conversations.shouldModifyConversation(),d=_.map(_.filter(n,function(a){return c||a.visible}),function(a){var c=g[a.id];void 0!==c&&(c=c[UserSettings.getUsername()],void 0!==c&&(a.myGradeValue=c.gradeValue));return a});"sortField"in a&&(d=_.sortBy(d,function(b){return b[a.sortField]}),"sortOrder"in a&&"desc"==a.sortOrder&&(d=_.reverse(d)));return d}},pageLoading:!1,fields:a});d.jsGrid("sort",{field:"timestamp",order:"desc"});l()});return{getGrades:function(){return n},getGradeValues:function(){return g},
reRender:l}}();
