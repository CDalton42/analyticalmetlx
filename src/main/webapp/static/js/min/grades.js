var Grades=function(){var d={},p={},h={},v={},y={},z={},A={},q=[],n=function(){WorkQueue.enqueue(function(){d.jsGrid("loadData");var a=d.jsGrid("getSorting");"field"in a&&d.jsGrid("sort",a);v.unbind("click");Conversations.shouldModifyConversation()?v.on("click",function(){console.log("clicked createButton");if(Conversations.shouldModifyConversation()){var a=Conversations.getCurrentSlideJid(),g=UserSettings.getUsername(),a={type:"grade",name:"",description:"",audiences:[],author:g,location:a,id:sprintf("%s_%s_%s",
a,g,(new Date).getTime().toString()),gradeType:"numeric",numericMinimum:0,numericMaximum:100,visible:!1,timestamp:0};sendStanza(a)}}).show():v.hide()})},B=function(){p={};h={};n()},u=function(a,d){try{if("type"in a){switch(a.type){case "grade":var g=p[a.id];if(void 0==g||g.timestamp<a.timestamp)p[a.id]=a;break;case "numericGradeValue":case "booleanGradeValue":case "textGradeValue":var c=h[a.gradeId]||{};h[a.gradeId]=c;var k=c[a.gradedUser];if(!k||k.timestamp<a.timestamp)c[a.gradedUser]=a,Progress.call("gradeValueReceived",
[a])}d||n()}}catch(b){console.log("Grades.stanzaReceived",b)}};Progress.onConversationJoin.Grades=B;Progress.historyReceived.Grades=function(a){try{"type"in a&&"history"==a.type&&(B(),_.forEach(a.grades,function(a){u(a,!0)}),_.forEach(a.gradeValues,function(a){u(a,!0)}),n())}catch(d){console.log("Grades.historyReceivedFunction",d)}};Progress.stanzaReceived.Grades=u;$(function(){$.getJSON("/getExternalGradebooks",function(a){q=a});d=$("#gradesDatagrid");y=d.find(".gradeActionsContainer").clone();z=
d.find(".gradeEditContainer").clone();A=d.find(".gradeAssessContainer").clone();d.empty();v=$("#createGradeButton");var a=function(a){jsGrid.Field.call(this,a)};a.prototype=new jsGrid.Field({sorter:function(a,c){return new Date(a)-new Date(c)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;var a=[{name:"name",type:"text",
title:"Name",readOnly:!0,sorting:!0},{name:"description",type:"text",title:"Description",readOnly:!0,sorting:!0},{name:"location",type:"text",title:"Location",readOnly:!0,sorting:!0},{name:"timestamp",type:"dateField",title:"When",readOnly:!0},{name:"gradeType",type:"text",title:"Type",readOnly:!0,sorting:!0},{name:"author",type:"text",title:"Who",readOnly:!0,sorting:!0},{name:"identity",type:"text",title:"actions",readOnly:!0,sorting:!1,itemTemplate:function(a,c){if(c.author==UserSettings.getUsername()){var d=
y.clone(),b=_.cloneDeep(c),l=function(){var a=_.uniqueId(),c=$("<div/>",{id:a}),d=$.jAlert({title:"edit grade",width:"50%",content:c[0].outerHTML}),e=z.clone(),c=sprintf("gradeName_%s",a),g=e.find(".gradeNameInputBox");g.attr("id",c).on("blur",function(a){b.name=g.val()}).val(b.name);e.find(".gradeNameLabel").attr("for",c);var c=sprintf("gradeDesc_%s",a),h=e.find(".gradeDescriptionInputBox");h.attr("id",c).on("blur",function(a){b.description=h.val()}).val(b.description);e.find(".gradeDescriptionLabel").attr("for",
c);var c=sprintf("gradeType_%s",a),k=e.find(".gradeTypeSelect"),C=e.find(".numericMinTextbox"),f=e.find(".numericMaxTextbox"),D=sprintf("numericMin_%s",a),E=sprintf("numericMax_%s",a);e.find(".numericMinLabel").attr("for",D);e.find(".numericMaxLabel").attr("for",E);C.on("blur",function(a){"numeric"==b.gradeType?b.numericMinimum=parseFloat(f.val()):delete b.numericMinimum}).attr("id",D);f.on("blur",function(a){"numeric"==b.gradeType?b.numericMaximum=parseFloat(f.val()):delete b.numericMaximum}).attr("id",
E);var F=function(){switch(b.gradeType){case "numeric":e.find(".numericOptions").show();void 0===b.numericMinimum&&(b.numericMinimum=0);void 0===b.numericMaximum&&(b.numericMaximum=100);C.val(b.numericMinimum);f.val(b.numericMaximum);break;default:e.find(".numericOptions").hide()}};k.attr("id",c).on("change",function(){b.gradeType=k.val();F()}).val(b.gradeType);F();e.find(".gradeTypeLabel").attr("for",c);c=sprintf("gradeVisible_%s",a);e.find(".gradeVisibleLabel").attr("for",c);var r=e.find(".gradeVisibleCheckbox");
r.attr("id",c).prop("checked",b.visible).on("change",function(a){b.visible=r.prop("checked")});var w=void 0,t=void 0,x=void 0,m=function(){var a=e.find(".associateController");if("foreignRelationship"in b){a.find(".createAssociation").hide();var c=b.foreignRelationship.sys,f=b.foreignRelationship.key.split("_"),r=f[0],g=f[1];a.find(".associationSystem").text(c);a.find(".associationOrgUnit").text(r);a.find(".associationGradeId").text(g);a.find(".requestRefreshAssociation").unbind("click").on("click",
function(){$.getJSON(sprintf("/getExternalGrade/%s/%s/%s",c,r,g),function(a){b.description=a.description;b.name=a.name;b.gradeType=a.gradeType;b.numericMinimum=a.numericMinimum;b.numericMaximum=a.numericMaximum;d.closeAlert();l()}).fail(function(a,c,b){alert(sprintf("error: %s \r\n %s",c,b))})});a.find(".refreshAssociation").show()}else a.find(".refreshAssociation").hide(),a.find(".createAssociation").show(),a.find(".associationPhase").hide(),void 0===w?(a.find(".requestAssocPhase1").show(),a.find(".requestAssociation").unbind("click").on("click",
function(){w=!0;1==q.length&&(t=q[0]);m()})):void 0==t?(t=q[0],a.find(".chooseGradebook").html(_.map(q,function(a){return $("<option/>",{value:a,text:a})})).unbind("change").on("change",function(a){t=$(this).val()}),a.find(".commitGradebook").unbind("click").on("click",function(){m()}),a.find(".requestAssocPhase2").show()):void 0===x?$.getJSON(sprintf("/getExternalGradebookOrgUnits/%s",t),function(c){console.log("requestedOrgUnits:",c);x=c[0].foreignRelationship.key;a.find(".chooseOrgUnit").html(_.map(c,
function(a){return $("<option/>",{value:a.foreignRelationship.key,text:a.name})})).unbind("change").on("change",function(a){x=$(this).val()});a.find(".commitOrgUnit").unbind("click").on("click",function(){m()});a.find(".requestAssocPhase3").show()}).fail(function(a,c,b){alert(sprintf("error: %s \r\n %s",c,b))}):(a.find(".requestAssocPhase4").show(),a.find(".createGrade").unbind("click").on("click",function(){$.ajax({type:"POST",url:sprintf("/createExternalGrade/%s/%s",t,x),data:JSON.stringify(b),
success:function(a){console.log("createdGrades:",b,a);b.foreignRelationship={sys:a.foreignRelationship.sys,key:a.foreignRelationship.key};sendStanza(b);m()},contentType:"application/json",dataType:"json"}).fail(function(a,c,b){alert(sprintf("error: %s \r\n %s",c,b))})}))};m();e.find(".cancelGradeEdit").on("click",function(){d.closeAlert()});e.find(".submitGradeEdit").on("click",function(){sendStanza(b);d.closeAlert()});$("#"+a).append(e)};d.find(".editGradeButton").on("click",l);d.find(".assessGradeButton").on("click",
function(){var a=_.uniqueId(),b=$("<div/>",{id:a});$.jAlert({title:"assess grade",width:"auto",content:b[0].outerHTML,onClose:function(){n()}});var d=A.clone(),e=d.find(".gradebookDatagrid"),g=e.find(".gradeUserContainer").clone();e.empty();var k=function(a){var b=h[c.id];void 0==b&&(h[c.id]={},b={});var d=sprintf("%sGradeValue",c.gradeType),e=Participants.getPossibleParticipants();if("foreignRelationship"in c){var g=c.foreignRelationship.sys,r=c.foreignRelationship.key.split("_")[0];$.getJSON(sprintf("/getExternalGradebookOrgUnitClasslist/%s/%s",
g,r),function(w){_.forEach(w,function(a){a=a.UserName;void 0!==a&&e.push(a)});e=_.uniq(e);_.forEach(e,function(a){void 0==b[a]&&(b[a]={type:d,gradeId:c.id,gradedUser:a,author:c.author,timestamp:0,audiences:[]})});console.log("possibleParticipants:",e,b);b=_.values(b);b=_.filter(b,function(a){return a.type==d});a(b)}).fail(function(a,b,c){console.log("error",b,c)})}else _.forEach(e,function(a){void 0==b[a]&&(b[a]={type:d,gradeId:c.id,gradedUser:a,author:c.author,timestamp:0,audiences:[]})}),b=_.values(b),
b=_.filter(b,function(a){return a.type==d}),a(b)},l=function(b){var f=[{name:"gradedUser",type:"text",title:"Who",readOnly:!0,sorting:!0},{name:"timestamp",type:"dateField",title:"When",readOnly:!0},{name:"gradeValue",type:"text",title:"Score",readOnly:!0,sorting:!0,itemTemplate:function(a,b){var d=g.clone(),e=d.find(".numericScore"),m=d.find(".booleanScore"),k=d.find(".booleanScoreLabel"),f=d.find(".textScore");switch(c.gradeType){case "numeric":var l=function(a){b.gradeValue=parseFloat(e.val());
sendStanza(b)};e.val(b.gradeValue).attr("min",c.numericMinimum).attr("max",c.numericMaximum).on("blur",l);m.remove();k.remove();f.remove();break;case "text":e.remove();l=function(a){b.gradeValue=f.val();sendStanza(b)};f.val(b.gradeValue).on("blur",l);k.remove();m.remove();break;case "boolean":e.remove();var h=sprintf("booleanScoreId_%s",_.uniqueId()),l=function(a){b.gradeValue=m.prop("checked");sendStanza(b)};m.on("change",l).prop("checked",b.gradeValue).attr("id",h);k.attr("for",h);f.remove();break;
default:e.remove(),m.remove(),k.remove(),f.remove()}return d}}];"foreignRelationship"in c&&f.push({name:"remoteGrade",type:"text",title:"Remote score",readOnly:!0,sorting:!0});$("#"+a).append(d);e.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No gradeable users",controller:{loadData:function(a){if("sortField"in a){var c=_.sortBy(b,function(b){return b[a.sortField]});"sortOrder"in a&&"desc"==a.sortOrder&&(c=_.reverse(c));return c}return b}},pageLoading:!1,
fields:f});e.jsGrid("loadData");e.jsGrid("sort",{field:"gradedUser",order:"desc"});if("foreignRelationship"in c){var n=c.foreignRelationship.sys,f=c.foreignRelationship.key.split("_"),p=f[0],q=f[1];d.find(".getRemoteData").on("click",function(){$.getJSON(sprintf("/getExternalGradeValues/%s/%s/%s",n,p,q),function(a){k(function(b){_.forEach(b,function(b){var c=_.find(a,function(a){return a.gradedUser==b.gradedUser});void 0!==c&&(b.remoteGrade=c.gradeValue)});return l(b)})}).fail(function(a,b,c){console.log("error",
b,c)})});d.find(".sendGradesToRemote").on("click",function(){var a=_.filter(h[c.id],function(a){return void 0!=a.gradeValue});$.ajax({type:"POST",data:JSON.stringify(a),dataType:"json",success:function(a){k(function(b){_.forEach(b,function(b){var c=_.find(a,function(a){return a.gradedUser==b.gradedUser});void 0!==c&&(b.remoteGrade=c.gradeValue)});return l(b)})},url:sprintf("/updateExternalGradeValues/%s/%s/%s",n,p,q),contentType:"application/json"}).fail(function(a,b,c){console.log("error",b,c)})})}else d.find(".gradeSyncActions").remove()};
k(l)});return d}return $("<span/>")}}],u=[{name:"myGradeValue",type:"text",title:"Score",readOnly:!0,sorting:!0}];Conversations.shouldModifyConversation()||(a=_.concat(a,u));d.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No grades",controller:{loadData:function(a){var c=Conversations.shouldModifyConversation(),d=_.map(_.filter(p,function(a){return c||a.visible}),function(a){var c=h[a.id];void 0!==c&&(c=c[UserSettings.getUsername()],void 0!==c&&(a.myGradeValue=
c.gradeValue));return a});"sortField"in a&&(d=_.sortBy(d,function(b){return b[a.sortField]}),"sortOrder"in a&&"desc"==a.sortOrder&&(d=_.reverse(d)));return d}},pageLoading:!1,fields:a});d.jsGrid("sort",{field:"timestamp",order:"desc"});n()});return{getGrades:function(){return p},getGradeValues:function(){return h},reRender:n}}();
