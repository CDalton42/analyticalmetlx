var Grades=function(){var g={},n={},m={},v={},y={},z={},A={},p=[],f=function(a,f,h){f?($(a).prop("disabled",!0).css({position:"relative"}),h&&(a=h(a)),a.append($("<div />",{"class":"spinner"}).append($("<div />",{"class":"fa fa-spin fa-cog"})))):$(a).prop("disabled",!1).find(".spinner").remove()},k=function(){WorkQueue.enqueue(function(){g.jsGrid("loadData");var a=g.jsGrid("getSorting");"field"in a&&g.jsGrid("sort",a);v.unbind("click");Conversations.shouldModifyConversation()?v.on("click",function(){console.log("clicked createButton");
if(Conversations.shouldModifyConversation()){var a=Conversations.getCurrentSlideJid(),h=UserSettings.getUsername(),a={type:"grade",name:"",description:"",audiences:[],author:h,location:a,id:sprintf("%s_%s_%s",a,h,(new Date).getTime().toString()),gradeType:"numeric",numericMinimum:0,numericMaximum:100,visible:!1,timestamp:0};sendStanza(a)}}).show():v.hide()})},B=function(){n={};m={};k()},q=function(a,f){try{if("type"in a){switch(a.type){case "grade":var h=n[a.id];if(void 0==h||h.timestamp<a.timestamp)n[a.id]=
a;break;case "numericGradeValue":case "booleanGradeValue":case "textGradeValue":var c=m[a.gradeId]||{};m[a.gradeId]=c;var e=c[a.gradedUser];if(!e||e.timestamp<a.timestamp)c[a.gradedUser]=a,Progress.call("gradeValueReceived",[a])}f||k()}}catch(b){console.log("Grades.stanzaReceived",b)}};Progress.onConversationJoin.Grades=B;Progress.historyReceived.Grades=function(a){try{"type"in a&&"history"==a.type&&(B(),_.forEach(a.grades,function(a){q(a,!0)}),_.forEach(a.gradeValues,function(a){q(a,!0)}),k())}catch(f){console.log("Grades.historyReceivedFunction",
f)}};Progress.stanzaReceived.Grades=q;$(function(){$.getJSON("/getExternalGradebooks",function(a){p=a});g=$("#gradesDatagrid");y=g.find(".gradeActionsContainer").clone();z=g.find(".gradeEditContainer").clone();A=g.find(".gradeAssessContainer").clone();g.empty();v=$("#createGradeButton");var a=function(a){jsGrid.Field.call(this,a)};a.prototype=new jsGrid.Field({sorter:function(a,c){return new Date(a)-new Date(c)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},
editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;var a=[{name:"name",type:"text",title:"Name",readOnly:!0,sorting:!0},{name:"description",type:"text",title:"Description",readOnly:!0,sorting:!0},{name:"location",type:"text",title:"Location",readOnly:!0,sorting:!0},{name:"timestamp",type:"dateField",title:"When",readOnly:!0},{name:"gradeType",type:"text",title:"Type",readOnly:!0,sorting:!0},{name:"author",type:"text",title:"Who",
readOnly:!0,sorting:!0},{name:"identity",type:"text",title:"actions",readOnly:!0,sorting:!1,itemTemplate:function(a,c){if(c.author==UserSettings.getUsername()){var e=y.clone(),b=_.cloneDeep(c),g=function(){var a=_.uniqueId(),c=$("<div/>",{id:a}),h=$.jAlert({title:"edit grade",width:"50%",content:c[0].outerHTML}),d=z.clone(),c=sprintf("gradeName_%s",a),e=d.find(".gradeNameInputBox");e.attr("id",c).on("blur",function(a){b.name=e.val()}).val(b.name);d.find(".gradeNameLabel").attr("for",c);var c=sprintf("gradeDesc_%s",
a),m=d.find(".gradeDescriptionInputBox");m.attr("id",c).on("blur",function(a){b.description=m.val()}).val(b.description);d.find(".gradeDescriptionLabel").attr("for",c);var c=sprintf("gradeType_%s",a),k=d.find(".gradeTypeSelect"),C=d.find(".numericMinTextbox"),r=d.find(".numericMaxTextbox"),D=sprintf("numericMin_%s",a),E=sprintf("numericMax_%s",a);d.find(".numericMinLabel").attr("for",D);d.find(".numericMaxLabel").attr("for",E);C.on("blur",function(a){"numeric"==b.gradeType?b.numericMinimum=parseFloat(r.val()):
delete b.numericMinimum}).attr("id",D);r.on("blur",function(a){"numeric"==b.gradeType?b.numericMaximum=parseFloat(r.val()):delete b.numericMaximum}).attr("id",E);var F=function(){switch(b.gradeType){case "numeric":d.find(".numericOptions").show();void 0===b.numericMinimum&&(b.numericMinimum=0);void 0===b.numericMaximum&&(b.numericMaximum=100);C.val(b.numericMinimum);r.val(b.numericMaximum);break;default:d.find(".numericOptions").hide()}};k.attr("id",c).on("change",function(){b.gradeType=k.val();F()}).val(b.gradeType);
F();d.find(".gradeTypeLabel").attr("for",c);c=sprintf("gradeVisible_%s",a);d.find(".gradeVisibleLabel").attr("for",c);var t=d.find(".gradeVisibleCheckbox");t.attr("id",c).prop("checked",b.visible).on("change",function(a){b.visible=t.prop("checked")});var w=void 0,l=void 0,x=void 0,u=function(){var a=d.find(".associateController");f(a,!1);if("foreignRelationship"in b){a.find(".createAssociation").hide();var c=b.foreignRelationship.sys,r=b.foreignRelationship.key.split("_"),t=r[0],e=r[1];a.find(".associationSystem").text(c);
a.find(".associationOrgUnit").text(t);a.find(".associationGradeId").text(e);a.find(".requestRefreshAssociation").unbind("click").on("click",function(){f(a,!0);$.getJSON(sprintf("/getExternalGrade/%s/%s/%s",c,t,e),function(a){b.description=a.description;b.name=a.name;b.gradeType=a.gradeType;b.numericMinimum=a.numericMinimum;b.numericMaximum=a.numericMaximum;h.closeAlert();g();f(this,!1)}).fail(function(c,b,l){f(a,!1);alert(sprintf("error: %s \r\n %s",b,l))})});a.find(".refreshAssociation").show()}else a.find(".refreshAssociation").hide(),
a.find(".createAssociation").show(),a.find(".associationPhase").hide(),void 0===w?(a.find(".requestAssocPhase1").show(),a.find(".requestAssociation").unbind("click").on("click",function(){w=!0;1==p.length&&(l=p[0]);u()})):void 0==l?(l=p[0],a.find(".chooseGradebook").html(_.map(p,function(a){return $("<option/>",{value:a,text:a})})).unbind("change").on("change",function(a){l=$(this).val()}),a.find(".commitGradebook").unbind("click").on("click",function(){f(this,!0);u()}),a.find(".requestAssocPhase2").show()):
void 0===x?(f(a,!0),$.getJSON(sprintf("/getExternalGradebookOrgUnits/%s",l),function(c){console.log("requestedOrgUnits:",c);x=c[0].foreignRelationship.key;a.find(".chooseOrgUnit").html(_.map(c,function(a){return $("<option/>",{value:a.foreignRelationship.key,text:a.name})})).unbind("change").on("change",function(a){x=$(this).val()});a.find(".commitOrgUnit").unbind("click").on("click",function(){u()});a.find(".requestAssocPhase3").show();f(a,!1)}).fail(function(c,b,l){f(a,!1);alert(sprintf("error: %s \r\n %s",
b,l))})):(a.find(".requestAssocPhase4").show(),a.find(".createGrade").unbind("click").on("click",function(){f(a,!0);$.ajax({type:"POST",url:sprintf("/createExternalGrade/%s/%s",l,x),data:JSON.stringify(b),success:function(a){console.log("createdGrades:",b,a);b.foreignRelationship={sys:a.foreignRelationship.sys,key:a.foreignRelationship.key};sendStanza(b);u();f(this,!1)},contentType:"application/json",dataType:"json"}).fail(function(c,b,l){f(a,!1);alert(sprintf("error: %s \r\n %s",b,l))})}))};u();
d.find(".cancelGradeEdit").on("click",function(){h.closeAlert()});d.find(".submitGradeEdit").on("click",function(){sendStanza(b);h.closeAlert()});$("#"+a).append(d)};e.find(".editGradeButton").on("click",g);e.find(".assessGradeButton").on("click",function(){var a=_.uniqueId(),b=$("<div/>",{id:a});$.jAlert({title:"assess grade",width:"auto",content:b[0].outerHTML,onClose:function(){k()}});var e=A.clone();$("#"+a).append(e);f(e,!0);var d=e.find(".gradebookDatagrid"),h=d.find(".gradeUserContainer").clone();
d.empty();var g=function(a){var b=m[c.id];void 0==b&&(m[c.id]={},b={});var d=sprintf("%sGradeValue",c.gradeType),h=Participants.getPossibleParticipants();if("foreignRelationship"in c){var g=c.foreignRelationship.sys,t=c.foreignRelationship.key.split("_")[0];$.getJSON(sprintf("/getExternalGradebookOrgUnitClasslist/%s/%s",g,t),function(w){_.forEach(w,function(a){a=a.UserName;void 0!==a&&h.push(a)});h=_.uniq(h);_.forEach(h,function(a){void 0==b[a]&&(b[a]={type:d,gradeId:c.id,gradedUser:a,author:c.author,
timestamp:0,audiences:[]})});console.log("possibleParticipants:",h,b);b=_.values(b);b=_.filter(b,function(a){return a.type==d});a(b)}).fail(function(a,b,c){f(e,!1);console.log("error",b,c)})}else _.forEach(h,function(a){void 0==b[a]&&(b[a]={type:d,gradeId:c.id,gradedUser:a,author:c.author,timestamp:0,audiences:[]})}),b=_.values(b),b=_.filter(b,function(a){return a.type==d}),a(b)},n=function(a){var b=[{name:"gradedUser",type:"text",title:"Who",readOnly:!0,sorting:!0},{name:"timestamp",type:"dateField",
title:"When",readOnly:!0},{name:"gradeValue",type:"text",title:"Score",readOnly:!0,sorting:!0,itemTemplate:function(a,b){var l=h.clone(),d=l.find(".numericScore"),e=l.find(".booleanScore"),f=l.find(".booleanScoreLabel"),g=l.find(".textScore");switch(c.gradeType){case "numeric":var k=function(a){b.gradeValue=parseFloat(d.val());sendStanza(b)};d.val(b.gradeValue).attr("min",c.numericMinimum).attr("max",c.numericMaximum).on("blur",k);e.remove();f.remove();g.remove();break;case "text":d.remove();k=function(a){b.gradeValue=
g.val();sendStanza(b)};g.val(b.gradeValue).on("blur",k);f.remove();e.remove();break;case "boolean":d.remove();var m=sprintf("booleanScoreId_%s",_.uniqueId()),k=function(a){b.gradeValue=e.prop("checked");sendStanza(b)};e.on("change",k).prop("checked",b.gradeValue).attr("id",m);f.attr("for",m);g.remove();break;default:d.remove(),e.remove(),f.remove(),g.remove()}return l}}];"foreignRelationship"in c&&b.push({name:"remoteGrade",type:"text",title:"Remote score",readOnly:!0,sorting:!0});d.jsGrid({width:"100%",
height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No gradeable users",controller:{loadData:function(b){if("sortField"in b){var c=_.sortBy(a,function(a){return a[b.sortField]});"sortOrder"in b&&"desc"==b.sortOrder&&(c=_.reverse(c));return c}return a}},pageLoading:!1,fields:b});d.jsGrid("loadData");d.jsGrid("sort",{field:"gradedUser",order:"desc"});if("foreignRelationship"in c){var k=c.foreignRelationship.sys,b=c.foreignRelationship.key.split("_"),p=b[0],q=b[1];e.find(".getRemoteData").on("click",
function(){var a=this;f(a,!0);$.getJSON(sprintf("/getExternalGradeValues/%s/%s/%s",k,p,q),function(b){g(function(c){_.forEach(c,function(c){var d=_.find(b,function(a){return a.gradedUser==c.gradedUser});void 0!==d&&(c.remoteGrade=d.gradeValue);f(a,!1)});return n(c)})}).fail(function(b,c,d){f(a,!1);console.log("error",c,d)})});e.find(".sendGradesToRemote").on("click",function(){var a=this;f(a,!0,function(a){return $(a).find("span")});var b=_.filter(m[c.id],function(a){return void 0!=a.gradeValue});
$.ajax({type:"POST",data:JSON.stringify(b),dataType:"json",success:function(b){g(function(c){_.forEach(c,function(a){var c=_.find(b,function(b){return b.gradedUser==a.gradedUser});void 0!==c&&(a.remoteGrade=c.gradeValue)});f(a,!1);return n(c)})},url:sprintf("/updateExternalGradeValues/%s/%s/%s",k,p,q),contentType:"application/json"}).fail(function(b,c,d){f(a,!1);console.log("error",c,d)})})}else e.find(".gradeSyncActions").remove();f(e,!1)};g(n)});return e}return $("<span/>")}}],q=[{name:"myGradeValue",
type:"text",title:"Score",readOnly:!0,sorting:!0}];Conversations.shouldModifyConversation()||(a=_.concat(a,q));g.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No grades",controller:{loadData:function(a){var c=Conversations.shouldModifyConversation(),e=_.map(_.filter(n,function(a){return c||a.visible}),function(a){var c=m[a.id];void 0!==c&&(c=c[UserSettings.getUsername()],void 0!==c&&(a.myGradeValue=c.gradeValue));return a});"sortField"in a&&(e=_.sortBy(e,
function(b){return b[a.sortField]}),"sortOrder"in a&&"desc"==a.sortOrder&&(e=_.reverse(e)));return e}},pageLoading:!1,fields:a});g.jsGrid("sort",{field:"timestamp",order:"desc"});k()});return{getGrades:function(){return n},getGradeValues:function(){return m},reRender:k}}();
