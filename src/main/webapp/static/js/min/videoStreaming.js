var TokBox=function(){var c=!1,d=!1,m=!1,h={},q=void 0,t=void 0;return{getSessions:function(){return h},initialize:function(){q=$("#videoConfSessionsContainer");t=q.find(".videoConfSessionContainer").clone();q.empty();m=!0},receiveTokBoxSession:function(f){if(m)if(0==OT.checkSystemRequirements())c||(errorAlert("Video conferencing disabled","Video conferencing is disabled because your browser does not support it.  You could try recent versions of Chrome or Firefox."),c=!0);else if(d&&!(f.sessionId in
h)){var u=t.clone();q.append(u);f=TokBoxSession(f,u);h[f.id]=f;f.refreshVisualState()}},setTokBoxEnabledState:function(c){d=c},removeSessions:function(c){_.forEach(h,function(d){_.some(c,function(c){return c==d.id})&&(d.shutdown(),delete h[d.id])})}}}(),TokBoxSession=function(c,d){var m=160,h=120,q=15,t=[320,640,1280],f=[240,480,720],u=[1,7,15,30],z=Conversations.getCurrentConversation().permissions.studentsMayBroadcast,D=function(a){var b=_.reverse(_.filter(u,function(b){return b<=a}))[0];void 0==
b&&(b=u[0]);return b},E=function(a){var b=_.reverse(_.filter(t,function(b){return b<=a}))[0];void 0==b&&(b=t[0]);return b},F=function(a){var b=_.reverse(_.filter(f,function(b){return b<=a}))[0];void 0==b&&(b=f[0]);return b},n=function(){return"isConnected"in e&&e.isConnected()},A={},k=d.find(".videoConfStartButton"),v=d.find(".videoConfContainer"),w=d.find(".videoConfStartButtonContainer"),x=d.find(".videoConfPermitStudentBroadcastContainer"),G=x.find(".videoConfPermitStudentBroadcastButton"),H=x.find(".context"),
I=d.find(".videoSubscriptionsContainer"),J=d.find(".videoContainer").clone(),B=d.find(".broadcastContainer"),K=d.find(".broadcastLink");I.empty();B.empty();v.empty();var p={},l=void 0,g=function(){k.unbind("click");Conversations.shouldModifyConversation()?(x.show(),H.text(z?"students may broadcast":"students may not broadcast"),G.unbind("click").on("click",function(){if("Conversations"in window){var a=Conversations.getCurrentConversation(),b=a.permissions;b.studentsMayBroadcast=!b.studentsMayBroadcast;
changePermissionsOfConversation(a.jid.toString(),b)}})):x.hide();n()&&(z||Conversations.shouldModifyConversation())?(v.show(),"capabilities"in e&&"publish"in e.capabilities&&1==e.capabilities.publish?(w.show(),k.show(),k.on("click",function(){n()&&(void 0==l?C():y())})):(n()&&y(!0),w.hide(),k.hide(),v.hide())):(n()&&y(!0),w.hide(),k.hide(),v.hide());d.find(".subscribedStream").removeClass("subscribedStream");if(e.connection){var a=e.connection.data.match(/description=(.+)$/)[1],b=a;if(a==Conversations.getCurrentConversationJid())b=
"everyone";else{var c=_.flatMap(Conversations.getCurrentSlide().groupSets,function(b){return _.find(b.groups,function(b){return b.id==a})});c.length&&(b=sprintf("group %s",c[0].title))}w.find(".context").text(b)}void 0!=l?k.addClass("publishedStream").find("div").text("Hide from"):k.removeClass("publishedStream").find("div").text("Stream to");_.forEach(p,function(a){"refreshVisual"in a&&a.refreshVisual()});DeviceConfiguration.applyFit()},C=function(){g();if(n()&&void 0==l){var a=sprintf("tokBoxVideoElemPublisher_%s",
_.uniqueId()),b=$("<span />",{id:a,"class":"publisherVideoElem"});d.find(".viewscreen").append(b);sprintf("%sx%s",E(m),F(h));l=a=OT.initPublisher(a,{name:UserSettings.getUsername(),width:m,height:h,resolution:"320x240",frameRate:D(q),insertMode:"append"},function(a){a&&console.log("tokbox error:",a)});a.element.style.width=m;a.element.style.height=h;e.publish(a);d.find(".videoConfStartButton").addClass("publishedStream")}g()},y=function(a){a||g();n()&&void 0!=l&&(d.find(".publisherVideoElem").remove(),
e.unpublish(l),l=void 0,d.find(".videoConfStartButton").removeClass("publishedStream"));a||g()};Progress.afterWorkQueuePause.videoStreaming=function(){_.forEach(p,function(a){"subscriber"in a&&null!=a.subscriber&&"restrictFramerate"in a.subscriber&&a.subscriber.restrictFramerate(!0)})};Progress.beforeWorkQueueResume.videoStreaming=function(){_.forEach(p,function(a){"subscriber"in a&&null!=a.subscriber&&"restrictFramerate"in a.subscriber&&a.subscriber.restrictFramerate(!1)})};Progress.conversationDetailsReceived.videoStreaming=
function(a){console.log("videoStreaming conversationDetails",a);"jid"in a&&"Conversations"in window&&"permissions"in a&&"studentsMayBroadcast"in a.permissions&&(z=a.permissions.studentsMayBroadcast,g())};var e=OT.initSession(c.apiKey,c.sessionId);e.on({streamDestroyed:function(a){a.stream.id in p&&(p[a.stream.id].elem.remove(),delete p[a.stream.id],g())},streamCreated:function(a){if("capabilities"in e&&"subscribe"in e.capabilities&&1==e.capabilities.subscribe){var b=a.stream,c=p[b.id];if(void 0==
c){c={stream:b,subscribed:!1,refreshVisual:function(){}};p[b.id]=c;var d=sprintf("tokBoxVideoElemSubscriber_%s",_.uniqueId()),f=$(J.clone()),l=$("<span />",{id:d,"class":"subscriberVideoElem"});f.find(".publisherName").text(a.stream.name);var q=f.find(".videoConfSubscribeButton"),n=function(){q.toggleClass("subscribedStream",c.subscribed)};n();var r=p[b.id],k=b.name,t=function(){r.subscribed=!0;A[k]=!0;var a=e.subscribe(r.stream,d,{insertMode:"append",width:m,height:h},function(a){a&&(f.remove(),
console.log("error when subscribing to stream",a,r.stream.name,r.stream.id))});a.element.style.width=m;a.element.style.height=h;a.on("videoDimensionsChanged",function(b){a.element.style.width=b.newValue.width+"px";a.element.style.height=b.newValue.height+"px"});r.subscriber=a;r.refreshVisual=n};f.find(".videoConfSubscribeButton").on("click",function(){r.subscribed?(r.subscribed=!1,e.unsubscribe(r.subscriber),delete A[k]):t();g()});l.prepend(f);v.append(l);c.videoSelectorId=d;c.elem=f;k in A&&t();
g()}else c.stream=b}},sessionConnected:function(a){g()},sessionDisconnected:function(a){g()},sessionReconnected:function(a){g()},sessionReconnecting:function(a){g()}});e.connect(c.token,function(a){a&&console.log("error when connecting to tokBox",a,c);g()});return{startPublish:C,receiveBroadcast:function(a){if(null!=a&&"broadcastUrls"in a&&"hls"in a.broadcastUrls){var b=K.clone();b.attr("href",a.broadcastUrls.hls);B.append(b)}else B.empty()},getIsConnected:n,id:e.id,getSession:function(){return e},
refreshVisualState:g,shutdown:function(){e.disconnect();d.remove()},resizeVideo:function(a,b,c){void 0!=a&&(m=a);void 0!=b&&(h=b);void 0!=c&&(q=c);void 0!=l&&(y(),startPublisherFunc());_.forEach(p,function(a){"subscriber"in a&&null!=a.subscriber&&(a.subscriber.setPreferredResolution({width:m,height:h}),"refreshVisual"in a&&a.refreshVisual())});g()}}};function receiveTokBoxSessionToken(c){"token"in c&&TokBox.receiveTokBoxSession(c)}function removeTokBoxSessions(c){TokBox.removeSessions(c)}
function receiveTokBoxEnabled(c){TokBox.setTokBoxEnabledState(c)}function receiveTokBoxArchives(c){}function receiveTokBoxBroadcast(c){};
