var TokBox=function(){var a=!1,b=!1,l=!1,d={},e=void 0,u=void 0,f=void 0,m=void 0,v=!1,x=function(a){a&&(v="permissions"in a&&a.permissions.studentsMayBroadcast,f&&(Conversations.shouldModifyConversation(a)?(f.show(),m.prop("checked",v).unbind("click").on("click",function(){var a=$(this).prop("checked");if("Conversations"in window){var b=Conversations.getCurrentConversation(),d=b.permissions;d.studentsMayBroadcast=a;changePermissionsOfConversation(b.jid.toString(),d)}})):(m.unbind("click"),f.hide())));
_.forEach(d,function(a){a.refreshVisualState()})};Progress.conversationDetailsReceived.TokBox=x;return{getSessions:function(){return d},initialize:function(){e=$("#videoConfSessionsContainer");f=e.find(".teacherControls").clone();m=f.find("#canBroadcast");u=e.find(".videoConfSessionContainer").clone();e.empty();e.append(f);x(Conversations.getCurrentConversation());l=!0},receiveTokBoxSession:function(k){if(l)if(e.css({display:"flex"}),window.OT)if(0==OT.checkSystemRequirements())a||(errorAlert("Video conferencing disabled",
"Video conferencing is disabled because your browser does not support it.  You could try recent versions of Chrome or Firefox."),a=!0);else{if(b&&!(k.sessionId in d)){var h=u.clone();e.append(h);k=TokBoxSession(k,h);d[k.id]=k;k.refreshVisualState()}}else errorAlert("Could not connect video","Please check your network connection")},getTokBoxEnabledState:function(){return b},setTokBoxEnabledState:function(a){b=a},removeSessions:function(a){_.forEach(d,function(b){_.some(a,function(a){return a==b.id})&&
(b.shutdown(),delete d[b.id])})},canPublish:function(){return Conversations.shouldModifyConversation()||v}}}(),TokBoxSession=function(a,b){var l=160,d=120,e=15,u=[320,640,1280],f=[240,480,720],m=[1,7,15,30],v=function(r){var a=_.reverse(_.filter(m,function(a){return a<=r}))[0];void 0==a&&(a=m[0]);return a},x=function(r){var a=_.reverse(_.filter(u,function(a){return a<=r}))[0];void 0==a&&(a=u[0]);return a},k=function(r){var a=_.reverse(_.filter(f,function(a){return a<=r}))[0];void 0==a&&(a=f[0]);return a},
h=function(){return"isConnected"in c&&c.isConnected()},A={},n=b.find(".videoConfStartButton"),w=b.find(".videoConfContainer"),y=b.find(".videoConfStartButtonContainer"),E=b.find(".videoSubscriptionsContainer"),F=b.find(".videoContainer").clone(),B=b.find(".broadcastContainer"),G=b.find(".broadcastLink");E.empty();B.empty();w.empty();var p={},q=void 0,g=function(){n.unbind("click");h()&&TokBox.canPublish()?(w.show(),"capabilities"in c&&"publish"in c.capabilities&&1==c.capabilities.publish?(y.show(),
n.show(),n.on("click",function(){h()&&(void 0==q?C():z())})):(h()&&z(!0),y.hide(),n.hide(),w.hide())):(h()&&z(!0),y.hide(),n.hide(),w.hide());b.find(".subscribedStream").removeClass("subscribedStream");if(c.connection){var r=c.connection.data.match(/description=(.+)$/)[1],a=r;if(r==Conversations.getCurrentConversationJid())a="everyone";else{var d=_.flatMap(Conversations.getCurrentSlide().groupSets,function(a){return _.find(a.groups,function(a){return a.id==r})});d.length&&(a=sprintf("group %s",d[0].title))}y.find(".context").text(a)}void 0!=
q?n.addClass("publishedStream").find("div").text("Hide from"):n.removeClass("publishedStream").find("div").text("Stream to");_.forEach(p,function(a){"refreshVisual"in a&&a.refreshVisual()});DeviceConfiguration.applyFit()},C=function(){g();if(h()&&void 0==q){var a=sprintf("tokBoxVideoElemPublisher_%s",_.uniqueId()),D=$("<span />",{id:a,"class":"publisherVideoElem"});b.find(".viewscreen").append(D);sprintf("%sx%s",x(l),k(d));q=a=OT.initPublisher(a,{name:UserSettings.getUsername(),width:l,height:d,resolution:"320x240",
frameRate:v(e),insertMode:"append"},function(a){a&&console.log("tokbox error:",a)});a.element.style.width=l;a.element.style.height=d;c.publish(a);b.find(".videoConfStartButton").addClass("publishedStream")}g()},z=function(a){a||g();h()&&void 0!=q&&(b.find(".publisherVideoElem").remove(),c.unpublish(q),q=void 0,b.find(".videoConfStartButton").removeClass("publishedStream"));a||g()};Progress.afterWorkQueuePause.videoStreaming=function(){_.forEach(p,function(a){"subscriber"in a&&null!=a.subscriber&&
"restrictFramerate"in a.subscriber&&a.subscriber.restrictFramerate(!0)})};Progress.beforeWorkQueueResume.videoStreaming=function(){_.forEach(p,function(a){"subscriber"in a&&null!=a.subscriber&&"restrictFramerate"in a.subscriber&&a.subscriber.restrictFramerate(!1)})};Progress.conversationDetailsReceived.videoStreaming=function(a){"jid"in a&&"Conversations"in window&&"permissions"in a&&"studentsMayBroadcast"in a.permissions&&g()};var c=OT.initSession(a.apiKey,a.sessionId);c.on({streamDestroyed:function(a){a.stream.id in
p&&(p[a.stream.id].elem.remove(),delete p[a.stream.id],g())},streamCreated:function(a){if("capabilities"in c&&"subscribe"in c.capabilities&&1==c.capabilities.subscribe){var b=a.stream,e=p[b.id];if(void 0==e){e={stream:b,subscribed:!1,refreshVisual:function(){}};p[b.id]=e;var h=sprintf("tokBoxVideoElemSubscriber_%s",_.uniqueId()),f=$(F.clone()),k=$("<span />",{id:h,"class":"subscriberVideoElem"});f.find(".publisherName").text(a.stream.name);var q=f.find(".videoConfSubscribeButton"),n=function(){q.toggleClass("subscribedStream",
e.subscribed)};n();var t=p[b.id],m=b.name,u=function(){t.subscribed=!0;A[m]=!0;var a=c.subscribe(t.stream,h,{insertMode:"append",width:l,height:d},function(a){a&&(f.remove(),console.log("error when subscribing to stream",a,t.stream.name,t.stream.id))});a.element.style.width=l;a.element.style.height=d;a.on("videoDimensionsChanged",function(b){a.element.style.width=b.newValue.width+"px";a.element.style.height=b.newValue.height+"px"});t.subscriber=a;t.refreshVisual=n};f.find(".videoConfSubscribeButton").on("click",
function(){t.subscribed?(t.subscribed=!1,c.unsubscribe(t.subscriber),delete A[m]):u();g()});k.prepend(f);w.append(k);e.videoSelectorId=h;e.elem=f;m in A&&u();g()}else e.stream=b}},sessionConnected:function(a){g()},sessionDisconnected:function(a){g()},sessionReconnected:function(a){g()},sessionReconnecting:function(a){g()}});c.connect(a.token,function(b){b&&console.log("error when connecting to tokBox",b,a);g()});return{startPublish:C,receiveBroadcast:function(a){if(null!=a&&"broadcastUrls"in a&&"hls"in
a.broadcastUrls){var b=G.clone();b.attr("href",a.broadcastUrls.hls);B.append(b)}else B.empty()},getIsConnected:h,id:c.id,getSession:function(){return c},refreshVisualState:g,shutdown:function(){c.disconnect();b.remove()},resizeVideo:function(a,b,c){void 0!=a&&(l=a);void 0!=b&&(d=b);void 0!=c&&(e=c);void 0!=q&&(z(),startPublisherFunc());_.forEach(p,function(a){"subscriber"in a&&null!=a.subscriber&&(a.subscriber.setPreferredResolution({width:l,height:d}),"refreshVisual"in a&&a.refreshVisual())});g()}}};
function receiveTokBoxSessionToken(a){"token"in a&&TokBox.receiveTokBoxSession(a)}function removeTokBoxSessions(a){TokBox.removeSessions(a)}function receiveTokBoxEnabled(a){console.log("TokBox enabled",a);TokBox.setTokBoxEnabledState(a)}function receiveTokBoxArchives(a){}function receiveTokBoxBroadcast(a){};
