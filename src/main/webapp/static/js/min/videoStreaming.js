var TokBox=function(){var c=!1,d=!1,m=!1,h={},f=void 0,v=void 0,r=void 0;return{getSessions:function(){return h},initialize:function(){f=$("#videoConfSessionsContainer");r=f.find(".teacherControls").clone();v=f.find(".videoConfSessionContainer").clone();f.empty();f.append(r.show());console.log(r);m=!0},receiveTokBoxSession:function(k){if(m)if(0==OT.checkSystemRequirements())c||(errorAlert("Video conferencing disabled","Video conferencing is disabled because your browser does not support it.  You could try recent versions of Chrome or Firefox."),
c=!0);else if(d&&!(k.sessionId in h)){var u=v.clone();f.append(u);k=TokBoxSession(k,u);h[k.id]=k;k.refreshVisualState()}},setTokBoxEnabledState:function(c){d=c},removeSessions:function(c){_.forEach(h,function(d){_.some(c,function(c){return c==d.id})&&(d.shutdown(),delete h[d.id])})}}}(),TokBoxSession=function(c,d){var m=160,h=120,f=15,v=[320,640,1280],r=[240,480,720],k=[1,7,15,30],u=Conversations.getCurrentConversation().permissions.studentsMayBroadcast,D=function(a){var b=_.reverse(_.filter(k,function(b){return b<=
a}))[0];void 0==b&&(b=k[0]);return b},E=function(a){var b=_.reverse(_.filter(v,function(b){return b<=a}))[0];void 0==b&&(b=v[0]);return b},F=function(a){var b=_.reverse(_.filter(r,function(b){return b<=a}))[0];void 0==b&&(b=r[0]);return b},n=function(){return"isConnected"in e&&e.isConnected()},z={},l=d.find(".videoConfStartButton"),w=d.find(".videoConfContainer"),x=d.find(".videoConfStartButtonContainer"),A=d.find(".videoConfPermitStudentBroadcastContainer"),G=A.find("#canBroadcast"),H=d.find(".videoSubscriptionsContainer"),
I=d.find(".videoContainer").clone(),B=d.find(".broadcastContainer"),J=d.find(".broadcastLink");H.empty();B.empty();w.empty();var p={},q=void 0,g=function(){l.unbind("click");Conversations.shouldModifyConversation()?(A.show(),G.prop("checked",u).unbind("click").on("click",function(){var a=$(this).prop("checked");if("Conversations"in window){var b=Conversations.getCurrentConversation(),c=b.permissions;c.studentsMayBroadcast=a;changePermissionsOfConversation(b.jid.toString(),c)}})):A.hide();n()&&(u||
Conversations.shouldModifyConversation())?(w.show(),"capabilities"in e&&"publish"in e.capabilities&&1==e.capabilities.publish?(x.show(),l.show(),l.on("click",function(){n()&&(void 0==q?C():y())})):(n()&&y(!0),x.hide(),l.hide(),w.hide())):(n()&&y(!0),x.hide(),l.hide(),w.hide());d.find(".subscribedStream").removeClass("subscribedStream");if(e.connection){var a=e.connection.data.match(/description=(.+)$/)[1],b=a;if(a==Conversations.getCurrentConversationJid())b="everyone";else{var c=_.flatMap(Conversations.getCurrentSlide().groupSets,
function(b){return _.find(b.groups,function(b){return b.id==a})});c.length&&(b=sprintf("group %s",c[0].title))}x.find(".context").text(b)}void 0!=q?l.addClass("publishedStream").find("div").text("Hide from"):l.removeClass("publishedStream").find("div").text("Stream to");_.forEach(p,function(a){"refreshVisual"in a&&a.refreshVisual()});DeviceConfiguration.applyFit()},C=function(){g();if(n()&&void 0==q){var a=sprintf("tokBoxVideoElemPublisher_%s",_.uniqueId()),b=$("<span />",{id:a,"class":"publisherVideoElem"});
d.find(".viewscreen").append(b);sprintf("%sx%s",E(m),F(h));q=a=OT.initPublisher(a,{name:UserSettings.getUsername(),width:m,height:h,resolution:"320x240",frameRate:D(f),insertMode:"append"},function(a){a&&console.log("tokbox error:",a)});a.element.style.width=m;a.element.style.height=h;e.publish(a);d.find(".videoConfStartButton").addClass("publishedStream")}g()},y=function(a){a||g();n()&&void 0!=q&&(d.find(".publisherVideoElem").remove(),e.unpublish(q),q=void 0,d.find(".videoConfStartButton").removeClass("publishedStream"));
a||g()};Progress.afterWorkQueuePause.videoStreaming=function(){_.forEach(p,function(a){"subscriber"in a&&null!=a.subscriber&&"restrictFramerate"in a.subscriber&&a.subscriber.restrictFramerate(!0)})};Progress.beforeWorkQueueResume.videoStreaming=function(){_.forEach(p,function(a){"subscriber"in a&&null!=a.subscriber&&"restrictFramerate"in a.subscriber&&a.subscriber.restrictFramerate(!1)})};Progress.conversationDetailsReceived.videoStreaming=function(a){console.log("videoStreaming conversationDetails",
a);"jid"in a&&"Conversations"in window&&"permissions"in a&&"studentsMayBroadcast"in a.permissions&&(u=a.permissions.studentsMayBroadcast,g())};var e=OT.initSession(c.apiKey,c.sessionId);e.on({streamDestroyed:function(a){a.stream.id in p&&(p[a.stream.id].elem.remove(),delete p[a.stream.id],g())},streamCreated:function(a){if("capabilities"in e&&"subscribe"in e.capabilities&&1==e.capabilities.subscribe){var b=a.stream,c=p[b.id];if(void 0==c){c={stream:b,subscribed:!1,refreshVisual:function(){}};p[b.id]=
c;var d=sprintf("tokBoxVideoElemSubscriber_%s",_.uniqueId()),f=$(I.clone()),k=$("<span />",{id:d,"class":"subscriberVideoElem"});f.find(".publisherName").text(a.stream.name);var q=f.find(".videoConfSubscribeButton"),n=function(){q.toggleClass("subscribedStream",c.subscribed)};n();var t=p[b.id],l=b.name,r=function(){t.subscribed=!0;z[l]=!0;var a=e.subscribe(t.stream,d,{insertMode:"append",width:m,height:h},function(a){a&&(f.remove(),console.log("error when subscribing to stream",a,t.stream.name,t.stream.id))});
a.element.style.width=m;a.element.style.height=h;a.on("videoDimensionsChanged",function(b){a.element.style.width=b.newValue.width+"px";a.element.style.height=b.newValue.height+"px"});t.subscriber=a;t.refreshVisual=n};f.find(".videoConfSubscribeButton").on("click",function(){t.subscribed?(t.subscribed=!1,e.unsubscribe(t.subscriber),delete z[l]):r();g()});k.prepend(f);w.append(k);c.videoSelectorId=d;c.elem=f;l in z&&r();g()}else c.stream=b}},sessionConnected:function(a){g()},sessionDisconnected:function(a){g()},
sessionReconnected:function(a){g()},sessionReconnecting:function(a){g()}});e.connect(c.token,function(a){a&&console.log("error when connecting to tokBox",a,c);g()});return{startPublish:C,receiveBroadcast:function(a){if(null!=a&&"broadcastUrls"in a&&"hls"in a.broadcastUrls){var b=J.clone();b.attr("href",a.broadcastUrls.hls);B.append(b)}else B.empty()},getIsConnected:n,id:e.id,getSession:function(){return e},refreshVisualState:g,shutdown:function(){e.disconnect();d.remove()},resizeVideo:function(a,
b,c){void 0!=a&&(m=a);void 0!=b&&(h=b);void 0!=c&&(f=c);void 0!=q&&(y(),startPublisherFunc());_.forEach(p,function(a){"subscriber"in a&&null!=a.subscriber&&(a.subscriber.setPreferredResolution({width:m,height:h}),"refreshVisual"in a&&a.refreshVisual())});g()}}};function receiveTokBoxSessionToken(c){"token"in c&&TokBox.receiveTokBoxSession(c)}function removeTokBoxSessions(c){TokBox.removeSessions(c)}function receiveTokBoxEnabled(c){TokBox.setTokBoxEnabledState(c)}
function receiveTokBoxArchives(c){}function receiveTokBoxBroadcast(c){};
