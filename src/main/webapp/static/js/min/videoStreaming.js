var TokBox=function(){var a=void 0,m=function(){return void 0!=a&&"isConnected"in a&&a.isConnected()},n=void 0,e=void 0,k=void 0,p=void 0,l=void 0,q=void 0,r=!1,f={};$(function(){e=$("#videoConfStartButton");k=$("#videoConfContainer");p=$("#videoSubsciptionsContainer");l=$("#broadcastContainer");q=l.find("#broadcastLink").clone();n=k.find(".videoContainer").clone();k.empty();l.empty();g()});var g=function(){e.unbind("click");r&&m()?(k.show(),"capabilities"in a&&"publish"in a.capabilities&&1==a.capabilities.publish?
(e.show(),e.on("click",t)):e.hide()):(e.hide(),k.hide());$(".subscribedStream").removeClass("subscribedStream");void 0!=h?e.addClass("subscribedStream"):e.removeClass("subscribedStream");_.forEach(f,function(a){console.log("refreshing s:",a);a.refreshVisual()})},h=void 0,t=function(){g();console.log("attempting to start send:",m(),a);if(m())if(void 0==h){var b=sprintf("tokBoxVideoElemPublisher_%s",_.uniqueId()),d=$("<span />",{id:b,"class":"publisherVideoElem"});k.append(d);h=b=OT.initPublisher(b,
{insertMode:"append",width:320,height:240,name:UserSettings.getUsername()},function(a){a&&console("error:",a)});console.log("publishing",b,a);a.publish(b)}else $(".publisherVideoElem").remove(),b=h,h=void 0,a.unpublish(b);g()};Progress.afterWorkQueuePause.videoStreaming=function(){console.log("downgrading video quality");_.forEach(f,function(a){subscriber.restrictFramerate(!0)})};Progress.beforeWorkQueueResume.videoStreaming=function(){console.log("upgrading video quality");_.forEach(f,function(a){subscriber.restrictFramerate(!1)})};
return{setTokBoxEnabledState:function(a){r=a;g()},startPublish:t,receiveBroadcast:function(a){console.log("broadcast:",a);if(null!=a&&"broadcastUrls"in a&&"hls"in a.broadcastUrls){var d=q.clone();d.attr("href",a.broadcastUrls.hls);l.append(d)}else l.empty()},receiveTokBoxSession:function(b){0!=OT.checkSystemRequirements()&&(a=OT.initSession(b.apiKey,b.sessionId),a.on({streamDestroyed:function(a){if(a.stream.id in f){var c=f[a.stream.id];delete f[a.stream.id];console.log("streamDestroyed",a,c);c.elem.remove();
g()}},streamCreated:function(d){if("capabilities"in a&&"subscribe"in a.capabilities&&1==a.capabilities.subscribe){var c=d.stream,b=$(n.clone()),e=sprintf("tokBoxVideoElemSubscriber_%s",_.uniqueId()),l=$("<span />",{id:e,"class":"subscriberVideoElem"});b.find(".icon-txt").text(d.stream.name);var h=b.find(".videoConfSubscribeButton");c.id in f?h.addClass("subscribedStream"):h.removeClass("subscribedStream");b.find(".videoConfSubscribeButton").on("click",function(){if(c.id in f){var d=f[c.id];delete f[c.id];
a.unsubscribe(d.subscriber);console.log("unsubscribed from stream:",c.name,c.id)}else d=a.subscribe(c,e,{insertMode:"append",width:320,height:240},function(a){a?(b.remove(),console.log("error when subscribing to stream",a,c.name,c.id)):console.log("subscribed to stream:",c.name,c.id)}),d.on("videoDimensionsChanged",function(a){d.element.style.width=a.newValue.width+"px";d.element.style.height=a.newValue.height+"px"}),f[c.id]={videoSelectorId:e,elem:b,subscriber:d,refreshVisual:function(){c.id in f?
h.addClass("subscribedStream"):h.removeClass("subscribedStream")}};g()});p.append(b);k.append(l);g()}},sessionConnected:function(a){g()},sessionDisconnected:function(a){g()},sessionReconnected:function(a){g()},sessionReconnecting:function(a){g()}}),a.connect(b.token,function(a){a&&console.log("error when connecting to tokBox",a,b);g()}))},getIsConnected:m,getSession:function(){return a}}}();function receiveTokBoxSessionToken(a){"token"in a&&TokBox.receiveTokBoxSession(a)}
function receiveTokBoxEnabled(a){TokBox.setTokBoxEnabledState(a)}function receiveTokBoxArchives(a){console.log("archives:",a)}function receiveTokBoxBroadcast(a){TokBox.receiveBroadcast(a)};
