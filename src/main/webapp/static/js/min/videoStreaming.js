var TokBox=function(){var c=!1,d=!1,p=!1,h={},l=void 0,t=void 0;return{getSessions:function(){return h},initialize:function(){l=$("#videoConfSessionsContainer");t=l.find(".videoConfSessionContainer").clone();l.empty();p=!0;console.log("tokBox initialized",l,t)},receiveTokBoxSession:function(f){if(p)if(0==OT.checkSystemRequirements())c||(errorAlert("Video conferencing disabled","Video conferencing is disabled because your browser does not support it.  You could try recent versions of Chrome, Firefox or Internet Explorer."),
c=!0);else if(d&&!(f.sessionId in h)){var u=t.clone();l.append(u);f=TokBoxSession(f,u);h[f.id]=f;console.log("received session:",f.id,u);f.refreshVisualState()}},setTokBoxEnabledState:function(c){d=c},removeSessions:function(c){_.forEach(h,function(d){_.some(c,function(c){return c==d.id})&&(d.shutdown(),delete h[d.id])})}}}(),TokBoxSession=function(c,d){var p=160,h=120,l=15,t=[320,640,1280],f=[240,480,720],u=[1,7,15,30],z=function(a){var b=_.reverse(_.filter(u,function(b){return b<=a}))[0];void 0==
b&&(b=u[0]);return b},A=function(a){var b=_.reverse(_.filter(t,function(b){return b<=a}))[0];void 0==b&&(b=t[0]);return b},B=function(a){var b=_.reverse(_.filter(f,function(b){return b<=a}))[0];void 0==b&&(b=f[0]);return b},q=function(){return"isConnected"in e&&e.isConnected()},r=d.find(".videoConfStartButton"),v=d.find(".videoConfContainer"),C=d.find(".videoSubscriptionsContainer"),D=d.find(".videoContainer").clone(),w=d.find(".broadcastContainer"),E=d.find(".broadcastLink");C.empty();w.empty();
v.empty();var m={},n=void 0,g=function(){r.unbind("click");q()?(v.show(),"capabilities"in e&&"publish"in e.capabilities&&1==e.capabilities.publish?(r.show(),r.on("click",function(){q()&&(void 0==n?(console.log("attempting to start send:",q(),e),x()):(console.log("attempting to stop send:",q(),e),y()))})):r.hide()):(r.hide(),v.hide());d.find(".subscribedStream").removeClass("subscribedStream");void 0!=n?r.addClass("publishedStream"):r.removeClass("publishedStream");_.forEach(m,function(a){console.log("refreshing s:",
a);"refreshVisual"in a&&a.refreshVisual()});DeviceConfiguration.applyFit()},x=function(){g();console.log("attempting to start send:",q(),e);if(q()&&void 0==n){var a=sprintf("tokBoxVideoElemPublisher_%s",_.uniqueId()),b=$("<span />",{id:a,"class":"publisherVideoElem"});d.find(".videoConfStartButtonContainer").append(b);b=sprintf("%sx%s",A(p),B(h));console.log("target resolution:",b);n=a=OT.initPublisher(a,{name:UserSettings.getUsername(),width:p,height:h,resolution:"320x240",frameRate:z(l),insertMode:"append"},
function(a){a&&console.log("tokbox error:",a)});a.element.style.width=p;a.element.style.height=h;console.log("publishing",a,e);e.publish(a);d.find(".videoConfStartButton").addClass("publishedStream")}g()},y=function(a){g();q()&&void 0!=n&&(d.find(".publisherVideoElem").remove(),e.unpublish(n),n=void 0,d.find(".videoConfStartButton").removeClass("publishedStream"));g()};Progress.afterWorkQueuePause.videoStreaming=function(){_.forEach(m,function(a){"subscriber"in a&&null!=a.subscriber&&"restrictFramerate"in
a.subscriber&&a.subscriber.restrictFramerate(!0)})};Progress.beforeWorkQueueResume.videoStreaming=function(){_.forEach(m,function(a){"subscriber"in a&&null!=a.subscriber&&"restrictFramerate"in a.subscriber&&a.subscriber.restrictFramerate(!1)})};var e=OT.initSession(c.apiKey,c.sessionId);e.on({streamDestroyed:function(a){if(a.stream.id in m){var b=m[a.stream.id];b.elem.remove();delete m[a.stream.id];console.log("streamDestroyed",a,b);g()}},streamCreated:function(a){if("capabilities"in e&&"subscribe"in
e.capabilities&&1==e.capabilities.subscribe){console.log("streamCreated",a,m);var b=a.stream,c=m[b.id];if(void 0==c){c={stream:b,subscribed:!1,refreshVisual:function(){}};m[b.id]=c;var d=sprintf("tokBoxVideoElemSubscriber_%s",_.uniqueId()),f=$(D.clone()),l=$("<span />",{id:d,"class":"subscriberVideoElem"});f.find(".icon-txt").text(a.stream.name);var q=f.find(".videoConfSubscribeButton"),n=function(){q.toggleClass("subscribedStream",c.subscribed)};n();var k=m[b.id],r=function(){k.subscribed=!0;var a=
e.subscribe(k.stream,d,{insertMode:"append",width:p,height:h},function(a){a?(f.remove(),console.log("error when subscribing to stream",a,k.stream.name,k.stream.id)):console.log("subscribed to stream:",k.stream.name,k.stream.id)});a.element.style.width=p;a.element.style.height=h;a.on("videoDimensionsChanged",function(b){a.element.style.width=b.newValue.width+"px";a.element.style.height=b.newValue.height+"px"});k.subscriber=a;k.refreshVisual=n};f.find(".videoConfSubscribeButton").on("click",function(){k.subscribed?
(k.subscribed=!1,e.unsubscribe(k.subscriber),console.log("unsubscribed from stream:",k.stream.name,k.stream.id)):r();g()});l.prepend(f);v.append(l);c.videoSelectorId=d;c.elem=f;g()}else c.stream=b,console.log("updating stream with a new version of it, for whatever reason.",a)}},sessionConnected:function(a){g()},sessionDisconnected:function(a){g()},sessionReconnected:function(a){g()},sessionReconnecting:function(a){g()}});e.connect(c.token,function(a){a&&console.log("error when connecting to tokBox",
a,c);g()});return{startPublish:x,receiveBroadcast:function(a){console.log("broadcast:",a);if(null!=a&&"broadcastUrls"in a&&"hls"in a.broadcastUrls){var b=E.clone();b.attr("href",a.broadcastUrls.hls);w.append(b)}else w.empty()},getIsConnected:q,id:e.id,getSession:function(){return e},refreshVisualState:g,shutdown:function(){console.log("removing this session:",e);e.disconnect();d.remove()},resizeVideo:function(a,b,c){void 0!=a&&(p=a);void 0!=b&&(h=b);void 0!=c&&(l=c);void 0!=n&&(y(),startPublisherFunc());
_.forEach(m,function(a){"subscriber"in a&&null!=a.subscriber&&(a.subscriber.setPreferredResolution({width:p,height:h}),"refreshVisual"in a&&a.refreshVisual())});g()}}};function receiveTokBoxSessionToken(c){"token"in c&&(console.log("receiveTokBoxSession:",c),TokBox.receiveTokBoxSession(c))}function removeTokBoxSessions(c){console.log("removeTokBoxSessions",c);TokBox.removeSessions(c)}function receiveTokBoxEnabled(c){TokBox.setTokBoxEnabledState(c)}
function receiveTokBoxArchives(c){console.log("archives:",c)}function receiveTokBoxBroadcast(c){};
