var Attachments=function(){var c=[],b={},g={};$(function(){b=$("#attachmentListing");g=b.find(".attachmentItem").clone();b.empty();$("#attachments").click(function(){showBackstage("attachments");updateActiveMenu(this)});var a=$("<div />",{id:"attachmentCount","class":"icon-txt"});$("#feedbackStatus").prepend(a);a.click(function(){showBackstage("attachments");updateActiveMenu(this)});$("#menuAttachments").on("click",function(){showBackstage("attachments");updateActiveMenu(this)});f()});var f=function(){var a=
_.size(c);0<a?1==a?($("#attachmentCount").text(sprintf("%s attachment",a)),$("#dedicatedAttachmentCount").text("This conversation has 1 attachment")):($("#attachmentCount").text(sprintf("%s attachments",a)),$("#dedicatedAttachmentCount").text(sprintf("This conversation has %s attachments",a))):($("#attachmentCount").text(""),$("#dedicatedAttachmentCount").text("This conversation has no attachments"))},e=function(){var a=$("#attachmentFileChoice"),d=$("#attachmentUploadFormContainer");a.wrap("<form>").closest("form").get(0).reset();
a.unwrap();d.hide();Conversations.shouldModifyConversation()?($("#attachmentCreationButton").unbind("click").on("click",function(){d.show()}).show(),a.unbind("change").on("change",function(a){WorkQueue.pause();var d=Conversations.getCurrentConversationJid(),c=$(this).val(),b=new FileReader;a=(a.target.files||a.dataTransfer.files)[0];void 0!=a?(b=new FileReader,b.onload=function(a){a=a.target.result;var b=sprintf("/uploadDataUri?filename=%s&jid=%s",encodeURI(c),d);console.log("uploading",b,a.length,
a);$.ajax({url:b,type:"POST",data:a,success:function(a){a=$(a).find("resourceUrl").text();var b=UserSettings.getUsername(),d=Date.now();a={type:"file",id:a,name:c,url:a,author:b,timestamp:d};Conversations.shouldModifyConversation()&&sendStanza(a);e();WorkQueue.gracefullyResume()},error:function(a){alert("upload failed");console.log("file upload failed",a);e();WorkQueue.gracefullyResume()},cache:!1,contentType:!1,processData:!1})},b.readAsDataURL(a)):(e(),WorkQueue.gracefullyResume())})):($("#attachmentCreationButton").unbind("click").hide(),
a.unbind("change").hide())},h=function(){c=[];b.empty();$("#attachmentCount").text("");e()},k=function(){try{b.empty(),0<c.length&&$.map(c,function(a){var d=b,c=g.clone();c.find(".attachmentItem").attr("id",sprintf("attachment_%s_%s","container",a.id));var e=c.find(".attachmentDownloadLink"),f=sprintf("/resourceProxy/%s",encodeURI(a.id));e.attr("href",f);c.find(".attachmentDownloadLinkText").text(a.name);d.append(c)}),f()}catch(a){console.log("renderAttachments exception",a,c)}},l=function(a){try{"type"in
a&&"file"==a.type&&c.push(a)}catch(b){console.log("Attachments.stanzaReceivedFunction exception",b)}};Progress.onConversationJoin.Attachments=h;Progress.historyReceived.Attachments=function(a){try{"type"in a&&"history"==a.type&&(h(),_.forEach(a.files,l),k())}catch(b){console.log("Attachments.historyReceivedFunction",b)}};Progress.stanzaReceived.Attachments=function(a){l(a);k()};return{getAllAttachments:function(){return c}}}();
