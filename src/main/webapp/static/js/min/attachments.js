var Attachments=function(){var c=[],b={},f={};$(function(){b=$("#attachmentListing");f=b.find(".attachmentItem").clone();b.empty();$("#attachments").click(function(){showBackstage("attachments");updateActiveMenu(this)});var a=$("<div />",{id:"attachmentCount","class":"icon-txt"});$("#feedbackStatus").prepend(a);a.click(function(){showBackstage("attachments");updateActiveMenu(this)});$("#menuAttachments").on("click",function(){showBackstage("attachments");updateActiveMenu(this)});g()});var g=function(){var a=
_.size(c);0<a?1==a?($("#attachmentCount").text(sprintf("%s attachment",a)),$("#dedicatedAttachmentCount").text("This conversation has 1 attachment")):($("#attachmentCount").text(sprintf("%s attachments",a)),$("#dedicatedAttachmentCount").text(sprintf("This conversation has %s attachments",a))):($("#attachmentCount").text(""),$("#dedicatedAttachmentCount").text("This conversation has no attachments"))},d=function(){var a=$("#attachmentFileChoice"),e=$("#attachmentUploadFormContainer");a.wrap("<form>").closest("form").get(0).reset();
a.unwrap();e.hide();Conversations.shouldModifyConversation()?($("#attachmentCreationButton").unbind("click").on("click",function(){e.show()}).show(),a.unbind("change").on("change",function(a){WorkQueue.pause();var e=Conversations.getCurrentConversationJid(),c=$(this).val().replace(/.*(\/|\\)/,"");console.log("filename for upload:",c);var b=new FileReader;a=(a.target.files||a.dataTransfer.files)[0];void 0!=a?(b=new FileReader,b.onload=function(a){a=a.target.result;var b=sprintf("/uploadDataUri?filename=%s&jid=%s",
encodeURI(c),e);console.log("uploading",b,a.length,a);$.ajax({url:b,type:"POST",data:a,success:function(a){a=$(a).find("resourceUrl").text();var b=UserSettings.getUsername(),e=Date.now();a={type:"file",id:a,name:c,deleted:!1,url:a,author:b,timestamp:e};Conversations.shouldModifyConversation()&&sendStanza(a);d();WorkQueue.gracefullyResume()},error:function(a){errorAlert("upload failed");console.log("file upload failed",a);d();WorkQueue.gracefullyResume()},cache:!1,contentType:!1,processData:!1})},
b.readAsDataURL(a)):(d(),WorkQueue.gracefullyResume())})):($("#attachmentCreationButton").unbind("click").hide(),a.unbind("change").hide())},h=function(){c=[];b.empty();$("#attachmentCount").text("");d()},k=function(){try{b.empty(),0<c.length&&$.map(_.filter(c,function(a){return 1!=a.deleted}),function(a){m(a,b,f.clone())}),g()}catch(a){console.log("renderAttachments exception",a,c)}},m=function(a,b,c){c.find(".attachmentItem").attr("id",sprintf("attachment_%s_%s","container",a.id));var d=c.find(".attachmentDownloadLink"),
f=sprintf("/attachmentProxy/%s/%s",Conversations.getCurrentConversationJid(),encodeURI(a.id));d.attr("href",f);c.find(".attachmentDownloadLinkText").text(a.name);d=c.find(".deleteButton");if("Conversations"in window&&Conversations.shouldModifyConversation())d.on("click",function(){a.deleted=!0;sendStanza(a)});else d.remove();b.append(c)},n=function(a){var b=_.partition(c,function(b){return b.id==a.id});c=_.concat(b[1],_.reverse(_.sortBy(_.concat([a],b[0]),"timestamp"))[0])},l=function(a){try{"type"in
a&&"file"==a.type&&n(a)}catch(b){console.log("Attachments.stanzaReceivedFunction exception",b)}};Progress.onConversationJoin.Attachments=h;Progress.historyReceived.Attachments=function(a){try{"type"in a&&"history"==a.type&&(h(),_.forEach(a.files,l),k())}catch(b){console.log("Attachments.historyReceivedFunction",b)}};Progress.stanzaReceived.Attachments=function(a){l(a);k()};return{getAllAttachments:function(){return c}}}();
