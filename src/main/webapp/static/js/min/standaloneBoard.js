var board=function(sa){var R=function(a,b){return void 0!=sa&&a in sa?sa[a]:b},A=$("<canvas/>"),x=A[0].getContext("2d"),Oa=$("<div/>"),h={images:{},highlighters:{},texts:{},multiWordTexts:{},inks:{}},ha=void 0;R("pressureSimilarityThreshold",32);var v=0,E=0,u=80,r=60,B=0,H=0,X=0,Y=0,Z=320,aa=240,ia=R("inkCoordinatePrecision",Math.pow(10,3));R("lineDrawingThreshold",25);var Pa=R("maxX",2147483647),Qa=R("maxY",2147483647),ca=[],ta=function(a){return a*(1<B/H/(B/H)?u/B:r/H)},ja=function(a){return a/
(1<B/H/(B/H)?u/B:r/H)},I=function(a,b){var c=ta(a)+v,f=ta(b)+E;return{x:c,y:f}},O=function(a,b){var c=ja(a-v),f=ja(b-E);return{x:c,y:f}},Ca=function(){var a=[["black","#000000",255],["red","#ff0000",255],["blue","#0000ff",255],["cyan","#00ffff",255],["green","#00ff00",255],["white","#ffffff",255],["dark grey","#666666",255]],b=a[0],c=function(a){n=parseInt(a,10);if(isNaN(n))return"00";nValue=Math.max(0,Math.min(n,255));a=function(a){internalN=Math.max(0,Math.min(a,15));return"0123456789ABCDEF".charAt(internalN)};
return(a((n-n%16)/16)+a(n%16)).toLowerCase()},f=function(a,b){return parseInt(a.substring(b,b+2).toUpperCase(),16)};return{getAllNamedColors:function(){return _.map(a,function(a){return{name:a[0],rgb:a[1],alpha:a[2],red:f(a[1],1),green:f(a[1],3),blue:f(a[1],5)}})},getNameForColor:function(b){var e=b[0],g=b[1];return(b=_.find(a,function(a){return a[1]==e&&a[2]==g}))?b[0]:"#"+c(g)+e.substring(1,7)},getColorForName:function(d){if(0==d.indexOf("#")&&7==d.length){var e=255,g=f(d,1),t=f(d,3),m=f(d,5);return[c(g)+
c(t)+c(m),e]}return 0==d.indexOf("#")&&9==d.length?(e=f(d,1),g=f(d,3),t=f(d,5),m=f(d,7),[c(g)+c(t)+c(m),e]):(e=_.find(a,function(a){return a[0]==d}))?[e[1],e[2]]:[b[1],b[2]]}}}(),Da=function(){var a=["sans-serif","serif"],b=[12,14,16,18,20,30,42,60];return{getAllFamilies:function(){return _.map(a,function(a){return a})},getAllSizes:function(){return _.map(b,function(a){return a})}}}(),Ea=function(){var a=[{id:1,width:2,color:"#000000",isHighlighter:!1},{id:2,width:5,color:"#FF0000",isHighlighter:!1},
{id:3,width:8,color:"#00FF00",isHighlighter:!1},{id:4,width:10,color:"#666666",isHighlighter:!1},{id:5,width:30,color:"#FFFF00",isHighlighter:!0}],b=[2,4,5,8,10,16,30];return{getDefaultBrushes:function(){return _.map(a,function(a){return a})},getAllBrushSizes:function(){return _.map(b,function(a){return a})}}}(),C=function(){return{call:function(a,b){b=b||[];$.each(C[a],function(c,f){try{f.apply(f,b)}catch(d){console.log("exception",a,c,d)}})},onPrivacyChanged:{},onConversationJoin:{},onSelectionChanged:{},
onBoardContentChanged:{},onViewboxChanged:{},onLayoutUpdated:{},postRender:{},historyReceived:{},stanzaReceived:{},currentConversationJidReceived:{},currentSlideJidReceived:{},conversationDetailsReceived:{},newConversationDetailsReceived:{},conversationsReceived:{},syncMoveReceived:{},userGroupsReceived:{},usernameReceived:{},userOptionsReceived:{}}}(),T=function(a,b,c,f){var d=!1,e=function(a,b){return{shift:a.shiftKey,ctrl:a.ctrlKey,alt:a.altKey,eraser:b}};$.each(a,function(a,t){var m=$(t);m.css({"touch-action":"none"});
var h=!1,k={},q=function(a){var b=a.originalEvent.pointerId,d="pen"==a.originalEvent.pointerType&&5==a.originalEvent.button,l=m.offset(),e=a.pageX-l.left,l=a.pageY-l.top,c=a.originalEvent.pressure||.5,g=I(e,l),f=k[b]||{pointerId:b,pointerType:a.originalEvent.pointerType,eraser:d,points:[]};f.points.push({x:g.x,y:g.y,screenX:e,screenY:l,z:c});f.eraser=f.eraser||d;k[b]=f;1<_.size(k)&&(0==h&&_.each(k,function(a){a.points=[_.last(a.points)]}),h=!0);return{pointerType:a.pointerType,eraser:f.eraser,x:e,
y:l,z:c,worldPos:g}},z=function(a){var b=a.originalEvent.pointerId,l="pen"==a.originalEvent.pointerType&&5==a.originalEvent.button,e=m.offset(),c=a.pageX-e.left,e=a.pageY-e.top,g=a.originalEvent.pressure||.5,f=I(c,e);delete k[b];h&&0==_.size(k)&&(d=h=!1);return{pointerType:a.pointerType,eraser:l,x:c,y:e,z:g,worldPos:f}},w;try{w="pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(P){w=!1}if(w){var L=_.throttle(function(){if(1<_.size(k)){K();var a=_.map(_.filter(k,
function(a){return 0<_.size(a.points)}),function(a){var b=_.first(a.points);a=_.last(a.points);return[b,a]});k={};var b=_.meanBy(a,function(a){return a[0].x-a[1].x}),d=_.meanBy(a,function(a){return a[0].y-a[1].y});ua.translate(ja(b),ja(d));var b=_.min(_.map(a,function(a){return a[0].y})),l=_.max(_.map(a,function(a){return a[0].y})),d=_.min(_.map(a,function(a){return a[0].x})),e=_.max(_.map(a,function(a){return a[0].x})),b=l-b,d=e-d,e=_.min(_.map(a,function(a){return a[1].y})),l=_.max(_.map(a,function(a){return a[1].y})),
c=_.min(_.map(a,function(a){return a[1].x})),a=(_.max(_.map(a,function(a){return a[1].x}))-c+(l-e))/2;da.scale((d+b)/2/a)}},25);m.bind("pointerdown",function(a){var l=q(a);a.preventDefault();D.pause();1!=_.size(k)||h||(d=!0,b(l.x,l.y,l.z,l.worldPos,e(a,l.eraser)))});m.bind("pointermove",function(a){var b=q(a);a.preventDefault();(a.originalEvent.pointerType==a.POINTER_TYPE_TOUCH||"touch"==a.originalEvent.pointerType&&1<_.size(k))&&L();1!=_.size(k)||h||d&&c(b.x,b.y,b.z,b.worldPos,e(a,b.eraser))});m.bind("pointerup",
function(a){var b=z(a);D.gracefullyResume();a.preventDefault();d&&!h&&f(b.x,b.y,b.z,b.worldPos,e(a,b.eraser));d=!1});w=function(a){z(a);D.gracefullyResume();a.preventDefault();if(d){var b=a.offsetX;a=a.offsetY;k={};D.gracefullyResume();a=I(b,a);b=a.x;a=a.y;b<v?(K(),S.left()):b>=v+u?(K(),S.right()):a<E?(K(),S.up()):a>=E+r&&(K(),S.down());d=!1}d=!1};m.bind("pointerout",w);m.bind("pointerleave",w);m.bind("pointercancel",w)}else{m.bind("mousedown",function(a){D.pause();var l=m.offset();a.preventDefault();
d=!0;var c=a.pageX-l.left,l=a.pageY-l.top,g=I(c,l);b(c,l,.5,g,e(a))});m.bind("mousemove",function(a){if(d){var b=m.offset();a.preventDefault();var l=a.pageX-b.left,b=a.pageY-b.top;c(l,b,.5,I(l,b),e(a))}});m.bind("mouseup",function(a){D.gracefullyResume();a.preventDefault();if(d){var b=m.offset(),l=a.pageX-b.left,b=a.pageY-b.top,c=I(l,b);f(l,b,.5,c,e(a))}d=!1});var ka=function(a,b){D.gracefullyResume();var l=I(a,b),e=l.x,l=l.y;e<v?(K(),S.left()):e>=v+u?(K(),S.right()):l<E?(K(),S.up()):l>=E+r&&(K(),
S.down());d=!1};m.bind("mouseout",function(a){D.gracefullyResume();a.preventDefault();d&&ka(a.offsetX,a.offsetY);d=!1});var l,G=function(a){return{x:average(_.map(a,"x")),y:average(_.map(a,"y"))}},ba=function(a){var b=[],l=m.offset();$.each(a,function(a,d){b.push({x:d.pageX-l.left,y:d.pageY-l.top,identifier:d.identifier})});return b};m.bind("touchstart",function(a){D.pause();a.preventDefault();var c=ba(a.originalEvent.touches);if(1==c.length){var c=c[0],g=I(c.x,c.y);d=!0;b(c.x,c.y,.5,g,e(a))}else l=
G(c)});m.bind("touchmove",function(a){a.preventDefault();var b=ba(a.originalEvent.touches);switch(b.length){case 0:break;case 1:d&&(b=b[0],c(b.x,b.y,.5,I(b.x,b.y),e(a)));break;default:a=G(b);var b=a.x-l.x,g=a.y-l.y;l=a;K();ua.translate(-1*b,-1*g)}});m.bind("touchend",function(a){D.gracefullyResume();a.preventDefault();if(d){var b=m.offset(),l=a.originalEvent.changedTouches[0],c=l.pageX-b.left,b=l.pageY-b.top;0>c||0>b||c>B||b>H?ka(c,b):f(c,b,.5,I(c,b),e(a))}d=!1});var W=1;m.bind("gesturechange",function(a){D.pause();
a.preventDefault();d=!1;a=a.originalEvent.scale;K();da.scale(W/a);W=a});m.bind("gestureend",function(){D.gracefullyResume();W=1})}});return function(a){d=a}},Ga=function(a,b,c){var f=H/B,d={left:a.left,top:a.top,right:a.right,bottom:a.bottom,width:a.width,height:a.height};a.height/a.width>f?(d.height=a.width*f,c&&(b=a.height-d.height,"center"==c?d.top+=b/2:"bottom"==c&&(d.top+=b))):(d.width=a.height/f,b&&(c=a.width-d.width,"center"==b?d.left+=c/2:"right"==b&&(d.left+=c)));d.right=d.left+d.width;d.bottom=
d.top+d.height;return d},N=function(a,b){return"undefined"!=typeof a&&"undefined"!=typeof b?!(b[0]>a[2]||b[2]<a[0]||b[1]>a[3]||b[3]<a[1]):!1},la=function(a,b){var c,f,d,e;a.x<b.x?(c=a.x,d=b.x):(c=b.x,d=a.x);a.y<b.y?(f=a.y,e=b.y):(f=b.y,e=a.y);return{left:c,top:f,right:d,bottom:e,width:Math.abs(d-c),height:Math.abs(e-f)}},ma=function(a,b,c){b=la(b,c);c=$("#selectionAdorner");jQuery.contains(c,a)||c.append(a);a.is(":visible")||a.show();a.css({left:F(b.left),top:F(b.top),width:F(b.width),height:F(b.height)})},
va=function(a){var b=a.x,c=a.y;0>a.x&&(b=0);a.x>B&&(b=B);0>a.y&&(c=0);a.y>H&&(c=H);return{x:b,y:c}},Q=function(a){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(b,c){a.unbind(c)});D.gracefullyResume()},U=function(a){isNaN(a[0])||(h.minX=Math.min(h.minX,a[0]));isNaN(a[1])||(h.minY=Math.min(h.minY,a[1]));isNaN(a[2])||(h.maxX=Math.max(h.maxX,
a[2]));isNaN(a[3])||(h.maxY=Math.max(h.maxY,a[3]));h.width=h.maxX-h.minX;h.height=h.maxY-h.minY},ea=function(a){var b=!_.some(a.bounds,function(a){return isNaN(a)||1E4<a||-1E4>a}),c="size"in a?!isNaN(a.size):!0;a="text"in a?0<a.text.length:!0;return b&&c&&a},D=function(){var a=!0,b=[],c=!1,f=function(){var a=b.pop();a?(c=c||a(),f()):(c&&(V(),c=!1),"Conversations"in window&&Conversations.updateThumbnail(Conversations.getCurrentSlideJid()))},d=void 0;return{pause:function(){d&&(window.clearTimeout(d),
d=void 0);a=!1},gracefullyResume:function(){d&&(window.clearTimeout(d),d=void 0);d=setTimeout(function(){a=!0;f()},1E3)},enqueue:function(d){a?d()&&V():b.push(function(){return d()})}}}(),ua={pan:function(a,b){M.panViewboxRelative(u/B*a,r/H*b)},translate:function(a,b){M.translateViewboxRelative(u/B*a,r/H*b)}},da=function(){var a=function(a){var c=3*h.width,f=3*h.height,d=.1*B,e=.1*H,g=void 0,t=void 0,m=void 0,k=void 0;"width"in a&&(g=a.width,g>c&&(g=c),g<d&&(g=d));"height"in a&&(t=a.height,t>f&&(t=
f),t<e&&(t=e));"x"in a&&(m=a.x,g!=a.width&&(m+=(a.width-g)/2));"y"in a&&t&&(k=a.y,t!=a.height&&(k+=(a.height-t)/2));return{width:g,height:t,x:m,y:k}};return{scale:function(b,c){var f=u*b,d=r*b;c||(d=a({height:d,width:f}),f=d.width,d=d.height);M.scaleAndTranslateViewbox((u-f)/2+v,(r-d)/2+E,f,d)},zoom:function(b,c,f){var d=u*b;b*=r;c||(c=a({height:b,width:d}),d=c.width,b=c.height);d-=u;c=b-r;M.zoomAndPanViewboxRelative(d/2*-1,c/2*-1,d,c,f)},out:function(){da.zoom(1.2)},"in":function(){da.zoom(1/1.2)},
constrainRequestedViewbox:a}}(),M=function(){var a=function(a,d,c,g,t,m){isNaN(a)||isNaN(d)||isNaN(c)||isNaN(g)?t&&t():(b&&b.stop(),b=!1,v=a,E=d,u=c,r=g,m||(X=v,Y=E,Z=u,aa=r),na(),fa(h),t&&t(),C.call("onViewboxChanged",[a,d,c,g]))},b,c=function(a,d,c,g,t,m,k){if(isNaN(a)||isNaN(d)||isNaN(c)||isNaN(g))t&&t();else{var y=v,q=E,z=u,w=r;k=a-y;var L=d-q,ka=c-z,l=g-w;b&&(b.stop(),b=!1);b=(new TWEEN.Tween({x:0,y:0,w:0,h:0})).to({x:k,y:L,w:ka,h:l},300).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){v=
y+this.x;E=q+this.y;u=z+this.w;r=w+this.h}).onComplete(function(){b=!1;m||(X=v,Y=E,Z=u,aa=r);t&&t();C.call("onViewboxChanged",[a,d,c,g])}).start();var G=function(a){b&&(requestAnimationFrame(G),TWEEN.update(),na(),fa(h))};requestAnimationFrame(G)}};return{panViewbox:function(a,b,e,g){return c(a,b,u,r,e,g)},translateViewbox:function(b,d,c,g){return a(b,d,u,r,c,g)},zoomAndPanViewbox:function(a,b,e,g,h,k,p){return c(a,b,e,g,h,k,p)},scaleAndTranslateViewbox:function(b,c,e,g,h,k){return a(b,c,e,g,h,k)},
panViewboxRelative:function(a,b,e,g){return c(a+v,b+E,u,r,e,g)},translateViewboxRelative:function(b,c,e,g){return a(b+v,c+E,u,r,e,g)},zoomAndPanViewboxRelative:function(a,b,e,g,h,k){return c(a+v,b+E,e+u,g+r,h,k)},scaleAndTranslateViewboxRelative:function(b,c,e,g,h,k){return a(b+v,c+E,e+u,g+r,h,k)},changeViewbox:a,easeViewbox:c}}(),S=function(){return{up:function(){M.panViewboxRelative(0,-Math.floor(.6*r))},down:function(){M.panViewboxRelative(0,Math.floor(.6*r))},left:function(){M.panViewboxRelative(-Math.floor(.6*
u),0)},right:function(){M.panViewboxRelative(Math.floor(.6*u),0)},shift:M.panViewboxRelative,center:function(a,b,c){M.panViewboxRelative(a-u/2-v,b-r/2-E,c)}}}(),Sa=function(a){try{ha=parseInt(a.jid);Date.now();h=a;h.minX=0;h.minY=0;h.maxX=B;h.maxY=H;$.each(h.inks,function(a,b){oa(b)});Date.now();$.each(h.highlighters,function(a,b){oa(b)});Date.now();$.each(h.texts,function(a,b){ea(b)?pa(b):delete h.texts[b.id]});Date.now();_.each(h.multiWordTexts,function(a,b){k.text.editorFor(a).doc.load(a.words)});
Date.now();h.width=h.maxX-h.minX;h.height=h.maxY-h.minY;var b=function(){console.log("rendering:",a,h,x);Date.now();C.call("historyReceived",[a]);Date.now();Infinity==h.minX&&(h.minX=0);Infinity==h.minY&&(h.minY=0);X=h.minX;Y=h.minY;Z=h.width;aa=h.height;wa["default"]();console.log("startRender",X,Y,Z,aa);na();fa(h);Date.now();C.call("postRender",[h])};if(0==_.keys(h.images).length)_.defer(b);else{var c=0,f=_.keys(h.images).length;$.each(h.images,function(a,e){e.bounds=[e.x,e.y,e.x+e.width,e.y+e.height];
U(e.bounds);var g=new Image;e.imageData=g;var h=Ha(e,!0);g.onload=function(a){a=!1;0==e.width&&(e.width=g.naturalWidth,a=!0);0==e.height&&(e.height=g.naturalHeight,a=!0);a&&(e.bounds=[e.x,e.y,e.x+e.width,e.y+e.height],U(e.bounds));c+=1;xa(e);c>=f&&_.defer(b)};g.onerror=function(a){console.log("Data image load error",e,a);--f;console.log(sprintf("Preloaded %s/%s images",c,f));c>=f&&_.defer(b)};g.src=h})}}catch(d){console.log("receiveHistory exception",d)}},Ta=_.once(function(){return{x:Pa,y:Qa}}),
Ia=function(a,b){var c=a,f=b,d=1,e=1,g=Ta(),h=g.x,g=g.y;a>h&&(d=h/a,c=a*d);b>g&&(e=g/b,f=b*e);return{width:c,height:f,scaleX:d,scaleY:e}},oa=function(a){if(!ea(a))return a.identity in h.inks&&delete h.inks[a.identity],a.identity in h.highlighters&&delete h.highlighters[a.identity],!1;ga(a);U(a.bounds);var b=$("<canvas />")[0];a.canvas=b;var c=b.getContext("2d"),f=0,d="PRIVATE"==a.privacy.toUpperCase();d&&(f=3);var e=a.bounds[2]-a.bounds[0]+a.thickness+2*f,g=a.bounds[3]-a.bounds[1]+a.thickness+2*f,
k=Ia(e,g);b.width=k.width;b.height=k.height;$(b).css({width:F(e),height:F(g)});b=a.points;e=[];for(g=0;g<b.length;g+=3)e.push(b[g]*k.scaleX),e.push(b[g+1]*k.scaleY),e.push(b[g+2]);var m=-1*(a.minX-a.thickness/2-f)*k.scaleX,p=-1*(a.minY-a.thickness/2-f)*k.scaleY,y,q;if(d){y=e[0]+m;q=e[1]+p;c.lineWidth=a.thickness+f;c.strokeStyle=a.color[0];c.fillStyle=a.color[0];c.moveTo(y,q);c.beginPath();for(g=0;g<e.length;g+=3)c.moveTo(y,q),y=e[g]+m,q=e[g+1]+p,c.lineTo(y,q);c.lineCap="round";c.stroke();c.closePath();
c.strokeStyle="white";c.fillStyle="white"}else c.strokeStyle=a.color[0],c.fillStyle=a.color[0];y=e[0]+m;q=e[1]+p;c.moveTo(y,q);c.beginPath();y=e[0]+m;q=e[1]+p;_.each(_.chunk(e,3),function(b){c.beginPath();c.moveTo(y,q);y=b[0]+m;q=b[1]+p;c.lineTo(y,q);c.lineWidth=b[2]/256*a.thickness;c.lineCap="round";c.stroke()});return!0},Ja=function(a){a.bounds=[a.x,a.y,a.x+a.width,a.y+a.height]},Ha=function(a){var b="PRIVATE"==a.privacy.toUpperCase()?sprintf("%s%s",a.slide,a.author):a.slide;return sprintf("/proxyImageUrl/%s?source=%s",
b,encodeURIComponent(a.source))},ya=function(a){a.bounds=[a.x,a.y,a.x+a.width,a.y+a.runs.length*a.size*1.25]},ga=function(a){for(var b=Infinity,c=Infinity,f=-Infinity,d=-Infinity,e=[],g=a.points,h=0;h<g.length;h+=3){var k=Math.round(g[h]*ia)/ia,p=Math.round(g[h+1]*ia)/ia;g[h]=k;g[h+1]=p;e.push(g[h+2]);b=Math.min(k,b);c=Math.min(p,c);f=Math.max(k,f);d=Math.max(p,d)}a.minX=b;a.minY=c;a.maxX=f;a.maxY=d;a.width=f-b;a.height=d-c;a.centerX=b+a.width/2;a.centerY=c+a.height/2;a.bounds=[b,c,f,d];a.widths=
e},xa=function(a){var b=$("<canvas/>")[0];a.canvas=b;b.width=a.width;b.height=a.height;var c=.1*b.width,f=.1*b.height;b.width=a.width+c;b.height=a.height+f;var d=b.getContext("2d");d.drawImage(a.imageData,c/2,f/2,a.width,a.height);"PRIVATE"==a.privacy.toUpperCase()&&(d.globalAlpha=.2,d.fillStyle="red",d.fillRect(0,0,b.width,b.height),d.globalAlpha=1);delete a.imageData},pa=function(a){function b(a){var b=a.font;"bold"==a.weight&&(b+=" bold");"italic"==a.style&&(b+=" italic");return b}var c=$("<canvas />")[0];
a.canvas=c;var f=c.getContext("2d");f.strokeStyle=a.color;f.font=a.font;var d=/\n/;a.width||(a.width=Math.max.apply(Math,a.text.split(d).map(function(a){return f.measureText(a).width})));var e="",g=[],h=!1;$.each(a.text.split(""),function(b,c){c.match(d)?(g.push(""+e),e=""):h&&" "==c?(g.push(e),e=""):(h=f.measureText(e).width>=a.width-80,e+=c)});g.push(e);g=g.map(function(a){return a.trim()});a.runs=g;ya(a);var k=a.bounds[3]-a.bounds[1],p=Ia(a.bounds[2]-a.bounds[0],k);c.width=p.width;c.height=p.height;
a.height=k;"PRIVATE"==a.privacy.toUpperCase()&&(f.globalAlpha=.2,f.fillStyle="red",f.fillRect(0,0,p.width,p.height),f.globalAlpha=1);f.fillStyle=a.color[0];f.textBaseline="top";$.each(a.runs,function(c,d){var e=function(){var b=_.range(a.size,a.height,a.height/(a.height/(1.25*a.size)));_.each(b,function(b){f.beginPath();f.strokeStyle=a.color[0];b=0+b;f.moveTo(0,b);f.lineTo(0+p.width,b);f.stroke()})},g=c*a.size*1.25;f.font=b(a);f.fillText(d,0*p.scaleX,(0+g)*p.scaleY,p.width);"underline"==a.decoration&&
e()});U(a.bounds)},fa=function(a){if(a){Date.now();try{var b=[v,E,v+u,E+r];ca=[];var c=function(a){void 0!=a&&$.each(a,function(a,c){try{N(c.bounds,b)&&Ka(c)}catch(d){console.log("ink render failed for",d,c.canvas,c.identity,c)}})},f=function(a){a&&$.each(a,function(a,c){c.bounds||(c.bounds=[c.x,c.y,c.x+c.width,c.y+c.height]);N(c.bounds,b)&&drawMultiwordText(c)})};Object.keys(a.images);na();Date.now();$.each(a.images,function(a,c){try{N(c.bounds,b)&&La(c)}catch(g){console.log("image render failed for",
g,c.identity,c)}});Date.now();(function(){c(a.highlighters);Date.now();$.each(a.texts,function(a,c){N(c.bounds,b)&&Ma(c)});Date.now();f(a.multiWordTexts);Date.now();c(a.inks);Date.now();C.call("postRender",[h]);Date.now()})()}catch(d){console.log("Render exception",d)}C.call("onViewboxChanged")}},V=function(){try{fa(h)}catch(a){console.log("exception in render:",a)}},F=function(a){return sprintf("%spx",a)},na=function(){x.clearRect(0,0,B,H)},wa=function(){var a=function(a,c,f,d){var e=!1;void 0==
a?a=X:(e=!0,X=a);void 0==c?c=Y:(e=!0,Y=c);void 0==f?f=Z:(e=!0,Z=f);void 0==d?d=aa:(e=!0,aa=d);d=da.constrainRequestedViewbox({width:f,height:d,x:a,y:c});f=H/d.height;c=B/d.width;c>f?(a=d.height,f=d.width*c/f):(a=d.height/c*f,f=d.width);M.zoomAndPanViewbox(d.x,d.y,f,a,void 0,!e);C.call("onViewboxChanged")};return{specific:function(b,c,f,d){return a(b,c,f,d)},"default":function(){return a()}}}(),Va=function(a){if(0<a.length){a=a.split(" ").map(function(a){return parseFloat(a)});for(var b={thickness:ta(k.draw.drawingAttributes.width),
color:[k.draw.drawingAttributes.color,255],type:"ink",author:"",timestamp:Date.now(),target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),slide:ha.toString(),isHighlighter:k.draw.drawingAttributes.isHighlighter},c=[],f,d,e=0;e<a.length;e+=3)f=a[e],d=a[e+1],f=I(f,d),c=c.concat([f.x,f.y,a[e+2]]);b.points=c;b.checksum=b.points.reduce(function(a,b){return a+b},0);b.startingSum=b.checksum;b.identity=b.checksum.toFixed(1);ga(b);b.isHighlighter?h.highlighters[b.identity]=b:h.inks[b.identity]=b;
Ua(b)}},qa=function(){return{type:"moveDelta",identity:Date.now().toString(),author:"",slide:ha.toString(),target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),timestamp:Date.now(),inkIds:[],textIds:[],multiWordTextIds:[],imageIds:[],xOrigin:0,yOrigin:0,xTranslate:0,yTranslate:0,xScale:1,yScale:1,isDeleted:!1,newPrivacy:"not_set"}},Ua=function(a){updateStrokesPending(1,a.identity);sendStanza(a)},Wa=function(a){var b=carota.runs.defaultFormatting,c;c=a.color||b.color;"string"==typeof c&&
(c=[c,255]);var f=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(c[0]);c={alpha:c[1],red:parseInt(f[1],16),green:parseInt(f[2],16),blue:parseInt(f[3],16)};return{text:a.text,color:c,size:a.size||b.size,font:a.font||b.font,justify:a.align||b.align,bold:!0===a.bold,underline:!0===a.underline,italic:!0===a.italic}},za=function(a){if(a.doc){k.text.echoesToDisregard[a.identity]=!0;var b=sendStanza,c=a.doc.calculateBounds(),f=a.doc.save();a={author:a.author,timestamp:-1,target:a.target,tag:"_",privacy:a.privacy,
slide:a.slide,identity:a.identity,type:a.type,x:c[0],y:c[1],requestedWidth:c[2]-c[0],width:c[2]-c[0],height:c[3]-c[1],words:f.map(Wa)};b(a)}},Na={ink:Xa,dirtyInk:Ya,move:Za,moveDelta:$a,image:ab,text:bb,multiWordText:cb,command:db,submission:eb,attendance:fb,file:gb},gb=function(a){},fb=function(a){},eb=function(a){Submissions.processSubmission(a)},db=function(a){if("/TEACHER_VIEW_MOVED"==a.command&&a.parameters[5]==ha){var b=a.parameters.map(parseFloat);_.some(b,isNaN)?console.log("Can't follow teacher to",
a):b[4]!=DeviceConfiguration.getIdentity()&&"Conversations"in window&&Conversations.getIsSyncedToTeacher()}},cb=function(a){a.identity in k.text.echoesToDisregard||ea(a)&&D.enqueue(function(){k.text.editorFor(a).doc.load(a.words);V()})},bb=function(a){try{ea(a)?(h.texts[a.identity]=a,pa(a),U(a.bounds),D.enqueue(function(){return Aa(a.bounds)?(Ma(a),!1):!0})):a.identity in h.texts&&delete h.texts[a.identity]}catch(b){console.log("textReceived exception:",b)}},$a=function(a){console.log("transformReceived",
a);var b="",c=function(){var a=[void 0,void 0,void 0,void 0],b=function(){return a},c=function(b,c){void 0==b||isNaN(b)||(a[c]=b)};return{minX:b[0],setMinX:function(a){c(a,0)},minY:b[1],setMinY:function(a){c(a,1)},maxX:b[2],setMaxX:function(a){c(a,2)},maxY:b[3],setMaxY:function(a){c(a,3)},incorporateBounds:function(b){var c=function(c){var l=a[c];void 0==l||isNaN(l)?a[c]=b[c]:a[c]=Math.max(l,b[c])},l=function(c){var l=a[c];void 0==l||isNaN(l)?a[c]=b[c]:a[c]=Math.min(l,b[c])};l(0);l(1);c(2);c(3)},
getBounds:b,incorporateBoardBounds:function(){void 0!=a[0]&&void 0!=a[1]&&void 0!=a[2]&&void 0!=a[3]&&U(a)}}}();if("not_set"!=a.newPrivacy&&!a.isDeleted){var f=a.newPrivacy,b=b+("Became "+f);$.each(a.inkIds,function(a,b){var c=h.inks[b];c&&(c.privacy=f);if(c=h.highlighters[b])c.privacy=f});$.each(a.imageIds,function(a,b){h.images[b].privacy=f});$.each(a.textIds,function(a,b){h.texts[b].privacy=f});$.each(a.multiWordTextIds,function(a,b){h.multiWordTextIds[b].privacy=f})}a.isDeleted&&(b+="deleted",
f=a.privacy,$.each(a.inkIds,function(a,b){ra("highlighters",f,b);ra("inks",f,b)}),$.each(a.imageIds,function(a,b){var c=f;h.images[b].privacy.toUpperCase()==c.toUpperCase()&&delete h.images[b]}),$.each(a.textIds,function(a,b){var c=f;h.texts[b].privacy.toUpperCase()==c.toUpperCase()&&delete h.texts[b]}),$.each(a.multiWordTextIds,function(a,b){var c=f;h.multiWordTexts[b].privacy.toUpperCase()==c.toUpperCase()&&delete h.multiWordTexts[b]}));if(1!=a.xScale||1!=a.yScale){var b=b+sprintf("scale (%s,%s)",
a.xScale,a.yScale),d=[],e=[],g=[],k=[];$.each(a.inkIds,function(a,b){d.push(h.inks[b]);d.push(h.highlighters[b])});$.each(a.imageIds,function(a,b){k.push(h.images[b])});$.each(a.textIds,function(a,b){e.push(h.texts[b])});$.each(a.multiWordTextIds,function(a,b){g.push(h.multiWordTexts[b])});var m=0,p=0;if("xOrigin"in a&&"yOrigin"in a)m=a.xOrigin,p=a.yOrigin;else{var y=!0,q=function(a){y?(m=a.x,p=a.y,y=!1):(a.x<m&&(m=a.x),a.y<p&&(p=a.y))};$.each(d,function(a,b){void 0!=b&&"bounds"in b&&1<_.size(b.bounds)&&
q({x:b.bounds[0],y:b.bounds[1]})});$.each(e,function(a,b){void 0!=b&&"x"in b&&"y"in b&&q({x:b.x,y:b.y})});$.each(g,function(a,b){void 0!=b&&"x"in b&&"y"in b&&q({x:b.x,y:b.y})});$.each(k,function(a,b){void 0!=b&&"x"in b&&"y"in b&&q({x:b.x,y:b.y})})}c.setMinX(m);c.setMinY(p);$.each(d,function(b,d){if(d&&void 0!=d){var e=d.points,g=d.bounds[0],f=d.bounds[1],h,k,t=g-m;h=f-p;for(var t=-(t-t*a.xScale),Ra=-(h-h*a.yScale),J=0;J<e.length;J+=3)h=e[J]-g,k=e[J+1]-f,e[J]=g+h*a.xScale+t,e[J+1]=f+k*a.yScale+Ra;
ga(d);c.incorporateBounds(d.bounds)}});$.each(k,function(b,d){if(void 0!=d){d.width*=a.xScale;d.height*=a.yScale;var e=d.x-m,g=d.y-p,g=-(g-g*a.yScale);d.x+=-(e-e*a.xScale);d.y+=g;Ja(d);c.incorporateBounds(d.bounds)}});$.each(e,function(b,d){if(void 0!=d){d.width*=a.xScale;d.height*=a.yScale;var e=d.x-m,g=d.y-p,g=-(g-g*a.yScale);d.x+=-(e-e*a.xScale);d.y+=g;d.size*=a.yScale;d.font=sprintf("%spx %s",d.size,d.family);ea(d)?(pa(d),ya(d)):d.identity in h.texts&&delete h.texts[d.identity];c.incorporateBounds(d.bounds)}});
$.each(g,function(b,d){if(void 0!=d){d.width*=a.xScale;d.height*=a.yScale;var e=d.x-m,g=d.y-p,g=-(g-g*a.yScale);d.x+=-(e-e*a.xScale);d.y+=g;d.size*=a.yScale;d.font=sprintf("%spx %s",d.size,d.family);d.identity in h.multiWordTexts&&delete h.multiWordTexts[d.identity];c.incorporateBounds(d.bounds)}})}if(a.xTranslate||a.yTranslate){var z=a.xTranslate,w=a.yTranslate,b=b+sprintf("translate (%s,%s)",z,w),L=function(a){if(a){for(var b=a.points,d=0;d<b.length;d+=3)b[d]+=z,b[d+1]+=w;ga(a);c.incorporateBounds(a.bounds)}};
$.each(a.inkIds,function(a,b){L(h.inks[b]);L(h.highlighters[b])});$.each(a.imageIds,function(b,d){var e=h.images[d];e.x+=a.xTranslate;e.y+=a.yTranslate;Ja(e);c.incorporateBounds(e.bounds)});$.each(a.textIds,function(b,d){var e=h.texts[d];e.x+=a.xTranslate;e.y+=a.yTranslate;ya(e);c.incorporateBounds(e.bounds)});$.each(a.multiWordTextIds,function(b,d){var e=h.multiWordTexts[d],g=e.doc;g.position.x+=a.xTranslate;g.position.y+=a.yTranslate;e.bounds=g.calculateBounds();c.incorporateBounds(e.bounds)})}c.incorporateBoardBounds();
updateStatus(sprintf("%s %s %s %s %s",b,a.imageIds.length,a.textIds.length,a.multiWordTextIds.length,a.inkIds.length));V()},Za=function(a){updateStatus(sprintf("Moving %s, %s, %s",Object.keys(a.images).length,Object.keys(a.texts).length,Object.keys(a.inks).length));$.each(a.inks,function(a,c){h.inks[a]=c});$.each(a.images,function(a,c){h.images[a]=c});$.each(a.texts,function(a,c){h.texts[a]=c});$.each(a.multiWordTexts,function(a,c){h.multiWordTexts[a]=c});V()},ra=function(a,b,c){c in h[a]&&h[a][c].privacy.toUpperCase()==
b.toUpperCase()&&delete h[a][c]},Ya=function(a){var b=a.identity;a=a.privacy;ra("highlighters",a,b);ra("inks",a,b);updateStatus(sprintf("Deleted ink %s",b));V()},Aa=function(a){return!_.some(ca,function(b){return N(b,a)})},Ba=function(a){var b=O(a[0],a[1]);a=O(a[2],a[3]);return{screenPos:b,screenLimit:a,screenWidth:a.x-b.x,screenHeight:a.y-b.y}},La=function(a){try{if(void 0!=a.canvas){var b=Ba(a.bounds);ca.push(a.bounds);var c=.1*b.screenWidth,f=.1*b.screenHeight;x.drawImage(a.canvas,b.screenPos.x-
c/2,b.screenPos.y-f/2,b.screenWidth+c,b.screenHeight+f)}}catch(d){console.log("drawImage exception",d)}},Ma=function(a){try{var b=Ba(a.bounds);ca.push(a.bounds);x.drawImage(a.canvas,b.screenPos.x,b.screenPos.y,b.screenWidth,b.screenHeight)}catch(c){console.log("drawText exception",c)}},Ka=function(a){var b=Ba(a.bounds);ca.push(a.bounds);x.drawImage(a.canvas,b.screenPos.x,b.screenPos.y,b.screenWidth,b.screenHeight)},ab=function(a){var b=new Image;a.imageData=b;b.onload=function(){0==a.width&&(a.width=
b.naturalWidth);0==a.height&&(a.height=b.naturalHeight);a.bounds=[a.x,a.y,a.x+a.width,a.y+a.height];U(a.bounds);h.images[a.identity]=a;updateTracking(a.identity);xa(a);D.enqueue(function(){if(Aa(a.bounds)){try{La(a)}catch(b){console.log("drawImage exception",b)}return!1}console.log("Rerendering image in contested space");return!0})};b.src=Ha(a)},Xa=function(a){ga(a);updateStrokesPending(-1,a.identity);oa(a)&&(U(a.bounds),a.isHighlighter?h.highlighters[a.identity]=a:h.inks[a.identity]=a,D.enqueue(function(){return Aa(a.bounds)?
(Ka(a),!1):!0}))},K=function(){delete C.onBoardContentChanged.autoZooming},R={historyReceived:function(a){Sa(a)},stanzaReceived:function(a){try{a.type in Na?(Na[a.type](a),C.call("onBoardContentChanged")):console.log(sprintf("Unknown stanza: %s %s",a.type,a))}catch(b){console.log("Exception in receiveMeTLStanza",b,a)}},progress:C,getCanvas:function(){return A},requestViewbox:function(a,b,c,f,d){M.changeViewbox(a,b,c,f,d)},resizeCanvas:function(a,b){var c=Math.round(a),f=Math.round(b),d=A[0].width,
e=A[0].height;if(e!=f||d!=c)B=c,H=f,A.width=c,A.height=f,A[0].width=c,A[0].height=f,console.log("resizing canvas:",d,c,e,f,x),V()},worldToScreen:O,screenToWorld:I,scale:function(){return Math.min(B/u,H/r)},alertCanvas:function(a){var b=A[0],c=b.toDataURL();window.open(c,a,sprintf("width=%s, height=%s",b.width,b.height))},getModes:function(){return k}},k=function(a){var b=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},c=function(a,
c){b();$(a).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$(c).addClass("activeTool").removeClass("inactiveTool")},f={name:"none",activate:function(){k.currentMode.deactivate();k.currentMode=k.none;b()},deactivate:function(){b();Q(A)}};return{currentMode:f,none:f,text:function(){var d=function(){},e,g,f,m,p,y,q,z,w,L,u,l,G,r=function(a){return k.text.editorFor({bounds:[a.x,a.y,a.x,a.y],identity:sprintf("%s_%s_%s","",Date.now(),
_.uniqueId()),requestedWidth:300,width:0,height:0,x:a.x,y:a.y,type:"multiWordText",author:"",words:[]})};$(function(){e=$("#fontFamilySelector");g=$("#fontSizeSelector");f=$("#fontColorSelector");m=$("#fontBoldSelector");p=$("#fontItalicSelector");y=$("#fontUnderlineSelector");q=$("#justifySelector");z=$("#presetFitToText");w=$("#presetRunToEdge");L=$("#presetNarrow");u=$("#presetWiden");G=$("#presetFullscreen");l=$("#presetCenterOnScreen");var a=e.find(".fontFamilyOption").clone(),b=g.find(".fontSizeOption").clone(),
c=f.find(".fontColorOption").clone();Da.getAllFamilies().map(function(b){e.append(a.clone().attr("value",b).text(b))});Da.getAllSizes().map(function(a){g.append(b.clone().attr("value",a).text(a))});Ca.getAllNamedColors().map(function(a){f.append(c.clone().attr("value",a.rgb).text(a.name))});var d=function(a){return function(){_.each(h.multiWordTexts,function(b){if(b.doc.isActive){var c=b.doc.selectedRange();c.setFormatting(a,!0!==c.getFormatting()[a]);0<b.doc.save().length&&za(b)}})}},k=function(a){return function(){var b=
$(this).val();_.each(h.multiWordTexts,function(c){c.doc.isActive&&(c.doc.selectedRange().setFormatting(a,b),0<c.doc.save().length&&za(c))})}},J=function(a){return function(){_.each(h.multiWordTexts,function(b){if(b.doc.isActive){switch(a){case "runToEdge":var c=I(B,0);b.doc.width(c.x+v-b.x);break;case "fitToText":b.doc.width(b.doc.frame.actualWidth());break;case "widen":b.doc.width(1.6*b.doc.frame.actualWidth());break;case "narrow":b.doc.width(.6*b.doc.frame.actualWidth());break;case "centerOnScreen":b.doc.width(I(B,
0).x);b.doc.selectedRange().setFormatting("align","center");b.doc.position.x=v;break;case "fullscreen":b.doc.position.x=v,b.doc.position.y=E,b.doc.width(I(B,0).x),b.doc.select(0,b.doc.frame.length-1),b.doc.selectedRange().setFormatting("align","center"),b.doc.selectedRange().setFormatting("bold",!0),c=b.doc.documentRange().save(),c.push({text:"\n"}),c.push({text:"\n"}),b.doc.load(c),c=b.doc.frame.length-1,b.doc.select(c,c)}b.doc.contentChanged.fire()}})}};m.click(d("bold"));p.click(d("italic"));y.click(d("underline"));
e.change(k("font"));g.change(k("size"));f.change(k("color"));q.change(k("align"));z.click(J("fitToText"));w.click(J("runToEdge"));L.click(J("narrow"));u.click(J("widen"));l.click(J("centerOnScreen"));G.click(J("fullscreen"))});return{echoesToDisregard:{},editorFor:function(a){var b=h.multiWordTexts[a.identity];b||(b=h.multiWordTexts[a.identity]=a);if(!b.doc){var c=""==a.author;b.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",a.identity)}).appendTo(Oa)[0],A[0],c?function(){fa(h)}:d);c&&(b.doc.contentChanged(function(){var a=
h.multiWordTexts[b.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();0<b.doc.save().length&&za(a)}),b.doc.selectionChanged(function(a){a=a();m.toggleClass("active",1==a.bold);p.toggleClass("active",1==a.italic);y.toggleClass("active",1==a.underline);g.val(a.size||carota.runs.defaultFormatting.size);e.val(a.font||carota.runs.defaultFormatting.font);f.val(a.color||carota.runs.defaultFormatting.color);q.val(a.align||carota.runs.defaultFormatting.align)}))}b.doc.position=
{x:a.x,y:a.y};b.doc.width(a.requestedWidth);return b},draw:function(b){b&&b.doc&&carota.editor.paint(A[0],b.doc,!0,a)},activate:function(){k.currentMode.deactivate();k.currentMode=k.text;c("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");C.call("onLayoutUpdated");var a=Date.now();T(A,d,d,function(b,c,d,e){var g=[e.x-10,e.y-10,e.x+10,e.y+10];b=_.values(h.multiWordTexts).filter(function(a){var b=a.doc.calculateBounds();return N(b,g)&&""==a.author});_.each(h.multiWordTexts,function(a){a.doc.isActive=
!1;0==a.doc.save().length&&delete h.multiWordTexts[a.identity]});console.log("Selected texts",b);0<b.length?(b=b[0].doc,b.isActive=!0,c=e.x-b.position.x,d=e.y-b.position.y,e=Date.now(),c=b.byCoordinate(c,d),b.mouseupHandler(c),500>=e-a&&b.dblclickHandler(c),a=e):(e=r(e).doc,e.load([]),e.isActive=!0,e.mouseupHandler(e.byOrdinal(0)));C.historyReceived.ClearMultiTextEchoes=function(){k.text.echoesToDisregard={}};C.call("onSelectionChanged",[k.select.selected])})},deactivate:function(){b();_.each(h.multiWordTexts,
function(a){a.doc.isActive=!1});Q(A);V()}}}(),image:function(){var a=void 0,e=function(){},g={},f=void 0,h=void 0,p=void 0,y=void 0,q=void 0,z=void 0,w=void 0,L=void 0,x=void 0,l=void 0,G=void 0,ba=[{name:"160*120",func:function(a,b){return{w:160,h:120}}},{name:"320*240",func:function(a,b){return{w:320,h:240}}},{name:"25%",func:function(a,b){return{w:a/4,h:b/4}}},{name:"50%",func:function(a,b){return{w:a/2,h:b/2}}},{name:"75%",func:function(a,b){return{w:a/4*3,h:b/4*3}}},{name:"Native",func:function(a,
b){return{w:a,h:b}}}],W=function(){if("type"in g&&"imageDefinition"==g.type){f.css({position:"absolute",left:F(g.screenX-30),top:F(g.screenY)});if("fileUpload"in g){p.hide();y.show();$.map(q.find(".imageSizeChoice"),function(a){"thumbnailSize"in g&&g.thumbnailSize.name==$(a).text()?$(a).addClass("active"):$(a).removeClass("active")});var a=new FileReader;a.onload=function(a){"thumbnailSize"in g||(g.thumbnailSize=ba[0]);z[0].getContext("2d").clearRect(0,0,z.width(),z.height());var b=new Image;b.onload=
function(a){var c=g.thumbnailSize.func(b.width,b.height);a=c.w;var c=c.h,d,e;a<c?(d=300,e=a/(c/300)):(e=300,d=c/(a/300));z.attr("width",e);z.attr("height",d);z.css({width:F(e),height:F(d)});z[0].getContext("2d").drawImage(b,0,0,e,d);L.text(g.x);x.text(g.y);l.text(a);G.text(c);d=$("<canvas/>");d.attr("width",a);d.attr("height",c);d.css({width:F(a),height:F(c)});d[0].getContext("2d").drawImage(b,0,0,a,c);g.width=a;g.height=c;g.resizedImage=d[0].toDataURL();"resizedImage"in g&&w.show()};b.src=a.target.result};
a.readAsDataURL(g.fileUpload);"resizedImage"in g?w.show():w.hide()}else p.show(),y.hide();f.show()}else P()},P=function(){f.hide();var a=p.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();void 0!=z[0]&&z[0].getContext("2d").clearRect(0,0,z.width(),z.height());L.text("");x.text("");l.text("");G.text("");p.unwrap();g={};w.text("Upload").unbind("click").on("click",B)},B=function(){w.unbind("click").text("Uploading");if("type"in g&&"imageDefinition"==g.type&&"resizedImage"in g){D.pause();var a=
Date.now(),b=sprintf("%s%s","",a),c=Conversations.getCurrentSlideJid(),d=sprintf("/uploadDataUri?jid=%s&filename=%s",c.toString(),encodeURI(b));$.ajax({url:d,type:"POST",success:function(d){updateTracking(b);var e=$(d).find("resourceUrl").text(),f={type:"image",author:"",timestamp:a,tag:'{"author":"","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+e+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:e,slide:c.toString(),source:$(d).text(),width:g.width,height:g.height,target:"presentationSpace",
privacy:Privacy.getCurrentPrivacy(),x:g.x,y:g.y};P();updateTracking(e,function(){wa.specific(Math.min(f.x,v),Math.min(f.y,E),Math.max(f.x+f.width,u),Math.max(f.y+f.height,r))});sendStanza(f);D.gracefullyResume()},error:function(a){P();alert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");D.gracefullyResume()},data:g.resizedImage,cache:!1,contentType:!1,processData:!1})}},Fa=!1;$(function(){if(!Fa){Fa=!0;a=$("imageMarquee");
f=$("#imageInsertOptions");h=$("#imageInsertOptionsClose");p=$("#imageFileChoice");y=$("#imageSizeControls");q=$("#imageSizeChoiceSelector");z=$("#imageUploadThumbnail");$("#imageProgressContainer");w=$("#imageUploadButton");L=$("#imageUploadX");x=$("#imageUploadY");l=$("#imageUploadWidth");G=$("#imageUploadHeight");h.on("click",P);p.attr("accept","image/*");void 0!=p[0]&&p[0].addEventListener("change",function(a){"type"in g&&"imageDefinition"==g.type&&(a=(a.target.files||a.dataTransfer.files)[0],
0==a.type.indexOf("image")&&(g.fileUpload=a,g.thumbnailSize=ba[0],W()))},!1);var b=q.find(".imageSizeChoice").clone();q.empty();ba.map(function(a){var c=b.clone().text(a.name).on("click",function(){"type"in g&&"imageDefinition"==g.type&&(g.thumbnailSize=a,W())});q.append(c)});P()}});return{activate:function(){k.currentMode.deactivate();k.currentMode=k.image;c("#imageTools","#insertImage");P();C.call("onLayoutUpdated");T(A,e,e,function(b,c,e,f){a.show();a.css({left:F(b),top:F(c)});P();b=O(f.x,f.y);
g={type:"imageDefinition",screenX:b.x,screenY:b.y,x:f.x,y:f.y};W()})},deactivate:function(){P();Q(A);b()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");k.currentMode.deactivate();c("#panTools","#panMode");k.currentMode=k.pan;var a,b;T(A,function(c,f,h){K();a=c;b=f},function(c,f,h){ua.translate(-1*(c-a),-1*(f-b));a=c;b=f},function(a,b,c){})},deactivate:function(){b();Q(A)}},select:function(){var a=!1,e=function(){k.select.selected={images:{},text:{},inks:{},multiWordTexts:{}};C.call("onSelectionChanged",
[k.select.selected])},g=_.debounce(function(){_.forEach(["images","texts","inks","highlighters","multiWordTexts"],function(a){var b="highlighters"==a?"inks":a;if(k&&k.select&&k.select.selected&&b in k.select.selected){var c=k.select.selected[b];_.forEach(c,function(d){c&&a in h&&d.identity in h[a]?c[d.identity]=h[a][d.identity]:"inks"==b?"highlighters"==a&&d.identity in c&&1==c[d.identity].isHighlighter?delete c[d.identity]:"inks"==a&&d.identity in c&&0==c[d.identity].isHighlighter&&delete c[d.identity]:
delete c[d.identity]})}});C.call("onSelectionChanged",[k.select.selected])},100),f=function(){if(void 0!=k.select.selected&&a){var b=k.select.selected;banContent(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),_.uniq(_.map(b.inks,function(a){return a.identity})),_.uniq(_.map(b.texts,function(a){return a.identity})),_.uniq(_.map(b.multiWordTexts,function(a){return a.identity})),_.uniq(_.map(b.images,function(a){return a.identity})))}e()},m=function(){(a=Conversations.shouldModifyConversation()?
!a:!1)?$("#administerContent").removeClass("disabledButton"):$("#administerContent").addClass("disabledButton");e()};C.onBoardContentChanged.ModesSelect=g;C.onViewboxChanged.ModesSelect=g;C.onSelectionChanged.ModesSelect=function(b){b&&(k.select.selected=b,"images"in b&&0<_.size(b.images)||"inks"in b&&0<_.size(b.inks)||"texts"in b&&0<_.size(b.texts)||"multiWordTexts"in b&&0<_.size(b.multiWordTexts)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),a?$("#ban").removeClass("disabledButton"):
$("#ban").addClass("disabledButton")):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?($("#ban").show(),$("#administerContent").show()):($("#ban").hide(),$("#administerContent").hide()),a?$("#administerContent").removeClass("disabledButton"):$("#administerContent").addClass("disabledButton"),k.currentMode==k.select&&($("#selectionAdorner").empty(),_.forEach(["images",
"texts","inks","highlighters","multiWordTexts"],function(a){a in b&&$.each(b[a],function(a,b){var c=va(O(b.bounds[0],b.bounds[1])),d=va(O(b.bounds[2],b.bounds[3])),e=d.x-c.x,d=d.y-c.y;va(b.bounds[0],b.bounds[1],b.bounds[2],b.bounds[3]);$("#selectionAdorner").prepend($("<div />").addClass("selectionAdorner").css({left:c.x,top:c.y,width:e,height:d}).data("originalWidth",e).data("originalHeight",d))})})))};C.historyReceived.ModesSelect=e;C.conversationDetailsReceived.ModesSelect=function(b){a&&Conversations.shouldModifyConversation()&&
(a=!1);Conversations.shouldModifyConversation()?($("#ban").show(),$("#administerContent").show(),$("#administerContent").bind("click",m),$("#ban").bind("click",f)):($("#ban").hide(),$("#administerContent").hide(),$("#administerContent").unbind("click"),$("#ban").unbind("click"));a?$("#administerContent").removeClass("disabledButton"):$("#administerContent").addClass("disabledButton")};return{name:"select",selected:{images:{},texts:{},inks:{},multiWordTexts:{}},clearSelection:e,activate:function(){k.currentMode.deactivate();
k.currentMode=k.select;c("#selectTools","#selectMode");updateStatus("SELECT");var b={x:0,y:0},g,q,z,w=$("<div/>",{id:"selectMarquee"}),u=$("#selectionAdorner"),r=!1,l=!1;$("#delete").bind("click",function(){if(void 0!=k.select.selected){var a=qa();a.isDeleted=!0;"inks"in k.select.selected&&(a.inkIds=_.keys(k.select.selected.inks));"texts"in k.select.selected&&(a.textIds=_.keys(k.select.selected.texts));"images"in k.select.selected&&(a.imageIds=_.keys(k.select.selected.images));"multiWordTexts"in k.select.selected&&
(a.multiWordTextIds=_.keys(k.select.selected.multiWordTexts));sendStanza(a)}e()});var G=[0,0,0,0];$("#administerContent").bind("click",m);$("#ban").bind("click",f);$("#resize").bind("click",function(){var a=_.flatten([_.values(k.select.selected.images),_.values(k.select.selected.texts),_.values(k.select.selected.inks),_.values(k.select.selected.multiWordTexts)]);if(0<a.length){var b=Math.min.apply(Math,a.map(function(a){return a.bounds[0]})),c=Math.min.apply(Math,a.map(function(a){return a.bounds[1]})),
d=Math.max.apply(Math,a.map(function(a){return a.bounds[2]})),a=Math.max.apply(Math,a.map(function(a){return a.bounds[3]})),b=O(b,c),d=O(d,a).x,b=b.y;G=[d-30,b-30,d+30,b+30];u.append($("<img />",{src:"/static/images/resize.png","class":"resizeHandle"}).css({width:F(30),height:F(30),position:"absolute",left:F(d),top:F(b)}))}});var x=function(a){a("images");a("texts");a("multiWordTexts");a("inks")},l=r=!1;T(A,function(a,c,d,e,f){r=l=!1;b={x:a,y:c};g=a;q=c;var h=[e.x-10,e.y-10,e.x+10,e.y+10];N(G,[a-
10,c-10,a+10,c+10])?(updateStatus("Resizing"),l=!0):f.ctrl||(r=_.some(["images","texts","inks","multiWordTexts"],function(a){return _.some(k.select.selected[a],function(a){return a?N(a.bounds,h):!1})}));z=e;r?updateStatus("SELECT -> DRAG"):l?updateStatus("SELECT -> RESIZE"):(u.empty(),u.append(w),w.show(),ma(w,b,b))},function(a,c,d,e,f){d={x:a,y:c};var h=a-g,k=c-q;g=a;q=c;if(l){var m=a/G[0],t=m;f.ctrl&&(t=c/G[0]);updateStatus(sprintf("Resizing %s%%",100*m));$(".selectionAdorner").map(function(){var a=
$(this);a.css({width:a.data("originalWidth")*m,height:a.data("originalHeight")*t})})}else r?$(".selectionAdorner").map(function(){var a=$(this),b=F(parseInt(a.css("left"))+h),c=F(parseInt(a.css("top"))+k);a.css({left:b,top:c})}):ma(w,b,d)},function(b,c,e,g,f){D.gracefullyResume();if(r)f=qa(),f.xTranslate=g.x-z.x,f.yTranslate=g.y-z.y,f.inkIds=_.keys(k.select.selected.inks),f.textIds=_.keys(k.select.selected.texts),f.imageIds=_.keys(k.select.selected.images),f.multiWordTextIds=_.keys(k.select.selected.multiWordTexts),
r=!1,sendStanza(f);else if(l){g=qa();b/=G[0];var m=Infinity,t=Infinity;_.forEach(k.select.selected.inks,function(a){m=Math.min(a.bounds[0]);t=Math.min(a.bounds[1])});_.forEach(k.select.selected.texts,function(a){m=Math.min(a.bounds[0]);t=Math.min(a.bounds[1])});_.forEach(k.select.selected.images,function(a){m=Math.min(a.bounds[0]);t=Math.min(a.bounds[1])});_.forEach(k.select.selected.multiWordTexts,function(a){m=Math.min(a.bounds[0]);t=Math.min(a.bounds[1])});g.xOrigin=m;g.yOrigin=t;g.inkIds=_.keys(k.select.selected.inks);
g.textIds=_.keys(k.select.selected.texts);g.imageIds=_.keys(k.select.selected.images);g.multiWordTextIds=_.keys(k.select.selected.multiWordTexts);g.xScale=b;g.yScale=f.ctrl?c/G[0]:b;sendStanza(g);l=!1}else{c=la(z,g);var p=[c.left,c.top,c.right,c.bottom],q={images:{},texts:{},inks:{},multiWordTexts:{}},y={};x(function(b){$.each(h[b],function(c,e){if(!("bounds"in e)&&"type"in e)switch(e.type){case "text":pa(e);break;case "image":xa(e);break;case "ink":oa(e);break;default:e.bounds=[NaN,NaN,NaN,NaN]}var g=
e.bounds,g=Math.abs(.5*(g[2]-g[0])*(g[3]-g[1])),f;f=e.bounds;f=N(p,f)?(Math.max(p[0],f[0])-Math.min(p[2],f[2]))*(Math.max(p[1],f[1])-Math.min(p[3],f[3])):0;f>=g&&(incrementKey(y,e.author),a?""!=e.author&&(q[b][e.identity]=e):""==e.author&&(q[b][e.identity]=e))})});$.each(h.highlighters,function(b,c){N(c.bounds,p)&&(incrementKey(y,c.author),a?""!=c.author&&(q.inks[c.identity]=c):""==c.author&&(q.inks[c.identity]=c))});f.ctrl?x(function(a){$.each(q[a],function(b,c){b in k.select.selected[a]?delete k.select.selected[a][b]:
k.select.selected[a][b]=c})}):k.select.selected=q;var u=sprintf("Selected %s images, %s texts, %s inks, %s rich texts ",_.keys(k.select.selected.images).length,_.keys(k.select.selected.texts).length,_.keys(k.select.selected.inks).length);$.each(y,function(a,b){u+=sprintf("%s:%s ",a,b)});updateStatus(u)}C.call("onSelectionChanged",[k.select.selected]);w.css({width:0,height:0}).hide()})},deactivate:function(){Q(A);b();e();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();
$("#selectMarquee").hide();$("#administerContent").unbind("click");$("#ban").unbind("click")}}}(),zoom:{name:"zoom",activate:function(){k.currentMode.deactivate();k.currentMode=k.zoom;c("#zoomTools","#zoomMode");var a=$("<div />",{id:"zoomMarquee"}),b,g={x:0,y:0};T(A,function(c,f,h,k){K();b=k;a.show();a.appendTo($("#selectionAdorner"));g={x:c,y:f};ma(a,g,g)},function(b,c,e,f){b={x:b,y:c};c=la(b,g);e="left";f="top";b.x==c.left&&(e="right");b.y==c.top&&(f="bottom");b=Ga(c,e,f);ma(a,{x:b.right,y:b.bottom},
{x:b.left,y:b.top})},function(c,g,f,h){D.gracefullyResume();a.hide();c={x:0+h.x,y:0+h.y};g=la(c,{x:0+b.x,y:0+b.y});f="left";h="top";c.x==g.left&&(f="right");c.y==g.top&&(h="bottom");c=Ga(g,f,h);wa.specific(c.left,c.top,c.width,c.height)})},deactivate:function(){b();$("#zoomMarquee").remove();Q(A)}},feedback:function(){var a=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};C.onConversationJoin.setConversationRole=
function(){a()};C.conversationDetailsReceived.respectNewPermissions=a;return{name:"feedback",activate:function(){k.currentMode.deactivate();k.currentMode=k.feedback;a();c("#feedbackTools","#feedbackMode");T(A,function(a,b,c,d){},function(a,b,c,d){},function(a,b,c,d){});a()},deactivate:function(){b();Q(A);C.call("onLayoutUpdated")}}}(),draw:function(){var a=Ea.getDefaultBrushes(),e,f=!1,t=!1;return{name:"draw",brushes:_.map(a,function(a){return _.clone(a)}),activate:function(){if(k.currentMode!=k.draw){k.currentMode.deactivate();
k.currentMode=k.draw;var b=function(){},p=void 0,u=void 0,q=function(a){k.draw.brushes[a.index]=a};$(".activeBrush").removeClass("activeBrush");var r=function(){var a=$("#drawTools");_.each(a.find(".pen"),function(a,c){var d=k.draw.brushes[c],h=$(a).css({color:d.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");e=d;q(d);k.draw.drawingAttributes=e;f=!1;b(d)});h.find(".widthIndicator").text(d.width);d==e&&h.addClass("activeBrush")})},b=function(a){var c=
$("#colors .dots"),d=$("#sizes .dots"),f=Ca.getAllNamedColors(),g=Ea.getAllBrushSizes();d.empty();g.map(function(c){var f=p.clone();d.append(f);f.click(function(){a.width=c;q(a);e=a;r();b(a)});var g=Canvas.circle(a.color,c,50);c==a.width&&f.addClass("activeTool");f.prepend(g);g=c.toString()+"px";f.find(".sizeDotName").append(g)});c.empty();f.map(function(d){var f=u.clone();c.append(f);f.on("click",function(){a.color=d.rgb;e=a;q(a);r();b(a)});f.css("color",d.rgb);"rgb"in d&&d.rgb==a.color&&f.addClass("activeTool");
var g=d.name;f.find(".colorDotName").append(g)});f=$("#setPenToHighlighter").unbind("click").on("click",function(){a.isHighlighter=!0;e=a;q(a);r();b(a)});g=$("#setPenToPen").unbind("click").on("click",function(){a.isHighlighter=!1;e=a;q(a);r();b(a)});"isHighlighter"in e&&e.isHighlighter?(f.addClass("activeTool").addClass("active"),g.removeClass("activeTool").removeClass("active")):(g.addClass("activeTool").addClass("active"),f.removeClass("activeTool").removeClass("active"));C.call("onLayoutUpdated")};
$("#resetPenButton").empty().text("reset pen").click(function(){var c=_.find(a,function(a){return a.id==e.id});void 0!=c&&(e.width=c.width,e.color=c.color,e.isHighlighter=c.isHighlighter,r(),b(e))});if(!t){t=!0;p=$("#penSize .sizeDot").clone();u=$("#penColor .colorDot").clone();e=k.draw.brushes[0];r();b(e);k.draw.drawingAttributes=e;var w=$("#drawTools");w.find(".eraser").click(function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");f=!0});w.find(".advancedTools").on("click",
function(){b(e);showBackstage("customizeBrush")})}c("#drawTools","#drawMode");var v=[],B=[];$(".activeBrush").removeClass("activeBrush");f?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".pen"),function(a,b){b+1==e.id&&$(a).addClass("activeBrush")});T(A,function(a,b,c,d,e){B=[];f||e.eraser||(x.strokeStyle=k.draw.drawingAttributes.color,v=[a,b,256*c])},function(a,b,c,d,e){if(f||e.eraser){var m=[d.x-10,d.y-10,d.x+10,d.y+10];a=function(a){$.each(a,function(b,c){if(""==
c.author&&N(c.bounds,m)){delete a[c.identity];B.push(c.identity);var d=c.bounds,e=O(d[0],d[1]),d=O(d[2],d[3]);x.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};x.globalAlpha=.4;x.fillStyle="red";a(h.inks);a(h.highlighters);x.globalAlpha=1}else d=k.draw.drawingAttributes.width*c,x.beginPath(),x.lineCap="round",x.lineWidth=d,d=_.takeRight(v,3),x.moveTo(d[0],d[1]),x.lineTo(a,b),x.stroke(),v=v.concat([a,b,256*c])},function(a,b,c,d,e){f||e.eraser?(a=qa(),a.isDeleted=!0,a.inkIds=B,sendStanza(a)):(d=k.draw.drawingAttributes.width*
c,x.lineWidth=d,x.beginPath(),x.lineWidth=d,x.lineCap="round",d=_.takeRight(v,3),x.moveTo(d[0],d[1]),x.lineTo(a,b),x.stroke(),v=v.concat([a,b,256*c]),Va(v.join(" ")))})}},deactivate:function(){$(".activeBrush").removeClass("activeBrush");b();D.gracefullyResume();Q(A);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){k.currentMode.deactivate();k.currentMode=k.erase;T(A,function(a,b,c,f){},function(a,b,c,f){},function(a,b,c,f){})},deactivate:function(){Q(A)}}}}(R);
return R};
