(function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelRequestAnimationFrame=window[b[c]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var l=(new Date).getTime(),h=Math.max(0,16-(l-a)),e=window.setTimeout(function(){b(l+h)},h);a=l+h;return e});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(b){clearTimeout(b)})})();
var reapplyStylingToServerGeneratedContent=function(a){$("#"+a).find(".simpleMultipleButtonInteractableMessageButton a").addClass("button-transparent-border button")},bounceAnd=function(a){return function(b){a(b)}};function updateStatus(a){$("#status").text(a)}var noActiveBackstage="none",flash=function(a){a.fadeOut(100).fadeIn(100)};function updateActiveMenu(a){$(".activeBackstageTab").removeClass("activeBackstageTab active");$(a).addClass("activeBackstageTab active")}
var WorkQueue=function(){var a=!0,b=[],c=!1,g=function(){var a=b.pop();a?(c=c||a(),g()):c&&(blit(),c=!1)},f=void 0;return{pause:function(){f&&(window.clearTimeout(f),f=void 0);a=!1;Progress.call("afterWorkQueuePause")},gracefullyResume:function(){f&&(window.clearTimeout(f),f=void 0);f=setTimeout(function(){a=!0;g()},1E3);Progress.call("beforeWorkQueueResume")},enqueue:function(c){a?c()&&blit():b.push(function(){return c()})}}}(),Pan={pan:function(a,b){takeControlOfViewbox();TweenController.panViewboxRelative(viewboxWidth/
boardWidth*a,viewboxHeight/boardHeight*b)},translate:function(a,b){takeControlOfViewbox();var c=viewboxWidth/boardWidth,g=viewboxHeight/boardHeight;console.log("Translate",a,b,c,g);TweenController.translateViewboxRelative(a*c,b*g)}},Zoom=function(){var a=function(b){var a=3*boardContent.width,g=3*boardContent.height,f=.1*boardWidth,l=.1*boardHeight,h=void 0,e=void 0,d=void 0,x=void 0;"width"in b&&(h=b.width,h>a&&(h=a),h<f&&(h=f));"height"in b&&(e=b.height,e>g&&(e=g),e<l&&(e=l));"x"in b&&(d=b.x,h!=
b.width&&(d+=(b.width-h)/2));"y"in b&&e&&(x=b.y,e!=b.height&&(x+=(b.height-e)/2));return{width:h,height:e,x:d,y:x}};return{scale:function(b,c){takeControlOfViewbox();var g=viewboxWidth*b,f=viewboxHeight*b;c||(f=a({height:f,width:g}),g=f.width,f=f.height);TweenController.scaleAndTranslateViewbox((viewboxWidth-g)/2+viewboxX,(viewboxHeight-f)/2+viewboxY,g,f)},zoom:function(b,c,g){takeControlOfViewbox();var f=viewboxWidth*b;b*=viewboxHeight;c||(c=a({height:b,width:f}),f=c.width,b=c.height);f-=viewboxWidth;
c=b-viewboxHeight;TweenController.zoomAndPanViewboxRelative(f/2*-1,c/2*-1,f,c,g)},out:function(){Zoom.zoom(1.2)},"in":function(){Zoom.zoom(1/1.2)},constrainRequestedViewbox:a}}(),TweenController=function(){var a=function(d,a,v,k,n,e){isNaN(d)||isNaN(a)||isNaN(v)||isNaN(k)?n&&n():(c&&c.stop(),c=!1,g=viewboxX=d,f=viewboxY=a,l=viewboxWidth=v,h=viewboxHeight=k,e||(requestedViewboxX=viewboxX,requestedViewboxY=viewboxY,requestedViewboxWidth=viewboxWidth,requestedViewboxHeight=viewboxHeight),n&&n(),blit(),
b(d,a,v,k),Progress.call("onViewboxChanged"))},b=_.throttle(function(d,a,b,k){Conversations.isAuthor()&&UserSettings.getIsInteractive()&&(d=[d,a,b,k,Date.now(),Conversations.getCurrentSlideJid(),"autoZooming"in Progress.onBoardContentChanged],0>=b||0>=k||_.some(d,function(d){return"undefined"==typeof d||isNaN(d)})||sendStanza({author:UserSettings.getUsername(),timestamp:Date.now(),type:"command",command:"/TEACHER_VIEW_MOVED",parameters:d.map(function(d){return d.toString()})}))},300),c,g,f,l,h,e=
function(d,a,v,k,n,e,A){if(isNaN(d)||isNaN(a)||isNaN(v)||isNaN(k))n&&n();else{var r=viewboxX,t=viewboxY,m=viewboxWidth,u=viewboxHeight;g=r;f=t;l=m;h=u;var p=d-r,w=a-t,q=v-m,y=k-u;c&&(c.stop(),c=!1);c=(new TWEEN.Tween({x:0,y:0,w:0,h:0})).to({x:p,y:w,w:q,h:y},300).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){g=r+this.x;f=t+this.y;l=m+this.w;h=u+this.h}).onComplete(function(){c=!1;g=viewboxX=d;f=viewboxY=a;l=viewboxWidth=v;h=viewboxHeight=k;blit();e||(requestedViewboxX=viewboxX,requestedViewboxY=
viewboxY,requestedViewboxWidth=viewboxWidth,requestedViewboxHeight=viewboxHeight);n&&n();Progress.call("onViewboxChanged");Progress.call("textBoundsChanged")}).start();var z=function(d){c&&(TWEEN.update(),blit(),requestAnimationFrame(z))};requestAnimationFrame(z);"Conversations"in window&&Conversations.isAuthor()&&!A&&!e&&void 0!=d&&void 0!=a&&0<v&&0<k&&(0!=p||0!=w||0!=q||0!=y)&&b(d,a,v,k)}};return{panViewbox:function(d,a,b,k){return e(d,a,viewboxWidth,viewboxHeight,b,k)},translateViewbox:function(d,
b,c,k){return a(d,b,viewboxWidth,viewboxHeight,c,k)},zoomAndPanViewbox:function(d,a,b,k,c,f,g){return e(d,a,b,k,c,f,g)},scaleAndTranslateViewbox:function(d,b,c,k,f,e){return a(d,b,c,k,f,e)},panViewboxRelative:function(d,a,b,c){return e(d+viewboxX,a+viewboxY,viewboxWidth,viewboxHeight,b,c)},translateViewboxRelative:function(d,b,c,k){return a(d+viewboxX,b+viewboxY,viewboxWidth,viewboxHeight,c,k)},zoomAndPanViewboxRelative:function(d,a,b,c,f,g){return e(d+viewboxX,a+viewboxY,b+viewboxWidth,c+viewboxHeight,
f,g)},scaleAndTranslateViewboxRelative:function(d,b,c,k,f,e){return a(d+viewboxX,b+viewboxY,c+viewboxWidth,k+viewboxHeight,f,e)},immediateView:function(){return[g,f,l,h]}}}(),Extend=function(){return{up:function(){TweenController.panViewboxRelative(0,-Math.floor(.6*viewboxHeight))},down:function(){TweenController.panViewboxRelative(0,Math.floor(.6*viewboxHeight))},left:function(){TweenController.panViewboxRelative(-Math.floor(.6*viewboxWidth),0)},right:function(){TweenController.panViewboxRelative(Math.floor(.6*
viewboxWidth),0)},shift:TweenController.panViewboxRelative,center:function(a,b,c){TweenController.panViewboxRelative(a-viewboxWidth/2-viewboxX,b-viewboxHeight/2-viewboxY,c)}}}(),subcategoryMapping={metaToolbar:".metaConversationGroup",roomToolbar:".inConversationGroup",optsToolbar:".applicationGroup"},categoryMapping=_.fromPairs(_.flatMap({metaToolbar:"integrations print recycleBin help",optsToolbar:"settings healthCheck",roomToolbar:"grades blacklist submissions attachments participants groups quizzes contentFilter"},
function(a,b){return _.map(a.split(" "),function(a){return[a,b]})})),active="activeBackstageTab active";
function showBackstage(a){$("html").css("overflow-y","auto");$("#masterFooter").hide();window.currentBackstage=a;$(".backstage").hide();"HealthCheckViewer"in window&&HealthCheckViewer.pause();$(".backstageTabHeaderGroup").hide();$(".backstageTabHeader").removeClass(active);$(".backstageCategory").removeClass("active");$(".backstageCategory").removeClass(active);$(".modeSpecificTool").removeClass(active);$(".backstage").removeClass(active);var b=$("#"+a+"Popup"),c=categoryMapping[a];$(subcategoryMapping[c]).show();
$("#backstageContainer").css("overflow-y","scroll").show();$("#hideBackstage").show();b.show();$("#applicationMenuPopup").addClass("active");$("#applicationMenuButton").addClass(active);$(".modeSpecificTool."+a).addClass(active);$("#"+c).addClass("active");$(".backstage-menu").addClass("active");$("#"+a).addClass(active);Conversations.inConversation()?($("#backstageTabHeaders").show(),$("#applicationMenuButton").show(),$("#roomToolbar").show()):($("#backstageTabHeaders").hide(),$("#applicationMenuButton").hide(),
$("#roomToolbar").hide());$(".dedicatedClose").click(hideBackstage);$("#masterLayout").css({opacity:Conversations.getCurrentConversationJid()?.3:0});Progress.call("onBackstageShow",[a])}
function hideBackstage(){$("html").css("overflow-y","hidden");$("#masterFooter").show();window.currentBackstage=noActiveBackstage;$(".backstage-menu").removeClass("active");$(".backstage").hide();$(".backstageTabHeader").removeClass(active);$(".backstage").removeClass(active);$("#applicationMenuButton").removeClass(active);$("#applicationMenuPopup").removeClass("active");$("#backstageTabHeaders").hide();$("#backstageContainer").hide();$("#hideBackstage").hide();$("#notices").show();$(".modeSpecificTool").removeClass(active);
hideSpinner();$("#masterLayout").css({opacity:1});"HealthCheckViewer"in window&&HealthCheckViewer.pause();Progress.call("onBackstageHide")}function showSpinner(){$("#loadingSlidePopup").show()}function hideSpinner(){$("#loadingSlidePopup").hide()}function toggleSubOptions(a){return function(){$(a).find(".backstageTabHeader").eq(0).click()}}
$(function(){var a=$("#heading"),b=progress().max(8);b.element.prependTo($("#progress"));b.value(0);a.text(sprintf("Logged in as %s",UserSettings.getUsername()));setupStatus();board=$("#board");boardContext=board[0].getContext("2d");a.text("Set up board");b.value(1);$("input.toolbar").addClass("commandModeInactive").addClass(commandMode?"commandModeActive":"commandModeInactive");$("#slideContainer button").addClass("commandModeInactive").addClass(commandMode?"commandModeActive":"commandModeInactive");
$("#up").click(bounceAnd(Extend.up));$("#down").click(bounceAnd(Extend.down));$("#left").click(bounceAnd(Extend.left));$("#right").click(bounceAnd(Extend.right));$("#in").click(bounceAnd(function(){Zoom["in"]()}));$("#out").click(bounceAnd(function(){Zoom.out()}));$("#drawMode").click(function(){Modes.currentMode!=Modes.draw&&Modes.draw.activate()});$("#selectMode").click(function(){Modes.currentMode!=Modes.select&&Modes.select.activate()});$("#insertText").click(function(){Modes.currentMode!=Modes.text&&
Modes.text.activate()});$("#panMode").click(function(){Modes.currentMode!=Modes.pan&&Modes.pan.activate()});$("#insertMode").click(function(){Modes.currentMode!=Modes.image&&(Modes.currentMode.deactivate(),Modes.image.activate())});$("#imageMode").click(function(){Modes.currentMode!=Modes.image&&Modes.image.activate()});$("#videoMode").click(function(){Modes.currentMode!=Modes.video&&Modes.video.activate()});$("#zoomMode").click(function(){Modes.currentMode!=Modes.zoom&&Modes.zoom.activate()});$("#feedbackMode").click(function(){Modes.currentMode!=
Modes.feedback&&Modes.feedback.activate()});$("#implicitlyExpanding").click(function(){implicitlyExpanding=$(this).is(":checked")});implicitlyExpanding&&$("#implicitlyExpanding").attr("checked",implicitlyExpanding);$("#showGrid").click(function(){showGrid=$(this).is(":checked");blit()});showGrid&&$("#showGrid").attr("checked",showGrid);b.value(2);$("#zoomToFull").click(bounceAnd(function(){zoomToFit()}));$("#zoomToPage").click(bounceAnd(function(){zoomToPage()}));$("#zoomToOriginal").click(bounceAnd(function(){zoomToOriginal()}));
window.currentBackstage=noActiveBackstage;$("#hideBackstage").click(bounceAnd(hideBackstage));$("#applicationMenuButton").click(function(){window.currentBackstage!=noActiveBackstage?hideBackstage():(showBackstage("integrations"),updateActiveMenu($("#menuIntegrations")))});loadSlidesAtNativeZoom="true"==UserSettings.getUserPref("loadSlidesAtNativeZoom");a=$("#loadSlidesAtNativeZoom");loadSlidesAtNativeZoom&&a.attr("checked",!0);a.click(bounceAnd(function(){loadSlidesAtNativeZoom=$(this).is(":checked");
UserSettings.setUserPref("loadSlidesAtNativeZoom",loadSlidesAtNativeZoom);receiveHistory(boardContent)}));a=function(a,b){var c=$("<div />");$("<div />",{text:sprintf("Choose your preferred %s",a)}).appendTo(c);b.map(function(b){return $("<div />").text(sprintf("%s px",b)).addClass("preferenceChoice").css({width:px(b),height:px(b)}).click(bounceAnd(function(){console.log("Setting user pref",a,b);UserSettings.setUserPref(a,b);var c=Modes.currentMode;Modes.none.activate();c.activate();Progress.call("onLayoutUpdated")})).appendTo(c)});
return c};$("#preferencesContainerRight").append(a("subModeSize",[30,60])).append(a("thumbnailSize",[60,100,200]));$("#preferences").click(function(){showBackstage("preferences");$("#toggleHighQualityInk");$("#toggleHighQualityInk").attr("disabled","disabled")});$("input[name=renderQuality]").change(function(){var a=$("input[name=renderQuality]:checked").val();pressureSimilarityThreshold=parseInt(a);blit()});b.value(3);$("#submissionsButton").on("click",function(){showBackstage("submissions");Submissions.reRender();
updateActiveMenu($("#menuSubmissions"))});$("#gradesButton").on("click",function(){showBackstage("grades");Grades.reRender();updateActiveMenu($("#menuGrades"))});$("#quizzesButton").on("click",function(){showBackstage("quizzes");Quizzes.reRender();updateActiveMenu($("#menuPolls"))});$("#submitScreenshotButton").on("click",function(){"Submissions"in window&&Submissions.sendSubmission()});"Conversations"in window&&($("#enableSync").on("click",Conversations.enableSyncMove),$("#disableSync").on("click",
Conversations.disableSyncMove));_.each(subcategoryMapping,function(a,b){$("#"+b).click(toggleSubOptions(a))});b.value(7);Progress.stanzaReceived.boardOnLoad=actOnReceivedStanza;Modes.select.activate();$("#progress").hide();b.value(8);$("#updatePens").click(function(){showBackstage("customizeBrush");updateActiveMenu(this)});var c=!0,g=!0,f=!0;$("#menuPrint").click(function(){showBackstage("print");updateActiveMenu(this);var a=Conversations.getCurrentConversationJid(),b=$("#rangeAll"),e=$("#rangeSpecified"),
k=$("#rangeThisSlide"),n=$("#rangeSpecifiedInput"),h=$("#printButton"),l=$("#printPrivateNotes"),r=$("#printPageCount"),t=$("#printConversationTitle"),m=Conversations.getCurrentSlide().index+1,u=function(){_.forEach([e,b,k],function(a){a.prop("checked",!1)});n.prop("disabled",!0)};l.prop("checked",c);t.prop("checked",g);r.prop("checked",f);u();k.prop("checked",!0);n.val(m);var p=function(){h.attr("target","blank").attr("href",sprintf("clientSidePrintConversation?conversationJid=%s&pageRange=%s&includePrivateContent=%s&includeConversationTitle=%s&includePageCount=%s",
a,m,c,g,f))};p();b.unbind("click");b.on("click",function(){u();$(this).prop("checked",!0);m="all";p()});e.unbind("click");e.on("click",function(){u();$(this).prop("checked",!0);n.prop("disabled",!1);m=n.val();p()});n.unbind("change");n.on("change",function(){m=$(this).val();p()});k.unbind("click");k.on("click",function(){u();$(this).prop("checked",!0);m=Conversations.getCurrentSlide().index+1;p()});l.unbind("change");l.on("change",function(){c=$(this).prop("checked");p()});t.unbind("change");t.on("change",
function(){g=$(this).prop("checked");p()});r.unbind("change");r.on("change",function(){f=$(this).prop("checked");p()})});$("#menuGroups").click(function(){showBackstage("groups");updateActiveMenu(this)});$("#menuGrades").click(function(){showBackstage("grades");updateActiveMenu(this);Grades.reRender()});$("#menuSubmissions").click(function(){showBackstage("submissions");updateActiveMenu(this);Submissions.reRender()});$("#menuPolls").click(function(){showBackstage("quizzes");updateActiveMenu(this);
Quizzes.reRender()});$("#menuBlacklist").click(function(){showBackstage("blacklist");updateActiveMenu(this);Blacklist.reRender()});$("#menuSettings").click(function(){showBackstage("settings");updateActiveMenu(this)});$("#menuIntegrations").click(function(){showBackstage("integrations");updateActiveMenu(this)});$("#menuHelp").click(function(){showBackstage("help");updateActiveMenu(this)});$("#menuHealthCheck").click(function(){showBackstage("healthCheck");updateActiveMenu(this);"HealthCheckViewer"in
window&&HealthCheckViewer.resume()});$("#conversations").click(function(){window.location.href="/conversationSearch"});var l=$("#pasteDialogTemplate").clone();$("#pasteDialogTemplate").remove();var h=function(a){var b="dataTransfer"in a?a.dataTransfer:a.clipboardData;if("types"in b){var c=a.offsetX||10,f=a.offsetY||10,e=_.filter(b.types,function(b){return b.toLowerCase().startsWith("text")||b.toLowerCase().startsWith("image")||b.toLowerCase().startsWith("file")}),g=_.toArray(b.items),h=_.toArray(b.files),
r={items:g,files:h,types:e};console.log("newDf",r);var t=_.map(e,function(a){return{key:a,value:b.getData(a)}}),m=function(a,c,d){a=_.find(a,c);void 0!=a&&null!=a&&d(a,b.getData(a))};console.log("availableTypes:",e,g,h);if(1<_.size(e)){var g=sprintf("pasteEventHandler_%s",_.uniqueId()),h=l.clone().attr("id",g),m=h.find(".dialogOptions"),u=m.find(".dialogOption").clone();m.empty();var p=$.jAlert({title:"Data to paste",content:h[0].outerHTML,closeOnClick:!0,closeOnEsc:!0,blurBackground:!0}),w=[{key:function(a){return"text/html"==
a},name:"rich text and images",faClass:"fa-file-code-o",onClick:function(a){var b=_.find(t,function(b){return b.key==a}).value,d=$(b),e=0,b=_.join(_.map(d,function(a){return a.outerHTML}),"");_.forEach(d.find("img"),function(a){try{Modes.image.handleDroppedSrc(a.src,c,f+e),e+=Math.max(a.height,50)}catch(b){errorAlert("Error dropping image","The source server you're draggin the image from does not want to allow dragging the image directly.  You may need to download the image first and then upload it.  "+
b)}});1<d.text().trim().length&&Modes.text.handleDrop(b,c,f+e)}},{key:function(a){return"text/plain"==a},name:"plain text",faClass:"fa-file-text-o",onClick:function(a){var b=_.find(t,function(b){return b.key==a}).value;Modes.text.handleDrop(b,c,f)}},{key:function(a){return"Files"==a},name:"files or images",faClass:"fa-file-o",onClick:function(a){Modes.image.handleDrop(r,c,f)}},{key:function(a){return 0==a.indexOf("image/")},name:"images",faClass:"fa-file-image-o",onClick:function(a){Modes.image.handleDrop(r,
c,f)}}];$("#"+g).find(".dialogOptions").html(_.map(_.filter(e,function(a){return _.some(w,function(b){return b.key(a)})}),function(a){var b=_.find(w,function(b){return b.key(a)}),c=u.clone(),d=c.find("button");d.addClass(b.faClass);d.on("click",function(){b.onClick(a);p.closeAlert()});d.find(".icon-txt").text(b.name);return c}))}else{var q=!1;m(e,function(a){return"Files"==a},function(a,d){q||(Modes.image.handleDrop(b,c,f),q=!0)});m(e,function(a){return 0==a.indexOf("image")},function(a,d){q||(Modes.image.handleDrop(b,
c,f),q=!0)});m(e,function(a){return"text/html"==a},function(a,b){if(!q){var d=$(b),e=0;b=_.join(_.map(d,function(a){return a.outerHTML}),"");_.forEach(d.find("img"),function(a){try{Modes.image.handleDroppedSrc(a.src,c,f+e),e+=Math.max(a.height,50)}catch(b){errorAlert("Error dropping image","The source server you're draggin the image from does not want to allow dragging the image directly.  You may need to download the image first and then upload it.  "+b)}});1<d.text().trim().length&&Modes.text.handleDrop(b,
c,f+e);q=!0}});m(e,function(a){return 0==a.indexOf("text")},function(a,b){q||(Modes.text.handleDrop(b,c,f),q=!0)});q||console.log("unknown type",b)}a.preventDefault();return!1}return!0};window.addEventListener("paste",function(a){return"originalEvent"in a?h(a.originalEvent):h(a)});$("#board").on("drop",function(a){return"originalEvent"in a?h(a.originalEvent):!1});(new Clipboard(".deeplink",{text:function(a){return $(a.nextElementSibling).find("a")[0].href}})).on("success",function(a){console.log(a);
alert("Link copied to clipboard")}).on("error",function(a){console.error("Action:",a.action);console.error("Trigger:",a.trigger)});var e=function(a){a.preventDefault();return!1};$(document).on("drop",e);window.onbeforepaste=e;_.forEach(["dragover","dragleave","dragenter"],function(a){window["on"+a]=e;$(window).on(a,e);$("#board")[0]["on"+a]=e;$("#board").on(a,e)})});
