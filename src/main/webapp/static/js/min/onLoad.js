(function(){for(var a=0,b=["ms","moz","webkit","o"],d=0;d<b.length&&!window.requestAnimationFrame;++d)window.requestAnimationFrame=window[b[d]+"RequestAnimationFrame"],window.cancelRequestAnimationFrame=window[b[d]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b,c){var l=(new Date).getTime(),f=Math.max(0,16-(l-a)),d=window.setTimeout(function(){b(l+f)},f);a=l+f;return d});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(b){clearTimeout(b)})})();
var reapplyStylingToServerGeneratedContent=function(a){$("#"+a).find(".simpleMultipleButtonInteractableMessageButton a").addClass("button-transparent-border button")},bounceAnd=function(a){return function(b){bounceButton(this);a(b)}};function updateStatus(a){$("#status").text(a)}function serverResponse(){}var noActiveBackstage="none",flash=function(a){a.fadeOut(100).fadeIn(100)};
function updateActiveMenu(a){$(".activeBackstageTab").removeClass("activeBackstageTab active");$(a).addClass("activeBackstageTab active")}
var WorkQueue=function(){var a=!0,b=[],d=!1,h=function(){var c=b.pop();c?(d=d||c(),h()):(d&&(blit(),d=!1),"Conversations"in window&&Conversations.updateThumbnail(Conversations.getCurrentSlideJid()))},c=void 0;return{pause:function(){c&&(window.clearTimeout(c),c=void 0);a=!1},gracefullyResume:function(){c&&(window.clearTimeout(c),c=void 0);c=setTimeout(function(){a=!0;h()},1E3)},enqueue:function(c){a?c()&&blit():b.push(function(){return c()})}}}(),Pan={pan:function(a,b){TweenController.panViewboxRelative(viewboxWidth/
boardWidth*a,viewboxHeight/boardHeight*b)},translate:function(a,b){TweenController.translateViewboxRelative(viewboxWidth/boardWidth*a,viewboxHeight/boardHeight*b)}},Zoom=function(){var a=function(b){var d=3*boardContent.width,a=3*boardContent.height,c=.1*boardWidth,l=.1*boardHeight,f=void 0,e=void 0,g=void 0,k=void 0;"width"in b&&(f=b.width,f>d&&(f=d),f<c&&(f=c));"height"in b&&(e=b.height,e>a&&(e=a),e<l&&(e=l));"x"in b&&(g=b.x,f!=b.width&&(g+=(b.width-f)/2));"y"in b&&e&&(k=b.y,e!=b.height&&(k+=(b.height-
e)/2));return{width:f,height:e,x:g,y:k}};return{scale:function(b,d){var h=viewboxWidth*b,c=viewboxHeight*b;d||(c=a({height:c,width:h}),h=c.width,c=c.height);TweenController.scaleAndTranslateViewbox((viewboxWidth-h)/2+viewboxX,(viewboxHeight-c)/2+viewboxY,h,c)},zoom:function(b,d,h){var c=viewboxWidth*b;b*=viewboxHeight;d||(d=a({height:b,width:c}),c=d.width,b=d.height);c-=viewboxWidth;d=b-viewboxHeight;TweenController.zoomAndPanViewboxRelative(c/2*-1,d/2*-1,c,d,h)},out:function(){Zoom.zoom(1.2)},"in":function(){Zoom.zoom(1/
1.2)},constrainRequestedViewbox:a}}(),TweenController=function(){var a=function(c,a,f,e,g,k){isNaN(c)||isNaN(a)||isNaN(f)||isNaN(e)?g&&g():(d&&d.stop(),d=!1,viewboxX=c,viewboxY=a,viewboxWidth=f,viewboxHeight=e,k||(requestedViewboxX=viewboxX,requestedViewboxY=viewboxY,requestedViewboxWidth=viewboxWidth,requestedViewboxHeight=viewboxHeight),clearBoard(),render(boardContent),g&&g(),b(c,a,f,e),Progress.call("onViewboxChanged"))},b=_.throttle(function(c,b,a,d){Conversations.isAuthor()&&UserSettings.getIsInteractive()&&
(c=[c,b,a,d,Date.now(),Conversations.getCurrentSlideJid()],0!=a&&0!=d&&(_.some(c,function(c){return"undefined"==typeof c||isNaN(c)})||sendStanza({author:UserSettings.getUsername(),timestamp:Date.now(),type:"command",command:"/TEACHER_VIEW_MOVED",parameters:c.map(function(c){return c.toString()})})))},300),d,h=function(c,a,f,e,g,k,h){if(isNaN(c)||isNaN(a)||isNaN(f)||isNaN(e))g&&g();else{var m=viewboxX,n=viewboxY,p=viewboxWidth,q=viewboxHeight,r=c-m,t=a-n,u=f-p,v=e-q;d&&(d.stop(),d=!1);d=(new TWEEN.Tween({x:0,
y:0,w:0,h:0})).to({x:r,y:t,w:u,h:v},300).easing(TWEEN.Easing.Quadratic.Out).onUpdate(function(){viewboxX=m+this.x;viewboxY=n+this.y;viewboxWidth=p+this.w;viewboxHeight=q+this.h}).onComplete(function(){d=!1;k||(requestedViewboxX=viewboxX,requestedViewboxY=viewboxY,requestedViewboxWidth=viewboxWidth,requestedViewboxHeight=viewboxHeight);g&&g();Progress.call("onViewboxChanged")}).start();var w=function(c){d&&(requestAnimationFrame(w),TWEEN.update(),clearBoard(),render(boardContent))};requestAnimationFrame(w);
"Conversations"in window&&Conversations.isAuthor()&&!h&&!k&&void 0!=c&&void 0!=a&&0<f&&0<e&&(0!=r||0!=t||0!=u||0!=v)&&b(c,a,f,e)}};return{panViewbox:function(c,a,b,d){return h(c,a,viewboxWidth,viewboxHeight,b,d)},translateViewbox:function(c,b,d,e){return a(c,b,viewboxWidth,viewboxHeight,d,e)},zoomAndPanViewbox:function(c,a,b,d,g,k,x){return h(c,a,b,d,g,k,x)},scaleAndTranslateViewbox:function(c,b,d,e,g,h){return a(c,b,d,e,g,h)},panViewboxRelative:function(c,a,b,d){return h(c+viewboxX,a+viewboxY,viewboxWidth,
viewboxHeight,b,d)},translateViewboxRelative:function(c,b,d,e){return a(c+viewboxX,b+viewboxY,viewboxWidth,viewboxHeight,d,e)},zoomAndPanViewboxRelative:function(c,b,a,d,g,k){return h(c+viewboxX,b+viewboxY,a+viewboxWidth,d+viewboxHeight,g,k)},scaleAndTranslateViewboxRelative:function(c,b,d,e,g,h){return a(c+viewboxX,b+viewboxY,d+viewboxWidth,e+viewboxHeight,g,h)}}}(),Extend=function(){return{up:function(){TweenController.panViewboxRelative(0,-Math.floor(.6*viewboxHeight))},down:function(){TweenController.panViewboxRelative(0,
Math.floor(.6*viewboxHeight))},left:function(){TweenController.panViewboxRelative(-Math.floor(.6*viewboxWidth),0)},right:function(){TweenController.panViewboxRelative(Math.floor(.6*viewboxWidth),0)},shift:TweenController.panViewboxRelative,center:function(a,b,d){TweenController.panViewboxRelative(a-viewboxWidth/2-viewboxX,b-viewboxHeight/2-viewboxY,d)}}}(),active="activeBackstageTab active";
function showBackstage(a){$(".backstage-menu").addClass("active");$(".backstage").hide();$(".backstageTabHeader").removeClass(active);$(".backstage").removeClass(active);var b=$("#"+a+"Popup");window.currentBackstage=a;b.show();$(".modeSpecificTool").removeClass(active);$("#"+a).addClass(active);$(".modeSpecificTool."+a).addClass(active);$("#backstageContainer").show();$("#applicationMenuPopup").addClass("active");Conversations.inConversation()?($("#backstageTabHeaders").show(),$("#applicationMenuButton").show()):
($("#backstageTabHeaders").hide(),$("#applicationMenuButton").hide());$("#applicationMenuButton").addClass(active);$("#hideBackstage").show();$(".dedicatedClose").click(hideBackstage);$("#masterLayout").css({opacity:Conversations.getCurrentConversationJid()?.3:0})}
function hideBackstage(){window.currentBackstage=noActiveBackstage;$(".backstage-menu").removeClass("active");$(".backstage").hide();$(".backstageTabHeader").removeClass(active);$(".backstage").removeClass(active);$("#applicationMenuButton").removeClass(active);$("#applicationMenuPopup").removeClass("active");$("#backstageTabHeaders").hide();$("#backstageContainer").hide();$("#hideBackstage").hide();$("#notices").show();$(".modeSpecificTool").removeClass(active);hideSpinner();$("#masterLayout").css({opacity:1})}
function showSpinner(){$("#loadingSlidePopup").show()}function hideSpinner(){$("#loadingSlidePopup").hide()}
$(function(){var a=$("#heading");a.text("Loading MeTLX...");var b=progress().max(8);b.element.prependTo($("#progress"));b.value(0);a.text(sprintf("Logged in as %s",UserSettings.getUsername()));setupStatus();board=$("#board");boardContext=board[0].getContext("2d");a.text("Set up board");b.value(1);$("input.toolbar").addClass("commandModeInactive").addClass(commandMode?"commandModeActive":"commandModeInactive");$("#slideContainer button").addClass("commandModeInactive").addClass(commandMode?"commandModeActive":
"commandModeInactive");$("#up").click(bounceAnd(Extend.up));$("#down").click(bounceAnd(Extend.down));$("#left").click(bounceAnd(Extend.left));$("#right").click(bounceAnd(Extend.right));$("#in").click(bounceAnd(Zoom["in"]));$("#out").click(bounceAnd(Zoom.out));$("#drawMode").click(function(){Modes.currentMode!=Modes.draw&&Modes.draw.activate()});$("#selectMode").click(function(){Modes.currentMode!=Modes.select&&Modes.select.activate()});$("#insertText").click(function(){Modes.currentMode!=Modes.text&&
Modes.text.activate()});$("#panMode").click(function(){Modes.currentMode!=Modes.pan&&Modes.pan.activate()});$("#imageMode").click(function(){Modes.currentMode!=Modes.image&&Modes.image.activate()});$("#zoomMode").click(function(){Modes.currentMode!=Modes.zoom&&Modes.zoom.activate()});$("#feedbackMode").click(function(){Modes.currentMode!=Modes.feedback&&Modes.feedback.activate()});$("#implicitlyExpanding").click(function(){implicitlyExpanding=$(this).is(":checked")});implicitlyExpanding&&$("#implicitlyExpanding").attr("checked",
implicitlyExpanding);$("#showGrid").click(function(){showGrid=$(this).is(":checked");blit()});showGrid&&$("#showGrid").attr("checked",showGrid);b.value(2);$("#zoomToFull").click(bounceAnd(zoomToFit));$("#zoomToPage").click(bounceAnd(zoomToPage));$("#zoomToOriginal").click(bounceAnd(zoomToOriginal));window.currentBackstage=noActiveBackstage;$("#hideBackstage").click(bounceAnd(hideBackstage));$("#applicationMenuButton").click(function(){window.currentBackstage!=noActiveBackstage?hideBackstage():(showBackstage("settings"),
updateActiveMenu($("#menuSettings")))});loadSlidesAtNativeZoom="true"==UserSettings.getUserPref("loadSlidesAtNativeZoom");a=$("#loadSlidesAtNativeZoom");loadSlidesAtNativeZoom&&a.attr("checked",!0);a.click(bounceAnd(function(){loadSlidesAtNativeZoom=$(this).is(":checked");UserSettings.setUserPref("loadSlidesAtNativeZoom",loadSlidesAtNativeZoom);receiveHistory(boardContent)}));a=function(b,a){var c=$("<div />");$("<div />",{text:sprintf("Choose your preferred %s",b)}).appendTo(c);a.map(function(a){return $("<div />").text(sprintf("%s px",
a)).addClass("preferenceChoice").css({width:px(a),height:px(a)}).click(bounceAnd(function(){console.log("Setting user pref",b,a);UserSettings.setUserPref(b,a);var c=Modes.currentMode;Modes.none.activate();c.activate();Progress.call("onLayoutUpdated")})).appendTo(c)});return c};$("#preferencesContainerRight").append(a("subModeSize",[30,60])).append(a("thumbnailSize",[60,100,200]));$("#preferences").click(function(){showBackstage("preferences");$("#toggleHighQualityInk");$("#toggleHighQualityInk").attr("disabled",
"disabled")});$("input[name=renderQuality]").change(function(){var a=$("input[name=renderQuality]:checked").val();pressureSimilarityThreshold=parseInt(a);blit()});b.value(3);$("#submissionsButton").on("click",function(){showBackstage("submissions")});$("#quizzesButton").on("click",function(){showBackstage("quizzes")});$("#submitScreenshotButton").on("click",function(){var a=Conversations.getCurrentConversation(),b=Conversations.getCurrentSlideJid();"jid"in a&&submitScreenshotSubmission(a.jid.toString(),
b)});"Conversations"in window&&($("#enableSync").on("click",Conversations.enableSyncMove),$("#disableSync").on("click",Conversations.disableSyncMove));b.value(7);Progress.stanzaReceived.boardOnLoad=actOnReceivedStanza;Modes.draw.activate();$("#progress").hide();b.value(8);$("#updatePens").click(function(){showBackstage("customizeBrush");updateActiveMenu(this)});$("#menuPrint").click(function(){showBackstage("print");updateActiveMenu(this);var a=Conversations.getCurrentConversationJid(),b=$("#rangeAll"),
c=$("#rangeSpecified"),l=$("#rangeThisSlide"),f=$("#rangeSpecifiedInput"),e=$("#printButton"),g=function(){_.forEach([c,b,l],function(a){a.prop("checked",!1)});f.prop("disabled",!0)};g();l.prop("checked",!0);f.val(Conversations.getCurrentSlide().index+1);var k=function(b){e.attr("target","blank").attr("href",sprintf("clientSidePrintConversation?conversationJid=%s&pageRange=%s",a,b))};k(Conversations.getCurrentSlide().index+1);b.on("click",function(){g();$(this).prop("checked",!0);k("all")});c.on("click",
function(){g();$(this).prop("checked",!0);f.prop("disabled",!1);k(f.val())});f.on("change",function(){var a=$(this).val();k(a)});l.on("click",function(){g();$(this).prop("checked",!0);k(Conversations.getCurrentSlide().index+1)})});$("#menuSubmissions").click(function(){showBackstage("submissions");updateActiveMenu(this)});$("#menuPolls").click(function(){showBackstage("quizzes");updateActiveMenu(this)});$("#menuBlacklist").click(function(){showBackstage("blacklist");updateActiveMenu(this)});$("#menuSettings").click(function(){showBackstage("settings");
updateActiveMenu(this)});$("#menuIntegrations").click(function(){showBackstage("integrations");updateActiveMenu(this)})});
