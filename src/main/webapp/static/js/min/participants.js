var Participants=function(){var g={},l={},f={},k={inks:0,highlighters:0,texts:{},images:0,quizResponses:0,submissions:0,following:!0},m=function(b){return _.reduce(b.words,function(c,a,r){return c+a.text.length},0)},h=function(){g.jsGrid("loadData");var b=g.jsGrid("getSorting");"field"in b&&g.jsGrid("sort",b)},q=function(){showBackstage("participants");updateActiveMenu(this);h()},n=function(){Conversations.shouldModifyConversation()?($("#menuParticipants").click(q),$("#menuParticipants").show()):
($("#menuParticipants").unbind("click"),$("#menuParticipants").hide())},p=function(){n()};$(function(){n();g=$("#participantsDatagrid");l=g.find(".followControls").clone();g.empty();var b=function(c){jsGrid.Field.call(this,c)};b.prototype=new jsGrid.Field({sorter:function(c,a){return new Date(c)-new Date(a)},itemTemplate:function(c){return(new Date(c)).toLocaleString()},insertTemplate:function(c){return""},editTemplate:function(c){return""},insertValue:function(){return""},editValue:function(){return""}});
jsGrid.fields.dateField=b;g.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No participants",controller:{loadData:function(c){var a=_.map(_.keys(f),function(a){var c=f[a];return{name:a,following:c.following,attendances:_.size(c.attendances),images:c.images,inks:c.inks,texts:_.reduce(c.texts,function(a,c){return a+c},0),quizResponses:c.quizResponses,submissions:c.submissions,highlighters:c.highlighters}});"sortField"in c&&(a=_.sortBy(a,function(a){return a[c.sortField]}),
"sortOrder"in c&&"desc"==c.sortOrder&&(a=_.reverse(a)));return a}},pageLoading:!1,fields:[{name:"name",type:"text",title:"Follow",readOnly:!0,sorting:!0,itemTemplate:function(c,a){var b=l.clone(),d=sprintf("participant_%s",a.name);b.find(".followValue").attr("id",d).prop("checked",a.following).on("change",function(){f[a.name].following=$(this).is(":checked");blit();h()});b.find(".followLabel").attr("for",d).text(a.name);return b}},{name:"attendances",type:"number",title:"Attendances",readOnly:!0},
{name:"images",type:"number",title:"Images",readOnly:!0},{name:"inks",type:"number",title:"Inks",readOnly:!0},{name:"highlighters",type:"number",title:"Highlighters",readOnly:!0},{name:"texts",type:"number",title:"Texts",readOnly:!0},{name:"quizResponses",type:"number",title:"Poll responses",readOnly:!0},{name:"submissions",type:"number",title:"Submissions",readOnly:!0}]});g.jsGrid("sort",{field:"name",order:"desc"});h()});Progress.stanzaReceived.participants=function(b){if("type"in b&&"author"in
b){var c=b.author;if(!(c in f)){var a=_.clone(k);a.name=c;f[c]=a}a=f[c];switch(b.type){case "ink":a.inks+=1;break;case "image":a.images+=1;break;case "highlighter":a.highlighters+=1;break;case "multiWordText":a.texts[b.identity]=m(b);break;case "submission":a.submissions+=1;break;case "quizResponse":a.quizResponses+=1}f[c]=a}h()};Progress.historyReceived.participants=function(b){var c={},a=function(a){return c[a]||_.cloneDeep(k)};_.each(_.groupBy(b.attendances,"author"),function(b){var d=b[0].author,
e=a(k);e.name=d;e.attendances=b;c[d]=e});_.each(_.groupBy(b.inks,"author"),function(b,d){var e=a(d);e.inks+=_.size(b);c[d]=e});_.each(_.groupBy(b.highlighters,"author"),function(b,d){var e=a(d);e.highlighters+=_.size(b);c[d]=e});_.each(_.groupBy(b.images,"author"),function(b,d){var e=a(d);e.images+=_.size(b);c[d]=e});_.each(_.groupBy(b.multiWordTexts,"author"),function(b,d){a(d);_.each(b,function(a){var b=m(a);c[d].texts[a.identity]=b})});_.each(_.groupBy(b.quizResponses,"author"),function(b,d){var e=
a(d);e.quizResponses+=_.size(b);c[d]=e});f=c;h()};Progress.conversationDetailsReceived.participants=p;Progress.newConversationDetailsReceived.participants=p;return{getParticipants:function(){return Conversations.shouldModifyConversation()?f:{}},code:function(b){return _.keys(f).indexOf(b)}}}();
