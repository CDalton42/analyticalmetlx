var Participants=function(){var g={},p={},f={},m={inks:0,highlighters:0,texts:{},images:0,quizResponses:0,submissions:0,following:!0},q=function(b){return _.reduce(b.words,function(a,d,c){return a+d.text.length},0)},r=d3.scaleLinear().range([9,30]),n,v=function(b){n||(n=d3.select("#lang").style("margin-left","1em"));r.domain(d3.extent(_.map(b,"value")));b=n.selectAll(".word").data(b,function(a){return a.key});b.enter().append("div").attr("class","word").style("margin-right","1em").style("display",
"inline-block").style("vertical-align","middle").text(function(a){return a.key}).style("font-size",function(a){return r(a.value)+"px"}).merge(b).sort(function(a,d){return d3.ascending(d.value,a.value)});b.exit().remove()},k={keyboarding:!0,handwriting:!0,imageRecognition:!0,imageTranscription:!0},h=function(){g.jsGrid("loadData");var b=g.jsGrid("getSorting");"field"in b&&g.jsGrid("sort",b);Analytics.word.reset();var a={};_.each(boardContent.themes,function(d){_.each(d.text.split(" "),function(c){c=
c.toLowerCase();var l=d.origin;1==k[l]&&(Analytics.word.incorporate(c),c in a||(a[c]={}),l in a[c]||(a[c][l]=0),a[c][l]++)})});v(Analytics.word.cloudData())},x=function(){showBackstage("participants");updateActiveMenu(this);w();h()},t=function(){Conversations.shouldModifyConversation()?($("#menuParticipants").off().on("click",x),$("#menuParticipants").show()):($("#menuParticipants").unbind("click"),$("#menuParticipants").hide())},u=function(){t()},w=function(){_.each(k,function(b,a){var d=$(sprintf("#%s",
a));d.attr("checked",k[a]);d.off("click").on("click",function(){k[a]=!k[a];h()})})};$(function(){t();g=$("#participantsDatagrid");p=g.find(".followControls").clone();g.empty();var b=function(a){jsGrid.Field.call(this,a)};b.prototype=new jsGrid.Field({sorter:function(a,d){return new Date(a)-new Date(d)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});
jsGrid.fields.dateField=b;g.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No participants",controller:{loadData:function(a){var d=_.map(_.keys(f),function(a){var d=f[a];return{name:a,following:d.following,attendances:_.size(d.attendances),images:d.images,inks:d.inks,texts:_.reduce(d.texts,function(a,c){return a+c},0),quizResponses:d.quizResponses,submissions:d.submissions,highlighters:d.highlighters}});"sortField"in a&&(d=_.sortBy(d,function(c){return c[a.sortField]}),
"sortOrder"in a&&"desc"==a.sortOrder&&(d=_.reverse(d)));return d}},pageLoading:!1,fields:[{name:"name",type:"text",title:"Follow",readOnly:!0,sorting:!0,itemTemplate:function(a,d){var c=p.clone(),b=sprintf("participant_%s",d.name);c.find(".followValue").attr("id",b).prop("checked",d.following).on("change",function(){f[d.name].following=$(this).is(":checked");blit();h()});c.find(".followLabel").attr("for",b).text(d.name);return c}},{name:"attendances",type:"number",title:"Attendances",readOnly:!0},
{name:"images",type:"number",title:"Images",readOnly:!0},{name:"inks",type:"number",title:"Inks",readOnly:!0},{name:"highlighters",type:"number",title:"Highlighters",readOnly:!0},{name:"texts",type:"number",title:"Texts",readOnly:!0},{name:"quizResponses",type:"number",title:"Poll responses",readOnly:!0},{name:"submissions",type:"number",title:"Submissions",readOnly:!0}]});g.jsGrid("sort",{field:"name",order:"desc"});h()});Progress.stanzaReceived.participants=function(b){var a=!1;if("type"in b&&"author"in
b){var d=b.author;if(!(d in f)){var c=_.clone(m);c.name=d;f[d]=c}c=f[d];switch(b.type){case "ink":c.inks+=1;a=!0;break;case "image":c.images+=1;a=!0;break;case "highlighter":c.highlighters+=1;a=!0;break;case "multiWordText":c.texts[b.identity]=q(b);a=!0;break;case "submission":c.submissions+=1;a=!0;break;case "quizResponse":c.quizResponses+=1,a=!0}f[d]=c}a&&h()};Progress.themeReceived.participants=function(){"participants"==window.currentBackstage&&h()};Progress.historyReceived.participants=function(b){var a=
{};Analytics.word.reset();var d=function(c){return a[c]||_.cloneDeep(m)};_.each(_.groupBy(b.attendances,"author"),function(c){var b=c[0].author,e=d(m);e.name=b;e.attendances=c;a[b]=e});_.each(_.groupBy(b.inks,"author"),function(c,b){var e=d(b);e.inks+=_.size(c);a[b]=e});_.each(_.groupBy(b.highlighters,"author"),function(c,b){var e=d(b);e.highlighters+=_.size(c);a[b]=e});_.each(_.groupBy(b.images,"author"),function(c,b){var e=d(b);e.images+=_.size(c);a[b]=e});_.each(_.groupBy(b.multiWordTexts,"author"),
function(c,b){d(b);_.each(c,function(c){var d=q(c);a[b].texts[c.identity]=d})});_.each(_.groupBy(b.quizResponses,"author"),function(c,b){var e=d(b);e.quizResponses+=_.size(c);a[b]=e});f=a;h()};Progress.conversationDetailsReceived.participants=u;Progress.newConversationDetailsReceived.participants=u;return{getParticipants:function(){return Conversations.shouldModifyConversation()?f:{}},reRender:function(){h()},code:function(b){return _.keys(f).indexOf(b)}}}();
