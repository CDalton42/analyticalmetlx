var Blacklist=function(){var f={},t={},u={},k={},g={},v={},l=[],e=[],h={};$(function(){f=$("#blacklistListing");t=f.find(".blacklistSummary").clone();k=$("#currentBlacklist");u=k.find(".blacklistContainer").clone();g=$("#currentBlacklistAuthorList");v=g.find(".blacklistAuthorContainer").clone();f.empty();g.empty();p()});var m=function(a){return Conversations.shouldModifyConversation()},z=function(){g.empty();var a=$("#unbanAll");0<e.length?(a.show(),a.unbind("click"),a.on("click",function(){console.log("unbanall click");
changeBlacklistOfConversation(Conversations.getCurrentConversationJid(),[])})):(a.unbind("click"),a.hide());e.map(function(a){var d=v.clone();d.find(".blacklistAuthorName").text(a);d.find(".blacklistAuthorUnbanButton").on("click",function(){console.log(sprintf("unban %s click",a));e=_.filter(e,function(d){return d!=a});changeBlacklistOfConversation(Conversations.getCurrentConversationJid(),e)});g.append(d)})},p=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),$("#administerContent").show(),
$("#menuBlacklist").show()):($("#ban").hide(),$("#administerContent").hide(),$("#menuBlacklist").hide(),$("#blacklistPopup").hide())},w=function(a){p(a);l=[];h={}},y=function(){f.empty();_.filter(l,m).map(function(a){A(a)});k.html(x(h))},A=function(a){if("type"in a&&"submission"==a.type&&"target"in a&&"bannedcontent"==a.target){var b=t.clone();f.append(b);b.find(".blacklistDescription").text(sprintf("submitted by %s at %s %s",a.author,(new Date(a.timestamp)).toDateString(),(new Date(a.timestamp)).toLocaleTimeString()));
b.find(".blacklistImageThumb").attr("src",sprintf("/submissionProxy/%s/%s/%s",Conversations.getCurrentConversationJid(),a.author,a.identity));b.find(".viewBlacklistButton").attr("id",sprintf("viewBlacklistButton_%s",a.identity)).on("click",function(){h=a;k.html(x(h))})}},x=function(a){var b=$("<div />");if("type"in a&&"submission"==a.type&&"target"in a&&"bannedcontent"==a.target&&Conversations.shouldModifyConversation()){b=u.clone();b.attr("id",sprintf("blacklist_%s",a.identity));b.find(".blacklistDescription").text(sprintf("submitted by %s at %s",
a.author,a.timestamp));b.find(".blacklistImage").attr("src",sprintf("/submissionProxy/%s/%s/%s",Conversations.getCurrentConversationJid(),a.author,a.identity));var d=b.find(".blacklistAuthors"),e=d.find(".blacklistAuthor").clone();d.empty();"blacklist"in a&&_.each(a.blacklist,function(a){if("username"in a&&"highlight"in a){var b=e.clone();b.find(".blacklistAuthorName").text(a.username);var f=a.highlight[0];a=a.highlight[1];b.find(".blacklistAuthorColor").css({"background-color":f,opacity:a});d.append(b)}});
b.find(".displaySubmissionOnNextSlide").on("click",function(){addSubmissionSlideToConversationAtIndex(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlide().index+1,a.identity)})}return b},n=function(a,b){try{"target"in a&&"bannedcontent"==a.target&&m(a)&&(l.push(a),b||y())}catch(d){console.log("Blacklists.stanzaReceivedFunction",d)}};Progress.conversationDetailsReceived.blacklist=function(a){"blacklist"in a&&"jid"in a&&Conversations.getCurrentConversationJid()==a.jid&&(e=a.blacklist,
z(),p(a))};Progress.onConversationJoin.blacklist=w;Progress.historyReceived.blacklist=function(a){try{"type"in a&&"history"==a.type&&(w(),_.forEach(a.submissions,function(a){n(a,!0)}),y())}catch(b){console.log("Blacklists.historyReceivedFunction",b)}};Progress.stanzaReceived.blacklist=n;return{getAllBlacklists:function(){return Conversations.shouldModifyConversation()?_.filter(l,m):[]},getCurrentBlacklist:function(){return Conversations.shouldModifyConversation()?h:{}},processBlacklist:n,getBlacklistedAuthors:function(){return Conversations.shouldModifyConversation()?
e:[]},banSelection:function(a,b,d,e,f,g){WorkQueue.pause();var h=_.uniq(_.map(_.flatMap([d,e,f,g],_.values),"author"));a=Conversations.getCurrentConversation();changeBlacklistOfConversation(a.jid.toString(),_.uniq(_.flatten([a.blacklist,h])));a=$("<canvas />");b=board[0].width;var q=board[0].height;a.width=b;a.height=q;a.attr("width",b);a.attr("height",q);a.css({width:b,height:q});var c=a[0].getContext("2d");c.fillStyle="white";c.fillRect(0,0,b,q);c.drawImage(board[0],0,0,b,q);var r=_.map(h,function(a){return{username:a,
highlight:["#808080",128]}});_.forEach(_.values(d),function(a){var b=_.cloneDeep(a);b.thickness*=3;b.color=_.find(r,{username:a.author}).highlight;b.isHighlighter=!0;b.identity+="_banning";prerenderInk(b);drawInk(b,c)});_.forEach(g,function(a){var b=screenBounds(a.bounds);1<=b.screenHeight&&1<=b.screenWidth&&(c.strokeStyle=_.find(r,{username:a.author}).highlight,a=b.screenPos,c.lineWidth=4,c.rect(a.x-2,a.y-2,b.screenWidth+4,b.screenHeight+4),c.stroke())});_.forEach(f,function(a){var b=screenBounds(a.bounds);
1<=b.screenHeight&&1<=b.screenWidth&&(c.strokeStyle=_.find(r,{username:a.author}).highlight,a=b.screenPos,c.lineWidth=4,c.rect(a.x-2,a.y-2,b.screenWidth+4,b.screenHeight+4),c.stroke())});_.forEach(e,function(a){var b=screenBounds(a.bounds);1<=b.screenHeight&&1<=b.screenWidth&&(c.strokeStyle=_.find(r,{username:a.author}).highlight,a=b.screenPos,c.lineWidth=4,c.rect(a.x-2,a.y-2,b.screenWidth+4,b.screenHeight+4),c.stroke())});a=a[0].toDataURL("image/jpeg",.4);var k=(new Date).getTime(),l=UserSettings.getUsername(),
p=Conversations.getCurrentSlide().id;b=Conversations.getCurrentConversation().jid;var m=sprintf("submission%s%s.jpg",l,k.toString()),n=sprintf("%s:%s:%s",b,m,k);b=sprintf("/uploadDataUri?jid=%s&filename=%s",b.toString(),encodeURI(n));$.ajax({url:b,type:"POST",success:function(a){a=$(a).find("resourceUrl").text();a={audiences:[],author:l,blacklist:r,identity:n,privacy:"PUBLIC",slide:p,target:"bannedcontent",timestamp:k,title:m,type:"submission",url:a};console.log(a);sendStanza(a);a=batchTransform();
a.inkIds=_.map(_.values(d),"identity");a.textIds=_.map(_.values(e),"identity");a.multiWordTextIds=_.map(_.values(f),"identity");a.imageIds=_.map(_.values(g),"identity");a.newPrivacy="private";console.log(a);sendStanza(a);WorkQueue.gracefullyResume();successAlert("Banned content",sprintf("You have banned: %s",h))},error:function(a){console.log(a);errorAlert("Banning failed","This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},
data:a,cache:!1,contentType:!1,processData:!1})}}}();
