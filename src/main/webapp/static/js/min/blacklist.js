var Blacklist=function(){var d={},m={},n={},g={},e={},p={},h=[],c=[],f={};$(function(){d=$("#blacklistListing");m=d.find(".blacklistSummary").clone();g=$("#currentBlacklist");n=g.find(".blacklistContainer").clone();e=$("#currentBlacklistAuthorList");p=e.find(".blacklistAuthorContainer").clone();d.empty();e.empty();q()});var k=function(a){return Conversations.shouldModifyConversation()},v=function(){e.empty();c.map(function(a){var b=p.clone();b.find(".blacklistAuthorName").text(a);b.find(".blacklistAuthorUnbanButton").on("click",
function(){c=_.filter(c,function(b){return b!=a});changeBlacklistOfConversation(Conversations.getCurrentConversationJid(),c)});e.append(b)})},q=function(){Conversations.shouldModifyConversation()?($("#ban").show(),$("#administerContent").show(),$("#menuBlacklist").show()):($("#ban").hide(),$("#administerContent").hide(),$("#menuBlacklist").hide(),$("#blacklistPopup").hide())},r=function(){q();h=[];f={}},u=function(){d.empty();_.filter(h,k).map(function(a){w(a)});g.html(t(f))},w=function(a){if("type"in
a&&"submission"==a.type&&"target"in a&&"bannedcontent"==a.target){var b=m.clone();d.append(b);b.find(".blacklistDescription").text(sprintf("submitted by %s at %s %s",a.author,(new Date(a.timestamp)).toDateString(),(new Date(a.timestamp)).toLocaleTimeString()));b.find(".blacklistImageThumb").attr("src",sprintf("/submissionProxy/%s/%s/%s",Conversations.getCurrentConversationJid(),a.author,a.identity));b.find(".viewBlacklistButton").attr("id",sprintf("viewBlacklistButton_%s",a.identity)).on("click",
function(){f=a;g.html(t(f))})}},t=function(a){var b=$("<div />");if("type"in a&&"submission"==a.type&&"target"in a&&"bannedcontent"==a.target&&Conversations.shouldModifyConversation()){b=n.clone();b.attr("id",sprintf("blacklist_%s",a.identity));b.find(".blacklistDescription").text(sprintf("submitted by %s at %s",a.author,a.timestamp));b.find(".blacklistImage").attr("src",sprintf("/submissionProxy/%s/%s/%s",Conversations.getCurrentConversationJid(),a.author,a.identity));var c=b.find(".blacklistAuthors"),
d=c.find(".blacklistAuthor").clone();c.empty();"blacklist"in a&&_.each(a.blacklist,function(a){if("username"in a&&"highlight"in a){var b=d.clone();b.find(".blacklistAuthorName").text(a.username);var e=a.highlight[0];a=a.highlight[1];b.find(".blacklistAuthorColor").css({"background-color":e,opacity:a});c.append(b)}});b.find(".displaySubmissionOnNextSlide").on("click",function(){addSubmissionSlideToConversationAtIndex(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlide().index+1,
a.identity)})}return b},l=function(a,b){try{"target"in a&&"bannedcontent"==a.target&&k(a)&&(h.push(a),b||u())}catch(c){console.log("Blacklists.stanzaReceivedFunction",c)}};Progress.conversationDetailsReceived.blacklist=function(a){"blacklist"in a&&"jid"in a&&Conversations.getCurrentConversationJid()==a.jid&&(c=a.blacklist,v())};Progress.onConversationJoin.blacklist=r;Progress.historyReceived.blacklist=function(a){try{"type"in a&&"history"==a.type&&(r(),_.forEach(a.submissions,function(a){l(a,!0)}),
u())}catch(b){console.log("Blacklists.historyReceivedFunction",b)}};Progress.stanzaReceived.blacklist=l;return{getAllBlacklists:function(){return Conversations.shouldModifyConversation()?_.filter(h,k):[]},getCurrentBlacklist:function(){return Conversations.shouldModifyConversation()?f:{}},processBlacklist:l,getBlacklistedAuthors:function(){return Conversations.shouldModifyConversation()?c:[]}}}();
