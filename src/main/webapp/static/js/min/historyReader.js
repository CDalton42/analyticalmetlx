var renderOffsetX=0,renderOffsetY=0,loadSlidesAtNativeZoom,startMark,requestedViewboxX=0,requestedViewboxY=0,requestedViewboxWidth=320,requestedViewboxHeight=240;function loadSlide(a){startMark=Date.now();$("#targetSlide").text(sprintf("Loading %s",a));showSpinner();moveToSlide(a.toString())}
function receiveHistory(a,d,b){try{var c=void 0==d?boardContext:d;Date.now();boardContent=a;boardContent.minX=0;boardContent.minY=0;boardContent.maxX=boardWidth;boardContent.maxY=boardHeight;$.each(boardContent.inks,function(a,b){prerenderInk(b)});Date.now();$.each(boardContent.highlighters,function(a,b){prerenderInk(b)});Date.now();$.each(boardContent.texts,function(a,b){isUsable(b)?prerenderText(b):delete boardContent.texts[b.id]});Date.now();_.each(boardContent.multiWordTexts,function(a,b){var c=
Modes.text.editorFor(a).doc;c.load(a.words);a.bounds=c.calculateBounds();incorporateBoardBounds(a.bounds)});Date.now();boardContent.width=boardContent.maxX-boardContent.minX;boardContent.height=boardContent.maxY-boardContent.minY;var f=function(){Date.now();Progress.call("historyReceived",[a]);Date.now();Infinity==boardContent.minX&&(boardContent.minX=0);Infinity==boardContent.minY&&(boardContent.minY=0);loadSlidesAtNativeZoom?(requestedViewboxY=requestedViewboxX=0,requestedViewboxWidth=boardWidth,
requestedViewboxHeight=boardHeight):(requestedViewboxX=boardContent.minX,requestedViewboxY=boardContent.minY,requestedViewboxWidth=boardContent.width,requestedViewboxHeight=boardContent.height);IncludeView["default"]();hideBackstage();clearBoard(c,{x:0,y:0,w:boardWidth,h:boardHeight});render(boardContent,c);Date.now();void 0!=b&&b()};if(0==_.keys(boardContent.images).length)_.defer(f);else{var g=0,e=_.keys(boardContent.images).length;$.each(boardContent.images,function(a,b){b.bounds=[b.x,b.y,b.x+
b.width,b.y+b.height];incorporateBoardBounds(b.bounds);var c=new Image;b.imageData=c;var d=calculateImageSource(b,!0);c.onload=function(a){a=!1;0==b.width&&(b.width=c.naturalWidth,a=!0);0==b.height&&(b.height=c.naturalHeight,a=!0);a&&(b.bounds=[b.x,b.y,b.x+b.width,b.y+b.height],incorporateBoardBounds(b.bounds));g+=1;prerenderImage(b);g>=e&&_.defer(f)};c.onerror=function(a){console.log("Data image load error",b,a);--e;console.log(sprintf("Preloaded %s/%s images",g,e));g>=e&&_.defer(f)};c.src=d})}}catch(h){console.log("receiveHistory exception",
h)}UserSettings.getIsInteractive()||zoomToFit()}var lineDrawingThreshold=25;function incorporateBoardBounds(a){isNaN(a[0])||(boardContent.minX=Math.min(boardContent.minX,a[0]));isNaN(a[1])||(boardContent.minY=Math.min(boardContent.minY,a[1]));isNaN(a[2])||(boardContent.maxX=Math.max(boardContent.maxX,a[2]));isNaN(a[3])||(boardContent.maxY=Math.max(boardContent.maxY,a[3]));boardContent.width=boardContent.maxX-boardContent.minX;boardContent.height=boardContent.maxY-boardContent.minY}
function mergeBounds(a,d){var b={};b.minX=Math.min(a[0],d[0]);b.minY=Math.min(a[1],d[1]);b.maxX=Math.max(a[2],d[2]);b.maxY=Math.max(a[3],d[3]);b.width=b.maxX-b.minX;b.height=b.maxY-b.minY;b.centerX=b.minX+b.width/2;b.centerY=b.minY+b.height/2;b[0]=b.minX;b[1]=b.minY;b[2]=b.maxX;b[3]=b.maxY;return b}var boardLimit=1E4;function isUsable(a){var d=!_.some(a.bounds,function(a){return isNaN(a)||a>boardLimit||a<-boardLimit}),b="size"in a?!isNaN(a.size):!0;a="text"in a?0<a.text.length:!0;return d&&b&&a}
var leftPoint=function(a,d,b,c,f,g){return{x:d*b*g+c,y:a*b*-g+f}},rightPoint=function(a,d,b,c,f,g){return{x:d*b*-g+c,y:a*b*g+f}},renderHull=function(a){if(!(6>a.points.length)){var d=a.canvas.getContext("2d"),b=Infinity,c=Infinity,f=a.points,g=[],e,h;for(e=0;e<f.length;e+=3)b=Math.min(b,f[e]),c=Math.min(c,f[e+1]);b-=a.thickness/2;c-=a.thickness/2;for(e=0;e<f.length;e+=3)g.push(f[e]-b),g.push(f[e+1]-c),g.push(f[e+2]);var l,k,m,n,q,r,t,u,y,z,w,x,b=[],c=[];try{for(e=0;e<g.length-3;e+=3){q=g[e];r=g[e+
1];y=g[e+2];t=g[e+3];u=g[e+4];z=g[e+5];var f=t-q,p=u-r;if(0!=f&&0!=p){var v=1/Math.sqrt(f*f+p*p);w=a.thickness/y*64;x=a.thickness/z*64;l=leftPoint(f,p,v,t,u,x);k=rightPoint(f,p,v,t,u,x);m=leftPoint(-f,-p,v,q,r,w);n=rightPoint(-f,-p,v,q,r,w);b.push(n);b.push(l);c.push(m);c.push(k)}}d.fillStyle=a.color[0];d.globalAlpha=a.color[1]/255;d.beginPath();var A=b[0];d.moveTo(A.x,A.y);for(e=0;e<b.length;e++)h=b[e],d.lineTo(h.x,h.y);for(e=c.length-1;0<=e;e--)h=c[e],d.lineTo(h.x,h.y);d.fill();d.closePath()}catch(B){console.log("Couldn't render hull for",
a.points)}}},determineCanvasConstants=_.once(function(){var a=DeviceConfiguration.getCurrentDevice(),d=2147483647,b=2147483647;"browser"!=a&&("iPad"==a?b=d=6144:"iPhone"==a?b=d=2048:"IE9"==a&&(b=d=8192));return{x:d,y:b}});function determineScaling(a,d){var b=a,c=d,f=1,g=1,e=determineCanvasConstants(),h=e.x,e=e.y;a>h&&(f=h/a,b=a*f);d>e&&(g=e/d,c=d*g);return{width:b,height:c,scaleX:f,scaleY:g}}
function prerenderInk(a){if(!isUsable(a))return a.identity in boardContent.inks&&delete boardContent.inks[a.identity],a.identity in boardContent.highlighters&&delete boardContent.highlighters[a.identity],!1;calculateInkBounds(a);incorporateBoardBounds(a.bounds);var d=$("<canvas />")[0];a.canvas=d;var b=d.getContext("2d"),c=0,f="PRIVATE"==a.privacy.toUpperCase();f&&(c=3);var g=a.bounds[2]-a.bounds[0]+a.thickness+2*c,e=a.bounds[3]-a.bounds[1]+a.thickness+2*c,h=determineScaling(g,e);d.width=h.width;
d.height=h.height;$(d).css({width:px(g),height:px(e)});d=a.points;g=[];for(e=0;e<d.length;e+=3)g.push(d[e]*h.scaleX),g.push(d[e+1]*h.scaleY),g.push(d[e+2]);var l=-1*(a.minX-a.thickness/2-c)*h.scaleX,k=-1*(a.minY-a.thickness/2-c)*h.scaleY,m,n;if(f){m=g[0]+l;n=g[1]+k;b.lineWidth=a.thickness+c;b.strokeStyle=a.color[0];b.fillStyle=a.color[0];b.moveTo(m,n);b.beginPath();for(e=0;e<g.length;e+=3)b.moveTo(m,n),m=g[e]+l,n=g[e+1]+k,b.lineTo(m,n);b.lineCap="round";b.stroke();b.closePath();b.strokeStyle="white";
b.fillStyle="white"}else b.strokeStyle=a.color[0],b.fillStyle=a.color[0];m=g[0]+l;n=g[1]+k;b.moveTo(m,n);b.beginPath();m=g[0]+l;n=g[1]+k;_.each(_.chunk(g,3),function(c){b.beginPath();b.moveTo(m,n);m=c[0]+l;n=c[1]+k;b.lineTo(m,n);b.lineWidth=c[2]/256*a.thickness;b.lineCap="round";b.stroke()});return!0}function alertCanvas(a,d){var b=a.toDataURL();window.open(b,d,sprintf("width=%s, height=%s",a.width,a.height))}var precision=Math.pow(10,3),round=function(a){return Math.round(a*precision)/precision};
function calculateImageBounds(a){a.bounds=[a.x,a.y,a.x+a.width,a.y+a.height]}function calculateImageSource(a){var d="PRIVATE"==a.privacy.toUpperCase()?sprintf("%s%s",a.slide,a.author):a.slide;return sprintf("/proxyImageUrl/%s?source=%s",d,encodeURIComponent(a.source))}function calculateTextBounds(a){a.bounds=[a.x,a.y,a.x+a.width,a.y+a.runs.length*a.size*1.25]}
function calculateInkBounds(a){for(var d=Infinity,b=Infinity,c=-Infinity,f=-Infinity,g=[],e=a.points,h=0;h<e.length;h+=3){var l=round(e[h]),k=round(e[h+1]);e[h]=l;e[h+1]=k;g.push(e[h+2]);d=Math.min(l,d);b=Math.min(k,b);c=Math.max(l,c);f=Math.max(k,f)}a.minX=d;a.minY=b;a.maxX=c;a.maxY=f;a.width=c-d;a.height=f-b;a.centerX=d+a.width/2;a.centerY=b+a.height/2;a.bounds=[d,b,c,f];a.widths=g}function scale(){return Math.min(boardWidth/viewboxWidth,boardHeight/viewboxHeight)}
function prerenderImage(a){var d=$("<canvas/>")[0];a.canvas=d;d.width=a.width;d.height=a.height;var b=.1*d.width,c=.1*d.height;d.width=a.width+b;d.height=a.height+c;var f=d.getContext("2d");f.drawImage(a.imageData,b/2,c/2,a.width,a.height);"PRIVATE"==a.privacy.toUpperCase()&&(f.globalAlpha=.2,f.fillStyle="red",f.fillRect(0,0,d.width,d.height),f.globalAlpha=1);delete a.imageData}
function prerenderText(a){function d(a){var b=a.font;"bold"==a.weight&&(b+=" bold");"italic"==a.style&&(b+=" italic");return b}var b=$("<canvas />")[0];a.canvas=b;var c=b.getContext("2d");c.strokeStyle=a.color;c.font=a.font;var f=/\n/;a.width||(a.width=Math.max.apply(Math,a.text.split(f).map(function(a){return c.measureText(a).width})));var g="",e=[],h=!1;$.each(a.text.split(""),function(b,d){d.match(f)?(e.push(""+g),g=""):h&&" "==d?(e.push(g),g=""):(h=c.measureText(g).width>=a.width-80,g+=d)});e.push(g);
e=e.map(function(a){return a.trim()});a.runs=e;calculateTextBounds(a);var l=a.bounds[3]-a.bounds[1],k=determineScaling(a.bounds[2]-a.bounds[0],l);b.width=k.width;b.height=k.height;a.height=l;"PRIVATE"==a.privacy.toUpperCase()&&(c.globalAlpha=.2,c.fillStyle="red",c.fillRect(0,0,k.width,k.height),c.globalAlpha=1);c.fillStyle=a.color[0];c.textBaseline="top";$.each(a.runs,function(b,e){var f=function(){var b=_.range(a.size,a.height,a.height/(a.height/(1.25*a.size)));_.each(b,function(b){c.beginPath();
c.strokeStyle=a.color[0];b=contentOffsetY+b;c.moveTo(contentOffsetX,b);c.lineTo(contentOffsetX+k.width,b);c.stroke()})},g=b*a.size*1.25;c.font=d(a);c.fillText(e,contentOffsetX*k.scaleX,(contentOffsetY+g)*k.scaleY,k.width);"underline"==a.decoration&&f()});incorporateBoardBounds(a.bounds)}
var boardContent={images:{},highlighters:{},texts:{},multiWordTexts:{},inks:{}},pressureSimilarityThreshold=32,viewboxX=0,viewboxY=0,viewboxWidth=80,viewboxHeight=60,contentOffsetX=0,contentOffsetY=0,boardWidth=0,boardHeight=0,visibleBounds=[];
function render(a,d,b){var c=d||boardContext;if(a){Date.now();try{var f=void 0==b?[viewboxX,viewboxY,viewboxX+viewboxWidth,viewboxY+viewboxHeight]:b;visibleBounds=[];var g=function(a){void 0!=a&&$.each(a,function(a,b){try{intersectRect(b.bounds,f)&&drawInk(b,c)}catch(d){console.log("ink render failed for",d,b.canvas,b.identity,b)}})},e=function(a){a&&$.each(a,function(a,b){b.bounds||(b.bounds=b.doc.calculateBounds());intersectRect(b.bounds,f)&&drawMultiwordText(b)})};Object.keys(a.images);clearBoard(c,
{x:0,y:0,w:boardWidth,h:boardHeight});Date.now();$.each(a.images,function(a,b){try{intersectRect(b.bounds,f)&&drawImage(b,c)}catch(d){console.log("image render failed for",d,b.identity,b)}});Date.now();(function(){g(a.highlighters);Date.now();$.each(a.texts,function(a,b){intersectRect(b.bounds,f)&&drawText(b,c)});Date.now();e(a.multiWordTexts);Date.now();g(a.inks);Date.now();Progress.call("postRender");Date.now()})();(function(){c.save();var a=[];_.forEach(Modes.select.selected,function(b){_.forEach(b,
function(b){b=b.bounds;var d=worldToScreen(b[0],b[1]),e=worldToScreen(b[2],b[3]);a.push([d,e]);b&&(c.setLineDash([5]),c.strokeStyle="blue",c.strokeRect(d.x,d.y,e.x-d.x,e.y-d.y))})});var b=Modes.select.totalSelectedBounds();0<a.length&&(c.strokeStyle="blue",c.strokeWidth=3,c.strokeRect(b.tl.x,b.tl.y,b.br.x-b.tl.x,b.br.y-b.tl.y));c.restore()})();(function(){var a=Modes.select.marqueeWorldOrigin;if(Modes.select.dragging){c.save();scale();var a=worldToScreen(Modes.select.offset.x-a.x,Modes.select.offset.y-
a.y),b=worldToScreen(0,0);c.translate(a.x-b.x,a.y-b.y);c.globalAlpha=.7;_.forEach(Modes.select.selected,function(a,b){_.forEach(a,function(a){switch(b){case "images":drawImage(a,c);break;case "texts":drawText(a,c);break;case "multiWordTexts":drawMultiwordText(a);break;case "inks":drawInk(a,c)}})});c.restore()}else if(Modes.select.resizing){var a=Modes.select.totalSelectedBounds(),d=(Modes.select.offset.x-a.x)/(a.x2-a.x),e=(Modes.select.offset.y-a.y)/(a.y2-a.y),f=function(a,b,f){c.save();c.globalAlpha=
.7;c.translate(a,b);c.scale(d,e);c.translate(-a,-b);f();c.restore()};_.forEach(Modes.select.selected,function(a,b){_.forEach(a,function(a){var d=a.bounds,e=worldToScreen(d[0],d[1]),d=e.x,e=e.y;switch(b){case "images":f(d,e,function(){drawImage(a,c)});break;case "texts":f(d,e,function(){drawText(a,c)});break;case "inks":f(d,e,function(){drawInk(a,c)})}})})}})();(function(){_.each(Modes.canvasInteractables,function(a){_.each(a,function(a){c.save();a.render(c);c.restore()})})})();Date.now()}catch(h){console.log("Render exception",
h)}Progress.call("onViewboxChanged")}}function lightBlueGradient(a,d,b){a=a.createLinearGradient(0,0,0,b);a.addColorStop(0,"#F5FAFF");a.addColorStop(.61,"#D0DEEF");a.addColorStop(.4,"#CADAED");a.addColorStop(1,"#E7F2FF");return a}function monashBlueGradient(a,d,b){a=a.createLinearGradient(0,0,0,b);a.addColorStop(1,"#C5D5F6");a.addColorStop(.65,"#87ACF2");a.addColorStop(.6,"#7AA3F4");a.addColorStop(0,"#C5D5F6");return a}
var blit=function(a,d){try{render(void 0==d?boardContent:d,void 0==a?boardContext:a)}catch(b){console.log("exception in render:",b)}};function pica(a){return a/128}function unpica(a){return Math.floor(128*a)}function px(a){return sprintf("%spx",a)}function unpix(a){return a.slice(0,a.length-2)}function updateConversationHeader(){$("#heading").text(Conversations.getCurrentConversation().title)}
function clearBoard(a,d){try{var b=void 0==d?{x:0,y:0,w:boardWidth,h:boardHeight}:d;(void 0==a?boardContext:a).clearRect(b.x,b.y,b.w,b.h)}catch(c){console.log("exception while clearing board:",c,a,d)}}
var IncludeView=function(){var a=function(a,b,c,f){var g=!1;void 0==a?a=requestedViewboxX:(g=!0,requestedViewboxX=a);void 0==b?b=requestedViewboxY:(g=!0,requestedViewboxY=b);void 0==c?c=requestedViewboxWidth:(g=!0,requestedViewboxWidth=c);void 0==f?f=requestedViewboxHeight:(g=!0,requestedViewboxHeight=f);f=Zoom.constrainRequestedViewbox({width:c,height:f,x:a,y:b});c=boardHeight/f.height;b=boardWidth/f.width;b>c?(a=f.height,c=f.width*b/c):(a=f.height/b*c,c=f.width);TweenController.zoomAndPanViewbox(f.x,
f.y,c,a,void 0,!g);Progress.call("onViewboxChanged")};return{specific:function(d,b,c,f){return a(d,b,c,f)},"default":function(){return a()}}}();
