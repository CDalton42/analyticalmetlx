function devLogAdd(a){$("#devLog").append($("<div />",{text:a}))}function devLogSet(a){$("#devLog").html($("<div />",{text:a}))}var incrementKey=function(a,d){d in a?a[d]++:a[d]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(a){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(d,f){a.unbind(f)});WorkQueue.gracefullyResume()}
function progress(){var a=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),d=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(a),f=$("<progress />");f.append(a);var l=1,c=0,p=function(){d.css("width",sprintf("%s%%",Math.floor(c/l*100)));f.attr({value:c,max:l})},h={element:f,value:function(a){c=a;p();return h},max:function(c){l=c;p();return h}};return h}
function proportion(a,d){return a/d/(boardWidth/boardHeight)}function scaleScreenToWorld(a){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return a*d}function scaleWorldToScreen(a){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return a/d}function screenToWorld(a,d){var f=scaleScreenToWorld(a)+viewboxX,l=scaleScreenToWorld(d)+viewboxY;return{x:f,y:l}}
function worldToScreen(a,d){var f=scaleWorldToScreen(a-viewboxX),l=scaleWorldToScreen(d-viewboxY);return{x:f,y:l}}function scaleWorldToVisual(a,d){var f;f=1<proportion(boardWidth,boardHeight)?d[2]/boardWidth:d[3]/boardHeight;return a/f}function worldToVisual(a,d){var f=TweenController.immediateView(),l=scaleWorldToVisual(a-f[0],f),f=scaleWorldToVisual(d-f[1],f);return{x:l,y:f}}
function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(a){return!1}}
function registerPositionHandlers(a,d,f,l){var c=!1,p=function(c,a){var d=[c.x-10,c.y-10,c.x+10,c.y+10],g=!0;_.each(Modes.canvasInteractables,function(b,v){_.each(b,function(b){void 0!=b&&a in b&&(b.activated||intersectRect(d,b.getBounds()))&&(g=g&&b[a](c))})});return g},h=function(c,a){return{shift:c.shiftKey,ctrl:c.ctrlKey,alt:c.altKey,eraser:a}};$.each(a,function(a,t){var k=$(t);k.css({"touch-action":"none"});var g=!1,b={},v=function(e){return void 0!==e&&"touch"==e.originalEvent.pointerType?1<
_.size(b):!1},n=function(e){var c=e.originalEvent.pointerId,a="pen"==e.originalEvent.pointerType&&5==e.originalEvent.button,m=k.offset(),r=e.pageX-m.left,m=e.pageY-m.top,n=e.originalEvent.pressure||.5,z=screenToWorld(r,m),d=b[c]||{pointerId:c,pointerType:e.originalEvent.pointerType,eraser:a,points:[]};d.points.push({x:z.x,y:z.y,screenX:r,screenY:m,z:n});d.eraser=d.eraser||a;"touch"==e.originalEvent.pointerType&&(b[c]=d);v(e)&&(0==g&&_.each(b,function(e){e.points=[_.last(e.points)]}),g=!0);return{pointerType:e.pointerType,
eraser:d.eraser,x:r,y:m,z:n,worldPos:z}},r=function(e){var D=e.originalEvent.pointerId,a="pen"==e.originalEvent.pointerType&&5==e.originalEvent.button,m=k.offset(),r=e.pageX-m.left,m=e.pageY-m.top,n=e.originalEvent.pressure||.5,z=screenToWorld(r,m);"touch"==e.originalEvent.pointerType&&delete b[D];g&&0==_.size(b)&&(c=g=!1);return{pointerType:e.pointerType,eraser:a,x:r,y:m,z:n,worldPos:z}};if(detectPointerEvents()){var A=function(){takeControlOfViewbox(!0);var e=_.map(_.filter(b,function(e){return 0<
_.size(e.points)}),function(e){var c=_.first(e.points);e=_.last(e.points);return[c,e]});b={};var c=_.meanBy(e,function(e){return e[0].x-e[1].x}),a=_.meanBy(e,function(e){return e[0].y-e[1].y});Pan.translate(scaleWorldToScreen(c),scaleWorldToScreen(a));var c=_.min(_.map(e,function(e){return e[0].y})),g=_.max(_.map(e,function(e){return e[0].y})),a=_.min(_.map(e,function(e){return e[0].x})),m=_.max(_.map(e,function(e){return e[0].x})),c=g-c,a=m-a,m=_.min(_.map(e,function(e){return e[1].y})),g=_.max(_.map(e,
function(e){return e[1].y})),r=_.min(_.map(e,function(e){return e[1].x})),e=(_.max(_.map(e,function(e){return e[1].x}))-r+(g-m))/2;Zoom.scale((a+c)/2/e)};k.bind("pointerdown",function(e){e.originalEvent.pointerType!=e.POINTER_TYPE_TOUCH&&"touch"!=e.originalEvent.pointerType||!v(e)||(g=!0);var b=n(e);e.preventDefault();WorkQueue.pause();v(e)||g||(c=!0,p(b.worldPos,"down")&&d(b.x,b.y,b.z,b.worldPos,h(e,b.eraser)))});k.bind("pointermove",function(e){var b=n(e);e.preventDefault();e.originalEvent.pointerType!=
e.POINTER_TYPE_TOUCH&&"touch"!=e.originalEvent.pointerType||!v(e)&&!g?p(b.worldPos,"move")&&c&&f(b.x,b.y,b.z,b.worldPos,h(e,b.eraser)):A()});k.bind("pointerup",function(e){var b=r(e);WorkQueue.gracefullyResume();e.preventDefault();p(b.worldPos,"up")&&c&&!g&&l(b.x,b.y,b.z,b.worldPos,h(e,b.eraser));c=!1;Modes.finishInteractableStates()});var x=function(e){r(e);WorkQueue.gracefullyResume();e.preventDefault();if(c){var a=e.offsetX,m=e.offsetY,n=r(e);b={};WorkQueue.gracefullyResume();a=screenToWorld(a,
m);m=a.x;m<viewboxX?(takeControlOfViewbox(!0),Extend.left()):m>=viewboxX+viewboxWidth?(takeControlOfViewbox(!0),Extend.right()):p(a,"up")&&c&&!g&&l(n.x,n.y,n.z,n.worldPos,h(e,n.eraser));c=!1;Modes.finishInteractableStates()}c=!1;Modes.finishInteractableStates()};k.bind("pointerout",x);k.bind("pointerleave",x);k.bind("pointercancel",x)}else{k.bind("mousedown",function(e){WorkQueue.pause();var b=k.offset();c=!0;var a=e.pageX-b.left,b=e.pageY-b.top,m=screenToWorld(a,b);p(m,"down")&&d(a,b,.5,m,h(e));
e.preventDefault()});k.bind("mousemove",function(e){var b=k.offset();e.preventDefault();var a=e.pageX-b.left,b=e.pageY-b.top,m=screenToWorld(a,b);p(m,"move")&&c&&f(a,b,.5,m,h(e))});k.bind("mouseup",function(e){WorkQueue.gracefullyResume();e.preventDefault();var b=k.offset(),a=e.pageX-b.left,b=e.pageY-b.top,m=screenToWorld(a,b);p(m,"up")&&c&&l(a,b,.5,m,h(e));c=!1;Modes.finishInteractableStates()});var w=function(e,b,a){WorkQueue.gracefullyResume();var m=screenToWorld(e,b),n=m.x;n<viewboxX?(takeControlOfViewbox(!0),
Extend.left()):n>=viewboxX+viewboxWidth?(takeControlOfViewbox(!0),Extend.right()):p(m,"up")&&c&&!g&&l(e,b,.5,m,h(a,!1));c=!1};k.bind("mouseout",function(e){WorkQueue.gracefullyResume();e.preventDefault();c&&w(e.offsetX,e.offsetY,e);c=!1;Modes.finishInteractableStates()});var y,u=function(e){return{x:average(_.map(e,"x")),y:average(_.map(e,"y"))}},z=function(e){var b=[],c=k.offset();$.each(e,function(e,a){b.push({x:a.pageX-c.left,y:a.pageY-c.top,identifier:a.identifier})});return b};k.bind("touchstart",
function(e){WorkQueue.pause();e.preventDefault();var b=z(e.originalEvent.touches);if(1==b.length){var b=b[0],a=screenToWorld(b.x,b.y);c=!0;p(a,"down")&&d(b.x,b.y,.5,a,h(e))}else y=u(b)});k.bind("touchmove",function(b){b.preventDefault();var a=z(b.originalEvent.touches);switch(a.length){case 0:break;case 1:var a=a[0],m=screenToWorld(a.x,a.y);p(m,"move")&&c&&f(a.x,a.y,.5,m,h(b));break;default:b=u(a),a=b.x-y.x,m=b.y-y.y,y=b,takeControlOfViewbox(!0),Pan.translate(-1*a,-1*m)}});k.bind("touchend",function(b){WorkQueue.gracefullyResume();
b.preventDefault();var a=k.offset(),m=b.originalEvent.changedTouches[0],g=m.pageX-a.left,a=m.pageY-a.top,m=screenToWorld(g,a);p(m,"up")&&c&&(0>g||0>a||g>boardWidth||a>boardHeight?w(g,a):l(g,a,.5,m,h(b)));c=!1;Modes.finishInteractableStates()});var m=1;k.bind("gesturechange",function(b){WorkQueue.pause();b.preventDefault();c=!1;b=b.originalEvent.scale;takeControlOfViewbox(!0);Zoom.scale(m/b);m=b});k.bind("gestureend",function(){WorkQueue.gracefullyResume();m=1})}});return function(a){c=a}}
function aspectConstrainedDimensions(a,d){var f=boardHeight/boardWidth,l={height:d,width:a};d/a>f?l.height=a*f:l.width=d/f;return l}
function aspectConstrainedRect(a,d,f){var l=boardHeight/boardWidth,c={left:a.left,top:a.top,right:a.right,bottom:a.bottom,width:a.width,height:a.height};a.height/a.width>l?(c.height=a.width*l,f&&(d=a.height-c.height,"center"==f?c.top+=d/2:"bottom"==f&&(c.top+=d))):(c.width=a.height/l,d&&(f=a.width-c.width,"center"==d?c.left+=f/2:"right"==d&&(c.left+=f)));c.right=c.left+c.width;c.bottom=c.top+c.height;return c}
function copyBuffer(a){var d=document.createElement("canvas");d.width=a.width;d.height=a.height;d.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,a.width,a.height);return d}function intersectRect(a,d){return"undefined"!=typeof a&&"undefined"!=typeof d?!(d[0]>a[2]||d[2]<a[0]||d[1]>a[3]||d[3]<a[1]):!1}function overlapRect(a,d){return intersectRect(a,d)?(Math.max(a[0],d[0])-Math.min(a[2],d[2]))*(Math.max(a[1],d[1])-Math.min(a[3],d[3])):0}
function rectFromTwoPoints(a,d,f){f=f||0;var l,c,p;a.x<d.x?(l=a.x,p=d.x):(l=d.x,p=a.x);a.y<d.y?(c=a.y,a=d.y):(c=d.y,a=a.y);d=p-l;var h=a-c;d<f&&(p+=f-d,d=p-l);h<f&&(a+=f-h,h=a-c);return{left:l,top:c,right:p,bottom:a,width:d,height:h}}function updateMarquee(a,d,f){d=rectFromTwoPoints(d,f);f=$("#selectionAdorner");jQuery.contains(f,a)||f.append(a);a.is(":visible")||a.show();a.css({left:px(d.left),top:px(d.top),width:px(d.width),height:px(d.height)})}
function clampToView(a){var d=a.x,f=a.y;0>a.x&&(d=0);a.x>boardWidth&&(d=boardWidth);0>a.y&&(f=0);a.y>boardHeight&&(f=boardHeight);return{x:d,y:f}}
var bounceButton=function(a){var d=$(a);d.addClass("activeBrush");setTimeout(function(){d.removeClass("activeBrush")},200)},videoControlInteractable=function(a){var d=void 0;return{activated:!1,rehome:function(a){},down:function(a){return!1},move:function(a){return!1},up:function(d){var l=Modes.select.handlesAtZoom();d=d.x-a.x;if(d<l)a.getState().paused?a.play():a.pause();else if(d>a.width-l)a.muted(!a.muted());else{var c=a.getState();a.seek((d-l)/(a.width-2*l)*c.duration)}return!1},getBounds:function(){return d},
deactivate:function(){},render:function(f){if(a.identity in boardContent.videos){var l=Modes.select.handlesAtZoom();d=[a.bounds[0],a.bounds[3],a.bounds[2],a.bounds[3]+l];var l=worldToScreen(d[0],d[1]),c=worldToScreen(d[2],d[3]),p=c.x-l.x,h=c.y-l.y,q=a.getState();f.globalAlpha=1;f.setLineDash([]);f.strokeStyle="black";f.font=sprintf("%spx FontAwesome",h);f.fillStyle="white";f.fillRect(l.x,l.y,h,h);f.fillStyle="black";q.paused?f.fillText("\uf04b",l.x,c.y):f.fillText("\uf04c",l.x,c.y);var t=l.x+h,k=
p-h;f.fillStyle="black";f.fillRect(t,l.y,k,h);f.fillStyle="blue";k*=q.currentTime/q.duration;f.fillRect(t,l.y,k,h);p=l.x+(p-h);f.fillStyle="white";f.fillRect(p,l.y,h,h);f.fillStyle="black";q.muted?f.fillText("\uf0f3",p,c.y):f.fillText("\uf1f6",p,c.y)}}}},Modes=function(){var a=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},d=function(c,d){a();$(c).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$(d).addClass("activeTool").removeClass("inactiveTool")},f={name:"none",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.none;a()},deactivate:function(){a();unregisterPositionHandlers(board)}},l=function(a,d){a in Modes.canvasInteractables||(Modes.canvasInteractables[a]=[]);Modes.canvasInteractables[a].push(d)};$(function(){var a={opacity:1};(new TWEEN.Tween(a)).delay(1E3).to({opacity:.3},1E3);var d=Modes.select.handlesAtZoom(),h=function(a){var b=Modes.select.handlesAtZoom(),
c=scaleScreenToWorld(DeviceConfiguration.headerHeight)+b,n=scaleScreenToWorld(DeviceConfiguration.footerHeight);return Math.min(viewboxY+viewboxHeight-(n-b/2),Math.max(a,viewboxY+c))},f=function(){var g=void 0;return{getBounds:function(){return g},activated:!1,originalHeight:1,originalWidth:1,rehome:function(b){if(!f.activated){var a=Modes.select.handlesAtZoom(),c=h(b.y);b=b.x+a/2;g=[b-a/2,c-a,b+a/2,c]}},down:function(b){f.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=
b;Modes.select.marqueeWorldOrigin=b;blit()},move:function(b){f.activated&&(f.bounds=[b.x-d,b.y,b.x+d,b.y],Modes.select.offset=b,blit());return!1},deactivate:function(){f.activated=!1;Modes.select.dragging=!1},up:function(b){f.deactivate();var a=batchTransform(),c=b.x-Modes.select.marqueeWorldOrigin.x,g=b.y-Modes.select.marqueeWorldOrigin.y;a.xTranslate=c;a.yTranslate=g;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);
a.videoIds=_.keys(Modes.select.selected.videos);a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(a.multiWordTextIds,function(b){Modes.text.echoesToDisregard[b]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(b){b.doc.position.x+=c;b.doc.position.y+=g;b.doc.invalidateBounds()});sendStanza(a);registerTracker(a.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(b){if(g){var d=worldToScreen(g[0],g[1]),n=worldToScreen(g[2],g[3]).x-
d.x,r=d.x,d=d.y;b.globalAlpha=a.opacity;b.setLineDash([]);b.strokeStyle="black";b.fillStyle="white";b.strokeWidth=2;b.fillRect(r,d,n,n);b.strokeRect(r,d,n,n);b.font=sprintf("%spx FontAwesome",n);b.fillStyle="black";b.fillText("\uf047",r,d+n-4)}}}}(),t=function(){var g=void 0;return{getBounds:function(){return g},activated:!1,originalHeight:1,originalWidth:1,rehome:function(b){if(!t.activated){var a=Modes.select.handlesAtZoom(),c=b.x2;b=h(b.y)-a;g=[c,b,c+a,b+a]}},down:function(b){Modes.select.aspectLocked=
!0;Modes.select.dragging=!1;Modes.select.resizing=!0;t.activated=!0;b=Modes.select.totalSelectedBounds();Modes.select.offset={x:b.x2,y:b.y2};t.rehome(b);blit();return!1},move:function(b){if(t.activated){g=[b.x-d,g[1],b.x+d,g[3]];var a=Modes.select.totalSelectedBounds();Modes.select.offset={x:b.x,y:a.y+(b.x-a.x)/(a.x2-a.x)*a.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;t.activated=!1;Modes.select.resizing=!1},up:function(b){t.deactivate();var a=batchTransform(),c=Modes.select.totalSelectedBounds();
a.xScale=(b.x-c.x)/(c.x2-c.x);a.yScale=a.xScale;a.xOrigin=c.x;a.yOrigin=c.y;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);a.videoIds=_.keys(Modes.select.selected.videos);a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(b,c){Modes.text.echoesToDisregard[c]=!0;var g=b.doc.documentRange();b.doc.select(g.start,g.end);Modes.text.scaleEditor(b.doc,
a.xScale);g=b.doc.width();b.doc.width(g*a.xScale);b.doc.select(0);b.doc.updateCanvas();blit()});registerTracker(a.identity,function(){Progress.call("onSelectionChanged")});sendStanza(a);return!1},render:function(b){if(g){var d=worldToScreen(g[0],g[1]),n=worldToScreen(g[2],g[3]).x-d.x,r=n/10,h=-1*n;b.globalAlpha=a.opacity;b.setLineDash([]);b.strokeStyle="black";b.fillStyle="white";b.strokeWidth=2;b.translate(d.x,d.y);b.rotate(90*Math.PI/180);b.fillRect(0,h,n,n);b.strokeRect(0,h,n,n);b.font=sprintf("%spx FontAwesome",
n);b.fillStyle="black";b.fillText("\uf0b2",r,-1*r)}}}}(),k=function(){var g=void 0;return{activated:!1,getBounds:function(){return g},rehome:function(b){if(!k.activated){var a=Modes.select.handlesAtZoom(),c=b.x2;b=h(b.y2);g=[c,b-a,c+a,b]}},down:function(b){k.activated=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;b=Modes.select.totalSelectedBounds();Modes.select.offset={x:b.x2,y:b.y2};blit();return!1},move:function(b){k.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),
k.bounds=[b.x-d,b.y-d,b.x+d,b.y+d],Modes.select.offset={x:b.x,y:b.y},blit());return!1},deactivate:function(){k.activated=!1;Modes.select.resizing=!1},up:function(b){k.deactivate();var a=batchTransform(),c=Modes.select.totalSelectedBounds(),g=c.y2-c.y,d=b.y-c.y;a.xScale=(b.x-c.x)/(c.x2-c.x);a.yScale=d/g;a.xOrigin=c.x;a.yOrigin=c.y;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);a.videoIds=_.keys(Modes.select.selected.videos);
var h=scale();_.each(Modes.select.selected.multiWordTexts,function(b){0<b.doc.save().length&&(b.doc.width(Math.max(b.doc.width()*a.xScale,Modes.text.minimumWidth/h)),b.doc.updateCanvas(),sendRichText(b))});blit();registerTracker(a.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(a);return!1},render:function(b){if(g){var d=worldToScreen(g[0],g[1]),n=worldToScreen(g[2],g[3]).x-d.x,r=n/10,h=-1*n;b.globalAlpha=a.opacity;b.setLineDash([]);b.strokeStyle="black";b.fillStyle="white";
b.strokeWidth=2;b.translate(d.x,d.y);b.rotate(90*Math.PI/180);b.fillRect(0,h,n,n);b.strokeRect(0,h,n,n);b.font=sprintf("%spx FontAwesome",n);b.fillStyle="black";b.fillText("\uf065",r,-1*r)}}}}();l("manualMove",f);l("resizeFree",k);l("resizeAspectLocked",t);Progress.textBoundsChanged.selectionHandles=function(a,b){if(a in Modes.select.selected.multiWordTexts){var c=Modes.select.totalSelectedBounds();f.rehome(c);k.rehome(c);t.rehome(c);blit()}};Progress.onSelectionChanged.selectionHandles=function(){var g=
Modes.select.totalSelectedBounds();Infinity==g.x?a.opacity=0:(a.opacity=1,f.rehome(g),k.rehome(g),t.rehome(g),blit())}});return{pushCanvasInteractable:l,clearCanvasInteractables:function(a){Modes.canvasInteractables[a]=[]},getCanvasInteractables:function(){return _.mapValues(Modes.canvasInteractables,function(a){return _.map(a,function(a){a=_.clone(a);a.bounds=a.getBounds();return a})})},currentMode:f,none:f,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),
function(a){_.forEach(Modes.canvasInteractables[a],function(a){void 0!=a&&"deactivate"in a&&a.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var c,f,h,q,l,k,g,b,v=function(a){return function(){u[a]=!u[a];RichText.setAttributes(u)}},n=function(a){return function(){RichText.scaleSelection(a)}};$(function(){q=$(".fontBoldSelector");l=$(".fontItalicSelector");k=$(".fontUnderlineSelector");$("#textDropdowns");$("#fontOptions");c=$("#fontFamilySelector");
f=$("#fontSizeSelector");h=$("#fontColorSelector");g=$("#fontLarger");b=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");$("#presetFullscreen");$("#presetCenterOnScreen");var a=c.find(".fontFamilyOption").clone(),m=f.find(".fontSizeOption").clone(),e=h.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(b){c.append(a.clone().attr("value",b).text(b))});Fonts.getAllSizes().map(function(a){f.append(m.clone().attr("value",
a).text(a))});Colors.getAllNamedColors().map(function(a){h.append(e.clone().attr("value",a.rgb).text(a.name))});g.on("click",n(1.25));b.click(n(.8));q.click(v("bold"));l.click(v("italic"));k.click(v("underline"));var d={red:"#ff0000",blue:"#0000ff",black:"#000000",yellow:"#ffff00",green:"#00ff00"};_.each(["red","blue","black","yellow","green"],function(a){$(sprintf("#%sText",a)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");u.color=d[a];RichText.setAttributes(u)})})});
var r=function(){return[$("#blackText"),$("#redText"),$("#blueText"),$("#yellowText"),$("#greenText")]},A=r(),x=function(a){w(a,q,"bold");w(a,l,"italic");w(a,k,"underline");y(a,A[0],"color","#000000");y(a,A[1],"color","#ff0000");y(a,A[2],"color","#0000ff");y(a,A[3],"color","#ffff00");y(a,A[4],"color","#00ff00")},w=function(a,b,e){(a=1==a[e])&&(u[e]=a);b.toggleClass("active",a)},y=function(a,b,e,c){var g=_.isEqual(a[e],c);e in a&&g&&(u[e]=c);b.toggleClass("active",g)},u={fontSize:25,fontFamily:"Arial",
bold:!1,underline:!1,italic:!1,color:"#000000"};return{name:"text",echoesToDisregard:{},minimumWidth:240,attributesAtCursor:function(){return u},minimumHeight:function(){return 3*Modes.select.resizeHandleSize},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},getSelectedRanges:function(){return _.map(boardContent.multiWordTexts,function(a){var b=a.doc.selectedRange();return{identity:a.identity,start:b.start,end:b.end,text:b.plainText()}})},getLinesets:function(){return _.map(boardContent.multiWordTexts,
function(a){a.doc.layout();return _.map(a.doc.frame.lines,function(a){return a.positionedWords.length})})},mapSelected:function(a){var b=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,function(e){e.identity in b&&a(e)})},scaleEditor:function(a,b){var e=a.selectedRange(),c=0,g=[],d=carota.runs.defaultFormatting.size;a.runs(function(b){b=_.size(b.text);b=c+b;a.select(c,b,!0);var e=a.selectedRange().getFormatting().size||d;_.each(_.range(c,b),function(){g.push(e)});c=b;d=e},
a.range(0,e.end));c=e.start;a.runs(function(e){e=c+e.text.length;a.select(c,e,!0);a.selectedRange().setFormatting("size",g[c]*b);c=e},a.range(e.start,e.end));a.select(e.start,e.end,!0);a.invalidateBounds();return g},scrollToCursor:function(a){var b=a.bounds,e=a.doc.selectedRange().start;a=a.doc.getCaretCoords(e);var e=Math.floor(a.t/a.h),c=Math.floor(scaleScreenToWorld(boardContext.height)/a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var e=Math.min(e,Math.max(0,c-2))*a.h,c=Math.max(b[2]-b[0],
scaleWorldToScreen(10*a.h)),g=c/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(b[0],b[1]-e+a.t,c,g)}else b=Math.max(0,Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(b[1]-viewboxY))/a.h)-8))*a.h,0!=b&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+b,viewboxWidth,viewboxHeight)},refocussing:!1,editorFor:function(a){var b=boardContent.multiWordTexts[a.identity];b||(b=boardContent.multiWordTexts[a.identity]=a);if(!b.doc){var c=a.author==UserSettings.getUsername();
b.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",a.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],a);if(c){var g=_.debounce(function(){var a=boardContent.multiWordTexts[b.identity];a&&(a.target="presentationSpace",a.slide=Conversations.getCurrentSlideJid(),a.audiences=ContentFilter.getAudiences(),sendRichText(a),incorporateBoardBounds(b.bounds))},1E3);Progress.beforeChangingAudience[a.identity]=function(){g.flush();delete Progress.beforeChangingAudience[a.identity]};Progress.beforeLeavingSlide[a.identity]=
function(){g.flush();delete Progress.beforeLeavingSlide[a.identity]};b.doc.contentChanged(g);b.doc.contentChanged(function(){Modes.text.scrollToCursor(b);blit()});b.doc.selectionChanged(function(a,b){if(Modes.text.refocussing)Modes.text.refocussing=!1;else{var c=a();x(c,r());blit()}})}}b.doc.position={x:a.x,y:a.y};b.doc.width(a.width);return b},contextFor:function(a,b){var c={x:b.x-a.position.x,y:b.y-a.position.y};return{node:a.byCoordinate(c.x,c.y),relativePos:c}},activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.text;d("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");A=r();x(u);registerPositionHandlers(board,function(a,b,c,g){},function(a,b,c,g){},function(a,b,c,g){RichText.click(g);RichText.listen(boardContext);Progress.call("onSelectionChanged",[Modes.select.selected])});RichText.setAttributes(u);Progress.call("onLayoutUpdated")},deactivate:function(){DeviceConfiguration.setKeyboard(!1);a();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,
function(a){a.doc.isActive=!1;0==a.doc.documentRange().plainText().trim().length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();blit()}}}(),video:function(){var c={},f=void 0,h=void 0,q=function(){f.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=h.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();h.unwrap()},l=function(a){if(void 0!=c&&void 0!=c.fileUpload&&void 0!=a){$("#videoWorking").show();$("#videoFileChoice").hide();var g=new FileReader;
g.onload=function(g){var d=$("<video/>"),h=d[0],f=g.target.result;h.addEventListener("loadeddata",function(g){g=h.videoHeight;c.width=h.videoWidth;c.height=g;c.video=d;c.videoSrc=f;a()},!1);d.append($("<source />",{src:f,type:"video/mp4"}));d.load()};g.readAsDataURL(c.fileUpload)}},k=function(){if("imageDefinition"==c.type){WorkQueue.pause();var a=Date.now(),g=sprintf("%s%s",UserSettings.getUsername(),a),d=Conversations.getCurrentSlideJid(),g=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),
encodeURI(g));$.ajax({url:g,type:"POST",success:function(g){g=$(g).find("resourceUrl").text().trim();var h={type:"video",author:UserSettings.getUsername(),timestamp:a,identity:g,slide:d.toString(),source:g,bounds:[c.x,c.y,c.x+c.width,c.y+c.height],width:c.width,height:c.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:c.x,y:c.y,audiences:_.map(Conversations.getCurrentGroup(),"id").concat(ContentFilter.getAudiences()).map(audienceToStanza)};registerTracker(g,function(){var a=
Modes.select.handlesAtZoom(),b=h.x,c=h.y,g=Math.max(h.width,viewboxWidth),d=Math.max(h.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,g+2*a,d+2*a);Modes.select.clearSelection();Modes.select.selected.videos[h.identity]=boardContent.videos[h.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(h);q();WorkQueue.gracefullyResume()},error:function(a){console.log("Image upload ex",a);resetImageUpload();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:c.videoSrc,cache:!1,contentType:!1,processData:!1})}},g=!1;$(function(){g||(g=!0,f=$("#videoInsertOptions").css({position:"absolute",left:0,top:0}),$("#videoInsertOptionsClose").click(Modes.select.activate),h=$("#videoFileChoice").attr("accept","video/mp4"),h[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("video")&&(c.fileUpload=a);l(k)},!1),q())});Progress.beforeLeavingSlide.videos=function(){"videos"in boardContent&&
_.forEach(boardContent.videos,function(a){null!=a&&void 0!=a&&"destroy"in a&&a.destroy()})};return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.video;d("#insertTools","#videoMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$("#insertMode").addClass("activeTool").removeClass("inactiveTool");$(".toolbar.active").removeClass("active");$("#videoMode").addClass("active");$("#insertTools .insetColumn").hide();$("#videoTools").show();var a=screenToWorld(10,
10);c={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");f.show()},deactivate:function(){q();a()}}}(),image:function(){var c={},f=void 0,h=void 0,q=function(){f.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=h.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();h.unwrap()},l=function(){var a=function(a,b,c,g){for(var e=b*c;e>a;)b*=.8,c*=.8,e=b*c;return{w:b,h:c,q:g}},b={"native":{resizeFunc:function(a,b){return{w:a,h:b,q:1}},selector:"#imageInsertNative"},
optimized:{resizeFunc:function(b,c){return a(1*g,b,c,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(b,c){return a(3*g,b,c,.8)},selector:"#imageInsertHighDef"}},c=b.optimized,g=1048576,d=function(){_.forEach(b,function(a){var b=$(a.selector);c.selector==a.selector?b.addClass("activeBrush"):b.removeClass("activeBrush")})};$(function(){_.forEach(b,function(a){$(a.selector).on("click",function(){c=a;d()})});d()});return{reapplyVisualStyle:d,changeMode:function(a){a in b&&(c=b[a],
d())},getResizeFunction:function(){return c.resizeFunc}}}(),k=function(a,b){var d=void 0==b?c:b;if(void 0==d||void 0==d.fileUpload||void 0==a)console.log("returning because currentImage is empty",c);else{$("#imageWorking").show();$("#imageFileChoice").hide();var h=new FileReader;h.onload=function(b){var c=b.target.result;g(c,d,a,function(a){return c.length<a})};h.readAsDataURL(d.fileUpload)}},g=function(a,b,g,d){var h=void 0!=b?b:c,f=$("<canvas/>"),k=new Image;0!=a.indexOf("data")&&k.setAttribute("crossOrigin",
"Anonymous");k.onerror=function(a){errorAlert("Error dropping image","The source server you're dragging the image from does not allow dragging the image directly.  You may need to download the image first and then upload it.")};k.onload=function(b){var c=k.width,e=k.height,r=l.getResizeFunction()(c,e);b=r.w;var q=r.h,r=r.q;f.width=c;f.height=e;f.attr("width",c);f.attr("height",e);f.css({width:px(c),height:px(e)});var p=f[0].getContext("2d");p.rect(0,0,c,e);p.fillStyle="white";p.fill();p.drawImage(k,
0,0,c,e);c=multiStageRescale(f[0],b,q);h.width=b;h.height=q;h.resizedImage=c.toDataURL("image/jpeg",r);d(h.resizedImage.length)&&(h.resizedImage=a);g(h)};k.src=a},b=function(a){if("imageDefinition"==a.type){WorkQueue.pause();var b=Date.now(),c=sprintf("%s%s%s",UserSettings.getUsername(),b,_.uniqueId()),g=Conversations.getCurrentSlideJid(),c=sprintf("/uploadDataUri?jid=%s&filename=%s",g.toString(),encodeURI(c));$.ajax({url:c,type:"POST",success:function(c){c=$(c).find("resourceUrl").text().trim();
var d={type:"image",author:UserSettings.getUsername(),timestamp:b,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+c+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:c,slide:g.toString(),source:c,bounds:[a.x,a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,x:a.x,y:a.y,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),audiences:_.map(Conversations.getCurrentGroup(),"id").concat(ContentFilter.getAudiences()).map(audienceToStanza)};
registerTracker(c,function(){var a=Modes.select.handlesAtZoom(),b=d.x,c=d.y,g=Math.max(d.width,viewboxWidth),h=Math.max(d.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,g+2*a,h+2*a);Modes.select.clearSelection();Modes.select.selected.images[d.identity]=boardContent.images[d.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(d);q();WorkQueue.gracefullyResume();zoomToFit()},error:function(a){console.log(a);q();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:a.resizedImage,cache:!1,contentType:!1,processData:!1})}},v=!1;$(function(){v||(v=!0,f=$("#imageInsertOptions").css({position:"absolute",left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),h=$("#imageFileChoice").attr("accept","image/*"),h[0].addEventListener("change",function(a){try{var g=(a.target.files||a.dataTransfer.files)[0];0==g.type.indexOf("image")&&(c.fileUpload=g);k(b)}catch(d){console.log("imageFileChoiceHandleChanged exception:",
d)}},!1),q())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.image;d("#insertTools","#imageMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$("#insertMode").addClass("activeTool").removeClass("inactiveTool");$(".toolbar.active").removeClass("active");$("#imageMode").addClass("active");$("#insertTools .insetColumn").hide();$("#imageTools").show();var a=screenToWorld(10,10);c={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");
l.reapplyVisualStyle();f.show();console.log("activated insert")},handleDroppedSrc:function(a,c,d){console.log("handleDroppedSrc:",a,c,d);var h=screenToWorld(c,d);g(a,{type:"imageDefinition",screenX:c,screenY:d,x:h.x,y:h.y},b,function(a){return!1})},handleDrop:function(a,c,g){var d=0,h=[];console.log("handling drop:",a,c,g);var f=function(a,f){try{if(void 0!=a&&null!=a&&"type"in a&&0==a.type.indexOf("image")&&!_.some(h,function(b){return b==a})){var m=screenToWorld(c,g+d),e={type:"imageDefinition",
screenX:c,screenY:g+d,x:m.x,y:m.y};e.fileUpload=a;h.push(a);k(b,e);d+=50}}catch(q){console.log("could not processFile:",a,f)}};_.forEach(a.files,function(a){f(a,"file")});_.forEach(a.items,function(a){try{var b=a.getAsFile(0);f(b,"item")}catch(c){console.log("could not get item as file:",c)}})},deactivate:function(){q();a()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");Modes.currentMode.deactivate();d("#panTools","#panMode");Modes.currentMode=Modes.pan;var a,f;registerPositionHandlers(board,
function(d,q,l){takeControlOfViewbox(!0);a=d;f=q},function(d,q,l){Pan.translate(-1*(d-a),-1*(q-f));a=d;f=q},function(a,c,d){})},deactivate:function(){a();unregisterPositionHandlers(board)}},select:function(){var c=!1,f=function(){Modes.select.selected={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}};Progress.call("onSelectionChanged",[Modes.select.selected])},h=_.debounce(function(){var a=!1;_.forEach("images texts inks highlighters multiWordTexts videos".split(" "),function(b){var c="highlighters"==
b?"inks":b;if(Modes&&Modes.select&&Modes.select.selected&&c in Modes.select.selected){var d=Modes.select.selected[c];_.forEach(d,function(f){d&&b in boardContent&&f&&f.identity in boardContent[b]?d[f.identity]=boardContent[b][f.identity]:(a=!0,"inks"==c?"highlighters"==b&&f.identity in d&&1==d[f.identity].isHighlighter?delete d[f.identity]:"inks"==b&&f.identity in d&&0==d[f.identity].isHighlighter&&delete d[f.identity]:delete d[f.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},
100),q=function(){if(void 0!=Modes.select.selected&&c&&"Blacklist"in window){var a=Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),a.inks,a.texts,a.multiWordTexts,a.images,a.videos)}f()},l=function(){(c=Conversations.shouldModifyConversation()?!c:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");f();blit()},k=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),
$("#ban").removeClass("disabledButton"),$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());c?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=h;Progress.onViewboxChanged.ModesSelect=h;Progress.onSelectionChanged.ModesSelect=function(a){a&&
(Modes.select.selected=a,"images"in a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||"multiWordTexts"in a&&0<_.size(a.multiWordTexts)||"videos"in a&&0<_.size(a.videos)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),c?($("#ban").removeClass("disabledButton"),$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),
$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=f;Progress.conversationDetailsReceived.ModesSelect=function(a){c&&!Conversations.shouldModifyConversation(a)&&(c=!1);Conversations.shouldModifyConversation(a)?($("#administerContent").show().unbind("click").bind("click",l),$("#ban").unbind("click").show().bind("click",
q)):($("#administerContent").hide().unbind("click"),$("#ban").hide().unbind("click"));k(a)};return{name:"select",isAdministeringContent:function(){return c},updateAdministerContentVisualState:k,selected:{images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",
function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,b);_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,b);_.forEach(Modes.select.selected.videos,b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),
offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:f,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;d("#selectTools","#selectMode");var a={x:0,y:0},b=$("<div/>",{id:"selectMarquee"}),h=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&!c){var a=batchTransform();a.isDeleted=!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&
(a.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));"videos"in Modes.select.selected&&(a.videoIds=_.keys(Modes.select.selected.videos));sendStanza(a);_.forEach(_.union(Modes.select.selected.inks,Modes.select.selected.texts,Modes.select.selected.images,Modes.select.selected.multiWordTexts,Modes.select.selected.videos),
function(a){Progress.call("onCanvasContentDeleted",[a])});f()}});var l=function(a){a("images");a("texts");a("multiWordTexts");a("inks");a("videos")};Modes.select.dragging=!1;k();Modes.select.resizing=!1;registerPositionHandlers(board,function(c,d,f,k,l){Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:c,y:d};Modes.select.marqueeWorldOrigin=k;if(!l.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){c=3/scale();var q=[k.x-c,k.y-c,k.x+c,k.y+c];Modes.select.dragging=_.some(["images","texts",
"inks","multiWordTexts","videos"],function(a){return _.some(Modes.select.selected[a],function(a){return a?intersectRect(a.bounds,q):!1})})}Modes.select.dragging?(Modes.select.offset=k,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(h.empty(),h.append(b),b.show(),updateMarquee(b,a,a))},function(c,d,f,h,k){c={x:c,y:d};Modes.select.offset=h;Modes.select.dragging?blit():Modes.select.resizing?blit():updateMarquee(b,a,c)},function(a,d,g,f,h){WorkQueue.gracefullyResume();
try{var k=f.x-Modes.select.marqueeWorldOrigin.x,q=f.y-Modes.select.marqueeWorldOrigin.y;15>Math.abs(k)+Math.abs(q)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=k;a.doc.position.y+=q;a.doc.invalidateBounds()});var m=batchTransform();m.xTranslate=k;m.yTranslate=q;m.inkIds=_.keys(Modes.select.selected.inks);m.textIds=
_.keys(Modes.select.selected.texts);m.imageIds=_.keys(Modes.select.selected.images);m.videoIds=_.keys(Modes.select.selected.videos);m.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(m.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(m)}else{var e=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,f,2),p=[e.left,e.top,e.right,e.bottom],t={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},B={},C={};l(function(a){$.each(boardContent[a],
function(b,d){if(!("bounds"in d)&&"type"in d)switch(d.type){case "text":prerenderText(d);break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;case "video":prerenderVideo(d);break;case "multiWordText":prerenderMultiwordText(d);break;default:d.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(p,d.bounds)&&(incrementKey(B,d.author),incrementKey(C,"any"),c?d.author!=UserSettings.getUsername()&&(t[a][d.identity]=d):d.author==UserSettings.getUsername()&&(t[a][d.identity]=d))})});$.each(boardContent.highlighters,
function(a,b){intersectRect(b.bounds,p)&&(incrementKey(B,b.author),c?b.author!=UserSettings.getUsername()&&(t.inks[b.identity]=b):b.author==UserSettings.getUsername()&&(t.inks[b.identity]=b))});l(function(a){$.each(t[a],function(b,c){a in Modes.select.selected||(Modes.select.selected[a]=[]);a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=c})});C.any||Modes.select.clearSelection();var E=sprintf("Selected %s images, %s texts, %s inks, %s rich texts, %s videos ",
_.keys(Modes.select.selected.images).length,_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,_.keys(Modes.select.selected.inks).length,_.keys(Modes.select.selected.videos).length);$.each(B,function(a,b){E+=sprintf("%s:%s ",a,b)});Progress.call("onSelectionChanged",[Modes.select.selected])}b.css({width:0,height:0}).hide();blit()}catch(F){console.log("Selection up ex",F)}})},deactivate:function(){unregisterPositionHandlers(board);a();f();$("#delete").unbind("click");
$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();k();blit();blit()}}}(),zoom:{name:"zoom",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;d("#zoomTools","#zoomMode");var a=$("<div />",{id:"zoomMarquee"}),f,h={x:0,y:0};registerPositionHandlers(board,function(d,l,k,g){takeControlOfViewbox(!0);f=g;a.show();a.appendTo($("#selectionAdorner"));h={x:d,y:l};updateMarquee(a,h,h)},function(d,f,k,g){d={x:d,y:f};f=rectFromTwoPoints(d,h);k=
"left";g="top";d.x==f.left&&(k="right");d.y==f.top&&(g="bottom");d=aspectConstrainedRect(f,k,g);updateMarquee(a,{x:d.right,y:d.bottom},{x:d.left,y:d.top})},function(d,h,k,g){WorkQueue.gracefullyResume();a.hide();d={x:contentOffsetX+g.x,y:contentOffsetY+g.y};h=rectFromTwoPoints(d,{x:contentOffsetX+f.x,y:contentOffsetY+f.y});2500>scale()*h.width*h.height||(k="left",g="top",d.x==h.left&&(k="right"),d.y==h.top&&(g="bottom"),d=aspectConstrainedRect(h,k,g),IncludeView.specific(d.left,d.top,d.width,d.height),
takeControlOfViewbox(!0))})},deactivate:function(){a();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},feedback:function(){var c=function(){Conversations.shouldModifyConversation()?$("#participantsButton").unbind("click").on("click",function(){Participants.openMenu()}).show():$("#participantsButton").unbind("click").hide();switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=
function(){c()};Progress.conversationDetailsReceived.respectNewPermissions=c;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;c();d("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(a,c,d,f){},function(a,c,d,f){},function(a,c,d,f){});c()},deactivate:function(){a();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),draw:function(){var c=Brushes.getDefaultBrushes(),f=_.map(c,function(a){return _.clone(a)}),
h,l=!1,t=void 0,k=void 0,g=function(a){f[a.index]=a},b=function(){},v=function(){},n=function(){};$(function(){var a,d;$(".activeBrush").removeClass("activeBrush");var x=function(){var a=$("#drawTools");_.each(a.find(".modeSpecificTool.pen"),function(a,b){var c=f[b],d=$(a).css({color:c.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");h=c;g(c);Modes.draw.drawingAttributes=h;l=!1;w(c)}).removeClass("fa-tint").removeClass("fa-circle").addClass(c.isHighlighter?
"fa-circle":"fa-tint");d.find(".widthIndicator").text(c.width);c==h&&d.addClass("activeBrush")})},w=function(a){var b=$("#colors .dots"),c=$("#sizes .dots"),d=Colors.getAllNamedColors(),f=Brushes.getAllBrushSizes();c.empty();f.map(function(b){var d=t.clone();c.append(d);d.click(function(){a.width=b;g(a);h=a;x();w(a)});var e=Canvas.circle(a.color,b,50);b==a.width&&d.addClass("activeTool");d.prepend(e);e=b.toString()+"px";d.find(".sizeDotName").append(e)});b.empty();d.map(function(c){var d=k.clone();
b.append(d);d.on("click",function(){a.color=c.rgb;h=a;g(a);x();w(a)});d.css("color",c.rgb);"rgb"in c&&c.rgb==a.color&&d.addClass("activeTool");var f=c.name;d.find(".colorDotName").append(f)});d=$("#setPenToHighlighter").unbind("click").on("click",function(){a.isHighlighter=!0;h=a;g(a);x();w(a)});f=$("#setPenToPen").unbind("click").on("click",function(){a.isHighlighter=!1;h=a;g(a);x();w(a)});"isHighlighter"in h&&h.isHighlighter?(d.addClass("activeTool").addClass("active"),f.removeClass("activeTool").removeClass("active")):
(f.addClass("activeTool").addClass("active"),d.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var a=_.find(c,function(a){return a.id==h.id});void 0!=a&&(h.width=a.width,h.color=a.color,h.isHighlighter=a.isHighlighter,x(),w(h))});t=$("#penSize .sizeDot").clone();k=$("#penColor .colorDot").clone();h=f[0];x();w(h);var y=$("#drawTools");y.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");
$(this).addClass("activeBrush");l=!0;$("#drawDropdowns").hide()});y.find(".advancedTools").unbind("click").on("click",function(){l||(w(h),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});var u=[];v=function(b,c,f,g,h){z=[];l||h.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,boardContext.fillStyle=Modes.draw.drawingAttributes.color,boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,u=
[g.x,g.y,256*f],a=b,d=c,boardContext.beginPath(),boardContext.arc(b,c,Modes.draw.drawingAttributes.width*f/2,0,2*Math.PI),boardContext.fill())};var z=[];d=a=void 0;n=function(b,c,f,g,h){b=Math.round(b);c=Math.round(c);if(l||h.eraser){var k=[g.x-10,g.y-10,g.x+10,g.y+10];f=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,k)){delete a[c.identity];z.push(c);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,
e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";f(boardContent.inks);f(boardContent.highlighters);boardContext.globalAlpha=1}else h=Modes.draw.drawingAttributes.width*f,boardContext.beginPath(),boardContext.lineCap="round",boardContext.lineWidth=h,_.takeRight(u,3),boardContext.moveTo(a,d),boardContext.lineTo(b,c),boardContext.stroke(),u=u.concat([g.x,g.y,256*f]);a=b;d=c};b=function(b,c,f,g,h){l||h.eraser?(b=batchTransform(),b.isDeleted=!0,b.inkIds=_.map(z,function(a){return a.identity}),
_.forEach(z,function(a){Progress.call("onCanvasContentDeleted",[a])}),sendStanza(b)):(h=Modes.draw.drawingAttributes.width*f,boardContext.lineWidth=h,boardContext.beginPath(),boardContext.lineWidth=h,boardContext.lineCap="round",boardContext.moveTo(a,d),boardContext.lineTo(b,c),boardContext.stroke(),u=u.concat([g.x,g.y,256*f]),strokeCollected(u));boardContext.globalAlpha=1}});return{name:"draw",brushes:f,mousePressure:256,activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&
(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,Modes.draw.drawingAttributes=h,d("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),l?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==h.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,v,n,b))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();a();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);
"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,function(a,d,f,l){},function(a,d,f,l){},function(a,d,f,l){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
