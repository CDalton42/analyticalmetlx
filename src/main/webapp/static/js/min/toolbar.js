function devLogAdd(b){$("#devLog").append($("<div />",{text:b}))}function devLogSet(b){$("#devLog").html($("<div />",{text:b}))}var incrementKey=function(b,d){d in b?b[d]++:b[d]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(b){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(d,g){b.unbind(g)});WorkQueue.gracefullyResume()}
function progress(){var b=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),d=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(b),g=$("<progress />");g.append(b);var k=1,c=0,q=function(){d.css("width",sprintf("%s%%",Math.floor(c/k*100)));g.attr({value:c,max:k})},e={element:g,value:function(b){c=b;q();return e},max:function(c){k=c;q();return e}};return e}
function proportion(b,d){return b/d/(boardWidth/boardHeight)}function scaleScreenToWorld(b){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b*d}function scaleWorldToScreen(b){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b/d}function screenToWorld(b,d){var g=scaleScreenToWorld(b)+viewboxX,k=scaleScreenToWorld(d)+viewboxY;return{x:g,y:k}}
function worldToScreen(b,d){var g=scaleWorldToScreen(b-viewboxX),k=scaleWorldToScreen(d-viewboxY);return{x:g,y:k}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(b){return!1}}
function registerPositionHandlers(b,d,g,k){var c=!1,q=function(c,b){var e=[c.x-10,c.y-10,c.x+10,c.y+10],a=!0;_.each(Modes.canvasInteractables,function(h,r){_.each(h,function(h){void 0!=h&&b in h&&(h.activated||intersectRect(e,h.getBounds()))&&(a=a&&h[b](c))})});return a},e=function(c,b){return{shift:c.shiftKey,ctrl:c.ctrlKey,alt:c.altKey,eraser:b}};$.each(b,function(b,w){var l=$(w);l.css({"touch-action":"none"});var a=!1,h={},r=function(f){var p=f.originalEvent.pointerId,c="pen"==f.originalEvent.pointerType&&
5==f.originalEvent.button,b=l.offset(),u=f.pageX-b.left,b=f.pageY-b.top,r=f.originalEvent.pressure||.5,e=screenToWorld(u,b),m=h[p]||{pointerId:p,pointerType:f.originalEvent.pointerType,eraser:c,points:[]};m.points.push({x:e.x,y:e.y,screenX:u,screenY:b,z:r});m.eraser=m.eraser||c;h[p]=m;1<_.size(h)&&(0==a&&_.each(h,function(f){f.points=[_.last(f.points)]}),a=!0);return{pointerType:f.pointerType,eraser:m.eraser,x:u,y:b,z:r,worldPos:e}},x=function(f){var p=f.originalEvent.pointerId,b="pen"==f.originalEvent.pointerType&&
5==f.originalEvent.button,u=l.offset(),r=f.pageX-u.left,u=f.pageY-u.top,m=f.originalEvent.pressure||.5,e=screenToWorld(r,u);delete h[p];a&&0==_.size(h)&&(c=a=!1);return{pointerType:f.pointerType,eraser:b,x:r,y:u,z:m,worldPos:e}};if(detectPointerEvents()){var m=_.throttle(function(){if(1<_.size(h)){takeControlOfViewbox();var f=_.map(_.filter(h,function(f){return 0<_.size(f.points)}),function(f){var a=_.first(f.points);f=_.last(f.points);return[a,f]});h={};var a=_.meanBy(f,function(f){return f[0].x-
f[1].x}),c=_.meanBy(f,function(f){return f[0].y-f[1].y});Pan.translate(scaleWorldToScreen(a),scaleWorldToScreen(c));var a=_.min(_.map(f,function(f){return f[0].y})),b=_.max(_.map(f,function(f){return f[0].y})),c=_.min(_.map(f,function(f){return f[0].x})),u=_.max(_.map(f,function(f){return f[0].x})),a=b-a,c=u-c,u=_.min(_.map(f,function(f){return f[1].y})),b=_.max(_.map(f,function(f){return f[1].y})),r=_.min(_.map(f,function(f){return f[1].x})),f=(_.max(_.map(f,function(f){return f[1].x}))-r+(b-u))/
2;Zoom.scale((c+a)/2/f)}},25);l.bind("pointerdown",function(f){var p=r(f);f.preventDefault();WorkQueue.pause();1!=_.size(h)||a||(c=!0,q(p.worldPos,"down")&&d(p.x,p.y,p.z,p.worldPos,e(f,p.eraser)))});l.bind("pointermove",function(f){var p=r(f);f.preventDefault();(f.originalEvent.pointerType==f.POINTER_TYPE_TOUCH||"touch"==f.originalEvent.pointerType&&1<_.size(h))&&m();1!=_.size(h)||a||q(p.worldPos,"move")&&c&&g(p.x,p.y,p.z,p.worldPos,e(f,p.eraser))});l.bind("pointerup",function(f){var p=x(f);WorkQueue.gracefullyResume();
f.preventDefault();q(p.worldPos,"up")&&c&&!a&&k(p.x,p.y,p.z,p.worldPos,e(f,p.eraser));c=!1;Modes.finishInteractableStates()});var A=function(f){x(f);WorkQueue.gracefullyResume();f.preventDefault();if(c){var a=f.offsetX;f=f.offsetY;h={};WorkQueue.gracefullyResume();f=screenToWorld(a,f);a=f.x;f=f.y;a<viewboxX?(takeControlOfViewbox(),Extend.left()):a>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):f<viewboxY?(takeControlOfViewbox(),Extend.up()):f>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),
Extend.down());c=!1;Modes.finishInteractableStates()}c=!1;Modes.finishInteractableStates()};l.bind("pointerout",A);l.bind("pointerleave",A);l.bind("pointercancel",A)}else{l.bind("mousedown",function(f){WorkQueue.pause();var a=l.offset();c=!0;var h=f.pageX-a.left,a=f.pageY-a.top,b=screenToWorld(h,a);q(b,"down")&&d(h,a,.5,b,e(f));f.preventDefault()});l.bind("mousemove",function(f){var a=l.offset();f.preventDefault();var h=f.pageX-a.left,a=f.pageY-a.top,b=screenToWorld(h,a);q(b,"move")&&c&&g(h,a,.5,
b,e(f))});l.bind("mouseup",function(f){WorkQueue.gracefullyResume();f.preventDefault();var a=l.offset(),h=f.pageX-a.left,a=f.pageY-a.top,b=screenToWorld(h,a);q(b,"up")&&c&&k(h,a,.5,b,e(f));c=!1;Modes.finishInteractableStates()});var z=function(f,a){WorkQueue.gracefullyResume();var h=screenToWorld(f,a),b=h.x,h=h.y;b<viewboxX?(takeControlOfViewbox(),Extend.left()):b>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):h<viewboxY?(takeControlOfViewbox(),Extend.up()):h>=viewboxY+viewboxHeight&&
(takeControlOfViewbox(),Extend.down());c=!1};l.bind("mouseout",function(f){WorkQueue.gracefullyResume();f.preventDefault();c&&z(f.offsetX,f.offsetY);c=!1;Modes.finishInteractableStates()});var t,y=function(f){return{x:average(_.map(f,"x")),y:average(_.map(f,"y"))}},v=function(f){var a=[],c=l.offset();$.each(f,function(f,h){a.push({x:h.pageX-c.left,y:h.pageY-c.top,identifier:h.identifier})});return a};l.bind("touchstart",function(f){WorkQueue.pause();f.preventDefault();var a=v(f.originalEvent.touches);
if(1==a.length){var a=a[0],h=screenToWorld(a.x,a.y);c=!0;q(h,"down")&&d(a.x,a.y,.5,h,e(f))}else t=y(a)});l.bind("touchmove",function(f){f.preventDefault();var a=v(f.originalEvent.touches);switch(a.length){case 0:break;case 1:var a=a[0],h=screenToWorld(a.x,a.y);q(h,"move")&&c&&g(a.x,a.y,.5,h,e(f));break;default:f=y(a),a=f.x-t.x,h=f.y-t.y,t=f,takeControlOfViewbox(),Pan.translate(-1*a,-1*h)}});l.bind("touchend",function(f){WorkQueue.gracefullyResume();f.preventDefault();var a=l.offset(),h=f.originalEvent.changedTouches[0],
b=h.pageX-a.left,a=h.pageY-a.top,h=screenToWorld(b,a);q(h,"up")&&c&&(0>b||0>a||b>boardWidth||a>boardHeight?z(b,a):k(b,a,.5,h,e(f)));c=!1;Modes.finishInteractableStates()});var u=1;l.bind("gesturechange",function(a){WorkQueue.pause();a.preventDefault();c=!1;a=a.originalEvent.scale;takeControlOfViewbox();Zoom.scale(u/a);u=a});l.bind("gestureend",function(){WorkQueue.gracefullyResume();u=1})}});return function(b){c=b}}
function aspectConstrainedDimensions(b,d){var g=boardHeight/boardWidth,k={height:d,width:b};d/b>g?k.height=b*g:k.width=d/g;return k}
function aspectConstrainedRect(b,d,g){var k=boardHeight/boardWidth,c={left:b.left,top:b.top,right:b.right,bottom:b.bottom,width:b.width,height:b.height};b.height/b.width>k?(c.height=b.width*k,g&&(d=b.height-c.height,"center"==g?c.top+=d/2:"bottom"==g&&(c.top+=d))):(c.width=b.height/k,d&&(g=b.width-c.width,"center"==d?c.left+=g/2:"right"==d&&(c.left+=g)));c.right=c.left+c.width;c.bottom=c.top+c.height;return c}
function copyBuffer(b){var d=document.createElement("canvas");d.width=b.width;d.height=b.height;d.getContext("2d").drawImage(b,0,0,b.width,b.height,0,0,b.width,b.height);return d}function intersectRect(b,d){return"undefined"!=typeof b&&"undefined"!=typeof d?!(d[0]>b[2]||d[2]<b[0]||d[1]>b[3]||d[3]<b[1]):!1}function overlapRect(b,d){return intersectRect(b,d)?(Math.max(b[0],d[0])-Math.min(b[2],d[2]))*(Math.max(b[1],d[1])-Math.min(b[3],d[3])):0}
function rectFromTwoPoints(b,d,g){g=g||0;var k,c,q;b.x<d.x?(k=b.x,q=d.x):(k=d.x,q=b.x);b.y<d.y?(c=b.y,b=d.y):(c=d.y,b=b.y);d=q-k;var e=b-c;d<g&&(q+=g-d,d=q-k);e<g&&(b+=g-e,e=b-c);return{left:k,top:c,right:q,bottom:b,width:d,height:e}}function updateMarquee(b,d,g){d=rectFromTwoPoints(d,g);g=$("#selectionAdorner");jQuery.contains(g,b)||g.append(b);b.is(":visible")||b.show();b.css({left:px(d.left),top:px(d.top),width:px(d.width),height:px(d.height)})}
function clampToView(b){var d=b.x,g=b.y;0>b.x&&(d=0);b.x>boardWidth&&(d=boardWidth);0>b.y&&(g=0);b.y>boardHeight&&(g=boardHeight);return{x:d,y:g}}
var bounceButton=function(b){var d=$(b);d.addClass("activeBrush");setTimeout(function(){d.removeClass("activeBrush")},200)},videoControlInteractable=function(b){var d=void 0;return{activated:!1,rehome:function(b){},down:function(b){return!1},move:function(b){return!1},up:function(d){var k=Modes.select.handlesAtZoom();d=d.x-b.x;if(d<k)b.getState().paused?b.play():b.pause();else if(d>b.width-k)b.muted(!b.muted());else{var c=b.getState();b.seek((d-k)/(b.width-2*k)*c.duration)}return!1},getBounds:function(){return d},
deactivate:function(){},render:function(g){if(b.identity in boardContent.videos){var k=Modes.select.handlesAtZoom();d=[b.bounds[0],b.bounds[3],b.bounds[2],b.bounds[3]+k];var k=worldToScreen(d[0],d[1]),c=worldToScreen(d[2],d[3]),q=c.x-k.x,e=c.y-k.y,n=b.getState();g.globalAlpha=1;g.setLineDash([]);g.strokeStyle="black";g.font=sprintf("%spx FontAwesome",e);g.fillStyle="white";g.fillRect(k.x,k.y,e,e);g.fillStyle="black";n.paused?g.fillText("\uf04b",k.x,c.y):g.fillText("\uf04c",k.x,c.y);var w=k.x+e,l=
q-e;g.fillStyle="black";g.fillRect(w,k.y,l,e);g.fillStyle="blue";l*=n.currentTime/n.duration;g.fillRect(w,k.y,l,e);q=k.x+(q-e);g.fillStyle="white";g.fillRect(q,k.y,e,e);g.fillStyle="black";n.muted?g.fillText("\uf0f3",q,c.y):g.fillText("\uf1f6",q,c.y)}}}},Modes=function(){var b=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},d=function(c,d){b();$(c).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$(d).addClass("activeTool").removeClass("inactiveTool")},g={name:"none",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.none;b()},deactivate:function(){b();unregisterPositionHandlers(board)}},k=function(c,b){c in Modes.canvasInteractables||(Modes.canvasInteractables[c]=[]);Modes.canvasInteractables[c].push(b)};$(function(){var c={opacity:1};(new TWEEN.Tween(c)).delay(1E3).to({opacity:.3},1E3);var b=Modes.select.handlesAtZoom(),e=function(){var d=void 0;return{getBounds:function(){return d},
activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!e.activated){var c=Modes.select.handlesAtZoom(),b=a.x+c/2;d=[b-c/2,a.y-c,b+c/2,a.y]}},down:function(a){e.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=a;Modes.select.marqueeWorldOrigin=a;blit()},move:function(a){e.activated&&(e.bounds=[a.x-b,a.y,a.x+b,a.y],Modes.select.offset=a,blit());return!1},deactivate:function(){e.activated=!1;Modes.select.dragging=!1},up:function(a){e.deactivate();var c=
batchTransform(),b=a.x-Modes.select.marqueeWorldOrigin.x,d=a.y-Modes.select.marqueeWorldOrigin.y;c.xTranslate=b;c.yTranslate=d;c.inkIds=_.keys(Modes.select.selected.inks);c.textIds=_.keys(Modes.select.selected.texts);c.imageIds=_.keys(Modes.select.selected.images);c.videoIds=_.keys(Modes.select.selected.videos);c.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(c.multiWordTextIds,function(a){Modes.text.echoesToDisregard[a]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(a){a.doc.position.x+=
b;a.doc.position.y+=d;a.doc.invalidateBounds()});sendStanza(c);registerTracker(c.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(a){if(d){var b=worldToScreen(d[0],d[1]),r=worldToScreen(d[2],d[3]).x-b.x,e=b.x,b=b.y;a.globalAlpha=c.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.fillRect(e,b,r,r);a.strokeRect(e,b,r,r);a.font=sprintf("%spx FontAwesome",r);a.fillStyle="black";a.fillText("\uf047",e,b+r-4)}}}}(),d=function(){var e=
void 0;return{getBounds:function(){return e},activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!d.activated){var c=Modes.select.handlesAtZoom(),b=a.x2;a=a.y;e=[b,a,b+c,a+c]}},down:function(a){Modes.select.aspectLocked=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;d.activated=!0;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};d.rehome(a);blit();return!1},move:function(a){if(d.activated){e=[a.x-b,e[1],a.x+b,e[3]];var c=Modes.select.totalSelectedBounds();
Modes.select.offset={x:a.x,y:c.y+(a.x-c.x)/(c.x2-c.x)*c.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;d.activated=!1;Modes.select.resizing=!1},up:function(a){d.deactivate();var c=batchTransform(),b=Modes.select.totalSelectedBounds();c.xScale=(a.x-b.x)/(b.x2-b.x);c.yScale=c.xScale;c.xOrigin=b.x;c.yOrigin=b.y;c.inkIds=_.keys(Modes.select.selected.inks);c.textIds=_.keys(Modes.select.selected.texts);c.imageIds=_.keys(Modes.select.selected.images);c.videoIds=_.keys(Modes.select.selected.videos);
c.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0;var d=a.doc.save();_.each(d,function(a){a.size*=c.xScale});a.doc.width(a.doc.width()*c.xScale);a.doc.load(d)});registerTracker(c.identity,function(){Progress.call("onSelectionChanged")});sendStanza(c);return!1},render:function(a){if(e){var b=worldToScreen(e[0],e[1]),d=worldToScreen(e[2],e[3]).x-b.x,g=d/10,m=-1*d;a.globalAlpha=c.opacity;a.setLineDash([]);
a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(b.x,b.y);a.rotate(90*Math.PI/180);a.fillRect(0,m,d,d);a.strokeRect(0,m,d,d);a.font=sprintf("%spx FontAwesome",d);a.fillStyle="black";a.fillText("\uf0b2",g,-1*g)}}}}(),g=function(){var d=void 0;return{activated:!1,getBounds:function(){return d},rehome:function(a){if(!g.activated){var c=Modes.select.handlesAtZoom(),b=a.x2;a=a.y2;d=[b,a-c,b+c,a]}},down:function(a){g.activated=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=
!1;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();return!1},move:function(a){g.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),g.bounds=[a.x-b,a.y-b,a.x+b,a.y+b],Modes.select.offset={x:a.x,y:a.y},blit());return!1},deactivate:function(){g.activated=!1;Modes.select.resizing=!1},up:function(a){g.deactivate();var c=batchTransform(),b=Modes.select.totalSelectedBounds(),d=b.y2-b.y,e=a.y-b.y;c.xScale=(a.x-b.x)/(b.x2-b.x);c.yScale=e/d;c.xOrigin=b.x;c.yOrigin=b.y;c.inkIds=
_.keys(Modes.select.selected.inks);c.textIds=_.keys(Modes.select.selected.texts);c.imageIds=_.keys(Modes.select.selected.images);c.videoIds=_.keys(Modes.select.selected.videos);_.each(Modes.select.selected.multiWordTexts,function(a){a.doc.width(Math.max(a.doc.width()*c.xScale,Modes.text.minimumWidth/scale()));0<a.doc.save().length&&sendRichText(a)});Modes.text.invalidateSelectedBoxes();registerTracker(c.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(c);blit();return!1},
render:function(a){if(d){var b=worldToScreen(d[0],d[1]),e=worldToScreen(d[2],d[3]).x-b.x,g=e/10,m=-1*e;a.globalAlpha=c.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(b.x,b.y);a.rotate(90*Math.PI/180);a.fillRect(0,m,e,e);a.strokeRect(0,m,e,e);a.font=sprintf("%spx FontAwesome",e);a.fillStyle="black";a.fillText("\uf065",g,-1*g)}}}}();k("manualMove",e);k("resizeFree",g);k("resizeAspectLocked",d);Progress.textBoundsChanged.selectionHandles=function(c,a){if(c in
Modes.select.selected.multiWordTexts){var b=Modes.select.totalSelectedBounds();e.rehome(b);g.rehome(b);d.rehome(b)}};Progress.onSelectionChanged.selectionHandles=function(){var b=Modes.select.totalSelectedBounds();Infinity==b.x?c.opacity=0:(c.opacity=1,e.rehome(b),g.rehome(b),d.rehome(b))}});return{pushCanvasInteractable:k,clearCanvasInteractables:function(c){Modes.canvasInteractables[c]=[]},currentMode:g,none:g,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),
function(c){_.forEach(Modes.canvasInteractables[c],function(c){void 0!=c&&"deactivate"in c&&c.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var c=function(){},g,e,n,k,l,a,h,r,x,m,A,z=function(a,c){var b=Modes.text.minimumWidth/scale(),b=Modes.text.editorFor({bounds:[a.x,a.y,a.x,a.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),slide:Conversations.getCurrentSlideJid(),
target:"presentationSpace",requestedWidth:b,width:b,height:0,x:a.x,y:a.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});b.doc.load(c);return b},t=function(a){return function(){var c=!1;_.each(boardContent.multiWordTexts,function(b){if(b.doc.isActive){c=!0;var d=b.doc.selectedRange();carota.runs.nextInsertFormatting={};d.setFormatting(a,!0!==d.getFormatting()[a]);0<b.doc.save().length&&sendRichText(b)}});if(!c){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};
var b=carota.runs.nextInsertFormatting[a]=!carota.runs.nextInsertFormatting[a];$(sprintf(".font%sSelector",_.capitalize(a))).toggleClass("active",b)}}},y=function(a,c){return function(){var b=!1;c=c||$(this).val();_.each(boardContent.multiWordTexts,function(d){d.doc.isActive&&(b=!0,carota.runs.nextInsertFormatting={},d.doc.selectedRange().setFormatting(a,c),0<d.doc.save().length&&sendRichText(d))});b||(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[a]=
c)}},v=function(a){return function(){_.each(boardContent.multiWordTexts,function(c){var b=c.doc;if(b.isActive){b.save();var d=b.selectedRange(),e=d.start,d=d.end,h=e,m=e,g=[];b.select(0,d,!0);var t=0;b.runs(function(a){var c=t+_.size(a.text);b.select(t,c,!0);var f=b.selectedRange().getFormatting();g.push({start:t,end:c,run:a,formatting:f});t=c},b.selectedRange());b.select(e,d,!0);b.runs(function(c){h=m;m=h+c.text.length;b.select(h,m,!0);c=b.selectedRange().getFormatting().size;if(void 0==c){var f=
_.findLast(g,function(a){return"formatting"in a&&"size"in a.formatting&&a.end<=m});void 0!=f&&"formatting"in f&&"size"in f.formatting&&(c=f.formatting.size)}void 0!=c&&b.selectedRange().setFormatting("size",c*a)},b.selectedRange());b.select(e,d,!0);0<b.save().length&&sendRichText(c)}})}};$(function(){k=$(".fontBoldSelector");l=$(".fontItalicSelector");a=$(".fontUnderlineSelector");x=$("#textDropdowns");r=$("#fontOptions");g=$("#fontFamilySelector");e=$("#fontSizeSelector");n=$("#fontColorSelector");
m=$("#fontLarger");A=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");h=$("#presetFullscreen");$("#presetCenterOnScreen");var c=g.find(".fontFamilyOption").clone(),b=e.find(".fontSizeOption").clone(),d=n.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(a){g.append(c.clone().attr("value",a).text(a))});Fonts.getAllSizes().map(function(a){e.append(b.clone().attr("value",a).text(a))});Colors.getAllNamedColors().map(function(a){n.append(d.clone().attr("value",
a.rgb).text(a.name))});m.click(v(1.2));A.click(v(.8));k.click(t("bold"));l.click(t("italic"));a.click(t("underline"));var C={red:"#ff0000",blue:"#0000ff",black:"#000000"};_.each(["red","blue","black"],function(a){$(sprintf("#%sText",a)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");y("color",[C[a],255])()})});h.click(function(a){return function(){_.each(boardContent.multiWordTexts,function(c){if(c.doc.isActive){switch(a){case "runToEdge":var b=screenToWorld(boardWidth,
0);c.doc.width(b.x+viewboxX-c.x);break;case "fitToText":c.doc.width(c.doc.frame.actualWidth());break;case "widen":c.doc.width(1.6*c.doc.frame.actualWidth());break;case "narrow":c.doc.width(.6*c.doc.frame.actualWidth());break;case "centerOnScreen":c.doc.width(screenToWorld(boardWidth,0).x);c.doc.selectedRange().setFormatting("align","center");c.doc.position.x=viewboxX;break;case "fullscreen":c.doc.position.x=viewboxX,c.doc.position.y=viewboxY,c.doc.width(screenToWorld(boardWidth,0).x)}c.doc.contentChanged.fire()}})}}("fullscreen"));
r.click(function(){x.toggle()});$("#closeTextDialog").click(function(){x.hide()});$("#exitTextEditing").click(function(){Modes.select.activate()})});return{echoesToDisregard:{},minimumWidth:240,minimumHeight:function(){return 3*Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},mapSelected:function(a){var c=Modes.select.selected.multiWordTexts;
_.each(boardContent.multiWordTexts,function(b){b.identity in c&&a(b)})},scrollToCursor:function(a){var c=a.bounds,b=a.doc.selectedRange().start;a=a.doc.getCaretCoords(b);var b=Math.floor(a.t/a.h),d=Math.floor(scaleScreenToWorld(boardContext.height)/a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var b=Math.min(b,Math.max(0,d-2))*a.h,d=Math.max(c[2]-c[0],scaleWorldToScreen(10*a.h)),e=d/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(c[0],c[1]-b+a.t,
d,e)}else c=Math.max(0,Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(c[1]-viewboxY))/a.h)-4))*a.h,0!=c&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+c,viewboxWidth,viewboxHeight)},editorFor:function(b){var f=boardContent.multiWordTexts[b.identity];f||(f=boardContent.multiWordTexts[b.identity]=b);if(!f.doc){var d=b.author==UserSettings.getUsername();f.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",b.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],d?blit:c,b);d&&(f.doc.contentChanged(function(){Modes.text.scrollToCursor(f);
var a=boardContent.multiWordTexts[f.identity];a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);incorporateBoardBounds(f.bounds)}),f.doc.selectionChanged(function(c,b){if(0<f.doc.save().length){var d=c();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var e=[$("#blackText"),$("#redText"),$("#blueText")],h=function(a,c){var b=1==d[c];b&&(carota.runs.nextInsertFormatting[c]=b);a.toggleClass("active",b)},m=function(a,c,b){var f=_.isEqual(d[c],
b);c in d&&f&&(carota.runs.nextInsertFormatting[c]=b);a.toggleClass("active",f)};h(k,"bold");h(l,"italic");h(a,"underline");m(e[0],"color",["#000000",255]);m(e[1],"color",["#ff0000",255]);m(e[2],"color",["#0000ff",255]);b&&Modes.text.scrollToCursor(f)}}))}f.doc.position={x:b.x,y:b.y};f.doc.width(b.width);return f},draw:function(a){a&&a.doc&&carota.editor.paint(board[0],a.doc,!0)},editorAt:function(a,c,b,d){var e=UserSettings.getUsername(),h=[d.x-10,d.y-10,d.x+10,d.y+10];a=_.values(boardContent.multiWordTexts).filter(function(a){var c=
intersectRect(a.bounds,h);c&&(console.log("intersects",a.bounds,h),console.log(sprintf("%s clicked box by %s",Participants.code(e),Participants.code(a.author))));return c&&a.author==e});return 0<a.length?a[0]:!1},contextFor:function(a,c){var b={x:c.x-a.position.x,y:c.y-a.position.y};return{node:a.byCoordinate(b.x,b.y),relativePos:b}},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;d("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");
var a=Date.now();registerPositionHandlers(board,function(a,c,b,d){if(a=Modes.text.editorAt(a,c,b,d).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,d).node)},function(a,c,b,d){(a=Modes.text.editorAt(a,c,b,d).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,d).node)},function(c,b,d,e){var h=Date.now(),m=Modes.text.editorAt(c,b,d,e);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=a.doc.identity==m.identity;0==a.doc.save().length&&delete boardContent.multiWordTexts[a.identity]});
Modes.select.clearSelection();m?(c=m.doc,e=Modes.text.contextFor(c,e),500>=h-a&&c.dblclickHandler(e.node),a=h,h={multiWordTexts:{}},h.multiWordTexts[m.identity]=m,Modes.select.setSelection(h),c.mouseupHandler(e.node)):(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},c=z(e,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||
carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.size/scale()}]),e=c.doc,e.select(0,1),boardContent.multiWordTexts[c.identity]=c,h={multiWordTexts:{}},h.multiWordTexts[c.identity]=boardContent.multiWordTexts[c.identity],Modes.select.setSelection(h),m=c,h=e.byOrdinal(0),e.mousedownHandler(h),e.mouseupHandler(h));m.doc.invalidateBounds();m.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(m);Progress.call("onSelectionChanged",
[Modes.select.selected])})},deactivate:function(){DeviceConfiguration.setKeyboard(!1);b();x.hide();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=!1;0==_.trim(a.doc.save()).length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();blit()}}}(),video:function(){var c={},g=void 0,e=void 0,n=function(){g.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=e.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();
e.unwrap()},k=function(a){if(void 0!=c&&void 0!=c.fileUpload&&void 0!=a){$("#videoWorking").show();$("#videoFileChoice").hide();var b=new FileReader;b.onload=function(b){var d=$("<video/>"),e=d[0],g=b.target.result;e.addEventListener("loadeddata",function(b){b=e.videoHeight;c.width=e.videoWidth;c.height=b;c.video=d;c.videoSrc=g;a()},!1);d.append($("<source />",{src:g,type:"video/mp4"}));d.load()};b.readAsDataURL(c.fileUpload)}},l=function(){if("imageDefinition"==c.type){WorkQueue.pause();var a=Date.now(),
b=sprintf("%s%s",UserSettings.getUsername(),a),d=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),encodeURI(b));$.ajax({url:b,type:"POST",success:function(b){var e=$(b).find("resourceUrl").text(),g={type:"video",author:UserSettings.getUsername(),timestamp:a,identity:e,slide:d.toString(),source:$(b).text(),bounds:[c.x,c.y,c.x+c.width,c.y+c.height],width:c.width,height:c.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:c.x,y:c.y};registerTracker(e,
function(){var a=Modes.select.handlesAtZoom(),c=g.x,b=g.y,d=Math.max(g.width,viewboxWidth),f=Math.max(g.height,viewboxHeight);Modes.select.activate();IncludeView.specific(c-a,b-a,d+2*a,f+2*a);Modes.select.clearSelection();Modes.select.selected.videos[g.identity]=boardContent.videos[g.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(g);n();WorkQueue.gracefullyResume()},error:function(a){console.log(a);resetImageUpload();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:c.videoSrc,cache:!1,contentType:!1,processData:!1})}},a=!1;$(function(){a||(a=!0,g=$("#videoInsertOptions").css({position:"absolute",left:0,top:0}),$("#videoInsertOptionsClose").click(Modes.select.activate),e=$("#videoFileChoice").attr("accept","video/mp4"),e[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("video")&&(c.fileUpload=a);k(l)},!1),n())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=
Modes.video;d("#videoTools","#videoMode");var a=screenToWorld(10,10);c={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");g.show()},deactivate:function(){n();b()}}}(),image:function(){var c={},g=void 0,e=void 0,n=function(){g.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=e.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();e.unwrap()},k=function(){var a=function(a,c,b,d){for(var f=c*b;f>a;)c*=.8,b*=.8,f=c*b;return{w:c,h:b,q:d}},
c={"native":{resizeFunc:function(a,c){return{w:a,h:c,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(c,b){return a(1*d,c,b,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(c,b){return a(3*d,c,b,.8)},selector:"#imageInsertHighDef"}},b=c.optimized,d=1048576,e=function(){_.forEach(c,function(a){var c=$(a.selector);b.selector==a.selector?c.addClass("activeBrush"):c.removeClass("activeBrush")})};$(function(){_.forEach(c,function(a){$(a.selector).on("click",function(){b=
a;e()})});e()});return{reapplyVisualStyle:e,changeMode:function(a){a in c&&(b=c[a],e())},getResizeFunction:function(){return b.resizeFunc}}}(),l=function(a){if(void 0!=c&&void 0!=c.fileUpload&&void 0!=a){$("#imageWorking").show();$("#imageFileChoice").hide();var b=new FileReader;b.onload=function(b){var d=$("<canvas/>"),e=new Image,h=b.target.result,g=h.length;e.onload=function(b){var m=e.width,f=e.height,p=k.getResizeFunction()(m,f);b=p.w;var n=p.h,p=p.q;d.width=m;d.height=f;d.attr("width",m);d.attr("height",
f);d.css({width:px(m),height:px(f)});d[0].getContext("2d").drawImage(e,0,0,m,f);m=multiStageRescale(d[0],b,n);c.width=b;c.height=n;c.resizedImage=m.toDataURL("image/jpeg",p);g<c.resizedImage.length&&(c.resizedImage=h);a()};e.src=h};b.readAsDataURL(c.fileUpload)}},a=function(){if("imageDefinition"==c.type){WorkQueue.pause();var a=Date.now(),b=sprintf("%s%s",UserSettings.getUsername(),a),d=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),encodeURI(b));$.ajax({url:b,
type:"POST",success:function(b){var e=$(b).find("resourceUrl").text(),h={type:"image",author:UserSettings.getUsername(),timestamp:a,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+e+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:e,slide:d.toString(),source:$(b).text(),bounds:[c.x,c.y,c.x+c.width,c.y+c.height],width:c.width,height:c.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:c.x,y:c.y};registerTracker(e,
function(){var a=Modes.select.handlesAtZoom(),b=h.x,c=h.y,d=Math.max(h.width,viewboxWidth),e=Math.max(h.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,d+2*a,e+2*a);Modes.select.clearSelection();Modes.select.selected.images[h.identity]=boardContent.images[h.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(h);n();WorkQueue.gracefullyResume()},error:function(a){console.log(a);n();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:c.resizedImage,cache:!1,contentType:!1,processData:!1})}},h=!1;$(function(){h||(h=!0,g=$("#imageInsertOptions").css({position:"absolute",left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),e=$("#imageFileChoice").attr("accept","image/*"),e[0].addEventListener("change",function(b){b=(b.target.files||b.dataTransfer.files)[0];0==b.type.indexOf("image")&&(c.fileUpload=b);l(a)},!1),n())});return{activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.image;d("#imageTools","#imageMode");var a=screenToWorld(10,10);c={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");k.reapplyVisualStyle();g.show()},deactivate:function(){n();b()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");Modes.currentMode.deactivate();d("#panTools","#panMode");Modes.currentMode=Modes.pan;var b,g;registerPositionHandlers(board,function(d,n,k){takeControlOfViewbox();b=d;g=n},function(d,n,k){Pan.translate(-1*
(d-b),-1*(n-g));b=d;g=n},function(b,c,d){})},deactivate:function(){b();unregisterPositionHandlers(board)}},select:function(){var c=!1,g=function(){Modes.select.selected={images:{},text:{},inks:{},multiWordTexts:{},videos:{}};Progress.call("onSelectionChanged",[Modes.select.selected])},e=_.debounce(function(){var a=!1;_.forEach("images texts inks highlighters multiWordTexts videos".split(" "),function(b){var c="highlighters"==b?"inks":b;if(Modes&&Modes.select&&Modes.select.selected&&c in Modes.select.selected){var d=
Modes.select.selected[c];_.forEach(d,function(e){d&&b in boardContent&&e&&e.identity in boardContent[b]?d[e.identity]=boardContent[b][e.identity]:(a=!0,"inks"==c?"highlighters"==b&&e.identity in d&&1==d[e.identity].isHighlighter?delete d[e.identity]:"inks"==b&&e.identity in d&&0==d[e.identity].isHighlighter&&delete d[e.identity]:delete d[e.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),n=function(){if(void 0!=Modes.select.selected&&c&&"Blacklist"in window){var a=
Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),a.inks,a.texts,a.multiWordTexts,a.images,a.videos)}g()},k=function(){(c=Conversations.shouldModifyConversation()?!c:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");g()},l=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),$("#ban").removeClass("disabledButton"),$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):
($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());c?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=e;Progress.onViewboxChanged.ModesSelect=e;Progress.onSelectionChanged.ModesSelect=function(a){a&&(Modes.select.selected=a,"images"in a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||
"multiWordTexts"in a&&0<_.size(a.multiWordTexts)||"videos"in a&&0<_.size(a.videos)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),c?($("#ban").removeClass("disabledButton"),$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?
$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=g;Progress.conversationDetailsReceived.ModesSelect=function(a){c&&!Conversations.shouldModifyConversation(a)&&(c=!1);Conversations.shouldModifyConversation(a)?($("#administerContent").unbind("click").bind("click",k),$("#ban").unbind("click").bind("click",n)):($("#administerContent").unbind("click"),$("#ban").unbind("click"));l(a)};return{name:"select",selected:{images:{},
texts:{},inks:{},multiWordTexts:{},videos:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,
b);_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,b);_.forEach(Modes.select.selected.videos,b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:g,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;d("#selectTools","#selectMode");var a=
{x:0,y:0},b=$("<div/>",{id:"selectMarquee"}),e=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&!c){var a=batchTransform();a.isDeleted=!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&(a.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));
"videos"in Modes.select.selected&&(a.videoIds=_.keys(Modes.select.selected.videos));sendStanza(a);g()}});var n=function(a){a("images");a("texts");a("multiWordTexts");a("inks");a("videos")};Modes.select.dragging=!1;l();Modes.select.resizing=!1;registerPositionHandlers(board,function(c,d,g,n,k){Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:c,y:d};Modes.select.marqueeWorldOrigin=n;if(!k.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){c=10/scale();var v=[n.x-c,n.y-c,n.x+c,n.y+c];Modes.select.dragging=
_.some(["images","texts","inks","multiWordTexts","videos"],function(a){return _.some(Modes.select.selected[a],function(a){return a?intersectRect(a.bounds,v):!1})})}Modes.select.dragging?(Modes.select.offset=n,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(e.empty(),e.append(b),b.show(),updateMarquee(b,a,a))},function(c,d,e,g,n){c={x:c,y:d};Modes.select.offset=g;Modes.select.dragging?blit():Modes.select.resizing?blit():updateMarquee(b,a,c)},function(a,d,e,g,
k){WorkQueue.gracefullyResume();try{var v=g.x-Modes.select.marqueeWorldOrigin.x,l=g.y-Modes.select.marqueeWorldOrigin.y;15>Math.abs(v)+Math.abs(l)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=v;a.doc.position.y+=l;a.doc.invalidateBounds()});var f=batchTransform();f.xTranslate=v;f.yTranslate=l;f.inkIds=_.keys(Modes.select.selected.inks);
f.textIds=_.keys(Modes.select.selected.texts);f.imageIds=_.keys(Modes.select.selected.images);f.videoIds=_.keys(Modes.select.selected.videos);f.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(f.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(f)}else{var p=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,g,2),q=[p.left,p.top,p.right,p.bottom],w={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},r={},B={};n(function(a){$.each(boardContent[a],
function(b,d){if(!("bounds"in d)&&"type"in d)switch(d.type){case "text":prerenderText(d);break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;case "video":prerenderVideo(d);break;default:d.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(q,d.bounds)&&(incrementKey(r,d.author),incrementKey(B,"any"),c?d.author!=UserSettings.getUsername()&&(w[a][d.identity]=d):d.author==UserSettings.getUsername()&&(w[a][d.identity]=d))})});$.each(boardContent.highlighters,function(a,b){intersectRect(b.bounds,
q)&&(incrementKey(r,b.author),c?b.author!=UserSettings.getUsername()&&(w.inks[b.identity]=b):b.author==UserSettings.getUsername()&&(w.inks[b.identity]=b))});n(function(a){$.each(w[a],function(b,c){a in Modes.select.selected||(Modes.select.selected[a]=[]);a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=c})});B.any||Modes.select.clearSelection();var D=sprintf("Selected %s images, %s texts, %s inks, %s rich texts, %s videos ",_.keys(Modes.select.selected.images).length,
_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,_.keys(Modes.select.selected.inks).length,_.keys(Modes.select.selected.videos).length);$.each(r,function(a,b){D+=sprintf("%s:%s ",a,b)});Progress.call("onSelectionChanged",[Modes.select.selected])}b.css({width:0,height:0}).hide();blit()}catch(E){console.log("Selection up",E)}})},deactivate:function(){unregisterPositionHandlers(board);b();g();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();
$("#selectMarquee").hide();l();blit();blit()}}}(),zoom:{name:"zoom",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;d("#zoomTools","#zoomMode");var b=$("<div />",{id:"zoomMarquee"}),g,e={x:0,y:0};registerPositionHandlers(board,function(d,k,l,a){takeControlOfViewbox();g=a;b.show();b.appendTo($("#selectionAdorner"));e={x:d,y:k};updateMarquee(b,e,e)},function(d,g,k,a){d={x:d,y:g};g=rectFromTwoPoints(d,e);k="left";a="top";d.x==g.left&&(k="right");d.y==g.top&&(a="bottom");
d=aspectConstrainedRect(g,k,a);updateMarquee(b,{x:d.right,y:d.bottom},{x:d.left,y:d.top})},function(d,e,k,a){WorkQueue.gracefullyResume();b.hide();d={x:contentOffsetX+a.x,y:contentOffsetY+a.y};e=rectFromTwoPoints(d,{x:contentOffsetX+g.x,y:contentOffsetY+g.y});2500>scale()*e.width*e.height||(k="left",a="top",d.x==e.left&&(k="right"),d.y==e.top&&(a="bottom"),d=aspectConstrainedRect(e,k,a),IncludeView.specific(d.left,d.top,d.width,d.height))})},deactivate:function(){b();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},
feedback:function(){var c=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){c()};Progress.conversationDetailsReceived.respectNewPermissions=c;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;c();d("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(b,c,d,g){},
function(b,c,d,g){},function(b,c,d,g){});c()},deactivate:function(){b();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),draw:function(){var c=Brushes.getDefaultBrushes(),g=_.map(c,function(a){return _.clone(a)}),e,k=!1,w=void 0,l=void 0,a=function(a){g[a.index]=a},h=function(){},r=function(){},x=function(){};$(function(){$(".activeBrush").removeClass("activeBrush");var b=function(){var b=$("#drawTools");_.each(b.find(".modeSpecificTool.pen"),function(b,c){var h=g[c],v=$(b).css({color:h.color}).click(function(){$(".activeBrush").removeClass("activeBrush");
$(this).addClass("activeBrush");e=h;a(h);Modes.draw.drawingAttributes=e;k=!1;d(h)}).removeClass("fa-tint").removeClass("fa-circle").addClass(h.isHighlighter?"fa-circle":"fa-tint");v.find(".widthIndicator").text(h.width);h==e&&v.addClass("activeBrush")})},d=function(c){var g=$("#colors .dots"),f=$("#sizes .dots"),h=Colors.getAllNamedColors(),k=Brushes.getAllBrushSizes();f.empty();k.map(function(g){var h=w.clone();f.append(h);h.click(function(){c.width=g;a(c);e=c;b();d(c)});var k=Canvas.circle(c.color,
g,50);g==c.width&&h.addClass("activeTool");h.prepend(k);k=g.toString()+"px";h.find(".sizeDotName").append(k)});g.empty();h.map(function(f){var h=l.clone();g.append(h);h.on("click",function(){c.color=f.rgb;e=c;a(c);b();d(c)});h.css("color",f.rgb);"rgb"in f&&f.rgb==c.color&&h.addClass("activeTool");var k=f.name;h.find(".colorDotName").append(k)});h=$("#setPenToHighlighter").unbind("click").on("click",function(){c.isHighlighter=!0;e=c;a(c);b();d(c)});k=$("#setPenToPen").unbind("click").on("click",function(){c.isHighlighter=
!1;e=c;a(c);b();d(c)});"isHighlighter"in e&&e.isHighlighter?(h.addClass("activeTool").addClass("active"),k.removeClass("activeTool").removeClass("active")):(k.addClass("activeTool").addClass("active"),h.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var a=_.find(c,function(a){return a.id==e.id});void 0!=a&&(e.width=a.width,e.color=a.color,e.isHighlighter=a.isHighlighter,b(),d(e))});w=$("#penSize .sizeDot").clone();l=$("#penColor .colorDot").clone();
e=g[0];b();d(e);var z=$("#drawTools");z.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");k=!0;$("#drawDropdowns").hide()});z.find(".advancedTools").unbind("click").on("click",function(){k||(d(e),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});var t=[];r=function(a,b,c,d,e){y=[];k||e.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,
boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,t=[a,b,256*c])};var y=[];x=function(a,b,c,d,e){if(k||e.eraser){var g=[d.x-10,d.y-10,d.x+10,d.y+10];a=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,g)){delete a[c.identity];y.push(c.identity);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";a(boardContent.inks);
a(boardContent.highlighters);boardContext.globalAlpha=1}else d=Modes.draw.drawingAttributes.width*c,boardContext.beginPath(),boardContext.lineCap="round",boardContext.lineWidth=d,d=_.takeRight(t,3),boardContext.moveTo(d[0],d[1]),boardContext.lineTo(a,b),boardContext.stroke(),t=t.concat([a,b,256*c])};h=function(a,b,c,d,e){k||e.eraser?(a=batchTransform(),a.isDeleted=!0,a.inkIds=y,sendStanza(a)):(d=Modes.draw.drawingAttributes.width*c,boardContext.lineWidth=d,boardContext.beginPath(),boardContext.lineWidth=
d,boardContext.lineCap="round",d=_.takeRight(t,3),boardContext.moveTo(d[0],d[1]),boardContext.lineTo(a,b),boardContext.stroke(),t=t.concat([a,b,256*c]),strokeCollected(t.join(" ")));boardContext.globalAlpha=1}});return{name:"draw",brushes:g,activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,Modes.draw.drawingAttributes=e,d("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),k?$("#drawTools").find(".eraser").addClass("activeBrush"):
_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==e.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,r,x,h))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();b();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,
function(b,d,e,g){},function(b,d,e,g){},function(b,d,e,g){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
