function devLogAdd(b){$("#devLog").append($("<div />",{text:b}))}function devLogSet(b){$("#devLog").html($("<div />",{text:b}))}var incrementKey=function(b,e){e in b?b[e]++:b[e]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(b){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(e,g){b.unbind(g)});WorkQueue.gracefullyResume()}
function progress(){var b=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),e=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(b),g=$("<progress />");g.append(b);var l=1,d=0,k=function(){e.css("width",sprintf("%s%%",Math.floor(d/l*100)));g.attr({value:d,max:l})},f={element:g,value:function(b){d=b;k();return f},max:function(d){l=d;k();return f}};return f}
function proportion(b,e){return b/e/(boardWidth/boardHeight)}function scaleScreenToWorld(b){var e;e=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b*e}function scaleWorldToScreen(b){var e;e=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b/e}function screenToWorld(b,e){var g=scaleScreenToWorld(b)+viewboxX,l=scaleScreenToWorld(e)+viewboxY;return{x:g,y:l}}
function worldToScreen(b,e){var g=scaleWorldToScreen(b-viewboxX),l=scaleWorldToScreen(e-viewboxY);return{x:g,y:l}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(b){return!1}}
function registerPositionHandlers(b,e,g,l){var d=!1,k=function(d,b){var f=[d.x-10,d.y-10,d.x+10,d.y+10],a=!0;_.each(Modes.canvasInteractables,function(q,e){_.each(q,function(q){void 0!=q&&b in q&&(q.activated||intersectRect(f,q.getBounds()))&&(a=a&&q[b](d))})});return a},f=function(d,b){return{shift:d.shiftKey,ctrl:d.ctrlKey,alt:d.altKey,eraser:b}};$.each(b,function(b,w){var m=$(w);m.css({"touch-action":"none"});var a=!1,q={},t=function(c){return void 0!==c&&"touch"==c.originalEvent.pointerType?1<
_.size(q):!1},u=function(c){var z=c.originalEvent.pointerId,d="pen"==c.originalEvent.pointerType&&5==c.originalEvent.button,h=m.offset(),b=c.pageX-h.left,h=c.pageY-h.top,n=c.originalEvent.pressure||.5,p=screenToWorld(b,h),f=q[z]||{pointerId:z,pointerType:c.originalEvent.pointerType,eraser:d,points:[]};f.points.push({x:p.x,y:p.y,screenX:b,screenY:h,z:n});f.eraser=f.eraser||d;"touch"==c.originalEvent.pointerType&&(q[z]=f);t(c)&&(0==a&&_.each(q,function(c){c.points=[_.last(c.points)]}),a=!0);return{pointerType:c.pointerType,
eraser:f.eraser,x:b,y:h,z:n,worldPos:p}},p=function(c){var z=c.originalEvent.pointerId,h="pen"==c.originalEvent.pointerType&&5==c.originalEvent.button,b=m.offset(),p=c.pageX-b.left,b=c.pageY-b.top,n=c.originalEvent.pressure||.5,f=screenToWorld(p,b);"touch"==c.originalEvent.pointerType&&delete q[z];a&&0==_.size(q)&&(d=a=!1);return{pointerType:c.pointerType,eraser:h,x:p,y:b,z:n,worldPos:f}};if(detectPointerEvents()){var B=_.throttle(function(){takeControlOfViewbox();var c=_.map(_.filter(q,function(c){return 0<
_.size(c.points)}),function(c){var a=_.first(c.points);c=_.last(c.points);return[a,c]});q={};var a=_.meanBy(c,function(c){return c[0].x-c[1].x}),h=_.meanBy(c,function(c){return c[0].y-c[1].y});Pan.translate(scaleWorldToScreen(a),scaleWorldToScreen(h));var a=_.min(_.map(c,function(c){return c[0].y})),d=_.max(_.map(c,function(c){return c[0].y})),h=_.min(_.map(c,function(c){return c[0].x})),b=_.max(_.map(c,function(c){return c[0].x})),a=d-a,h=b-h,b=_.min(_.map(c,function(c){return c[1].y})),d=_.max(_.map(c,
function(c){return c[1].y})),p=_.min(_.map(c,function(c){return c[1].x})),c=(_.max(_.map(c,function(c){return c[1].x}))-p+(d-b))/2;Zoom.scale((h+a)/2/c)},25);m.bind("pointerdown",function(c){c.originalEvent.pointerType!=c.POINTER_TYPE_TOUCH&&"touch"!=c.originalEvent.pointerType||!t(c)||(a=!0);var h=u(c);c.preventDefault();WorkQueue.pause();t(c)||a||(d=!0,k(h.worldPos,"down")&&e(h.x,h.y,h.z,h.worldPos,f(c,h.eraser)))});m.bind("pointermove",function(c){var h=u(c);c.preventDefault();c.originalEvent.pointerType!=
c.POINTER_TYPE_TOUCH&&"touch"!=c.originalEvent.pointerType||!t(c)&&!a?k(h.worldPos,"move")&&d&&g(h.x,h.y,h.z,h.worldPos,f(c,h.eraser)):B()});m.bind("pointerup",function(c){var h=p(c);WorkQueue.gracefullyResume();c.preventDefault();k(h.worldPos,"up")&&d&&!a&&l(h.x,h.y,h.z,h.worldPos,f(c,h.eraser));d=!1;Modes.finishInteractableStates()});var y=function(c){p(c);WorkQueue.gracefullyResume();c.preventDefault();if(d){var a=c.offsetX;c=c.offsetY;q={};WorkQueue.gracefullyResume();c=screenToWorld(a,c);a=c.x;
c=c.y;a<viewboxX?(takeControlOfViewbox(),Extend.left()):a>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):c<viewboxY?(takeControlOfViewbox(),Extend.up()):c>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),Extend.down());d=!1;Modes.finishInteractableStates()}d=!1;Modes.finishInteractableStates()};m.bind("pointerout",y);m.bind("pointerleave",y);m.bind("pointercancel",y)}else{m.bind("mousedown",function(c){WorkQueue.pause();var a=m.offset();d=!0;var h=c.pageX-a.left,a=c.pageY-a.top,b=
screenToWorld(h,a);k(b,"down")&&e(h,a,.5,b,f(c));c.preventDefault()});m.bind("mousemove",function(c){var a=m.offset();c.preventDefault();var h=c.pageX-a.left,a=c.pageY-a.top,b=screenToWorld(h,a);k(b,"move")&&d&&g(h,a,.5,b,f(c))});m.bind("mouseup",function(c){WorkQueue.gracefullyResume();c.preventDefault();var a=m.offset(),h=c.pageX-a.left,a=c.pageY-a.top,b=screenToWorld(h,a);k(b,"up")&&d&&l(h,a,.5,b,f(c));d=!1;Modes.finishInteractableStates()});var v=function(c,a){WorkQueue.gracefullyResume();var h=
screenToWorld(c,a),b=h.x,h=h.y;b<viewboxX?(takeControlOfViewbox(),Extend.left()):b>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):h<viewboxY?(takeControlOfViewbox(),Extend.up()):h>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),Extend.down());d=!1};m.bind("mouseout",function(c){WorkQueue.gracefullyResume();c.preventDefault();d&&v(c.offsetX,c.offsetY);d=!1;Modes.finishInteractableStates()});var x,n=function(c){return{x:average(_.map(c,"x")),y:average(_.map(c,"y"))}},A=function(c){var a=
[],h=m.offset();$.each(c,function(c,d){a.push({x:d.pageX-h.left,y:d.pageY-h.top,identifier:d.identifier})});return a};m.bind("touchstart",function(c){WorkQueue.pause();c.preventDefault();var a=A(c.originalEvent.touches);if(1==a.length){var a=a[0],h=screenToWorld(a.x,a.y);d=!0;k(h,"down")&&e(a.x,a.y,.5,h,f(c))}else x=n(a)});m.bind("touchmove",function(c){c.preventDefault();var a=A(c.originalEvent.touches);switch(a.length){case 0:break;case 1:var a=a[0],h=screenToWorld(a.x,a.y);k(h,"move")&&d&&g(a.x,
a.y,.5,h,f(c));break;default:c=n(a),a=c.x-x.x,h=c.y-x.y,x=c,takeControlOfViewbox(),Pan.translate(-1*a,-1*h)}});m.bind("touchend",function(c){WorkQueue.gracefullyResume();c.preventDefault();var a=m.offset(),h=c.originalEvent.changedTouches[0],b=h.pageX-a.left,a=h.pageY-a.top,h=screenToWorld(b,a);k(h,"up")&&d&&(0>b||0>a||b>boardWidth||a>boardHeight?v(b,a):l(b,a,.5,h,f(c)));d=!1;Modes.finishInteractableStates()});var h=1;m.bind("gesturechange",function(c){WorkQueue.pause();c.preventDefault();d=!1;c=
c.originalEvent.scale;takeControlOfViewbox();Zoom.scale(h/c);h=c});m.bind("gestureend",function(){WorkQueue.gracefullyResume();h=1})}});return function(b){d=b}}function aspectConstrainedDimensions(b,e){var g=boardHeight/boardWidth,l={height:e,width:b};e/b>g?l.height=b*g:l.width=e/g;return l}
function aspectConstrainedRect(b,e,g){var l=boardHeight/boardWidth,d={left:b.left,top:b.top,right:b.right,bottom:b.bottom,width:b.width,height:b.height};b.height/b.width>l?(d.height=b.width*l,g&&(e=b.height-d.height,"center"==g?d.top+=e/2:"bottom"==g&&(d.top+=e))):(d.width=b.height/l,e&&(g=b.width-d.width,"center"==e?d.left+=g/2:"right"==e&&(d.left+=g)));d.right=d.left+d.width;d.bottom=d.top+d.height;return d}
function copyBuffer(b){var e=document.createElement("canvas");e.width=b.width;e.height=b.height;e.getContext("2d").drawImage(b,0,0,b.width,b.height,0,0,b.width,b.height);return e}function intersectRect(b,e){return"undefined"!=typeof b&&"undefined"!=typeof e?!(e[0]>b[2]||e[2]<b[0]||e[1]>b[3]||e[3]<b[1]):!1}function overlapRect(b,e){return intersectRect(b,e)?(Math.max(b[0],e[0])-Math.min(b[2],e[2]))*(Math.max(b[1],e[1])-Math.min(b[3],e[3])):0}
function rectFromTwoPoints(b,e,g){g=g||0;var l,d,k;b.x<e.x?(l=b.x,k=e.x):(l=e.x,k=b.x);b.y<e.y?(d=b.y,b=e.y):(d=e.y,b=b.y);e=k-l;var f=b-d;e<g&&(k+=g-e,e=k-l);f<g&&(b+=g-f,f=b-d);return{left:l,top:d,right:k,bottom:b,width:e,height:f}}function updateMarquee(b,e,g){e=rectFromTwoPoints(e,g);g=$("#selectionAdorner");jQuery.contains(g,b)||g.append(b);b.is(":visible")||b.show();b.css({left:px(e.left),top:px(e.top),width:px(e.width),height:px(e.height)})}
function clampToView(b){var e=b.x,g=b.y;0>b.x&&(e=0);b.x>boardWidth&&(e=boardWidth);0>b.y&&(g=0);b.y>boardHeight&&(g=boardHeight);return{x:e,y:g}}
var bounceButton=function(b){var e=$(b);e.addClass("activeBrush");setTimeout(function(){e.removeClass("activeBrush")},200)},videoControlInteractable=function(b){var e=void 0;return{activated:!1,rehome:function(b){},down:function(b){return!1},move:function(b){return!1},up:function(e){var l=Modes.select.handlesAtZoom();e=e.x-b.x;if(e<l)b.getState().paused?b.play():b.pause();else if(e>b.width-l)b.muted(!b.muted());else{var d=b.getState();b.seek((e-l)/(b.width-2*l)*d.duration)}return!1},getBounds:function(){return e},
deactivate:function(){},render:function(g){if(b.identity in boardContent.videos){var l=Modes.select.handlesAtZoom();e=[b.bounds[0],b.bounds[3],b.bounds[2],b.bounds[3]+l];var l=worldToScreen(e[0],e[1]),d=worldToScreen(e[2],e[3]),k=d.x-l.x,f=d.y-l.y,r=b.getState();g.globalAlpha=1;g.setLineDash([]);g.strokeStyle="black";g.font=sprintf("%spx FontAwesome",f);g.fillStyle="white";g.fillRect(l.x,l.y,f,f);g.fillStyle="black";r.paused?g.fillText("\uf04b",l.x,d.y):g.fillText("\uf04c",l.x,d.y);var w=l.x+f,m=
k-f;g.fillStyle="black";g.fillRect(w,l.y,m,f);g.fillStyle="blue";m*=r.currentTime/r.duration;g.fillRect(w,l.y,m,f);k=l.x+(k-f);g.fillStyle="white";g.fillRect(k,l.y,f,f);g.fillStyle="black";r.muted?g.fillText("\uf0f3",k,d.y):g.fillText("\uf1f6",k,d.y)}}}},Modes=function(){var b=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},e=function(d,e){b();$(d).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$(e).addClass("activeTool").removeClass("inactiveTool")},g={name:"none",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.none;b()},deactivate:function(){b();unregisterPositionHandlers(board)}},l=function(b,e){b in Modes.canvasInteractables||(Modes.canvasInteractables[b]=[]);Modes.canvasInteractables[b].push(e)};$(function(){var b={opacity:1};(new TWEEN.Tween(b)).delay(1E3).to({opacity:.3},1E3);var e=Modes.select.handlesAtZoom(),f=function(){var m=void 0;return{getBounds:function(){return m},
activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!f.activated){var b=Modes.select.handlesAtZoom(),d=a.x+b/2;m=[d-b/2,a.y-b,d+b/2,a.y]}},down:function(a){f.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=a;Modes.select.marqueeWorldOrigin=a;blit()},move:function(a){f.activated&&(f.bounds=[a.x-e,a.y,a.x+e,a.y],Modes.select.offset=a,blit());return!1},deactivate:function(){f.activated=!1;Modes.select.dragging=!1},up:function(a){f.deactivate();var b=
batchTransform(),d=a.x-Modes.select.marqueeWorldOrigin.x,e=a.y-Modes.select.marqueeWorldOrigin.y;b.xTranslate=d;b.yTranslate=e;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(b.multiWordTextIds,function(a){Modes.text.echoesToDisregard[a]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(a){a.doc.position.x+=
d;a.doc.position.y+=e;a.doc.invalidateBounds()});sendStanza(b);registerTracker(b.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(a){if(m){var q=worldToScreen(m[0],m[1]),e=worldToScreen(m[2],m[3]).x-q.x,f=q.x,q=q.y;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.fillRect(f,q,e,e);a.strokeRect(f,q,e,e);a.font=sprintf("%spx FontAwesome",e);a.fillStyle="black";a.fillText("\uf047",f,q+e-4)}}}}(),r=function(){var f=
void 0;return{getBounds:function(){return f},activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!r.activated){var b=Modes.select.handlesAtZoom(),d=a.x2;a=a.y;f=[d,a,d+b,a+b]}},down:function(a){Modes.select.aspectLocked=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;r.activated=!0;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};r.rehome(a);blit();return!1},move:function(a){if(r.activated){f=[a.x-e,f[1],a.x+e,f[3]];var b=Modes.select.totalSelectedBounds();
Modes.select.offset={x:a.x,y:b.y+(a.x-b.x)/(b.x2-b.x)*b.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;r.activated=!1;Modes.select.resizing=!1},up:function(a){r.deactivate();var b=batchTransform(),d=Modes.select.totalSelectedBounds();b.xScale=(a.x-d.x)/(d.x2-d.x);b.yScale=b.xScale;b.xOrigin=d.x;b.yOrigin=d.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);
b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(a,d){Modes.text.echoesToDisregard[d]=!0;var e=a.doc.documentRange();a.doc.select(e.start,e.end);Modes.text.scaleEditor(a.doc,b.xScale);a.doc.select(0,0);a.doc.width(a.doc.width()*b.xScale);a.doc.invalidateBounds()});registerTracker(b.identity,function(){Progress.call("onSelectionChanged")});sendStanza(b);return!1},render:function(a){if(f){var e=worldToScreen(f[0],f[1]),k=worldToScreen(f[2],
f[3]).x-e.x,u=k/10,p=-1*k;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(e.x,e.y);a.rotate(90*Math.PI/180);a.fillRect(0,p,k,k);a.strokeRect(0,p,k,k);a.font=sprintf("%spx FontAwesome",k);a.fillStyle="black";a.fillText("\uf0b2",u,-1*u)}}}}(),g=function(){var f=void 0;return{activated:!1,getBounds:function(){return f},rehome:function(a){if(!g.activated){var b=Modes.select.handlesAtZoom(),d=a.x2;a=a.y2;f=[d,a-b,d+b,a]}},down:function(a){g.activated=
!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();console.log("Free transform down");return!1},move:function(a){g.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),g.bounds=[a.x-e,a.y-e,a.x+e,a.y+e],Modes.select.offset={x:a.x,y:a.y},blit());return!1},deactivate:function(){g.activated=!1;Modes.select.resizing=!1},up:function(a){g.deactivate();var b=batchTransform(),d=Modes.select.totalSelectedBounds(),
e=d.y2-d.y,f=a.y-d.y;b.xScale=(a.x-d.x)/(d.x2-d.x);b.yScale=f/e;b.xOrigin=d.x;b.yOrigin=d.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);_.each(Modes.select.selected.multiWordTexts,function(a){a.doc.width(Math.max(a.doc.width()*b.xScale,Modes.text.minimumWidth/scale()));a.doc.invalidateBounds();0<a.doc.save().length&&sendRichText(a)});registerTracker(b.identity,
function(){Progress.call("onSelectionChanged");blit()});console.log("Free transform up");sendStanza(b);blit();return!1},render:function(a){if(f){var e=worldToScreen(f[0],f[1]),k=worldToScreen(f[2],f[3]).x-e.x,u=k/10,p=-1*k;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(e.x,e.y);a.rotate(90*Math.PI/180);a.fillRect(0,p,k,k);a.strokeRect(0,p,k,k);a.font=sprintf("%spx FontAwesome",k);a.fillStyle="black";a.fillText("\uf065",u,-1*u)}}}}();
l("manualMove",f);l("resizeFree",g);l("resizeAspectLocked",r);Progress.textBoundsChanged.selectionHandles=function(b,a){if(b in Modes.select.selected.multiWordTexts){var d=Modes.select.totalSelectedBounds();f.rehome(d);g.rehome(d);r.rehome(d)}};Progress.onSelectionChanged.selectionHandles=function(){var e=Modes.select.totalSelectedBounds();Infinity==e.x?b.opacity=0:(b.opacity=1,f.rehome(e),g.rehome(e),r.rehome(e))}});return{pushCanvasInteractable:l,clearCanvasInteractables:function(b){Modes.canvasInteractables[b]=
[]},getCanvasInteractables:function(){return _.mapValues(Modes.canvasInteractables,function(b){return _.map(b,function(b){b=_.clone(b);b.bounds=b.getBounds();return b})})},currentMode:g,none:g,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),function(b){_.forEach(Modes.canvasInteractables[b],function(b){void 0!=b&&"deactivate"in b&&b.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var d=
function(){},k,f,g,l,m,a,q,t,u,p,B,y=function(a,c){var b=Modes.text.minimumWidth/scale(),b=Modes.text.editorFor({bounds:[a.x,a.y,a.x,a.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),slide:Conversations.getCurrentSlideJid(),target:"presentationSpace",requestedWidth:b,width:b,height:0,x:a.x,y:a.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});b.doc.load(c);return b},v=function(a){return function(){var c=!1;_.each(boardContent.multiWordTexts,
function(b){if(b.doc.isActive){c=!0;var d=b.doc.selectedRange();carota.runs.nextInsertFormatting={};d.setFormatting(a,!0!==d.getFormatting()[a]);0<b.doc.save().length&&sendRichText(b)}});if(!c){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var b=carota.runs.nextInsertFormatting[a]=!carota.runs.nextInsertFormatting[a];$(sprintf(".font%sSelector",_.capitalize(a))).toggleClass("active",b)}}},x=function(a,c){return function(){var b=!1;c=c||$(this).val();_.each(boardContent.multiWordTexts,
function(d){d.doc.isActive&&(b=!0,carota.runs.nextInsertFormatting={},d.doc.selectedRange().setFormatting(a,c),0<d.doc.save().length&&sendRichText(d))});b||(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[a]=c)}},n=function(a,c){var b=a.selectedRange(),d=0,e=[],f=carota.runs.defaultFormatting.size;a.runs(function(c){c=_.size(c.text);c=d+c;a.select(d,c,!0);var b=a.selectedRange().getFormatting().size||f;_.each(_.range(d,c),function(){e.push(b)});
d=c;f=b},a.range(0,b.end));e=e.reverse();d=b.start;a.runs(function(b){b=d+b.text.length;a.select(d,b,!0);a.selectedRange().setFormatting("size",e[d]*c);d=b},a.range(b.start,b.end));a.select(b.start,b.end,!0)},A=function(a){return function(){_.each(boardContent.multiWordTexts,function(c){c=c.doc;c.isActive&&n(c,a)})}};$(function(){l=$(".fontBoldSelector");m=$(".fontItalicSelector");a=$(".fontUnderlineSelector");u=$("#textDropdowns");t=$("#fontOptions");k=$("#fontFamilySelector");f=$("#fontSizeSelector");
g=$("#fontColorSelector");p=$("#fontLarger");B=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");q=$("#presetFullscreen");$("#presetCenterOnScreen");var b=k.find(".fontFamilyOption").clone(),c=f.find(".fontSizeOption").clone(),d=g.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(a){k.append(b.clone().attr("value",a).text(a))});Fonts.getAllSizes().map(function(a){f.append(c.clone().attr("value",a).text(a))});
Colors.getAllNamedColors().map(function(a){g.append(d.clone().attr("value",a.rgb).text(a.name))});p.on("click",A(1.2));B.click(A(.8));l.click(v("bold"));m.click(v("italic"));a.click(v("underline"));var e={red:"#ff0000",blue:"#0000ff",black:"#000000",yellow:"#ffff00"};_.each(["red","blue","black","yellow"],function(a){$(sprintf("#%sText",a)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");x("color",[e[a],255])()})});q.click(function(a){return function(){_.each(boardContent.multiWordTexts,
function(c){if(c.doc.isActive){switch(a){case "runToEdge":var b=screenToWorld(boardWidth,0);c.doc.width(b.x+viewboxX-c.x);break;case "fitToText":c.doc.width(c.doc.frame.actualWidth());break;case "widen":c.doc.width(1.6*c.doc.frame.actualWidth());break;case "narrow":c.doc.width(.6*c.doc.frame.actualWidth());break;case "centerOnScreen":c.doc.width(screenToWorld(boardWidth,0).x);c.doc.selectedRange().setFormatting("align","center");c.doc.position.x=viewboxX;break;case "fullscreen":c.doc.position.x=viewboxX,
c.doc.position.y=viewboxY,c.doc.width(screenToWorld(boardWidth,0).x)}c.doc.contentChanged.fire()}})}}("fullscreen"));t.click(function(){u.toggle()});$("#closeTextDialog").click(function(){u.hide()});$("#exitTextEditing").click(function(){Modes.select.activate()})});return{name:"text",echoesToDisregard:{},minimumWidth:240,minimumHeight:function(){return 3*Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},
getSelectedRanges:function(){return _.map(boardContent.multiWordTexts,function(a){var c=a.doc.selectedRange();return{identity:a.identity,start:c.start,end:c.end,text:c.plainText()}})},getLinesets:function(){return _.map(boardContent.multiWordTexts,function(a){console.log("Textbox",a.identity,a.doc.width());a.doc.layout();return _.map(a.doc.frame.lines,function(a){return a.positionedWords.length})})},mapSelected:function(a){var c=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,
function(b){b.identity in c&&a(b)})},scaleEditor:n,scrollToCursor:function(a){var c=a.bounds,b=a.doc.selectedRange().start;a=a.doc.getCaretCoords(b);var b=Math.floor(a.t/a.h),d=Math.floor(scaleScreenToWorld(boardContext.height)/a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var b=Math.min(b,Math.max(0,d-2))*a.h,d=Math.max(c[2]-c[0],scaleWorldToScreen(10*a.h)),e=d/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(c[0],c[1]-b+a.t,d,e)}else c=Math.max(0,
Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(c[1]-viewboxY))/a.h)-4))*a.h,0!=c&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+c,viewboxWidth,viewboxHeight)},editorFor:function(b){var c=boardContent.multiWordTexts[b.identity];c||(c=boardContent.multiWordTexts[b.identity]=b);if(!c.doc){var e=b.author==UserSettings.getUsername();c.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",b.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],e?blit:d,b);e&&(e=_.debounce(function(){Modes.text.scrollToCursor(c);
var a=boardContent.multiWordTexts[c.identity];a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);incorporateBoardBounds(c.bounds)},1E3),c.doc.contentChanged(e),c.doc.selectionChanged(function(b,d){if(0<c.doc.save().length){var e=b();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var h=[$("#blackText"),$("#redText"),$("#blueText"),$("#yellowText")],f=function(a,c){var b=1==e[c];b&&(carota.runs.nextInsertFormatting[c]=b);a.toggleClass("active",
b)},n=function(a,c,b){var d=_.isEqual(e[c],b);c in e&&d&&(carota.runs.nextInsertFormatting[c]=b);a.toggleClass("active",d)};f(l,"bold");f(m,"italic");f(a,"underline");n(h[0],"color",["#000000",255]);n(h[1],"color",["#ff0000",255]);n(h[2],"color",["#0000ff",255]);n(h[3],"color",["#ffff00",255]);d&&Modes.text.scrollToCursor(c)}}))}c.doc.position={x:b.x,y:b.y};c.doc.width(b.width);return c},draw:function(a){a&&a.doc&&carota.editor.paint(board[0],a.doc,!0)},editorAt:function(a,c,b,d){var e=UserSettings.getUsername(),
f=[d.x-10,d.y-10,d.x+10,d.y+10];a=_.values(boardContent.multiWordTexts).filter(function(a){return intersectRect(a.bounds,f)&&a.author==e});return 0<a.length?a[0]:!1},contextFor:function(a,c){var b={x:c.x-a.position.x,y:c.y-a.position.y};return{node:a.byCoordinate(b.x,b.y),relativePos:b}},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;e("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var a=0;registerPositionHandlers(board,
function(a,b,d,e){if(a=Modes.text.editorAt(a,b,d,e).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,e).node)},function(a,b,d,e){(a=Modes.text.editorAt(a,b,d,e).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,e).node)},function(b,d,e,f){var n=Date.now(),p=Modes.text.editorAt(b,d,e,f);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=a.doc.identity==p.identity;0==a.doc.documentRange().plainText().trim().length&&(delete boardContent.multiWordTexts[a.identity],
blit())});Modes.select.clearSelection();p?(b=p.doc,f=Modes.text.contextFor(b,f),500>=n-a?b.dblclickHandler(f.node):b.mouseupHandler(f.node),a=n,f={multiWordTexts:{}},f.multiWordTexts[p.identity]=p,Modes.select.setSelection(f)):(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},b=y(f,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||
carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.size/scale()}]),n=b.doc,n.select(0,1),boardContent.multiWordTexts[b.identity]=b,f={multiWordTexts:{}},f.multiWordTexts[b.identity]=boardContent.multiWordTexts[b.identity],Modes.select.setSelection(f),p=b,f=n.byOrdinal(0),n.mousedownHandler(f),n.mouseupHandler(f));p.doc.invalidateBounds();p.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(p);Progress.call("onSelectionChanged",
[Modes.select.selected])})},handleDrop:function(a,b,d){if(0<a.length){a=carota.html.parse(a,{});console.log("newRuns:",a);b=screenToWorld(b,d);Modes.text.activate();Date.now();Modes.select.clearSelection();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var e=y(b,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,
size:carota.runs.defaultFormatting.size/scale()}]);b=e.doc;b.select(0,1);boardContent.multiWordTexts[e.identity]=e;d={multiWordTexts:{}};d.multiWordTexts[e.identity]=boardContent.multiWordTexts[e.identity];Modes.select.setSelection(d);editor=e;d=b.byOrdinal(0);b.mousedownHandler(d);b.mouseupHandler(d);editor.doc.invalidateBounds();editor.doc.isActive=!0;editor.doc.load(a);Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(editor);a=
boardContent.multiWordTexts[editor.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);Progress.call("onSelectionChanged",[Modes.select.selected])}},deactivate:function(){DeviceConfiguration.setKeyboard(!1);b();u.hide();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=!1;0==a.doc.documentRange().plainText().trim().length&&delete boardContent.multiWordTexts[a.identity]});
Modes.select.clearSelection();blit()}}}(),video:function(){var d={},k=void 0,f=void 0,g=function(){k.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=f.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();f.unwrap()},l=function(a){if(void 0!=d&&void 0!=d.fileUpload&&void 0!=a){$("#videoWorking").show();$("#videoFileChoice").hide();var b=new FileReader;b.onload=function(b){var e=$("<video/>"),f=e[0],g=b.target.result;f.addEventListener("loadeddata",function(b){b=f.videoHeight;
d.width=f.videoWidth;d.height=b;d.video=e;d.videoSrc=g;a()},!1);e.append($("<source />",{src:g,type:"video/mp4"}));e.load()};b.readAsDataURL(d.fileUpload)}},m=function(){if("imageDefinition"==d.type){WorkQueue.pause();var a=Date.now(),b=sprintf("%s%s",UserSettings.getUsername(),a),e=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",e.toString(),encodeURI(b));$.ajax({url:b,type:"POST",success:function(b){var f=$(b).find("resourceUrl").text(),k={type:"video",author:UserSettings.getUsername(),
timestamp:a,identity:f,slide:e.toString(),source:$(b).text(),bounds:[d.x,d.y,d.x+d.width,d.y+d.height],width:d.width,height:d.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:d.x,y:d.y};registerTracker(f,function(){var a=Modes.select.handlesAtZoom(),b=k.x,d=k.y,e=Math.max(k.width,viewboxWidth),f=Math.max(k.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,d-a,e+2*a,f+2*a);Modes.select.clearSelection();Modes.select.selected.videos[k.identity]=boardContent.videos[k.identity];
Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(k);g();WorkQueue.gracefullyResume()},error:function(a){console.log(a);resetImageUpload();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:d.videoSrc,cache:!1,contentType:!1,processData:!1})}},a=!1;$(function(){a||(a=!0,k=$("#videoInsertOptions").css({position:"absolute",left:0,top:0}),$("#videoInsertOptionsClose").click(Modes.select.activate),
f=$("#videoFileChoice").attr("accept","video/mp4"),f[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("video")&&(d.fileUpload=a);l(m)},!1),g())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.video;e("#videoTools","#videoMode");var a=screenToWorld(10,10);d={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");k.show()},deactivate:function(){g();b()}}}(),image:function(){var d=
{},k=void 0,f=void 0,g=function(){k.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=f.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();f.unwrap()},l=function(){var a=function(a,b,d,e){for(var c=b*d;c>a;)b*=.8,d*=.8,c=b*d;return{w:b,h:d,q:e}},b={"native":{resizeFunc:function(a,b){return{w:a,h:b,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(b,d){return a(1*e,b,d,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(b,d){return a(3*e,
b,d,.8)},selector:"#imageInsertHighDef"}},d=b.optimized,e=1048576,f=function(){_.forEach(b,function(a){var b=$(a.selector);d.selector==a.selector?b.addClass("activeBrush"):b.removeClass("activeBrush")})};$(function(){_.forEach(b,function(a){$(a.selector).on("click",function(){d=a;f()})});f()});return{reapplyVisualStyle:f,changeMode:function(a){a in b&&(d=b[a],f())},getResizeFunction:function(){return d.resizeFunc}}}(),m=function(b,e){var f=void 0==e?d:e;if(void 0==f||void 0==f.fileUpload||void 0==
b)console.log("returning because currentImage is empty",d);else{$("#imageWorking").show();$("#imageFileChoice").hide();var g=new FileReader;g.onload=function(d){var e=d.target.result;a(e,f,b,function(a){return e.length<a})};g.readAsDataURL(f.fileUpload)}},a=function(a,b,e,f){var g=void 0!=b?b:d,k=$("<canvas/>"),n=new Image;n.setAttribute("crossOrigin","Anonymous");n.onerror=function(a){errorAlert("Error dropping image","The source server you're dragging the image from does not allow dragging the image directly across into MeTL.  You may need to download the image first and then upload it.")};
n.onload=function(b){var d=n.width,c=n.height,p=l.getResizeFunction()(d,c);b=p.w;var m=p.h,p=p.q;k.width=d;k.height=c;k.attr("width",d);k.attr("height",c);k.css({width:px(d),height:px(c)});var r=k[0].getContext("2d");r.rect(0,0,d,c);r.fillStyle="white";r.fill();r.drawImage(n,0,0,d,c);d=multiStageRescale(k[0],b,m);g.width=b;g.height=m;g.resizedImage=d.toDataURL("image/jpeg",p);f(g.resizedImage.length)&&(g.resizedImage=a);e(g)};n.src=a},q=function(a){if("imageDefinition"==a.type){WorkQueue.pause();
var b=Date.now(),d=sprintf("%s%s%s",UserSettings.getUsername(),b,_.uniqueId()),e=Conversations.getCurrentSlideJid(),d=sprintf("/uploadDataUri?jid=%s&filename=%s",e.toString(),encodeURI(d));$.ajax({url:d,type:"POST",success:function(d){var f=$(d).find("resourceUrl").text(),n={type:"image",author:UserSettings.getUsername(),timestamp:b,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+f+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:f,slide:e.toString(),
source:$(d).text(),bounds:[a.x,a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:a.x,y:a.y};registerTracker(f,function(){var a=Modes.select.handlesAtZoom(),b=n.x,c=n.y,d=Math.max(n.width,viewboxWidth),e=Math.max(n.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,d+2*a,e+2*a);Modes.select.clearSelection();Modes.select.selected.images[n.identity]=boardContent.images[n.identity];Progress.call("onSelectionChanged",
[Modes.select.selected])});sendStanza(n);g();WorkQueue.gracefullyResume()},error:function(a){console.log(a);g();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:a.resizedImage,cache:!1,contentType:!1,processData:!1})}},t=!1;$(function(){t||(t=!0,k=$("#imageInsertOptions").css({position:"absolute",left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),
f=$("#imageFileChoice").attr("accept","image/*"),f[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("image")&&(d.fileUpload=a);m(q)},!1),g())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.image;e("#imageTools","#imageMode");var a=screenToWorld(10,10);d={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");l.reapplyVisualStyle();k.show()},handleDroppedSrc:function(b,d,e){var f=
screenToWorld(d,e);a(b,{type:"imageDefinition",screenX:d,screenY:e,x:f.x,y:f.y},q,function(a){return!1})},handleDrop:function(a,b,d){var e=0,f=[],g=function(a,g){if(null!=a&&"type"in a&&0==a.type.indexOf("image")&&!_.some(f,function(b){return b==a})){var h=screenToWorld(b,d+e),h={type:"imageDefinition",screenX:b,screenY:d+e,x:h.x,y:h.y};h.fileUpload=a;console.log("handlingDrop",a,g,h);f.push(a);m(q,h);e+=50}};_.forEach(a.files,function(a){g(a,"file")});_.forEach(a.items,function(a){a=a.getAsFile(0);
g(a,"item")})},deactivate:function(){g();b()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");Modes.currentMode.deactivate();e("#panTools","#panMode");Modes.currentMode=Modes.pan;var b,g;registerPositionHandlers(board,function(e,r,l){takeControlOfViewbox();b=e;g=r},function(e,r,l){Pan.translate(-1*(e-b),-1*(r-g));b=e;g=r},function(b,d,e){})},deactivate:function(){b();unregisterPositionHandlers(board)}},select:function(){var d=!1,g=function(){Modes.select.selected={images:{},text:{},inks:{},
multiWordTexts:{},videos:{}};Progress.call("onSelectionChanged",[Modes.select.selected])},f=_.debounce(function(){var a=!1;_.forEach("images texts inks highlighters multiWordTexts videos".split(" "),function(b){var d="highlighters"==b?"inks":b;if(Modes&&Modes.select&&Modes.select.selected&&d in Modes.select.selected){var e=Modes.select.selected[d];_.forEach(e,function(f){e&&b in boardContent&&f&&f.identity in boardContent[b]?e[f.identity]=boardContent[b][f.identity]:(a=!0,"inks"==d?"highlighters"==
b&&f.identity in e&&1==e[f.identity].isHighlighter?delete e[f.identity]:"inks"==b&&f.identity in e&&0==e[f.identity].isHighlighter&&delete e[f.identity]:delete e[f.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),r=function(){if(void 0!=Modes.select.selected&&d&&"Blacklist"in window){var a=Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),a.inks,a.texts,a.multiWordTexts,a.images,a.videos)}g()},
l=function(){(d=Conversations.shouldModifyConversation()?!d:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");g()},m=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),$("#ban").removeClass("disabledButton"),$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());
d?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=f;Progress.onViewboxChanged.ModesSelect=f;Progress.onSelectionChanged.ModesSelect=function(a){a&&(Modes.select.selected=a,"images"in a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||"multiWordTexts"in a&&0<_.size(a.multiWordTexts)||"videos"in a&&0<_.size(a.videos)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),
d?($("#ban").removeClass("disabledButton"),$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=g;Progress.conversationDetailsReceived.ModesSelect=
function(a){d&&!Conversations.shouldModifyConversation(a)&&(d=!1);Conversations.shouldModifyConversation(a)?($("#administerContent").unbind("click").bind("click",l),$("#ban").unbind("click").bind("click",r)):($("#administerContent").unbind("click"),$("#ban").unbind("click"));m(a)};return{name:"select",selected:{images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=
scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,b);_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,b);_.forEach(Modes.select.selected.videos,
b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:g,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;e("#selectTools","#selectMode");var a={x:0,y:0},b=$("<div/>",{id:"selectMarquee"}),f=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&!d){var a=batchTransform();a.isDeleted=
!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&(a.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));"videos"in Modes.select.selected&&(a.videoIds=_.keys(Modes.select.selected.videos));sendStanza(a);g()}});var r=function(a){a("images");a("texts");a("multiWordTexts");
a("inks");a("videos")};Modes.select.dragging=!1;m();Modes.select.resizing=!1;registerPositionHandlers(board,function(d,e,g,k,r){Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:d,y:e};Modes.select.marqueeWorldOrigin=k;if(!r.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){g=3/scale();var n=[k.x-g,k.y-g,k.x+g,k.y+g];Modes.select.dragging=_.some(["images","texts","inks","multiWordTexts","videos"],function(a){return _.some(Modes.select.selected[a],function(a){return a?intersectRect(a.bounds,
n):!1})})}console.log(d,e,k,Modes.select.dragging);Modes.select.dragging?(Modes.select.offset=k,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(f.empty(),f.append(b),b.show(),updateMarquee(b,a,a))},function(d,e,f,g,k){d={x:d,y:e};Modes.select.offset=g;Modes.select.dragging?blit():Modes.select.resizing?blit():updateMarquee(b,a,d)},function(a,e,f,g,k){WorkQueue.gracefullyResume();try{var n=g.x-Modes.select.marqueeWorldOrigin.x,m=g.y-Modes.select.marqueeWorldOrigin.y;
15>Math.abs(n)+Math.abs(m)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=n;a.doc.position.y+=m;a.doc.invalidateBounds()});var h=batchTransform();h.xTranslate=n;h.yTranslate=m;h.inkIds=_.keys(Modes.select.selected.inks);h.textIds=_.keys(Modes.select.selected.texts);h.imageIds=_.keys(Modes.select.selected.images);
h.videoIds=_.keys(Modes.select.selected.videos);h.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(h.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(h)}else{var c=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,g,2),l=[c.left,c.top,c.right,c.bottom],w={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},C={},t={};r(function(a){$.each(boardContent[a],function(b,c){if(!("bounds"in c)&&"type"in c)switch(c.type){case "text":prerenderText(c);
break;case "image":prerenderImage(c);break;case "ink":prerenderInk(c);break;case "video":prerenderVideo(c);break;default:c.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(l,c.bounds)&&(incrementKey(C,c.author),incrementKey(t,"any"),d?c.author!=UserSettings.getUsername()&&(w[a][c.identity]=c):c.author==UserSettings.getUsername()&&(w[a][c.identity]=c))})});$.each(boardContent.highlighters,function(a,b){intersectRect(b.bounds,l)&&(incrementKey(C,b.author),d?b.author!=UserSettings.getUsername()&&(w.inks[b.identity]=
b):b.author==UserSettings.getUsername()&&(w.inks[b.identity]=b))});r(function(a){$.each(w[a],function(b,c){a in Modes.select.selected||(Modes.select.selected[a]=[]);a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=c})});t.any||Modes.select.clearSelection();var D=sprintf("Selected %s images, %s texts, %s inks, %s rich texts, %s videos ",_.keys(Modes.select.selected.images).length,_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,
_.keys(Modes.select.selected.inks).length,_.keys(Modes.select.selected.videos).length);$.each(C,function(a,b){D+=sprintf("%s:%s ",a,b)});Progress.call("onSelectionChanged",[Modes.select.selected])}b.css({width:0,height:0}).hide();blit()}catch(E){console.log("Selection up",E)}})},deactivate:function(){unregisterPositionHandlers(board);b();g();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();m();blit();blit()}}}(),zoom:{name:"zoom",
activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;e("#zoomTools","#zoomMode");var b=$("<div />",{id:"zoomMarquee"}),g,f={x:0,y:0};registerPositionHandlers(board,function(e,l,m,a){takeControlOfViewbox();g=a;b.show();b.appendTo($("#selectionAdorner"));f={x:e,y:l};updateMarquee(b,f,f)},function(e,g,k,a){e={x:e,y:g};g=rectFromTwoPoints(e,f);k="left";a="top";e.x==g.left&&(k="right");e.y==g.top&&(a="bottom");e=aspectConstrainedRect(g,k,a);updateMarquee(b,{x:e.right,y:e.bottom},
{x:e.left,y:e.top})},function(e,f,l,a){WorkQueue.gracefullyResume();b.hide();e={x:contentOffsetX+a.x,y:contentOffsetY+a.y};f=rectFromTwoPoints(e,{x:contentOffsetX+g.x,y:contentOffsetY+g.y});2500>scale()*f.width*f.height||(l="left",a="top",e.x==f.left&&(l="right"),e.y==f.top&&(a="bottom"),e=aspectConstrainedRect(f,l,a),IncludeView.specific(e.left,e.top,e.width,e.height))})},deactivate:function(){b();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},feedback:function(){var d=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);
break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){d()};Progress.conversationDetailsReceived.respectNewPermissions=d;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;d();e("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(b,d,e,g){},function(b,d,e,g){},function(b,d,e,g){});d()},deactivate:function(){b();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),
draw:function(){var d=Brushes.getDefaultBrushes(),g=_.map(d,function(a){return _.clone(a)}),f,l=!1,w=void 0,m=void 0,a=function(a){g[a.index]=a},q=function(){},t=function(){},u=function(){};$(function(){$(".activeBrush").removeClass("activeBrush");var b=function(){var b=$("#drawTools");_.each(b.find(".modeSpecificTool.pen"),function(b,d){var c=g[d],n=$(b).css({color:c.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");f=c;a(c);Modes.draw.drawingAttributes=
f;l=!1;e(c)}).removeClass("fa-tint").removeClass("fa-circle").addClass(c.isHighlighter?"fa-circle":"fa-tint");n.find(".widthIndicator").text(c.width);c==f&&n.addClass("activeBrush")})},e=function(d){var g=$("#colors .dots"),h=$("#sizes .dots"),c=Colors.getAllNamedColors(),k=Brushes.getAllBrushSizes();h.empty();k.map(function(c){var g=w.clone();h.append(g);g.click(function(){d.width=c;a(d);f=d;b();e(d)});var k=Canvas.circle(d.color,c,50);c==d.width&&g.addClass("activeTool");g.prepend(k);k=c.toString()+
"px";g.find(".sizeDotName").append(k)});g.empty();c.map(function(c){var h=m.clone();g.append(h);h.on("click",function(){d.color=c.rgb;f=d;a(d);b();e(d)});h.css("color",c.rgb);"rgb"in c&&c.rgb==d.color&&h.addClass("activeTool");var k=c.name;h.find(".colorDotName").append(k)});c=$("#setPenToHighlighter").unbind("click").on("click",function(){d.isHighlighter=!0;f=d;a(d);b();e(d)});k=$("#setPenToPen").unbind("click").on("click",function(){d.isHighlighter=!1;f=d;a(d);b();e(d)});"isHighlighter"in f&&f.isHighlighter?
(c.addClass("activeTool").addClass("active"),k.removeClass("activeTool").removeClass("active")):(k.addClass("activeTool").addClass("active"),c.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var a=_.find(d,function(a){return a.id==f.id});void 0!=a&&(f.width=a.width,f.color=a.color,f.isHighlighter=a.isHighlighter,b(),e(f))});w=$("#penSize .sizeDot").clone();m=$("#penColor .colorDot").clone();f=g[0];b();e(f);var y=$("#drawTools");
y.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");l=!0;$("#drawDropdowns").hide()});y.find(".advancedTools").unbind("click").on("click",function(){l||(e(f),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});var v=[];t=function(a,b,d,c,e){x=[];l||e.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,boardContext.fillStyle=Modes.draw.drawingAttributes.color,
boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,v=[a,b,256*d],boardContext.beginPath(),boardContext.arc(a,b,Modes.draw.drawingAttributes.width*d/2,0,2*Math.PI),boardContext.fill())};var x=[];u=function(a,b,d,c,e){if(l||e.eraser){var f=[c.x-10,c.y-10,c.x+10,c.y+10];a=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,f)){delete a[c.identity];x.push(c.identity);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);
boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";a(boardContent.inks);a(boardContent.highlighters);boardContext.globalAlpha=1}else c=Modes.draw.drawingAttributes.width*d,boardContext.beginPath(),boardContext.lineCap="round",boardContext.lineWidth=c,c=_.takeRight(v,3),boardContext.moveTo(c[0],c[1]),boardContext.lineTo(a,b),boardContext.stroke(),v=v.concat([a,b,256*d])};q=function(a,b,d,c,e){l||e.eraser?(a=batchTransform(),a.isDeleted=!0,a.inkIds=
x,sendStanza(a)):(c=Modes.draw.drawingAttributes.width*d,boardContext.lineWidth=c,boardContext.beginPath(),boardContext.lineWidth=c,boardContext.lineCap="round",c=_.takeRight(v,3),boardContext.moveTo(c[0],c[1]),boardContext.lineTo(a,b),boardContext.stroke(),v=v.concat([a,b,256*d]),strokeCollected(v));boardContext.globalAlpha=1}});return{name:"draw",brushes:g,activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,
Modes.draw.drawingAttributes=f,e("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),l?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==f.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,t,u,q))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();b();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&
window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,function(b,e,f,g){},function(b,e,f,g){},function(b,e,f,g){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
