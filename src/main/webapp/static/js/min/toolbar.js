function devLogAdd(a){$("#devLog").append($("<div />",{text:a}))}function devLogSet(a){$("#devLog").html($("<div />",{text:a}))}var incrementKey=function(a,e){e in a?a[e]++:a[e]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(a){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(e,m){a.unbind(m)});WorkQueue.gracefullyResume()}
function progress(){var a=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),e=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(a),m=$("<progress />");m.append(a);var n=1,c=0,l=function(){e.css("width",sprintf("%s%%",Math.floor(c/n*100)));m.attr({value:c,max:n})},g={element:m,value:function(a){c=a;l();return g},max:function(c){n=c;l();return g}};return g}
function proportion(a,e){return a/e/(boardWidth/boardHeight)}function scaleScreenToWorld(a){var e;e=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return a*e}function scaleWorldToScreen(a){var e;e=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return a/e}function screenToWorld(a,e){var m=scaleScreenToWorld(a)+viewboxX,n=scaleScreenToWorld(e)+viewboxY;return{x:m,y:n}}
function worldToScreen(a,e){var m=scaleWorldToScreen(a-viewboxX),n=scaleWorldToScreen(e-viewboxY);return{x:m,y:n}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(a){return!1}}
function registerPositionHandlers(a,e,m,n){var c=!1,l=function(c,a){var f=[c.x-10,c.y-10,c.x+10,c.y+10],b=!0;_.each(Modes.canvasInteractables,function(q,e){_.each(q,function(q){a in q&&(q.activated||intersectRect(f,q.bounds))&&(b=b&&q[a](c))})});return b},g=function(c,a){return{shift:c.shiftKey,ctrl:c.ctrlKey,alt:c.altKey,eraser:a}};$.each(a,function(a,p){var f=$(p);f.css({"touch-action":"none"});var b=!1,q={},z=function(d){var k=d.originalEvent.pointerId,c="pen"==d.originalEvent.pointerType&&5==
d.originalEvent.button,a=f.offset(),r=d.pageX-a.left,a=d.pageY-a.top,e=d.originalEvent.pressure||.5,g=screenToWorld(r,a),h=q[k]||{pointerId:k,pointerType:d.originalEvent.pointerType,eraser:c,points:[]};h.points.push({x:g.x,y:g.y,screenX:r,screenY:a,z:e});h.eraser=h.eraser||c;q[k]=h;1<_.size(q)&&(0==b&&_.each(q,function(d){d.points=[_.last(d.points)]}),b=!0);return{pointerType:d.pointerType,eraser:h.eraser,x:r,y:a,z:e,worldPos:g}},v=function(d){var k=d.originalEvent.pointerId,a="pen"==d.originalEvent.pointerType&&
5==d.originalEvent.button,r=f.offset(),e=d.pageX-r.left,r=d.pageY-r.top,g=d.originalEvent.pressure||.5,h=screenToWorld(e,r);delete q[k];b&&0==_.size(q)&&(c=b=!1);return{pointerType:d.pointerType,eraser:a,x:e,y:r,z:g,worldPos:h}};if(detectPointerEvents()){var u=_.throttle(function(){if(1<_.size(q)){takeControlOfViewbox();var d=_.map(_.filter(q,function(d){return 0<_.size(d.points)}),function(d){var k=_.first(d.points);d=_.last(d.points);return[k,d]});q={};var k=_.meanBy(d,function(d){return d[0].x-
d[1].x}),b=_.meanBy(d,function(d){return d[0].y-d[1].y});Pan.translate(scaleWorldToScreen(k),scaleWorldToScreen(b));var k=_.min(_.map(d,function(d){return d[0].y})),f=_.max(_.map(d,function(d){return d[0].y})),b=_.min(_.map(d,function(d){return d[0].x})),c=_.max(_.map(d,function(d){return d[0].x})),k=f-k,b=c-b,c=_.min(_.map(d,function(d){return d[1].y})),f=_.max(_.map(d,function(d){return d[1].y})),a=_.min(_.map(d,function(d){return d[1].x})),d=(_.max(_.map(d,function(d){return d[1].x}))-a+(f-c))/
2;Zoom.scale((b+k)/2/d)}},25);f.bind("pointerdown",function(d){var k=z(d);d.preventDefault();WorkQueue.pause();1!=_.size(q)||b||(c=!0,l(k.worldPos,"down")&&e(k.x,k.y,k.z,k.worldPos,g(d,k.eraser)))});f.bind("pointermove",function(d){var k=z(d);d.preventDefault();(d.originalEvent.pointerType==d.POINTER_TYPE_TOUCH||"touch"==d.originalEvent.pointerType&&1<_.size(q))&&u();1!=_.size(q)||b||l(k.worldPos,"move")&&c&&m(k.x,k.y,k.z,k.worldPos,g(d,k.eraser))});f.bind("pointerup",function(d){var k=v(d);WorkQueue.gracefullyResume();
d.preventDefault();l(k.worldPos,"up")&&c&&!b&&n(k.x,k.y,k.z,k.worldPos,g(d,k.eraser));c=!1;Modes.finishInteractableStates()});var y=function(d){v(d);WorkQueue.gracefullyResume();d.preventDefault();if(c){var k=d.offsetX;d=d.offsetY;q={};WorkQueue.gracefullyResume();d=screenToWorld(k,d);k=d.x;d=d.y;k<viewboxX?(takeControlOfViewbox(),Extend.left()):k>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):d<viewboxY?(takeControlOfViewbox(),Extend.up()):d>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),
Extend.down());c=!1;Modes.finishInteractableStates()}c=!1;Modes.finishInteractableStates()};f.bind("pointerout",y);f.bind("pointerleave",y);f.bind("pointercancel",y)}else{f.bind("mousedown",function(d){WorkQueue.pause();var k=f.offset();c=!0;var b=d.pageX-k.left,k=d.pageY-k.top,a=screenToWorld(b,k);l(a,"down")&&e(b,k,.5,a,g(d));d.preventDefault()});f.bind("mousemove",function(d){var k=f.offset();d.preventDefault();var b=d.pageX-k.left,k=d.pageY-k.top,a=screenToWorld(b,k);l(a,"move")&&c&&m(b,k,.5,
a,g(d))});f.bind("mouseup",function(d){WorkQueue.gracefullyResume();d.preventDefault();var k=f.offset(),b=d.pageX-k.left,k=d.pageY-k.top,a=screenToWorld(b,k);l(a,"up")&&c&&n(b,k,.5,a,g(d));c=!1;Modes.finishInteractableStates()});var B=function(d,k){WorkQueue.gracefullyResume();var b=screenToWorld(d,k),f=b.x,b=b.y;f<viewboxX?(takeControlOfViewbox(),Extend.left()):f>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):b<viewboxY?(takeControlOfViewbox(),Extend.up()):b>=viewboxY+viewboxHeight&&
(takeControlOfViewbox(),Extend.down());c=!1};f.bind("mouseout",function(d){WorkQueue.gracefullyResume();d.preventDefault();c&&B(d.offsetX,d.offsetY);c=!1;Modes.finishInteractableStates()});var t,w=function(d){return{x:average(_.map(d,"x")),y:average(_.map(d,"y"))}},x=function(d){var b=[],c=f.offset();$.each(d,function(d,f){b.push({x:f.pageX-c.left,y:f.pageY-c.top,identifier:f.identifier})});return b};f.bind("touchstart",function(d){WorkQueue.pause();d.preventDefault();var b=x(d.originalEvent.touches);
if(1==b.length){var b=b[0],f=screenToWorld(b.x,b.y);c=!0;l(f,"down")&&e(b.x,b.y,.5,f,g(d))}else t=w(b)});f.bind("touchmove",function(d){d.preventDefault();var b=x(d.originalEvent.touches);switch(b.length){case 0:break;case 1:var b=b[0],f=screenToWorld(b.x,b.y);l(f,"move")&&c&&m(b.x,b.y,.5,f,g(d));break;default:d=w(b),b=d.x-t.x,f=d.y-t.y,t=d,takeControlOfViewbox(),Pan.translate(-1*b,-1*f)}});f.bind("touchend",function(d){WorkQueue.gracefullyResume();d.preventDefault();var b=f.offset(),a=d.originalEvent.changedTouches[0],
r=a.pageX-b.left,b=a.pageY-b.top,a=screenToWorld(r,b);l(a,"up")&&c&&(0>r||0>b||r>boardWidth||b>boardHeight?B(r,b):n(r,b,.5,a,g(d)));c=!1;Modes.finishInteractableStates()});var r=1;f.bind("gesturechange",function(d){WorkQueue.pause();d.preventDefault();c=!1;d=d.originalEvent.scale;takeControlOfViewbox();Zoom.scale(r/d);r=d});f.bind("gestureend",function(){WorkQueue.gracefullyResume();r=1})}});return function(a){c=a}}
function aspectConstrainedDimensions(a,e){var m=boardHeight/boardWidth,n={height:e,width:a};e/a>m?n.height=a*m:n.width=e/m;return n}
function aspectConstrainedRect(a,e,m){var n=boardHeight/boardWidth,c={left:a.left,top:a.top,right:a.right,bottom:a.bottom,width:a.width,height:a.height};a.height/a.width>n?(c.height=a.width*n,m&&(e=a.height-c.height,"center"==m?c.top+=e/2:"bottom"==m&&(c.top+=e))):(c.width=a.height/n,e&&(m=a.width-c.width,"center"==e?c.left+=m/2:"right"==e&&(c.left+=m)));c.right=c.left+c.width;c.bottom=c.top+c.height;return c}
function copyBuffer(a){var e=document.createElement("canvas");e.width=a.width;e.height=a.height;e.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,a.width,a.height);return e}function intersectRect(a,e){return"undefined"!=typeof a&&"undefined"!=typeof e?!(e[0]>a[2]||e[2]<a[0]||e[1]>a[3]||e[3]<a[1]):!1}function overlapRect(a,e){return intersectRect(a,e)?(Math.max(a[0],e[0])-Math.min(a[2],e[2]))*(Math.max(a[1],e[1])-Math.min(a[3],e[3])):0}
function rectFromTwoPoints(a,e,m){m=m||0;var n,c,l;a.x<e.x?(n=a.x,l=e.x):(n=e.x,l=a.x);a.y<e.y?(c=a.y,a=e.y):(c=e.y,a=a.y);e=l-n;var g=a-c;e<m&&(l+=m-e,e=l-n);g<m&&(a+=m-g,g=a-c);return{left:n,top:c,right:l,bottom:a,width:e,height:g}}function updateMarquee(a,e,m){e=rectFromTwoPoints(e,m);m=$("#selectionAdorner");jQuery.contains(m,a)||m.append(a);a.is(":visible")||a.show();a.css({left:px(e.left),top:px(e.top),width:px(e.width),height:px(e.height)})}
function clampToView(a){var e=a.x,m=a.y;0>a.x&&(e=0);a.x>boardWidth&&(e=boardWidth);0>a.y&&(m=0);a.y>boardHeight&&(m=boardHeight);return{x:e,y:m}}
var bounceButton=function(a){var e=$(a);e.addClass("activeBrush");setTimeout(function(){e.removeClass("activeBrush")},200)},Modes=function(){var a=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},e=function(c,e){a();$(c).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$(e).addClass("activeTool").removeClass("inactiveTool")},m={name:"none",activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.none;a()},deactivate:function(){a();unregisterPositionHandlers(board)}},n=function(c,a){c in Modes.canvasInteractables||(Modes.canvasInteractables[c]=[]);Modes.canvasInteractables[c].push(a)};$(function(){var c={opacity:1};(new TWEEN.Tween(c)).delay(1E3).to({opacity:.3},1E3);var a=Modes.select.handlesAtZoom(),e=function(){return{activated:!1,originalHeight:1,originalWidth:1,rehome:function(f){if(!e.activated){var b=Modes.select.handlesAtZoom(),a=f.x+b/2;e.bounds=[a-b/2,f.y-
b,a+b/2,f.y]}},down:function(f){e.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=f;Modes.select.marqueeWorldOrigin=f;blit()},move:function(f){e.activated&&(e.bounds=[f.x-a,f.y,f.x+a,f.y],Modes.select.offset=f,blit());return!1},deactivate:function(){e.activated=!1;Modes.select.dragging=!1},up:function(f){e.deactivate();var b=batchTransform(),a=f.x-Modes.select.marqueeWorldOrigin.x,c=f.y-Modes.select.marqueeWorldOrigin.y;b.xTranslate=a;b.yTranslate=c;b.inkIds=_.keys(Modes.select.selected.inks);
b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(b.multiWordTextIds,function(b){Modes.text.echoesToDisregard[b]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(b){b.doc.position.x+=a;b.doc.position.y+=c;b.doc.invalidateBounds()});sendStanza(b);registerTracker(b.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(f){if(e.bounds){var b=
worldToScreen(e.bounds[0],e.bounds[1]),a=worldToScreen(e.bounds[2],e.bounds[3]).x-b.x,h=b.x,b=b.y;f.globalAlpha=c.opacity;f.setLineDash([]);f.strokeStyle="black";f.fillStyle="white";f.strokeWidth=2;f.fillRect(h,b,a,a);f.strokeRect(h,b,a,a);f.font=sprintf("%spx FontAwesome",a);f.fillStyle="black";f.fillText("\uf047",h,b+a-4)}}}}(),h=function(){return{activated:!1,originalHeight:1,originalWidth:1,rehome:function(f){if(!h.activated){var b=Modes.select.handlesAtZoom(),a=f.x2;f=f.y;h.bounds=[a,f,a+b,f+
b]}},down:function(a){h.activated=!0;Modes.select.aspectLocked=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();return!1},move:function(f){if(h.activated){h.bounds=[f.x-a,h.bounds[1],f.x+a,h.bounds[3]];var b=Modes.select.totalSelectedBounds();Modes.select.offset={x:f.x,y:b.y+(f.x-b.x)/(b.x2-b.x)*b.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;h.activated=!1;Modes.select.resizing=!1},up:function(a){h.deactivate();
var b=batchTransform(),c=Modes.select.totalSelectedBounds();b.xScale=(a.x-c.x)/(c.x2-c.x);b.yScale=b.xScale;b.xOrigin=c.x;b.yOrigin=c.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(a,f){Modes.text.echoesToDisregard[f]=!0;var c=a.doc.save();_.each(c,function(a){a.size*=b.xScale});a.doc.width(a.doc.width()*
b.xScale);a.doc.load(c)});registerTracker(b.identity,function(){Progress.call("onSelectionChanged")});sendStanza(b);return!1},render:function(a){if(h.bounds){var b=worldToScreen(h.bounds[0],h.bounds[1]),e=worldToScreen(h.bounds[2],h.bounds[3]).x-b.x,g=e/10,l=-1*e;a.globalAlpha=c.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(b.x,b.y);a.rotate(90*Math.PI/180);a.fillRect(0,l,e,e);a.strokeRect(0,l,e,e);a.font=sprintf("%spx FontAwesome",e);a.fillStyle=
"black";a.fillText("\uf0b2",g,-1*g)}}}}(),p=function(){return{activated:!1,rehome:function(a){if(!p.activated){var b=Modes.select.handlesAtZoom(),c=a.x2;a=a.y2;p.bounds=[c,a-b,c+b,a]}},down:function(a){p.activated=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();return!1},move:function(c){p.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),p.bounds=[c.x-a,c.y-a,c.x+a,c.y+a],Modes.select.offset=
{x:c.x,y:c.y},blit());return!1},deactivate:function(){p.activated=!1;Modes.select.resizing=!1},up:function(a){p.deactivate();var b=batchTransform(),c=Modes.select.totalSelectedBounds(),e=c.y2-c.y,h=a.y-c.y;b.xScale=(a.x-c.x)/(c.x2-c.x);b.yScale=h/e;b.xOrigin=c.x;b.yOrigin=c.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);_.each(Modes.select.selected.multiWordTexts,function(a){a.doc.width(Math.max(a.doc.width()*
b.xScale,Modes.text.minimumWidth/scale()));sendRichText(a)});Modes.text.invalidateSelectedBoxes();registerTracker(b.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(b);blit();return!1},render:function(a){if(p.bounds){var b=worldToScreen(p.bounds[0],p.bounds[1]),e=worldToScreen(p.bounds[2],p.bounds[3]).x-b.x,h=e/10,g=-1*e;a.globalAlpha=c.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(b.x,b.y);a.rotate(90*Math.PI/180);a.fillRect(0,
g,e,e);a.strokeRect(0,g,e,e);a.font=sprintf("%spx FontAwesome",e);a.fillStyle="black";a.fillText("\uf065",h,-1*h)}}}}();n("manualMove",e);n("resizeFree",p);n("resizeAspectLocked",h);Progress.textBoundsChanged.selectionHandles=function(a,b){if(a in Modes.select.selected.multiWordTexts){var c=Modes.select.totalSelectedBounds();e.rehome(c);p.rehome(c);h.rehome(c)}};Progress.onSelectionChanged.selectionHandles=function(){var a=Modes.select.totalSelectedBounds();Infinity==a.x?c.opacity=0:(c.opacity=1,
e.rehome(a),p.rehome(a),h.rehome(a))}});return{currentMode:m,none:m,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),function(a){_.forEach(Modes.canvasInteractables[a],function(a){void 0!=a&&"deactivate"in a&&a.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var c=function(){},l,g,h,p,f,b,q,m,v,u,y,n=function(a,d){var b=Modes.text.minimumWidth/scale(),b=Modes.text.editorFor({bounds:[a.x,
a.y,a.x,a.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),requestedWidth:b,width:b,height:0,x:a.x,y:a.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});b.doc.load(d);return b},t=function(a){return function(){var d=!1;_.each(boardContent.multiWordTexts,function(b){if(b.doc.isActive){d=!0;var c=b.doc.selectedRange();carota.runs.nextInsertFormatting={};c.setFormatting(a,!0!==c.getFormatting()[a]);0<b.doc.save().length&&
sendRichText(b)}});if(!d){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var b=carota.runs.nextInsertFormatting[a]=!carota.runs.nextInsertFormatting[a];$(sprintf(".font%sSelector",_.capitalize(a))).toggleClass("active",b)}}},w=function(a,d){return function(){var b=!1;d=d||$(this).val();_.each(boardContent.multiWordTexts,function(c){c.doc.isActive&&(b=!0,carota.runs.nextInsertFormatting={},c.doc.selectedRange().setFormatting(a,d),0<c.doc.save().length&&sendRichText(c))});b||
(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[a]=d)}},x=function(a){return function(){_.each(boardContent.multiWordTexts,function(d){var b=d.doc;if(b.isActive){var c=b.save();_.each(c,function(d){d.size*=a});b.load(c);0<b.save().length&&sendRichText(d)}})}};$(function(){p=$(".fontBoldSelector");f=$(".fontItalicSelector");b=$(".fontUnderlineSelector");v=$("#textDropdowns");m=$("#fontOptions");l=$("#fontFamilySelector");g=$("#fontSizeSelector");
h=$("#fontColorSelector");u=$("#fontLarger");y=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");q=$("#presetFullscreen");$("#presetCenterOnScreen");var a=l.find(".fontFamilyOption").clone(),d=g.find(".fontSizeOption").clone(),c=h.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(d){l.append(a.clone().attr("value",d).text(d))});Fonts.getAllSizes().map(function(a){g.append(d.clone().attr("value",a).text(a))});
Colors.getAllNamedColors().map(function(a){h.append(c.clone().attr("value",a.rgb).text(a.name))});u.click(x(1.2));y.click(x(.8));p.click(t("bold"));f.click(t("italic"));b.click(t("underline"));var e={red:"#ff0000",blue:"#0000ff",black:"#000000"};_.each(["red","blue","black"],function(a){$(sprintf("#%sText",a)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");w("color",[e[a],255])()})});q.click(function(a){return function(){_.each(boardContent.multiWordTexts,
function(d){if(d.doc.isActive){switch(a){case "runToEdge":var b=screenToWorld(boardWidth,0);d.doc.width(b.x+viewboxX-d.x);break;case "fitToText":d.doc.width(d.doc.frame.actualWidth());break;case "widen":d.doc.width(1.6*d.doc.frame.actualWidth());break;case "narrow":d.doc.width(.6*d.doc.frame.actualWidth());break;case "centerOnScreen":d.doc.width(screenToWorld(boardWidth,0).x);d.doc.selectedRange().setFormatting("align","center");d.doc.position.x=viewboxX;break;case "fullscreen":d.doc.position.x=viewboxX,
d.doc.position.y=viewboxY,d.doc.width(screenToWorld(boardWidth,0).x)}d.doc.contentChanged.fire()}})}}("fullscreen"));m.click(function(){v.toggle()});$("#closeTextDialog").click(function(){v.hide()});$("#exitTextEditing").click(function(){Modes.select.activate()})});return{echoesToDisregard:{},minimumWidth:240,minimumHeight:function(){return 3*Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},
mapSelected:function(a){var d=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,function(b){b.identity in d&&a(b)})},scrollToCursor:function(a){var d=a.bounds,b=a.doc.selectedRange().start;a=a.doc.getCaretCoords(b);var b=Math.floor(a.t/a.h),c=Math.floor(scaleScreenToWorld(boardContext.height)/a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var b=Math.min(b,Math.max(0,c-2))*a.h,c=Math.max(d[2]-d[0],scaleWorldToScreen(10*a.h)),e=c/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);
TweenController.zoomAndPanViewbox(d[0],d[1]-b+a.t,c,e)}else d=Math.max(0,Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(d[1]-viewboxY))/a.h)-4))*a.h,0!=d&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+d,viewboxWidth,viewboxHeight)},editorFor:function(a){var d=boardContent.multiWordTexts[a.identity];d||(d=boardContent.multiWordTexts[a.identity]=a);if(!d.doc){var e=a.author==UserSettings.getUsername();d.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",a.identity)}).appendTo($("#textInputInvisibleHost"))[0],
board[0],e?blit:c,a);e&&(d.doc.contentChanged(function(){Modes.text.scrollToCursor(d);var a=boardContent.multiWordTexts[d.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);incorporateBoardBounds(d.bounds)}),d.doc.selectionChanged(function(a,c){if(0<d.doc.save().length){var e=a();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var k=[$("#blackText"),$("#redText"),$("#blueText")],h=function(a,
d){var b=1==e[d];b&&(carota.runs.nextInsertFormatting[d]=b);a.toggleClass("active",b)},g=function(a,d,b){var c=_.isEqual(e[d],b);d in e&&c&&(carota.runs.nextInsertFormatting[d]=b);a.toggleClass("active",c)};h(p,"bold");h(f,"italic");h(b,"underline");g(k[0],"color",["#000000",255]);g(k[1],"color",["#ff0000",255]);g(k[2],"color",["#0000ff",255]);c&&Modes.text.scrollToCursor(d)}}))}d.doc.position={x:a.x,y:a.y};d.doc.width(a.width);return d},draw:function(a){a&&a.doc&&carota.editor.paint(board[0],a.doc,
!0)},editorAt:function(a,d,b,c){var e=UserSettings.getUsername(),f=[c.x-10,c.y-10,c.x+10,c.y+10];a=_.values(boardContent.multiWordTexts).filter(function(a){var d=intersectRect(a.bounds,f);d&&(console.log("intersects",a.bounds,f),console.log(sprintf("%s clicked box by %s",Participants.code(e),Participants.code(a.author))));return d&&a.author==e});return 0<a.length?a[0]:!1},contextFor:function(a,d){var b={x:d.x-a.position.x,y:d.y-a.position.y};return{node:a.byCoordinate(b.x,b.y),relativePos:b}},activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.text;e("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var a=Date.now();registerPositionHandlers(board,function(a,b,c,e){if(a=Modes.text.editorAt(a,b,c,e).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,e).node)},function(a,b,c,e){(a=Modes.text.editorAt(a,b,c,e).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,e).node)},function(b,c,e,f){var h=Date.now(),g=Modes.text.editorAt(b,c,e,f);
_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=a.doc.identity==g.identity;0==a.doc.save().length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();g?(b=g.doc,f=Modes.text.contextFor(b,f),500>=h-a&&b.dblclickHandler(f.node),a=h,h={multiWordTexts:{}},h.multiWordTexts[g.identity]=g,Modes.select.setSelection(h),b.mouseupHandler(f.node)):(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},b=n(f,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,
bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.size/scale()}]),f=b.doc,f.select(0,1),boardContent.multiWordTexts[b.identity]=b,h={multiWordTexts:{}},h.multiWordTexts[b.identity]=boardContent.multiWordTexts[b.identity],Modes.select.setSelection(h),g=b,h=f.byOrdinal(0),f.mousedownHandler(h),f.mouseupHandler(h));g.doc.invalidateBounds();
g.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(g);Progress.call("onSelectionChanged",[Modes.select.selected])})},deactivate:function(){DeviceConfiguration.setKeyboard(!1);a();v.hide();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=!1;0==_.trim(a.doc.save()).length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();blit()}}}(),image:function(){var c=
{},l=void 0,g=void 0,h=function(){l.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=g.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();g.unwrap()},p=function(){var a=function(a,b,c,e){for(var d=b*c;d>a;)b*=.8,c*=.8,d=b*c;return{w:b,h:c,q:e}},b={"native":{resizeFunc:function(a,b){return{w:a,h:b,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(b,c){return a(1*e,b,c,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(b,c){return a(3*e,
b,c,.8)},selector:"#imageInsertHighDef"}},c=b.optimized,e=1048576,f=function(){_.forEach(b,function(a){var b=$(a.selector);c.selector==a.selector?b.addClass("activeBrush"):b.removeClass("activeBrush")})};$(function(){_.forEach(b,function(a){$(a.selector).on("click",function(){c=a;f()})});f()});return{reapplyVisualStyle:f,changeMode:function(a){a in b&&(c=b[a],f())},getResizeFunction:function(){return c.resizeFunc}}}(),f=function(a){if(void 0!=c&&void 0!=c.fileUpload&&void 0!=a){$("#imageWorking").show();
$("#imageFileChoice").hide();var b=new FileReader;b.onload=function(b){var e=$("<canvas/>"),f=new Image,h=b.target.result,g=h.length;f.onload=function(b){var u=f.width,d=f.height,k=p.getResizeFunction()(u,d);b=k.w;var l=k.h,k=k.q;e.width=u;e.height=d;e.attr("width",u);e.attr("height",d);e.css({width:px(u),height:px(d)});e[0].getContext("2d").drawImage(f,0,0,u,d);u=multiStageRescale(e[0],b,l);c.width=b;c.height=l;c.resizedImage=u.toDataURL("image/jpeg",k);g<c.resizedImage.length&&(c.resizedImage=h);
a()};f.src=h};b.readAsDataURL(c.fileUpload)}},b=function(){if("imageDefinition"==c.type){WorkQueue.pause();var a=Date.now(),b=sprintf("%s%s",UserSettings.getUsername(),a),e=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",e.toString(),encodeURI(b));$.ajax({url:b,type:"POST",success:function(b){var f=$(b).find("resourceUrl").text(),g={type:"image",author:UserSettings.getUsername(),timestamp:a,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+
'","id":"'+f+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:f,slide:e.toString(),source:$(b).text(),bounds:[c.x,c.y,c.x+c.width,c.y+c.height],width:c.width,height:c.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:c.x,y:c.y};registerTracker(f,function(){var a=Modes.select.handlesAtZoom(),b=g.x,c=g.y,d=Math.max(g.width,viewboxWidth),e=Math.max(g.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,d+2*a,e+2*a);Modes.select.clearSelection();
Modes.select.selected.images[g.identity]=boardContent.images[g.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(g);h();WorkQueue.gracefullyResume()},error:function(a){console.log(a);h();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:c.resizedImage,cache:!1,contentType:!1,processData:!1})}},q=!1;$(function(){q||(q=!0,l=$("#imageInsertOptions").css({position:"absolute",
left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),g=$("#imageFileChoice").attr("accept","image/*"),g[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("image")&&(c.fileUpload=a);f(b)},!1),h())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.image;e("#imageTools","#imageMode");var a=screenToWorld(10,10);c={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");
p.reapplyVisualStyle();l.show()},deactivate:function(){h();a()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");Modes.currentMode.deactivate();e("#panTools","#panMode");Modes.currentMode=Modes.pan;var a,l;registerPositionHandlers(board,function(e,h,p){takeControlOfViewbox();a=e;l=h},function(e,h,p){Pan.translate(-1*(e-a),-1*(h-l));a=e;l=h},function(a,c,e){})},deactivate:function(){a();unregisterPositionHandlers(board)}},select:function(){var c=!1,l=function(){Modes.select.selected={images:{},
text:{},inks:{},multiWordTexts:{}};Progress.call("onSelectionChanged",[Modes.select.selected])},g=_.debounce(function(){var a=!1;_.forEach(["images","texts","inks","highlighters","multiWordTexts"],function(c){var e="highlighters"==c?"inks":c;if(Modes&&Modes.select&&Modes.select.selected&&e in Modes.select.selected){var f=Modes.select.selected[e];_.forEach(f,function(h){f&&c in boardContent&&h&&h.identity in boardContent[c]?f[h.identity]=boardContent[c][h.identity]:(a=!0,"inks"==e?"highlighters"==
c&&h.identity in f&&1==f[h.identity].isHighlighter?delete f[h.identity]:"inks"==c&&h.identity in f&&0==f[h.identity].isHighlighter&&delete f[h.identity]:delete f[h.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),h=function(){if(void 0!=Modes.select.selected&&c&&"Blacklist"in window){var a=Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),a.inks,a.texts,a.multiWordTexts,a.images)}l()},p=function(){(c=
Conversations.shouldModifyConversation()?!c:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");l()},f=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),$("#ban").removeClass("disabledButton"),$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());c?$("#administerContent").addClass("activeBrush"):
$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=g;Progress.onViewboxChanged.ModesSelect=g;Progress.onSelectionChanged.ModesSelect=function(a){a&&(Modes.select.selected=a,"images"in a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||"multiWordTexts"in a&&0<_.size(a.multiWordTexts)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),c?($("#ban").removeClass("disabledButton"),$("#delete").addClass("disabledButton")):
($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=l;Progress.conversationDetailsReceived.ModesSelect=function(a){c&&!Conversations.shouldModifyConversation(a)&&
(c=!1);Conversations.shouldModifyConversation(a)?($("#administerContent").unbind("click").bind("click",p),$("#ban").unbind("click").bind("click",h)):($("#administerContent").unbind("click"),$("#ban").unbind("click"));f(a)};return{name:"select",selected:{images:{},texts:{},inks:{},multiWordTexts:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",
function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},c=function(c){c=c.bounds;a.x=Math.min(a.x,c[0]);a.y=Math.min(a.y,c[1]);a.x2=Math.max(a.x2,c[2]);a.y2=Math.max(a.y2,c[3])};_.forEach(Modes.select.selected.inks,c);_.forEach(Modes.select.selected.texts,c);_.forEach(Modes.select.selected.images,c);_.forEach(Modes.select.selected.multiWordTexts,c);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),offset:{x:0,y:0},marqueeWorldOrigin:{x:0,
y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:l,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;e("#selectTools","#selectMode");var a={x:0,y:0},h=$("<div/>",{id:"selectMarquee"}),g=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&!c){var a=batchTransform();a.isDeleted=!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&(a.textIds=_.keys(Modes.select.selected.texts));
"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));sendStanza(a);l()}});var p=function(a){a("images");a("texts");a("multiWordTexts");a("inks")};Modes.select.dragging=!1;f();Modes.select.resizing=!1;registerPositionHandlers(board,function(c,e,f,l,p){Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:c,y:e};Modes.select.marqueeWorldOrigin=l;if(!p.ctrl&&Infinity!=
Modes.select.totalSelectedBounds().x){c=10/scale();var x=[l.x-c,l.y-c,l.x+c,l.y+c];Modes.select.dragging=_.some(["images","texts","inks","multiWordTexts"],function(a){return _.some(Modes.select.selected[a],function(a){return a?intersectRect(a.bounds,x):!1})})}Modes.select.dragging?(Modes.select.offset=l,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(g.empty(),g.append(h),h.show(),updateMarquee(h,a,a))},function(c,e,f,g,l){c={x:c,y:e};Modes.select.offset=g;
Modes.select.dragging?blit():Modes.select.resizing?blit():updateMarquee(h,a,c)},function(a,b,e,f,g){WorkQueue.gracefullyResume();try{var l=f.x-Modes.select.marqueeWorldOrigin.x,m=f.y-Modes.select.marqueeWorldOrigin.y;15>Math.abs(l)+Math.abs(m)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=l;a.doc.position.y+=
m;a.doc.invalidateBounds()});var d=batchTransform();d.xTranslate=l;d.yTranslate=m;d.inkIds=_.keys(Modes.select.selected.inks);d.textIds=_.keys(Modes.select.selected.texts);d.imageIds=_.keys(Modes.select.selected.images);d.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(d.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(d)}else{var k=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,f,2),n=[k.left,k.top,k.right,k.bottom],
A={images:{},texts:{},inks:{},multiWordTexts:{}},C={},D={};p(function(a){$.each(boardContent[a],function(b,d){if(!("bounds"in d)&&"type"in d)switch(d.type){case "text":prerenderText(d);break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;default:d.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(n,d.bounds)&&(incrementKey(C,d.author),incrementKey(D,"any"),c?d.author!=UserSettings.getUsername()&&(A[a][d.identity]=d):d.author==UserSettings.getUsername()&&(A[a][d.identity]=d))})});$.each(boardContent.highlighters,
function(a,b){intersectRect(b.bounds,n)&&(incrementKey(C,b.author),c?b.author!=UserSettings.getUsername()&&(A.inks[b.identity]=b):b.author==UserSettings.getUsername()&&(A.inks[b.identity]=b))});p(function(a){$.each(A[a],function(b,d){a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=d})});D.any||Modes.select.clearSelection();var E=sprintf("Selected %s images, %s texts, %s inks, %s rich texts ",_.keys(Modes.select.selected.images).length,
_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,_.keys(Modes.select.selected.inks).length);$.each(C,function(a,b){E+=sprintf("%s:%s ",a,b)});Progress.call("onSelectionChanged",[Modes.select.selected])}h.css({width:0,height:0}).hide();blit()}catch(F){console.log("Selection up",F)}})},deactivate:function(){unregisterPositionHandlers(board);a();l();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();
f();blit()}}}(),zoom:{name:"zoom",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;e("#zoomTools","#zoomMode");var a=$("<div />",{id:"zoomMarquee"}),l,g={x:0,y:0};registerPositionHandlers(board,function(e,p,f,b){takeControlOfViewbox();l=b;a.show();a.appendTo($("#selectionAdorner"));g={x:e,y:p};updateMarquee(a,g,g)},function(e,l,f,b){e={x:e,y:l};l=rectFromTwoPoints(e,g);f="left";b="top";e.x==l.left&&(f="right");e.y==l.top&&(b="bottom");e=aspectConstrainedRect(l,f,b);
updateMarquee(a,{x:e.right,y:e.bottom},{x:e.left,y:e.top})},function(e,g,f,b){WorkQueue.gracefullyResume();a.hide();e={x:contentOffsetX+b.x,y:contentOffsetY+b.y};g=rectFromTwoPoints(e,{x:contentOffsetX+l.x,y:contentOffsetY+l.y});2500>scale()*g.width*g.height||(f="left",b="top",e.x==g.left&&(f="right"),e.y==g.top&&(b="bottom"),e=aspectConstrainedRect(g,f,b),IncludeView.specific(e.left,e.top,e.width,e.height))})},deactivate:function(){a();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},
feedback:function(){var c=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){c()};Progress.conversationDetailsReceived.respectNewPermissions=c;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;c();e("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(a,c,e,m){},
function(a,c,e,m){},function(a,c,e,m){});c()},deactivate:function(){a();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),draw:function(){var c=Brushes.getDefaultBrushes(),l=_.map(c,function(a){return _.clone(a)}),g,h=!1,m=void 0,f=void 0,b=function(a){l[a.index]=a},n=function(){},z=function(){},v=function(){};$(function(){$(".activeBrush").removeClass("activeBrush");var a=function(){var a=$("#drawTools");_.each(a.find(".modeSpecificTool.pen"),function(a,d){var c=l[d],f=$(a).css({color:c.color}).click(function(){$(".activeBrush").removeClass("activeBrush");
$(this).addClass("activeBrush");g=c;b(c);Modes.draw.drawingAttributes=g;h=!1;e(c)}).removeClass("fa-tint").removeClass("fa-circle").addClass(c.isHighlighter?"fa-circle":"fa-tint");f.find(".widthIndicator").text(c.width);c==g&&f.addClass("activeBrush")})},e=function(c){var h=$("#colors .dots"),d=$("#sizes .dots"),k=Colors.getAllNamedColors(),l=Brushes.getAllBrushSizes();d.empty();l.map(function(f){var h=m.clone();d.append(h);h.click(function(){c.width=f;b(c);g=c;a();e(c)});var k=Canvas.circle(c.color,
f,50);f==c.width&&h.addClass("activeTool");h.prepend(k);k=f.toString()+"px";h.find(".sizeDotName").append(k)});h.empty();k.map(function(d){var k=f.clone();h.append(k);k.on("click",function(){c.color=d.rgb;g=c;b(c);a();e(c)});k.css("color",d.rgb);"rgb"in d&&d.rgb==c.color&&k.addClass("activeTool");var l=d.name;k.find(".colorDotName").append(l)});k=$("#setPenToHighlighter").unbind("click").on("click",function(){c.isHighlighter=!0;g=c;b(c);a();e(c)});l=$("#setPenToPen").unbind("click").on("click",function(){c.isHighlighter=
!1;g=c;b(c);a();e(c)});"isHighlighter"in g&&g.isHighlighter?(k.addClass("activeTool").addClass("active"),l.removeClass("activeTool").removeClass("active")):(l.addClass("activeTool").addClass("active"),k.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var b=_.find(c,function(a){return a.id==g.id});void 0!=b&&(g.width=b.width,g.color=b.color,g.isHighlighter=b.isHighlighter,a(),e(g))});m=$("#penSize .sizeDot").clone();f=$("#penColor .colorDot").clone();
g=l[0];a();e(g);var B=$("#drawTools");B.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");h=!0;$("#drawDropdowns").hide()});B.find(".advancedTools").unbind("click").on("click",function(){h||(e(g),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});var t=[];z=function(a,b,c,e,f){w=[];h||f.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,
boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,t=[a,b,256*c])};var w=[];v=function(a,b,c,e,f){if(h||f.eraser){var g=[e.x-10,e.y-10,e.x+10,e.y+10];a=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,g)){delete a[c.identity];w.push(c.identity);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";a(boardContent.inks);
a(boardContent.highlighters);boardContext.globalAlpha=1}else e=Modes.draw.drawingAttributes.width*c,boardContext.beginPath(),boardContext.lineCap="round",boardContext.lineWidth=e,e=_.takeRight(t,3),boardContext.moveTo(e[0],e[1]),boardContext.lineTo(a,b),boardContext.stroke(),t=t.concat([a,b,256*c])};n=function(a,b,c,e,f){h||f.eraser?(a=batchTransform(),a.isDeleted=!0,a.inkIds=w,sendStanza(a)):(e=Modes.draw.drawingAttributes.width*c,boardContext.lineWidth=e,boardContext.beginPath(),boardContext.lineWidth=
e,boardContext.lineCap="round",e=_.takeRight(t,3),boardContext.moveTo(e[0],e[1]),boardContext.lineTo(a,b),boardContext.stroke(),t=t.concat([a,b,256*c]),strokeCollected(t.join(" ")));boardContext.globalAlpha=1}});return{name:"draw",brushes:l,activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,Modes.draw.drawingAttributes=g,e("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),h?$("#drawTools").find(".eraser").addClass("activeBrush"):
_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==g.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,z,v,n))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();a();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,
function(a,e,g,h){},function(a,e,g,h){},function(a,e,g,h){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
