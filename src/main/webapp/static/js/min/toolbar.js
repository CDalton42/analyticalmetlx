function devLogAdd(c){$("#devLog").append($("<div />",{text:c}))}function devLogSet(c){$("#devLog").html($("<div />",{text:c}))}var incrementKey=function(c,e){e in c?c[e]++:c[e]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(c){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(e,f){c.unbind(f)});WorkQueue.gracefullyResume()}
function progress(){var c=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),e=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(c),f=$("<progress />");f.append(c);var k=1,b=0,q=function(){e.css("width",sprintf("%s%%",Math.floor(b/k*100)));f.attr({value:b,max:k})},g={element:f,value:function(c){b=c;q();return g},max:function(b){k=b;q();return g}};return g}
function proportion(c,e){return c/e/(boardWidth/boardHeight)}function scaleScreenToWorld(c){var e;e=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return c*e}function scaleWorldToScreen(c){var e;e=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return c/e}function screenToWorld(c,e){var f=scaleScreenToWorld(c)+viewboxX,k=scaleScreenToWorld(e)+viewboxY;return{x:f,y:k}}
function worldToScreen(c,e){var f=scaleWorldToScreen(c-viewboxX),k=scaleWorldToScreen(e-viewboxY);return{x:f,y:k}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(c){return!1}}
function registerPositionHandlers(c,e,f,k){var b=!1,q=function(b,c){var g=[b.x-10,b.y-10,b.x+10,b.y+10],a=!0;_.each(Modes.canvasInteractables,function(m,e){_.each(m,function(m){void 0!=m&&c in m&&(m.activated||intersectRect(g,m.getBounds()))&&(a=a&&m[c](b))})});return a},g=function(b,c){return{shift:b.shiftKey,ctrl:b.ctrlKey,alt:b.altKey,eraser:c}};$.each(c,function(c,x){var l=$(x);l.css({"touch-action":"none"});var a=!1,m={},u=function(d){return void 0!==d&&"touch"==d.originalEvent.pointerType?1<
_.size(m):!1},r=function(d){var h=d.originalEvent.pointerId,b="pen"==d.originalEvent.pointerType&&5==d.originalEvent.button,c=l.offset(),p=d.pageX-c.left,c=d.pageY-c.top,g=d.originalEvent.pressure||.5,e=screenToWorld(p,c),r=m[h]||{pointerId:h,pointerType:d.originalEvent.pointerType,eraser:b,points:[]};r.points.push({x:e.x,y:e.y,screenX:p,screenY:c,z:g});r.eraser=r.eraser||b;"touch"==d.originalEvent.pointerType&&(m[h]=r);u(d)&&(0==a&&_.each(m,function(d){d.points=[_.last(d.points)]}),a=!0);return{pointerType:d.pointerType,
eraser:r.eraser,x:p,y:c,z:g,worldPos:e}},p=function(d){var h=d.originalEvent.pointerId,c="pen"==d.originalEvent.pointerType&&5==d.originalEvent.button,y=l.offset(),p=d.pageX-y.left,y=d.pageY-y.top,g=d.originalEvent.pressure||.5,e=screenToWorld(p,y);"touch"==d.originalEvent.pointerType&&delete m[h];a&&0==_.size(m)&&(b=a=!1);return{pointerType:d.pointerType,eraser:c,x:p,y:y,z:g,worldPos:e}};if(detectPointerEvents()){var C=_.throttle(function(){takeControlOfViewbox();var d=_.map(_.filter(m,function(d){return 0<
_.size(d.points)}),function(d){var a=_.first(d.points);d=_.last(d.points);return[a,d]});m={};var a=_.meanBy(d,function(d){return d[0].x-d[1].x}),h=_.meanBy(d,function(d){return d[0].y-d[1].y});Pan.translate(scaleWorldToScreen(a),scaleWorldToScreen(h));var a=_.min(_.map(d,function(d){return d[0].y})),b=_.max(_.map(d,function(d){return d[0].y})),h=_.min(_.map(d,function(d){return d[0].x})),c=_.max(_.map(d,function(d){return d[0].x})),a=b-a,h=c-h,c=_.min(_.map(d,function(d){return d[1].y})),b=_.max(_.map(d,
function(d){return d[1].y})),p=_.min(_.map(d,function(d){return d[1].x})),d=(_.max(_.map(d,function(d){return d[1].x}))-p+(b-c))/2;Zoom.scale((h+a)/2/d)},25);l.bind("pointerdown",function(d){d.originalEvent.pointerType!=d.POINTER_TYPE_TOUCH&&"touch"!=d.originalEvent.pointerType||!u(d)||(a=!0);var h=r(d);d.preventDefault();WorkQueue.pause();u(d)||a||(b=!0,q(h.worldPos,"down")&&e(h.x,h.y,h.z,h.worldPos,g(d,h.eraser)))});l.bind("pointermove",function(d){var h=r(d);d.preventDefault();d.originalEvent.pointerType!=
d.POINTER_TYPE_TOUCH&&"touch"!=d.originalEvent.pointerType||!u(d)&&!a?q(h.worldPos,"move")&&b&&f(h.x,h.y,h.z,h.worldPos,g(d,h.eraser)):C()});l.bind("pointerup",function(d){var h=p(d);WorkQueue.gracefullyResume();d.preventDefault();q(h.worldPos,"up")&&b&&!a&&k(h.x,h.y,h.z,h.worldPos,g(d,h.eraser));b=!1;Modes.finishInteractableStates()});var v=function(d){p(d);WorkQueue.gracefullyResume();d.preventDefault();if(b){var h=d.offsetX;d=d.offsetY;m={};WorkQueue.gracefullyResume();d=screenToWorld(h,d);h=d.x;
d=d.y;h<viewboxX?(takeControlOfViewbox(),Extend.left()):h>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):d<viewboxY?(takeControlOfViewbox(),Extend.up()):d>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),Extend.down());b=!1;Modes.finishInteractableStates()}b=!1;Modes.finishInteractableStates()};l.bind("pointerout",v);l.bind("pointerleave",v);l.bind("pointercancel",v)}else{l.bind("mousedown",function(d){WorkQueue.pause();var h=l.offset();b=!0;var a=d.pageX-h.left,h=d.pageY-h.top,m=
screenToWorld(a,h);q(m,"down")&&e(a,h,.5,m,g(d));d.preventDefault()});l.bind("mousemove",function(d){var h=l.offset();d.preventDefault();var a=d.pageX-h.left,h=d.pageY-h.top,m=screenToWorld(a,h);q(m,"move")&&b&&f(a,h,.5,m,g(d))});l.bind("mouseup",function(d){WorkQueue.gracefullyResume();d.preventDefault();var h=l.offset(),a=d.pageX-h.left,h=d.pageY-h.top,m=screenToWorld(a,h);q(m,"up")&&b&&k(a,h,.5,m,g(d));b=!1;Modes.finishInteractableStates()});var t=function(d,h){WorkQueue.gracefullyResume();var a=
screenToWorld(d,h),m=a.x,a=a.y;m<viewboxX?(takeControlOfViewbox(),Extend.left()):m>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):a<viewboxY?(takeControlOfViewbox(),Extend.up()):a>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),Extend.down());b=!1};l.bind("mouseout",function(d){WorkQueue.gracefullyResume();d.preventDefault();b&&t(d.offsetX,d.offsetY);b=!1;Modes.finishInteractableStates()});var z,w=function(d){return{x:average(_.map(d,"x")),y:average(_.map(d,"y"))}},A=function(d){var h=
[],a=l.offset();$.each(d,function(d,b){h.push({x:b.pageX-a.left,y:b.pageY-a.top,identifier:b.identifier})});return h};l.bind("touchstart",function(d){WorkQueue.pause();d.preventDefault();var h=A(d.originalEvent.touches);if(1==h.length){var h=h[0],a=screenToWorld(h.x,h.y);b=!0;q(a,"down")&&e(h.x,h.y,.5,a,g(d))}else z=w(h)});l.bind("touchmove",function(d){d.preventDefault();var h=A(d.originalEvent.touches);switch(h.length){case 0:break;case 1:var h=h[0],a=screenToWorld(h.x,h.y);q(a,"move")&&b&&f(h.x,
h.y,.5,a,g(d));break;default:d=w(h),h=d.x-z.x,a=d.y-z.y,z=d,takeControlOfViewbox(),Pan.translate(-1*h,-1*a)}});l.bind("touchend",function(d){WorkQueue.gracefullyResume();d.preventDefault();var h=l.offset(),a=d.originalEvent.changedTouches[0],m=a.pageX-h.left,h=a.pageY-h.top,a=screenToWorld(m,h);q(a,"up")&&b&&(0>m||0>h||m>boardWidth||h>boardHeight?t(m,h):k(m,h,.5,a,g(d)));b=!1;Modes.finishInteractableStates()});var h=1;l.bind("gesturechange",function(d){WorkQueue.pause();d.preventDefault();b=!1;d=
d.originalEvent.scale;takeControlOfViewbox();Zoom.scale(h/d);h=d});l.bind("gestureend",function(){WorkQueue.gracefullyResume();h=1})}});return function(c){b=c}}function aspectConstrainedDimensions(c,e){var f=boardHeight/boardWidth,k={height:e,width:c};e/c>f?k.height=c*f:k.width=e/f;return k}
function aspectConstrainedRect(c,e,f){var k=boardHeight/boardWidth,b={left:c.left,top:c.top,right:c.right,bottom:c.bottom,width:c.width,height:c.height};c.height/c.width>k?(b.height=c.width*k,f&&(e=c.height-b.height,"center"==f?b.top+=e/2:"bottom"==f&&(b.top+=e))):(b.width=c.height/k,e&&(f=c.width-b.width,"center"==e?b.left+=f/2:"right"==e&&(b.left+=f)));b.right=b.left+b.width;b.bottom=b.top+b.height;return b}
function copyBuffer(c){var e=document.createElement("canvas");e.width=c.width;e.height=c.height;e.getContext("2d").drawImage(c,0,0,c.width,c.height,0,0,c.width,c.height);return e}function intersectRect(c,e){return"undefined"!=typeof c&&"undefined"!=typeof e?!(e[0]>c[2]||e[2]<c[0]||e[1]>c[3]||e[3]<c[1]):!1}function overlapRect(c,e){return intersectRect(c,e)?(Math.max(c[0],e[0])-Math.min(c[2],e[2]))*(Math.max(c[1],e[1])-Math.min(c[3],e[3])):0}
function rectFromTwoPoints(c,e,f){f=f||0;var k,b,q;c.x<e.x?(k=c.x,q=e.x):(k=e.x,q=c.x);c.y<e.y?(b=c.y,c=e.y):(b=e.y,c=c.y);e=q-k;var g=c-b;e<f&&(q+=f-e,e=q-k);g<f&&(c+=f-g,g=c-b);return{left:k,top:b,right:q,bottom:c,width:e,height:g}}function updateMarquee(c,e,f){e=rectFromTwoPoints(e,f);f=$("#selectionAdorner");jQuery.contains(f,c)||f.append(c);c.is(":visible")||c.show();c.css({left:px(e.left),top:px(e.top),width:px(e.width),height:px(e.height)})}
function clampToView(c){var e=c.x,f=c.y;0>c.x&&(e=0);c.x>boardWidth&&(e=boardWidth);0>c.y&&(f=0);c.y>boardHeight&&(f=boardHeight);return{x:e,y:f}}
var bounceButton=function(c){var e=$(c);e.addClass("activeBrush");setTimeout(function(){e.removeClass("activeBrush")},200)},videoControlInteractable=function(c){var e=void 0;return{activated:!1,rehome:function(c){},down:function(c){return!1},move:function(c){return!1},up:function(e){var k=Modes.select.handlesAtZoom();e=e.x-c.x;if(e<k)c.getState().paused?c.play():c.pause();else if(e>c.width-k)c.muted(!c.muted());else{var b=c.getState();c.seek((e-k)/(c.width-2*k)*b.duration)}return!1},getBounds:function(){return e},
deactivate:function(){},render:function(f){if(c.identity in boardContent.videos){var k=Modes.select.handlesAtZoom();e=[c.bounds[0],c.bounds[3],c.bounds[2],c.bounds[3]+k];var k=worldToScreen(e[0],e[1]),b=worldToScreen(e[2],e[3]),q=b.x-k.x,g=b.y-k.y,n=c.getState();f.globalAlpha=1;f.setLineDash([]);f.strokeStyle="black";f.font=sprintf("%spx FontAwesome",g);f.fillStyle="white";f.fillRect(k.x,k.y,g,g);f.fillStyle="black";n.paused?f.fillText("\uf04b",k.x,b.y):f.fillText("\uf04c",k.x,b.y);var x=k.x+g,l=
q-g;f.fillStyle="black";f.fillRect(x,k.y,l,g);f.fillStyle="blue";l*=n.currentTime/n.duration;f.fillRect(x,k.y,l,g);q=k.x+(q-g);f.fillStyle="white";f.fillRect(q,k.y,g,g);f.fillStyle="black";n.muted?f.fillText("\uf0f3",q,b.y):f.fillText("\uf1f6",q,b.y)}}}},Modes=function(){var c=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},e=function(b,e){c();$(b).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$(e).addClass("activeTool").removeClass("inactiveTool")},f={name:"none",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.none;c()},deactivate:function(){c();unregisterPositionHandlers(board)}},k=function(b,c){b in Modes.canvasInteractables||(Modes.canvasInteractables[b]=[]);Modes.canvasInteractables[b].push(c)};$(function(){var b={opacity:1};(new TWEEN.Tween(b)).delay(1E3).to({opacity:.3},1E3);var c=Modes.select.handlesAtZoom(),e=function(){var l=void 0;return{getBounds:function(){return l},
activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!e.activated){var b=Modes.select.handlesAtZoom(),c=a.x+b/2;l=[c-b/2,a.y-b,c+b/2,a.y]}},down:function(a){e.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=a;Modes.select.marqueeWorldOrigin=a;blit()},move:function(a){e.activated&&(e.bounds=[a.x-c,a.y,a.x+c,a.y],Modes.select.offset=a,blit());return!1},deactivate:function(){e.activated=!1;Modes.select.dragging=!1},up:function(a){e.deactivate();var b=
batchTransform(),c=a.x-Modes.select.marqueeWorldOrigin.x,r=a.y-Modes.select.marqueeWorldOrigin.y;b.xTranslate=c;b.yTranslate=r;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(b.multiWordTextIds,function(a){Modes.text.echoesToDisregard[a]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(a){a.doc.position.x+=
c;a.doc.position.y+=r;a.doc.invalidateBounds()});sendStanza(b);registerTracker(b.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(a){if(l){var c=worldToScreen(l[0],l[1]),e=worldToScreen(l[2],l[3]).x-c.x,r=c.x,c=c.y;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.fillRect(r,c,e,e);a.strokeRect(r,c,e,e);a.font=sprintf("%spx FontAwesome",e);a.fillStyle="black";a.fillText("\uf047",r,c+e-4)}}}}(),n=function(){var e=
void 0;return{getBounds:function(){return e},activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!n.activated){var b=Modes.select.handlesAtZoom(),c=a.x2;a=a.y;e=[c,a,c+b,a+b]}},down:function(a){Modes.select.aspectLocked=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;n.activated=!0;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};n.rehome(a);blit();return!1},move:function(a){if(n.activated){e=[a.x-c,e[1],a.x+c,e[3]];var b=Modes.select.totalSelectedBounds();
Modes.select.offset={x:a.x,y:b.y+(a.x-b.x)/(b.x2-b.x)*b.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;n.activated=!1;Modes.select.resizing=!1},up:function(a){n.deactivate();var b=batchTransform(),c=Modes.select.totalSelectedBounds();b.xScale=(a.x-c.x)/(c.x2-c.x);b.yScale=b.xScale;b.xOrigin=c.x;b.yOrigin=c.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);
b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(a,c){Modes.text.echoesToDisregard[c]=!0;var e=a.doc.documentRange();a.doc.select(e.start,e.end);Modes.text.scaleEditor(a.doc,b.xScale);a.doc.select(0,0);a.doc.width(a.doc.width()*b.xScale);a.doc.invalidateBounds()});registerTracker(b.identity,function(){Progress.call("onSelectionChanged")});sendStanza(b);return!1},render:function(a){if(e){var c=worldToScreen(e[0],e[1]),g=worldToScreen(e[2],
e[3]).x-c.x,r=g/10,p=-1*g;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(c.x,c.y);a.rotate(90*Math.PI/180);a.fillRect(0,p,g,g);a.strokeRect(0,p,g,g);a.font=sprintf("%spx FontAwesome",g);a.fillStyle="black";a.fillText("\uf0b2",r,-1*r)}}}}(),f=function(){var e=void 0;return{activated:!1,getBounds:function(){return e},rehome:function(a){if(!f.activated){var b=Modes.select.handlesAtZoom(),c=a.x2;a=a.y2;e=[c,a-b,c+b,a]}},down:function(a){f.activated=
!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();console.log("Free transform down");return!1},move:function(a){f.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),f.bounds=[a.x-c,a.y-c,a.x+c,a.y+c],Modes.select.offset={x:a.x,y:a.y},blit());return!1},deactivate:function(){f.activated=!1;Modes.select.resizing=!1},up:function(a){f.deactivate();var b=batchTransform(),c=Modes.select.totalSelectedBounds(),
e=c.y2-c.y,p=a.y-c.y;b.xScale=(a.x-c.x)/(c.x2-c.x);b.yScale=p/e;b.xOrigin=c.x;b.yOrigin=c.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);_.each(Modes.select.selected.multiWordTexts,function(a){a.doc.width(Math.max(a.doc.width()*b.xScale,Modes.text.minimumWidth/scale()));a.doc.invalidateBounds();0<a.doc.save().length&&sendRichText(a)});registerTracker(b.identity,
function(){Progress.call("onSelectionChanged");blit()});console.log("Free transform up");sendStanza(b);blit();return!1},render:function(a){if(e){var c=worldToScreen(e[0],e[1]),g=worldToScreen(e[2],e[3]).x-c.x,r=g/10,p=-1*g;a.globalAlpha=b.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(c.x,c.y);a.rotate(90*Math.PI/180);a.fillRect(0,p,g,g);a.strokeRect(0,p,g,g);a.font=sprintf("%spx FontAwesome",g);a.fillStyle="black";a.fillText("\uf065",r,-1*r)}}}}();
k("manualMove",e);k("resizeFree",f);k("resizeAspectLocked",n);Progress.textBoundsChanged.selectionHandles=function(b,a){if(b in Modes.select.selected.multiWordTexts){var c=Modes.select.totalSelectedBounds();e.rehome(c);f.rehome(c);n.rehome(c)}};Progress.onSelectionChanged.selectionHandles=function(){var c=Modes.select.totalSelectedBounds();Infinity==c.x?b.opacity=0:(b.opacity=1,e.rehome(c),f.rehome(c),n.rehome(c))}});return{pushCanvasInteractable:k,clearCanvasInteractables:function(b){Modes.canvasInteractables[b]=
[]},getCanvasInteractables:function(){return _.mapValues(Modes.canvasInteractables,function(b){return _.map(b,function(b){b=_.clone(b);b.bounds=b.getBounds();return b})})},currentMode:f,none:f,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),function(b){_.forEach(Modes.canvasInteractables[b],function(b){void 0!=b&&"deactivate"in b&&b.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var b=
function(){},f,g,n,k,l,a,m,u,r,p,C,v=function(h,d){var a=Modes.text.minimumWidth/scale(),a=Modes.text.editorFor({bounds:[h.x,h.y,h.x,h.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),slide:Conversations.getCurrentSlideJid(),target:"presentationSpace",requestedWidth:a,width:a,height:0,x:h.x,y:h.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});a.doc.load(d);return a},t=function(h){return function(){var d=!1;_.each(boardContent.multiWordTexts,
function(a){if(a.doc.isActive){d=!0;var b=a.doc.selectedRange();carota.runs.nextInsertFormatting={};b.setFormatting(h,!0!==b.getFormatting()[h]);0<a.doc.save().length&&sendRichText(a)}});if(!d){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var a=carota.runs.nextInsertFormatting[h]=!carota.runs.nextInsertFormatting[h];$(sprintf(".font%sSelector",_.capitalize(h))).toggleClass("active",a)}}},z=function(h,d){return function(){var a=!1;d=d||$(this).val();_.each(boardContent.multiWordTexts,
function(b){b.doc.isActive&&(a=!0,carota.runs.nextInsertFormatting={},b.doc.selectedRange().setFormatting(h,d),0<b.doc.save().length&&sendRichText(b))});a||(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[h]=d)}},w=function(h,d){var a=h.selectedRange(),b=0,c=[],e=carota.runs.defaultFormatting.size;h.runs(function(a){a=_.size(a.text);a=b+a;h.select(b,a,!0);var d=h.selectedRange().getFormatting().size||e;_.each(_.range(b,a),function(){c.push(d)});
b=a;e=d},h.range(0,a.end));c=c.reverse();b=a.start;h.runs(function(a){a=b+a.text.length;h.select(b,a,!0);h.selectedRange().setFormatting("size",c[b]*d);b=a},h.range(a.start,a.end));h.select(a.start,a.end,!0)},A=function(a){return function(){_.each(boardContent.multiWordTexts,function(d){d=d.doc;d.isActive&&w(d,a)})}};$(function(){k=$(".fontBoldSelector");l=$(".fontItalicSelector");a=$(".fontUnderlineSelector");r=$("#textDropdowns");u=$("#fontOptions");f=$("#fontFamilySelector");g=$("#fontSizeSelector");
n=$("#fontColorSelector");p=$("#fontLarger");C=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");m=$("#presetFullscreen");$("#presetCenterOnScreen");var h=f.find(".fontFamilyOption").clone(),d=g.find(".fontSizeOption").clone(),b=n.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(a){f.append(h.clone().attr("value",a).text(a))});Fonts.getAllSizes().map(function(a){g.append(d.clone().attr("value",a).text(a))});
Colors.getAllNamedColors().map(function(a){n.append(b.clone().attr("value",a.rgb).text(a.name))});p.on("click",A(1.2));C.click(A(.8));k.click(t("bold"));l.click(t("italic"));a.click(t("underline"));var c={red:"#ff0000",blue:"#0000ff",black:"#000000",yellow:"#ffff00"};_.each(["red","blue","black","yellow"],function(a){$(sprintf("#%sText",a)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");z("color",[c[a],255])()})});m.click(function(a){return function(){_.each(boardContent.multiWordTexts,
function(d){if(d.doc.isActive){switch(a){case "runToEdge":var h=screenToWorld(boardWidth,0);d.doc.width(h.x+viewboxX-d.x);break;case "fitToText":d.doc.width(d.doc.frame.actualWidth());break;case "widen":d.doc.width(1.6*d.doc.frame.actualWidth());break;case "narrow":d.doc.width(.6*d.doc.frame.actualWidth());break;case "centerOnScreen":d.doc.width(screenToWorld(boardWidth,0).x);d.doc.selectedRange().setFormatting("align","center");d.doc.position.x=viewboxX;break;case "fullscreen":d.doc.position.x=viewboxX,
d.doc.position.y=viewboxY,d.doc.width(screenToWorld(boardWidth,0).x)}d.doc.contentChanged.fire()}})}}("fullscreen"));u.click(function(){r.toggle()});$("#closeTextDialog").click(function(){r.hide()});$("#exitTextEditing").click(function(){Modes.select.activate()})});return{name:"text",echoesToDisregard:{},minimumWidth:240,minimumHeight:function(){return 3*Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},
getSelectedRanges:function(){return _.map(boardContent.multiWordTexts,function(a){var d=a.doc.selectedRange();return{identity:a.identity,start:d.start,end:d.end,text:d.plainText()}})},getLinesets:function(){return _.map(boardContent.multiWordTexts,function(a){console.log("Textbox",a.identity,a.doc.width());a.doc.layout();return _.map(a.doc.frame.lines,function(a){return a.positionedWords.length})})},mapSelected:function(a){var d=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,
function(b){b.identity in d&&a(b)})},scaleEditor:w,scrollToCursor:function(a){var d=a.bounds,b=a.doc.selectedRange().start;a=a.doc.getCaretCoords(b);var b=Math.floor(a.t/a.h),c=Math.floor(scaleScreenToWorld(boardContext.height)/a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var b=Math.min(b,Math.max(0,c-2))*a.h,c=Math.max(d[2]-d[0],scaleWorldToScreen(10*a.h)),e=c/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(d[0],d[1]-b+a.t,c,e)}else d=Math.max(0,
Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(d[1]-viewboxY))/a.h)-4))*a.h,0!=d&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+d,viewboxWidth,viewboxHeight)},editorFor:function(h){var d=boardContent.multiWordTexts[h.identity];d||(d=boardContent.multiWordTexts[h.identity]=h);if(!d.doc){var c=h.author==UserSettings.getUsername();d.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",h.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],c?blit:b,h);if(c){var e=_.debounce(function(){Modes.text.scrollToCursor(d);
var a=boardContent.multiWordTexts[d.identity];a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);incorporateBoardBounds(d.bounds)},1E3);Progress.beforeLeavingSlide[h.identity]=function(){e.flush();delete Progress.beforeLeavingSlide[h.identity]};d.doc.contentChanged(e);d.doc.selectionChanged(function(b,h){if(0<d.doc.save().length){var c=b();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var e=[$("#blackText"),$("#redText"),$("#blueText"),
$("#yellowText")],g=function(a,d){var b=1==c[d];b&&(carota.runs.nextInsertFormatting[d]=b);a.toggleClass("active",b)},p=function(a,d,b){var h=_.isEqual(c[d],b);d in c&&h&&(carota.runs.nextInsertFormatting[d]=b);a.toggleClass("active",h)};g(k,"bold");g(l,"italic");g(a,"underline");p(e[0],"color",["#000000",255]);p(e[1],"color",["#ff0000",255]);p(e[2],"color",["#0000ff",255]);p(e[3],"color",["#ffff00",255]);h&&Modes.text.scrollToCursor(d)}})}}d.doc.position={x:h.x,y:h.y};d.doc.width(h.width);return d},
draw:function(a){a&&a.doc&&carota.editor.paint(board[0],a.doc,!0)},editorAt:function(a,d,b,c){var e=UserSettings.getUsername(),g=[c.x-10,c.y-10,c.x+10,c.y+10];a=_.values(boardContent.multiWordTexts).filter(function(a){return intersectRect(a.bounds,g)&&a.author==e});return 0<a.length?a[0]:!1},contextFor:function(a,d){var b={x:d.x-a.position.x,y:d.y-a.position.y};return{node:a.byCoordinate(b.x,b.y),relativePos:b}},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;e("#textTools",
"#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var a=0;registerPositionHandlers(board,function(a,b,c,h){if(a=Modes.text.editorAt(a,b,c,h).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,h).node)},function(a,b,c,h){(a=Modes.text.editorAt(a,b,c,h).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,h).node)},function(d,b,c,e){var g=Date.now(),p=Modes.text.editorAt(d,b,c,e);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=
a.doc.identity==p.identity;0==a.doc.documentRange().plainText().trim().length&&(delete boardContent.multiWordTexts[a.identity],blit())});Modes.select.clearSelection();p?(d=p.doc,e=Modes.text.contextFor(d,e),500>=g-a?d.dblclickHandler(e.node):d.mouseupHandler(e.node),a=g,e={multiWordTexts:{}},e.multiWordTexts[p.identity]=p,Modes.select.setSelection(e)):(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},d=v(e,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,
underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.size/scale()}]),g=d.doc,g.select(0,1),boardContent.multiWordTexts[d.identity]=d,e={multiWordTexts:{}},e.multiWordTexts[d.identity]=boardContent.multiWordTexts[d.identity],Modes.select.setSelection(e),p=d,e=g.byOrdinal(0),g.mousedownHandler(e),g.mouseupHandler(e));p.doc.invalidateBounds();p.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=
function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(p);Progress.call("onSelectionChanged",[Modes.select.selected])})},handleDrop:function(a,d,b){if(0<a.length){a=carota.html.parse(a,{});console.log("newRuns:",a);d=screenToWorld(d,b);Modes.text.activate();Date.now();Modes.select.clearSelection();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var c=v(d,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,
underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.size/scale()}]);d=c.doc;d.select(0,1);boardContent.multiWordTexts[c.identity]=c;b={multiWordTexts:{}};b.multiWordTexts[c.identity]=boardContent.multiWordTexts[c.identity];Modes.select.setSelection(b);editor=c;b=d.byOrdinal(0);d.mousedownHandler(b);d.mouseupHandler(b);editor.doc.invalidateBounds();editor.doc.isActive=!0;editor.doc.load(a);
Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(editor);a=boardContent.multiWordTexts[editor.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);Progress.call("onSelectionChanged",[Modes.select.selected])}},deactivate:function(){DeviceConfiguration.setKeyboard(!1);c();r.hide();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=
!1;0==a.doc.documentRange().plainText().trim().length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();blit()}}}(),video:function(){var b={},f=void 0,g=void 0,n=function(){f.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=g.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();g.unwrap()},k=function(a){if(void 0!=b&&void 0!=b.fileUpload&&void 0!=a){$("#videoWorking").show();$("#videoFileChoice").hide();var c=new FileReader;c.onload=function(c){var e=
$("<video/>"),g=e[0],f=c.target.result;g.addEventListener("loadeddata",function(c){c=g.videoHeight;b.width=g.videoWidth;b.height=c;b.video=e;b.videoSrc=f;a()},!1);e.append($("<source />",{src:f,type:"video/mp4"}));e.load()};c.readAsDataURL(b.fileUpload)}},l=function(){if("imageDefinition"==b.type){WorkQueue.pause();var a=Date.now(),c=sprintf("%s%s",UserSettings.getUsername(),a),e=Conversations.getCurrentSlideJid(),c=sprintf("/uploadDataUri?jid=%s&filename=%s",e.toString(),encodeURI(c));$.ajax({url:c,
type:"POST",success:function(c){var g=$(c).find("resourceUrl").text(),f={type:"video",author:UserSettings.getUsername(),timestamp:a,identity:g,slide:e.toString(),source:$(c).text(),bounds:[b.x,b.y,b.x+b.width,b.y+b.height],width:b.width,height:b.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:b.x,y:b.y,audiences:_.map(Conversations.getCurrentGroup(),"id").map(audienceToStanza)};registerTracker(g,function(){var a=Modes.select.handlesAtZoom(),b=f.x,c=f.y,e=Math.max(f.width,viewboxWidth),
h=Math.max(f.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,e+2*a,h+2*a);Modes.select.clearSelection();Modes.select.selected.videos[f.identity]=boardContent.videos[f.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(f);n();WorkQueue.gracefullyResume()},error:function(a){console.log(a);resetImageUpload();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:b.videoSrc,cache:!1,contentType:!1,processData:!1})}},a=!1;$(function(){a||(a=!0,f=$("#videoInsertOptions").css({position:"absolute",left:0,top:0}),$("#videoInsertOptionsClose").click(Modes.select.activate),g=$("#videoFileChoice").attr("accept","video/mp4"),g[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("video")&&(b.fileUpload=a);k(l)},!1),n())});Progress.beforeLeavingSlide.videos=function(){"videos"in boardContent&&
_.forEach(boardContent.videos,function(a){null!=a&&void 0!=a&&"destroy"in a&&a.destroy()})};return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.video;e("#insertTools","#videoMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$("#insertMode").addClass("activeTool").removeClass("inactiveTool");$(".active").removeClass("active");$("#videoMode").addClass("active");$(".insetColumn").hide();$("#videoTools").show();var a=screenToWorld(10,10);b={type:"imageDefinition",
screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");f.show()},deactivate:function(){n();c()}}}(),image:function(){var b={},f=void 0,g=void 0,n=function(){f.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=g.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();g.unwrap()},k=function(){var a=function(a,b,c,h){for(var d=b*c;d>a;)b*=.8,c*=.8,d=b*c;return{w:b,h:c,q:h}},b={"native":{resizeFunc:function(a,b){return{w:a,h:b,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(b,
c){return a(1*e,b,c,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(b,c){return a(3*e,b,c,.8)},selector:"#imageInsertHighDef"}},c=b.optimized,e=1048576,g=function(){_.forEach(b,function(a){var b=$(a.selector);c.selector==a.selector?b.addClass("activeBrush"):b.removeClass("activeBrush")})};$(function(){_.forEach(b,function(a){$(a.selector).on("click",function(){c=a;g()})});g()});return{reapplyVisualStyle:g,changeMode:function(a){a in b&&(c=b[a],g())},getResizeFunction:function(){return c.resizeFunc}}}(),
l=function(c,e){var g=void 0==e?b:e;if(void 0==g||void 0==g.fileUpload||void 0==c)console.log("returning because currentImage is empty",b);else{$("#imageWorking").show();$("#imageFileChoice").hide();var f=new FileReader;f.onload=function(b){var e=b.target.result;a(e,g,c,function(a){return e.length<a})};f.readAsDataURL(g.fileUpload)}},a=function(a,c,e,g){var f=void 0!=c?c:b,n=$("<canvas/>"),m=new Image;m.setAttribute("crossOrigin","Anonymous");m.onerror=function(a){errorAlert("Error dropping image",
"The source server you're dragging the image from does not allow dragging the image directly across into MeTL.  You may need to download the image first and then upload it.")};m.onload=function(b){var c=m.width,d=m.height,p=k.getResizeFunction()(c,d);b=p.w;var l=p.h,p=p.q;n.width=c;n.height=d;n.attr("width",c);n.attr("height",d);n.css({width:px(c),height:px(d)});var q=n[0].getContext("2d");q.rect(0,0,c,d);q.fillStyle="white";q.fill();q.drawImage(m,0,0,c,d);c=multiStageRescale(n[0],b,l);f.width=b;
f.height=l;f.resizedImage=c.toDataURL("image/jpeg",p);g(f.resizedImage.length)&&(f.resizedImage=a);e(f)};m.src=a},m=function(a){if("imageDefinition"==a.type){WorkQueue.pause();var b=Date.now(),c=sprintf("%s%s%s",UserSettings.getUsername(),b,_.uniqueId()),e=Conversations.getCurrentSlideJid(),c=sprintf("/uploadDataUri?jid=%s&filename=%s",e.toString(),encodeURI(c));$.ajax({url:c,type:"POST",success:function(c){var g=$(c).find("resourceUrl").text(),f={type:"image",author:UserSettings.getUsername(),timestamp:b,
tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+g+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:g,slide:e.toString(),source:$(c).text(),bounds:[a.x,a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,x:a.x,y:a.y,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),audiences:_.map(Conversations.getCurrentGroup(),"id").concat(ContentFilter.getAudiences()).map(audienceToStanza)};registerTracker(g,function(){var a=Modes.select.handlesAtZoom(),
b=f.x,c=f.y,e=Math.max(f.width,viewboxWidth),g=Math.max(f.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,e+2*a,g+2*a);Modes.select.clearSelection();Modes.select.selected.images[f.identity]=boardContent.images[f.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(f);n();WorkQueue.gracefullyResume()},error:function(a){console.log(a);n();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:a.resizedImage,cache:!1,contentType:!1,processData:!1})}},u=!1;$(function(){u||(u=!0,f=$("#imageInsertOptions").css({position:"absolute",left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),g=$("#imageFileChoice").attr("accept","image/*"),g[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("image")&&(b.fileUpload=a);l(m)},!1),n())});return{activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.image;e("#insertTools","#imageMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$("#insertMode").addClass("activeTool").removeClass("inactiveTool");$(".active").removeClass("active");$("#imageMode").addClass("active");$(".insetColumn").hide();$("#imageTools").show();var a=screenToWorld(10,10);b={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");k.reapplyVisualStyle();f.show()},handleDroppedSrc:function(b,c,e){var g=
screenToWorld(c,e);a(b,{type:"imageDefinition",screenX:c,screenY:e,x:g.x,y:g.y},m,function(a){return!1})},handleDrop:function(a,b,c){var e=0,g=[],f=function(a,f){if(null!=a&&"type"in a&&0==a.type.indexOf("image")&&!_.some(g,function(b){return b==a})){var h=screenToWorld(b,c+e),h={type:"imageDefinition",screenX:b,screenY:c+e,x:h.x,y:h.y};h.fileUpload=a;console.log("handlingDrop",a,f,h);g.push(a);l(m,h);e+=50}};_.forEach(a.files,function(a){f(a,"file")});_.forEach(a.items,function(a){a=a.getAsFile(0);
f(a,"item")})},deactivate:function(){n();c()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");Modes.currentMode.deactivate();e("#panTools","#panMode");Modes.currentMode=Modes.pan;var b,c;registerPositionHandlers(board,function(e,f,k){takeControlOfViewbox();b=e;c=f},function(e,f,k){Pan.translate(-1*(e-b),-1*(f-c));b=e;c=f},function(b,c,e){})},deactivate:function(){c();unregisterPositionHandlers(board)}},select:function(){var b=!1,f=function(){Modes.select.selected={images:{},text:{},inks:{},
multiWordTexts:{},videos:{}};Progress.call("onSelectionChanged",[Modes.select.selected])},g=_.debounce(function(){var a=!1;_.forEach("images texts inks highlighters multiWordTexts videos".split(" "),function(b){var c="highlighters"==b?"inks":b;if(Modes&&Modes.select&&Modes.select.selected&&c in Modes.select.selected){var e=Modes.select.selected[c];_.forEach(e,function(g){e&&b in boardContent&&g&&g.identity in boardContent[b]?e[g.identity]=boardContent[b][g.identity]:(a=!0,"inks"==c?"highlighters"==
b&&g.identity in e&&1==e[g.identity].isHighlighter?delete e[g.identity]:"inks"==b&&g.identity in e&&0==e[g.identity].isHighlighter&&delete e[g.identity]:delete e[g.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),n=function(){if(void 0!=Modes.select.selected&&b&&"Blacklist"in window){var a=Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),a.inks,a.texts,a.multiWordTexts,a.images,a.videos)}f()},
k=function(){(b=Conversations.shouldModifyConversation()?!b:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");f()},l=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),$("#ban").removeClass("disabledButton"),$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());
b?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=g;Progress.onViewboxChanged.ModesSelect=g;Progress.onSelectionChanged.ModesSelect=function(a){a&&(Modes.select.selected=a,"images"in a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||"multiWordTexts"in a&&0<_.size(a.multiWordTexts)||"videos"in a&&0<_.size(a.videos)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),
b?($("#ban").removeClass("disabledButton"),$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=f;Progress.conversationDetailsReceived.ModesSelect=
function(a){b&&!Conversations.shouldModifyConversation(a)&&(b=!1);Conversations.shouldModifyConversation(a)?($("#administerContent").unbind("click").bind("click",k),$("#ban").unbind("click").bind("click",n)):($("#administerContent").unbind("click"),$("#ban").unbind("click"));l(a)};return{name:"select",selected:{images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=
scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,b);_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,b);_.forEach(Modes.select.selected.videos,
b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:f,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;e("#selectTools","#selectMode");var a={x:0,y:0},c=$("<div/>",{id:"selectMarquee"}),g=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&!b){var a=batchTransform();a.isDeleted=
!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&(a.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));"videos"in Modes.select.selected&&(a.videoIds=_.keys(Modes.select.selected.videos));sendStanza(a);f()}});var n=function(a){a("images");a("texts");a("multiWordTexts");
a("inks");a("videos")};Modes.select.dragging=!1;l();Modes.select.resizing=!1;registerPositionHandlers(board,function(b,e,f,n,l){console.log("DOWN",n);Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:b,y:e};Modes.select.marqueeWorldOrigin=n;if(!l.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){f=3/scale();var k=[n.x-f,n.y-f,n.x+f,n.y+f];Modes.select.dragging=_.some(["images","texts","inks","multiWordTexts","videos"],function(a){return _.some(Modes.select.selected[a],function(a){return a?
intersectRect(a.bounds,k):!1})})}console.log("SELECT DOWN",b,e,n,Modes.select.dragging);Modes.select.dragging?(Modes.select.offset=n,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(g.empty(),g.append(c),c.show(),updateMarquee(c,a,a))},function(b,e,g,f,n){b={x:b,y:e};Modes.select.offset=f;Modes.select.dragging?blit():Modes.select.resizing?blit():updateMarquee(c,a,b)},function(a,e,g,f,l){WorkQueue.gracefullyResume();try{var k=f.x-Modes.select.marqueeWorldOrigin.x,
q=f.y-Modes.select.marqueeWorldOrigin.y;15>Math.abs(k)+Math.abs(q)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=k;a.doc.position.y+=q;a.doc.invalidateBounds()});var h=batchTransform();h.xTranslate=k;h.yTranslate=q;h.inkIds=_.keys(Modes.select.selected.inks);h.textIds=_.keys(Modes.select.selected.texts);h.imageIds=
_.keys(Modes.select.selected.images);h.videoIds=_.keys(Modes.select.selected.videos);h.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(h.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(h)}else{var d=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,f,2),x=[d.left,d.top,d.right,d.bottom],B={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},y={},D={};n(function(a){$.each(boardContent[a],function(c,d){if(!("bounds"in
d)&&"type"in d)switch(d.type){case "text":prerenderText(d);break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;case "video":prerenderVideo(d);break;default:d.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(x,d.bounds)&&(incrementKey(y,d.author),incrementKey(D,"any"),b?d.author!=UserSettings.getUsername()&&(B[a][d.identity]=d):d.author==UserSettings.getUsername()&&(B[a][d.identity]=d))})});$.each(boardContent.highlighters,function(a,c){intersectRect(c.bounds,x)&&(incrementKey(y,c.author),
b?c.author!=UserSettings.getUsername()&&(B.inks[c.identity]=c):c.author==UserSettings.getUsername()&&(B.inks[c.identity]=c))});n(function(a){$.each(B[a],function(b,c){a in Modes.select.selected||(Modes.select.selected[a]=[]);a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=c})});D.any||Modes.select.clearSelection();var E=sprintf("Selected %s images, %s texts, %s inks, %s rich texts, %s videos ",_.keys(Modes.select.selected.images).length,
_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,_.keys(Modes.select.selected.inks).length,_.keys(Modes.select.selected.videos).length);$.each(y,function(a,b){E+=sprintf("%s:%s ",a,b)});Progress.call("onSelectionChanged",[Modes.select.selected])}c.css({width:0,height:0}).hide();blit()}catch(F){console.log("Selection up",F)}})},deactivate:function(){unregisterPositionHandlers(board);c();f();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();
$("#selectMarquee").hide();l();blit();blit()}}}(),zoom:{name:"zoom",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;e("#zoomTools","#zoomMode");var b=$("<div />",{id:"zoomMarquee"}),c,g={x:0,y:0};registerPositionHandlers(board,function(e,f,k,a){takeControlOfViewbox();c=a;b.show();b.appendTo($("#selectionAdorner"));g={x:e,y:f};updateMarquee(b,g,g)},function(c,e,f,a){c={x:c,y:e};e=rectFromTwoPoints(c,g);f="left";a="top";c.x==e.left&&(f="right");c.y==e.top&&(a="bottom");
c=aspectConstrainedRect(e,f,a);updateMarquee(b,{x:c.right,y:c.bottom},{x:c.left,y:c.top})},function(e,g,f,a){WorkQueue.gracefullyResume();b.hide();e={x:contentOffsetX+a.x,y:contentOffsetY+a.y};g=rectFromTwoPoints(e,{x:contentOffsetX+c.x,y:contentOffsetY+c.y});2500>scale()*g.width*g.height||(f="left",a="top",e.x==g.left&&(f="right"),e.y==g.top&&(a="bottom"),e=aspectConstrainedRect(g,f,a),IncludeView.specific(e.left,e.top,e.width,e.height))})},deactivate:function(){c();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},
feedback:function(){var b=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){b()};Progress.conversationDetailsReceived.respectNewPermissions=b;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;b();e("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(b,c,e,f){},
function(b,c,e,f){},function(b,c,e,f){});b()},deactivate:function(){c();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),draw:function(){var b=Brushes.getDefaultBrushes(),f=_.map(b,function(a){return _.clone(a)}),g,k=!1,x=void 0,l=void 0,a=function(a){f[a.index]=a},m=function(){},u=function(){},r=function(){};$(function(){var c,e;$(".activeBrush").removeClass("activeBrush");var v=function(){var b=$("#drawTools");_.each(b.find(".modeSpecificTool.pen"),function(b,c){var e=f[c],
h=$(b).css({color:e.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");g=e;a(e);Modes.draw.drawingAttributes=g;k=!1;t(e)}).removeClass("fa-tint").removeClass("fa-circle").addClass(e.isHighlighter?"fa-circle":"fa-tint");h.find(".widthIndicator").text(e.width);e==g&&h.addClass("activeBrush")})},t=function(b){var c=$("#colors .dots"),e=$("#sizes .dots"),f=Colors.getAllNamedColors(),k=Brushes.getAllBrushSizes();e.empty();k.map(function(c){var d=x.clone();
e.append(d);d.click(function(){b.width=c;a(b);g=b;v();t(b)});var f=Canvas.circle(b.color,c,50);c==b.width&&d.addClass("activeTool");d.prepend(f);f=c.toString()+"px";d.find(".sizeDotName").append(f)});c.empty();f.map(function(e){var f=l.clone();c.append(f);f.on("click",function(){b.color=e.rgb;g=b;a(b);v();t(b)});f.css("color",e.rgb);"rgb"in e&&e.rgb==b.color&&f.addClass("activeTool");var k=e.name;f.find(".colorDotName").append(k)});f=$("#setPenToHighlighter").unbind("click").on("click",function(){b.isHighlighter=
!0;g=b;a(b);v();t(b)});k=$("#setPenToPen").unbind("click").on("click",function(){b.isHighlighter=!1;g=b;a(b);v();t(b)});"isHighlighter"in g&&g.isHighlighter?(f.addClass("activeTool").addClass("active"),k.removeClass("activeTool").removeClass("active")):(k.addClass("activeTool").addClass("active"),f.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var a=_.find(b,function(a){return a.id==g.id});void 0!=a&&(g.width=a.width,g.color=
a.color,g.isHighlighter=a.isHighlighter,v(),t(g))});x=$("#penSize .sizeDot").clone();l=$("#penColor .colorDot").clone();g=f[0];v();t(g);var z=$("#drawTools");z.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");k=!0;$("#drawDropdowns").hide()});z.find(".advancedTools").unbind("click").on("click",function(){k||(t(g),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});
var w=[];u=function(a,b,f,g,l){A=[];k||l.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,boardContext.fillStyle=Modes.draw.drawingAttributes.color,boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,w=[g.x,g.y,256*f],c=a,e=b,boardContext.beginPath(),boardContext.arc(a,b,Modes.draw.drawingAttributes.width*f/2,0,2*Math.PI),boardContext.fill())};var A=[];e=c=void 0;r=function(a,b,f,g,l){a=Math.round(a);b=Math.round(b);if(k||l.eraser){var m=[g.x-10,g.y-10,g.x+
10,g.y+10];f=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,m)){delete a[c.identity];A.push(c.identity);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";f(boardContent.inks);f(boardContent.highlighters);boardContext.globalAlpha=1}else l=Modes.draw.drawingAttributes.width*f,boardContext.beginPath(),boardContext.lineCap="round",
boardContext.lineWidth=l,_.takeRight(w,3),boardContext.moveTo(c,e),boardContext.lineTo(a,b),boardContext.stroke(),w=w.concat([g.x,g.y,256*f]);c=a;e=b};m=function(a,b,f,g,l){k||l.eraser?(a=batchTransform(),a.isDeleted=!0,a.inkIds=A,sendStanza(a)):(l=Modes.draw.drawingAttributes.width*f,boardContext.lineWidth=l,boardContext.beginPath(),boardContext.lineWidth=l,boardContext.lineCap="round",boardContext.moveTo(c,e),boardContext.lineTo(a,b),boardContext.stroke(),w=w.concat([g.x,g.y,256*f]),strokeCollected(w));
boardContext.globalAlpha=1}});return{name:"draw",brushes:f,mousePressure:256,activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,Modes.draw.drawingAttributes=g,e("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),k?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==g.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,
u,r,m))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();c();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,function(b,c,e,f){},function(b,c,e,f){},function(b,c,e,f){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
