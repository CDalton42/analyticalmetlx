function devLogAdd(b){$("#devLog").append($("<div />",{text:b}))}function devLogSet(b){$("#devLog").html($("<div />",{text:b}))}var incrementKey=function(b,e){e in b?b[e]++:b[e]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(b){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(e,m){b.unbind(m)});WorkQueue.gracefullyResume()}
function progress(){var b=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),e=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(b),m=$("<progress />");m.append(b);var n=1,f=0,k=function(){e.css("width",sprintf("%s%%",Math.floor(f/n*100)));m.attr({value:f,max:n})},g={element:m,value:function(b){f=b;k();return g},max:function(f){n=f;k();return g}};return g}
function proportion(b,e){return b/e/(boardWidth/boardHeight)}function scaleScreenToWorld(b){var e;e=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b*e}function scaleWorldToScreen(b){var e;e=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b/e}function screenToWorld(b,e){var m=scaleScreenToWorld(b)+viewboxX,n=scaleScreenToWorld(e)+viewboxY;return{x:m,y:n}}
function worldToScreen(b,e){var m=scaleWorldToScreen(b-viewboxX),n=scaleWorldToScreen(e-viewboxY);return{x:m,y:n}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(b){return!1}}
function registerPositionHandlers(b,e,m,n){var f=!1,k=function(f,b){var c=[f.x-10,f.y-10,f.x+10,f.y+10],a=!0;_.each(Modes.canvasInteractables,function(q,e){_.each(q,function(q){b in q&&(q.activated||intersectRect(c,q.bounds))&&(a=a&&q[b](f))})});return a},g=function(f,b){return{shift:f.shiftKey,ctrl:f.ctrlKey,alt:f.altKey,eraser:b}};$.each(b,function(b,p){var c=$(p);c.css({"touch-action":"none"});var a=!1,q={},z=function(d){var A=d.originalEvent.pointerId,f="pen"==d.originalEvent.pointerType&&5==
d.originalEvent.button,b=c.offset(),l=d.pageX-b.left,b=d.pageY-b.top,x=d.originalEvent.pressure||.5,e=screenToWorld(l,b),g=q[A]||{pointerId:A,pointerType:d.originalEvent.pointerType,eraser:f,points:[]};g.points.push({x:e.x,y:e.y,screenX:l,screenY:b,z:x});g.eraser=g.eraser||f;q[A]=g;1<_.size(q)&&(0==a&&_.each(q,function(d){d.points=[_.last(d.points)]}),a=!0);return{pointerType:d.pointerType,eraser:g.eraser,x:l,y:b,z:x,worldPos:e}},v=function(d){var A=d.originalEvent.pointerId,b="pen"==d.originalEvent.pointerType&&
5==d.originalEvent.button,l=c.offset(),x=d.pageX-l.left,l=d.pageY-l.top,e=d.originalEvent.pressure||.5,g=screenToWorld(x,l);delete q[A];a&&0==_.size(q)&&(f=a=!1);return{pointerType:d.pointerType,eraser:b,x:x,y:l,z:e,worldPos:g}};if(detectPointerEvents()){var u=_.throttle(function(){if(1<_.size(q)){takeControlOfViewbox();var d=_.map(_.filter(q,function(d){return 0<_.size(d.points)}),function(d){var a=_.first(d.points);d=_.last(d.points);return[a,d]});q={};var a=_.meanBy(d,function(d){return d[0].x-
d[1].x}),c=_.meanBy(d,function(d){return d[0].y-d[1].y});Pan.translate(scaleWorldToScreen(a),scaleWorldToScreen(c));var a=_.min(_.map(d,function(d){return d[0].y})),f=_.max(_.map(d,function(d){return d[0].y})),c=_.min(_.map(d,function(d){return d[0].x})),l=_.max(_.map(d,function(d){return d[0].x})),a=f-a,c=l-c,l=_.min(_.map(d,function(d){return d[1].y})),f=_.max(_.map(d,function(d){return d[1].y})),b=_.min(_.map(d,function(d){return d[1].x})),d=(_.max(_.map(d,function(d){return d[1].x}))-b+(f-l))/
2;Zoom.scale((c+a)/2/d)}},25);c.bind("pointerdown",function(d){var c=z(d);d.preventDefault();WorkQueue.pause();1!=_.size(q)||a||(f=!0,k(c.worldPos,"down")&&e(c.x,c.y,c.z,c.worldPos,g(d,c.eraser)))});c.bind("pointermove",function(d){var c=z(d);d.preventDefault();(d.originalEvent.pointerType==d.POINTER_TYPE_TOUCH||"touch"==d.originalEvent.pointerType&&1<_.size(q))&&u();1!=_.size(q)||a||k(c.worldPos,"move")&&f&&m(c.x,c.y,c.z,c.worldPos,g(d,c.eraser))});c.bind("pointerup",function(d){var c=v(d);WorkQueue.gracefullyResume();
d.preventDefault();k(c.worldPos,"up")&&f&&!a&&n(c.x,c.y,c.z,c.worldPos,g(d,c.eraser));f=!1});var B=function(d,c){q={};WorkQueue.gracefullyResume();var a=screenToWorld(d,c),l=a.x,a=a.y;l<viewboxX?(takeControlOfViewbox(),Extend.left()):l>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):a<viewboxY?(takeControlOfViewbox(),Extend.up()):a>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),Extend.down());f=!1},y=function(d){v(d);WorkQueue.gracefullyResume();d.preventDefault();f&&B(d.offsetX,
d.offsetY);f=!1;_.each(Modes.canvasInteractables,function(d){d.deactivate&&d.deactivate()})};c.bind("pointerout",y);c.bind("pointerleave",y);c.bind("pointercancel",y)}else{c.bind("mousedown",function(d){WorkQueue.pause();var a=c.offset();f=!0;var l=d.pageX-a.left,a=d.pageY-a.top,b=screenToWorld(l,a);k(b,"down")&&e(l,a,.5,b,g(d));d.preventDefault()});c.bind("mousemove",function(d){var a=c.offset();d.preventDefault();var l=d.pageX-a.left,a=d.pageY-a.top,b=screenToWorld(l,a);k(b,"move")&&f&&m(l,a,.5,
b,g(d))});c.bind("mouseup",function(d){WorkQueue.gracefullyResume();d.preventDefault();var a=c.offset(),l=d.pageX-a.left,a=d.pageY-a.top,b=screenToWorld(l,a);k(b,"up")&&f&&n(l,a,.5,b,g(d));f=!1});var r=function(d,a){WorkQueue.gracefullyResume();var c=screenToWorld(d,a),l=c.x,c=c.y;l<viewboxX?(takeControlOfViewbox(),Extend.left()):l>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):c<viewboxY?(takeControlOfViewbox(),Extend.up()):c>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),Extend.down());
f=!1};c.bind("mouseout",function(d){WorkQueue.gracefullyResume();d.preventDefault();f&&r(d.offsetX,d.offsetY);f=!1});var w,t=function(d){return{x:average(_.map(d,"x")),y:average(_.map(d,"y"))}},x=function(d){var a=[],f=c.offset();$.each(d,function(d,c){a.push({x:c.pageX-f.left,y:c.pageY-f.top,identifier:c.identifier})});return a};c.bind("touchstart",function(d){WorkQueue.pause();d.preventDefault();var a=x(d.originalEvent.touches);if(1==a.length){var a=a[0],c=screenToWorld(a.x,a.y);f=!0;k(c,"down")&&
e(a.x,a.y,.5,c,g(d))}else w=t(a)});c.bind("touchmove",function(d){d.preventDefault();var a=x(d.originalEvent.touches);switch(a.length){case 0:break;case 1:var a=a[0],c=screenToWorld(a.x,a.y);k(c,"move")&&f&&m(a.x,a.y,.5,c,g(d));break;default:d=t(a),a=d.x-w.x,c=d.y-w.y,w=d,takeControlOfViewbox(),Pan.translate(-1*a,-1*c)}});c.bind("touchend",function(d){WorkQueue.gracefullyResume();d.preventDefault();var a=c.offset(),l=d.originalEvent.changedTouches[0],b=l.pageX-a.left,a=l.pageY-a.top,l=screenToWorld(b,
a);k(l,"up")&&f&&(0>b||0>a||b>boardWidth||a>boardHeight?r(b,a):n(b,a,.5,l,g(d)));f=!1});var l=1;c.bind("gesturechange",function(a){WorkQueue.pause();a.preventDefault();f=!1;a=a.originalEvent.scale;takeControlOfViewbox();Zoom.scale(l/a);l=a});c.bind("gestureend",function(){WorkQueue.gracefullyResume();l=1})}});return function(b){f=b}}function aspectConstrainedDimensions(b,e){var m=boardHeight/boardWidth,n={height:e,width:b};e/b>m?n.height=b*m:n.width=e/m;return n}
function aspectConstrainedRect(b,e,m){var n=boardHeight/boardWidth,f={left:b.left,top:b.top,right:b.right,bottom:b.bottom,width:b.width,height:b.height};b.height/b.width>n?(f.height=b.width*n,m&&(e=b.height-f.height,"center"==m?f.top+=e/2:"bottom"==m&&(f.top+=e))):(f.width=b.height/n,e&&(m=b.width-f.width,"center"==e?f.left+=m/2:"right"==e&&(f.left+=m)));f.right=f.left+f.width;f.bottom=f.top+f.height;return f}
function copyBuffer(b){var e=document.createElement("canvas");e.width=b.width;e.height=b.height;e.getContext("2d").drawImage(b,0,0,b.width,b.height,0,0,b.width,b.height);return e}function intersectRect(b,e){return"undefined"!=typeof b&&"undefined"!=typeof e?!(e[0]>b[2]||e[2]<b[0]||e[1]>b[3]||e[3]<b[1]):!1}function overlapRect(b,e){return intersectRect(b,e)?(Math.max(b[0],e[0])-Math.min(b[2],e[2]))*(Math.max(b[1],e[1])-Math.min(b[3],e[3])):0}
function rectFromTwoPoints(b,e,m){m=m||0;var n,f,k;b.x<e.x?(n=b.x,k=e.x):(n=e.x,k=b.x);b.y<e.y?(f=b.y,b=e.y):(f=e.y,b=b.y);e=k-n;var g=b-f;e<m&&(k+=m-e,e=k-n);g<m&&(b+=m-g,g=b-f);return{left:n,top:f,right:k,bottom:b,width:e,height:g}}function updateMarquee(b,e,m){e=rectFromTwoPoints(e,m);m=$("#selectionAdorner");jQuery.contains(m,b)||m.append(b);b.is(":visible")||b.show();b.css({left:px(e.left),top:px(e.top),width:px(e.width),height:px(e.height)})}
function clampToView(b){var e=b.x,m=b.y;0>b.x&&(e=0);b.x>boardWidth&&(e=boardWidth);0>b.y&&(m=0);b.y>boardHeight&&(m=boardHeight);return{x:e,y:m}}
var bounceButton=function(b){var e=$(b);e.addClass("activeBrush");setTimeout(function(){e.removeClass("activeBrush")},200)},Modes=function(){var b=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},e=function(f,e){b();$(f).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$(e).addClass("activeTool").removeClass("inactiveTool")},m={name:"none",activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.none;b()},deactivate:function(){b();unregisterPositionHandlers(board)}},n=function(f,b){f in Modes.canvasInteractables||(Modes.canvasInteractables[f]=[]);Modes.canvasInteractables[f].push(b)};$(function(){var f={opacity:1};(new TWEEN.Tween(f)).delay(1E3).to({opacity:.3},1E3);var b=Modes.select.handlesAtZoom(),e=function(){return{activated:!1,originalHeight:1,originalWidth:1,rehome:function(c){if(!e.activated){var a=Modes.select.handlesAtZoom(),b=c.x+a/2;e.bounds=[b-a/2,c.y-
a,b+a/2,c.y]}},down:function(c){e.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=c;Modes.select.marqueeWorldOrigin=c;blit()},move:function(c){e.activated&&(e.bounds=[c.x-b,c.y,c.x+b,c.y],Modes.select.offset=c,blit());return!1},deactivate:function(){e.activated=!1;Modes.select.dragging=!1},up:function(c){e.deactivate();var a=batchTransform(),b=c.x-Modes.select.marqueeWorldOrigin.x,f=c.y-Modes.select.marqueeWorldOrigin.y;a.xTranslate=b;a.yTranslate=f;a.inkIds=_.keys(Modes.select.selected.inks);
a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(a.multiWordTextIds,function(a){Modes.text.echoesToDisregard[a]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(a){a.doc.position.x+=b;a.doc.position.y+=f;a.doc.invalidateBounds()});sendStanza(a);registerTracker(a.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(c){if(e.bounds){var a=
worldToScreen(e.bounds[0],e.bounds[1]),b=worldToScreen(e.bounds[2],e.bounds[3]).x-a.x,h=a.x,a=a.y;c.globalAlpha=f.opacity;c.setLineDash([]);c.strokeStyle="black";c.fillStyle="white";c.strokeWidth=2;c.fillRect(h,a,b,b);c.strokeRect(h,a,b,b);c.font=sprintf("%spx FontAwesome",b);c.fillStyle="black";c.fillText("\uf047",h,a+b-4)}}}}(),h=function(){return{activated:!1,originalHeight:1,originalWidth:1,rehome:function(c){if(!h.activated){var a=Modes.select.handlesAtZoom(),b=c.x2;c=c.y;h.bounds=[b,c,b+a,c+
a]}},down:function(c){Modes.select.aspectLocked=!0;h.activated=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;c=Modes.select.totalSelectedBounds();Modes.select.offset={x:c.x2,y:c.y2};blit();return!1},move:function(c){if(h.activated){h.bounds=[c.x-b,h.bounds[1],c.x+b,h.bounds[3]];var a=Modes.select.totalSelectedBounds();Modes.select.offset={x:c.x,y:a.y+(c.x-a.x)/(a.x2-a.x)*a.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;h.activated=!1;Modes.select.resizing=!1},up:function(c){h.deactivate();
var a=batchTransform(),b=Modes.select.totalSelectedBounds();a.xScale=(c.x-b.x)/(b.x2-b.x);a.yScale=a.xScale;a.xOrigin=b.x;a.yOrigin=b.y;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(c,b){Modes.text.echoesToDisregard[b]=!0;var f=c.doc.save();_.each(f,function(c){c.size*=a.xScale});c.doc.width(c.doc.width()*
a.xScale);c.doc.load(f)});registerTracker(a.identity,function(){Progress.call("onSelectionChanged")});sendStanza(a);return!1},render:function(c){if(h.bounds){var a=worldToScreen(h.bounds[0],h.bounds[1]),b=worldToScreen(h.bounds[2],h.bounds[3]).x-a.x,e=b/10,g=-1*b;c.globalAlpha=f.opacity;c.setLineDash([]);c.strokeStyle="black";c.fillStyle="white";c.strokeWidth=2;c.translate(a.x,a.y);c.rotate(90*Math.PI/180);c.fillRect(0,g,b,b);c.strokeRect(0,g,b,b);c.font=sprintf("%spx FontAwesome",b);c.fillStyle=
"black";c.fillText("\uf0b2",e,-1*e)}}}}(),p=function(){return{activated:!1,rehome:function(c){if(!p.activated){var a=Modes.select.handlesAtZoom(),b=c.x2;c=c.y2;p.bounds=[b,c-a,b+a,c]}},down:function(c){p.activated=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;c=Modes.select.totalSelectedBounds();Modes.select.offset={x:c.x2,y:c.y2};blit();return!1},move:function(c){p.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),p.bounds=[c.x-b,c.y-b,c.x+b,c.y+b],Modes.select.offset=
{x:c.x,y:c.y},blit());return!1},deactivate:function(){p.activated=!1;Modes.select.resizing=!1},up:function(c){p.deactivate();var a=batchTransform(),b=Modes.select.totalSelectedBounds(),f=b.y2-b.y,e=c.y-b.y;a.xScale=(c.x-b.x)/(b.x2-b.x);a.yScale=e/f;a.xOrigin=b.x;a.yOrigin=b.y;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);_.each(Modes.select.selected.multiWordTexts,function(c){c.doc.width(Math.max(c.doc.width()*
a.xScale,Modes.text.minimumWidth/scale()));sendRichText(c)});Modes.text.invalidateSelectedBoxes();registerTracker(a.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(a);blit();return!1},render:function(c){if(p.bounds){var a=worldToScreen(p.bounds[0],p.bounds[1]),b=worldToScreen(p.bounds[2],p.bounds[3]).x-a.x,e=b/10,g=-1*b;c.globalAlpha=f.opacity;c.setLineDash([]);c.strokeStyle="black";c.fillStyle="white";c.strokeWidth=2;c.translate(a.x,a.y);c.rotate(90*Math.PI/180);c.fillRect(0,
g,b,b);c.strokeRect(0,g,b,b);c.font=sprintf("%spx FontAwesome",b);c.fillStyle="black";c.fillText("\uf065",e,-1*e)}}}}();n("manualMove",e);n("resizeFree",p);n("resizeAspectLocked",h);Progress.textBoundsChanged.selectionHandles=function(c,a){if(c in Modes.select.selected.multiWordTexts){var b=Modes.select.totalSelectedBounds();e.rehome(b);p.rehome(b);h.rehome(b)}};Progress.onSelectionChanged.selectionHandles=function(){var b=Modes.select.totalSelectedBounds();Infinity==b.x?f.opacity=0:(f.opacity=1,
e.rehome(b),p.rehome(b),h.rehome(b))}});return{currentMode:m,none:m,canvasInteractables:{},text:function(){var f=function(){},k,g,h,p,c,a,q,m,v,u,B,n=function(a,b){var d=Modes.text.minimumWidth/scale(),d=Modes.text.editorFor({bounds:[a.x,a.y,a.x,a.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),requestedWidth:d,width:d,height:0,x:a.x,y:a.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});d.doc.load(b);return d},
r=function(a){return function(){var b=!1;_.each(boardContent.multiWordTexts,function(d){if(d.doc.isActive){b=!0;var c=d.doc.selectedRange();carota.runs.nextInsertFormatting={};c.setFormatting(a,!0!==c.getFormatting()[a]);0<d.doc.save().length&&sendRichText(d)}});if(!b){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var d=carota.runs.nextInsertFormatting[a]=!carota.runs.nextInsertFormatting[a];$(sprintf(".font%sSelector",_.capitalize(a))).toggleClass("active",d)}}},w=function(a,
b){return function(){var d=!1;b=b||$(this).val();_.each(boardContent.multiWordTexts,function(c){c.doc.isActive&&(d=!0,carota.runs.nextInsertFormatting={},c.doc.selectedRange().setFormatting(a,b),0<c.doc.save().length&&sendRichText(c))});d||(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[a]=b)}},t=function(a){return function(){_.each(boardContent.multiWordTexts,function(b){var d=b.doc;if(d.isActive){var c=d.save();_.each(c,function(b){b.size*=
a});d.load(c);0<d.save().length&&sendRichText(b)}})}};$(function(){p=$(".fontBoldSelector");c=$(".fontItalicSelector");a=$(".fontUnderlineSelector");v=$("#textDropdowns");m=$("#fontOptions");k=$("#fontFamilySelector");g=$("#fontSizeSelector");h=$("#fontColorSelector");u=$("#fontLarger");B=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");q=$("#presetFullscreen");$("#presetCenterOnScreen");var b=k.find(".fontFamilyOption").clone(),
f=g.find(".fontSizeOption").clone(),d=h.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(a){k.append(b.clone().attr("value",a).text(a))});Fonts.getAllSizes().map(function(a){g.append(f.clone().attr("value",a).text(a))});Colors.getAllNamedColors().map(function(a){h.append(d.clone().attr("value",a.rgb).text(a.name))});u.click(t(1.2));B.click(t(.8));p.click(r("bold"));c.click(r("italic"));a.click(r("underline"));var e={red:"#ff0000",blue:"#0000ff",black:"#000000"};_.each(["red","blue",
"black"],function(a){$(sprintf("#%sText",a)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");w("color",[e[a],255])()})});q.click(function(a){return function(){_.each(boardContent.multiWordTexts,function(b){if(b.doc.isActive){switch(a){case "runToEdge":var d=screenToWorld(boardWidth,0);b.doc.width(d.x+viewboxX-b.x);break;case "fitToText":b.doc.width(b.doc.frame.actualWidth());break;case "widen":b.doc.width(1.6*b.doc.frame.actualWidth());break;case "narrow":b.doc.width(.6*
b.doc.frame.actualWidth());break;case "centerOnScreen":b.doc.width(screenToWorld(boardWidth,0).x);b.doc.selectedRange().setFormatting("align","center");b.doc.position.x=viewboxX;break;case "fullscreen":b.doc.position.x=viewboxX,b.doc.position.y=viewboxY,b.doc.width(screenToWorld(boardWidth,0).x)}b.doc.contentChanged.fire()}})}}("fullscreen"));m.click(function(){v.toggle()});$("#closeTextDialog").click(function(){v.hide()});$("#exitTextEditing").click(function(){Modes.select.activate()})});return{echoesToDisregard:{},
minimumWidth:240,minimumHeight:function(){return 3*Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},mapSelected:function(a){var b=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,function(d){d.identity in b&&a(d)})},scrollToCursor:function(a){var b=a.bounds,d=a.doc.selectedRange().start;a=a.doc.getCaretCoords(d);var d=Math.floor(a.t/
a.h),c=Math.floor(scaleScreenToWorld(boardContext.height)/a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var d=Math.min(d,Math.max(0,c-2))*a.h,c=Math.max(b[2]-b[0],scaleWorldToScreen(10*a.h)),f=c/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(b[0],b[1]-d+a.t,c,f)}else b=Math.max(0,Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(b[1]-viewboxY))/a.h)-4))*a.h,0!=b&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+b,viewboxWidth,viewboxHeight)},editorFor:function(b){var e=
boardContent.multiWordTexts[b.identity];e||(e=boardContent.multiWordTexts[b.identity]=b);if(!e.doc){var d=b.author==UserSettings.getUsername();e.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",b.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],d?blit:f,b);d&&(e.doc.contentChanged(function(){Modes.text.scrollToCursor(e);var a=boardContent.multiWordTexts[e.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);
incorporateBoardBounds(e.bounds)}),e.doc.selectionChanged(function(b,d){if(0<e.doc.save().length){var f=b();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var g=[$("#blackText"),$("#redText"),$("#blueText")],h=function(a,b){var d=1==f[b];d&&(carota.runs.nextInsertFormatting[b]=d);a.toggleClass("active",d)},t=function(a,b,d){var c=_.isEqual(f[b],d);b in f&&c&&(carota.runs.nextInsertFormatting[b]=d);a.toggleClass("active",c)};h(p,"bold");h(c,"italic");h(a,"underline");t(g[0],
"color",["#000000",255]);t(g[1],"color",["#ff0000",255]);t(g[2],"color",["#0000ff",255]);d&&Modes.text.scrollToCursor(e)}}))}e.doc.position={x:b.x,y:b.y};e.doc.width(b.width);return e},draw:function(a){a&&a.doc&&carota.editor.paint(board[0],a.doc,!0)},editorAt:function(a,b,d,c){var f=UserSettings.getUsername(),e=[c.x-10,c.y-10,c.x+10,c.y+10];a=_.values(boardContent.multiWordTexts).filter(function(a){var b=intersectRect(a.bounds,e);b&&(console.log("intersects",a.bounds,e),console.log(sprintf("%s clicked box by %s",
Participants.code(f),Participants.code(a.author))));return b&&a.author==f});return 0<a.length?a[0]:!1},contextFor:function(a,b){var d={x:b.x-a.position.x,y:b.y-a.position.y};return{node:a.byCoordinate(d.x,d.y),relativePos:d}},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;e("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var a=Date.now();registerPositionHandlers(board,function(a,b,c,f){if(a=Modes.text.editorAt(a,
b,c,f).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,f).node)},function(a,b,c,f){(a=Modes.text.editorAt(a,b,c,f).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,f).node)},function(b,c,f,e){var g=Date.now(),h=Modes.text.editorAt(b,c,f,e);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=a.doc.identity==h.identity;0==a.doc.save().length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();h?(b=h.doc,e=Modes.text.contextFor(b,e),
500>=g-a&&b.dblclickHandler(e.node),a=g,g={multiWordTexts:{}},g.multiWordTexts[h.identity]=h,Modes.select.setSelection(g),b.mouseupHandler(e.node)):(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},b=n(e,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.size/
scale()}]),e=b.doc,e.select(0,1),boardContent.multiWordTexts[b.identity]=b,g={multiWordTexts:{}},g.multiWordTexts[b.identity]=boardContent.multiWordTexts[b.identity],Modes.select.setSelection(g),h=b,g=e.byOrdinal(0),e.mousedownHandler(g),e.mouseupHandler(g));h.doc.invalidateBounds();h.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(h);Progress.call("onSelectionChanged",[Modes.select.selected])})},deactivate:function(){DeviceConfiguration.setKeyboard(!1);
b();v.hide();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=!1;0==_.trim(a.doc.save()).length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();blit()}}}(),image:function(){var f={},k=void 0,g=void 0,h=function(){k.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=g.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();g.unwrap()},p=function(){var a=function(a,b,c,f){for(var e=b*c;e>a;)b*=.8,c*=.8,
e=b*c;return{w:b,h:c,q:f}},b={"native":{resizeFunc:function(a,b){return{w:a,h:b,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(b,c){return a(1*f,b,c,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(b,c){return a(3*f,b,c,.8)},selector:"#imageInsertHighDef"}},c=b.optimized,f=1048576,e=function(){_.forEach(b,function(a){var b=$(a.selector);c.selector==a.selector?b.addClass("activeBrush"):b.removeClass("activeBrush")})};$(function(){_.forEach(b,function(a){$(a.selector).on("click",
function(){c=a;e()})});e()});return{reapplyVisualStyle:e,changeMode:function(a){a in b&&(c=b[a],e())},getResizeFunction:function(){return c.resizeFunc}}}(),c=function(a){if(void 0!=f&&void 0!=f.fileUpload&&void 0!=a){$("#imageWorking").show();$("#imageFileChoice").hide();var b=new FileReader;b.onload=function(b){var c=$("<canvas/>"),e=new Image,g=b.target.result,h=g.length;e.onload=function(b){var u=e.width,l=e.height,d=p.getResizeFunction()(u,l);b=d.w;var k=d.h,d=d.q;c.width=u;c.height=l;c.attr("width",
u);c.attr("height",l);c.css({width:px(u),height:px(l)});c[0].getContext("2d").drawImage(e,0,0,u,l);u=multiStageRescale(c[0],b,k);f.width=b;f.height=k;f.resizedImage=u.toDataURL("image/jpeg",d);h<f.resizedImage.length&&(f.resizedImage=g);a()};e.src=g};b.readAsDataURL(f.fileUpload)}},a=function(){if("imageDefinition"==f.type){WorkQueue.pause();var a=Date.now(),b=sprintf("%s%s",UserSettings.getUsername(),a),c=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",c.toString(),
encodeURI(b));$.ajax({url:b,type:"POST",success:function(b){var e=$(b).find("resourceUrl").text(),g={type:"image",author:UserSettings.getUsername(),timestamp:a,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+e+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:e,slide:c.toString(),source:$(b).text(),bounds:[f.x,f.y,f.x+f.width,f.y+f.height],width:f.width,height:f.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:f.x,
y:f.y};registerTracker(e,function(){var a=Modes.select.handlesAtZoom(),b=g.x,c=g.y,f=Math.max(g.width,viewboxWidth),d=Math.max(g.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,f+2*a,d+2*a);Modes.select.clearSelection();Modes.select.selected.images[g.identity]=boardContent.images[g.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(g);h();WorkQueue.gracefullyResume()},error:function(a){console.log(a);h();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:f.resizedImage,cache:!1,contentType:!1,processData:!1})}},q=!1;$(function(){q||(q=!0,k=$("#imageInsertOptions").css({position:"absolute",left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),g=$("#imageFileChoice").attr("accept","image/*"),g[0].addEventListener("change",function(b){b=(b.target.files||b.dataTransfer.files)[0];0==b.type.indexOf("image")&&(f.fileUpload=b);c(a)},!1),h())});return{activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.image;e("#imageTools","#imageMode");var a=screenToWorld(10,10);f={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");p.reapplyVisualStyle();k.show()},deactivate:function(){h();b()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");Modes.currentMode.deactivate();e("#panTools","#panMode");Modes.currentMode=Modes.pan;var b,k;registerPositionHandlers(board,function(e,h,p){takeControlOfViewbox();b=e;k=h},function(e,h,p){Pan.translate(-1*
(e-b),-1*(h-k));b=e;k=h},function(b,f,e){})},deactivate:function(){b();unregisterPositionHandlers(board)}},select:function(){var f=!1,k=function(){Modes.select.selected={images:{},text:{},inks:{},multiWordTexts:{}};Progress.call("onSelectionChanged",[Modes.select.selected])},g=_.debounce(function(){var a=!1;_.forEach(["images","texts","inks","highlighters","multiWordTexts"],function(b){var c="highlighters"==b?"inks":b;if(Modes&&Modes.select&&Modes.select.selected&&c in Modes.select.selected){var f=
Modes.select.selected[c];_.forEach(f,function(e){f&&b in boardContent&&e&&e.identity in boardContent[b]?f[e.identity]=boardContent[b][e.identity]:(a=!0,"inks"==c?"highlighters"==b&&e.identity in f&&1==f[e.identity].isHighlighter?delete f[e.identity]:"inks"==b&&e.identity in f&&0==f[e.identity].isHighlighter&&delete f[e.identity]:delete f[e.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),h=function(){if(void 0!=Modes.select.selected&&f&&"Blacklist"in window){var a=
Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),a.inks,a.texts,a.multiWordTexts,a.images)}k()},p=function(){(f=Conversations.shouldModifyConversation()?!f:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");k()},c=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),$("#ban").removeClass("disabledButton"),$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):
($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());f?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=g;Progress.onViewboxChanged.ModesSelect=g;Progress.onSelectionChanged.ModesSelect=function(a){a&&(Modes.select.selected=a,"images"in a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||
"multiWordTexts"in a&&0<_.size(a.multiWordTexts)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),f?($("#ban").removeClass("disabledButton"),$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?$("#ban").show():
$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=k;Progress.conversationDetailsReceived.ModesSelect=function(a){f&&!Conversations.shouldModifyConversation(a)&&(f=!1);Conversations.shouldModifyConversation(a)?($("#administerContent").unbind("click").bind("click",p),$("#ban").unbind("click").bind("click",h)):($("#administerContent").unbind("click"),$("#ban").unbind("click"));c(a)};return{name:"select",selected:{images:{},texts:{},
inks:{},multiWordTexts:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,b);
_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:k,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;e("#selectTools","#selectMode");var a={x:0,y:0},b=$("<div/>",{id:"selectMarquee"}),
g=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&!f){var a=batchTransform();a.isDeleted=!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&(a.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));sendStanza(a);
k()}});var h=function(a){a("images");a("texts");a("multiWordTexts");a("inks")};Modes.select.dragging=!1;c();Modes.select.resizing=!1;registerPositionHandlers(board,function(c,e,f,h,k){Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:c,y:e};Modes.select.marqueeWorldOrigin=h;if(!k.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){c=10/scale();var t=[h.x-c,h.y-c,h.x+c,h.y+c];Modes.select.dragging=_.some(["images","texts","inks","multiWordTexts"],function(a){return _.some(Modes.select.selected[a],
function(a){return a?intersectRect(a.bounds,t):!1})})}Modes.select.dragging?(Modes.select.offset=h,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(g.empty(),g.append(b),b.show(),updateMarquee(b,a,a))},function(c,e,f,g,h){c={x:c,y:e};Modes.select.offset=g;Modes.select.dragging?blit():Modes.select.resizing?blit():updateMarquee(b,a,c)},function(a,c,e,g,k){WorkQueue.gracefullyResume();try{var t=g.x-Modes.select.marqueeWorldOrigin.x,p=g.y-Modes.select.marqueeWorldOrigin.y;
15>Math.abs(t)+Math.abs(p)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=t;a.doc.position.y+=p;a.doc.invalidateBounds()});var l=batchTransform();l.xTranslate=t;l.yTranslate=p;l.inkIds=_.keys(Modes.select.selected.inks);l.textIds=_.keys(Modes.select.selected.texts);l.imageIds=_.keys(Modes.select.selected.images);
l.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(l.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(l)}else{var d=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,g,2),m=[d.left,d.top,d.right,d.bottom],n={images:{},texts:{},inks:{},multiWordTexts:{}},C={},D={};h(function(a){$.each(boardContent[a],function(b,c){if(!("bounds"in c)&&"type"in c)switch(c.type){case "text":prerenderText(c);break;case "image":prerenderImage(c);
break;case "ink":prerenderInk(c);break;default:c.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(m,c.bounds)&&(incrementKey(C,c.author),incrementKey(D,"any"),f?c.author!=UserSettings.getUsername()&&(n[a][c.identity]=c):c.author==UserSettings.getUsername()&&(n[a][c.identity]=c))})});$.each(boardContent.highlighters,function(a,b){intersectRect(b.bounds,m)&&(incrementKey(C,b.author),f?b.author!=UserSettings.getUsername()&&(n.inks[b.identity]=b):b.author==UserSettings.getUsername()&&(n.inks[b.identity]=b))});
h(function(a){$.each(n[a],function(b,c){a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=c})});D.any||Modes.select.clearSelection();var E=sprintf("Selected %s images, %s texts, %s inks, %s rich texts ",_.keys(Modes.select.selected.images).length,_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,_.keys(Modes.select.selected.inks).length);$.each(C,function(a,b){E+=sprintf("%s:%s ",a,
b)});Progress.call("onSelectionChanged",[Modes.select.selected])}b.css({width:0,height:0}).hide();blit()}catch(F){console.log("Selection up",F)}})},deactivate:function(){unregisterPositionHandlers(board);b();k();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();c();blit()}}}(),zoom:{name:"zoom",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;e("#zoomTools","#zoomMode");var b=$("<div />",{id:"zoomMarquee"}),
k,g={x:0,y:0};registerPositionHandlers(board,function(e,p,c,a){takeControlOfViewbox();k=a;b.show();b.appendTo($("#selectionAdorner"));g={x:e,y:p};updateMarquee(b,g,g)},function(e,k,c,a){e={x:e,y:k};k=rectFromTwoPoints(e,g);c="left";a="top";e.x==k.left&&(c="right");e.y==k.top&&(a="bottom");e=aspectConstrainedRect(k,c,a);updateMarquee(b,{x:e.right,y:e.bottom},{x:e.left,y:e.top})},function(e,g,c,a){WorkQueue.gracefullyResume();b.hide();e={x:contentOffsetX+a.x,y:contentOffsetY+a.y};g=rectFromTwoPoints(e,
{x:contentOffsetX+k.x,y:contentOffsetY+k.y});2500>scale()*g.width*g.height||(c="left",a="top",e.x==g.left&&(c="right"),e.y==g.top&&(a="bottom"),e=aspectConstrainedRect(g,c,a),IncludeView.specific(e.left,e.top,e.width,e.height))})},deactivate:function(){b();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},feedback:function(){var f=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};
Progress.onConversationJoin.setConversationRole=function(){f()};Progress.conversationDetailsReceived.respectNewPermissions=f;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;f();e("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(b,e,f,m){},function(b,e,f,m){},function(b,e,f,m){});f()},deactivate:function(){b();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),draw:function(){var f=Brushes.getDefaultBrushes(),
k=_.map(f,function(a){return _.clone(a)}),g,h=!1,m=void 0,c=void 0,a=function(a){k[a.index]=a},n=function(){},z=function(){},v=function(){};$(function(){$(".activeBrush").removeClass("activeBrush");var b=function(){var b=$("#drawTools");_.each(b.find(".modeSpecificTool.pen"),function(b,c){var d=k[c],f=$(b).css({color:d.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");g=d;a(d);Modes.draw.drawingAttributes=g;h=!1;e(d)}).removeClass("fa-tint").removeClass("fa-circle").addClass(d.isHighlighter?
"fa-circle":"fa-tint");f.find(".widthIndicator").text(d.width);d==g&&f.addClass("activeBrush")})},e=function(f){var h=$("#colors .dots"),l=$("#sizes .dots"),d=Colors.getAllNamedColors(),k=Brushes.getAllBrushSizes();l.empty();k.map(function(c){var d=m.clone();l.append(d);d.click(function(){f.width=c;a(f);g=f;b();e(f)});var h=Canvas.circle(f.color,c,50);c==f.width&&d.addClass("activeTool");d.prepend(h);h=c.toString()+"px";d.find(".sizeDotName").append(h)});h.empty();d.map(function(d){var k=c.clone();
h.append(k);k.on("click",function(){f.color=d.rgb;g=f;a(f);b();e(f)});k.css("color",d.rgb);"rgb"in d&&d.rgb==f.color&&k.addClass("activeTool");var l=d.name;k.find(".colorDotName").append(l)});d=$("#setPenToHighlighter").unbind("click").on("click",function(){f.isHighlighter=!0;g=f;a(f);b();e(f)});k=$("#setPenToPen").unbind("click").on("click",function(){f.isHighlighter=!1;g=f;a(f);b();e(f)});"isHighlighter"in g&&g.isHighlighter?(d.addClass("activeTool").addClass("active"),k.removeClass("activeTool").removeClass("active")):
(k.addClass("activeTool").addClass("active"),d.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var a=_.find(f,function(a){return a.id==g.id});void 0!=a&&(g.width=a.width,g.color=a.color,g.isHighlighter=a.isHighlighter,b(),e(g))});m=$("#penSize .sizeDot").clone();c=$("#penColor .colorDot").clone();g=k[0];b();e(g);var y=$("#drawTools");y.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");
$(this).addClass("activeBrush");h=!0;$("#drawDropdowns").hide()});y.find(".advancedTools").unbind("click").on("click",function(){h||(e(g),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});var r=[];z=function(a,b,c,d,e){w=[];h||e.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,r=[a,b,256*c])};var w=[];v=function(a,b,c,d,e){if(h||e.eraser){var f=
[d.x-10,d.y-10,d.x+10,d.y+10];a=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,f)){delete a[c.identity];w.push(c.identity);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";a(boardContent.inks);a(boardContent.highlighters);boardContext.globalAlpha=1}else d=Modes.draw.drawingAttributes.width*c,boardContext.beginPath(),boardContext.lineCap=
"round",boardContext.lineWidth=d,d=_.takeRight(r,3),boardContext.moveTo(d[0],d[1]),boardContext.lineTo(a,b),boardContext.stroke(),r=r.concat([a,b,256*c])};n=function(a,b,c,d,e){h||e.eraser?(a=batchTransform(),a.isDeleted=!0,a.inkIds=w,sendStanza(a)):(d=Modes.draw.drawingAttributes.width*c,boardContext.lineWidth=d,boardContext.beginPath(),boardContext.lineWidth=d,boardContext.lineCap="round",d=_.takeRight(r,3),boardContext.moveTo(d[0],d[1]),boardContext.lineTo(a,b),boardContext.stroke(),r=r.concat([a,
b,256*c]),strokeCollected(r.join(" ")));boardContext.globalAlpha=1}});return{name:"draw",brushes:k,activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,Modes.draw.drawingAttributes=g,e("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),h?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==g.id&&$(a).addClass("activeBrush")}),
registerPositionHandlers(board,z,v,n))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();b();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,function(b,e,g,h){},function(b,e,g,h){},function(b,e,g,h){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
