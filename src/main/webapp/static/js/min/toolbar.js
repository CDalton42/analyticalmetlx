function devLogAdd(a){$("#devLog").append($("<div />",{text:a}))}function devLogSet(a){$("#devLog").html($("<div />",{text:a}))}var incrementKey=function(a,c){c in a?a[c]++:a[c]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(a){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(c,h){a.unbind(h)});WorkQueue.gracefullyResume()}
function progress(){var a=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),c=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(a),h=$("<progress />");h.append(a);var m=1,b=0,r=function(){c.css("width",sprintf("%s%%",Math.floor(b/m*100)));h.attr({value:b,max:m})},g={element:h,value:function(a){b=a;r();return g},max:function(b){m=b;r();return g}};return g}
function proportion(a,c){return a/c/(boardWidth/boardHeight)}function scaleScreenToWorld(a){var c;c=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return a*c}function scaleWorldToScreen(a){var c;c=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return a/c}function screenToWorld(a,c){var h=scaleScreenToWorld(a)+viewboxX,m=scaleScreenToWorld(c)+viewboxY;return{x:h,y:m}}
function worldToScreen(a,c){var h=scaleWorldToScreen(a-viewboxX),m=scaleWorldToScreen(c-viewboxY);return{x:h,y:m}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(a){return!1}}
function registerPositionHandlers(a,c,h,m){var b=!1,r=function(b,a){var c=[b.x-10,b.y-10,b.x+10,b.y+10],d=!0;_.each(Modes.canvasInteractables,function(f,t){_.each(f,function(f){void 0!=f&&a in f&&(f.activated||intersectRect(c,f.getBounds()))&&(d=d&&f[a](b))})});return d},g=function(b,a){return{shift:b.shiftKey,ctrl:b.ctrlKey,alt:b.altKey,eraser:a}};$.each(a,function(a,A){var n=$(A);n.css({"touch-action":"none"});var d=!1,f={},t=function(e){return void 0!==e&&"touch"==e.originalEvent.pointerType?1<
_.size(f):!1},l=function(e){var k=e.originalEvent.pointerId,b="pen"==e.originalEvent.pointerType&&5==e.originalEvent.button,B=n.offset(),a=e.pageX-B.left,B=e.pageY-B.top,l=e.originalEvent.pressure||.5,p=screenToWorld(a,B),c=f[k]||{pointerId:k,pointerType:e.originalEvent.pointerType,eraser:b,points:[]};c.points.push({x:p.x,y:p.y,screenX:a,screenY:B,z:l});c.eraser=c.eraser||b;"touch"==e.originalEvent.pointerType&&(f[k]=c);t(e)&&(0==d&&_.each(f,function(e){e.points=[_.last(e.points)]}),d=!0);return{pointerType:e.pointerType,
eraser:c.eraser,x:a,y:B,z:l,worldPos:p}},p=function(e){var k=e.originalEvent.pointerId,K="pen"==e.originalEvent.pointerType&&5==e.originalEvent.button,a=n.offset(),l=e.pageX-a.left,a=e.pageY-a.top,p=e.originalEvent.pressure||.5,t=screenToWorld(l,a);"touch"==e.originalEvent.pointerType&&delete f[k];d&&0==_.size(f)&&(b=d=!1);return{pointerType:e.pointerType,eraser:K,x:l,y:a,z:p,worldPos:t}};if(detectPointerEvents()){var D=function(){takeControlOfViewbox(!0);var e=_.map(_.filter(f,function(e){return 0<
_.size(e.points)}),function(e){var k=_.first(e.points);e=_.last(e.points);return[k,e]});f={};var k=_.meanBy(e,function(e){return e[0].x-e[1].x}),b=_.meanBy(e,function(e){return e[0].y-e[1].y});Pan.translate(scaleWorldToScreen(k),scaleWorldToScreen(b));var k=_.min(_.map(e,function(e){return e[0].y})),a=_.max(_.map(e,function(e){return e[0].y})),b=_.min(_.map(e,function(e){return e[0].x})),d=_.max(_.map(e,function(e){return e[0].x})),k=a-k,b=d-b,d=_.min(_.map(e,function(e){return e[1].y})),a=_.max(_.map(e,
function(e){return e[1].y})),l=_.min(_.map(e,function(e){return e[1].x})),e=(_.max(_.map(e,function(e){return e[1].x}))-l+(a-d))/2;Zoom.scale((b+k)/2/e)};n.bind("pointerdown",function(e){e.originalEvent.pointerType!=e.POINTER_TYPE_TOUCH&&"touch"!=e.originalEvent.pointerType||!t(e)||(d=!0);var k=l(e);e.preventDefault();WorkQueue.pause();t(e)||d||(b=!0,r(k.worldPos,"down")&&c(k.x,k.y,k.z,k.worldPos,g(e,k.eraser)))});n.bind("pointermove",function(e){var k=l(e);e.preventDefault();e.originalEvent.pointerType!=
e.POINTER_TYPE_TOUCH&&"touch"!=e.originalEvent.pointerType||!t(e)&&!d?r(k.worldPos,"move")&&b&&h(k.x,k.y,k.z,k.worldPos,g(e,k.eraser)):D()});n.bind("pointerup",function(e){var k=p(e);WorkQueue.gracefullyResume();e.preventDefault();r(k.worldPos,"up")&&b&&!d&&m(k.x,k.y,k.z,k.worldPos,g(e,k.eraser));b=!1;Modes.finishInteractableStates()});var x=function(e){p(e);WorkQueue.gracefullyResume();e.preventDefault();if(b){var k=e.offsetX,a=e.offsetY,l=p(e);f={};WorkQueue.gracefullyResume();k=screenToWorld(k,
a);a=k.x;a<viewboxX?(takeControlOfViewbox(!0),Extend.left()):a>=viewboxX+viewboxWidth?(takeControlOfViewbox(!0),Extend.right()):r(k,"up")&&b&&!d&&m(l.x,l.y,l.z,l.worldPos,g(e,l.eraser));b=!1;Modes.finishInteractableStates()}b=!1;Modes.finishInteractableStates()};n.bind("pointerout",x);n.bind("pointerleave",x);n.bind("pointercancel",x)}else{n.bind("mousedown",function(e){WorkQueue.pause();var k=n.offset();b=!0;var f=e.pageX-k.left,k=e.pageY-k.top,a=screenToWorld(f,k);r(a,"down")&&c(f,k,.5,a,g(e));
e.preventDefault()});n.bind("mousemove",function(e){var k=n.offset();e.preventDefault();var f=e.pageX-k.left,k=e.pageY-k.top,a=screenToWorld(f,k);r(a,"move")&&b&&h(f,k,.5,a,g(e))});n.bind("mouseup",function(e){WorkQueue.gracefullyResume();e.preventDefault();var k=n.offset(),f=e.pageX-k.left,k=e.pageY-k.top,a=screenToWorld(f,k);r(a,"up")&&b&&m(f,k,.5,a,g(e));b=!1;Modes.finishInteractableStates()});var u=function(e,k,f){WorkQueue.gracefullyResume();var a=screenToWorld(e,k),l=a.x;l<viewboxX?(takeControlOfViewbox(!0),
Extend.left()):l>=viewboxX+viewboxWidth?(takeControlOfViewbox(!0),Extend.right()):r(a,"up")&&b&&!d&&m(e,k,.5,a,g(f,!1));b=!1};n.bind("mouseout",function(e){WorkQueue.gracefullyResume();e.preventDefault();b&&u(e.offsetX,e.offsetY,e);b=!1;Modes.finishInteractableStates()});var y,v=function(e){return{x:average(_.map(e,"x")),y:average(_.map(e,"y"))}},w=function(e){var k=[],f=n.offset();$.each(e,function(e,b){k.push({x:b.pageX-f.left,y:b.pageY-f.top,identifier:b.identifier})});return k};n.bind("touchstart",
function(e){WorkQueue.pause();e.preventDefault();var k=w(e.originalEvent.touches);if(1==k.length){var k=k[0],f=screenToWorld(k.x,k.y);b=!0;r(f,"down")&&c(k.x,k.y,.5,f,g(e))}else y=v(k)});n.bind("touchmove",function(e){e.preventDefault();var k=w(e.originalEvent.touches);switch(k.length){case 0:break;case 1:var k=k[0],f=screenToWorld(k.x,k.y);r(f,"move")&&b&&h(k.x,k.y,.5,f,g(e));break;default:e=v(k),k=e.x-y.x,f=e.y-y.y,y=e,takeControlOfViewbox(!0),Pan.translate(-1*k,-1*f)}});n.bind("touchend",function(e){WorkQueue.gracefullyResume();
e.preventDefault();var k=n.offset(),f=e.originalEvent.changedTouches[0],a=f.pageX-k.left,k=f.pageY-k.top,f=screenToWorld(a,k);r(f,"up")&&b&&(0>a||0>k||a>boardWidth||k>boardHeight?u(a,k):m(a,k,.5,f,g(e)));b=!1;Modes.finishInteractableStates()});var C=1;n.bind("gesturechange",function(e){WorkQueue.pause();e.preventDefault();b=!1;e=e.originalEvent.scale;takeControlOfViewbox(!0);Zoom.scale(C/e);C=e});n.bind("gestureend",function(){WorkQueue.gracefullyResume();C=1})}});return function(a){b=a}}
function aspectConstrainedDimensions(a,c){var h=boardHeight/boardWidth,m={height:c,width:a};c/a>h?m.height=a*h:m.width=c/h;return m}
function aspectConstrainedRect(a,c,h){var m=boardHeight/boardWidth,b={left:a.left,top:a.top,right:a.right,bottom:a.bottom,width:a.width,height:a.height};a.height/a.width>m?(b.height=a.width*m,h&&(c=a.height-b.height,"center"==h?b.top+=c/2:"bottom"==h&&(b.top+=c))):(b.width=a.height/m,c&&(h=a.width-b.width,"center"==c?b.left+=h/2:"right"==c&&(b.left+=h)));b.right=b.left+b.width;b.bottom=b.top+b.height;return b}
function copyBuffer(a){var c=document.createElement("canvas");c.width=a.width;c.height=a.height;c.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,a.width,a.height);return c}function intersectRect(a,c){return"undefined"!=typeof a&&"undefined"!=typeof c?!(c[0]>a[2]||c[2]<a[0]||c[1]>a[3]||c[3]<a[1]):!1}function overlapRect(a,c){return intersectRect(a,c)?(Math.max(a[0],c[0])-Math.min(a[2],c[2]))*(Math.max(a[1],c[1])-Math.min(a[3],c[3])):0}
function rectFromTwoPoints(a,c,h){h=h||0;var m,b,r;a.x<c.x?(m=a.x,r=c.x):(m=c.x,r=a.x);a.y<c.y?(b=a.y,a=c.y):(b=c.y,a=a.y);c=r-m;var g=a-b;c<h&&(r+=h-c,c=r-m);g<h&&(a+=h-g,g=a-b);return{left:m,top:b,right:r,bottom:a,width:c,height:g}}function updateMarquee(a,c,h){c=rectFromTwoPoints(c,h);h=$("#selectionAdorner");jQuery.contains(h,a)||h.append(a);a.is(":visible")||a.show();a.css({left:px(c.left),top:px(c.top),width:px(c.width),height:px(c.height)})}
function clampToView(a){var c=a.x,h=a.y;0>a.x&&(c=0);a.x>boardWidth&&(c=boardWidth);0>a.y&&(h=0);a.y>boardHeight&&(h=boardHeight);return{x:c,y:h}}
var bounceButton=function(a){var c=$(a);c.addClass("activeBrush");setTimeout(function(){c.removeClass("activeBrush")},200)},videoControlInteractable=function(a){var c=void 0;return{activated:!1,rehome:function(a){},down:function(a){return!1},move:function(a){return!1},up:function(c){var m=Modes.select.handlesAtZoom();c=c.x-a.x;if(c<m)a.getState().paused?a.play():a.pause();else if(c>a.width-m)a.muted(!a.muted());else{var b=a.getState();a.seek((c-m)/(a.width-2*m)*b.duration)}return!1},getBounds:function(){return c},
deactivate:function(){},render:function(h){if(a.identity in boardContent.videos){var m=Modes.select.handlesAtZoom();c=[a.bounds[0],a.bounds[3],a.bounds[2],a.bounds[3]+m];var m=worldToScreen(c[0],c[1]),b=worldToScreen(c[2],c[3]),r=b.x-m.x,g=b.y-m.y,q=a.getState();h.globalAlpha=1;h.setLineDash([]);h.strokeStyle="black";h.font=sprintf("%spx FontAwesome",g);h.fillStyle="white";h.fillRect(m.x,m.y,g,g);h.fillStyle="black";q.paused?h.fillText("\uf04b",m.x,b.y):h.fillText("\uf04c",m.x,b.y);var A=m.x+g,n=
r-g;h.fillStyle="black";h.fillRect(A,m.y,n,g);h.fillStyle="blue";n*=q.currentTime/q.duration;h.fillRect(A,m.y,n,g);r=m.x+(r-g);h.fillStyle="white";h.fillRect(r,m.y,g,g);h.fillStyle="black";q.muted?h.fillText("\uf0f3",r,b.y):h.fillText("\uf1f6",r,b.y)}}}},Modes=function(){var a=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},c=function(b,c){a();$(b).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$(c).addClass("activeTool").removeClass("inactiveTool")},h={name:"none",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.none;a()},deactivate:function(){a();unregisterPositionHandlers(board)}},m=function(b,a){b in Modes.canvasInteractables||(Modes.canvasInteractables[b]=[]);Modes.canvasInteractables[b].push(a)};$(function(){var a={opacity:1};(new TWEEN.Tween(a)).delay(1E3).to({opacity:.3},1E3);var c=Modes.select.handlesAtZoom(),g=function(a){var f=Modes.select.handlesAtZoom(),
b=scaleScreenToWorld(DeviceConfiguration.headerHeight)+f,l=scaleScreenToWorld(DeviceConfiguration.footerHeight);return Math.min(viewboxY+viewboxHeight-(l-f/2),Math.max(a,viewboxY+b))},q=function(){var d=void 0;return{getBounds:function(){return d},activated:!1,originalHeight:1,originalWidth:1,rehome:function(f){if(!q.activated){var a=Modes.select.handlesAtZoom(),b=g(f.y);f=f.x+a/2;d=[f-a/2,b-a,f+a/2,b]}},down:function(f){q.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=
f;Modes.select.marqueeWorldOrigin=f;blit()},move:function(f){q.activated&&(q.bounds=[f.x-c,f.y,f.x+c,f.y],Modes.select.offset=f,blit());return!1},deactivate:function(){q.activated=!1;Modes.select.dragging=!1},up:function(f){q.deactivate();var a=batchTransform(),b=f.x-Modes.select.marqueeWorldOrigin.x,d=f.y-Modes.select.marqueeWorldOrigin.y;a.xTranslate=b;a.yTranslate=d;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);
a.videoIds=_.keys(Modes.select.selected.videos);a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(a.multiWordTextIds,function(a){Modes.text.echoesToDisregard[a]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(a){a.doc.position.x+=b;a.doc.position.y+=d;a.doc.invalidateBounds()});sendStanza(a);registerTracker(a.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(f){if(d){var c=worldToScreen(d[0],d[1]),l=worldToScreen(d[2],d[3]).x-
c.x,p=c.x,c=c.y;f.globalAlpha=a.opacity;f.setLineDash([]);f.strokeStyle="black";f.fillStyle="white";f.strokeWidth=2;f.fillRect(p,c,l,l);f.strokeRect(p,c,l,l);f.font=sprintf("%spx FontAwesome",l);f.fillStyle="black";f.fillText("\uf047",p,c+l-4)}}}}(),h=function(){var d=void 0;return{getBounds:function(){return d},activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!h.activated){var b=Modes.select.handlesAtZoom(),l=a.x2;a=g(a.y)-b;d=[l,a,l+b,a+b]}},down:function(a){Modes.select.aspectLocked=
!0;Modes.select.dragging=!1;Modes.select.resizing=!0;h.activated=!0;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};h.rehome(a);blit();return!1},move:function(a){if(h.activated){d=[a.x-c,d[1],a.x+c,d[3]];var b=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x,y:b.y+(a.x-b.x)/(b.x2-b.x)*b.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;h.activated=!1;Modes.select.resizing=!1},up:function(a){h.deactivate();var b=batchTransform(),d=Modes.select.totalSelectedBounds();
b.xScale=(a.x-d.x)/(d.x2-d.x);b.yScale=b.xScale;b.xOrigin=d.x;b.yOrigin=d.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(a,f){Modes.text.echoesToDisregard[f]=!0;var d=a.doc.documentRange();a.doc.select(d.start,d.end);Modes.text.scaleEditor(a.doc,
b.xScale);d=a.doc.width();a.doc.width(d*b.xScale);a.doc.select(0);a.doc.updateCanvas();blit()});registerTracker(b.identity,function(){Progress.call("onSelectionChanged")});sendStanza(b);return!1},render:function(f){if(d){var c=worldToScreen(d[0],d[1]),l=worldToScreen(d[2],d[3]).x-c.x,p=l/10,g=-1*l;f.globalAlpha=a.opacity;f.setLineDash([]);f.strokeStyle="black";f.fillStyle="white";f.strokeWidth=2;f.translate(c.x,c.y);f.rotate(90*Math.PI/180);f.fillRect(0,g,l,l);f.strokeRect(0,g,l,l);f.font=sprintf("%spx FontAwesome",
l);f.fillStyle="black";f.fillText("\uf0b2",p,-1*p)}}}}(),n=function(){var d=void 0;return{activated:!1,getBounds:function(){return d},rehome:function(a){if(!n.activated){var b=Modes.select.handlesAtZoom(),c=a.x2;a=g(a.y2);d=[c,a-b,c+b,a]}},down:function(a){n.activated=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();return!1},move:function(a){n.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),
n.bounds=[a.x-c,a.y-c,a.x+c,a.y+c],Modes.select.offset={x:a.x,y:a.y},blit());return!1},deactivate:function(){n.activated=!1;Modes.select.resizing=!1},up:function(a){n.deactivate();var b=batchTransform(),d=Modes.select.totalSelectedBounds(),c=d.y2-d.y,g=a.y-d.y;b.xScale=(a.x-d.x)/(d.x2-d.x);b.yScale=g/c;b.xOrigin=d.x;b.yOrigin=d.y;b.inkIds=_.keys(Modes.select.selected.inks);b.textIds=_.keys(Modes.select.selected.texts);b.imageIds=_.keys(Modes.select.selected.images);b.videoIds=_.keys(Modes.select.selected.videos);
var r=scale();_.each(Modes.select.selected.multiWordTexts,function(a){0<a.doc.save().length&&(a.doc.width(Math.max(a.doc.width()*b.xScale,Modes.text.minimumWidth/r)),a.doc.updateCanvas(),sendRichText(a))});blit();registerTracker(b.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(b);return!1},render:function(f){if(d){var c=worldToScreen(d[0],d[1]),l=worldToScreen(d[2],d[3]).x-c.x,p=l/10,g=-1*l;f.globalAlpha=a.opacity;f.setLineDash([]);f.strokeStyle="black";f.fillStyle="white";
f.strokeWidth=2;f.translate(c.x,c.y);f.rotate(90*Math.PI/180);f.fillRect(0,g,l,l);f.strokeRect(0,g,l,l);f.font=sprintf("%spx FontAwesome",l);f.fillStyle="black";f.fillText("\uf065",p,-1*p)}}}}();m("manualMove",q);m("resizeFree",n);m("resizeAspectLocked",h);Progress.textBoundsChanged.selectionHandles=function(a,b){if(a in Modes.select.selected.multiWordTexts){var c=Modes.select.totalSelectedBounds();q.rehome(c);n.rehome(c);h.rehome(c);blit()}};Progress.onSelectionChanged.selectionHandles=function(){var d=
Modes.select.totalSelectedBounds();Infinity==d.x?a.opacity=0:(a.opacity=1,q.rehome(d),n.rehome(d),h.rehome(d),blit())}});return{pushCanvasInteractable:m,clearCanvasInteractables:function(a){Modes.canvasInteractables[a]=[]},getCanvasInteractables:function(){return _.mapValues(Modes.canvasInteractables,function(a){return _.map(a,function(a){a=_.clone(a);a.bounds=a.getBounds();return a})})},currentMode:h,none:h,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),
function(a){_.forEach(Modes.canvasInteractables[a],function(a){void 0!=a&&"deactivate"in a&&a.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var b,h,g,q,m,n,d,f,t=function(e,a){var b=Modes.text.minimumWidth/scale(),b=Modes.text.editorFor({bounds:[e.x,e.y,e.x,e.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),slide:Conversations.getCurrentSlideJid(),target:"presentationSpace",
requestedWidth:b,width:b,height:0,x:e.x,y:e.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});b.doc.load(a);return b},l=function(e){return function(){var a=!1;_.each(boardContent.multiWordTexts,function(b){if(b.doc.isActive){a=!0;var d=b.doc.selectedRange();carota.runs.nextInsertFormatting={};d.setFormatting(e,!0!==d.getFormatting()[e]);b.doc.updateCanvas();0<b.doc.save().length&&sendRichText(b)}});if(!a){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var b=
carota.runs.nextInsertFormatting[e]=!carota.runs.nextInsertFormatting[e];$(sprintf(".font%sSelector",_.capitalize(e))).toggleClass("active",b)}blit()}},p=function(e,a){return function(){var b=!1;a=a||$(this).val();_.each(boardContent.multiWordTexts,function(d){d.doc.isActive&&(b=!0,carota.runs.nextInsertFormatting={},d.doc.selectedRange().setFormatting(e,a),carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[e]=a,d.doc.updateCanvas(),d.doc.claimFocus(),
0<d.doc.save().length&&sendRichText(d))});b||(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[e]=a);blit()}},D=function(e,a){var b=e.selectedRange(),d=0,f=[],c=carota.runs.defaultFormatting.size;e.runs(function(a){a=_.size(a.text);a=d+a;e.select(d,a,!0);var b=e.selectedRange().getFormatting().size||c;_.each(_.range(d,a),function(){f.push(b)});d=a;c=b},e.range(0,b.end));d=b.start;e.runs(function(b){b=d+b.text.length;e.select(d,b,!0);e.selectedRange().setFormatting("size",
f[d]*a);d=b},e.range(b.start,b.end));e.select(b.start,b.end,!0);e.invalidateBounds();return f},x=function(e){return function(){_.each(boardContent.multiWordTexts,function(a){a=a.doc;a.isActive&&(a=D(a,e),carota.runs.defaultFormatting.newBoxSize=1<e?_.max(a):_.min(a))})}};$(function(){q=$(".fontBoldSelector");m=$(".fontItalicSelector");n=$(".fontUnderlineSelector");$("#textDropdowns");$("#fontOptions");b=$("#fontFamilySelector");h=$("#fontSizeSelector");g=$("#fontColorSelector");d=$("#fontLarger");
f=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");$("#presetFullscreen");$("#presetCenterOnScreen");var a=b.find(".fontFamilyOption").clone(),k=h.find(".fontSizeOption").clone(),c=g.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(k){b.append(a.clone().attr("value",k).text(k))});Fonts.getAllSizes().map(function(a){h.append(k.clone().attr("value",a).text(a))});Colors.getAllNamedColors().map(function(a){g.append(c.clone().attr("value",
a.rgb).text(a.name))});d.on("click",x(1.2));f.click(x(.8));q.click(l("bold"));m.click(l("italic"));n.click(l("underline"));var C={red:"#ff0000",blue:"#0000ff",black:"#000000",yellow:"#ffff00",green:"#00ff00"};_.each(["red","blue","black","yellow","green"],function(a){$(sprintf("#%sText",a)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");Modes.text.refocussing=!0;p("color",[C[a],255])()})})});var u=function(a,b,d){(a=1==a[d])&&(carota.runs.nextInsertFormatting[d]=
a);b.toggleClass("active",a)},y=function(a,b,d,f){var c=_.isEqual(a[d],f);d in a&&c&&(carota.runs.nextInsertFormatting[d]=f);b.toggleClass("active",c)},v=function(){return[$("#blackText"),$("#redText"),$("#blueText"),$("#yellowText"),$("#greenText")]},w=v(),C=function(a){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};u(a,q,"bold");u(a,m,"italic");u(a,n,"underline");y(a,w[0],"color",["#000000",255]);y(a,w[1],"color",["#ff0000",255]);y(a,w[2],"color",["#0000ff",255]);y(a,w[3],
"color",["#ffff00",255]);y(a,w[4],"color",["#00ff00",255])};return{name:"text",echoesToDisregard:{},minimumWidth:240,minimumHeight:function(){return 3*Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},getSelectedRanges:function(){return _.map(boardContent.multiWordTexts,function(a){var b=a.doc.selectedRange();return{identity:a.identity,start:b.start,
end:b.end,text:b.plainText()}})},getLinesets:function(){return _.map(boardContent.multiWordTexts,function(a){a.doc.layout();return _.map(a.doc.frame.lines,function(a){return a.positionedWords.length})})},mapSelected:function(a){var b=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,function(d){d.identity in b&&a(d)})},scaleEditor:D,scrollToCursor:function(a){var b=a.bounds,d=a.doc.selectedRange().start;a=a.doc.getCaretCoords(d);var d=Math.floor(a.t/a.h),f=Math.floor(scaleScreenToWorld(boardContext.height)/
a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var d=Math.min(d,Math.max(0,f-2))*a.h,f=Math.max(b[2]-b[0],scaleWorldToScreen(10*a.h)),c=f/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(b[0],b[1]-d+a.t,f,c)}else b=Math.max(0,Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(b[1]-viewboxY))/a.h)-8))*a.h,0!=b&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+b,viewboxWidth,viewboxHeight)},refocussing:!1,editorFor:function(a){var b=boardContent.multiWordTexts[a.identity];
b||(b=boardContent.multiWordTexts[a.identity]=a);if(!b.doc){var d=a.author==UserSettings.getUsername();b.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",a.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],a);if(d){var f=_.debounce(function(){var a=boardContent.multiWordTexts[b.identity];a&&(a.target="presentationSpace",a.slide=Conversations.getCurrentSlideJid(),a.audiences=ContentFilter.getAudiences(),sendRichText(a),incorporateBoardBounds(b.bounds))},1E3);Progress.beforeChangingAudience[a.identity]=
function(){f.flush();delete Progress.beforeChangingAudience[a.identity]};Progress.beforeLeavingSlide[a.identity]=function(){f.flush();delete Progress.beforeLeavingSlide[a.identity]};b.doc.contentChanged(f);b.doc.contentChanged(function(){Modes.text.scrollToCursor(b);blit()});b.doc.selectionChanged(function(a,b){if(Modes.text.refocussing)Modes.text.refocussing=!1;else{var e=a();C(e,v());blit()}})}}b.doc.position={x:a.x,y:a.y};b.doc.width(a.width);return b},oldEditorAt:function(a,b,d,f){var c=UserSettings.getUsername(),
l=[f.x-10,f.y-10,f.x+10,f.y+10];a=_.values(boardContent.texts).filter(function(a){return intersectRect(a.bounds,l)&&a.author==c});return 0<a.length?a[0]:!1},editorAt:function(a,b,d,f){var c=UserSettings.getUsername(),l=[f.x-10,f.y-10,f.x+10,f.y+10];a=_.values(boardContent.multiWordTexts).filter(function(a){return intersectRect(a.bounds,l)&&a.author==c}).filter(ContentFilter.exposes);return 0<a.length?a[0]:!1},contextFor:function(a,b){var d={x:b.x-a.position.x,y:b.y-a.position.y};return{node:a.byCoordinate(d.x,
d.y),relativePos:d}},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;c("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var a=0;w=v();C(carota.runs.defaultFormatting);registerPositionHandlers(board,function(a,b,e,d){if(a=Modes.text.editorAt(a,b,e,d).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,d).node)},function(a,b,e,d){(a=Modes.text.editorAt(a,b,e,d).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,
d).node)},function(b,d,f,c){var l=Date.now(),p=Modes.text.oldEditorAt(b,d,f,c),g=Modes.text.editorAt(b,d,f,c);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=a.doc.identity==g.identity;0<a.doc.selection.start+a.doc.selection.end&&a.doc.identity!=g.identity&&(a.doc.select(0,0),a.doc.updateCanvas());0==a.doc.documentRange().plainText().trim().length&&(delete boardContent.multiWordTexts[a.identity],blit())});Modes.select.clearSelection();p?(l=batchTransform(),l.isDeleted=!0,"texts"in Modes.select.selected&&
(l.textIds=[p.identity]),sendStanza(l),p=t({x:p.x,y:p.y},[{text:p.text,italic:"italic"==p.style,bold:"bold"==p.weight,underline:"underline"==p.decoration,color:p.color,size:p.size}]),l=p.doc,l.select(0,1),boardContent.multiWordTexts[p.identity]=p,c={multiWordTexts:{}},c.multiWordTexts[p.identity]=boardContent.multiWordTexts[p.identity],Modes.select.setSelection(c),c=g=p,c.privacy=Privacy.getCurrentPrivacy(),c.target="presentationSpace",c.slide=Conversations.getCurrentSlideJid(),sendRichText(c),incorporateBoardBounds(g.bounds),
c=l.byOrdinal(0),l.mousedownHandler(c),l.mouseupHandler(c)):g?(p=g.doc,c=Modes.text.contextFor(p,c),500>=l-a?p.dblclickHandler(c.node):p.mouseupHandler(c.node),a=l,c={multiWordTexts:{}},c.multiWordTexts[g.identity]=g,Modes.select.setSelection(c)):(p=t(c,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.newBoxSize/
scale()}]),l=p.doc,l.select(0,1),boardContent.multiWordTexts[p.identity]=p,c={multiWordTexts:{}},c.multiWordTexts[p.identity]=boardContent.multiWordTexts[p.identity],Modes.select.setSelection(c),g=p,c=l.byOrdinal(0),l.mousedownHandler(c),l.mouseupHandler(c));g.doc.invalidateBounds();g.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Progress.call("onSelectionChanged",[Modes.select.selected])})},handleDrop:function(a,b,d){if(0<a.length){a=carota.html.parse(a,
{});b=screenToWorld(b,d);Modes.text.activate();Date.now();Modes.select.clearSelection();var f=t(b,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.newBoxSize/scale()}]);b=f.doc;b.select(0,1);boardContent.multiWordTexts[f.identity]=f;d={multiWordTexts:{}};d.multiWordTexts[f.identity]=
boardContent.multiWordTexts[f.identity];Modes.select.setSelection(d);editor=f;d=b.byOrdinal(0);b.mousedownHandler(d);b.mouseupHandler(d);editor.doc.invalidateBounds();editor.doc.isActive=!0;editor.doc.load(a);Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(editor);a=boardContent.multiWordTexts[editor.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);
Progress.call("onSelectionChanged",[Modes.select.selected])}},deactivate:function(){DeviceConfiguration.setKeyboard(!1);a();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=!1;0==a.doc.documentRange().plainText().trim().length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();blit()}}}(),video:function(){var b={},h=void 0,g=void 0,q=function(){h.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=g.wrap("<form>").closest("form").get(0);
void 0!=a&&a.reset();g.unwrap()},m=function(a){if(void 0!=b&&void 0!=b.fileUpload&&void 0!=a){$("#videoWorking").show();$("#videoFileChoice").hide();var d=new FileReader;d.onload=function(d){var c=$("<video/>"),g=c[0],h=d.target.result;g.addEventListener("loadeddata",function(d){d=g.videoHeight;b.width=g.videoWidth;b.height=d;b.video=c;b.videoSrc=h;a()},!1);c.append($("<source />",{src:h,type:"video/mp4"}));c.load()};d.readAsDataURL(b.fileUpload)}},n=function(){if("imageDefinition"==b.type){WorkQueue.pause();
var a=Date.now(),d=sprintf("%s%s",UserSettings.getUsername(),a),c=Conversations.getCurrentSlideJid(),d=sprintf("/uploadDataUri?jid=%s&filename=%s",c.toString(),encodeURI(d));$.ajax({url:d,type:"POST",success:function(d){d=$(d).find("resourceUrl").text().trim();var g={type:"video",author:UserSettings.getUsername(),timestamp:a,identity:d,slide:c.toString(),source:d,bounds:[b.x,b.y,b.x+b.width,b.y+b.height],width:b.width,height:b.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),
x:b.x,y:b.y,audiences:_.map(Conversations.getCurrentGroup(),"id").concat(ContentFilter.getAudiences()).map(audienceToStanza)};registerTracker(d,function(){var a=Modes.select.handlesAtZoom(),b=g.x,d=g.y,c=Math.max(g.width,viewboxWidth),f=Math.max(g.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,d-a,c+2*a,f+2*a);Modes.select.clearSelection();Modes.select.selected.videos[g.identity]=boardContent.videos[g.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});
sendStanza(g);q();WorkQueue.gracefullyResume()},error:function(a){console.log("Image upload ex",a);resetImageUpload();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:b.videoSrc,cache:!1,contentType:!1,processData:!1})}},d=!1;$(function(){d||(d=!0,h=$("#videoInsertOptions").css({position:"absolute",left:0,top:0}),$("#videoInsertOptionsClose").click(Modes.select.activate),
g=$("#videoFileChoice").attr("accept","video/mp4"),g[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("video")&&(b.fileUpload=a);m(n)},!1),q())});Progress.beforeLeavingSlide.videos=function(){"videos"in boardContent&&_.forEach(boardContent.videos,function(a){null!=a&&void 0!=a&&"destroy"in a&&a.destroy()})};return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.video;c("#insertTools","#videoMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$("#insertMode").addClass("activeTool").removeClass("inactiveTool");$(".toolbar.active").removeClass("active");$("#videoMode").addClass("active");$("#insertTools .insetColumn").hide();$("#videoTools").show();var a=screenToWorld(10,10);b={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");h.show()},deactivate:function(){q();a()}}}(),image:function(){var b={},h=void 0,g=void 0,q=function(){h.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=
g.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();g.unwrap()},m=function(){var a=function(a,b,d,c){for(var e=b*d;e>a;)b*=.8,d*=.8,e=b*d;return{w:b,h:d,q:c}},b={"native":{resizeFunc:function(a,b){return{w:a,h:b,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(b,d){return a(1*c,b,d,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(b,d){return a(3*c,b,d,.8)},selector:"#imageInsertHighDef"}},d=b.optimized,c=1048576,f=function(){_.forEach(b,function(a){var b=
$(a.selector);d.selector==a.selector?b.addClass("activeBrush"):b.removeClass("activeBrush")})};$(function(){_.forEach(b,function(a){$(a.selector).on("click",function(){d=a;f()})});f()});return{reapplyVisualStyle:f,changeMode:function(a){a in b&&(d=b[a],f())},getResizeFunction:function(){return d.resizeFunc}}}(),n=function(a,c){var f=void 0==c?b:c;if(void 0==f||void 0==f.fileUpload||void 0==a)console.log("returning because currentImage is empty",b);else{$("#imageWorking").show();$("#imageFileChoice").hide();
var g=new FileReader;g.onload=function(b){var c=b.target.result;d(c,f,a,function(a){return c.length<a})};g.readAsDataURL(f.fileUpload)}},d=function(a,d,c,f){var g=void 0!=d?d:b,h=$("<canvas/>"),q=new Image;0!=a.indexOf("data")&&q.setAttribute("crossOrigin","Anonymous");q.onerror=function(a){errorAlert("Error dropping image","The source server you're dragging the image from does not allow dragging the image directly.  You may need to download the image first and then upload it.")};q.onload=function(b){var d=
q.width,e=q.height,k=m.getResizeFunction()(d,e);b=k.w;var p=k.h,k=k.q;h.width=d;h.height=e;h.attr("width",d);h.attr("height",e);h.css({width:px(d),height:px(e)});var n=h[0].getContext("2d");n.rect(0,0,d,e);n.fillStyle="white";n.fill();n.drawImage(q,0,0,d,e);d=multiStageRescale(h[0],b,p);g.width=b;g.height=p;g.resizedImage=d.toDataURL("image/jpeg",k);f(g.resizedImage.length)&&(g.resizedImage=a);c(g)};q.src=a},f=function(a){if("imageDefinition"==a.type){WorkQueue.pause();var b=Date.now(),d=sprintf("%s%s%s",
UserSettings.getUsername(),b,_.uniqueId()),c=Conversations.getCurrentSlideJid(),d=sprintf("/uploadDataUri?jid=%s&filename=%s",c.toString(),encodeURI(d));$.ajax({url:d,type:"POST",success:function(d){d=$(d).find("resourceUrl").text().trim();var f={type:"image",author:UserSettings.getUsername(),timestamp:b,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+d+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:d,slide:c.toString(),source:d,bounds:[a.x,
a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,x:a.x,y:a.y,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),audiences:_.map(Conversations.getCurrentGroup(),"id").concat(ContentFilter.getAudiences()).map(audienceToStanza)};registerTracker(d,function(){var a=Modes.select.handlesAtZoom(),b=f.x,d=f.y,e=Math.max(f.width,viewboxWidth),c=Math.max(f.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,d-a,e+2*a,c+2*a);Modes.select.clearSelection();Modes.select.selected.images[f.identity]=
boardContent.images[f.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(f);q();WorkQueue.gracefullyResume();zoomToFit()},error:function(a){console.log(a);q();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:a.resizedImage,cache:!1,contentType:!1,processData:!1})}},t=!1;$(function(){t||(t=!0,h=$("#imageInsertOptions").css({position:"absolute",
left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),g=$("#imageFileChoice").attr("accept","image/*"),g[0].addEventListener("change",function(a){try{var d=(a.target.files||a.dataTransfer.files)[0];0==d.type.indexOf("image")&&(b.fileUpload=d);n(f)}catch(c){console.log("imageFileChoiceHandleChanged exception:",c)}},!1),q())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.image;c("#insertTools","#imageMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$("#insertMode").addClass("activeTool").removeClass("inactiveTool");$(".toolbar.active").removeClass("active");$("#imageMode").addClass("active");$("#insertTools .insetColumn").hide();$("#imageTools").show();var a=screenToWorld(10,10);b={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");m.reapplyVisualStyle();h.show()},handleDroppedSrc:function(a,b,c){var g=screenToWorld(b,c);d(a,{type:"imageDefinition",screenX:b,screenY:c,x:g.x,y:g.y},f,function(a){return!1})},
handleDrop:function(a,b,d){var c=0,g=[];console.log("handling drop:",a,b,d);var h=function(a,h){try{if(void 0!=a&&null!=a&&"type"in a&&0==a.type.indexOf("image")&&!_.some(g,function(b){return b==a})){var l=screenToWorld(b,d+c),e={type:"imageDefinition",screenX:b,screenY:d+c,x:l.x,y:l.y};e.fileUpload=a;g.push(a);n(f,e);c+=50}}catch(k){console.log("could not processFile:",a,h)}};_.forEach(a.files,function(a){h(a,"file")});_.forEach(a.items,function(a){try{var b=a.getAsFile(0);h(b,"item")}catch(d){console.log("could not get item as file:",
d)}})},deactivate:function(){q();a()}}}(),pan:{name:"pan",activate:function(){Modes.currentMode.deactivate();c("#panTools","#panMode");Modes.currentMode=Modes.pan;var a,h;registerPositionHandlers(board,function(c,q,m){takeControlOfViewbox(!0);a=c;h=q},function(c,q,m){Pan.translate(-1*(c-a),-1*(q-h));a=c;h=q},function(a,b,c){})},deactivate:function(){a();unregisterPositionHandlers(board)}},select:function(){var b=!1,h=function(){Modes.select.selected={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}};
Progress.call("onSelectionChanged",[Modes.select.selected])},g=_.debounce(function(){var a=!1;_.forEach("images texts inks highlighters multiWordTexts videos".split(" "),function(b){var c="highlighters"==b?"inks":b;if(Modes&&Modes.select&&Modes.select.selected&&c in Modes.select.selected){var g=Modes.select.selected[c];_.forEach(g,function(h){g&&b in boardContent&&h&&h.identity in boardContent[b]?g[h.identity]=boardContent[b][h.identity]:(a=!0,"inks"==c?"highlighters"==b&&h.identity in g&&1==g[h.identity].isHighlighter?
delete g[h.identity]:"inks"==b&&h.identity in g&&0==g[h.identity].isHighlighter&&delete g[h.identity]:delete g[h.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),q=function(){if(void 0!=Modes.select.selected&&b&&"Blacklist"in window){var a=Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),a.inks,a.texts,a.multiWordTexts,a.images,a.videos)}h()},m=function(){(b=Conversations.shouldModifyConversation()?
!b:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");h();blit()},n=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),$("#ban").removeClass("disabledButton"),$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());b?$("#administerContent").addClass("activeBrush"):
$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=g;Progress.onViewboxChanged.ModesSelect=g;Progress.onSelectionChanged.ModesSelect=function(a){a&&(Modes.select.selected=a,"images"in a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||"multiWordTexts"in a&&0<_.size(a.multiWordTexts)||"videos"in a&&0<_.size(a.videos)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),b?($("#ban").removeClass("disabledButton"),
$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=h;Progress.conversationDetailsReceived.ModesSelect=function(a){b&&
!Conversations.shouldModifyConversation(a)&&(b=!1);Conversations.shouldModifyConversation(a)?($("#administerContent").show().unbind("click").bind("click",m),$("#ban").unbind("click").show().bind("click",q)):($("#administerContent").hide().unbind("click"),$("#ban").hide().unbind("click"));n(a)};return{name:"select",isAdministeringContent:function(){return b},updateAdministerContentVisualState:n,selected:{images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=
_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,b);_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,
b);_.forEach(Modes.select.selected.videos,b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:h,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;c("#selectTools","#selectMode");var a={x:0,y:0},f=$("<div/>",{id:"selectMarquee"}),g=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&
!b){var a=batchTransform();a.isDeleted=!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&(a.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));"videos"in Modes.select.selected&&(a.videoIds=_.keys(Modes.select.selected.videos));sendStanza(a);_.forEach(_.union(Modes.select.selected.inks,
Modes.select.selected.texts,Modes.select.selected.images,Modes.select.selected.multiWordTexts,Modes.select.selected.videos),function(a){Progress.call("onCanvasContentDeleted",[a])});h()}});var l=function(a){a("images");a("texts");a("multiWordTexts");a("inks");a("videos")};Modes.select.dragging=!1;n();Modes.select.resizing=!1;registerPositionHandlers(board,function(b,c,h,l,q){Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:b,y:c};Modes.select.marqueeWorldOrigin=l;if(!q.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){b=
3/scale();var n=[l.x-b,l.y-b,l.x+b,l.y+b];Modes.select.dragging=_.some(["images","texts","inks","multiWordTexts","videos"],function(a){return _.some(Modes.select.selected[a],function(a){return a?intersectRect(a.bounds,n):!1})})}Modes.select.dragging?(Modes.select.offset=l,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(g.empty(),g.append(f),f.show(),updateMarquee(f,a,a))},function(b,c,g,h,l){b={x:b,y:c};Modes.select.offset=h;Modes.select.dragging?blit():Modes.select.resizing?
blit():updateMarquee(f,a,b)},function(a,c,d,g,h){function q(a,b){var c=null;0<_.size(a)&&(c=_.reverse(_.sortBy(a,"timestamp"))[0]);return c}function n(a){return a&&null!==a&&"undefined"!==a}WorkQueue.gracefullyResume();try{var m=g.x-Modes.select.marqueeWorldOrigin.x,e=g.y-Modes.select.marqueeWorldOrigin.y;15>Math.abs(m)+Math.abs(e)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=
!0});Modes.text.mapSelected(function(a){a.doc.position.x+=m;a.doc.position.y+=e;a.doc.invalidateBounds()});var k=batchTransform();k.xTranslate=m;k.yTranslate=e;k.inkIds=_.keys(Modes.select.selected.inks);k.textIds=_.keys(Modes.select.selected.texts);k.imageIds=_.keys(Modes.select.selected.images);k.videoIds=_.keys(Modes.select.selected.videos);k.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(k.identity,function(){Progress.call("onSelectionChanged");
blit()});sendStanza(k)}else{var r=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,g,2),B=[r.left,r.top,r.right,r.bottom],z={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},A={},t={};l(function(a){$.each(boardContent[a],function(c,d){if(!("bounds"in d)&&"type"in d)switch(d.type){case "text":prerenderText(d);break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;case "video":prerenderVideo(d);break;case "multiWordText":prerenderMultiwordText(d);break;default:d.bounds=
[NaN,NaN,NaN,NaN]}1<=overlapRect(B,d.bounds)&&(incrementKey(A,d.author),incrementKey(t,"any"),b?d.author!=UserSettings.getUsername()&&(z[a][d.identity]=d):d.author==UserSettings.getUsername()&&(z[a][d.identity]=d))})});$.each(boardContent.highlighters,function(a,d){intersectRect(d.bounds,B)&&(incrementKey(A,d.author),b?d.author!=UserSettings.getUsername()&&(z.inks[d.identity]=d):d.author==UserSettings.getUsername()&&(z.inks[d.identity]=d))});l(function(a){$.each(z[a],function(b,d){a in Modes.select.selected||
(Modes.select.selected[a]=[]);a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=d})});t.any||Modes.select.clearSelection();if(2>=r.width&&2>=r.height){var L=_.filter(z.inks,function(a){return!a.isHighlighter}),E=q(L,"ink");if(n(E))Modes.select.clearSelection(),Modes.select.selected.inks[E.id]=E;else{var F=q(z.multiWordTexts,"multiWordText");if(n(F))Modes.select.clearSelection(),Modes.select.selected.multiWordTexts[F.id]=F;else{var G=
q(z.texts,"text");if(n(G))Modes.select.clearSelection(),Modes.select.selected.texts[G.id]=G;else{var N=_.filter(z.inks,function(a){return a.isHighlighter}),H=q(N,"highlighter");if(n(H))Modes.select.clearSelection(),Modes.select.selected.inks[H.id]=H;else{var I=q(z.videos,"video");if(n(I))Modes.select.clearSelection(),Modes.select.selected.videos[I.id]=I;else{var J=q(z.images,"image");n(J)&&(Modes.select.clearSelection(),Modes.select.selected.images[J.id]=J)}}}}}}Progress.call("onSelectionChanged",
[Modes.select.selected])}f.css({width:0,height:0}).hide();blit()}catch(M){console.log("Selection up ex",M)}})},deactivate:function(){unregisterPositionHandlers(board);a();h();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();n();blit();blit()}}}(),zoom:{name:"zoom",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;c("#zoomTools","#zoomMode");var a=$("<div />",{id:"zoomMarquee"}),h,g={x:0,y:0};Progress.onBoardContentChanged.autoZooming?
takeControlOfViewbox(!1):takeControlOfViewbox(!0);registerPositionHandlers(board,function(c,m,n,d){takeControlOfViewbox(!0);h=d;a.show();a.appendTo($("#selectionAdorner"));g={x:c,y:m};updateMarquee(a,g,g)},function(c,h,n,d){c={x:c,y:h};h=rectFromTwoPoints(c,g);n="left";d="top";c.x==h.left&&(n="right");c.y==h.top&&(d="bottom");c=aspectConstrainedRect(h,n,d);updateMarquee(a,{x:c.right,y:c.bottom},{x:c.left,y:c.top})},function(c,g,n,d){WorkQueue.gracefullyResume();a.hide();c={x:contentOffsetX+d.x,y:contentOffsetY+
d.y};g=rectFromTwoPoints(c,{x:contentOffsetX+h.x,y:contentOffsetY+h.y});2500>scale()*g.width*g.height||(n="left",d="top",c.x==g.left&&(n="right"),c.y==g.top&&(d="bottom"),c=aspectConstrainedRect(g,n,d),IncludeView.specific(c.left,c.top,c.width,c.height))})},deactivate:function(){a();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},feedback:function(){var b=function(){Conversations.shouldModifyConversation()?$("#participantsButton").unbind("click").on("click",function(){Participants.openMenu()}).show():
$("#participantsButton").unbind("click").hide();switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){b()};Progress.conversationDetailsReceived.respectNewPermissions=b;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;b();c("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(a,
b,c,h){},function(a,b,c,h){},function(a,b,c,h){});b()},deactivate:function(){a();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),draw:function(){var b=Brushes.getDefaultBrushes(),h=_.map(b,function(a){return _.clone(a)}),g,m=!1,A=void 0,n=void 0,d=function(a){h[a.index]=a},f=function(){},t=function(){},l=function(){};$(function(){var a,c;$(".activeBrush").removeClass("activeBrush");var x=function(){var a=$("#drawTools");_.each(a.find(".modeSpecificTool.pen"),function(a,b){var c=
h[b],f=$(a).css({color:c.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");g=c;d(c);Modes.draw.drawingAttributes=g;m=!1;u(c)}).removeClass("fa-tint").removeClass("fa-circle").addClass(c.isHighlighter?"fa-circle":"fa-tint");f.find(".widthIndicator").text(c.width);c==g&&f.addClass("activeBrush")})},u=function(a){var b=$("#colors .dots"),c=$("#sizes .dots"),f=Colors.getAllNamedColors(),h=Brushes.getAllBrushSizes();c.empty();h.map(function(b){var e=
A.clone();c.append(e);e.click(function(){a.width=b;d(a);g=a;x();u(a)});var f=Canvas.circle(a.color,b,50);b==a.width&&e.addClass("activeTool");e.prepend(f);f=b.toString()+"px";e.find(".sizeDotName").append(f)});b.empty();f.map(function(c){var f=n.clone();b.append(f);f.on("click",function(){a.color=c.rgb;g=a;d(a);x();u(a)});f.css("color",c.rgb);"rgb"in c&&c.rgb==a.color&&f.addClass("activeTool");var h=c.name;f.find(".colorDotName").append(h)});f=$("#setPenToHighlighter").unbind("click").on("click",
function(){a.isHighlighter=!0;g=a;d(a);x();u(a)});h=$("#setPenToPen").unbind("click").on("click",function(){a.isHighlighter=!1;g=a;d(a);x();u(a)});"isHighlighter"in g&&g.isHighlighter?(f.addClass("activeTool").addClass("active"),h.removeClass("activeTool").removeClass("active")):(h.addClass("activeTool").addClass("active"),f.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var a=_.find(b,function(a){return a.id==g.id});void 0!=
a&&(g.width=a.width,g.color=a.color,g.isHighlighter=a.isHighlighter,x(),u(g))});A=$("#penSize .sizeDot").clone();n=$("#penColor .colorDot").clone();g=h[0];x();u(g);var y=$("#drawTools");y.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");m=!0;$("#drawDropdowns").hide()});y.find(".advancedTools").unbind("click").on("click",function(){m||(u(g),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",
function(){$("#drawDropdowns").hide()});var v=[];t=function(b,d,f,g,h){w=[];m||h.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,boardContext.fillStyle=Modes.draw.drawingAttributes.color,boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,v=[g.x,g.y,256*f],a=b,c=d,boardContext.beginPath(),boardContext.arc(b,d,Modes.draw.drawingAttributes.width*f/2,0,2*Math.PI),boardContext.fill())};var w=[];c=a=void 0;l=function(b,d,f,g,h){b=Math.round(b);d=Math.round(d);
if(m||h.eraser){var l=[g.x-10,g.y-10,g.x+10,g.y+10];f=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,l)){delete a[c.identity];w.push(c);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";f(boardContent.inks);f(boardContent.highlighters);boardContext.globalAlpha=1}else h=Modes.draw.drawingAttributes.width*f,boardContext.beginPath(),
boardContext.lineCap="round",boardContext.lineWidth=h,_.takeRight(v,3),boardContext.moveTo(a,c),boardContext.lineTo(b,d),boardContext.stroke(),v=v.concat([g.x,g.y,256*f]);a=b;c=d};f=function(b,d,f,g,h){m||h.eraser?(b=batchTransform(),b.isDeleted=!0,b.inkIds=_.map(w,function(a){return a.identity}),_.forEach(w,function(a){Progress.call("onCanvasContentDeleted",[a])}),sendStanza(b)):(h=Modes.draw.drawingAttributes.width*f,boardContext.lineWidth=h,boardContext.beginPath(),boardContext.lineWidth=h,boardContext.lineCap=
"round",boardContext.moveTo(a,c),boardContext.lineTo(b,d),boardContext.stroke(),v=v.concat([g.x,g.y,256*f]),strokeCollected(v));boardContext.globalAlpha=1}});return{name:"draw",brushes:h,mousePressure:256,activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,Modes.draw.drawingAttributes=g,c("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),m?$("#drawTools").find(".eraser").addClass("activeBrush"):
_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==g.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,t,l,f))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();a();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,
function(a,c,g,h){},function(a,c,g,h){},function(a,c,g,h){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
