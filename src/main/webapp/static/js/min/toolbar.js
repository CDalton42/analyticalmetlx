function devLogAdd(b){$("#devLog").append($("<div />",{text:b}))}function devLogSet(b){$("#devLog").html($("<div />",{text:b}))}var incrementKey=function(b,d){d in b?b[d]++:b[d]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(b){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(d,g){b.unbind(g)});WorkQueue.gracefullyResume()}
function progress(){var b=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),d=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(b),g=$("<progress />");g.append(b);var k=1,a=0,q=function(){d.css("width",sprintf("%s%%",Math.floor(a/k*100)));g.attr({value:a,max:k})},f={element:g,value:function(b){a=b;q();return f},max:function(a){k=a;q();return f}};return f}
function proportion(b,d){return b/d/(boardWidth/boardHeight)}function scaleScreenToWorld(b){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b*d}function scaleWorldToScreen(b){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b/d}function screenToWorld(b,d){var g=scaleScreenToWorld(b)+viewboxX,k=scaleScreenToWorld(d)+viewboxY;return{x:g,y:k}}
function worldToScreen(b,d){var g=scaleWorldToScreen(b-viewboxX),k=scaleWorldToScreen(d-viewboxY);return{x:g,y:k}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(b){return!1}}
function registerPositionHandlers(b,d,g,k){var a=!1,q=function(a,b){var f=[a.x-10,a.y-10,a.x+10,a.y+10],c=!0;_.each(Modes.canvasInteractables,function(l,r){_.each(l,function(l){void 0!=l&&b in l&&(l.activated||intersectRect(f,l.getBounds()))&&(c=c&&l[b](a))})});return c},f=function(a,b){return{shift:a.shiftKey,ctrl:a.ctrlKey,alt:a.altKey,eraser:b}};$.each(b,function(b,u){var m=$(u);m.css({"touch-action":"none"});var c=!1,l={},r=function(e){var h=e.originalEvent.pointerId,a="pen"==e.originalEvent.pointerType&&
5==e.originalEvent.button,b=m.offset(),r=e.pageX-b.left,b=e.pageY-b.top,f=e.originalEvent.pressure||.5,d=screenToWorld(r,b),n=l[h]||{pointerId:h,pointerType:e.originalEvent.pointerType,eraser:a,points:[]};n.points.push({x:d.x,y:d.y,screenX:r,screenY:b,z:f});n.eraser=n.eraser||a;l[h]=n;1<_.size(l)&&(0==c&&_.each(l,function(e){e.points=[_.last(e.points)]}),c=!0);return{pointerType:e.pointerType,eraser:n.eraser,x:r,y:b,z:f,worldPos:d}},v=function(e){var h=e.originalEvent.pointerId,b="pen"==e.originalEvent.pointerType&&
5==e.originalEvent.button,r=m.offset(),f=e.pageX-r.left,r=e.pageY-r.top,d=e.originalEvent.pressure||.5,n=screenToWorld(f,r);delete l[h];c&&0==_.size(l)&&(a=c=!1);return{pointerType:e.pointerType,eraser:b,x:f,y:r,z:d,worldPos:n}};if(detectPointerEvents()){var n=_.throttle(function(){if(1<_.size(l)){takeControlOfViewbox();var e=_.map(_.filter(l,function(e){return 0<_.size(e.points)}),function(e){var h=_.first(e.points);e=_.last(e.points);return[h,e]});l={};var h=_.meanBy(e,function(e){return e[0].x-
e[1].x}),c=_.meanBy(e,function(e){return e[0].y-e[1].y});Pan.translate(scaleWorldToScreen(h),scaleWorldToScreen(c));var h=_.min(_.map(e,function(e){return e[0].y})),a=_.max(_.map(e,function(e){return e[0].y})),c=_.min(_.map(e,function(e){return e[0].x})),b=_.max(_.map(e,function(e){return e[0].x})),h=a-h,c=b-c,b=_.min(_.map(e,function(e){return e[1].y})),a=_.max(_.map(e,function(e){return e[1].y})),r=_.min(_.map(e,function(e){return e[1].x})),e=(_.max(_.map(e,function(e){return e[1].x}))-r+(a-b))/
2;Zoom.scale((c+h)/2/e)}},25);m.bind("pointerdown",function(e){var h=r(e);e.preventDefault();WorkQueue.pause();1!=_.size(l)||c||(a=!0,q(h.worldPos,"down")&&d(h.x,h.y,h.z,h.worldPos,f(e,h.eraser)))});m.bind("pointermove",function(e){var h=r(e);e.preventDefault();(e.originalEvent.pointerType==e.POINTER_TYPE_TOUCH||"touch"==e.originalEvent.pointerType&&1<_.size(l))&&n();1!=_.size(l)||c||q(h.worldPos,"move")&&a&&g(h.x,h.y,h.z,h.worldPos,f(e,h.eraser))});m.bind("pointerup",function(e){var h=v(e);WorkQueue.gracefullyResume();
e.preventDefault();q(h.worldPos,"up")&&a&&!c&&k(h.x,h.y,h.z,h.worldPos,f(e,h.eraser));a=!1;Modes.finishInteractableStates()});var z=function(e){v(e);WorkQueue.gracefullyResume();e.preventDefault();if(a){var h=e.offsetX;e=e.offsetY;l={};WorkQueue.gracefullyResume();e=screenToWorld(h,e);h=e.x;e=e.y;h<viewboxX?(takeControlOfViewbox(),Extend.left()):h>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):e<viewboxY?(takeControlOfViewbox(),Extend.up()):e>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),
Extend.down());a=!1;Modes.finishInteractableStates()}a=!1;Modes.finishInteractableStates()};m.bind("pointerout",z);m.bind("pointerleave",z);m.bind("pointercancel",z)}else{m.bind("mousedown",function(e){WorkQueue.pause();var h=m.offset();a=!0;var c=e.pageX-h.left,h=e.pageY-h.top,l=screenToWorld(c,h);q(l,"down")&&d(c,h,.5,l,f(e));e.preventDefault()});m.bind("mousemove",function(e){var h=m.offset();e.preventDefault();var c=e.pageX-h.left,h=e.pageY-h.top,l=screenToWorld(c,h);q(l,"move")&&a&&g(c,h,.5,
l,f(e))});m.bind("mouseup",function(e){WorkQueue.gracefullyResume();e.preventDefault();var h=m.offset(),c=e.pageX-h.left,h=e.pageY-h.top,l=screenToWorld(c,h);q(l,"up")&&a&&k(c,h,.5,l,f(e));a=!1;Modes.finishInteractableStates()});var y=function(e,h){WorkQueue.gracefullyResume();var c=screenToWorld(e,h),l=c.x,c=c.y;l<viewboxX?(takeControlOfViewbox(),Extend.left()):l>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):c<viewboxY?(takeControlOfViewbox(),Extend.up()):c>=viewboxY+viewboxHeight&&
(takeControlOfViewbox(),Extend.down());a=!1};m.bind("mouseout",function(e){WorkQueue.gracefullyResume();e.preventDefault();a&&y(e.offsetX,e.offsetY);a=!1;Modes.finishInteractableStates()});var t,x=function(e){return{x:average(_.map(e,"x")),y:average(_.map(e,"y"))}},w=function(e){var h=[],c=m.offset();$.each(e,function(e,a){h.push({x:a.pageX-c.left,y:a.pageY-c.top,identifier:a.identifier})});return h};m.bind("touchstart",function(e){WorkQueue.pause();e.preventDefault();var h=w(e.originalEvent.touches);
if(1==h.length){var h=h[0],c=screenToWorld(h.x,h.y);a=!0;q(c,"down")&&d(h.x,h.y,.5,c,f(e))}else t=x(h)});m.bind("touchmove",function(e){e.preventDefault();var c=w(e.originalEvent.touches);switch(c.length){case 0:break;case 1:var c=c[0],l=screenToWorld(c.x,c.y);q(l,"move")&&a&&g(c.x,c.y,.5,l,f(e));break;default:e=x(c),c=e.x-t.x,l=e.y-t.y,t=e,takeControlOfViewbox(),Pan.translate(-1*c,-1*l)}});m.bind("touchend",function(e){WorkQueue.gracefullyResume();e.preventDefault();var c=m.offset(),l=e.originalEvent.changedTouches[0],
b=l.pageX-c.left,c=l.pageY-c.top,l=screenToWorld(b,c);q(l,"up")&&a&&(0>b||0>c||b>boardWidth||c>boardHeight?y(b,c):k(b,c,.5,l,f(e)));a=!1;Modes.finishInteractableStates()});var A=1;m.bind("gesturechange",function(e){WorkQueue.pause();e.preventDefault();a=!1;e=e.originalEvent.scale;takeControlOfViewbox();Zoom.scale(A/e);A=e});m.bind("gestureend",function(){WorkQueue.gracefullyResume();A=1})}});return function(b){a=b}}
function aspectConstrainedDimensions(b,d){var g=boardHeight/boardWidth,k={height:d,width:b};d/b>g?k.height=b*g:k.width=d/g;return k}
function aspectConstrainedRect(b,d,g){var k=boardHeight/boardWidth,a={left:b.left,top:b.top,right:b.right,bottom:b.bottom,width:b.width,height:b.height};b.height/b.width>k?(a.height=b.width*k,g&&(d=b.height-a.height,"center"==g?a.top+=d/2:"bottom"==g&&(a.top+=d))):(a.width=b.height/k,d&&(g=b.width-a.width,"center"==d?a.left+=g/2:"right"==d&&(a.left+=g)));a.right=a.left+a.width;a.bottom=a.top+a.height;return a}
function copyBuffer(b){var d=document.createElement("canvas");d.width=b.width;d.height=b.height;d.getContext("2d").drawImage(b,0,0,b.width,b.height,0,0,b.width,b.height);return d}function intersectRect(b,d){return"undefined"!=typeof b&&"undefined"!=typeof d?!(d[0]>b[2]||d[2]<b[0]||d[1]>b[3]||d[3]<b[1]):!1}function overlapRect(b,d){return intersectRect(b,d)?(Math.max(b[0],d[0])-Math.min(b[2],d[2]))*(Math.max(b[1],d[1])-Math.min(b[3],d[3])):0}
function rectFromTwoPoints(b,d,g){g=g||0;var k,a,q;b.x<d.x?(k=b.x,q=d.x):(k=d.x,q=b.x);b.y<d.y?(a=b.y,b=d.y):(a=d.y,b=b.y);d=q-k;var f=b-a;d<g&&(q+=g-d,d=q-k);f<g&&(b+=g-f,f=b-a);return{left:k,top:a,right:q,bottom:b,width:d,height:f}}function updateMarquee(b,d,g){d=rectFromTwoPoints(d,g);g=$("#selectionAdorner");jQuery.contains(g,b)||g.append(b);b.is(":visible")||b.show();b.css({left:px(d.left),top:px(d.top),width:px(d.width),height:px(d.height)})}
function clampToView(b){var d=b.x,g=b.y;0>b.x&&(d=0);b.x>boardWidth&&(d=boardWidth);0>b.y&&(g=0);b.y>boardHeight&&(g=boardHeight);return{x:d,y:g}}
var bounceButton=function(b){var d=$(b);d.addClass("activeBrush");setTimeout(function(){d.removeClass("activeBrush")},200)},videoControlInteractable=function(b){var d=void 0;return{activated:!1,rehome:function(b){},down:function(b){return!1},move:function(b){return!1},up:function(d){var k=Modes.select.handlesAtZoom();d=d.x-b.x;if(d<k)b.getState().paused?b.play():b.pause();else if(d>b.width-k)b.muted(!b.muted());else{var a=b.getState();b.seek((d-k)/(b.width-2*k)*a.duration)}return!1},getBounds:function(){return d},
deactivate:function(){},render:function(g){if(b.identity in boardContent.videos){var k=Modes.select.handlesAtZoom();d=[b.bounds[0],b.bounds[3],b.bounds[2],b.bounds[3]+k];var k=worldToScreen(d[0],d[1]),a=worldToScreen(d[2],d[3]),q=a.x-k.x,f=a.y-k.y,p=b.getState();g.globalAlpha=1;g.setLineDash([]);g.strokeStyle="black";g.font=sprintf("%spx FontAwesome",f);g.fillStyle="white";g.fillRect(k.x,k.y,f,f);g.fillStyle="black";p.paused?g.fillText("\uf04b",k.x,a.y):g.fillText("\uf04c",k.x,a.y);var u=k.x+f,m=
q-f;g.fillStyle="black";g.fillRect(u,k.y,m,f);g.fillStyle="blue";m*=p.currentTime/p.duration;g.fillRect(u,k.y,m,f);q=k.x+(q-f);g.fillStyle="white";g.fillRect(q,k.y,f,f);g.fillStyle="black";p.muted?g.fillText("\uf0f3",q,a.y):g.fillText("\uf1f6",q,a.y)}}}},Modes=function(){var b=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},d=function(a,d){b();$(a).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$(d).addClass("activeTool").removeClass("inactiveTool")},g={name:"none",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.none;b()},deactivate:function(){b();unregisterPositionHandlers(board)}},k=function(a,b){a in Modes.canvasInteractables||(Modes.canvasInteractables[a]=[]);Modes.canvasInteractables[a].push(b)};$(function(){var a={opacity:1};(new TWEEN.Tween(a)).delay(1E3).to({opacity:.3},1E3);var b=Modes.select.handlesAtZoom(),d=function(){var m=void 0;return{getBounds:function(){return m},
activated:!1,originalHeight:1,originalWidth:1,rehome:function(c){if(!d.activated){var a=Modes.select.handlesAtZoom(),b=c.x+a/2;m=[b-a/2,c.y-a,b+a/2,c.y]}},down:function(c){d.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=c;Modes.select.marqueeWorldOrigin=c;blit()},move:function(c){d.activated&&(d.bounds=[c.x-b,c.y,c.x+b,c.y],Modes.select.offset=c,blit());return!1},deactivate:function(){d.activated=!1;Modes.select.dragging=!1},up:function(c){d.deactivate();var a=
batchTransform(),b=c.x-Modes.select.marqueeWorldOrigin.x,m=c.y-Modes.select.marqueeWorldOrigin.y;a.xTranslate=b;a.yTranslate=m;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);a.videoIds=_.keys(Modes.select.selected.videos);a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(a.multiWordTextIds,function(c){Modes.text.echoesToDisregard[c]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(c){c.doc.position.x+=
b;c.doc.position.y+=m;c.doc.invalidateBounds()});sendStanza(a);registerTracker(a.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(c){if(m){var b=worldToScreen(m[0],m[1]),d=worldToScreen(m[2],m[3]).x-b.x,f=b.x,b=b.y;c.globalAlpha=a.opacity;c.setLineDash([]);c.strokeStyle="black";c.fillStyle="white";c.strokeWidth=2;c.fillRect(f,b,d,d);c.strokeRect(f,b,d,d);c.font=sprintf("%spx FontAwesome",d);c.fillStyle="black";c.fillText("\uf047",f,b+d-4)}}}}(),p=function(){var d=
void 0;return{getBounds:function(){return d},activated:!1,originalHeight:1,originalWidth:1,rehome:function(c){if(!p.activated){var a=Modes.select.handlesAtZoom(),b=c.x2;c=c.y;d=[b,c,b+a,c+a]}},down:function(c){Modes.select.aspectLocked=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;p.activated=!0;c=Modes.select.totalSelectedBounds();Modes.select.offset={x:c.x2,y:c.y2};p.rehome(c);blit();return!1},move:function(c){if(p.activated){d=[c.x-b,d[1],c.x+b,d[3]];var a=Modes.select.totalSelectedBounds();
Modes.select.offset={x:c.x,y:a.y+(c.x-a.x)/(a.x2-a.x)*a.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;p.activated=!1;Modes.select.resizing=!1},up:function(c){p.deactivate();var a=batchTransform(),b=Modes.select.totalSelectedBounds();a.xScale=(c.x-b.x)/(b.x2-b.x);a.yScale=a.xScale;a.xOrigin=b.x;a.yOrigin=b.y;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);a.videoIds=_.keys(Modes.select.selected.videos);
a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(c,b){Modes.text.echoesToDisregard[b]=!0;var d=c.doc.documentRange();c.doc.select(d.start,d.end);Modes.text.scaleEditor(c.doc,a.xScale);c.doc.select(0,0);c.doc.width(c.doc.width()*a.xScale);c.doc.invalidateBounds()});registerTracker(a.identity,function(){Progress.call("onSelectionChanged")});sendStanza(a);return!1},render:function(c){if(d){var b=worldToScreen(d[0],d[1]),f=worldToScreen(d[2],
d[3]).x-b.x,q=f/10,n=-1*f;c.globalAlpha=a.opacity;c.setLineDash([]);c.strokeStyle="black";c.fillStyle="white";c.strokeWidth=2;c.translate(b.x,b.y);c.rotate(90*Math.PI/180);c.fillRect(0,n,f,f);c.strokeRect(0,n,f,f);c.font=sprintf("%spx FontAwesome",f);c.fillStyle="black";c.fillText("\uf0b2",q,-1*q)}}}}(),g=function(){var d=void 0;return{activated:!1,getBounds:function(){return d},rehome:function(c){if(!g.activated){var a=Modes.select.handlesAtZoom(),b=c.x2;c=c.y2;d=[b,c-a,b+a,c]}},down:function(c){g.activated=
!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;c=Modes.select.totalSelectedBounds();Modes.select.offset={x:c.x2,y:c.y2};blit();console.log("Free transform down");return!1},move:function(c){g.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),g.bounds=[c.x-b,c.y-b,c.x+b,c.y+b],Modes.select.offset={x:c.x,y:c.y},blit());return!1},deactivate:function(){g.activated=!1;Modes.select.resizing=!1},up:function(c){g.deactivate();var a=batchTransform(),b=Modes.select.totalSelectedBounds(),
d=b.y2-b.y,f=c.y-b.y;a.xScale=(c.x-b.x)/(b.x2-b.x);a.yScale=f/d;a.xOrigin=b.x;a.yOrigin=b.y;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);a.videoIds=_.keys(Modes.select.selected.videos);_.each(Modes.select.selected.multiWordTexts,function(c){c.doc.width(Math.max(c.doc.width()*a.xScale,Modes.text.minimumWidth/scale()));c.doc.invalidateBounds();0<c.doc.save().length&&sendRichText(c)});registerTracker(a.identity,
function(){Progress.call("onSelectionChanged");blit()});console.log("Free transform up");sendStanza(a);blit();return!1},render:function(c){if(d){var b=worldToScreen(d[0],d[1]),f=worldToScreen(d[2],d[3]).x-b.x,q=f/10,n=-1*f;c.globalAlpha=a.opacity;c.setLineDash([]);c.strokeStyle="black";c.fillStyle="white";c.strokeWidth=2;c.translate(b.x,b.y);c.rotate(90*Math.PI/180);c.fillRect(0,n,f,f);c.strokeRect(0,n,f,f);c.font=sprintf("%spx FontAwesome",f);c.fillStyle="black";c.fillText("\uf065",q,-1*q)}}}}();
k("manualMove",d);k("resizeFree",g);k("resizeAspectLocked",p);Progress.textBoundsChanged.selectionHandles=function(a,c){if(a in Modes.select.selected.multiWordTexts){var b=Modes.select.totalSelectedBounds();d.rehome(b);g.rehome(b);p.rehome(b)}};Progress.onSelectionChanged.selectionHandles=function(){var b=Modes.select.totalSelectedBounds();Infinity==b.x?a.opacity=0:(a.opacity=1,d.rehome(b),g.rehome(b),p.rehome(b))}});return{pushCanvasInteractable:k,clearCanvasInteractables:function(a){Modes.canvasInteractables[a]=
[]},getCanvasInteractables:function(){return _.mapValues(Modes.canvasInteractables,function(a){return _.map(a,function(a){a=_.clone(a);a.bounds=a.getBounds();return a})})},currentMode:g,none:g,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),function(a){_.forEach(Modes.canvasInteractables[a],function(a){void 0!=a&&"deactivate"in a&&a.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var a=
function(){},g,f,p,k,m,c,l,r,v,n,z,y=function(e,c){var a=Modes.text.minimumWidth/scale(),a=Modes.text.editorFor({bounds:[e.x,e.y,e.x,e.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),slide:Conversations.getCurrentSlideJid(),target:"presentationSpace",requestedWidth:a,width:a,height:0,x:e.x,y:e.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});a.doc.load(c);return a},t=function(e){return function(){var c=!1;_.each(boardContent.multiWordTexts,
function(a){if(a.doc.isActive){c=!0;var b=a.doc.selectedRange();carota.runs.nextInsertFormatting={};b.setFormatting(e,!0!==b.getFormatting()[e]);0<a.doc.save().length&&sendRichText(a)}});if(!c){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var a=carota.runs.nextInsertFormatting[e]=!carota.runs.nextInsertFormatting[e];$(sprintf(".font%sSelector",_.capitalize(e))).toggleClass("active",a)}}},x=function(e,c){return function(){var a=!1;c=c||$(this).val();_.each(boardContent.multiWordTexts,
function(b){b.doc.isActive&&(a=!0,carota.runs.nextInsertFormatting={},b.doc.selectedRange().setFormatting(e,c),0<b.doc.save().length&&sendRichText(b))});a||(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[e]=c)}},w=function(c,a){var b=c.selectedRange(),d=0,f=[],l=carota.runs.defaultFormatting.size;c.runs(function(a){a=_.size(a.text);a=d+a;c.select(d,a,!0);var b=c.selectedRange().getFormatting().size||l;_.each(_.range(d,a),function(){f.push(b)});
d=a;l=b},c.range(0,b.end));f=f.reverse();d=b.start;c.runs(function(b){b=d+b.text.length;c.select(d,b,!0);c.selectedRange().setFormatting("size",f[d]*a);d=b},c.range(b.start,b.end));c.select(b.start,b.end,!0)},A=function(c){return function(){_.each(boardContent.multiWordTexts,function(a){a=a.doc;a.isActive&&w(a,c)})}};$(function(){k=$(".fontBoldSelector");m=$(".fontItalicSelector");c=$(".fontUnderlineSelector");v=$("#textDropdowns");r=$("#fontOptions");g=$("#fontFamilySelector");f=$("#fontSizeSelector");
p=$("#fontColorSelector");n=$("#fontLarger");z=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");l=$("#presetFullscreen");$("#presetCenterOnScreen");var a=g.find(".fontFamilyOption").clone(),b=f.find(".fontSizeOption").clone(),d=p.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(c){g.append(a.clone().attr("value",c).text(c))});Fonts.getAllSizes().map(function(c){f.append(b.clone().attr("value",c).text(c))});
Colors.getAllNamedColors().map(function(c){p.append(d.clone().attr("value",c.rgb).text(c.name))});n.on("click",A(1.2));z.click(A(.8));k.click(t("bold"));m.click(t("italic"));c.click(t("underline"));var w={red:"#ff0000",blue:"#0000ff",black:"#000000",yellow:"#ffff00"};_.each(["red","blue","black","yellow"],function(c){$(sprintf("#%sText",c)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");x("color",[w[c],255])()})});l.click(function(c){return function(){_.each(boardContent.multiWordTexts,
function(a){if(a.doc.isActive){switch(c){case "runToEdge":var e=screenToWorld(boardWidth,0);a.doc.width(e.x+viewboxX-a.x);break;case "fitToText":a.doc.width(a.doc.frame.actualWidth());break;case "widen":a.doc.width(1.6*a.doc.frame.actualWidth());break;case "narrow":a.doc.width(.6*a.doc.frame.actualWidth());break;case "centerOnScreen":a.doc.width(screenToWorld(boardWidth,0).x);a.doc.selectedRange().setFormatting("align","center");a.doc.position.x=viewboxX;break;case "fullscreen":a.doc.position.x=viewboxX,
a.doc.position.y=viewboxY,a.doc.width(screenToWorld(boardWidth,0).x)}a.doc.contentChanged.fire()}})}}("fullscreen"));r.click(function(){v.toggle()});$("#closeTextDialog").click(function(){v.hide()});$("#exitTextEditing").click(function(){Modes.select.activate()})});return{name:"text",echoesToDisregard:{},minimumWidth:240,minimumHeight:function(){return 3*Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},
getSelectedRanges:function(){return _.map(boardContent.multiWordTexts,function(a){var c=a.doc.selectedRange();return{identity:a.identity,start:c.start,end:c.end,text:c.plainText()}})},getLinesets:function(){return _.map(boardContent.multiWordTexts,function(a){console.log("Textbox",a.identity,a.doc.width());a.doc.layout();return _.map(a.doc.frame.lines,function(a){return a.positionedWords.length})})},mapSelected:function(a){var c=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,
function(b){b.identity in c&&a(b)})},scaleEditor:w,scrollToCursor:function(a){var c=a.bounds,b=a.doc.selectedRange().start;a=a.doc.getCaretCoords(b);var b=Math.floor(a.t/a.h),d=Math.floor(scaleScreenToWorld(boardContext.height)/a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var b=Math.min(b,Math.max(0,d-2))*a.h,d=Math.max(c[2]-c[0],scaleWorldToScreen(10*a.h)),f=d/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(c[0],c[1]-b+a.t,d,f)}else c=Math.max(0,
Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(c[1]-viewboxY))/a.h)-4))*a.h,0!=c&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+c,viewboxWidth,viewboxHeight)},editorFor:function(b){var d=boardContent.multiWordTexts[b.identity];d||(d=boardContent.multiWordTexts[b.identity]=b);if(!d.doc){var f=b.author==UserSettings.getUsername();d.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",b.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],f?blit:a,b);f&&(f=_.debounce(function(){Modes.text.scrollToCursor(d);
var a=boardContent.multiWordTexts[d.identity];a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);incorporateBoardBounds(d.bounds)},1E3),d.doc.contentChanged(f),d.doc.selectionChanged(function(a,b){if(0<d.doc.save().length){var e=a();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var f=[$("#blackText"),$("#redText"),$("#blueText"),$("#yellowText")],l=function(a,c){var b=1==e[c];b&&(carota.runs.nextInsertFormatting[c]=b);a.toggleClass("active",
b)},n=function(a,c,b){var d=_.isEqual(e[c],b);c in e&&d&&(carota.runs.nextInsertFormatting[c]=b);a.toggleClass("active",d)};l(k,"bold");l(m,"italic");l(c,"underline");n(f[0],"color",["#000000",255]);n(f[1],"color",["#ff0000",255]);n(f[2],"color",["#0000ff",255]);n(f[3],"color",["#ffff00",255]);b&&Modes.text.scrollToCursor(d)}}))}d.doc.position={x:b.x,y:b.y};d.doc.width(b.width);return d},draw:function(a){a&&a.doc&&carota.editor.paint(board[0],a.doc,!0)},editorAt:function(a,c,b,d){var f=UserSettings.getUsername(),
l=[d.x-10,d.y-10,d.x+10,d.y+10];a=_.values(boardContent.multiWordTexts).filter(function(a){return intersectRect(a.bounds,l)&&a.author==f});return 0<a.length?a[0]:!1},contextFor:function(a,c){var b={x:c.x-a.position.x,y:c.y-a.position.y};return{node:a.byCoordinate(b.x,b.y),relativePos:b}},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;d("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var a=0;registerPositionHandlers(board,
function(a,c,b,e){if(a=Modes.text.editorAt(a,c,b,e).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,e).node)},function(a,c,b,e){(a=Modes.text.editorAt(a,c,b,e).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,e).node)},function(c,b,d,f){var l=Date.now(),n=Modes.text.editorAt(c,b,d,f);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=a.doc.identity==n.identity;0==a.doc.documentRange().plainText().trim().length&&(delete boardContent.multiWordTexts[a.identity],
blit())});Modes.select.clearSelection();n?(c=n.doc,f=Modes.text.contextFor(c,f),500>=l-a?c.dblclickHandler(f.node):c.mouseupHandler(f.node),a=l,f={multiWordTexts:{}},f.multiWordTexts[n.identity]=n,Modes.select.setSelection(f)):(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},c=y(f,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||
carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.size/scale()}]),l=c.doc,l.select(0,1),boardContent.multiWordTexts[c.identity]=c,f={multiWordTexts:{}},f.multiWordTexts[c.identity]=boardContent.multiWordTexts[c.identity],Modes.select.setSelection(f),n=c,f=l.byOrdinal(0),l.mousedownHandler(f),l.mouseupHandler(f));n.doc.invalidateBounds();n.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(n);Progress.call("onSelectionChanged",
[Modes.select.selected])})},deactivate:function(){DeviceConfiguration.setKeyboard(!1);b();v.hide();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=!1;0==a.doc.documentRange().plainText().trim().length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();blit()}}}(),video:function(){var a={},g=void 0,f=void 0,p=function(){g.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=f.wrap("<form>").closest("form").get(0);
void 0!=a&&a.reset();f.unwrap()},k=function(c){if(void 0!=a&&void 0!=a.fileUpload&&void 0!=c){$("#videoWorking").show();$("#videoFileChoice").hide();var b=new FileReader;b.onload=function(b){var d=$("<video/>"),f=d[0],g=b.target.result;f.addEventListener("loadeddata",function(b){b=f.videoHeight;a.width=f.videoWidth;a.height=b;a.video=d;a.videoSrc=g;c()},!1);d.append($("<source />",{src:g,type:"video/mp4"}));d.load()};b.readAsDataURL(a.fileUpload)}},m=function(){if("imageDefinition"==a.type){WorkQueue.pause();
var c=Date.now(),b=sprintf("%s%s",UserSettings.getUsername(),c),d=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),encodeURI(b));$.ajax({url:b,type:"POST",success:function(b){var f=$(b).find("resourceUrl").text(),g={type:"video",author:UserSettings.getUsername(),timestamp:c,identity:f,slide:d.toString(),source:$(b).text(),bounds:[a.x,a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),
x:a.x,y:a.y};registerTracker(f,function(){var a=Modes.select.handlesAtZoom(),c=g.x,b=g.y,d=Math.max(g.width,viewboxWidth),e=Math.max(g.height,viewboxHeight);Modes.select.activate();IncludeView.specific(c-a,b-a,d+2*a,e+2*a);Modes.select.clearSelection();Modes.select.selected.videos[g.identity]=boardContent.videos[g.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(g);p();WorkQueue.gracefullyResume()},error:function(a){console.log(a);resetImageUpload();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:a.videoSrc,cache:!1,contentType:!1,processData:!1})}},c=!1;$(function(){c||(c=!0,g=$("#videoInsertOptions").css({position:"absolute",left:0,top:0}),$("#videoInsertOptionsClose").click(Modes.select.activate),f=$("#videoFileChoice").attr("accept","video/mp4"),f[0].addEventListener("change",function(c){c=(c.target.files||c.dataTransfer.files)[0];0==c.type.indexOf("video")&&(a.fileUpload=c);k(m)},!1),p())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=
Modes.video;d("#videoTools","#videoMode");var c=screenToWorld(10,10);a={type:"imageDefinition",screenX:10,screenY:10,x:c.x,y:c.y};Progress.call("onLayoutUpdated");g.show()},deactivate:function(){p();b()}}}(),image:function(){var a={},g=void 0,f=void 0,p=function(){g.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=f.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();f.unwrap()},k=function(){var a=function(a,c,b,d){for(var e=c*b;e>a;)c*=.8,b*=.8,e=c*b;return{w:c,h:b,q:d}},
c={"native":{resizeFunc:function(a,c){return{w:a,h:c,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(c,b){return a(1*d,c,b,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(c,b){return a(3*d,c,b,.8)},selector:"#imageInsertHighDef"}},b=c.optimized,d=1048576,f=function(){_.forEach(c,function(a){var c=$(a.selector);b.selector==a.selector?c.addClass("activeBrush"):c.removeClass("activeBrush")})};$(function(){_.forEach(c,function(a){$(a.selector).on("click",function(){b=
a;f()})});f()});return{reapplyVisualStyle:f,changeMode:function(a){a in c&&(b=c[a],f())},getResizeFunction:function(){return b.resizeFunc}}}(),m=function(c){if(void 0!=a&&void 0!=a.fileUpload&&void 0!=c){$("#imageWorking").show();$("#imageFileChoice").hide();var b=new FileReader;b.onload=function(b){var d=$("<canvas/>"),f=new Image,g=b.target.result,l=g.length;f.onload=function(b){var n=f.width,e=f.height,h=k.getResizeFunction()(n,e);b=h.w;var p=h.h,h=h.q;d.width=n;d.height=e;d.attr("width",n);d.attr("height",
e);d.css({width:px(n),height:px(e)});d[0].getContext("2d").drawImage(f,0,0,n,e);n=multiStageRescale(d[0],b,p);a.width=b;a.height=p;a.resizedImage=n.toDataURL("image/jpeg",h);l<a.resizedImage.length&&(a.resizedImage=g);c()};f.src=g};b.readAsDataURL(a.fileUpload)}},c=function(){if("imageDefinition"==a.type){WorkQueue.pause();var c=Date.now(),b=sprintf("%s%s",UserSettings.getUsername(),c),d=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),encodeURI(b));$.ajax({url:b,
type:"POST",success:function(b){var f=$(b).find("resourceUrl").text(),g={type:"image",author:UserSettings.getUsername(),timestamp:c,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+f+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:f,slide:d.toString(),source:$(b).text(),bounds:[a.x,a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:a.x,y:a.y};registerTracker(f,
function(){var a=Modes.select.handlesAtZoom(),c=g.x,b=g.y,d=Math.max(g.width,viewboxWidth),f=Math.max(g.height,viewboxHeight);Modes.select.activate();IncludeView.specific(c-a,b-a,d+2*a,f+2*a);Modes.select.clearSelection();Modes.select.selected.images[g.identity]=boardContent.images[g.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(g);p();WorkQueue.gracefullyResume()},error:function(a){console.log(a);p();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:a.resizedImage,cache:!1,contentType:!1,processData:!1})}},l=!1;$(function(){l||(l=!0,g=$("#imageInsertOptions").css({position:"absolute",left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),f=$("#imageFileChoice").attr("accept","image/*"),f[0].addEventListener("change",function(b){b=(b.target.files||b.dataTransfer.files)[0];0==b.type.indexOf("image")&&(a.fileUpload=b);m(c)},!1),p())});return{activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.image;d("#imageTools","#imageMode");var c=screenToWorld(10,10);a={type:"imageDefinition",screenX:10,screenY:10,x:c.x,y:c.y};Progress.call("onLayoutUpdated");k.reapplyVisualStyle();g.show()},deactivate:function(){p();b()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");Modes.currentMode.deactivate();d("#panTools","#panMode");Modes.currentMode=Modes.pan;var a,b;registerPositionHandlers(board,function(d,g,k){takeControlOfViewbox();a=d;b=g},function(d,g,k){Pan.translate(-1*
(d-a),-1*(g-b));a=d;b=g},function(a,b,d){})},deactivate:function(){b();unregisterPositionHandlers(board)}},select:function(){var a=!1,g=function(){Modes.select.selected={images:{},text:{},inks:{},multiWordTexts:{},videos:{}};Progress.call("onSelectionChanged",[Modes.select.selected])},f=_.debounce(function(){var a=!1;_.forEach("images texts inks highlighters multiWordTexts videos".split(" "),function(b){var d="highlighters"==b?"inks":b;if(Modes&&Modes.select&&Modes.select.selected&&d in Modes.select.selected){var f=
Modes.select.selected[d];_.forEach(f,function(g){f&&b in boardContent&&g&&g.identity in boardContent[b]?f[g.identity]=boardContent[b][g.identity]:(a=!0,"inks"==d?"highlighters"==b&&g.identity in f&&1==f[g.identity].isHighlighter?delete f[g.identity]:"inks"==b&&g.identity in f&&0==f[g.identity].isHighlighter&&delete f[g.identity]:delete f[g.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),p=function(){if(void 0!=Modes.select.selected&&a&&"Blacklist"in window){var c=
Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),c.inks,c.texts,c.multiWordTexts,c.images,c.videos)}g()},k=function(){(a=Conversations.shouldModifyConversation()?!a:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");g()},m=function(c){Conversations.shouldModifyConversation(c)?($("#ban").show(),$("#ban").removeClass("disabledButton"),$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):
($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());a?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=f;Progress.onViewboxChanged.ModesSelect=f;Progress.onSelectionChanged.ModesSelect=function(c){c&&(Modes.select.selected=c,"images"in c&&0<_.size(c.images)||"inks"in c&&0<_.size(c.inks)||"texts"in c&&0<_.size(c.texts)||
"multiWordTexts"in c&&0<_.size(c.multiWordTexts)||"videos"in c&&0<_.size(c.videos)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),a?($("#ban").removeClass("disabledButton"),$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?
$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=g;Progress.conversationDetailsReceived.ModesSelect=function(c){a&&!Conversations.shouldModifyConversation(c)&&(a=!1);Conversations.shouldModifyConversation(c)?($("#administerContent").unbind("click").bind("click",k),$("#ban").unbind("click").bind("click",p)):($("#administerContent").unbind("click"),$("#ban").unbind("click"));m(c)};return{name:"select",selected:{images:{},
texts:{},inks:{},multiWordTexts:{},videos:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,
b);_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,b);_.forEach(Modes.select.selected.videos,b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:g,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;d("#selectTools","#selectMode");var b=
{x:0,y:0},f=$("<div/>",{id:"selectMarquee"}),p=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&!a){var b=batchTransform();b.isDeleted=!0;"inks"in Modes.select.selected&&(b.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&(b.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(b.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));
"videos"in Modes.select.selected&&(b.videoIds=_.keys(Modes.select.selected.videos));sendStanza(b);g()}});var k=function(a){a("images");a("texts");a("multiWordTexts");a("inks");a("videos")};Modes.select.dragging=!1;m();Modes.select.resizing=!1;registerPositionHandlers(board,function(a,d,g,k,m){Modes.select.resizing=!1;Modes.select.dragging=!1;b={x:a,y:d};Modes.select.marqueeWorldOrigin=k;if(!m.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){g=3/scale();var w=[k.x-g,k.y-g,k.x+g,k.y+g];Modes.select.dragging=
_.some(["images","texts","inks","multiWordTexts","videos"],function(a){return _.some(Modes.select.selected[a],function(a){return a?intersectRect(a.bounds,w):!1})})}console.log(a,d,k,Modes.select.dragging);Modes.select.dragging?(Modes.select.offset=k,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(p.empty(),p.append(f),f.show(),updateMarquee(f,b,b))},function(a,d,g,k,p){a={x:a,y:d};Modes.select.offset=k;Modes.select.dragging?blit():Modes.select.resizing?blit():
updateMarquee(f,b,a)},function(b,c,d,g,p){WorkQueue.gracefullyResume();try{var m=g.x-Modes.select.marqueeWorldOrigin.x,q=g.y-Modes.select.marqueeWorldOrigin.y;15>Math.abs(m)+Math.abs(q)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=m;a.doc.position.y+=q;a.doc.invalidateBounds()});var e=batchTransform();e.xTranslate=
m;e.yTranslate=q;e.inkIds=_.keys(Modes.select.selected.inks);e.textIds=_.keys(Modes.select.selected.texts);e.imageIds=_.keys(Modes.select.selected.images);e.videoIds=_.keys(Modes.select.selected.videos);e.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(e.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(e)}else{var h=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,g,2),u=[h.left,h.top,h.right,h.bottom],r={images:{},
texts:{},inks:{},multiWordTexts:{},videos:{}},B={},C={};k(function(b){$.each(boardContent[b],function(c,d){if(!("bounds"in d)&&"type"in d)switch(d.type){case "text":prerenderText(d);break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;case "video":prerenderVideo(d);break;default:d.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(u,d.bounds)&&(incrementKey(B,d.author),incrementKey(C,"any"),a?d.author!=UserSettings.getUsername()&&(r[b][d.identity]=d):d.author==UserSettings.getUsername()&&
(r[b][d.identity]=d))})});$.each(boardContent.highlighters,function(b,c){intersectRect(c.bounds,u)&&(incrementKey(B,c.author),a?c.author!=UserSettings.getUsername()&&(r.inks[c.identity]=c):c.author==UserSettings.getUsername()&&(r.inks[c.identity]=c))});k(function(a){$.each(r[a],function(b,c){a in Modes.select.selected||(Modes.select.selected[a]=[]);a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=c})});C.any||Modes.select.clearSelection();
var D=sprintf("Selected %s images, %s texts, %s inks, %s rich texts, %s videos ",_.keys(Modes.select.selected.images).length,_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,_.keys(Modes.select.selected.inks).length,_.keys(Modes.select.selected.videos).length);$.each(B,function(a,b){D+=sprintf("%s:%s ",a,b)});Progress.call("onSelectionChanged",[Modes.select.selected])}f.css({width:0,height:0}).hide();blit()}catch(E){console.log("Selection up",E)}})},deactivate:function(){unregisterPositionHandlers(board);
b();g();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();m();blit();blit()}}}(),zoom:{name:"zoom",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;d("#zoomTools","#zoomMode");var a=$("<div />",{id:"zoomMarquee"}),b,f={x:0,y:0};registerPositionHandlers(board,function(d,g,k,c){takeControlOfViewbox();b=c;a.show();a.appendTo($("#selectionAdorner"));f={x:d,y:g};updateMarquee(a,f,f)},function(b,d,g,c){b={x:b,
y:d};d=rectFromTwoPoints(b,f);g="left";c="top";b.x==d.left&&(g="right");b.y==d.top&&(c="bottom");b=aspectConstrainedRect(d,g,c);updateMarquee(a,{x:b.right,y:b.bottom},{x:b.left,y:b.top})},function(d,f,g,c){WorkQueue.gracefullyResume();a.hide();d={x:contentOffsetX+c.x,y:contentOffsetY+c.y};f=rectFromTwoPoints(d,{x:contentOffsetX+b.x,y:contentOffsetY+b.y});2500>scale()*f.width*f.height||(g="left",c="top",d.x==f.left&&(g="right"),d.y==f.top&&(c="bottom"),d=aspectConstrainedRect(f,g,c),IncludeView.specific(d.left,
d.top,d.width,d.height))})},deactivate:function(){b();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},feedback:function(){var a=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){a()};Progress.conversationDetailsReceived.respectNewPermissions=a;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=
Modes.feedback;a();d("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(a,b,d,g){},function(a,b,d,g){},function(a,b,d,g){});a()},deactivate:function(){b();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),draw:function(){var a=Brushes.getDefaultBrushes(),g=_.map(a,function(a){return _.clone(a)}),f,k=!1,u=void 0,m=void 0,c=function(a){g[a.index]=a},l=function(){},r=function(){},v=function(){};$(function(){$(".activeBrush").removeClass("activeBrush");var b=
function(){var a=$("#drawTools");_.each(a.find(".modeSpecificTool.pen"),function(a,b){var h=g[b],l=$(a).css({color:h.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");f=h;c(h);Modes.draw.drawingAttributes=f;k=!1;d(h)}).removeClass("fa-tint").removeClass("fa-circle").addClass(h.isHighlighter?"fa-circle":"fa-tint");l.find(".widthIndicator").text(h.width);h==f&&l.addClass("activeBrush")})},d=function(a){var g=$("#colors .dots"),e=$("#sizes .dots"),
h=Colors.getAllNamedColors(),k=Brushes.getAllBrushSizes();e.empty();k.map(function(g){var h=u.clone();e.append(h);h.click(function(){a.width=g;c(a);f=a;b();d(a)});var k=Canvas.circle(a.color,g,50);g==a.width&&h.addClass("activeTool");h.prepend(k);k=g.toString()+"px";h.find(".sizeDotName").append(k)});g.empty();h.map(function(e){var h=m.clone();g.append(h);h.on("click",function(){a.color=e.rgb;f=a;c(a);b();d(a)});h.css("color",e.rgb);"rgb"in e&&e.rgb==a.color&&h.addClass("activeTool");var k=e.name;
h.find(".colorDotName").append(k)});h=$("#setPenToHighlighter").unbind("click").on("click",function(){a.isHighlighter=!0;f=a;c(a);b();d(a)});k=$("#setPenToPen").unbind("click").on("click",function(){a.isHighlighter=!1;f=a;c(a);b();d(a)});"isHighlighter"in f&&f.isHighlighter?(h.addClass("activeTool").addClass("active"),k.removeClass("activeTool").removeClass("active")):(k.addClass("activeTool").addClass("active"),h.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};
$("#resetPenButton").click(function(){var c=_.find(a,function(a){return a.id==f.id});void 0!=c&&(f.width=c.width,f.color=c.color,f.isHighlighter=c.isHighlighter,b(),d(f))});u=$("#penSize .sizeDot").clone();m=$("#penColor .colorDot").clone();f=g[0];b();d(f);var y=$("#drawTools");y.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");k=!0;$("#drawDropdowns").hide()});y.find(".advancedTools").unbind("click").on("click",function(){k||
(d(f),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});var t=[];r=function(a,b,c,d,f){x=[];k||f.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,t=[a,b,256*c])};var x=[];v=function(a,b,c,d,f){if(k||f.eraser){var g=[d.x-10,d.y-10,d.x+10,d.y+10];a=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,
g)){delete a[c.identity];x.push(c.identity);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";a(boardContent.inks);a(boardContent.highlighters);boardContext.globalAlpha=1}else d=Modes.draw.drawingAttributes.width*c,boardContext.beginPath(),boardContext.lineCap="round",boardContext.lineWidth=d,d=_.takeRight(t,3),boardContext.moveTo(d[0],d[1]),boardContext.lineTo(a,b),boardContext.stroke(),
t=t.concat([a,b,256*c])};l=function(a,b,c,d,f){k||f.eraser?(a=batchTransform(),a.isDeleted=!0,a.inkIds=x,sendStanza(a)):(d=Modes.draw.drawingAttributes.width*c,boardContext.lineWidth=d,boardContext.beginPath(),boardContext.lineWidth=d,boardContext.lineCap="round",d=_.takeRight(t,3),boardContext.moveTo(d[0],d[1]),boardContext.lineTo(a,b),boardContext.stroke(),t=t.concat([a,b,256*c]),strokeCollected(t));boardContext.globalAlpha=1}});return{name:"draw",brushes:g,activate:function(){boardContext.setLineDash([]);
Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,Modes.draw.drawingAttributes=f,d("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),k?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==f.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,r,v,l))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();b();
WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,function(a,b,d,g){},function(a,b,d,g){},function(a,b,d,g){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
