function devLogAdd(b){$("#devLog").append($("<div />",{text:b}))}function devLogSet(b){$("#devLog").html($("<div />",{text:b}))}var incrementKey=function(b,d){d in b?b[d]++:b[d]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(b){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(d,f){b.unbind(f)});WorkQueue.gracefullyResume()}
function progress(){var b=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),d=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(b),f=$("<progress />");f.append(b);var m=1,a=0,r=function(){d.css("width",sprintf("%s%%",Math.floor(a/m*100)));f.attr({value:a,max:m})},h={element:f,value:function(b){a=b;r();return h},max:function(a){m=a;r();return h}};return h}
function proportion(b,d){return b/d/(boardWidth/boardHeight)}function scaleScreenToWorld(b){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b*d}function scaleWorldToScreen(b){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b/d}function screenToWorld(b,d){var f=scaleScreenToWorld(b)+viewboxX,m=scaleScreenToWorld(d)+viewboxY;return{x:f,y:m}}
function worldToScreen(b,d){var f=scaleWorldToScreen(b-viewboxX),m=scaleWorldToScreen(d-viewboxY);return{x:f,y:m}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(b){return!1}}
function registerPositionHandlers(b,d,f,m){var a=!1,r=function(a,b){var d=[a.x-10,a.y-10,a.x+10,a.y+10],e=!0;_.each(Modes.canvasInteractables,function(c,v){_.each(c,function(c){void 0!=c&&b in c&&(c.activated||intersectRect(d,c.getBounds()))&&(e=e&&c[b](a))})});return e},h=function(a,b){return{shift:a.shiftKey,ctrl:a.ctrlKey,alt:a.altKey,eraser:b}};$.each(b,function(b,y){var n=$(y);n.css({"touch-action":"none"});var e=!1,c={},v=function(g){return void 0!==g&&"touch"==g.originalEvent.pointerType?1<
_.size(c):!1},u=function(g){var z=g.originalEvent.pointerId,k="pen"==g.originalEvent.pointerType&&5==g.originalEvent.button,a=n.offset(),l=g.pageX-a.left,a=g.pageY-a.top,b=g.originalEvent.pressure||.5,p=screenToWorld(l,a),w=c[z]||{pointerId:z,pointerType:g.originalEvent.pointerType,eraser:k,points:[]};w.points.push({x:p.x,y:p.y,screenX:l,screenY:a,z:b});w.eraser=w.eraser||k;"touch"==g.originalEvent.pointerType&&(c[z]=w);v(g)&&(0==e&&_.each(c,function(g){g.points=[_.last(g.points)]}),e=!0);return{pointerType:g.pointerType,
eraser:w.eraser,x:l,y:a,z:b,worldPos:p}},t=function(g){var z=g.originalEvent.pointerId,k="pen"==g.originalEvent.pointerType&&5==g.originalEvent.button,l=n.offset(),p=g.pageX-l.left,l=g.pageY-l.top,b=g.originalEvent.pressure||.5,w=screenToWorld(p,l);"touch"==g.originalEvent.pointerType&&delete c[z];e&&0==_.size(c)&&(a=e=!1);return{pointerType:g.pointerType,eraser:k,x:p,y:l,z:b,worldPos:w}};if(detectPointerEvents()){var B=_.throttle(function(){takeControlOfViewbox();var g=_.map(_.filter(c,function(g){return 0<
_.size(g.points)}),function(g){var k=_.first(g.points);g=_.last(g.points);return[k,g]});c={};var z=_.meanBy(g,function(g){return g[0].x-g[1].x}),k=_.meanBy(g,function(g){return g[0].y-g[1].y});Pan.translate(scaleWorldToScreen(z),scaleWorldToScreen(k));var z=_.min(_.map(g,function(g){return g[0].y})),a=_.max(_.map(g,function(g){return g[0].y})),k=_.min(_.map(g,function(g){return g[0].x})),l=_.max(_.map(g,function(g){return g[0].x})),z=a-z,k=l-k,l=_.min(_.map(g,function(g){return g[1].y})),a=_.max(_.map(g,
function(g){return g[1].y})),e=_.min(_.map(g,function(g){return g[1].x})),g=(_.max(_.map(g,function(g){return g[1].x}))-e+(a-l))/2;Zoom.scale((k+z)/2/g)},25);n.bind("pointerdown",function(g){g.originalEvent.pointerType!=g.POINTER_TYPE_TOUCH&&"touch"!=g.originalEvent.pointerType||!v(g)||(e=!0);var k=u(g);g.preventDefault();WorkQueue.pause();v(g)||e||(a=!0,r(k.worldPos,"down")&&d(k.x,k.y,k.z,k.worldPos,h(g,k.eraser)))});n.bind("pointermove",function(g){var k=u(g);g.preventDefault();g.originalEvent.pointerType!=
g.POINTER_TYPE_TOUCH&&"touch"!=g.originalEvent.pointerType||!v(g)&&!e?r(k.worldPos,"move")&&a&&f(k.x,k.y,k.z,k.worldPos,h(g,k.eraser)):B()});n.bind("pointerup",function(g){var k=t(g);WorkQueue.gracefullyResume();g.preventDefault();r(k.worldPos,"up")&&a&&!e&&m(k.x,k.y,k.z,k.worldPos,h(g,k.eraser));a=!1;Modes.finishInteractableStates()});var x=function(g){t(g);WorkQueue.gracefullyResume();g.preventDefault();if(a){var k=g.offsetX,l=g.offsetY,p=t(g);c={};WorkQueue.gracefullyResume();k=screenToWorld(k,
l);l=k.x;l<viewboxX?(takeControlOfViewbox(),Extend.left()):l>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):r(k,"up")&&a&&!e&&m(p.x,p.y,p.z,p.worldPos,h(g,p.eraser));a=!1;Modes.finishInteractableStates()}a=!1;Modes.finishInteractableStates()};n.bind("pointerout",x);n.bind("pointerleave",x);n.bind("pointercancel",x)}else{n.bind("mousedown",function(g){WorkQueue.pause();var k=n.offset();a=!0;var c=g.pageX-k.left,k=g.pageY-k.top,l=screenToWorld(c,k);r(l,"down")&&d(c,k,.5,l,h(g));g.preventDefault()});
n.bind("mousemove",function(g){var k=n.offset();g.preventDefault();var c=g.pageX-k.left,k=g.pageY-k.top,l=screenToWorld(c,k);r(l,"move")&&a&&f(c,k,.5,l,h(g))});n.bind("mouseup",function(k){WorkQueue.gracefullyResume();k.preventDefault();var c=n.offset(),l=k.pageX-c.left,c=k.pageY-c.top,p=screenToWorld(l,c);r(p,"up")&&a&&m(l,c,.5,p,h(k));a=!1;Modes.finishInteractableStates()});var k=function(k,c,l){WorkQueue.gracefullyResume();var p=screenToWorld(k,c),b=p.x;b<viewboxX?(takeControlOfViewbox(),Extend.left()):
b>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):r(p,"up")&&a&&!e&&m(k,c,.5,p,h(l,!1));a=!1};n.bind("mouseout",function(g){WorkQueue.gracefullyResume();g.preventDefault();a&&k(g.offsetX,g.offsetY,g);a=!1;Modes.finishInteractableStates()});var w,p=function(k){return{x:average(_.map(k,"x")),y:average(_.map(k,"y"))}},A=function(k){var c=[],l=n.offset();$.each(k,function(k,g){c.push({x:g.pageX-l.left,y:g.pageY-l.top,identifier:g.identifier})});return c};n.bind("touchstart",function(k){WorkQueue.pause();
k.preventDefault();var c=A(k.originalEvent.touches);if(1==c.length){var c=c[0],l=screenToWorld(c.x,c.y);a=!0;r(l,"down")&&d(c.x,c.y,.5,l,h(k))}else w=p(c)});n.bind("touchmove",function(k){k.preventDefault();var c=A(k.originalEvent.touches);switch(c.length){case 0:break;case 1:var c=c[0],l=screenToWorld(c.x,c.y);r(l,"move")&&a&&f(c.x,c.y,.5,l,h(k));break;default:k=p(c),c=k.x-w.x,l=k.y-w.y,w=k,takeControlOfViewbox(),Pan.translate(-1*c,-1*l)}});n.bind("touchend",function(c){WorkQueue.gracefullyResume();
c.preventDefault();var l=n.offset(),p=c.originalEvent.changedTouches[0],e=p.pageX-l.left,l=p.pageY-l.top,p=screenToWorld(e,l);r(p,"up")&&a&&(0>e||0>l||e>boardWidth||l>boardHeight?k(e,l):m(e,l,.5,p,h(c)));a=!1;Modes.finishInteractableStates()});var l=1;n.bind("gesturechange",function(k){WorkQueue.pause();k.preventDefault();a=!1;k=k.originalEvent.scale;takeControlOfViewbox();Zoom.scale(l/k);l=k});n.bind("gestureend",function(){WorkQueue.gracefullyResume();l=1})}});return function(b){a=b}}
function aspectConstrainedDimensions(b,d){var f=boardHeight/boardWidth,m={height:d,width:b};d/b>f?m.height=b*f:m.width=d/f;return m}
function aspectConstrainedRect(b,d,f){var m=boardHeight/boardWidth,a={left:b.left,top:b.top,right:b.right,bottom:b.bottom,width:b.width,height:b.height};b.height/b.width>m?(a.height=b.width*m,f&&(d=b.height-a.height,"center"==f?a.top+=d/2:"bottom"==f&&(a.top+=d))):(a.width=b.height/m,d&&(f=b.width-a.width,"center"==d?a.left+=f/2:"right"==d&&(a.left+=f)));a.right=a.left+a.width;a.bottom=a.top+a.height;return a}
function copyBuffer(b){var d=document.createElement("canvas");d.width=b.width;d.height=b.height;d.getContext("2d").drawImage(b,0,0,b.width,b.height,0,0,b.width,b.height);return d}function intersectRect(b,d){return"undefined"!=typeof b&&"undefined"!=typeof d?!(d[0]>b[2]||d[2]<b[0]||d[1]>b[3]||d[3]<b[1]):!1}function overlapRect(b,d){return intersectRect(b,d)?(Math.max(b[0],d[0])-Math.min(b[2],d[2]))*(Math.max(b[1],d[1])-Math.min(b[3],d[3])):0}
function rectFromTwoPoints(b,d,f){f=f||0;var m,a,r;b.x<d.x?(m=b.x,r=d.x):(m=d.x,r=b.x);b.y<d.y?(a=b.y,b=d.y):(a=d.y,b=b.y);d=r-m;var h=b-a;d<f&&(r+=f-d,d=r-m);h<f&&(b+=f-h,h=b-a);return{left:m,top:a,right:r,bottom:b,width:d,height:h}}function updateMarquee(b,d,f){d=rectFromTwoPoints(d,f);f=$("#selectionAdorner");jQuery.contains(f,b)||f.append(b);b.is(":visible")||b.show();b.css({left:px(d.left),top:px(d.top),width:px(d.width),height:px(d.height)})}
function clampToView(b){var d=b.x,f=b.y;0>b.x&&(d=0);b.x>boardWidth&&(d=boardWidth);0>b.y&&(f=0);b.y>boardHeight&&(f=boardHeight);return{x:d,y:f}}
var bounceButton=function(b){var d=$(b);d.addClass("activeBrush");setTimeout(function(){d.removeClass("activeBrush")},200)},videoControlInteractable=function(b){var d=void 0;return{activated:!1,rehome:function(b){},down:function(b){return!1},move:function(b){return!1},up:function(d){var m=Modes.select.handlesAtZoom();d=d.x-b.x;if(d<m)b.getState().paused?b.play():b.pause();else if(d>b.width-m)b.muted(!b.muted());else{var a=b.getState();b.seek((d-m)/(b.width-2*m)*a.duration)}return!1},getBounds:function(){return d},
deactivate:function(){},render:function(f){if(b.identity in boardContent.videos){var m=Modes.select.handlesAtZoom();d=[b.bounds[0],b.bounds[3],b.bounds[2],b.bounds[3]+m];var m=worldToScreen(d[0],d[1]),a=worldToScreen(d[2],d[3]),r=a.x-m.x,h=a.y-m.y,q=b.getState();f.globalAlpha=1;f.setLineDash([]);f.strokeStyle="black";f.font=sprintf("%spx FontAwesome",h);f.fillStyle="white";f.fillRect(m.x,m.y,h,h);f.fillStyle="black";q.paused?f.fillText("\uf04b",m.x,a.y):f.fillText("\uf04c",m.x,a.y);var y=m.x+h,n=
r-h;f.fillStyle="black";f.fillRect(y,m.y,n,h);f.fillStyle="blue";n*=q.currentTime/q.duration;f.fillRect(y,m.y,n,h);r=m.x+(r-h);f.fillStyle="white";f.fillRect(r,m.y,h,h);f.fillStyle="black";q.muted?f.fillText("\uf0f3",r,a.y):f.fillText("\uf1f6",r,a.y)}}}},Modes=function(){var b=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},d=function(a,d){b();$(a).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$(d).addClass("activeTool").removeClass("inactiveTool")},f={name:"none",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.none;b()},deactivate:function(){b();unregisterPositionHandlers(board)}},m=function(a,b){a in Modes.canvasInteractables||(Modes.canvasInteractables[a]=[]);Modes.canvasInteractables[a].push(b)};$(function(){var a={opacity:1};(new TWEEN.Tween(a)).delay(1E3).to({opacity:.3},1E3);var b=Modes.select.handlesAtZoom(),d=function(a){var c=Modes.select.handlesAtZoom(),
b=scaleScreenToWorld(DeviceConfiguration.headerHeight)+c,u=scaleScreenToWorld(DeviceConfiguration.footerHeight);return Math.min(viewboxY+viewboxHeight-(u-c/2),Math.max(a,viewboxY+b))},q=function(){var e=void 0;return{getBounds:function(){return e},activated:!1,originalHeight:1,originalWidth:1,rehome:function(c){if(!q.activated){var a=Modes.select.handlesAtZoom(),b=d(c.y);c=c.x+a/2;e=[c-a/2,b-a,c+a/2,b]}},down:function(c){q.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=
c;Modes.select.marqueeWorldOrigin=c;blit()},move:function(c){q.activated&&(q.bounds=[c.x-b,c.y,c.x+b,c.y],Modes.select.offset=c,blit());return!1},deactivate:function(){q.activated=!1;Modes.select.dragging=!1},up:function(c){q.deactivate();var a=batchTransform(),b=c.x-Modes.select.marqueeWorldOrigin.x,e=c.y-Modes.select.marqueeWorldOrigin.y;a.xTranslate=b;a.yTranslate=e;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);
a.videoIds=_.keys(Modes.select.selected.videos);a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(a.multiWordTextIds,function(c){Modes.text.echoesToDisregard[c]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(c){c.doc.position.x+=b;c.doc.position.y+=e;c.doc.invalidateBounds()});sendStanza(a);registerTracker(a.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(c){if(e){var b=worldToScreen(e[0],e[1]),u=worldToScreen(e[2],e[3]).x-
b.x,t=b.x,b=b.y;c.globalAlpha=a.opacity;c.setLineDash([]);c.strokeStyle="black";c.fillStyle="white";c.strokeWidth=2;c.fillRect(t,b,u,u);c.strokeRect(t,b,u,u);c.font=sprintf("%spx FontAwesome",u);c.fillStyle="black";c.fillText("\uf047",t,b+u-4)}}}}(),f=function(){var e=void 0;return{getBounds:function(){return e},activated:!1,originalHeight:1,originalWidth:1,rehome:function(c){if(!f.activated){var a=Modes.select.handlesAtZoom(),b=c.x2;c=d(c.y)-a;e=[b,c,b+a,c+a]}},down:function(c){Modes.select.aspectLocked=
!0;Modes.select.dragging=!1;Modes.select.resizing=!0;f.activated=!0;c=Modes.select.totalSelectedBounds();Modes.select.offset={x:c.x2,y:c.y2};f.rehome(c);blit();return!1},move:_.throttle(function(c){if(f.activated){e=[c.x-b,e[1],c.x+b,e[3]];var a=Modes.select.totalSelectedBounds();Modes.select.offset={x:c.x,y:a.y+(c.x-a.x)/(a.x2-a.x)*a.height};blit()}return!1},20),deactivate:function(){Modes.select.aspectLocked=!1;f.activated=!1;Modes.select.resizing=!1},up:function(c){f.deactivate();var a=batchTransform(),
b=Modes.select.totalSelectedBounds();a.xScale=(c.x-b.x)/(b.x2-b.x);a.yScale=a.xScale;a.xOrigin=b.x;a.yOrigin=b.y;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);a.videoIds=_.keys(Modes.select.selected.videos);a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(c,b){Modes.text.echoesToDisregard[b]=!0;var e=c.doc.documentRange();c.doc.select(e.start,
e.end);Modes.text.scaleEditor(c.doc,a.xScale);e=c.doc.width();c.doc.width(e*a.xScale);c.doc.select(0);c.doc.updateCanvas();blit()});registerTracker(a.identity,function(){Progress.call("onSelectionChanged")});sendStanza(a);return!1},render:function(c){if(e){var b=worldToScreen(e[0],e[1]),d=worldToScreen(e[2],e[3]).x-b.x,t=d/10,h=-1*d;c.globalAlpha=a.opacity;c.setLineDash([]);c.strokeStyle="black";c.fillStyle="white";c.strokeWidth=2;c.translate(b.x,b.y);c.rotate(90*Math.PI/180);c.fillRect(0,h,d,d);
c.strokeRect(0,h,d,d);c.font=sprintf("%spx FontAwesome",d);c.fillStyle="black";c.fillText("\uf0b2",t,-1*t)}}}}(),n=function(){var e=void 0;return{activated:!1,getBounds:function(){return e},rehome:function(c){if(!n.activated){var a=Modes.select.handlesAtZoom(),b=c.x2;c=d(c.y2);e=[b,c-a,b+a,c]}},down:function(c){n.activated=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;c=Modes.select.totalSelectedBounds();Modes.select.offset={x:c.x2,y:c.y2};blit();return!1},move:function(c){n.activated&&
(scaleWorldToScreen(Modes.text.minimumWidth),n.bounds=[c.x-b,c.y-b,c.x+b,c.y+b],Modes.select.offset={x:c.x,y:c.y},blit());return!1},deactivate:function(){n.activated=!1;Modes.select.resizing=!1},up:function(c){n.deactivate();var a=batchTransform(),b=Modes.select.totalSelectedBounds(),e=b.y2-b.y,d=c.y-b.y;a.xScale=(c.x-b.x)/(b.x2-b.x);a.yScale=d/e;a.xOrigin=b.x;a.yOrigin=b.y;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);
a.videoIds=_.keys(Modes.select.selected.videos);var h=scale();_.each(Modes.select.selected.multiWordTexts,function(k){0<k.doc.save().length&&(k.doc.width(Math.max(k.doc.width()*a.xScale,Modes.text.minimumWidth/h)),k.doc.updateCanvas(),sendRichText(k))});blit();registerTracker(a.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(a);return!1},render:function(c){if(e){var b=worldToScreen(e[0],e[1]),d=worldToScreen(e[2],e[3]).x-b.x,t=d/10,h=-1*d;c.globalAlpha=a.opacity;c.setLineDash([]);
c.strokeStyle="black";c.fillStyle="white";c.strokeWidth=2;c.translate(b.x,b.y);c.rotate(90*Math.PI/180);c.fillRect(0,h,d,d);c.strokeRect(0,h,d,d);c.font=sprintf("%spx FontAwesome",d);c.fillStyle="black";c.fillText("\uf065",t,-1*t)}}}}();m("manualMove",q);m("resizeFree",n);m("resizeAspectLocked",f);Progress.textBoundsChanged.selectionHandles=function(a,c){if(a in Modes.select.selected.multiWordTexts){var b=Modes.select.totalSelectedBounds();q.rehome(b);n.rehome(b);f.rehome(b);blit()}};Progress.onSelectionChanged.selectionHandles=
function(){var b=Modes.select.totalSelectedBounds();Infinity==b.x?a.opacity=0:(a.opacity=1,q.rehome(b),n.rehome(b),f.rehome(b),blit())}});return{pushCanvasInteractable:m,clearCanvasInteractables:function(a){Modes.canvasInteractables[a]=[]},getCanvasInteractables:function(){return _.mapValues(Modes.canvasInteractables,function(a){return _.map(a,function(a){a=_.clone(a);a.bounds=a.getBounds();return a})})},currentMode:f,none:f,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),
function(a){_.forEach(Modes.canvasInteractables[a],function(a){void 0!=a&&"deactivate"in a&&a.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var a,f,h,q,m,n,e,c,v=function(k,a){var c=Modes.text.minimumWidth/scale(),c=Modes.text.editorFor({bounds:[k.x,k.y,k.x,k.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),slide:Conversations.getCurrentSlideJid(),target:"presentationSpace",
requestedWidth:c,width:c,height:0,x:k.x,y:k.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});c.doc.load(a);return c},u=function(k){return function(){var a=!1;_.each(boardContent.multiWordTexts,function(c){if(c.doc.isActive){a=!0;var b=c.doc.selectedRange();carota.runs.nextInsertFormatting={};b.setFormatting(k,!0!==b.getFormatting()[k]);c.doc.updateCanvas();0<c.doc.save().length&&sendRichText(c)}});if(!a){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var c=
carota.runs.nextInsertFormatting[k]=!carota.runs.nextInsertFormatting[k];$(sprintf(".font%sSelector",_.capitalize(k))).toggleClass("active",c)}blit()}},t=function(k,a){return function(){var c=!1;a=a||$(this).val();_.each(boardContent.multiWordTexts,function(b){b.doc.isActive&&(c=!0,carota.runs.nextInsertFormatting={},b.doc.selectedRange().setFormatting(k,a),carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[k]=a,b.doc.updateCanvas(),b.doc.claimFocus(),
0<b.doc.save().length&&sendRichText(b))});c||(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[k]=a);blit()}},B=function(a,c){var b=a.selectedRange(),e=0,l=[],g=carota.runs.defaultFormatting.size;a.runs(function(c){c=_.size(c.text);c=e+c;a.select(e,c,!0);var b=a.selectedRange().getFormatting().size||g;_.each(_.range(e,c),function(){l.push(b)});e=c;g=b},a.range(0,b.end));e=b.start;a.runs(function(b){b=e+b.text.length;a.select(e,b,!0);a.selectedRange().setFormatting("size",
l[e]*c);e=b},a.range(b.start,b.end));a.select(b.start,b.end,!0);a.invalidateBounds();return l},x=function(a){return function(){_.each(boardContent.multiWordTexts,function(c){c=c.doc;c.isActive&&(c=B(c,a),carota.runs.defaultFormatting.newBoxSize=1<a?_.max(c):_.min(c))})}};$(function(){q=$(".fontBoldSelector");m=$(".fontItalicSelector");n=$(".fontUnderlineSelector");$("#textDropdowns");$("#fontOptions");a=$("#fontFamilySelector");f=$("#fontSizeSelector");h=$("#fontColorSelector");e=$("#fontLarger");
c=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");$("#presetFullscreen");$("#presetCenterOnScreen");var b=a.find(".fontFamilyOption").clone(),d=f.find(".fontSizeOption").clone(),p=h.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(c){a.append(b.clone().attr("value",c).text(c))});Fonts.getAllSizes().map(function(a){f.append(d.clone().attr("value",a).text(a))});Colors.getAllNamedColors().map(function(a){h.append(p.clone().attr("value",
a.rgb).text(a.name))});e.on("click",x(1.2));c.click(x(.8));q.click(u("bold"));m.click(u("italic"));n.click(u("underline"));var A={red:"#ff0000",blue:"#0000ff",black:"#000000",yellow:"#ffff00",green:"#00ff00"};_.each(["red","blue","black","yellow","green"],function(a){$(sprintf("#%sText",a)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");Modes.text.refocussing=!0;t("color",[A[a],255])()})})});return{name:"text",echoesToDisregard:{},minimumWidth:240,minimumHeight:function(){return 3*
Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},getSelectedRanges:function(){return _.map(boardContent.multiWordTexts,function(a){var c=a.doc.selectedRange();return{identity:a.identity,start:c.start,end:c.end,text:c.plainText()}})},getLinesets:function(){return _.map(boardContent.multiWordTexts,function(a){a.doc.layout();return _.map(a.doc.frame.lines,
function(a){return a.positionedWords.length})})},mapSelected:function(a){var c=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,function(b){b.identity in c&&a(b)})},scaleEditor:B,scrollToCursor:function(a){var c=a.bounds,b=a.doc.selectedRange().start;a=a.doc.getCaretCoords(b);var b=Math.floor(a.t/a.h),e=Math.floor(scaleScreenToWorld(boardContext.height)/a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var b=Math.min(b,Math.max(0,e-2))*a.h,e=Math.max(c[2]-c[0],scaleWorldToScreen(10*
a.h)),l=e/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(c[0],c[1]-b+a.t,e,l)}else c=Math.max(0,Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(c[1]-viewboxY))/a.h)-8))*a.h,0!=c&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+c,viewboxWidth,viewboxHeight)},refocussing:!1,editorFor:function(a){var c=[$("#blackText"),$("#redText"),$("#blueText"),$("#yellowText"),$("#greenText")],b=boardContent.multiWordTexts[a.identity];b||(b=boardContent.multiWordTexts[a.identity]=
a);if(!b.doc){var e=a.author==UserSettings.getUsername();b.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",a.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],a);if(e){var l=_.debounce(function(){var a=boardContent.multiWordTexts[b.identity];a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();a.audiences=ContentFilter.getAudiences();sendRichText(a);incorporateBoardBounds(b.bounds)},1E3);Progress.beforeChangingAudience[a.identity]=function(){l.flush();delete Progress.beforeChangingAudience[a.identity]};
Progress.beforeLeavingSlide[a.identity]=function(){l.flush();delete Progress.beforeLeavingSlide[a.identity]};b.doc.contentChanged(l);b.doc.contentChanged(function(){Modes.text.scrollToCursor(b);blit()});b.doc.selectionChanged(function(a,b){if(Modes.text.refocussing)Modes.text.refocussing=!1;else{var k=a();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var l=function(a,c){var b=1==k[c];b&&(carota.runs.nextInsertFormatting[c]=b);a.toggleClass("active",b)},e=function(a,c,b){var l=
_.isEqual(k[c],b);c in k&&l&&(carota.runs.nextInsertFormatting[c]=b);a.toggleClass("active",l)};l(q,"bold");l(m,"italic");l(n,"underline");e(c[0],"color",["#000000",255]);e(c[1],"color",["#ff0000",255]);e(c[2],"color",["#0000ff",255]);e(c[3],"color",["#ffff00",255]);e(c[4],"color",["#00ff00",255]);blit()}})}}b.doc.position={x:a.x,y:a.y};b.doc.width(a.width);return b},oldEditorAt:function(a,c,b,e){var l=UserSettings.getUsername(),g=[e.x-10,e.y-10,e.x+10,e.y+10];a=_.values(boardContent.texts).filter(function(a){return intersectRect(a.bounds,
g)&&a.author==l});return 0<a.length?a[0]:!1},editorAt:function(a,c,b,e){var l=UserSettings.getUsername(),g=[e.x-10,e.y-10,e.x+10,e.y+10];a=_.values(boardContent.multiWordTexts).filter(function(a){return intersectRect(a.bounds,g)&&a.author==l}).filter(ContentFilter.exposes);return 0<a.length?a[0]:!1},contextFor:function(a,c){var b={x:c.x-a.position.x,y:c.y-a.position.y};return{node:a.byCoordinate(b.x,b.y),relativePos:b}},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;
d("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var a=0;registerPositionHandlers(board,function(a,c,b,l){if(a=Modes.text.editorAt(a,c,b,l).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,l).node)},function(a,c,b,l){(a=Modes.text.editorAt(a,c,b,l).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,l).node)},function(c,b,e,l){var g=Date.now(),d=Modes.text.oldEditorAt(c,b,e,l),t=Modes.text.editorAt(c,b,e,l);_.each(boardContent.multiWordTexts,
function(a){a.doc.isActive=a.doc.identity==t.identity;0==a.doc.documentRange().plainText().trim().length&&(delete boardContent.multiWordTexts[a.identity],blit())});Modes.select.clearSelection();d?(g=batchTransform(),g.isDeleted=!0,"texts"in Modes.select.selected&&(g.textIds=[d.identity]),sendStanza(g),carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},d=v({x:d.x,y:d.y},[{text:d.text,italic:"italic"==d.style,bold:"bold"==d.weight,underline:"underline"==d.decoration,color:d.color,
size:d.size}]),g=d.doc,g.select(0,1),boardContent.multiWordTexts[d.identity]=d,l={multiWordTexts:{}},l.multiWordTexts[d.identity]=boardContent.multiWordTexts[d.identity],Modes.select.setSelection(l),l=t=d,l.privacy=Privacy.getCurrentPrivacy(),l.target="presentationSpace",l.slide=Conversations.getCurrentSlideJid(),sendRichText(l),incorporateBoardBounds(t.bounds),l=g.byOrdinal(0),g.mousedownHandler(l),g.mouseupHandler(l)):t?(d=t.doc,l=Modes.text.contextFor(d,l),500>=g-a?d.dblclickHandler(l.node):d.mouseupHandler(l.node),
a=g,l={multiWordTexts:{}},l.multiWordTexts[t.identity]=t,Modes.select.setSelection(l)):(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},d=v(l,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.newBoxSize/scale()}]),g=d.doc,g.select(0,1),boardContent.multiWordTexts[d.identity]=
d,l={multiWordTexts:{}},l.multiWordTexts[d.identity]=boardContent.multiWordTexts[d.identity],Modes.select.setSelection(l),t=d,l=g.byOrdinal(0),g.mousedownHandler(l),g.mouseupHandler(l));t.doc.invalidateBounds();t.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Progress.call("onSelectionChanged",[Modes.select.selected])})},handleDrop:function(a,c,b){if(0<a.length){a=carota.html.parse(a,{});c=screenToWorld(c,b);Modes.text.activate();Date.now();
Modes.select.clearSelection();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var e=v(c,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.newBoxSize/scale()}]);c=e.doc;c.select(0,1);boardContent.multiWordTexts[e.identity]=e;b={multiWordTexts:{}};b.multiWordTexts[e.identity]=
boardContent.multiWordTexts[e.identity];Modes.select.setSelection(b);editor=e;b=c.byOrdinal(0);c.mousedownHandler(b);c.mouseupHandler(b);editor.doc.invalidateBounds();editor.doc.isActive=!0;editor.doc.load(a);Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(editor);a=boardContent.multiWordTexts[editor.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);
Progress.call("onSelectionChanged",[Modes.select.selected])}},deactivate:function(){DeviceConfiguration.setKeyboard(!1);b();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=!1;0==a.doc.documentRange().plainText().trim().length&&delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();blit()}}}(),video:function(){var a={},f=void 0,h=void 0,q=function(){f.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=h.wrap("<form>").closest("form").get(0);
void 0!=a&&a.reset();h.unwrap()},m=function(c){if(void 0!=a&&void 0!=a.fileUpload&&void 0!=c){$("#videoWorking").show();$("#videoFileChoice").hide();var b=new FileReader;b.onload=function(b){var e=$("<video/>"),d=e[0],h=b.target.result;d.addEventListener("loadeddata",function(b){b=d.videoHeight;a.width=d.videoWidth;a.height=b;a.video=e;a.videoSrc=h;c()},!1);e.append($("<source />",{src:h,type:"video/mp4"}));e.load()};b.readAsDataURL(a.fileUpload)}},n=function(){if("imageDefinition"==a.type){WorkQueue.pause();
var c=Date.now(),b=sprintf("%s%s",UserSettings.getUsername(),c),e=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",e.toString(),encodeURI(b));$.ajax({url:b,type:"POST",success:function(b){var d=$(b).find("resourceUrl").text(),h={type:"video",author:UserSettings.getUsername(),timestamp:c,identity:d,slide:e.toString(),source:$(b).text(),bounds:[a.x,a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),
x:a.x,y:a.y,audiences:_.map(Conversations.getCurrentGroup(),"id").map(permitStudentsToPublishCheckbox)};registerTracker(d,function(){var a=Modes.select.handlesAtZoom(),c=h.x,b=h.y,e=Math.max(h.width,viewboxWidth),l=Math.max(h.height,viewboxHeight);Modes.select.activate();IncludeView.specific(c-a,b-a,e+2*a,l+2*a);Modes.select.clearSelection();Modes.select.selected.videos[h.identity]=boardContent.videos[h.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(h);q();WorkQueue.gracefullyResume()},
error:function(a){console.log("Image upload ex",a);resetImageUpload();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:a.videoSrc,cache:!1,contentType:!1,processData:!1})}},e=!1;$(function(){e||(e=!0,f=$("#videoInsertOptions").css({position:"absolute",left:0,top:0}),$("#videoInsertOptionsClose").click(Modes.select.activate),h=$("#videoFileChoice").attr("accept","video/mp4"),
h[0].addEventListener("change",function(c){c=(c.target.files||c.dataTransfer.files)[0];0==c.type.indexOf("video")&&(a.fileUpload=c);m(n)},!1),q())});Progress.beforeLeavingSlide.videos=function(){"videos"in boardContent&&_.forEach(boardContent.videos,function(a){null!=a&&void 0!=a&&"destroy"in a&&a.destroy()})};return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.video;d("#insertTools","#videoMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$("#insertMode").addClass("activeTool").removeClass("inactiveTool");
$(".active").removeClass("active");$("#videoMode").addClass("active");$("#insertTools .insetColumn").hide();$("#videoTools").show();var c=screenToWorld(10,10);a={type:"imageDefinition",screenX:10,screenY:10,x:c.x,y:c.y};Progress.call("onLayoutUpdated");f.show()},deactivate:function(){q();b()}}}(),image:function(){var a={},f=void 0,h=void 0,q=function(){f.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=h.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();h.unwrap()},m=function(){var a=
function(a,c,b,e){for(var g=c*b;g>a;)c*=.8,b*=.8,g=c*b;return{w:c,h:b,q:e}},c={"native":{resizeFunc:function(a,c){return{w:a,h:c,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(c,b){return a(1*e,c,b,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(c,b){return a(3*e,c,b,.8)},selector:"#imageInsertHighDef"}},b=c.optimized,e=1048576,d=function(){_.forEach(c,function(a){var c=$(a.selector);b.selector==a.selector?c.addClass("activeBrush"):c.removeClass("activeBrush")})};
$(function(){_.forEach(c,function(a){$(a.selector).on("click",function(){b=a;d()})});d()});return{reapplyVisualStyle:d,changeMode:function(a){a in c&&(b=c[a],d())},getResizeFunction:function(){return b.resizeFunc}}}(),n=function(c,b){var d=void 0==b?a:b;if(void 0==d||void 0==d.fileUpload||void 0==c)console.log("returning because currentImage is empty",a);else{$("#imageWorking").show();$("#imageFileChoice").hide();var h=new FileReader;h.onload=function(a){var b=a.target.result;e(b,d,c,function(a){return b.length<
a})};h.readAsDataURL(d.fileUpload)}},e=function(c,b,e,d){var k=void 0!=b?b:a,h=$("<canvas/>"),f=new Image;0!=c.indexOf("data")&&f.setAttribute("crossOrigin","Anonymous");f.onerror=function(a){errorAlert("Error dropping image","The source server you're dragging the image from does not allow dragging the image directly.  You may need to download the image first and then upload it.")};f.onload=function(a){var b=f.width,g=f.height,t=m.getResizeFunction()(b,g);a=t.w;var q=t.h,t=t.q;h.width=b;h.height=
g;h.attr("width",b);h.attr("height",g);h.css({width:px(b),height:px(g)});var n=h[0].getContext("2d");n.rect(0,0,b,g);n.fillStyle="white";n.fill();n.drawImage(f,0,0,b,g);b=multiStageRescale(h[0],a,q);k.width=a;k.height=q;k.resizedImage=b.toDataURL("image/jpeg",t);d(k.resizedImage.length)&&(k.resizedImage=c);e(k)};f.src=c},c=function(a){if("imageDefinition"==a.type){WorkQueue.pause();var b=Date.now(),c=sprintf("%s%s%s",UserSettings.getUsername(),b,_.uniqueId()),e=Conversations.getCurrentSlideJid(),
c=sprintf("/uploadDataUri?jid=%s&filename=%s",e.toString(),encodeURI(c));$.ajax({url:c,type:"POST",success:function(c){var d=$(c).find("resourceUrl").text(),h={type:"image",author:UserSettings.getUsername(),timestamp:b,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+d+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:d,slide:e.toString(),source:$(c).text(),bounds:[a.x,a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,x:a.x,y:a.y,
target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),audiences:_.map(Conversations.getCurrentGroup(),"id").concat(ContentFilter.getAudiences()).map(audienceToStanza)};registerTracker(d,function(){var a=Modes.select.handlesAtZoom(),c=h.x,b=h.y,e=Math.max(h.width,viewboxWidth),d=Math.max(h.height,viewboxHeight);Modes.select.activate();IncludeView.specific(c-a,b-a,e+2*a,d+2*a);Modes.select.clearSelection();Modes.select.selected.images[h.identity]=boardContent.images[h.identity];Progress.call("onSelectionChanged",
[Modes.select.selected])});sendStanza(h);q();WorkQueue.gracefullyResume();zoomToFit()},error:function(a){console.log(a);q();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:a.resizedImage,cache:!1,contentType:!1,processData:!1})}},v=!1;$(function(){v||(v=!0,f=$("#imageInsertOptions").css({position:"absolute",left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),
h=$("#imageFileChoice").attr("accept","image/*"),h[0].addEventListener("change",function(b){try{var e=(b.target.files||b.dataTransfer.files)[0];0==e.type.indexOf("image")&&(a.fileUpload=e);n(c)}catch(d){console.log("imageFileChoiceHandleChanged exception:",d)}},!1),q())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.image;d("#insertTools","#imageMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$("#insertMode").addClass("activeTool").removeClass("inactiveTool");
$(".active").removeClass("active");$("#imageMode").addClass("active");$("#insertTools .insetColumn").hide();$("#imageTools").show();var b=screenToWorld(10,10);a={type:"imageDefinition",screenX:10,screenY:10,x:b.x,y:b.y};Progress.call("onLayoutUpdated");m.reapplyVisualStyle();f.show()},handleDroppedSrc:function(a,b,d){console.log("handleDroppedSrc:",a,b,d);var h=screenToWorld(b,d);e(a,{type:"imageDefinition",screenX:b,screenY:d,x:h.x,y:h.y},c,function(a){return!1})},handleDrop:function(a,b,e){var d=
0,k=[];console.log("handling drop:",a,b,e);var h=function(a,h){try{if(void 0!=a&&null!=a&&"type"in a&&0==a.type.indexOf("image")&&!_.some(k,function(b){return b==a})){var l=screenToWorld(b,e+d),g={type:"imageDefinition",screenX:b,screenY:e+d,x:l.x,y:l.y};g.fileUpload=a;k.push(a);n(c,g);d+=50}}catch(f){console.log("could not processFile:",a,h)}};_.forEach(a.files,function(a){h(a,"file")});_.forEach(a.items,function(a){try{var b=a.getAsFile(0);h(b,"item")}catch(c){console.log("could not get item as file:",
c)}})},deactivate:function(){q();b()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");Modes.currentMode.deactivate();d("#panTools","#panMode");Modes.currentMode=Modes.pan;var a,b;registerPositionHandlers(board,function(d,f,m){takeControlOfViewbox();a=d;b=f},function(d,f,m){Pan.translate(-1*(d-a),-1*(f-b));a=d;b=f},function(a,b,d){})},deactivate:function(){b();unregisterPositionHandlers(board)}},select:function(){var a=!1,f=function(){Modes.select.selected={images:{},texts:{},inks:{},multiWordTexts:{},
videos:{}};Progress.call("onSelectionChanged",[Modes.select.selected])},h=_.debounce(function(){var a=!1;_.forEach("images texts inks highlighters multiWordTexts videos".split(" "),function(b){var d="highlighters"==b?"inks":b;if(Modes&&Modes.select&&Modes.select.selected&&d in Modes.select.selected){var h=Modes.select.selected[d];_.forEach(h,function(f){h&&b in boardContent&&f&&f.identity in boardContent[b]?h[f.identity]=boardContent[b][f.identity]:(a=!0,"inks"==d?"highlighters"==b&&f.identity in
h&&1==h[f.identity].isHighlighter?delete h[f.identity]:"inks"==b&&f.identity in h&&0==h[f.identity].isHighlighter&&delete h[f.identity]:delete h[f.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),q=function(){if(void 0!=Modes.select.selected&&a&&"Blacklist"in window){var b=Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),b.inks,b.texts,b.multiWordTexts,b.images,b.videos)}f()},m=function(){(a=
Conversations.shouldModifyConversation()?!a:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");f();blit()},n=function(b){Conversations.shouldModifyConversation(b)?($("#ban").show(),$("#ban").removeClass("disabledButton"),$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());a?$("#administerContent").addClass("activeBrush"):
$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=h;Progress.onViewboxChanged.ModesSelect=h;Progress.onSelectionChanged.ModesSelect=function(b){b&&(Modes.select.selected=b,"images"in b&&0<_.size(b.images)||"inks"in b&&0<_.size(b.inks)||"texts"in b&&0<_.size(b.texts)||"multiWordTexts"in b&&0<_.size(b.multiWordTexts)||"videos"in b&&0<_.size(b.videos)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),a?($("#ban").removeClass("disabledButton"),
$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=f;Progress.conversationDetailsReceived.ModesSelect=function(b){a&&
!Conversations.shouldModifyConversation(b)&&(a=!1);Conversations.shouldModifyConversation(b)?($("#administerContent").show().unbind("click").bind("click",m),$("#ban").unbind("click").show().bind("click",q)):($("#administerContent").hide().unbind("click"),$("#ban").hide().unbind("click"));n(b)};return{name:"select",isAdministeringContent:function(){return a},updateAdministerContentVisualState:n,selected:{images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=
_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,b);_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,
b);_.forEach(Modes.select.selected.videos,b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:f,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;d("#selectTools","#selectMode");var b={x:0,y:0},c=$("<div/>",{id:"selectMarquee"}),h=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&
!a){var b=batchTransform();b.isDeleted=!0;"inks"in Modes.select.selected&&(b.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&(b.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(b.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(b.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));"videos"in Modes.select.selected&&(b.videoIds=_.keys(Modes.select.selected.videos));sendStanza(b);_.forEach(_.union(Modes.select.selected.inks,
Modes.select.selected.texts,Modes.select.selected.images,Modes.select.selected.multiWordTexts,Modes.select.selected.videos),function(a){Progress.call("onCanvasContentDeleted",[a])});f()}});var q=function(a){a("images");a("texts");a("multiWordTexts");a("inks");a("videos")};Modes.select.dragging=!1;n();Modes.select.resizing=!1;registerPositionHandlers(board,function(a,d,f,k,q){Modes.select.resizing=!1;Modes.select.dragging=!1;b={x:a,y:d};Modes.select.marqueeWorldOrigin=k;if(!q.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){a=
3/scale();var n=[k.x-a,k.y-a,k.x+a,k.y+a];Modes.select.dragging=_.some(["images","texts","inks","multiWordTexts","videos"],function(a){return _.some(Modes.select.selected[a],function(a){return a?intersectRect(a.bounds,n):!1})})}Modes.select.dragging?(Modes.select.offset=k,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(h.empty(),h.append(c),c.show(),updateMarquee(c,b,b))},function(a,d,h,k,f){a={x:a,y:d};Modes.select.offset=k;Modes.select.dragging?blit():Modes.select.resizing?
blit():updateMarquee(c,b,a)},function(b,d,e,k,h){WorkQueue.gracefullyResume();try{var f=k.x-Modes.select.marqueeWorldOrigin.x,n=k.y-Modes.select.marqueeWorldOrigin.y;15>Math.abs(f)+Math.abs(n)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=f;a.doc.position.y+=n;a.doc.invalidateBounds()});var l=batchTransform();
l.xTranslate=f;l.yTranslate=n;l.inkIds=_.keys(Modes.select.selected.inks);l.textIds=_.keys(Modes.select.selected.texts);l.imageIds=_.keys(Modes.select.selected.images);l.videoIds=_.keys(Modes.select.selected.videos);l.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(l.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(l)}else{var g=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,k,2),m=[g.left,g.top,g.right,g.bottom],
r={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},y={},C={};q(function(b){$.each(boardContent[b],function(c,d){if(!("bounds"in d)&&"type"in d)switch(d.type){case "text":prerenderText(d);break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;case "video":prerenderVideo(d);break;case "multiWordText":prerenderMultiwordText(d);break;default:d.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(m,d.bounds)&&(incrementKey(y,d.author),incrementKey(C,"any"),a?d.author!=UserSettings.getUsername()&&
(r[b][d.identity]=d):d.author==UserSettings.getUsername()&&(r[b][d.identity]=d))})});$.each(boardContent.highlighters,function(b,c){intersectRect(c.bounds,m)&&(incrementKey(y,c.author),a?c.author!=UserSettings.getUsername()&&(r.inks[c.identity]=c):c.author==UserSettings.getUsername()&&(r.inks[c.identity]=c))});q(function(a){$.each(r[a],function(b,c){a in Modes.select.selected||(Modes.select.selected[a]=[]);a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:
Modes.select.selected[a][b]=c})});C.any||Modes.select.clearSelection();var D=sprintf("Selected %s images, %s texts, %s inks, %s rich texts, %s videos ",_.keys(Modes.select.selected.images).length,_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,_.keys(Modes.select.selected.inks).length,_.keys(Modes.select.selected.videos).length);$.each(y,function(a,b){D+=sprintf("%s:%s ",a,b)});Progress.call("onSelectionChanged",[Modes.select.selected])}c.css({width:0,
height:0}).hide();blit()}catch(E){console.log("Selection up ex",E)}})},deactivate:function(){unregisterPositionHandlers(board);b();f();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();n();blit();blit()}}}(),zoom:{name:"zoom",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;d("#zoomTools","#zoomMode");var a=$("<div />",{id:"zoomMarquee"}),b,h={x:0,y:0};registerPositionHandlers(board,function(d,f,n,e){takeControlOfViewbox();
b=e;a.show();a.appendTo($("#selectionAdorner"));h={x:d,y:f};updateMarquee(a,h,h)},function(b,d,f,e){b={x:b,y:d};d=rectFromTwoPoints(b,h);f="left";e="top";b.x==d.left&&(f="right");b.y==d.top&&(e="bottom");b=aspectConstrainedRect(d,f,e);updateMarquee(a,{x:b.right,y:b.bottom},{x:b.left,y:b.top})},function(d,h,f,e){WorkQueue.gracefullyResume();a.hide();d={x:contentOffsetX+e.x,y:contentOffsetY+e.y};h=rectFromTwoPoints(d,{x:contentOffsetX+b.x,y:contentOffsetY+b.y});2500>scale()*h.width*h.height||(f="left",
e="top",d.x==h.left&&(f="right"),d.y==h.top&&(e="bottom"),d=aspectConstrainedRect(h,f,e),IncludeView.specific(d.left,d.top,d.width,d.height))})},deactivate:function(){b();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},feedback:function(){var a=function(){Conversations.shouldModifyConversation()?$("#participantsButton").unbind("click").on("click",function(){Participants.openMenu()}).show():$("#participantsButton").unbind("click").hide();switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);
break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){a()};Progress.conversationDetailsReceived.respectNewPermissions=a;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;a();d("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(a,b,d,f){},function(a,b,d,f){},function(a,b,d,f){});a()},deactivate:function(){b();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),
draw:function(){var a=Brushes.getDefaultBrushes(),f=_.map(a,function(a){return _.clone(a)}),h,m=!1,y=void 0,n=void 0,e=function(a){f[a.index]=a},c=function(){},v=function(){},u=function(){};$(function(){var b,d;$(".activeBrush").removeClass("activeBrush");var x=function(){var a=$("#drawTools");_.each(a.find(".modeSpecificTool.pen"),function(a,b){var c=f[b],d=$(a).css({color:c.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");h=c;e(c);Modes.draw.drawingAttributes=
h;m=!1;k(c)}).removeClass("fa-tint").removeClass("fa-circle").addClass(c.isHighlighter?"fa-circle":"fa-tint");d.find(".widthIndicator").text(c.width);c==h&&d.addClass("activeBrush")})},k=function(a){var b=$("#colors .dots"),c=$("#sizes .dots"),d=Colors.getAllNamedColors(),f=Brushes.getAllBrushSizes();c.empty();f.map(function(b){var d=y.clone();c.append(d);d.click(function(){a.width=b;e(a);h=a;x();k(a)});var g=Canvas.circle(a.color,b,50);b==a.width&&d.addClass("activeTool");d.prepend(g);g=b.toString()+
"px";d.find(".sizeDotName").append(g)});b.empty();d.map(function(c){var d=n.clone();b.append(d);d.on("click",function(){a.color=c.rgb;h=a;e(a);x();k(a)});d.css("color",c.rgb);"rgb"in c&&c.rgb==a.color&&d.addClass("activeTool");var f=c.name;d.find(".colorDotName").append(f)});d=$("#setPenToHighlighter").unbind("click").on("click",function(){a.isHighlighter=!0;h=a;e(a);x();k(a)});f=$("#setPenToPen").unbind("click").on("click",function(){a.isHighlighter=!1;h=a;e(a);x();k(a)});"isHighlighter"in h&&h.isHighlighter?
(d.addClass("activeTool").addClass("active"),f.removeClass("activeTool").removeClass("active")):(f.addClass("activeTool").addClass("active"),d.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var b=_.find(a,function(a){return a.id==h.id});void 0!=b&&(h.width=b.width,h.color=b.color,h.isHighlighter=b.isHighlighter,x(),k(h))});y=$("#penSize .sizeDot").clone();n=$("#penColor .colorDot").clone();h=f[0];x();k(h);var w=$("#drawTools");
w.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");m=!0;$("#drawDropdowns").hide()});w.find(".advancedTools").unbind("click").on("click",function(){m||(k(h),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});var p=[];v=function(a,c,e,f,h){A=[];m||h.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,boardContext.fillStyle=Modes.draw.drawingAttributes.color,
boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,p=[f.x,f.y,256*e],b=a,d=c,boardContext.beginPath(),boardContext.arc(a,c,Modes.draw.drawingAttributes.width*e/2,0,2*Math.PI),boardContext.fill())};var A=[];d=b=void 0;u=function(a,c,e,f,h){a=Math.round(a);c=Math.round(c);if(m||h.eraser){var k=[f.x-10,f.y-10,f.x+10,f.y+10];e=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,k)){delete a[c.identity];A.push(c);var d=c.bounds,e=worldToScreen(d[0],
d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";e(boardContent.inks);e(boardContent.highlighters);boardContext.globalAlpha=1}else h=Modes.draw.drawingAttributes.width*e,boardContext.beginPath(),boardContext.lineCap="round",boardContext.lineWidth=h,_.takeRight(p,3),boardContext.moveTo(b,d),boardContext.lineTo(a,c),boardContext.stroke(),p=p.concat([f.x,f.y,256*e]);b=a;d=c};c=function(a,c,e,f,h){m||h.eraser?
(a=batchTransform(),a.isDeleted=!0,a.inkIds=_.map(A,function(a){return a.identity}),_.forEach(A,function(a){Progress.call("onCanvasContentDeleted",[a])}),sendStanza(a)):(h=Modes.draw.drawingAttributes.width*e,boardContext.lineWidth=h,boardContext.beginPath(),boardContext.lineWidth=h,boardContext.lineCap="round",boardContext.moveTo(b,d),boardContext.lineTo(a,c),boardContext.stroke(),p=p.concat([f.x,f.y,256*e]),strokeCollected(p));boardContext.globalAlpha=1}});return{name:"draw",brushes:f,mousePressure:256,
activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,Modes.draw.drawingAttributes=h,d("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),m?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==h.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,v,u,c))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");
$("#drawDropdowns").hide();b();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,function(a,b,d,f){},function(a,b,d,f){},function(a,b,d,f){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
