function devLogAdd(b){$("#devLog").append($("<div />",{text:b}))}function devLogSet(b){$("#devLog").html($("<div />",{text:b}))}var incrementKey=function(b,d){d in b?b[d]++:b[d]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(b){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(d,f){b.unbind(f)});WorkQueue.gracefullyResume()}
function progress(){var b=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),d=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(b),f=$("<progress />");f.append(b);var l=1,c=0,r=function(){d.css("width",sprintf("%s%%",Math.floor(c/l*100)));f.attr({value:c,max:l})},g={element:f,value:function(b){c=b;r();return g},max:function(c){l=c;r();return g}};return g}
function proportion(b,d){return b/d/(boardWidth/boardHeight)}function scaleScreenToWorld(b){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b*d}function scaleWorldToScreen(b){var d;d=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return b/d}function screenToWorld(b,d){var f=scaleScreenToWorld(b)+viewboxX,l=scaleScreenToWorld(d)+viewboxY;return{x:f,y:l}}
function worldToScreen(b,d){var f=scaleWorldToScreen(b-viewboxX),l=scaleWorldToScreen(d-viewboxY);return{x:f,y:l}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(b){return!1}}
function registerPositionHandlers(b,d,f,l){var c=!1,r=function(c,b){var g=[c.x-10,c.y-10,c.x+10,c.y+10],a=!0;_.each(Modes.canvasInteractables,function(t,d){_.each(t,function(t){void 0!=t&&b in t&&(t.activated||intersectRect(g,t.getBounds()))&&(a=a&&t[b](c))})});return a},g=function(c,b){return{shift:c.shiftKey,ctrl:c.ctrlKey,alt:c.altKey,eraser:b}};$.each(b,function(b,z){var m=$(z);m.css({"touch-action":"none"});var a=!1,t={},x=function(e){return void 0!==e&&"touch"==e.originalEvent.pointerType?1<
_.size(t):!1},u=function(e){var c=e.originalEvent.pointerId,h="pen"==e.originalEvent.pointerType&&5==e.originalEvent.button,p=m.offset(),k=e.pageX-p.left,p=e.pageY-p.top,b=e.originalEvent.pressure||.5,n=screenToWorld(k,p),v=t[c]||{pointerId:c,pointerType:e.originalEvent.pointerType,eraser:h,points:[]};v.points.push({x:n.x,y:n.y,screenX:k,screenY:p,z:b});v.eraser=v.eraser||h;"touch"==e.originalEvent.pointerType&&(t[c]=v);x(e)&&(0==a&&_.each(t,function(e){e.points=[_.last(e.points)]}),a=!0);return{pointerType:e.pointerType,
eraser:v.eraser,x:k,y:p,z:b,worldPos:n}},n=function(e){var h=e.originalEvent.pointerId,p="pen"==e.originalEvent.pointerType&&5==e.originalEvent.button,k=m.offset(),b=e.pageX-k.left,k=e.pageY-k.top,n=e.originalEvent.pressure||.5,v=screenToWorld(b,k);"touch"==e.originalEvent.pointerType&&delete t[h];a&&0==_.size(t)&&(c=a=!1);return{pointerType:e.pointerType,eraser:p,x:b,y:k,z:n,worldPos:v}};if(detectPointerEvents()){var B=_.throttle(function(){takeControlOfViewbox();var e=_.map(_.filter(t,function(e){return 0<
_.size(e.points)}),function(e){var a=_.first(e.points);e=_.last(e.points);return[a,e]});t={};var a=_.meanBy(e,function(e){return e[0].x-e[1].x}),c=_.meanBy(e,function(e){return e[0].y-e[1].y});Pan.translate(scaleWorldToScreen(a),scaleWorldToScreen(c));var a=_.min(_.map(e,function(e){return e[0].y})),h=_.max(_.map(e,function(e){return e[0].y})),c=_.min(_.map(e,function(e){return e[0].x})),p=_.max(_.map(e,function(e){return e[0].x})),a=h-a,c=p-c,p=_.min(_.map(e,function(e){return e[1].y})),h=_.max(_.map(e,
function(e){return e[1].y})),k=_.min(_.map(e,function(e){return e[1].x})),e=(_.max(_.map(e,function(e){return e[1].x}))-k+(h-p))/2;Zoom.scale((c+a)/2/e)},25);m.bind("pointerdown",function(e){e.originalEvent.pointerType!=e.POINTER_TYPE_TOUCH&&"touch"!=e.originalEvent.pointerType||!x(e)||(a=!0);var h=u(e);e.preventDefault();WorkQueue.pause();x(e)||a||(c=!0,r(h.worldPos,"down")&&d(h.x,h.y,h.z,h.worldPos,g(e,h.eraser)))});m.bind("pointermove",function(e){var h=u(e);e.preventDefault();e.originalEvent.pointerType!=
e.POINTER_TYPE_TOUCH&&"touch"!=e.originalEvent.pointerType||!x(e)&&!a?r(h.worldPos,"move")&&c&&f(h.x,h.y,h.z,h.worldPos,g(e,h.eraser)):B()});m.bind("pointerup",function(e){var h=n(e);WorkQueue.gracefullyResume();e.preventDefault();r(h.worldPos,"up")&&c&&!a&&l(h.x,h.y,h.z,h.worldPos,g(e,h.eraser));c=!1;Modes.finishInteractableStates()});var y=function(e){n(e);WorkQueue.gracefullyResume();e.preventDefault();if(c){var h=e.offsetX,p=e.offsetY,k=n(e);t={};WorkQueue.gracefullyResume();h=screenToWorld(h,
p);p=h.x;p<viewboxX?(takeControlOfViewbox(),Extend.left()):p>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):r(h,"up")&&c&&!a&&l(k.x,k.y,k.z,k.worldPos,g(e,k.eraser));c=!1;Modes.finishInteractableStates()}c=!1;Modes.finishInteractableStates()};m.bind("pointerout",y);m.bind("pointerleave",y);m.bind("pointercancel",y)}else{m.bind("mousedown",function(e){WorkQueue.pause();var a=m.offset();c=!0;var h=e.pageX-a.left,a=e.pageY-a.top,p=screenToWorld(h,a);r(p,"down")&&d(h,a,.5,p,g(e));e.preventDefault()});
m.bind("mousemove",function(e){var a=m.offset();e.preventDefault();var h=e.pageX-a.left,a=e.pageY-a.top,p=screenToWorld(h,a);r(p,"move")&&c&&f(h,a,.5,p,g(e))});m.bind("mouseup",function(e){WorkQueue.gracefullyResume();e.preventDefault();var a=m.offset(),h=e.pageX-a.left,a=e.pageY-a.top,p=screenToWorld(h,a);r(p,"up")&&c&&l(h,a,.5,p,g(e));c=!1;Modes.finishInteractableStates()});var w=function(e,h,p){console.log("mouseout",e,h);WorkQueue.gracefullyResume();var k=screenToWorld(e,h),t=k.x;t<viewboxX?(takeControlOfViewbox(),
Extend.left()):t>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):r(k,"up")&&c&&!a&&l(e,h,.5,k,g(p,!1));c=!1};m.bind("mouseout",function(e){WorkQueue.gracefullyResume();e.preventDefault();c&&w(e.offsetX,e.offsetY,e);c=!1;Modes.finishInteractableStates()});var h,p=function(e){return{x:average(_.map(e,"x")),y:average(_.map(e,"y"))}},v=function(e){var a=[],h=m.offset();$.each(e,function(e,p){a.push({x:p.pageX-h.left,y:p.pageY-h.top,identifier:p.identifier})});return a};m.bind("touchstart",
function(e){WorkQueue.pause();e.preventDefault();var a=v(e.originalEvent.touches);if(1==a.length){var a=a[0],k=screenToWorld(a.x,a.y);c=!0;r(k,"down")&&d(a.x,a.y,.5,k,g(e))}else h=p(a)});m.bind("touchmove",function(e){e.preventDefault();var a=v(e.originalEvent.touches);switch(a.length){case 0:break;case 1:var a=a[0],k=screenToWorld(a.x,a.y);r(k,"move")&&c&&f(a.x,a.y,.5,k,g(e));break;default:e=p(a),a=e.x-h.x,k=e.y-h.y,h=e,takeControlOfViewbox(),Pan.translate(-1*a,-1*k)}});m.bind("touchend",function(e){WorkQueue.gracefullyResume();
e.preventDefault();var a=m.offset(),h=e.originalEvent.changedTouches[0],p=h.pageX-a.left,a=h.pageY-a.top,h=screenToWorld(p,a);r(h,"up")&&c&&(0>p||0>a||p>boardWidth||a>boardHeight?w(p,a):l(p,a,.5,h,g(e)));c=!1;Modes.finishInteractableStates()});var k=1;m.bind("gesturechange",function(a){WorkQueue.pause();a.preventDefault();c=!1;a=a.originalEvent.scale;takeControlOfViewbox();Zoom.scale(k/a);k=a});m.bind("gestureend",function(){WorkQueue.gracefullyResume();k=1})}});return function(b){c=b}}
function aspectConstrainedDimensions(b,d){var f=boardHeight/boardWidth,l={height:d,width:b};d/b>f?l.height=b*f:l.width=d/f;return l}
function aspectConstrainedRect(b,d,f){var l=boardHeight/boardWidth,c={left:b.left,top:b.top,right:b.right,bottom:b.bottom,width:b.width,height:b.height};b.height/b.width>l?(c.height=b.width*l,f&&(d=b.height-c.height,"center"==f?c.top+=d/2:"bottom"==f&&(c.top+=d))):(c.width=b.height/l,d&&(f=b.width-c.width,"center"==d?c.left+=f/2:"right"==d&&(c.left+=f)));c.right=c.left+c.width;c.bottom=c.top+c.height;return c}
function copyBuffer(b){var d=document.createElement("canvas");d.width=b.width;d.height=b.height;d.getContext("2d").drawImage(b,0,0,b.width,b.height,0,0,b.width,b.height);return d}function intersectRect(b,d){return"undefined"!=typeof b&&"undefined"!=typeof d?!(d[0]>b[2]||d[2]<b[0]||d[1]>b[3]||d[3]<b[1]):!1}function overlapRect(b,d){return intersectRect(b,d)?(Math.max(b[0],d[0])-Math.min(b[2],d[2]))*(Math.max(b[1],d[1])-Math.min(b[3],d[3])):0}
function rectFromTwoPoints(b,d,f){f=f||0;var l,c,r;b.x<d.x?(l=b.x,r=d.x):(l=d.x,r=b.x);b.y<d.y?(c=b.y,b=d.y):(c=d.y,b=b.y);d=r-l;var g=b-c;d<f&&(r+=f-d,d=r-l);g<f&&(b+=f-g,g=b-c);return{left:l,top:c,right:r,bottom:b,width:d,height:g}}function updateMarquee(b,d,f){d=rectFromTwoPoints(d,f);f=$("#selectionAdorner");jQuery.contains(f,b)||f.append(b);b.is(":visible")||b.show();b.css({left:px(d.left),top:px(d.top),width:px(d.width),height:px(d.height)})}
function clampToView(b){var d=b.x,f=b.y;0>b.x&&(d=0);b.x>boardWidth&&(d=boardWidth);0>b.y&&(f=0);b.y>boardHeight&&(f=boardHeight);return{x:d,y:f}}
var bounceButton=function(b){var d=$(b);d.addClass("activeBrush");setTimeout(function(){d.removeClass("activeBrush")},200)},videoControlInteractable=function(b){var d=void 0;return{activated:!1,rehome:function(b){},down:function(b){return!1},move:function(b){return!1},up:function(d){var l=Modes.select.handlesAtZoom();d=d.x-b.x;if(d<l)b.getState().paused?b.play():b.pause();else if(d>b.width-l)b.muted(!b.muted());else{var c=b.getState();b.seek((d-l)/(b.width-2*l)*c.duration)}return!1},getBounds:function(){return d},
deactivate:function(){},render:function(f){if(b.identity in boardContent.videos){var l=Modes.select.handlesAtZoom();d=[b.bounds[0],b.bounds[3],b.bounds[2],b.bounds[3]+l];var l=worldToScreen(d[0],d[1]),c=worldToScreen(d[2],d[3]),r=c.x-l.x,g=c.y-l.y,q=b.getState();f.globalAlpha=1;f.setLineDash([]);f.strokeStyle="black";f.font=sprintf("%spx FontAwesome",g);f.fillStyle="white";f.fillRect(l.x,l.y,g,g);f.fillStyle="black";q.paused?f.fillText("\uf04b",l.x,c.y):f.fillText("\uf04c",l.x,c.y);var z=l.x+g,m=
r-g;f.fillStyle="black";f.fillRect(z,l.y,m,g);f.fillStyle="blue";m*=q.currentTime/q.duration;f.fillRect(z,l.y,m,g);r=l.x+(r-g);f.fillStyle="white";f.fillRect(r,l.y,g,g);f.fillStyle="black";q.muted?f.fillText("\uf0f3",r,c.y):f.fillText("\uf1f6",r,c.y)}}}},Modes=function(){var b=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},d=function(c,d){b();$(c).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");
$(d).addClass("activeTool").removeClass("inactiveTool")},f={name:"none",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.none;b()},deactivate:function(){b();unregisterPositionHandlers(board)}},l=function(c,b){c in Modes.canvasInteractables||(Modes.canvasInteractables[c]=[]);Modes.canvasInteractables[c].push(b)};$(function(){var c={opacity:1};(new TWEEN.Tween(c)).delay(1E3).to({opacity:.3},1E3);var b=Modes.select.handlesAtZoom(),d=function(){var m=void 0;return{getBounds:function(){return m},
activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!d.activated){var c=Modes.select.handlesAtZoom(),b=a.x+c/2;m=[b-c/2,a.y-c,b+c/2,a.y]}},down:function(a){d.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.offset=a;Modes.select.marqueeWorldOrigin=a;blit()},move:function(a){d.activated&&(d.bounds=[a.x-b,a.y,a.x+b,a.y],Modes.select.offset=a,blit());return!1},deactivate:function(){d.activated=!1;Modes.select.dragging=!1},up:function(a){d.deactivate();var c=
batchTransform(),b=a.x-Modes.select.marqueeWorldOrigin.x,u=a.y-Modes.select.marqueeWorldOrigin.y;c.xTranslate=b;c.yTranslate=u;c.inkIds=_.keys(Modes.select.selected.inks);c.textIds=_.keys(Modes.select.selected.texts);c.imageIds=_.keys(Modes.select.selected.images);c.videoIds=_.keys(Modes.select.selected.videos);c.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(c.multiWordTextIds,function(a){Modes.text.echoesToDisregard[a]=!0});Modes.select.dragging=!1;Modes.text.mapSelected(function(a){a.doc.position.x+=
b;a.doc.position.y+=u;a.doc.invalidateBounds()});sendStanza(c);registerTracker(c.identity,function(){Progress.call("onSelectionChanged");blit()});return!1},render:function(a){if(m){var b=worldToScreen(m[0],m[1]),d=worldToScreen(m[2],m[3]).x-b.x,u=b.x,b=b.y;a.globalAlpha=c.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.fillRect(u,b,d,d);a.strokeRect(u,b,d,d);a.font=sprintf("%spx FontAwesome",d);a.fillStyle="black";a.fillText("\uf047",u,b+d-4)}}}}(),q=function(){var d=
void 0;return{getBounds:function(){return d},activated:!1,originalHeight:1,originalWidth:1,rehome:function(a){if(!q.activated){var c=Modes.select.handlesAtZoom(),b=a.x2;a=a.y;d=[b,a,b+c,a+c]}},down:function(a){Modes.select.aspectLocked=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;q.activated=!0;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};q.rehome(a);blit();return!1},move:function(a){if(q.activated){d=[a.x-b,d[1],a.x+b,d[3]];var c=Modes.select.totalSelectedBounds();
Modes.select.offset={x:a.x,y:c.y+(a.x-c.x)/(c.x2-c.x)*c.height};blit()}return!1},deactivate:function(){Modes.select.aspectLocked=!1;q.activated=!1;Modes.select.resizing=!1},up:function(a){q.deactivate();var c=batchTransform(),b=Modes.select.totalSelectedBounds();c.xScale=(a.x-b.x)/(b.x2-b.x);c.yScale=c.xScale;c.xOrigin=b.x;c.yOrigin=b.y;c.inkIds=_.keys(Modes.select.selected.inks);c.textIds=_.keys(Modes.select.selected.texts);c.imageIds=_.keys(Modes.select.selected.images);c.videoIds=_.keys(Modes.select.selected.videos);
c.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0;var d=a.doc.documentRange();a.doc.select(d.start,d.end);Modes.text.scaleEditor(a.doc,c.xScale);a.doc.select(0,0);a.doc.width(a.doc.width()*c.xScale);a.doc.invalidateBounds()});registerTracker(c.identity,function(){Progress.call("onSelectionChanged")});sendStanza(c);return!1},render:function(a){if(d){var b=worldToScreen(d[0],d[1]),g=worldToScreen(d[2],
d[3]).x-b.x,u=g/10,n=-1*g;a.globalAlpha=c.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(b.x,b.y);a.rotate(90*Math.PI/180);a.fillRect(0,n,g,g);a.strokeRect(0,n,g,g);a.font=sprintf("%spx FontAwesome",g);a.fillStyle="black";a.fillText("\uf0b2",u,-1*u)}}}}(),f=function(){var d=void 0;return{activated:!1,getBounds:function(){return d},rehome:function(a){if(!f.activated){var c=Modes.select.handlesAtZoom(),b=a.x2;a=a.y2;d=[b,a-c,b+c,a]}},down:function(a){f.activated=
!0;Modes.select.dragging=!1;Modes.select.resizing=!0;Modes.select.aspectLocked=!1;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();return!1},move:function(a){f.activated&&(scaleWorldToScreen(Modes.text.minimumWidth),f.bounds=[a.x-b,a.y-b,a.x+b,a.y+b],Modes.select.offset={x:a.x,y:a.y},blit());return!1},deactivate:function(){f.activated=!1;Modes.select.resizing=!1},up:function(a){f.deactivate();var c=batchTransform(),b=Modes.select.totalSelectedBounds(),d=b.y2-b.y,n=a.y-
b.y;c.xScale=(a.x-b.x)/(b.x2-b.x);c.yScale=n/d;c.xOrigin=b.x;c.yOrigin=b.y;c.inkIds=_.keys(Modes.select.selected.inks);c.textIds=_.keys(Modes.select.selected.texts);c.imageIds=_.keys(Modes.select.selected.images);c.videoIds=_.keys(Modes.select.selected.videos);_.each(Modes.select.selected.multiWordTexts,function(a){a.doc.width(Math.max(a.doc.width()*c.xScale,Modes.text.minimumWidth/scale()));a.doc.invalidateBounds();0<a.doc.save().length&&sendRichText(a)});registerTracker(c.identity,function(){Progress.call("onSelectionChanged");
blit()});sendStanza(c);blit();return!1},render:function(a){if(d){var b=worldToScreen(d[0],d[1]),g=worldToScreen(d[2],d[3]).x-b.x,u=g/10,n=-1*g;a.globalAlpha=c.opacity;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(b.x,b.y);a.rotate(90*Math.PI/180);a.fillRect(0,n,g,g);a.strokeRect(0,n,g,g);a.font=sprintf("%spx FontAwesome",g);a.fillStyle="black";a.fillText("\uf065",u,-1*u)}}}}();l("manualMove",d);l("resizeFree",f);l("resizeAspectLocked",q);Progress.textBoundsChanged.selectionHandles=
function(c,a){if(c in Modes.select.selected.multiWordTexts){var b=Modes.select.totalSelectedBounds();d.rehome(b);f.rehome(b);q.rehome(b)}};Progress.onSelectionChanged.selectionHandles=function(){var b=Modes.select.totalSelectedBounds();Infinity==b.x?c.opacity=0:(c.opacity=1,d.rehome(b),f.rehome(b),q.rehome(b))}});return{pushCanvasInteractable:l,clearCanvasInteractables:function(c){Modes.canvasInteractables[c]=[]},getCanvasInteractables:function(){return _.mapValues(Modes.canvasInteractables,function(c){return _.map(c,
function(c){c=_.clone(c);c.bounds=c.getBounds();return c})})},currentMode:f,none:f,canvasInteractables:{},finishInteractableStates:function(){_.forEach(_.keys(Modes.canvasInteractables),function(c){_.forEach(Modes.canvasInteractables[c],function(c){void 0!=c&&"deactivate"in c&&c.deactivate()})});Modes.select.resizing=!1;Modes.select.dragging=!1;Modes.select.aspectLocked=!1},text:function(){var c=function(){},f,g,q,l,m,a,t,x,u=function(a,c){var b=Modes.text.minimumWidth/scale(),b=Modes.text.editorFor({bounds:[a.x,
a.y,a.x,a.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),slide:Conversations.getCurrentSlideJid(),target:"presentationSpace",requestedWidth:b,width:b,height:0,x:a.x,y:a.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]});b.doc.load(c);return b},n=function(a){return function(){var c=!1;_.each(boardContent.multiWordTexts,function(b){if(b.doc.isActive){c=!0;var e=b.doc.selectedRange();carota.runs.nextInsertFormatting=
{};e.setFormatting(a,!0!==e.getFormatting()[a]);0<b.doc.save().length&&sendRichText(b)}});if(!c){carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var b=carota.runs.nextInsertFormatting[a]=!carota.runs.nextInsertFormatting[a];$(sprintf(".font%sSelector",_.capitalize(a))).toggleClass("active",b)}}},B=function(a,c){return function(){var b=!1;c=c||$(this).val();_.each(boardContent.multiWordTexts,function(k){k.doc.isActive&&(b=!0,carota.runs.nextInsertFormatting={},k.doc.selectedRange().setFormatting(a,
c),carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[a]=c,k.doc.claimFocus(),0<k.doc.save().length&&sendRichText(k))});b||(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},carota.runs.nextInsertFormatting[a]=c)}},y=function(a,c){var b=a.selectedRange(),k=0,e=[],d=carota.runs.defaultFormatting.size;a.runs(function(c){c=_.size(c.text);c=k+c;a.select(k,c,!0);var b=a.selectedRange().getFormatting().size||d;_.each(_.range(k,c),function(){e.push(b)});
k=c;d=b},a.range(0,b.end));k=b.start;a.runs(function(b){b=k+b.text.length;a.select(k,b,!0);a.selectedRange().setFormatting("size",e[k]*c);k=b},a.range(b.start,b.end));a.select(b.start,b.end,!0);return e},w=function(a){return function(){_.each(boardContent.multiWordTexts,function(c){c=c.doc;c.isActive&&(c=y(c,a),carota.runs.defaultFormatting.newBoxSize=1<a?_.max(c):_.min(c))})}};$(function(){l=$(".fontBoldSelector");m=$(".fontItalicSelector");a=$(".fontUnderlineSelector");$("#textDropdowns");$("#fontOptions");
f=$("#fontFamilySelector");g=$("#fontSizeSelector");q=$("#fontColorSelector");t=$("#fontLarger");x=$("#fontSmaller");$("#justifySelector");$("#presetFitToText");$("#presetRunToEdge");$("#presetNarrow");$("#presetWiden");$("#presetFullscreen");$("#presetCenterOnScreen");var c=f.find(".fontFamilyOption").clone(),b=g.find(".fontSizeOption").clone(),d=q.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(a){f.append(c.clone().attr("value",a).text(a))});Fonts.getAllSizes().map(function(a){g.append(b.clone().attr("value",
a).text(a))});Colors.getAllNamedColors().map(function(a){q.append(d.clone().attr("value",a.rgb).text(a.name))});t.on("click",w(1.2));x.click(w(.8));l.click(n("bold"));m.click(n("italic"));a.click(n("underline"));var k={red:"#ff0000",blue:"#0000ff",black:"#000000",yellow:"#ffff00",green:"#00ff00"};_.each(["red","blue","black","yellow","green"],function(a){$(sprintf("#%sText",a)).click(function(){$("#textTools .fa-tint").removeClass("active");$(this).addClass("active");Modes.text.refocussing=!0;B("color",
[k[a],255])();console.log("Clicked",a)})})});return{name:"text",echoesToDisregard:{},minimumWidth:240,minimumHeight:function(){return 3*Modes.select.resizeHandleSize},"default":{fontSize:12,bold:!1,underline:!1,italic:!1,color:["#000000",255]},invalidateSelectedBoxes:function(){Modes.text.mapSelected(function(a){a.doc.invalidateBounds()})},getSelectedRanges:function(){return _.map(boardContent.multiWordTexts,function(a){var c=a.doc.selectedRange();return{identity:a.identity,start:c.start,end:c.end,
text:c.plainText()}})},getLinesets:function(){return _.map(boardContent.multiWordTexts,function(a){a.doc.layout();return _.map(a.doc.frame.lines,function(a){return a.positionedWords.length})})},mapSelected:function(a){var c=Modes.select.selected.multiWordTexts;_.each(boardContent.multiWordTexts,function(b){b.identity in c&&a(b)})},scaleEditor:y,scrollToCursor:function(a){var c=a.bounds,b=a.doc.selectedRange().start;a=a.doc.getCaretCoords(b);var b=Math.floor(a.t/a.h),k=Math.floor(scaleScreenToWorld(boardContext.height)/
a.h);if(DeviceConfiguration.hasOnScreenKeyboard()){var b=Math.min(b,Math.max(0,k-2))*a.h,k=Math.max(c[2]-c[0],scaleWorldToScreen(10*a.h)),e=k/(boardWidth/boardHeight);DeviceConfiguration.setKeyboard(!0);TweenController.zoomAndPanViewbox(c[0],c[1]-b+a.t,k,e)}else c=Math.max(0,Math.floor(a.t/a.h)-(Math.floor((viewboxHeight-(c[1]-viewboxY))/a.h)-4))*a.h,0!=c&&TweenController.zoomAndPanViewbox(viewboxX,viewboxY+c,viewboxWidth,viewboxHeight)},refocussing:!1,editorFor:function(b){var d=[$("#blackText"),
$("#redText"),$("#blueText"),$("#yellowText"),$("#greenText")],n=boardContent.multiWordTexts[b.identity];n||(n=boardContent.multiWordTexts[b.identity]=b);if(!n.doc){var k=b.author==UserSettings.getUsername();n.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",b.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],k?blit:c,b);if(k){var e=_.debounce(function(){Modes.text.scrollToCursor(n);var a=boardContent.multiWordTexts[n.identity];a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();
a.audiences=ContentFilter.getAudiences();sendRichText(a);incorporateBoardBounds(n.bounds)},1E3);Progress.beforeChangingAudience[b.identity]=function(){e.flush();delete Progress.beforeChangingAudience[b.identity]};Progress.beforeLeavingSlide[b.identity]=function(){e.flush();delete Progress.beforeLeavingSlide[b.identity]};n.doc.contentChanged(e);n.doc.selectionChanged(function(c,b){if(Modes.text.refocussing)Modes.text.refocussing=!1;else{var e=c();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||
{};var k=function(a,c){var b=1==e[c];b&&(carota.runs.nextInsertFormatting[c]=b);a.toggleClass("active",b)},h=function(a,c,b){var k=_.isEqual(e[c],b);c in e&&k&&(carota.runs.nextInsertFormatting[c]=b);a.toggleClass("active",k)};k(l,"bold");k(m,"italic");k(a,"underline");h(d[0],"color",["#000000",255]);h(d[1],"color",["#ff0000",255]);h(d[2],"color",["#0000ff",255]);h(d[3],"color",["#ffff00",255]);h(d[4],"color",["#00ff00",255]);b&&Modes.text.scrollToCursor(n)}})}}n.doc.position={x:b.x,y:b.y};n.doc.width(b.width);
return n},draw:function(a){a&&a.doc&&carota.editor.paint(board[0],a.doc,!0)},oldEditorAt:function(a,c,b,k){var e=UserSettings.getUsername(),d=[k.x-10,k.y-10,k.x+10,k.y+10];a=_.values(boardContent.texts).filter(function(a){return intersectRect(a.bounds,d)&&a.author==e});return 0<a.length?a[0]:!1},editorAt:function(a,c,b,k){var e=UserSettings.getUsername(),d=[k.x-10,k.y-10,k.x+10,k.y+10];a=_.values(boardContent.multiWordTexts).filter(function(a){return intersectRect(a.bounds,d)&&a.author==e});return 0<
a.length?a[0]:!1},contextFor:function(a,c){var b={x:c.x-a.position.x,y:c.y-a.position.y};return{node:a.byCoordinate(b.x,b.y),relativePos:b}},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;d("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var a=0;registerPositionHandlers(board,function(a,c,b,e){if(a=Modes.text.editorAt(a,c,b,e).doc)a.isActive=!0,a.caretVisible=!0,a.mousedownHandler(Modes.text.contextFor(a,e).node)},
function(a,c,b,e){(a=Modes.text.editorAt(a,c,b,e).doc)&&a.mousemoveHandler(Modes.text.contextFor(a,e).node)},function(c,b,k,e){var d=Date.now(),n=Modes.text.oldEditorAt(c,b,k,e),g=Modes.text.editorAt(c,b,k,e);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=a.doc.identity==g.identity;0==a.doc.documentRange().plainText().trim().length&&(delete boardContent.multiWordTexts[a.identity],blit())});Modes.select.clearSelection();n?(d=batchTransform(),d.isDeleted=!0,"texts"in Modes.select.selected&&
(d.textIds=[n.identity]),sendStanza(d),carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},n=u({x:n.x,y:n.y},[{text:n.text,italic:"italic"==n.style,bold:"bold"==n.weight,underline:"underline"==n.decoration,color:n.color,size:n.size}]),d=n.doc,d.select(0,1),boardContent.multiWordTexts[n.identity]=n,e={multiWordTexts:{}},e.multiWordTexts[n.identity]=boardContent.multiWordTexts[n.identity],Modes.select.setSelection(e),e=g=n,e.privacy=Privacy.getCurrentPrivacy(),e.target="presentationSpace",
e.slide=Conversations.getCurrentSlideJid(),sendRichText(e),incorporateBoardBounds(g.bounds),e=d.byOrdinal(0),d.mousedownHandler(e),d.mouseupHandler(e)):g?(n=g.doc,e=Modes.text.contextFor(n,e),500>=d-a?n.dblclickHandler(e.node):n.mouseupHandler(e.node),a=d,e={multiWordTexts:{}},e.multiWordTexts[g.identity]=g,Modes.select.setSelection(e)):(carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{},n=u(e,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,
underline:1==carota.runs.nextInsertFormatting.underline,color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.newBoxSize/scale()}]),d=n.doc,d.select(0,1),boardContent.multiWordTexts[n.identity]=n,e={multiWordTexts:{}},e.multiWordTexts[n.identity]=boardContent.multiWordTexts[n.identity],Modes.select.setSelection(e),g=n,e=d.byOrdinal(0),d.mousedownHandler(e),d.mouseupHandler(e));g.doc.invalidateBounds();g.doc.isActive=!0;Progress.historyReceived.ClearMultiTextEchoes=
function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(g);Progress.call("onSelectionChanged",[Modes.select.selected])})},handleDrop:function(a,c,b){if(0<a.length){a=carota.html.parse(a,{});c=screenToWorld(c,b);Modes.text.activate();Date.now();Modes.select.clearSelection();carota.runs.nextInsertFormatting=carota.runs.nextInsertFormatting||{};var d=u(c,[{text:" ",italic:1==carota.runs.nextInsertFormatting.italic,bold:1==carota.runs.nextInsertFormatting.bold,underline:1==carota.runs.nextInsertFormatting.underline,
color:carota.runs.nextInsertFormatting.color||carota.runs.defaultFormatting.color,size:carota.runs.defaultFormatting.newBoxSize/scale()}]);c=d.doc;c.select(0,1);boardContent.multiWordTexts[d.identity]=d;b={multiWordTexts:{}};b.multiWordTexts[d.identity]=boardContent.multiWordTexts[d.identity];Modes.select.setSelection(b);editor=d;b=c.byOrdinal(0);c.mousedownHandler(b);c.mouseupHandler(b);editor.doc.invalidateBounds();editor.doc.isActive=!0;editor.doc.load(a);Progress.historyReceived.ClearMultiTextEchoes=
function(){Modes.text.echoesToDisregard={}};Modes.text.scrollToCursor(editor);a=boardContent.multiWordTexts[editor.identity];a.privacy=Privacy.getCurrentPrivacy();a.target="presentationSpace";a.slide=Conversations.getCurrentSlideJid();sendRichText(a);Progress.call("onSelectionChanged",[Modes.select.selected])}},deactivate:function(){DeviceConfiguration.setKeyboard(!1);b();unregisterPositionHandlers(board);_.each(boardContent.multiWordTexts,function(a){a.doc.isActive=!1;0==a.doc.documentRange().plainText().trim().length&&
delete boardContent.multiWordTexts[a.identity]});Modes.select.clearSelection();blit()}}}(),video:function(){var c={},f=void 0,g=void 0,q=function(){f.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=g.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();g.unwrap()},l=function(a){if(void 0!=c&&void 0!=c.fileUpload&&void 0!=a){$("#videoWorking").show();$("#videoFileChoice").hide();var b=new FileReader;b.onload=function(b){var d=$("<video/>"),g=d[0],f=b.target.result;g.addEventListener("loadeddata",
function(b){b=g.videoHeight;c.width=g.videoWidth;c.height=b;c.video=d;c.videoSrc=f;a()},!1);d.append($("<source />",{src:f,type:"video/mp4"}));d.load()};b.readAsDataURL(c.fileUpload)}},m=function(){if("imageDefinition"==c.type){WorkQueue.pause();var a=Date.now(),b=sprintf("%s%s",UserSettings.getUsername(),a),d=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),encodeURI(b));$.ajax({url:b,type:"POST",success:function(b){var g=$(b).find("resourceUrl").text(),
f={type:"video",author:UserSettings.getUsername(),timestamp:a,identity:g,slide:d.toString(),source:$(b).text(),bounds:[c.x,c.y,c.x+c.width,c.y+c.height],width:c.width,height:c.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:c.x,y:c.y,audiences:_.map(Conversations.getCurrentGroup(),"id").map(permitStudentsToPublishCheckbox)};registerTracker(g,function(){var a=Modes.select.handlesAtZoom(),c=f.x,b=f.y,d=Math.max(f.width,viewboxWidth),k=Math.max(f.height,viewboxHeight);Modes.select.activate();
IncludeView.specific(c-a,b-a,d+2*a,k+2*a);Modes.select.clearSelection();Modes.select.selected.videos[f.identity]=boardContent.videos[f.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(f);q();WorkQueue.gracefullyResume()},error:function(a){console.log("Image upload ex",a);resetImageUpload();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},
data:c.videoSrc,cache:!1,contentType:!1,processData:!1})}},a=!1;$(function(){a||(a=!0,f=$("#videoInsertOptions").css({position:"absolute",left:0,top:0}),$("#videoInsertOptionsClose").click(Modes.select.activate),g=$("#videoFileChoice").attr("accept","video/mp4"),g[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("video")&&(c.fileUpload=a);l(m)},!1),q())});Progress.beforeLeavingSlide.videos=function(){"videos"in boardContent&&_.forEach(boardContent.videos,
function(a){null!=a&&void 0!=a&&"destroy"in a&&a.destroy()})};return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.video;d("#insertTools","#videoMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$("#insertMode").addClass("activeTool").removeClass("inactiveTool");$(".active").removeClass("active");$("#videoMode").addClass("active");$("#insertTools .insetColumn").hide();$("#videoTools").show();var a=screenToWorld(10,10);c={type:"imageDefinition",
screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");f.show()},deactivate:function(){q();b()}}}(),image:function(){var c={},f=void 0,g=void 0,q=function(){f.hide();$("#imageWorking").hide();$("#imageFileChoice").show();var a=g.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();g.unwrap()},l=function(){var a=function(a,c,b,d){for(var e=c*b;e>a;)c*=.8,b*=.8,e=c*b;return{w:c,h:b,q:d}},c={"native":{resizeFunc:function(a,c){return{w:a,h:c,q:1}},selector:"#imageInsertNative"},optimized:{resizeFunc:function(c,
b){return a(1*d,c,b,.4)},selector:"#imageInsertOptimized"},highDef:{resizeFunc:function(c,b){return a(3*d,c,b,.8)},selector:"#imageInsertHighDef"}},b=c.optimized,d=1048576,g=function(){_.forEach(c,function(a){var c=$(a.selector);b.selector==a.selector?c.addClass("activeBrush"):c.removeClass("activeBrush")})};$(function(){_.forEach(c,function(a){$(a.selector).on("click",function(){b=a;g()})});g()});return{reapplyVisualStyle:g,changeMode:function(a){a in c&&(b=c[a],g())},getResizeFunction:function(){return b.resizeFunc}}}(),
m=function(b,d){var g=void 0==d?c:d;if(void 0==g||void 0==g.fileUpload||void 0==b)console.log("returning because currentImage is empty",c);else{$("#imageWorking").show();$("#imageFileChoice").hide();var f=new FileReader;f.onload=function(c){var d=c.target.result;a(d,g,b,function(a){return d.length<a})};f.readAsDataURL(g.fileUpload)}},a=function(a,b,d,g){var f=void 0!=b?b:c,h=$("<canvas/>"),p=new Image;0!=a.indexOf("data")&&p.setAttribute("crossOrigin","Anonymous");p.onerror=function(a){errorAlert("Error dropping image",
"The source server you're dragging the image from does not allow dragging the image directly.  You may need to download the image first and then upload it.")};p.onload=function(c){var b=p.width,e=p.height,n=l.getResizeFunction()(b,e);c=n.w;var q=n.h,n=n.q;h.width=b;h.height=e;h.attr("width",b);h.attr("height",e);h.css({width:px(b),height:px(e)});var m=h[0].getContext("2d");m.rect(0,0,b,e);m.fillStyle="white";m.fill();m.drawImage(p,0,0,b,e);b=multiStageRescale(h[0],c,q);f.width=c;f.height=q;f.resizedImage=
b.toDataURL("image/jpeg",n);g(f.resizedImage.length)&&(f.resizedImage=a);d(f)};p.src=a},t=function(a){if("imageDefinition"==a.type){WorkQueue.pause();var c=Date.now(),b=sprintf("%s%s%s",UserSettings.getUsername(),c,_.uniqueId()),d=Conversations.getCurrentSlideJid(),b=sprintf("/uploadDataUri?jid=%s&filename=%s",d.toString(),encodeURI(b));$.ajax({url:b,type:"POST",success:function(b){var g=$(b).find("resourceUrl").text(),f={type:"image",author:UserSettings.getUsername(),timestamp:c,tag:'{"author":"'+
UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+g+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:g,slide:d.toString(),source:$(b).text(),bounds:[a.x,a.y,a.x+a.width,a.y+a.height],width:a.width,height:a.height,x:a.x,y:a.y,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),audiences:_.map(Conversations.getCurrentGroup(),"id").concat(ContentFilter.getAudiences()).map(audienceToStanza)};registerTracker(g,function(){var a=Modes.select.handlesAtZoom(),
b=f.x,c=f.y,d=Math.max(f.width,viewboxWidth),g=Math.max(f.height,viewboxHeight);Modes.select.activate();IncludeView.specific(b-a,c-a,d+2*a,g+2*a);Modes.select.clearSelection();Modes.select.selected.images[f.identity]=boardContent.images[f.identity];Progress.call("onSelectionChanged",[Modes.select.selected])});sendStanza(f);q();WorkQueue.gracefullyResume();zoomToFit()},error:function(a){console.log(a);q();errorAlert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:a.resizedImage,cache:!1,contentType:!1,processData:!1})}},x=!1;$(function(){x||(x=!0,f=$("#imageInsertOptions").css({position:"absolute",left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),g=$("#imageFileChoice").attr("accept","image/*"),g[0].addEventListener("change",function(a){try{var b=(a.target.files||a.dataTransfer.files)[0];0==b.type.indexOf("image")&&(c.fileUpload=b);m(t)}catch(d){console.log("imageFileChoiceHandleChanged exception:",
d)}},!1),q())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.image;d("#insertTools","#imageMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$("#insertMode").addClass("activeTool").removeClass("inactiveTool");$(".active").removeClass("active");$("#imageMode").addClass("active");$("#insertTools .insetColumn").hide();$("#imageTools").show();var a=screenToWorld(10,10);c={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");
l.reapplyVisualStyle();f.show()},handleDroppedSrc:function(b,c,d){console.log("handleDroppedSrc:",b,c,d);var g=screenToWorld(c,d);a(b,{type:"imageDefinition",screenX:c,screenY:d,x:g.x,y:g.y},t,function(a){return!1})},handleDrop:function(a,b,c){var d=0,g=[];console.log("handling drop:",a,b,c);var f=function(a,f){try{if(void 0!=a&&null!=a&&"type"in a&&0==a.type.indexOf("image")&&!_.some(g,function(b){return b==a})){var k=screenToWorld(b,c+d),e={type:"imageDefinition",screenX:b,screenY:c+d,x:k.x,y:k.y};
e.fileUpload=a;g.push(a);m(t,e);d+=50}}catch(h){console.log("could not processFile:",a,f)}};_.forEach(a.files,function(a){f(a,"file")});_.forEach(a.items,function(a){try{var b=a.getAsFile(0);f(b,"item")}catch(c){console.log("could not get item as file:",c)}})},deactivate:function(){q();b()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");Modes.currentMode.deactivate();d("#panTools","#panMode");Modes.currentMode=Modes.pan;var b,f;registerPositionHandlers(board,function(d,q,l){takeControlOfViewbox();
b=d;f=q},function(d,q,l){Pan.translate(-1*(d-b),-1*(q-f));b=d;f=q},function(b,c,d){})},deactivate:function(){b();unregisterPositionHandlers(board)}},select:function(){var c=!1,f=function(){Modes.select.selected={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}};Progress.call("onSelectionChanged",[Modes.select.selected])},g=_.debounce(function(){var a=!1;_.forEach("images texts inks highlighters multiWordTexts videos".split(" "),function(b){var c="highlighters"==b?"inks":b;if(Modes&&Modes.select&&
Modes.select.selected&&c in Modes.select.selected){var d=Modes.select.selected[c];_.forEach(d,function(g){d&&b in boardContent&&g&&g.identity in boardContent[b]?d[g.identity]=boardContent[b][g.identity]:(a=!0,"inks"==c?"highlighters"==b&&g.identity in d&&1==d[g.identity].isHighlighter?delete d[g.identity]:"inks"==b&&g.identity in d&&0==d[g.identity].isHighlighter&&delete d[g.identity]:delete d[g.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),q=function(){if(void 0!=
Modes.select.selected&&c&&"Blacklist"in window){var a=Modes.select.selected;Blacklist.banSelection(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),a.inks,a.texts,a.multiWordTexts,a.images,a.videos)}f()},l=function(){(c=Conversations.shouldModifyConversation()?!c:!1)?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush");f();blit()},m=function(a){Conversations.shouldModifyConversation(a)?($("#ban").show(),$("#ban").removeClass("disabledButton"),
$("#administerContent").show(),$("#administerContent").removeClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#ban").hide(),$("#administerContent").addClass("disabledButton"),$("#administerContent").hide());c?$("#administerContent").addClass("activeBrush"):$("#administerContent").removeClass("activeBrush")};Progress.onBoardContentChanged.ModesSelect=g;Progress.onViewboxChanged.ModesSelect=g;Progress.onSelectionChanged.ModesSelect=function(a){a&&(Modes.select.selected=a,"images"in
a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||"multiWordTexts"in a&&0<_.size(a.multiWordTexts)||"videos"in a&&0<_.size(a.videos)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),c?($("#ban").removeClass("disabledButton"),$("#delete").addClass("disabledButton")):($("#ban").addClass("disabledButton"),$("#delete").removeClass("disabledButton"))):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),
$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?$("#ban").show():$("#ban").hide(),Modes.currentMode==Modes.select&&$("#selectionAdorner").empty())};Progress.historyReceived.ModesSelect=f;Progress.conversationDetailsReceived.ModesSelect=function(a){c&&!Conversations.shouldModifyConversation(a)&&(c=!1);Conversations.shouldModifyConversation(a)?($("#administerContent").unbind("click").bind("click",l),$("#ban").unbind("click").bind("click",q)):
($("#administerContent").unbind("click"),$("#ban").unbind("click"));m(a)};return{name:"select",isAdministeringContent:function(){return c},selected:{images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},resizeHandleSize:20,setSelection:function(a){Modes.select.selected=_.merge(Modes.select.selected,a)},handlesAtZoom:function(){var a=scale();return Modes.select.resizeHandleSize/a},totalSelectedBounds:Bench.track("Modes.select.totalSelectedBounds",function(){var a={x:Infinity,y:Infinity,x2:-Infinity,
y2:-Infinity},b=function(b){b=b.bounds;a.x=Math.min(a.x,b[0]);a.y=Math.min(a.y,b[1]);a.x2=Math.max(a.x2,b[2]);a.y2=Math.max(a.y2,b[3])};_.forEach(Modes.select.selected.inks,b);_.forEach(Modes.select.selected.texts,b);_.forEach(Modes.select.selected.images,b);_.forEach(Modes.select.selected.multiWordTexts,b);_.forEach(Modes.select.selected.videos,b);a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a}),offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},
resizing:!1,dragging:!1,aspectLocked:!1,clearSelection:f,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;d("#selectTools","#selectMode");var a={x:0,y:0},b=$("<div/>",{id:"selectMarquee"}),g=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected&&!c){var a=batchTransform();a.isDeleted=!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));"texts"in Modes.select.selected&&(a.textIds=_.keys(Modes.select.selected.texts));
"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));"videos"in Modes.select.selected&&(a.videoIds=_.keys(Modes.select.selected.videos));sendStanza(a);_.forEach(_.union(Modes.select.selected.inks,Modes.select.selected.texts,Modes.select.selected.images,Modes.select.selected.multiWordTexts,Modes.select.selected.videos),function(a){Progress.call("onCanvasContentDeleted",
[a])});f()}});var q=function(a){a("images");a("texts");a("multiWordTexts");a("inks");a("videos")};Modes.select.dragging=!1;m();Modes.select.resizing=!1;registerPositionHandlers(board,function(c,d,f,q,h){Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:c,y:d};Modes.select.marqueeWorldOrigin=q;if(!h.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){c=3/scale();var m=[q.x-c,q.y-c,q.x+c,q.y+c];Modes.select.dragging=_.some(["images","texts","inks","multiWordTexts","videos"],function(a){return _.some(Modes.select.selected[a],
function(a){return a?intersectRect(a.bounds,m):!1})})}Modes.select.dragging?(Modes.select.offset=q,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):(g.empty(),g.append(b),b.show(),updateMarquee(b,a,a))},function(c,d,g,f,q){c={x:c,y:d};Modes.select.offset=f;Modes.select.dragging?blit():Modes.select.resizing?blit():updateMarquee(b,a,c)},function(a,d,g,f,h){WorkQueue.gracefullyResume();try{var m=f.x-Modes.select.marqueeWorldOrigin.x,l=f.y-Modes.select.marqueeWorldOrigin.y;
15>Math.abs(m)+Math.abs(l)&&(Modes.select.dragging=!1);if(Modes.select.dragging){Modes.select.totalSelectedBounds();_.each(Modes.select.selected.multiWordTexts,function(a,b){Modes.text.echoesToDisregard[b]=!0});Modes.text.mapSelected(function(a){a.doc.position.x+=m;a.doc.position.y+=l;a.doc.invalidateBounds()});var k=batchTransform();k.xTranslate=m;k.yTranslate=l;k.inkIds=_.keys(Modes.select.selected.inks);k.textIds=_.keys(Modes.select.selected.texts);k.imageIds=_.keys(Modes.select.selected.images);
k.videoIds=_.keys(Modes.select.selected.videos);k.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;registerTracker(k.identity,function(){Progress.call("onSelectionChanged");blit()});sendStanza(k)}else{var e=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,f,2),r=[e.left,e.top,e.right,e.bottom],A={images:{},texts:{},inks:{},multiWordTexts:{},videos:{}},z={},C={};q(function(a){$.each(boardContent[a],function(b,d){if(!("bounds"in d)&&"type"in d)switch(d.type){case "text":prerenderText(d);
break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;case "video":prerenderVideo(d);break;default:d.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(r,d.bounds)&&(incrementKey(z,d.author),incrementKey(C,"any"),c?d.author!=UserSettings.getUsername()&&(A[a][d.identity]=d):d.author==UserSettings.getUsername()&&(A[a][d.identity]=d))})});$.each(boardContent.highlighters,function(a,b){intersectRect(b.bounds,r)&&(incrementKey(z,b.author),c?b.author!=UserSettings.getUsername()&&(A.inks[b.identity]=
b):b.author==UserSettings.getUsername()&&(A.inks[b.identity]=b))});q(function(a){$.each(A[a],function(b,c){a in Modes.select.selected||(Modes.select.selected[a]=[]);a in Modes.select.selected&&b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=c})});C.any||Modes.select.clearSelection();var D=sprintf("Selected %s images, %s texts, %s inks, %s rich texts, %s videos ",_.keys(Modes.select.selected.images).length,_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,
_.keys(Modes.select.selected.inks).length,_.keys(Modes.select.selected.videos).length);$.each(z,function(a,b){D+=sprintf("%s:%s ",a,b)});Progress.call("onSelectionChanged",[Modes.select.selected])}b.css({width:0,height:0}).hide();blit()}catch(E){console.log("Selection up ex",E)}})},deactivate:function(){unregisterPositionHandlers(board);b();f();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();m();blit();blit()}}}(),zoom:{name:"zoom",
activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.zoom;d("#zoomTools","#zoomMode");var b=$("<div />",{id:"zoomMarquee"}),f,g={x:0,y:0};registerPositionHandlers(board,function(d,l,m,a){takeControlOfViewbox();f=a;b.show();b.appendTo($("#selectionAdorner"));g={x:d,y:l};updateMarquee(b,g,g)},function(d,f,m,a){d={x:d,y:f};f=rectFromTwoPoints(d,g);m="left";a="top";d.x==f.left&&(m="right");d.y==f.top&&(a="bottom");d=aspectConstrainedRect(f,m,a);updateMarquee(b,{x:d.right,y:d.bottom},
{x:d.left,y:d.top})},function(d,g,m,a){WorkQueue.gracefullyResume();b.hide();d={x:contentOffsetX+a.x,y:contentOffsetY+a.y};g=rectFromTwoPoints(d,{x:contentOffsetX+f.x,y:contentOffsetY+f.y});2500>scale()*g.width*g.height||(m="left",a="top",d.x==g.left&&(m="right"),d.y==g.top&&(a="bottom"),d=aspectConstrainedRect(g,m,a),IncludeView.specific(d.left,d.top,d.width,d.height))})},deactivate:function(){b();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},feedback:function(){var c=function(){Conversations.shouldModifyConversation()?
(console.log("showing participants button"),$("#participantsButton").unbind("click").on("click",function(){Participants.openMenu()}).show()):(console.log("hiding participants button"),$("#participantsButton").unbind("click").hide());switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){c()};Progress.conversationDetailsReceived.respectNewPermissions=c;
return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;c();d("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(b,c,d,f){},function(b,c,d,f){},function(b,c,d,f){});c()},deactivate:function(){b();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),draw:function(){var c=Brushes.getDefaultBrushes(),f=_.map(c,function(a){return _.clone(a)}),g,l=!1,z=void 0,m=void 0,a=function(a){f[a.index]=a},t=function(){},
x=function(){},u=function(){};$(function(){var b,d;$(".activeBrush").removeClass("activeBrush");var y=function(){var b=$("#drawTools");_.each(b.find(".modeSpecificTool.pen"),function(b,c){var d=f[c],k=$(b).css({color:d.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");g=d;a(d);Modes.draw.drawingAttributes=g;l=!1;w(d)}).removeClass("fa-tint").removeClass("fa-circle").addClass(d.isHighlighter?"fa-circle":"fa-tint");k.find(".widthIndicator").text(d.width);
d==g&&k.addClass("activeBrush")})},w=function(b){var c=$("#colors .dots"),d=$("#sizes .dots"),f=Colors.getAllNamedColors(),h=Brushes.getAllBrushSizes();d.empty();h.map(function(c){var e=z.clone();d.append(e);e.click(function(){b.width=c;a(b);g=b;y();w(b)});var f=Canvas.circle(b.color,c,50);c==b.width&&e.addClass("activeTool");e.prepend(f);f=c.toString()+"px";e.find(".sizeDotName").append(f)});c.empty();f.map(function(d){var f=m.clone();c.append(f);f.on("click",function(){b.color=d.rgb;g=b;a(b);y();
w(b)});f.css("color",d.rgb);"rgb"in d&&d.rgb==b.color&&f.addClass("activeTool");var h=d.name;f.find(".colorDotName").append(h)});f=$("#setPenToHighlighter").unbind("click").on("click",function(){b.isHighlighter=!0;g=b;a(b);y();w(b)});h=$("#setPenToPen").unbind("click").on("click",function(){b.isHighlighter=!1;g=b;a(b);y();w(b)});"isHighlighter"in g&&g.isHighlighter?(f.addClass("activeTool").addClass("active"),h.removeClass("activeTool").removeClass("active")):(h.addClass("activeTool").addClass("active"),
f.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").click(function(){var a=_.find(c,function(a){return a.id==g.id});void 0!=a&&(g.width=a.width,g.color=a.color,g.isHighlighter=a.isHighlighter,y(),w(g))});z=$("#penSize .sizeDot").clone();m=$("#penColor .colorDot").clone();g=f[0];y();w(g);var h=$("#drawTools");h.find(".eraser").unbind("click").on("click",function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");l=!0;
$("#drawDropdowns").hide()});h.find(".advancedTools").unbind("click").on("click",function(){l||(w(g),$("#drawDropdowns").toggle())});$("#closePenDialog").unbind("click").on("click",function(){$("#drawDropdowns").hide()});var p=[];x=function(a,c,f,g,h){v=[];l||h.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,boardContext.fillStyle=Modes.draw.drawingAttributes.color,boardContext.globalAlpha=Modes.draw.drawingAttributes.isHighlighter?.4:1,p=[g.x,g.y,256*f],b=a,d=c,boardContext.beginPath(),
boardContext.arc(a,c,Modes.draw.drawingAttributes.width*f/2,0,2*Math.PI),boardContext.fill())};var v=[];d=b=void 0;u=function(a,c,f,g,h){a=Math.round(a);c=Math.round(c);if(l||h.eraser){var m=[g.x-10,g.y-10,g.x+10,g.y+10];f=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,m)){delete a[c.identity];v.push(c);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=
.4;boardContext.fillStyle="red";f(boardContent.inks);f(boardContent.highlighters);boardContext.globalAlpha=1}else h=Modes.draw.drawingAttributes.width*f,boardContext.beginPath(),boardContext.lineCap="round",boardContext.lineWidth=h,_.takeRight(p,3),boardContext.moveTo(b,d),boardContext.lineTo(a,c),boardContext.stroke(),p=p.concat([g.x,g.y,256*f]);b=a;d=c};t=function(a,c,f,g,h){l||h.eraser?(a=batchTransform(),a.isDeleted=!0,a.inkIds=_.map(v,function(a){return a.identity}),_.forEach(v,function(a){Progress.call("onCanvasContentDeleted",
[a])}),sendStanza(a)):(h=Modes.draw.drawingAttributes.width*f,boardContext.lineWidth=h,boardContext.beginPath(),boardContext.lineWidth=h,boardContext.lineCap="round",boardContext.moveTo(b,d),boardContext.lineTo(a,c),boardContext.stroke(),p=p.concat([g.x,g.y,256*f]),strokeCollected(p));boardContext.globalAlpha=1}});return{name:"draw",brushes:f,mousePressure:256,activate:function(){boardContext.setLineDash([]);Modes.currentMode!=Modes.draw&&(Modes.currentMode.deactivate(),Modes.currentMode=Modes.draw,
Modes.draw.drawingAttributes=g,d("#drawTools","#drawMode"),$(".activeBrush").removeClass("activeBrush"),l?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".modeSpecificTool.pen"),function(a,b){b+1==g.id&&$(a).addClass("activeBrush")}),registerPositionHandlers(board,x,u,t))},deactivate:function(){$(".activeBrush").removeClass("activeBrush");$("#drawDropdowns").hide();b();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&
window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.erase;registerPositionHandlers(board,function(b,d,f,l){},function(b,d,f,l){},function(b,d,f,l){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
