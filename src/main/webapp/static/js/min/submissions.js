var Submissions=function(){var d=[],c={},k={},e=function(){WorkQueue.enqueue(function(){c.jsGrid("loadData");var a=c.jsGrid("getSorting");"field"in a&&c.jsGrid("sort",a)})};$(function(){var a=function(){c=$("#submissionsDatagrid");k=c.find(".insertOnNextSlideButtonContainer");c.empty();var a=function(a){jsGrid.Field.call(this,a)};a.prototype=new jsGrid.Field({sorter:function(a,b){return new Date(a)-new Date(b)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},
editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;var a=[{name:"url",type:"text",title:"Preview",readOnly:!0,sorting:!1,itemTemplate:function(a,b){var c=sprintf("/submissionProxy/%s/%s/%s",Conversations.getCurrentConversationJid(),b.author,b.identity);return $("<img/>",{src:c,"class":"submissionThumbnail",style:"max-height:100px;max-width:100%;cursor:zoom-in"}).on("click",function(){var a=sprintf("/submissionProxy/%s/%s/%s",
Conversations.getCurrentConversationJid(),b.author,b.identity),c=sprintf("Submission from %s at %s on page %s",b.author,new Date(b.timestamp),b.slide);$.jAlert({title:c,closeOnClick:!0,width:"90%",content:$("<img/>",{src:a})[0].outerHTML})})}},{name:"slide",type:"number",title:"Page",readOnly:!0},{name:"timestamp",type:"dateField",title:"When",readOnly:!0},{name:"author",type:"text",title:"Who",readOnly:!0}],b=[{name:"identity",type:"text",title:"actions",readOnly:!0,sorting:!1,itemTemplate:function(a,
b){var c=k.clone();c.find(".insertOnNextSlideButton").on("click",function(){addSubmissionSlideToConversationAtIndex(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlide().index+1,b.identity)});return c}}];Conversations.shouldModifyConversation()&&(a=a.concat(b));c.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No submissions",controller:{loadData:function(a){if("sortField"in a){var b=_.sortBy(_.filter(d,f),function(b){return b[a.sortField]});
"sortOrder"in a&&"desc"==a.sortOrder&&(b=_.reverse(b));return b}return _.filter(d,f)}},pageLoading:!1,fields:a});c.jsGrid("sort",{field:"timestamp",order:"desc"});e()},b=function(){Conversations.inConversation()?a():_.delay(b,500)};b()});var f=function(a){return Conversations.shouldModifyConversation()||a.author.toLowerCase()==UserSettings.getUsername().toLowerCase()},g=function(){d=[]},h=function(a,b){try{"target"in a&&"submission"==a.target&&f(a)&&(d.push(a),b||e())}catch(c){console.log("Submissions.stanzaReceivedFunction",
c)}};Progress.onConversationJoin.Submissions=g;Progress.historyReceived.Submissions=function(a){try{"type"in a&&"history"==a.type&&(g(),_.forEach(a.submissions,function(a){h(a,!0)}),e())}catch(b){console.log("Submissions.historyReceivedFunction",b)}};return{getAllSubmissions:function(){return _.filter(d,f)},getCurrentSubmission:function(){return currentSubmission},processSubmission:h,sendSubmission:function(){WorkQueue.pause();var a=$("<canvas />"),b=board[0].width,c=board[0].height;a.width=b;a.height=
c;a.attr("width",b);a.attr("height",c);a.css({width:b,height:c});var d=a[0].getContext("2d");d.fillStyle="white";d.fillRect(0,0,b,c);d.drawImage(board[0],0,0,b,c);var a=a[0].toDataURL("image/jpeg",.4),e=(new Date).getTime(),f=UserSettings.getUsername(),k=Conversations.getCurrentSlide().id,b=Conversations.getCurrentConversation().jid,g=sprintf("submission%s%s.jpg",f,e.toString()),h=sprintf("%s:%s:%s",b,g,e),b=sprintf("/uploadDataUri?jid=%s&filename=%s",b.toString(),encodeURI(h));$.ajax({url:b,type:"POST",
success:function(a){a=$(a).find("resourceUrl").text();a={audiences:[],author:f,blacklist:[],identity:h,privacy:Privacy.getCurrentPrivacy(),slide:k,target:"submission",timestamp:e,title:g,type:"submission",url:a};console.log(a);sendStanza(a);WorkQueue.gracefullyResume();successAlert("Submission sent","Your submission has been sent to the instructor")},error:function(a){console.log(a);errorAlert("Submission failed","This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");
WorkQueue.gracefullyResume()},data:a,cache:!1,contentType:!1,processData:!1})},requestServerSideSubmission:function(){if("Conversations"in window){var a=Conversations.getCurrentConversation(),b=Conversations.getCurrentSlideJid();"jid"in a&&submitScreenshotSubmission(a.jid.toString(),b)}},reRender:e}}();
