var Submissions=function(){var c={},h={},k={},f={},d=[],e={};$(function(){c=$("#submissionListing");h=c.find(".submissionSummary").clone();f=$("#currentSubmission");k=f.find(".submissionContainer").clone();c.empty();$("#submissions").click(function(){showBackstage("submissions")});var a=$("<div />",{id:"submissionCount","class":"icon-txt"});$("#feedbackStatus").prepend(a);a.click(function(){showBackstage("submissions")});l()});var l=function(){var a=_.size(_.filter(d,g));0<a?1==a?($("#submissionCount").text(sprintf("%s submission",
a)),$("#dedicatedSubmissionCount").text("This conversation has 1 submission")):($("#submissionCount").text(sprintf("%s submissions",a)),$("#dedicatedSubmissionCount").text(sprintf("This conversation has %s submissions",a))):($("#submissionCount").text(""),$("#dedicatedSubmissionCount").text(sprintf("This conversation has %s submissions",a)))},g=function(a){return Conversations.shouldModifyConversation()||a.author.toLowerCase()==UserSettings.getUsername().toLowerCase()},m=function(){d=[];e={};$("#submissionCount").text("")},
p=function(){c.empty();_.filter(d,g).map(function(a){r(a)});f.html(n(e));l()},r=function(a){if("type"in a&&"submission"==a.type){var b=h.clone();c.append(b);b.find(".submissionDescription").text(sprintf("submitted by %s at %s %s",a.author,(new Date(a.timestamp)).toDateString(),(new Date(a.timestamp)).toLocaleTimeString()));b.find(".submissionImageThumb").attr("src",sprintf("/submissionProxy/%s/%s/%s",Conversations.getCurrentConversationJid(),a.author,a.identity));b.find(".viewSubmissionButton").attr("id",
sprintf("viewSubmissionButton_%s",a.identity)).on("click",function(){e=a;f.html(n(e))})}},n=function(a){var b=$("<div />");if("type"in a&&"submission"==a.type)if(b=k.clone(),b.attr("id",sprintf("submission_%s",a.identity)),b.find(".submissionDescription").text(sprintf("submitted by %s at %s",a.author,a.timestamp)),b.find(".submissionImage").attr("src",sprintf("/submissionProxy/%s/%s/%s",Conversations.getCurrentConversationJid(),a.author,a.identity)),Conversations.shouldModifyConversation())b.find(".displaySubmissionOnNextSlide").on("click",
function(){addSubmissionSlideToConversationAtIndex(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlide().index+1,a.identity)});else b.find("submissionTeacherControls").hide();return b},q=function(a,b){try{"target"in a&&"submission"==a.target&&g(a)&&(d.push(a),b||p())}catch(c){console.log("Submissions.stanzaReceivedFunction",c)}};Progress.onConversationJoin.Submissions=m;Progress.historyReceived.Submissions=function(a){try{"type"in a&&"history"==a.type&&(m(),_.forEach(a.submissions,
function(a){q(a,!0)}),p())}catch(b){console.log("Submissions.historyReceivedFunction",b)}};return{getAllSubmissions:function(){return _.filter(d,g)},getCurrentSubmission:function(){return e},processSubmission:q}}();
