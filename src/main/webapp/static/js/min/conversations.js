var Conversations=function(){var f="",l=[],c={},g=0,h="",D=0,m=!1,E=void 0,v=void 0,x=function(){var a=!1,b=!1;return{checkIsBanned:function(d,c){var N=b,F=w(d);1==c&&(b=a=!1);!a&&F&&(b=a=!0,warningAlert("Banned","You have been banned from contributing publically to this class because you published some inappropriate content that is deemed to be contrary to the expectations of the university.\r\nThe content has been deleted on every screen, but the instructor has a record of your action.\r\nYou must contact your instructor in order to be reinstated as a contributing member of the classroom community."));
1==N&&0==F&&(a=b=!1,successAlert("Unbanned","The instructor has unbanned you.  You are once again permitted to contribute publicly in this class."))},reset:function(){b=a=!1}}}();$(function(){v=$("#searchResults");E=v.find(".searchResultItem").clone();v.empty()});var y=function(){var a={},b=function(b,d,c){d=sprintf("/thumbnailDataUri/%s",b.id);$.ajax({url:d,beforeSend:function(a){a.overrideMimeType("text/plain; charset=x-user-defined")},dataType:"text"}).done(function(d){a[b.id]={data:d,when:Date.now()};
c.attr("src",d)})},d=function(a,b){var d=$("<canvas />");d.width=a;d.height=b;d.attr("width",a);d.attr("height",b);var c=d[0].getContext("2d");c.rect(0,0,a,b);c.fillStyle="white";c.fill();return d[0].toDataURL()}(320,240),e=function(c){var e=$("#thumbScrollContainer"),f=e.height(),e=e.find(sprintf("#slideContainer_%s",c.id));try{var g=e.find("img"),h=e.position().top,k=h+e.height();if(h==k)g.attr("src",d);else if(0<=k&&h<=f){var l=e.find("img");c.id in a&&a[c.id].when>Date.now()-1E4?l.attr("src",
a[c.id].data):b(c,e,l)}}catch(m){console.log("exception while painting thumb: ",m)}};return{paintThumb:e,paintAllThumbs:_.debounce(function(){_.forEach(c.slides,function(a){var b=$(sprintf("#slideContainer_%s img",a.id));0==b.height()||void 0==b.height()?(b.on("load",function(){b.off("load");e(a)}),b.attr("src",d)):e(a)})},500),clearCache:function(){a={}}}}(),O=function(a){return!("slides"in c)||"slides"in a&&_.some(a,function(a,d){var e=c.slides[d];return e&&"id"in e&&"id"in a&&"index"in a&&"index"in
e&&e.id==a.id&&e.index==a.index?!1:!0})},p=function(){try{y.paintAllThumbs()}catch(a){console.log("exception while painting thumbs",a)}G()},Q=function(){updateStatus("Refreshing slide display");var a=$("#slideContainer");a.html(unwrap(c.slides.sort(function(a,b){return a.index-b.index}).map(P)));var b=$("#slideControls");b.empty();z("prevSlideButton","Prev Slide","fa-angle-left",H,b);z("nextSlideButton","Next Slide","fa-angle-right",H,b);z("addSlideButton","Add Slide","fa-plus",k,b);a.off("scroll");
a.on("scroll",p);A(g);Progress.call("onLayoutUpdated")},I=function(a){var b=c.permissions;changePermissionsOfConversation(c.jid.toString(),{studentCanOpenFriends:b.studentCanOpenFriends,studentCanPublish:a,usersAreCompulsorilySynced:b.usersAreCompulsorilySynced})},J=function(a){var b=c.permissions;changePermissionsOfConversation(c.jid.toString(),{studentCanOpenFriends:b.studentCanOpenFriends,studentCanPublish:b.studentCanPublish,usersAreCompulsorilySynced:a})},q=function(){m=!0;B()},r=function(){"permissions"in
c&&!k(c)&&c.permissions.usersAreCompulsorilySynced||(m=!1,B())},B=function(){m?($("#enableSync").addClass("activePrivacy active"),$("#disableSync").removeClass("activePrivacy active")):($("#enableSync").removeClass("activePrivacy active"),$("#disableSync").addClass("activePrivacy active"));$("#followTeacherCheckbox").prop("checked",m)},R=function(a){(!k(c)||!UserSettings.getIsInteractive())&&"slides"in c&&0<c.slides.filter(function(b){return b.id.toString()==a.toString()}).length&&(D=a,Conversations.getIsSyncedToTeacher()&&
g!=a&&(g=a,n(a)))},K=function(){if("slides"in c&&0<g){var a=_.find(c.slides,function(a){return a.id==g}),b=_.find(c.slides,function(b){return b.index==a.index+1});void 0!=b&&"id"in b&&n(b.id.toString())}},L=function(){if("slides"in c&&0<g){var a=_.find(c.slides,function(a){return a.id==g}),b=_.find(c.slides,function(b){return b.index==a.index-1});void 0!=b&&"id"in b&&n(b.id.toString())}},t=function(){var a=window.location.origin,b=sprintf("/join?conversation=%s&slide=%s",h,g),d=sprintf("/projector/%s",
h);$("#shareLink").html($("<a/>",{href:b,text:a+b}));$("#projectorLink").html($("<a/>",{href:d,text:a+d})).on("click",bounceAnd(function(){var a=document.documentElement;(a.requestFullScreen||a.webkitRequestFullScreen||a.mozRequestFullScreen).call(a);DeviceConfiguration.setCurrentDevice("projector");return!1}));""==h||0==g?($("#projectorViewLink").empty(),$("#slideDeepLink").empty(),$("#conversationDeepLink").empty(),$("#conversationAnalysis").empty(),$("#oneNoteExport").empty()):($("#projectorViewLink").html($("<a/>",
{href:sprintf("/board?conversationJid=%s&slideId=%s&showTools=false&unique=true",h,g),text:"Project this conversation"})),$("#conversationAnalysis").html($("<a/>",{href:sprintf("/dashboard?source=%s",h),text:"Dashboard for this conversation"})),$("#slideDeepLink").html($("<a/>",{href:sprintf("/board?conversationJid=%s&slideId=%s&unique=true",h,g),text:"DeepLink this slide"})),$("#conversationDeepLink").html($("<a/>",{href:sprintf("/board?conversationJid=%s&unique=true",h),text:"Deeplink this conversation"})),
$("#oneNoteExport").html($("<a/>",{href:sprintf("/saveToOneNote/%s",h),text:"Export this conversation"})))},S=function(a){var b=k(a),d=$("#studentsCanPublishCheckbox");d.off("change");d.prop("checked",a.permissions.studentCanPublish);d.prop("disabled",!b);if(b)d.on("change",function(){I(d.is(":checked"))});var c=$("#studentsMustFollowTeacherCheckbox");c.off("change");c.prop("checked",a.permissions.usersAreCompulsorilySynced);c.prop("disabled",!b);var f=$("#followTeacherCheckbox");f.off("change");
f.prop("checked",m);if(b)c.on("change",function(){J(c.is(":checked"))});else f.on("change",function(){var a=m,b=f.is(":checked");a!=b&&(b?q():r())});f.prop("disabled",a.permissions.usersAreCompulsorilySynced);b?($("#syncButtons").hide(),$(".syncCheckbox").hide()):($("#syncButtons").show(),$(".syncCheckbox").show())},U=function(a){a.jid==c.jid&&(!k(a)&&a.permissions.usersAreCompulsorilySynced&&q(),S(a),updateConversationHeader(),t(),B(),O(a)&&Q());T(a)},T=function(a){l=l.map(function(b){return b.jid==
a.jid?a:b});u()},k=function(a){a||(a=c);return"jid"in a?"author"in a&&a.author.toLowerCase()==UserSettings.getUsername().toLowerCase()||"UserSettings"in window&&_.some(UserSettings.getUserGroups(),function(a){var d=a.name?a.name:a.value;return"special"==(a.key?a.key:a.ouType)&&"superuser"==d})?!0:!1:!1},w=function(a){a||(a=c);return"blacklist"in a&&_.includes(a.blacklist,UserSettings.getUsername())},C=function(a){a||(a=c);var b="subject"in a?a.subject.toLowerCase().trim():"nosubject";return"subject"in
a&&"deleted"!=b&&("author"in a&&a.author==UserSettings.getUsername()||_.some(UserSettings.getUserGroups(),function(a){var c=a.name?a.name:a.value;return"special"==(a.key?a.key:a.type)&&"superuser"==c||c.toLowerCase().trim()==b}))?!0:!1},u=function(){try{var a=_.sortBy(l.filter(function(a){return C(a)}),function(a){return new Date(a.creation)}).reverse().map(V),b=$("#searchResults");0<_.size(a)?b.html(unwrap(a)):b.html($("<div/>",{text:"No search results found"}))}catch(d){console.log("refreshConversationSearchResults",
d)}},z=function(a,b,d,e,f){e(c)&&f.append($("<button/>",{id:a,"class":sprintf("toolbar fa %s btn-icon nmt",d),name:a,type:"button"}).append($("<div class='icon-txt' />",{text:b})))},W=function(){if(k()){var a=c.jid,b=c.slides.filter(function(a){return a.id==g})[0].index+1;addSlideToConversationAtIndex(c.jid.toString(),b);Progress.conversationDetailsReceived.JoinAtIndexIfAvailable=function(c){"jid"in c&&c.jid==a&&"slides"in c&&(c=_.find(c.slides,function(a){return a.index==b&&a.id!=g}),n(c.id.toString()))}}},
H=function(){return!0},M=function(){return _.find(c.slides,function(a){return a.id.toString()==g.toString()})},G=function(){console.log("updating queryparams:",c,g,window.location);if(void 0!=window&&"history"in window&&"pushState"in window.history){var a=window.location,b=c,d=M(),a=sprintf("%s//%s%s",a.protocol,a.host,a.pathname);void 0!=b&&"jid"in b&&void 0!=d&&"id"in d&&(a=sprintf("%s?conversationJid=%s&slideId=%s&unique=true&showTools=%s",a,b.jid.toString(),d.id.toString(),UserSettings.getIsInteractive().toString()));
window.history.replaceState({path:a,url:a},a,a)}void 0!=d&&"id"in d&&void 0!=document&&"title"in document&&(document.title=sprintf("MeTL - %s",d.id.toString()))},n=function(a){A(a);delete Progress.conversationDetailsReceived.JoinAtIndexIfAvailable;WorkQueue.enqueue(function(){loadSlide(a);G();return!0})},A=function(a){$(".slideButtonContainer").removeClass("activeSlide");a=$(sprintf("#slideContainer_%s",a));a.addClass("activeSlide");a=a.find(".slideThumbnailNumber").text();$("#currentSlide").text(a)},
P=function(a){var b=a.index+1,d=$("<div/>",{id:sprintf("slideContainer_%s",a.id),"class":"slideButtonContainer"});$("<img/>",{id:sprintf("slideButton_%s",a.id),"class":"thumbnail",alt:sprintf("Slide %s",b),title:sprintf("Slide %s (%s)",b,a.id)}).on("click",function(b){r();n(a.id.toString())}).appendTo(d);$("<span/>",{text:sprintf("%s/%s",b,c.slides.length),"class":"slideThumbnailNumber"}).appendTo($("<div/>").addClass("slide-count").appendTo(d));return d},V=function(a){var b=function(b){return sprintf("%s_%s",
b,a.jid)},c=a.jid.toString(),e=E.clone();e.attr("id",b("conversation")).on("click",bounceAnd(function(e){var f=e.target.parentElement.parentElement.id;e.target.parentElement.id!=b("extraConversationTools")&&f!=b("extraConversationTools")&&(h=c,e=a.slides.filter(function(a){return 0==a.index})[0],x.reset(),hideBackstage(),Progress.call("onConversationJoin",[a]),n(e.id.toString()))}));c=a.jid.toString();e.find(".searchResultTopRow");e.find(".searchResultMiddleRow");e.find(".teacherConversationTools").attr("id",
b("extraConversationTools"));e.find(".conversationTitle").attr("id",b("conversationTitle")).text(a.title);e.find(".conversationAuthor").text(a.author);e.find(".conversationSubject").text(a.subject);e.find(".conversationCreated").text(a.created);k(a)?(e.find(".conversationEditButton").attr("id",b("conversationEditLink")).attr("href",sprintf("/editConversation?conversationJid=%s",a.jid)),e.find(".conversationRename").attr("id",b("conversationRenameSubmit")).attr("name",b("conversationRenameSubmit")).on("click",
function(){requestRenameConversationDialogue(c)}),e.find(".conversationShare").attr("id",b("conversationChangeSubjectSubmit")).attr("name",b("conversationChangeSubjectSubmit")).on("click",function(){requestChangeSubjectOfConversationDialogue(c)}),e.find(".conversationDelete").attr("id",b("conversationDelete")).attr("name",b("conversationDelete")).on("click",function(){requestDeleteConversationDialogue(c)})):e.find(".teacherConversationTools").remove();"jid"in a&&h.trim().toLowerCase()==a.jid.toString().trim().toLowerCase()&&
e.addClass("activeConversation");return e};Progress.newConversationDetailsReceived.Conversations=function(a){if(-1<a.title.indexOf(f)||-1<a.author.indexOf(f))l=_.filter(l,function(b){return b.jid!=a.jid}),l.push(a),u()};Progress.conversationsReceived.Conversations=function(a){l=a;u()};Progress.syncMoveReceived.Conversations=function(a){(Conversations.getIsSyncedToTeacher()&&!k(c)||!UserSettings.getIsInteractive())&&"slides"in c&&0<c.slides.filter(function(b){return b.id.toString()==a.toString()}).length&&
WorkQueue.enqueue(function(){R(a);return!1})};Progress.conversationDetailsReceived.Conversations=function(a){try{console.log("received conversation:",a);var b="";"jid"in c&&(b=c.jid.toString().toLowerCase());"jid"in a&&h&&a.jid.toString().toLowerCase()==h.toLowerCase()&&(C(a)?(c=a,c.jid.toString().toLowerCase()!=b&&(Progress.call("onConversationJoin"),x.checkIsBanned(a,!0),y.clearCache())):(c={},h=""));U(a);x.checkIsBanned(a);!_.some(l,function(b){return b.jid==a.jid})&&k(a)&&(l.push(a),u())}catch(d){console.log("exception in actOnConversationDetails",
d),updateStatus(sprintf("FAILED: ReceiveConversationDetails exception: %s",d))}Progress.call("onLayoutUpdated")};Progress.currentSlideJidReceived.Conversations=function(a){console.log("currentSlideJid received:",a);g=a;A(a);t()};Progress.currentConversationJidReceived.Conversations=function(a){console.log("currentConversationJid received:",a);h=a;t()};Progress.onLayoutUpdated.Conversations=p;Progress.historyReceived.Conversations=p;$(function(){$("#thumbScrollContainer").on("scroll",p);$("#slideControls").on("click",
"#prevSlideButton",L).on("click","#nextSlideButton",K).on("click","#addSlideButton",W);$("#conversations").click(function(){showBackstage("conversations")});$("#importConversationButton").on("click",bounceAnd(function(){importConversation()}));$("#createConversationButton").on("click",bounceAnd(function(){createConversation(sprintf("%s created on %s",UserSettings.getUsername(),Date()))}));$("#myConversationsButton").on("click",bounceAnd(function(){getSearchResult(UserSettings.getUsername())}));$("#searchButton").on("click",
bounceAnd(function(){getSearchResult(f)}));var a=function(a){f=this.value;13==a.which&&(a.stopPropagation(),getSearchResult(f))},b=$("#searchForConversationBox");_.forEach(["blur","change","focus","keydown","select"],function(c){b.on(c,a)});$("<div />",{text:"share",id:"shareButton","class":"icon-txt"}).on("click",bounceAnd(function(){$("#shareContainer").toggle();t()})).appendTo($("#shareButton"));$("#closeSharingButton").on("click",bounceAnd(function(){$("#shareContainer").toggle()}))});return{inConversation:function(){return 0<
Conversations.getCurrentConversationJid().length},isAuthor:function(){return Conversations.inConversation()?UserSettings.getUsername()==Conversations.getCurrentConversation().author:!1},getCurrentTeacherSlide:function(){return D},getCurrentSlideJid:function(){return g},getCurrentSlide:M,getCurrentConversationJid:function(){return"jid"in c?c.jid.toString():h},getCurrentConversation:function(){return c},getIsSyncedToTeacher:function(){return m},getIsSyncedToTeacherDescriptor:function(){return m?"sync on":
"sync off"},getConversationModeDescriptor:function(){return c&&c.permissions&&c.permissions.studentCanPublish?"collaboration enabled":"collaboration disabled"},enableSyncMove:q,disableSyncMove:r,toggleSyncMove:function(){m?r():q()},setStudentsCanPublish:I,getStudentsCanPublish:function(){return c.permissions.studentCanPublish},setStudentsMustFollowTeacher:J,getStudentsMustFollowTeacher:function(){return c.permissions.usersAreCompulsorilySynced},shouldDisplayConversation:C,shouldPublishInConversation:function(a){a||
(a=c);return"permissions"in a&&"studentCanPublish"in a.permissions&&(k(a)||a.permissions.studentCanPublish)&&!w(a)?!0:!1},shouldModifyConversation:k,goToNextSlide:K,goToPrevSlide:L,updateThumbnail:function(a){var b=$("#slideContainer"),c=b.height();y.paintThumb({id:a,index:0},b,c)},getIsBanned:w}}();function unwrap(f){return _.map(f,"0")}function receiveCurrentSlide(f){Progress.call("currentSlideJidReceived",[f])}
function receiveCurrentConversation(f){Progress.call("currentConversationJidReceived",[f])}function receiveConversationDetails(f){Progress.call("conversationDetailsReceived",[f])}function receiveSyncMove(f){Conversations.getIsSyncedToTeacher()&&Progress.call("syncMoveReceived",[f])}function receiveNewConversationDetails(f){Progress.call("newConversationDetailsReceived",[f])}function receiveConversations(f){Progress.call("conversationsReceived",[f])};
