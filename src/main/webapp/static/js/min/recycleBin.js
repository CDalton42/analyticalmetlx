var RecycleBin=function(){var f=[],h=[],d={},l={},e=function(){d.jsGrid("loadData");var a=d.jsGrid("getSorting");"field"in a&&d.jsGrid("sort",a)};$(function(){d=$("#recycleBinDatagrid");l=d.find(".actionButtons").clone();d.empty();var a=function(a){jsGrid.Field.call(this,a)};a.prototype=new jsGrid.Field({sorter:function(a,b){return new Date(a)-new Date(b)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},editTemplate:function(a){return""},insertValue:function(){return""},
editValue:function(){return""}});jsGrid.fields.dateField=a;d.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No deleted content",controller:{loadData:function(a){if("sortField"in a){var b=_.sortBy(k(),function(b){return b[a.sortField]});"sortOrder"in a&&"desc"==a.sortOrder&&(b=_.reverse(b));return b}return k()}},pageLoading:!1,fields:[{name:"url",type:"text",title:"Preview",readOnly:!0,sorting:!1,itemTemplate:function(a,b){var c=$("<span/>",{text:"no preview"});
if("type"in b){var d=sprintf("Deleted %s from %s at %s on page %s",b.type,b.author,new Date(b.timestamp),b.slide);if("ink"==b.type){if("canvas"in b)var g=b.canvas.toDataURL("image/png"),c=$("<img/>",{src:g,"class":"stanzaThumbnail",style:"width:100%;cursor:zoom-in"}).on("click",function(){$.jAlert({title:d,closeOnClick:!0,width:"90%",content:$("<img/>",{src:g})[0].outerHTML})});return c}if("image"==b.type)return g=calculateImageSource(b),c=$("<img/>",{src:g,"class":"stanzaThumbnail",style:"width:100%;cursor:zoom-in"}).on("click",
function(){$.jAlert({title:d,closeOnClick:!0,width:"90%",content:$("<img/>",{src:g})[0].outerHTML})});if("text"==b.type)return c;if("multiWordText"==b.type){var e=$("<span/>"),f=100/_.maxBy(b.words,function(a){return a.size}).size;_.forEach(b.words,function(a){a=$("<span/>",{text:a.text}).css({color:a.color[0],"font-family":a.font,"font-style":a.italic?"italic":"normal","font-weight":a.bold?"bold":"normal","text-decoration":a.underline?"underline":"normal","font-size":sprintf("%s%%",a.size*f)});e.append(a)});
return e}}return c}},{name:"slide",type:"number",title:"Page",readOnly:!0},{name:"timestamp",type:"dateField",title:"When",readOnly:!0},{name:"author",type:"text",title:"Who",readOnly:!0},{name:"privacy",type:"text",title:"Privacy",readOnly:!0},{name:"identity",type:"text",title:"actions",readOnly:!0,sorting:!1,itemTemplate:function(a,b){var c=l.clone();c.find(".restoreContent").on("click",function(){var a=_.cloneDeep(b),c=sprintf("%s_%s",(new Date).getTime(),b.identity).substr(0,64);a.identity=c;
c={type:"undeletedCanvasContent",author:UserSettings.getUsername(),identity:sprintf("%s_%s_%s",(new Date).getTime(),b.slide,UserSettings.getUsername()).substr(0,64),timestamp:(new Date).getTime(),slide:b.slide,privacy:b.privacy,target:b.target,elementType:b.type,oldIdentity:b.identity,newIdentity:c};sendStanza(a);sendStanza(c)});c.find(".rowIdentity").text(a);return c}}]});d.jsGrid("sort",{field:"timestamp",order:"desc"});e()});var k=function(){var a=_.reject(f,function(a){return _.some(h,function(c){return c.elementType==
a.type&&c.oldIdentity==a.identity&&c.timestamp>a.timestamp})});if(Conversations.shouldModifyConversation())return a;var d=UserSettings.getUsername();return _.filter(a,function(a){return a.author==d})},m=function(){f=[];h=[]},n=function(a,d){try{if("type"in a)switch(a.type){case "ink":prerenderInk(a);break;case "multiWordText":"doc"in a&&(a=richTextEditorToStanza(a))}"identity"in a&&"type"in a&&(f.push(a),e())}catch(b){console.log("RecycleBin.onCanvasContentDeleted",b,a)}},p=function(a){void 0!=a&&
"type"in a&&"undeletedCanvasContent"==a.type&&"elementType"in a&&"oldIdentity"in a&&(h.push(a),e())};Progress.onConversationJoin.RecycleBin=m;Progress.historyReceived.RecycleBin=function(a){try{"type"in a&&"history"==a.type&&(m(),_.forEach(a.deletedCanvasContents,function(a){n(a,!0)}),_.forEach(a.undeletedCanvasContents,function(a){p(a)}),e())}catch(d){console.log("RecycleBin.historyReceivedFunction",d)}};Progress.onCanvasContentDeleted.RecycleBin=n;Progress.stanzaReceived.RecycleBin=p;$(function(){$("#menuRecycleBin").on("click",
function(){showBackstage("recycleBin");e()})});return{getAllDeletedContent:function(){return k()},getRawDeletedContent:function(){return f},getUndeletedContent:function(){return h},reRender:e}}();
