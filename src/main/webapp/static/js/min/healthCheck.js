var HealthChecker=function(){var b={},d=function(h,g,e){h in b||(b[h]=timedQueue(3E5));b[h].enqueue({instant:(new Date).getTime(),duration:e,success:g});k()},f=function(){var b=(new Date).getTime();$.ajax("/latency",{method:"GET",success:function(g){g=parseInt(g);var e=((new Date).getTime()-b-g)/2;d("serverResponse",!0,g);d("latency",!0,e);_.delay(f,2E4)},dataType:"text",error:function(){addMeasure("latency",!1,((new Date).getTime()-b)/2);_.delay(f,2E4)}})},k=_.throttle(function(){var b=l(1E3),g=
m();HealthCheckViewer.refreshDisplays(b,g)},500),n=function(){_.delay(f,2E4)},l=function(h){return _.mapValues(b,function(b){var e={};_.forEach(b.items(),function(b){var g=Math.floor(b.instant/h)*h,a=e[g],a=a?a:{count:0,avg:void 0,successCount:0,min:void 0,max:void 0,instant:g};a.count+=1;b.success&&(a.successCount+=1);if(void 0==a.min||a.min>b.duration)a.min=b.duration;if(void 0==a.max||a.max<b.duration)a.max=b.duration;a.avg=void 0==a.avg?b.duration:(b.duration-a.avg)/a.count+a.avg;e[g]=a});return _.values(e)})},
m=function(){return _.mapValues(b,function(b,g){var e=b.items(),d=e.length,f=_.map(e,"duration");if(0<d)return{name:g,count:d,max:_.max(f),min:_.min(f),average:_.mean(f),recent:_.mean(_.takeRight(f,10)),successRate:_.countBy(e,"success")[!0]/d}})};$(function(){n()});return{check:f,resumeHealthCheck:n,pauseHealthCheck:function(){},addMeasure:d,getMeasures:function(){return _.mapValues(b,function(b){return b.items()})},getAggregatedMeasures:l,describeHealth:m}}(),serverResponse=function(b){HealthChecker.addMeasure(b.command,
b.success,b.duration);if("instant"in b){var d=b.instant,d=((new Date).getTime()-d-b.duration)/2;HealthChecker.addMeasure("latency",b.success,d)}"success"in b&&0==b.success&&errorAlert(sprintf("error in %s",b.command),b.response||"error encountered")},HealthCheckViewer=function(){var b=!1,d={};$("#healthCheckListing");var f={},k={};$(function(){d=$("#healthCheckListing");f=d.find(".healthCheckItem").clone();d.empty()});var n=function(a){return _.filter(_.map(a,function(a){return{x:a.instant,y:a.count-
a.successCount}}),function(a){return 0<a.y})},l=function(a){return _.map(a,function(a){return{x:a.instant,y:a.avg}})},m=function(a){return _.map(a,function(a){return{x:a.instant,y:a.min}})},h=function(a){return _.map(a,function(a){return{x:a.instant,y:a.max}})},g=function(a){var b=(new Date).getTime();return _.map(a,function(a){a.instant=(a.instant-b)/1E3;return a})},e=function(a,b){if(!(a in k)){var c=g(b),e=f.clone(),p=$("<canvas />").addClass("healthCheckCanvas");e.html(p);d.append(e);e={title:{display:!0,
text:a},scales:{yAxes:[{id:"durationAxis",scaleLabel:{display:!0,labelString:"time taken (ms)"},type:"linear",stacked:!1,display:!0,position:"left",ticks:{},labels:{show:!0}},{id:"errorAxis",scaleLabel:{display:!0,labelString:"errors"},type:"linear",stacked:!0,display:!0,position:"right",ticks:{beginAtZero:!0,min:0,stepSize:1},labels:{show:!0}}],xAxes:[{type:"linear",position:"bottom",scaleLabel:{display:!0,labelString:"time (seconds)"},ticks:{beginAtZero:!0}}]},hover:{mode:"x-axis"},elements:{line:{fill:!1},
bar:{fill:!0}},legend:{display:!0}};c={type:"bar",data:{labels:_.map(c,"instant"),datasets:[{type:"line",label:"error count",data:n(c),fill:!0,borderColor:"rgba(0,0,0,0.5)",backgroundColor:"rgba(255,0,0,0.3)",borderWidth:1,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,lineTension:0,stepped:!0,yAxisID:"errorAxis"},{label:"min",type:"line",data:m(c),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(155,197,61,1)",backgroundColor:"rgba(155,197,61,0.3)",borderWidth:1,lineTension:.1,
yAxisID:"durationAxis"},{label:"avg",type:"line",data:l(c),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(250,121,33,1)",backgroundColor:"rgba(250,121,33,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},{label:"max",type:"line",data:h(c),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(229,89,52,1)",backgroundColor:"rgba(229,89,52,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"}]},options:e};p=new Chart(p[0].getContext("2d"),
c);k[a]=p}},r=function(a){var b=10;a.latency&&(b-=Math.min(5,a.latency.recent/100));a.render&&(b-=Math.min(5,a.render.recent/20));$("#healthStatus").prop({max:10,min:0,value:b,low:0,optimum:8,high:6})},q=function(a,d){(new Date).getTime();var c=d.latency;void 0!=c?(r(d),$(".healthCheckSummaryLatencyContainer").show(),$(".latencyAverage").text(c.average),$(".worstLatency").text(c.min),$(".bestLatency").text(c.max),$(".successRate").text(100*c.successRate),200<c.average?$(".latencyHumanReadable").text("poor"):
50<c.average?$(".latencyHumanReadable").text("moderate"):20<c.average&&$(".latencyHumanReadable").text("good")):$(".healthCheckSummaryLatencyContainer").hide();c=d.serverResponse;void 0!=c?($(".heathCheckSummaryServerResponseContainer").show(),c=c.average,$(".serverResponseAverage").text(c),c=2<c?"poor":"good",$(".serverResponseHumanReadable").text(c)):$(".heathCheckSummaryServerResponseContainer").hide();_.forEach(a,function(a,c){var d=g(a);c in k||e(c,a);if(1==b){var f=k[c];f.data.datasets[0].data=
n(d);f.data.datasets[1].data=m(d);f.data.datasets[2].data=l(d);f.data.datasets[3].data=h(d);f.update()}})};return{resume:function(){b=!0;var a=HealthChecker.getAggregatedMeasures(1E3),d=HealthChecker.describeHealth();q(a,d);_.forEach(a,function(a,b){e(b,a)})},pause:function(){b=!1},refreshDisplays:q}}();
