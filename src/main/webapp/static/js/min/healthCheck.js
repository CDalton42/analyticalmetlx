var HealthChecker=function(){var a={},c=function(h,b,f){h in a||(a[h]=timedQueue(3E5));a[h].enqueue({instant:(new Date).getTime(),duration:f,success:b});k()},g=function(){var a=(new Date).getTime(),b=l(),f="/reportLatency";"latency"in b&&(b=b.latency,f=sprintf("%s?minLatency=%s&maxLatency=%s&meanLatency=%s&sampleCount=%s",f,b.min,b.max,b.average,b.count));$.ajax(f,{method:"GET",success:function(m){m=parseInt(m);var b=((new Date).getTime()-a-m)/2;c("serverResponse",!0,m);c("latency",!0,b);_.delay(g,
2E4)},dataType:"text",error:function(){addMeasure("latency",!1,((new Date).getTime()-a)/2);_.delay(g,2E4)}})},k=_.throttle(function(){var a=n(1E3),b=l();HealthCheckViewer.refreshDisplays(a,b)},500),p=function(){_.delay(g,2E4)},n=function(h){return _.mapValues(a,function(a){var f={};_.forEach(a.items(),function(a){var b=Math.floor(a.instant/h)*h,e=f[b],e=e?e:{count:0,avg:void 0,successCount:0,min:void 0,max:void 0,instant:b};e.count+=1;a.success&&(e.successCount+=1);if(void 0==e.min||e.min>a.duration)e.min=
a.duration;if(void 0==e.max||e.max<a.duration)e.max=a.duration;e.avg=void 0==e.avg?a.duration:(a.duration-e.avg)/e.count+e.avg;f[b]=e});return _.values(f)})},l=function(){return _.mapValues(a,function(a,b){var f=a.items(),c=f.length,g=_.map(f,"duration");if(0<c)return{name:b,count:c,max:_.max(g),min:_.min(g),average:_.mean(g),recent:_.mean(_.takeRight(g,10)),successRate:_.countBy(f,"success")[!0]/c}})};$(function(){p()});return{check:g,resumeHealthCheck:p,pauseHealthCheck:function(){},addMeasure:c,
getMeasures:function(){return _.mapValues(a,function(a){return a.items()})},getAggregatedMeasures:n,describeHealth:l}}(),augmentArguments=function(a){a[_.size(a)]=(new Date).getTime();return a},serverResponse=function(a){HealthChecker.addMeasure(a.command,a.success,a.duration);if("instant"in a){var c=a.instant,c=((new Date).getTime()-c-a.duration)/2;HealthChecker.addMeasure("latency",a.success,c)}"success"in a&&0==a.success&&errorAlert(sprintf("error in %s",a.command),a.response||"error encountered")},
HealthCheckViewer=function(){var a=!1,c={};$("#healthCheckListing");var g={},k={};$(function(){c=$("#healthCheckListing");g=c.find(".healthCheckItem").clone();c.empty()});var p=function(a){return _.filter(_.map(a,function(a){return{x:a.instant,y:a.count-a.successCount}}),function(a){return 0<a.y})},n=function(a){return _.map(a,function(a){return{x:a.instant,y:a.avg}})},l=function(a){return _.map(a,function(a){return{x:a.instant,y:a.min}})},h=function(a){return _.map(a,function(a){return{x:a.instant,
y:a.max}})},b=function(a){var b=(new Date).getTime();return _.map(a,function(a){a.instant=(a.instant-b)/1E3;return a})},f=function(a,f){if(!(a in k)){var d=b(f),q=g.clone(),r=$("<canvas />").addClass("healthCheckCanvas");q.html(r);c.append(q);q={title:{display:!0,text:a},scales:{yAxes:[{id:"durationAxis",scaleLabel:{display:!0,labelString:"time taken (ms)"},type:"linear",stacked:!1,display:!0,position:"left",ticks:{},labels:{show:!0}},{id:"errorAxis",scaleLabel:{display:!0,labelString:"errors"},type:"linear",
stacked:!0,display:!0,position:"right",ticks:{beginAtZero:!0,min:0,stepSize:1},labels:{show:!0}}],xAxes:[{type:"linear",position:"bottom",scaleLabel:{display:!0,labelString:"time (seconds)"},ticks:{beginAtZero:!0}}]},hover:{mode:"x-axis"},elements:{line:{fill:!1},bar:{fill:!0}},legend:{display:!0}};d={type:"bar",data:{labels:_.map(d,"instant"),datasets:[{type:"line",label:"error count",data:p(d),fill:!0,borderColor:"rgba(0,0,0,0.5)",backgroundColor:"rgba(255,0,0,0.3)",borderWidth:1,pointRadius:0,
pointHoverRadius:3,pointHitRadius:5,lineTension:0,stepped:!0,yAxisID:"errorAxis"},{label:"min",type:"line",data:l(d),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(155,197,61,1)",backgroundColor:"rgba(155,197,61,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},{label:"avg",type:"line",data:n(d),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(250,121,33,1)",backgroundColor:"rgba(250,121,33,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},
{label:"max",type:"line",data:h(d),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(229,89,52,1)",backgroundColor:"rgba(229,89,52,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"}]},options:q};r=new Chart(r[0].getContext("2d"),d);k[a]=r}},m=function(a){var b=10;a.latency&&(b-=Math.min(8,a.latency.recent/100));a.render&&(b-=Math.min(8,a.render.recent/20));$("#healthStatus").prop({max:10,min:0,value:b,low:0,optimum:8,high:6})},t=function(e,c){(new Date).getTime();
var d=c.latency;void 0!=d?(m(c),$(".healthCheckSummaryLatencyContainer").show(),$(".latencyAverage").text(d.average),$(".worstLatency").text(d.min),$(".bestLatency").text(d.max),$(".successRate").text(100*d.successRate),200<d.average?$(".latencyHumanReadable").text("poor"):50<d.average?$(".latencyHumanReadable").text("moderate"):20<d.average&&$(".latencyHumanReadable").text("good")):$(".healthCheckSummaryLatencyContainer").hide();d=c.serverResponse;void 0!=d?($(".heathCheckSummaryServerResponseContainer").show(),
d=d.average,$(".serverResponseAverage").text(d),d=2<d?"poor":"good",$(".serverResponseHumanReadable").text(d)):$(".heathCheckSummaryServerResponseContainer").hide();_.forEach(e,function(d,e){var c=b(d);e in k||f(e,d);if(1==a){var g=k[e];g.data.datasets[0].data=p(c);g.data.datasets[1].data=l(c);g.data.datasets[2].data=n(c);g.data.datasets[3].data=h(c);g.update()}})};return{resume:function(){a=!0;var b=HealthChecker.getAggregatedMeasures(1E3),c=HealthChecker.describeHealth();t(b,c);_.forEach(b,function(a,
b){f(b,a)})},pause:function(){a=!1},refreshDisplays:t}}();
