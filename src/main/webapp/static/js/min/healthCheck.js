var HealthChecker=function(){var a={},g=0,l=function(k,e,b){k in a||(a[k]=timedQueue(3E5));a[k].enqueue({instant:(new Date).getTime(),duration:b,success:e});q()},h=function(){var a=(new Date).getTime(),e=m(),b="/reportLatency";"latency"in e&&(e=e.latency,b=sprintf("%s?minLatency=%s&maxLatency=%s&meanLatency=%s&sampleCount=%s",b,e.min,e.max,e.average,e.count));$.ajax(b,{method:"GET",success:function(d){var e=new Date,c=JSON.parse(d);d=parseInt(c.serverWorkTime);var t=((new Date).getTime()-a-d)/2,c=
c.serverTime;g=e.getTime()-(c+t);l("serverResponse",!0,d);l("latency",!0,t);_.delay(h,2E4)},dataType:"text",error:function(){addMeasure("latency",!1,((new Date).getTime()-a)/2);_.delay(h,2E4)}})},q=_.throttle(function(){var a=n(1E3),e=m();HealthCheckViewer.refreshDisplays(a,e)},500),p=function(a){a?h():_.delay(h,2E4)},n=function(k){return _.mapValues(a,function(a){var b={};_.forEach(a.items(),function(a){var e=Math.floor(a.instant/k)*k,c=b[e],c=c?c:{count:0,avg:void 0,successCount:0,min:void 0,max:void 0,
instant:e};c.count+=1;a.success&&(c.successCount+=1);if(void 0==c.min||c.min>a.duration)c.min=a.duration;if(void 0==c.max||c.max<a.duration)c.max=a.duration;c.avg=void 0==c.avg?a.duration:(a.duration-c.avg)/c.count+c.avg;b[e]=c});return _.values(b)})},m=function(){return _.mapValues(a,function(a,e){var b=a.items(),d=b.length,g=_.map(b,"duration");if(0<d)return{name:e,count:d,max:_.max(g),min:_.min(g),average:_.mean(g),recent:_.mean(_.takeRight(g,10)),successRate:_.countBy(b,"success")[!0]/d}})};$(function(){p(!0)});
return{getTimeOffset:function(){return g},getServerTime:function(){return new Date((new Date).getTime()+g)},check:h,resumeHealthCheck:p,pauseHealthCheck:function(){},addMeasure:l,getMeasures:function(){return _.mapValues(a,function(a){return a.items()})},getAggregatedMeasures:n,describeHealth:m}}(),augmentArguments=function(a){a[_.size(a)]=(new Date).getTime();return a},serverResponse=function(a){HealthChecker.addMeasure(a.command,a.success,a.duration);if("instant"in a){var g=a.instant,g=((new Date).getTime()-
g-a.duration)/2;HealthChecker.addMeasure("latency",a.success,g)}"success"in a&&0==a.success&&(console.log(a),errorAlert(sprintf("error in %s",a.command),a.response||"Error encountered"))},HealthCheckViewer=function(){var a=!1,g={};$("#healthCheckListing");var l={},h={};$(function(){g=$("#healthCheckListing");l=g.find(".healthCheckItem").clone();g.empty()});var q=function(a){return _.filter(_.map(a,function(a){return{x:a.instant,y:a.count-a.successCount}}),function(a){return 0<a.y})},p=function(a){return _.map(a,
function(a){return{x:a.instant,y:a.avg}})},n=function(a){return _.map(a,function(a){return{x:a.instant,y:a.min}})},m=function(a){return _.map(a,function(a){return{x:a.instant,y:a.max}})},k=function(a){var e=(new Date).getTime();return _.map(a,function(a){a.instant=(a.instant-e)/1E3;return a})},e=function(a,e){if(!(a in h)){var f=k(e),d=l.clone(),b=$("<canvas />").addClass("healthCheckCanvas").css({"margin-top":"-20px"});d.html(b);g.append(d);d={title:{display:!0,text:a,padding:20},legend:{display:!1},
scales:{yAxes:[{id:"durationAxis",scaleLabel:{display:!0,labelString:"time taken (ms)"},type:"linear",stacked:!1,display:!0,position:"left",ticks:{}},{id:"errorAxis",scaleLabel:{display:!0,labelString:"errors"},type:"linear",stacked:!0,display:!0,position:"right",ticks:{beginAtZero:!0,min:0,stepSize:1}}],xAxes:[{type:"linear",position:"bottom",scaleLabel:{display:!0,labelString:"time (seconds)"},ticks:{beginAtZero:!0}}]},hover:{mode:"x-axis"},elements:{line:{fill:!1},bar:{fill:!0}}};f={type:"bar",
data:{labels:_.map(f,"instant"),datasets:[{type:"line",label:"error count",data:q(f),fill:!0,borderColor:"rgba(0,0,0,0.5)",backgroundColor:"rgba(255,0,0,0.3)",borderWidth:1,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,lineTension:0,stepped:!0,yAxisID:"errorAxis"},{label:"min",type:"line",data:n(f),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(155,197,61,1)",backgroundColor:"rgba(155,197,61,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},{label:"avg",type:"line",
data:p(f),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(250,121,33,1)",backgroundColor:"rgba(250,121,33,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},{label:"max",type:"line",data:m(f),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(229,89,52,1)",backgroundColor:"rgba(229,89,52,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"}]},options:d};b=new Chart(b[0].getContext("2d"),f);console.log("New chart",a);h[a]=b}},b={},d=
function(a){return a in b?b[a]:b[a]=$(a)},r=function(c,b){WorkQueue.enqueue(function(){var a=10;b.latency&&(a-=Math.min(8,b.latency.recent/100));b.render&&(a-=Math.min(8,b.render.recent/20));$("#healthStatus").prop({max:10,min:0,value:a,low:0,optimum:8,high:6})});if(a){(new Date).getTime();var f=b.latency;void 0!=f?(d(".healthCheckSummaryLatencyContainer").show(),d(".latencyAverage").text(parseInt(f.average)),d(".worstLatency").text(parseInt(f.min)),d(".bestLatency").text(parseInt(f.max)),d(".successRate").text(parseInt(100*
f.successRate)),200<f.average?d(".latencyHumanReadable").text("poor"):50<f.average?d(".latencyHumanReadable").text("moderate"):20<f.average&&d(".latencyHumanReadable").text("good")):d(".healthCheckSummaryLatencyContainer").hide();f=b.serverResponse;void 0!=f?(d(".heathCheckSummaryServerResponseContainer").show(),f=f.average,d(".serverResponseAverage").text(parseInt(f)),f=2<f?"poor":"good",d(".serverResponseHumanReadable").text(f)):d(".heathCheckSummaryServerResponseContainer").hide();_.forEach(c,
function(a,b){var c=k(a);b in h||e(b,a);var d=h[b];d.data.datasets[0].data=q(c);d.data.datasets[1].data=n(c);d.data.datasets[2].data=p(c);d.data.datasets[3].data=m(c);d.update()})}};return{resume:function(){a=!0;var c=HealthChecker.getAggregatedMeasures(1E3),b=HealthChecker.describeHealth();r(c,b);_.forEach(c,function(a,b){e(b,a)})},pause:function(){a=!1},refreshDisplays:r}}();
