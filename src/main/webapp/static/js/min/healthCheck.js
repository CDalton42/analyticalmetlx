var HealthChecker=function(){var b={},f=0,l=function(k,e,g){k in b||(b[k]=timedQueue(3E5));b[k].enqueue({instant:(new Date).getTime(),duration:g,success:e});q()},h=function(){var b=(new Date).getTime(),e=m(),g="/reportLatency";"latency"in e&&(e=e.latency,g=sprintf("%s?minLatency=%s&maxLatency=%s&meanLatency=%s&sampleCount=%s",g,e.min,e.max,e.average,e.count));$.ajax(g,{method:"GET",success:function(c){var e=new Date,a=JSON.parse(c);c=parseInt(a.serverWorkTime);var r=((new Date).getTime()-b-c)/2,a=
a.serverTime,d=e.getTime()-(a+r);console.log("calculating time offset:",e.getTime(),a,r);f=d;l("serverResponse",!0,c);l("latency",!0,r);_.delay(h,2E4)},dataType:"text",error:function(){addMeasure("latency",!1,((new Date).getTime()-b)/2);_.delay(h,2E4)}})},q=_.throttle(function(){var b=n(1E3),e=m();HealthCheckViewer.refreshDisplays(b,e)},500),p=function(b){b?h():_.delay(h,2E4)},n=function(k){return _.mapValues(b,function(b){var g={};_.forEach(b.items(),function(b){var e=Math.floor(b.instant/k)*k,a=
g[e],a=a?a:{count:0,avg:void 0,successCount:0,min:void 0,max:void 0,instant:e};a.count+=1;b.success&&(a.successCount+=1);if(void 0==a.min||a.min>b.duration)a.min=b.duration;if(void 0==a.max||a.max<b.duration)a.max=b.duration;a.avg=void 0==a.avg?b.duration:(b.duration-a.avg)/a.count+a.avg;g[e]=a});return _.values(g)})},m=function(){return _.mapValues(b,function(b,e){var g=b.items(),c=g.length,f=_.map(g,"duration");if(0<c)return{name:e,count:c,max:_.max(f),min:_.min(f),average:_.mean(f),recent:_.mean(_.takeRight(f,
10)),successRate:_.countBy(g,"success")[!0]/c}})};$(function(){p(!0)});return{getTimeOffset:function(){return f},getServerTime:function(){return new Date((new Date).getTime()+f)},check:h,resumeHealthCheck:p,pauseHealthCheck:function(){},addMeasure:l,getMeasures:function(){return _.mapValues(b,function(b){return b.items()})},getAggregatedMeasures:n,describeHealth:m}}(),augmentArguments=function(b){b[_.size(b)]=(new Date).getTime();return b},serverResponse=function(b){HealthChecker.addMeasure(b.command,
b.success,b.duration);if("instant"in b){var f=b.instant,f=((new Date).getTime()-f-b.duration)/2;HealthChecker.addMeasure("latency",b.success,f)}"success"in b&&0==b.success&&(console.log(b),errorAlert(sprintf("error in %s",b.command),b.response||"Error encountered"))},HealthCheckViewer=function(){var b=!1,f={};$("#healthCheckListing");var l={},h={};$(function(){f=$("#healthCheckListing");l=f.find(".healthCheckItem").clone();f.empty()});var q=function(a){return _.filter(_.map(a,function(a){return{x:a.instant,
y:a.count-a.successCount}}),function(a){return 0<a.y})},p=function(a){return _.map(a,function(a){return{x:a.instant,y:a.avg}})},n=function(a){return _.map(a,function(a){return{x:a.instant,y:a.min}})},m=function(a){return _.map(a,function(a){return{x:a.instant,y:a.max}})},k=function(a){var b=(new Date).getTime();return _.map(a,function(a){a.instant=(a.instant-b)/1E3;return a})},e=function(a,b){if(!(a in h)){var d=k(b),e=l.clone(),c=$("<canvas />").addClass("healthCheckCanvas");e.html(c);f.append(e);
e={title:{display:!0,text:a},scales:{yAxes:[{id:"durationAxis",scaleLabel:{display:!0,labelString:"time taken (ms)"},type:"linear",stacked:!1,display:!0,position:"left",ticks:{},labels:{show:!0}},{id:"errorAxis",scaleLabel:{display:!0,labelString:"errors"},type:"linear",stacked:!0,display:!0,position:"right",ticks:{beginAtZero:!0,min:0,stepSize:1},labels:{show:!0}}],xAxes:[{type:"linear",position:"bottom",scaleLabel:{display:!0,labelString:"time (seconds)"},ticks:{beginAtZero:!0}}]},hover:{mode:"x-axis"},
elements:{line:{fill:!1},bar:{fill:!0}},legend:{display:!0}};d={type:"bar",data:{labels:_.map(d,"instant"),datasets:[{type:"line",label:"error count",data:q(d),fill:!0,borderColor:"rgba(0,0,0,0.5)",backgroundColor:"rgba(255,0,0,0.3)",borderWidth:1,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,lineTension:0,stepped:!0,yAxisID:"errorAxis"},{label:"min",type:"line",data:n(d),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(155,197,61,1)",backgroundColor:"rgba(155,197,61,0.3)",
borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},{label:"avg",type:"line",data:p(d),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(250,121,33,1)",backgroundColor:"rgba(250,121,33,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},{label:"max",type:"line",data:m(d),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(229,89,52,1)",backgroundColor:"rgba(229,89,52,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"}]},options:e};c=
new Chart(c[0].getContext("2d"),d);console.log("New chart",a);h[a]=c}},g={},c=function(a){return a in g?g[a]:g[a]=$(a)},t=function(a,f){WorkQueue.enqueue(function(){var a=10;f.latency&&(a-=Math.min(8,f.latency.recent/100));f.render&&(a-=Math.min(8,f.render.recent/20));$("#healthStatus").prop({max:10,min:0,value:a,low:0,optimum:8,high:6})});if(b){(new Date).getTime();var d=f.latency;void 0!=d?(c(".healthCheckSummaryLatencyContainer").show(),c(".latencyAverage").text(d.average),c(".worstLatency").text(d.min),
c(".bestLatency").text(d.max),c(".successRate").text(100*d.successRate),200<d.average?c(".latencyHumanReadable").text("poor"):50<d.average?c(".latencyHumanReadable").text("moderate"):20<d.average&&c(".latencyHumanReadable").text("good")):c(".healthCheckSummaryLatencyContainer").hide();d=f.serverResponse;void 0!=d?(c(".heathCheckSummaryServerResponseContainer").show(),d=d.average,c(".serverResponseAverage").text(d),d=2<d?"poor":"good",c(".serverResponseHumanReadable").text(d)):c(".heathCheckSummaryServerResponseContainer").hide();
_.forEach(a,function(a,b){var d=k(a);b in h||e(b,a);var c=h[b];c.data.datasets[0].data=q(d);c.data.datasets[1].data=n(d);c.data.datasets[2].data=p(d);c.data.datasets[3].data=m(d);c.update()})}};return{resume:function(){b=!0;var a=HealthChecker.getAggregatedMeasures(1E3),c=HealthChecker.describeHealth();t(a,c);_.forEach(a,function(a,b){e(b,a)})},pause:function(){b=!1},refreshDisplays:t}}();
