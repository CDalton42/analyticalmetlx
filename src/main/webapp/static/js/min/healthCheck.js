var HealthChecker=function(){var a={},f=0,m=function(g,d,b){g in a||(a[g]=timedQueue(3E5));a[g].enqueue({instant:(new Date).getTime(),duration:b,success:d});r()},k=function(a){$("#healthStatus").attr("low",a?11:4).attr("high",a?12:8).attr("optimum",a?13:10)},l=function(){var a=(new Date).getTime(),d=n(),b="/reportLatency";"latency"in d&&(d=d.latency,b=sprintf("%s?minLatency=%s&maxLatency=%s&meanLatency=%s&sampleCount=%s",b,d.min,d.max,d.average,d.count));k(!0);$.ajax(b,{method:"GET",success:function(b){k(!1);
var h=new Date,c=JSON.parse(b);b=parseInt(c.serverWorkTime);var e=((new Date).getTime()-a-b)/2,c=c.serverTime;f=h.getTime()-(c+e);m("serverResponse",!0,b);m("latency",!0,e);_.delay(l,2E4)},dataType:"text",error:function(){k(!0);addMeasure("latency",!1,((new Date).getTime()-a)/2);_.delay(l,2E4)}})},r=_.throttle(function(){var a=p(1E3),d=n();HealthCheckViewer.refreshDisplays(a,d)},1E3),q=function(a){a?l():_.delay(l,2E4)},p=function(g){return _.mapValues(a,function(a){var b={};_.forEach(a.items(),function(a){var h=
Math.floor(a.instant/g)*g,c=b[h],c=c?c:{count:0,avg:void 0,successCount:0,min:void 0,max:void 0,instant:h};c.count+=1;a.success&&(c.successCount+=1);if(void 0==c.min||c.min>a.duration)c.min=a.duration;if(void 0==c.max||c.max<a.duration)c.max=a.duration;c.avg=void 0==c.avg?a.duration:(a.duration-c.avg)/c.count+c.avg;b[h]=c});return _.values(b)})},n=function(){return _.mapValues(a,function(a,d){var b=a.items(),f=b.length,h=_.map(b,"duration");if(0<f)return{name:d,count:f,max:_.max(h),min:_.min(h),average:_.mean(h),
recent:_.mean(_.takeRight(h,10)),successRate:_.countBy(b,"success")[!0]/f}})};$(function(){q(!0)});return{getTimeOffset:function(){return f},getServerTime:function(){return new Date((new Date).getTime()+f)},check:l,resumeHealthCheck:q,pauseHealthCheck:function(){},addMeasure:m,getMeasures:function(){return _.mapValues(a,function(a){return a.items()})},getAggregatedMeasures:p,describeHealth:n}}(),augmentArguments=function(a){a[_.size(a)]=(new Date).getTime();return a},serverResponse=function(a){HealthChecker.addMeasure(a.command,
a.success,a.duration);if("instant"in a){var f=a.instant,f=((new Date).getTime()-f-a.duration)/2;HealthChecker.addMeasure("latency",a.success,f)}"success"in a&&0==a.success&&(console.log(a),errorAlert(sprintf("error in %s",a.command),a.response||"Error encountered"))},HealthCheckViewer=function(){var a=!1,f={};$("#healthCheckListing");var m={},k={};$(function(){f=$("#healthCheckListing");m=f.find(".healthCheckItem").clone();f.empty()});var l=function(a){return _.filter(_.map(a,function(a){return{x:a.instant,
y:a.count-a.successCount}}),function(a){return 0<a.y})},r=function(a){return _.map(a,function(a){return{x:a.instant,y:a.avg}})},q=function(a){return _.map(a,function(a){return{x:a.instant,y:a.min}})},p=function(a){return _.map(a,function(a){return{x:a.instant,y:a.max}})},n=function(a){var c=(new Date).getTime();return _.map(a,function(a){a.instant=(a.instant-c)/1E3;return a})},g=function(a,c){if(!(a in k)){var b=n(c),d=m.clone(),g=$("<canvas />").addClass("healthCheckCanvas").css({"margin-top":"-20px"});
d.html(g);f.append(d);d={title:{display:!0,text:a,padding:20},legend:{display:!1},scales:{yAxes:[{id:"durationAxis",scaleLabel:{display:!0,labelString:"time taken (ms)"},type:"linear",stacked:!1,display:!0,position:"left",ticks:{}},{id:"errorAxis",scaleLabel:{display:!0,labelString:"errors"},type:"linear",stacked:!0,display:!0,position:"right",ticks:{beginAtZero:!0,min:0,stepSize:1}}],xAxes:[{type:"linear",position:"bottom",scaleLabel:{display:!0,labelString:"time (seconds)"},ticks:{beginAtZero:!0}}]},
hover:{mode:"x-axis"},elements:{line:{fill:!1},bar:{fill:!0}}};b={type:"bar",data:{labels:_.map(b,"instant"),datasets:[{type:"line",label:"error count",data:l(b),fill:!0,borderColor:"rgba(0,0,0,0.5)",backgroundColor:"rgba(255,0,0,0.3)",borderWidth:1,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,lineTension:0,stepped:!0,yAxisID:"errorAxis"},{label:"min",type:"line",data:q(b),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(155,197,61,1)",backgroundColor:"rgba(155,197,61,0.3)",
borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},{label:"avg",type:"line",data:r(b),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(250,121,33,1)",backgroundColor:"rgba(250,121,33,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},{label:"max",type:"line",data:p(b),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(229,89,52,1)",backgroundColor:"rgba(229,89,52,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"}]},options:d};g=
new Chart(g[0].getContext("2d"),b);console.log("New chart",a);k[a]=g}},d={},b=function(a){return a in d?d[a]:d[a]=$(a)},t=function(d,c){WorkQueue.enqueue(function(){var a=10;c.latency&&(a-=Math.min(8,c.latency.recent/100));c.render&&(a-=Math.min(8,c.render.recent/20));$("#healthStatus").prop({max:13,min:0,value:a})});if(a){(new Date).getTime();var e=c.latency;void 0!=e?(b(".healthCheckSummaryLatencyContainer").show(),b(".latencyAverage").text(parseInt(e.average)),b(".worstLatency").text(parseInt(e.min)),
b(".bestLatency").text(parseInt(e.max)),b(".successRate").text(parseInt(100*e.successRate)),200<e.average?b(".latencyHumanReadable").text("poor"):50<e.average?b(".latencyHumanReadable").text("moderate"):20<e.average&&b(".latencyHumanReadable").text("good")):b(".healthCheckSummaryLatencyContainer").hide();e=c.serverResponse;void 0!=e?(b(".heathCheckSummaryServerResponseContainer").show(),e=e.average,b(".serverResponseAverage").text(parseInt(e)),e=2<e?"poor":"good",b(".serverResponseHumanReadable").text(e)):
b(".heathCheckSummaryServerResponseContainer").hide();_.forEach(d,function(a,b){var c=n(a);b in k||g(b,a);var d=k[b];d.data.datasets[0].data=l(c);d.data.datasets[1].data=q(c);d.data.datasets[2].data=r(c);d.data.datasets[3].data=p(c);d.update()})}};return{resume:function(){a=!0;var b=HealthChecker.getAggregatedMeasures(1E3),c=HealthChecker.describeHealth();t(b,c);_.forEach(b,function(a,b){g(b,a)})},pause:function(){a=!1},refreshDisplays:t}}();
