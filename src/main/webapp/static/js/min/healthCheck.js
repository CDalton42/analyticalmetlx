var HealthChecker=function(){var a={},k=0,p=function(m,g,h){m in a||(a[m]=timedQueue(3E5));a[m].enqueue({instant:(new Date).getTime(),duration:h,success:g});u()},n=function(a){$("#healthStatus").attr("low",a?11:4).attr("high",a?12:8).attr("optimum",a?13:10)},l=function(){var a=(new Date).getTime(),g=q(),h="/reportLatency";"latency"in g&&((g=g.latency)?h=sprintf("%s?minLatency=%s&maxLatency=%s&meanLatency=%s&sampleCount=%s",h,g.min,g.max,g.average,g.count):(console.log("recoverable error",e),n(!1)));
n(!0);$.ajax(h,{method:"GET",success:function(d){n(!1);var c=new Date,b=JSON.parse(d);d=parseInt(b.serverWorkTime);var v=((new Date).getTime()-a-d)/2,b=b.serverTime;k=c.getTime()-(b+v);p("serverResponse",!0,d);p("latency",!0,v);_.delay(l,2E4)},dataType:"text",error:function(d){n(!0);p("latency",!1,((new Date).getTime()-a)/2);"rejected"==d.state()?(console.log("unrecoverable error.  refreshing",d),location.reload(!0)):(console.log("recoverable error",d),_.delay(l,2E4))}})},u=_.throttle(function(){var a=
r(1E3),g=q();HealthCheckViewer.refreshDisplays(a,g)},1E3),t=function(a){a?l():_.delay(l,2E4)},r=function(m){return _.mapValues(a,function(a){var h={};_.forEach(a.items(),function(a){var c=Math.floor(a.instant/m)*m,b=h[c],b=b?b:{count:0,avg:void 0,successCount:0,min:void 0,max:void 0,instant:c};b.count+=1;a.success&&(b.successCount+=1);if(void 0==b.min||b.min>a.duration)b.min=a.duration;if(void 0==b.max||b.max<a.duration)b.max=a.duration;b.avg=void 0==b.avg?a.duration:(a.duration-b.avg)/b.count+b.avg;
h[c]=b});return _.values(h)})},q=function(){return _.mapValues(a,function(a,g){var h=a.items(),d=h.length,c=_.map(h,"duration");if(0<d)return{name:g,count:d,max:_.max(c),min:_.min(c),average:_.mean(c),recent:_.mean(_.takeRight(c,10)),successful:0==d||h[d-1].success,successRate:_.countBy(h,"success")[!0]/d}})};$(function(){t(!0)});return{getTimeOffset:function(){return k},getServerTime:function(){return new Date((new Date).getTime()+k)},check:l,resumeHealthCheck:t,pauseHealthCheck:function(){},addMeasure:p,
getMeasures:function(){return _.mapValues(a,function(a){return a.items()})},getAggregatedMeasures:r,describeHealth:q}}(),augmentArguments=function(a){a[_.size(a)]=(new Date).getTime();return a},serverResponse=function(a){HealthChecker.addMeasure(a.command,a.success,a.duration);if("instant"in a){var k=a.instant,k=((new Date).getTime()-k-a.duration)/2;HealthChecker.addMeasure("latency",a.success,k)}"success"in a&&0==a.success&&(console.log(a),errorAlert(sprintf("error in %s",a.command),a.response||
"Error encountered"))},HealthCheckViewer=function(){var a=!1,k={};$("#healthCheckListing");var p={},n={},l=!1;$(function(){k=$("#healthCheckListing");p=k.find(".healthCheckItem").clone();k.empty()});var u=function(a){return _.filter(_.map(a,function(a){return{x:a.instant,y:a.count-a.successCount}}),function(a){return 0<a.y})},t=function(a){return _.map(a,function(a){return{x:a.instant,y:a.avg}})},r=function(a){return _.map(a,function(a){return{x:a.instant,y:a.min}})},q=function(a){return _.map(a,
function(a){return{x:a.instant,y:a.max}})},m=function(a){var b=(new Date).getTime();return _.map(a,function(a){a.instant=(a.instant-b)/1E3;return a})},g=function(a,b){if(!(a in n)){var f=m(b),c=p.clone(),d=$("<canvas />").addClass("healthCheckCanvas").css({"margin-top":"-20px"});c.html(d);k.append(c);c={title:{display:!0,text:a,padding:20},legend:{display:!1},scales:{yAxes:[{id:"durationAxis",scaleLabel:{display:!0,labelString:"time taken (ms)"},type:"linear",stacked:!1,display:!0,position:"left",
ticks:{}},{id:"errorAxis",scaleLabel:{display:!0,labelString:"errors"},type:"linear",stacked:!0,display:!0,position:"right",ticks:{beginAtZero:!0,min:0,stepSize:1}}],xAxes:[{type:"linear",position:"bottom",scaleLabel:{display:!0,labelString:"time (seconds)"},ticks:{beginAtZero:!0}}]},hover:{mode:"x-axis"},elements:{line:{fill:!1},bar:{fill:!0}}};f={type:"bar",data:{labels:_.map(f,"instant"),datasets:[{type:"line",label:"error count",data:u(f),fill:!0,borderColor:"rgba(0,0,0,0.5)",backgroundColor:"rgba(255,0,0,0.3)",
borderWidth:1,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,lineTension:0,stepped:!0,yAxisID:"errorAxis"},{label:"min",type:"line",data:r(f),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(155,197,61,1)",backgroundColor:"rgba(155,197,61,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"},{label:"avg",type:"line",data:t(f),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(250,121,33,1)",backgroundColor:"rgba(250,121,33,0.3)",borderWidth:1,
lineTension:.1,yAxisID:"durationAxis"},{label:"max",type:"line",data:q(f),fill:!0,pointRadius:0,pointHoverRadius:3,pointHitRadius:5,borderColor:"rgba(229,89,52,1)",backgroundColor:"rgba(229,89,52,0.3)",borderWidth:1,lineTension:.1,yAxisID:"durationAxis"}]},options:c};d=new Chart(d[0].getContext("2d"),f);console.log("New chart",a);n[a]=d}},h=function(a){var b=10;a.latency&&(b-=Math.min(8,a.latency.recent/100));a.render&&(b-=Math.min(8,a.render.recent/20));$(".meters").css("background-color",function(){return _.some(["latency",
"serverResponse"],function(b){return b in a&&1>a[b].successRate})?"red":"transparent"}());var c=l;l=_.every(["latency","serverResponse"],function(b){return b in a&&a[b].successful});c!=l&&blit();$("#healthStatus").prop({max:13,low:4,high:8,min:0,value:b})},d={},c=function(a){return a in d?d[a]:d[a]=$(a)},b=function(b,d){WorkQueue.enqueue(function(){h(d)});if(a){var f=d.latency;void 0!=f?(c(".healthCheckSummaryLatencyContainer").show(),c(".latencyAverage").text(parseInt(f.average)),c(".worstLatency").text(parseInt(f.min)),
c(".bestLatency").text(parseInt(f.max)),c(".successRate").text(parseInt(100*f.successRate)),200<f.average?c(".latencyHumanReadable").text("poor"):50<f.average?c(".latencyHumanReadable").text("moderate"):20<f.average&&c(".latencyHumanReadable").text("good")):c(".healthCheckSummaryLatencyContainer").hide();f=d.serverResponse;void 0!=f?(c(".heathCheckSummaryServerResponseContainer").show(),f=f.average,c(".serverResponseAverage").text(parseInt(f)),f=2<f?"poor":"good",c(".serverResponseHumanReadable").text(f)):
c(".heathCheckSummaryServerResponseContainer").hide();_.forEach(b,function(a,b){var c=m(a);b in n||g(b,a);var d=n[b];d.data.datasets[0].data=u(c);d.data.datasets[1].data=r(c);d.data.datasets[2].data=t(c);d.data.datasets[3].data=q(c);d.update()})}};return{resume:function(){a=!0;var c=HealthChecker.getAggregatedMeasures(1E3),d=HealthChecker.describeHealth();b(c,d);_.forEach(c,function(a,b){g(b,a)})},pause:function(){a=!1},refreshDisplays:b,healthy:function(){return l}}}();
