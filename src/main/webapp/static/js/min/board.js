function setupStatus(){pending={};var a=$("#strokesPending"),b=$("#latency"),e=0;window.progressFuncs={};var c={};window.updateStrokesPending=function(c,d){0<c?pending[d]=Date.now():d in pending&&(e=Date.now()-pending[d],delete pending[d]);a.text(Object.keys(pending).length);b.text(e)};window.registerTracker=function(a,b){b?progressFuncs[a]=b:console.log("No tracker provided against",a)};window.updateTracking=function(a){if(a in progressFuncs){var b=progressFuncs[a];delete progressFuncs[a];b()}else console.log("updateTracking problem: Nobody is listening for ",
a)};window.stopTracking=function(a){if(a in c)c[a]();delete progressFuncs[a];delete c[a]};window.trackerFrom=function(a){return _.filter(_.keys(progressFuncs),function(b){return a.endsWith(sprintf("_from:%s",b))})}}
function strokeCollected(a){if(0<a.length){a=a.split(" ").map(function(a){return parseFloat(a)});for(var b=Conversations.getCurrentSlideJid(),b={thickness:scaleScreenToWorld(Modes.draw.drawingAttributes.width),color:[Modes.draw.drawingAttributes.color,255],type:"ink",author:UserSettings.getUsername(),timestamp:Date.now(),target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),slide:b.toString(),isHighlighter:Modes.draw.drawingAttributes.isHighlighter},e=[],c,g,d=0;d<a.length;d+=3)c=a[d],g=
a[d+1],c=screenToWorld(c,g),e=e.concat([c.x,c.y,a[d+2]]);b.points=e;b.checksum=b.points.reduce(function(a,b){return a+b},0);b.startingSum=b.checksum;b.identity=b.checksum.toFixed(1);calculateInkBounds(b);prerenderInk(b);b.isHighlighter?boardContent.highlighters[b.identity]=b:boardContent.inks[b.identity]=b;sendInk(b)}}
function batchTransform(){var a=Conversations.getCurrentSlideJid();return{type:"moveDelta",identity:Date.now().toString(),author:UserSettings.getUsername(),slide:a.toString(),target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),timestamp:Date.now(),inkIds:[],textIds:[],multiWordTextIds:[],imageIds:[],xOrigin:0,yOrigin:0,xTranslate:0,yTranslate:0,xScale:1,yScale:1,isDeleted:!1,newPrivacy:"not_set"}}
function sendDirtyInk(a){var b=Conversations.getCurrentSlideJid();sendStanza({type:"dirtyInk",identity:a.identity,author:UserSettings.getUsername(),timestamp:Date.now(),slide:b.toString(),target:"presentationSpace",privacy:a.privacy})}function sendInk(a){updateStrokesPending(1,a.identity);sendStanza(a)}
function hexToRgb(a){if("object"==typeof a&&a.alpha)return a;"string"==typeof a&&(a=[a,255]);var b=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a[0]);return{alpha:a[1],red:parseInt(b[1],16),green:parseInt(b[2],16),blue:parseInt(b[3],16)}}
function partToStanza(a){var b=carota.runs.defaultFormatting,e=hexToRgb(a.color||b.color);return{text:a.text,color:e,size:parseFloat(a.size)||parseFloat(b.size),font:a.font||b.font,justify:a.align||b.align,bold:!0===a.bold,underline:!0===a.underline,italic:!0===a.italic}}
function richTextEditorToStanza(a){a.bounds||a.doc.invalidateBounds();var b=a.bounds,e=a.doc.save();void 0==a.slide&&(a.slide=Conversations.getCurrentSlideJid());void 0==a.author&&(a.author=UserSettings.getUsername());void 0==a.target&&(a.target="presentationSpace");void 0==a.privacy&&(a.privacy=Privacy.getCurrentPrivacy());return{author:a.author,timestamp:-1,target:a.target,tag:"_",privacy:a.privacy,slide:a.slide,identity:a.identity,type:a.type,x:b[0],y:b[1],requestedWidth:b[2]-b[0],width:b[2]-b[0],
height:b[3]-b[1],words:e.map(partToStanza)}}function sendRichText(a){Modes.text.echoesToDisregard[a.identity]=!0;a=richTextEditorToStanza(a);sendStanza(a)}var sendRichText=_.debounce(sendRichText,1E3),stanzaHandlers={ink:inkReceived,dirtyInk:dirtyInkReceived,move:moveReceived,moveDelta:transformReceived,image:imageReceived,text:textReceived,multiWordText:richTextReceived,command:commandReceived,submission:submissionReceived,attendance:attendanceReceived,file:fileReceived};
function fileReceived(a){}function attendanceReceived(a){}function submissionReceived(a){Submissions.processSubmission(a)}
function commandReceived(a){if("/TEACHER_VIEW_MOVED"==a.command&&a.parameters[5]==Conversations.getCurrentSlide().id.toString()){var b=_.slice(a.parameters,0,6).map(parseFloat);if(_.some(b,isNaN))console.log("Can't follow teacher to",a);else if(b[4]!=DeviceConfiguration.getIdentity()&&Conversations.getIsSyncedToTeacher()){console.log("teacherViewMoved",a);var e=function(){var c=a.parameters[6];b[5]==Conversations.getCurrentSlide().id.toString()&&("true"==c?zoomToFit():(zoomToPage(),TweenController.zoomAndPanViewbox(b[0],
b[1],b[2],b[3],function(){},!1,!0)))};UserSettings.getIsInteractive()||e()}}}function richTextReceived(a){a.identity in Modes.text.echoesToDisregard||isUsable(a)&&WorkQueue.enqueue(function(){Modes.text.editorFor(a).doc.load(a.words);blit()})}
function textReceived(a){try{isUsable(a)?(boardContent.texts[a.identity]=a,prerenderText(a),incorporateBoardBounds(a.bounds),WorkQueue.enqueue(function(){return isInClearSpace(a.bounds)?(drawText(a),!1):!0})):a.identity in boardContent.texts&&delete boardContent.texts[a.identity]}catch(b){console.log("textReceived exception:",b)}}function receiveMeTLStanza(a){Progress.call("stanzaReceived",[a])}
function actOnReceivedStanza(a){try{a.type in stanzaHandlers?(stanzaHandlers[a.type](a),Progress.call("onBoardContentChanged")):console.log(sprintf("Unknown stanza: %s %s",a.type,a))}catch(b){console.log("Exception in receiveMeTLStanza",b,a)}}
function transformReceived(a){var b="",e=function(){var a=[void 0,void 0,void 0,void 0],f=function(){return a},b=function(f,b){void 0==f||isNaN(f)||(a[b]=f)};return{minX:f[0],setMinX:function(a){b(a,0)},minY:f[1],setMinY:function(a){b(a,1)},maxX:f[2],setMaxX:function(a){b(a,2)},maxY:f[3],setMaxY:function(a){b(a,3)},incorporateBounds:function(f){var b=function(b){var c=a[b];void 0==c||isNaN(c)?a[b]=f[b]:a[b]=Math.max(c,f[b])},c=function(b){var c=a[b];void 0==c||isNaN(c)?a[b]=f[b]:a[b]=Math.min(c,f[b])};
c(0);c(1);b(2);b(3)},getBounds:f,incorporateBoardBounds:function(){void 0!=a[0]&&void 0!=a[1]&&void 0!=a[2]&&void 0!=a[3]&&incorporateBoardBounds(a)}}}();if("not_set"!=a.newPrivacy&&!a.isDeleted){var c=a.newPrivacy,b=b+("Became "+c);$.each(a.inkIds,function(a,b){var e=boardContent.inks[b];e&&(e.privacy=c);if(e=boardContent.highlighters[b])e.privacy=c});$.each(a.imageIds,function(a,b){boardContent.images[b].privacy=c});$.each(a.textIds,function(a,b){boardContent.texts[b].privacy=c});$.each(a.multiWordTextIds,
function(a,b){boardContent.multiWordTextIds[b].privacy=c})}a.isDeleted&&(b+="deleted",c=a.privacy,$.each(a.inkIds,function(a,b){deleteInk("highlighters",c,b);deleteInk("inks",c,b)}),$.each(a.imageIds,function(a,b){deleteImage(c,b)}),$.each(a.textIds,function(a,b){deleteText(c,b)}),$.each(a.multiWordTextIds,function(a,b){deleteMultiWordText(c,b)}));if(1!=a.xScale||1!=a.yScale){var b=b+sprintf("scale (%s,%s)",a.xScale,a.yScale),g=[],d=[],h=[],n=[];$.each(a.inkIds,function(a,b){g.push(boardContent.inks[b]);
g.push(boardContent.highlighters[b])});$.each(a.imageIds,function(a,b){n.push(boardContent.images[b])});$.each(a.textIds,function(a,b){d.push(boardContent.texts[b])});$.each(a.multiWordTextIds,function(a,b){b in Modes.text.echoesToDisregard||h.push(boardContent.multiWordTexts[b])});var k=0,l=0;if("xOrigin"in a&&"yOrigin"in a)k=a.xOrigin,l=a.yOrigin;else{var q=!0,m=function(a){q?(k=a.x,l=a.y,q=!1):(a.x<k&&(k=a.x),a.y<l&&(l=a.y))};$.each(g,function(a,b){void 0!=b&&"bounds"in b&&1<_.size(b.bounds)&&
m({x:b.bounds[0],y:b.bounds[1]})});$.each(d,function(a,b){void 0!=b&&"x"in b&&"y"in b&&m({x:b.x,y:b.y})});$.each(h,function(a,b){void 0!=b&&"x"in b&&"y"in b&&m({x:b.x,y:b.y})});$.each(n,function(a,b){void 0!=b&&"x"in b&&"y"in b&&m({x:b.x,y:b.y})})}e.setMinX(k);e.setMinY(l);$.each(g,function(b,f){if(f&&void 0!=f){var c=f.points,d=f.bounds[0],g=f.bounds[1],h,n,m=d-k;h=g-l;for(var m=-(m-m*a.xScale),q=-(h-h*a.yScale),p=0;p<c.length;p+=3)h=c[p]-d,n=c[p+1]-g,c[p]=d+h*a.xScale+m,c[p+1]=g+n*a.yScale+q;calculateInkBounds(f);
e.incorporateBounds(f.bounds)}});$.each(n,function(b,f){if(void 0!=f){f.width*=a.xScale;f.height*=a.yScale;var c=f.x-k,d=f.y-l,d=-(d-d*a.yScale);f.x+=-(c-c*a.xScale);f.y+=d;calculateImageBounds(f);e.incorporateBounds(f.bounds)}});$.each(d,function(b,f){if(void 0!=f){f.width*=a.xScale;f.height*=a.yScale;var c=f.x-k,d=f.y-l,d=-(d-d*a.yScale);f.x+=-(c-c*a.xScale);f.y+=d;f.size*=a.yScale;f.font=sprintf("%spx %s",f.size,f.family);isUsable(f)?(prerenderText(f),calculateTextBounds(f)):f.identity in boardContent.texts&&
delete boardContent.texts[f.identity];e.incorporateBounds(f.bounds)}});$.each(h,function(b,c){if(void 0!=c){c.requestedWidth=(c.width||c.requestedWidth)*a.xScale;c.width=c.requestedWidth;c.doc.width(c.width);_.each(c.words,function(b){b.size*=a.xScale});var d=c.x-k,g=c.y-l;c.doc.position={x:c.x+-(d-d*a.xScale),y:c.y+-(g-g*a.yScale)};c.doc.load(c.words);e.incorporateBounds(c.bounds)}})}if(a.xTranslate||a.yTranslate){var r=a.xTranslate,t=a.yTranslate,b=b+sprintf("translate (%s,%s)",r,t),u=function(a){if(a){for(var b=
a.points,c=0;c<b.length;c+=3)b[c]+=r,b[c+1]+=t;calculateInkBounds(a);e.incorporateBounds(a.bounds)}};$.each(a.inkIds,function(a,b){u(boardContent.inks[b]);u(boardContent.highlighters[b])});$.each(a.imageIds,function(b,c){var d=boardContent.images[c];console.log("Shifting image",d.x,d.y);d.x+=a.xTranslate;d.y+=a.yTranslate;calculateImageBounds(d);console.log("Shifting image",d.x,d.y);e.incorporateBounds(d.bounds)});$.each(a.textIds,function(b,c){var d=boardContent.texts[c];d.x+=a.xTranslate;d.y+=a.yTranslate;
calculateTextBounds(d);e.incorporateBounds(d.bounds)});$.each(a.multiWordTextIds,function(b,c){if(!(c in Modes.text.echoesToDisregard)){var d=boardContent.multiWordTexts[c],g=d.doc;g.position.x+=a.xTranslate;g.position.y+=a.yTranslate;d.x=g.position.x;d.y=g.position.y;e.incorporateBounds(d.bounds)}})}e.incorporateBoardBounds();updateStatus(sprintf("%s %s %s %s %s",b,a.imageIds.length,a.textIds.length,a.multiWordTextIds.length,a.inkIds.length));_.each(trackerFrom(a.identity),function(a){updateTracking(a)});
blit()}function moveReceived(a){updateStatus(sprintf("Moving %s, %s, %s",Object.keys(a.images).length,Object.keys(a.texts).length,Object.keys(a.inks).length));$.each(a.inks,function(a,e){boardContent.inks[a]=e});$.each(a.images,function(a,e){boardContent.images[a]=e});$.each(a.texts,function(a,e){boardContent.texts[a]=e});$.each(a.multiWordTexts,function(a,e){boardContent.multiWordTexts[a]=e});blit()}
function deleteInk(a,b,e){e in boardContent[a]&&boardContent[a][e].privacy.toUpperCase()==b.toUpperCase()&&delete boardContent[a][e]}function deleteImage(a,b){boardContent.images[b].privacy.toUpperCase()==a.toUpperCase()&&delete boardContent.images[b]}function deleteText(a,b){boardContent.texts[b].privacy.toUpperCase()==a.toUpperCase()&&delete boardContent.texts[b]}
function deleteMultiWordText(a,b){boardContent.multiWordTexts[b].privacy.toUpperCase()==a.toUpperCase()&&delete boardContent.multiWordTexts[b]}function dirtyInkReceived(a){var b=a.identity;a=a.privacy;deleteInk("highlighters",a,b);deleteInk("inks",a,b);updateStatus(sprintf("Deleted ink %s",b));blit()}function isInClearSpace(a){return!_.some(visibleBounds,function(b){return intersectRect(b,a)})}
function screenBounds(a){var b=worldToScreen(a[0],a[1]);a=worldToScreen(a[2],a[3]);return{screenPos:b,screenLimit:a,screenWidth:a.x-b.x,screenHeight:a.y-b.y}}function scaleCanvas(a,b,e,c){return 1<=b&&1<=e?(c=$("<canvas />"),c.width=b,c.height=e,c.attr("width",b),c.attr("height",e),c.css({width:px(b),height:px(e)}),c[0].getContext("2d").drawImage(a,0,0,b,e),c[0]):a}var mipMappingEnabled=!0;
function multiStageRescale(a,b,e,c){if(mipMappingEnabled){c=void 0==c?{}:c;"mipMap"in c||(c.mipMap={});var g=c.mipMap,d=a.width,h=a.height;if(1<=b&&1<=d&&b<d){var d=.5*d,n=.5*h;if(d<b)return a;h=Math.floor(d);h in g||(a=scaleCanvas(a,d,n),g[h]=a);return multiStageRescale(g[h],b,e,c)}}return a}
function drawImage(a,b){var e=void 0==b?boardContext:b;try{if(void 0!=a.canvas){var c=screenBounds(a.bounds);visibleBounds.push(a.bounds);if(1<=c.screenHeight&&1<=c.screenWidth){var g=.1*c.screenWidth,d=.1*c.screenHeight;e.drawImage(multiStageRescale(a.canvas,c.screenWidth,c.screenHeight,a),c.screenPos.x-g/2,c.screenPos.y-d/2,c.screenWidth+g,c.screenHeight+d)}}}catch(h){console.log("drawImage exception",h)}}function drawMultiwordText(a){Modes.text.draw(a)}
function drawText(a,b){var e=void 0==b?boardContext:b;try{var c=screenBounds(a.bounds);visibleBounds.push(a.bounds);1<=c.screenHeight&&1<=c.screenWidth&&e.drawImage(multiStageRescale(a.canvas,c.screenWidth,c.screenHeight,a),c.screenPos.x,c.screenPos.y,c.screenWidth,c.screenHeight)}catch(g){console.log("drawText exception",g)}}
function drawInk(a,b){var e=void 0==b?boardContext:b,c=screenBounds(a.bounds);visibleBounds.push(a.bounds);1<=c.screenHeight&&1<=c.screenWidth&&e.drawImage(multiStageRescale(a.canvas,c.screenWidth,c.screenHeight,a),c.screenPos.x,c.screenPos.y,c.screenWidth,c.screenHeight)}
function imageReceived(a){var b=new Image;a.imageData=b;b.onload=function(){0==a.width&&(a.width=b.naturalWidth);0==a.height&&(a.height=b.naturalHeight);a.bounds=[a.x,a.y,a.x+a.width,a.y+a.height];incorporateBoardBounds(a.bounds);boardContent.images[a.identity]=a;updateTracking(a.identity);prerenderImage(a);WorkQueue.enqueue(function(){if(isInClearSpace(a.bounds)){try{drawImage(a)}catch(b){console.log("drawImage exception",b)}return!1}console.log("Rerendering image in contested space");return!0})};
b.src=calculateImageSource(a)}function inkReceived(a){calculateInkBounds(a);updateStrokesPending(-1,a.identity);prerenderInk(a)&&(incorporateBoardBounds(a.bounds),a.isHighlighter?boardContent.highlighters[a.identity]=a:boardContent.inks[a.identity]=a,WorkQueue.enqueue(function(){return isInClearSpace(a.bounds)?(drawInk(a),!1):!0}))}function takeControlOfViewbox(){delete Progress.onBoardContentChanged.autoZooming;UserSettings.setUserPref("followingTeacherViewbox",!0)}
function zoomToFit(a){Progress.onBoardContentChanged.autoZooming=zoomToFit;requestedViewboxWidth=boardContent.width;requestedViewboxHeight=boardContent.height;IncludeView.specific(boardContent.minX,boardContent.minY,boardContent.width,boardContent.height,a)}function zoomToOriginal(a){takeControlOfViewbox();requestedViewboxWidth=boardWidth;requestedViewboxHeight=boardHeight;IncludeView.specific(0,0,boardWidth,boardHeight,a)}
function zoomToPage(a){takeControlOfViewbox();var b=requestedViewboxHeight,e=requestedViewboxWidth;requestedViewboxWidth=boardWidth;requestedViewboxHeight=boardHeight;IncludeView.specific(viewboxX+(e-requestedViewboxWidth)/2,viewboxY+(b-requestedViewboxHeight)/2,boardWidth,boardHeight,a)}function receiveS2C(a,b){try{$(unescape(b)).addClass("s2cMessage").appendTo("body")}catch(e){console.log("receiveS2C exception:",e)}};
