var Quizzes=function(){var g={},k={},e={},f={},q={},h={},r={},l={},t={};$(function(){f=$("#unansweredQuizListing");q=f.find(".quizItem").clone();h=$("#answeredQuizListing");r=h.find(".quizItem").clone();l=$("#currentQuiz");t=l.find(".currentQuizItem").clone();$("#quizzes").click(function(){showBackstage("quizzes")});var a=$("<div />",{id:"quizCount","class":"icon-txt"});$("#feedbackStatus").prepend(a);a.click(function(){showBackstage("quizzes")});u()});var u=function(){var a=_.size(g);0<a?1==a?($("#quizCount").text(sprintf("%s quiz",
_.size(g))),$("#dedicatedQuizCount").text("This conversation has 1 quiz")):($("#quizCount").text(sprintf("%s quizzes",_.size(g))),$("#dedicatedQuizCount").text(sprintf("This conversation has %s quizzes",a))):($("#quizCount").text(""),$("#dedicatedQuizCount").text("This conversation has no quizzes"))},v=function(){g={};k={};e={};f.empty();h.empty();l.empty();$("#quizCount").text("");Conversations.shouldModifyConversation()?$("#quizCreationButton").unbind("click").on("click",function(){requestCreateQuizDialogue(Conversations.getCurrentConversation())}).show():
$("#quizCreationButton").unbind("click").hide()},y=function(){try{var a=_.sortBy(g,function(a){return a.created}),c=$.map(a,function(a,b){if(void 0!=m(a)[UserSettings.getUsername()])return a}),n=$.map(a,function(a,b){if(void 0==m(a)[UserSettings.getUsername()])return a});h.empty();0<c.length&&$.map(_.filter(c,function(a){return 1!=a.isDeleted}),function(a){w(a,h,r.clone())});f.empty();0<n.length&&$.map(_.filter(n,function(a){return 1!=a.isDeleted}),function(a){w(a,f,q.clone())});$("#currentQuiz").empty();
"type"in e&&"quiz"==e.type&&"isDeleted"in e&&1!=e.isDeleted&&$("#currentQuiz").html(x(e));u()}catch(d){console.log("renderQuizzes exception",d,g)}},m=function(a){if("type"in a&&"quiz"==a.type&&"id"in a){var c={};$.each(k[a.id]||[],function(a,d){if(Conversations.shouldModifyConversation()||d.author.toLowerCase()==UserSettings.getUsername().toLowerCase())c[d.answerer]={latestAnswer:d,answerCount:(c[d.answerer]||{answerCount:0}).answerCount+1}});return c}return{}},w=function(a,c,n){var d=function(b){return sprintf("quiz_summary_%s_%s",
b,a.id)},b=n.find(".quizSummary");b.attr("id",d("container")).on("click",function(){$(".quizSummary").removeClass("active");$(this).addClass("active");e=a;$("#currentQuiz").html(x(a))});b.find(".quizSummaryQuestion").attr("id",d("title")).text(a.question);var g=a.id in k?_.reduce(m(a),function(a,b){return a+("answerCount"in b?b.answerCount:0)},0):0;b.find(".quizSummaryAnswerCount").attr("id",d("answers")).text(sprintf("%s",g));if(Conversations.shouldModifyConversation())b.closest(".quizItem").find(".quizSummaryEditButton").attr("id",
d("editButton")).on("click",function(){requestUpdateQuizDialogue(Conversations.getCurrentConversationJid(),a.id)});else b.closest(".quizItem").find(".quizTeacherControls").remove();c.append(n)},x=function(a){var c=function(a,b){var c=0;a.id in k&&$.each(f,function(a,d){d.latestAnswer.answer.toLowerCase()!=b.name.toLowerCase()||!Conversations.shouldModifyConversation()&&a.toLowerCase()!=UserSettings.getUsername().toLowerCase()||(c+=1)});return c},g=function(a,b){var c="quizOption";a.id in k&&$.each(f,
function(a,d){d.latestAnswer.answer.toLowerCase()==b.name.toLowerCase()&&a.toLowerCase()==UserSettings.getUsername().toLowerCase()&&(c="quizOption activeAnswer active")});return c},d=function(b){return sprintf("quiz_%s_%s",b,a.id)},b=t.clone();b.attr("id",d("container"));b.find(".quizQuestion").text(a.question).attr("id",d("title"));if(Conversations.isAuthor()){b.find(".resultsTitle").show();var e=b.find(".quizResultsGraph");e.show();_.defer(function(){var b={labels:_.map(a.options,"name"),datasets:[{fillColor:"gray",
strokeColor:"black",data:a.options.map(function(b){return c(a,b)})}]},d={scaleOverride:!0,scaleStepWidth:1,scaleSteps:Math.max.apply(Math,b.datasets[0].data),scaleStartValue:0};console.log(b,d);(new Chart(e[0].getContext("2d"))).Bar(b,d)})}else b.find(".resultsTitle").hide(),b.find(".quizResultsGraph").hide();var f=m(a);"url"in a?b.find(".quizImagePreview").attr("src",sprintf("/quizProxy/%s/%s",Conversations.getCurrentConversationJid(),a.id)).show():b.find(".quizImagePreview").hide();var h=b.find(".quizOptionContainer"),
l=h.find(".quizOption").clone();h.empty();$.each(a.options,function(b,e){var f=l.clone();h.append(f);f.attr("id",d("option_"+e.name)).addClass(g(a,e)).on("click",function(){answerQuiz(Conversations.getCurrentConversationJid(),a.id,e.name)});f.find(".quizOptionText").text(e.text);f.find(".quizOptionName").text(e.name);Conversations.shouldModifyConversation()?f.find(".quizOptionAnswerCount").text(c(a,e)):f.find(".quizOptionCountContainer").remove()});Conversations.shouldModifyConversation()?(b.find(".quizShouldDisplayOnNextSlide").on("click",
function(){addQuizViewSlideToConversationAtIndex(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlide().index+1,a.id)}),b.find(".quizResultsShouldDisplayOnNextSlide").on("click",function(){addQuizResultsViewSlideToConversationAtIndex(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlide().index+1,a.id)}),b.find(".deleteQuiz").on("click",function(){requestDeleteQuizDialogue(Conversations.getCurrentConversationJid(),a.id)})):b.find(".currentQuizTeacherControls").hide();
return b},p=function(a){try{if("type"in a&&"quizResponse"==a.type){var c=k[a.id];c?c[_.size(c)]=a:c=[a];k[a.id]=c}else"type"in a&&"quiz"==a.type&&(g[a.id]=a,e.id==a.id&&(e=a))}catch(f){console.log("Quizzes.stanzaReceivedFunction exception",f)}};Progress.onConversationJoin.Quizzes=v;Progress.historyReceived.Quizzes=function(a){try{"type"in a&&"history"==a.type&&(v(),_.forEach(a.quizResponses,p),_.forEach(a.quizzes,p),y())}catch(c){console.log("Quizzes.historyReceivedFunction",c)}};Progress.stanzaReceived.Quizzes=
function(a){p(a);y()};return{getCurrentQuiz:function(){return e},getAllQuizzes:function(){return g},getAnswersForQuiz:m}}();
