var Quizzes=function(){var e={},q={},u={},w={},h={},z={},A={},B={},C={},p=void 0,r=function(){h.jsGrid("loadData");var a=h.jsGrid("getSorting");"field"in a&&h.jsGrid("sort",a)},v=function(a){return sprintf("/quizProxy/%s/%s",Conversations.getCurrentConversationJid(),a)};$(function(){h=$("#quizDatagrid");z=h.find(".editQuizPopup").clone();A=h.find(".answerQuizPopup").clone();B=h.find(".viewResultsPopup").clone();C=h.find(".actionsButtons").clone();h.empty();var a=function(b){jsGrid.Field.call(this,
b)};a.prototype=new jsGrid.Field({sorter:function(b,a){return new Date(b)-new Date(a)},itemTemplate:function(b){return(new Date(b)).toLocaleString()},insertTemplate:function(b){return""},editTemplate:function(b){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;h.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No polls",controller:{loadData:function(b){var a=_.map(_.keys(e),function(a){var b=e[a],d=
q[a];u[a]=D(b,640,480);return{key:a,question:b.question,author:b.author,created:b.created,id:b.id,answerCount:_.size(d),answers:d,timestamp:b.timestamp,url:b.url,optionCount:_.size(b.options),options:b.options}});"sortField"in b&&(a=_.sortBy(a,function(a){return a[b.sortField]}),"sortOrder"in b&&"desc"==b.sortOrder&&(a=_.reverse(a)));return a}},pageLoading:!1,fields:[{name:"question",type:"text",title:"Question",readOnly:!0},{name:"optionCount",type:"number",title:"Options",readOnly:!0},{name:"url",
type:"text",title:"Image",readOnly:!0,itemTemplate:function(a,d){return a?$("<img/>",{src:v(d.id),style:"width:120px;height:90px"}):$("<span/>")}},{name:"created",type:"dateField",title:"Created",readOnly:!0},{name:"timestamp",type:"dateField",title:"Modified",readOnly:!0},{name:"answerCount",type:"number",title:"Answers",readOnly:!0,itemTemplate:function(a,d){if(Conversations.shouldModifyConversation()){var c=e[d.key],k=$("<div/>");k.append(u[d.key]);k.css({width:"100%",height:"100%"});k.on("click",
function(){var a=sprintf("Results for %s",c.question),b=sprintf("quizResultsPopup_%s",c.id),g=$("<div/>",{id:b}),f=$.jAlert({title:a,width:"auto",content:g[0].outerHTML,onClose:function(a){p=void 0}});p=function(a){if(a==d.key){var g=B.clone(),l=sprintf("quizResultsPopupGraph_%s",c.id),t=$(u[d.key]).clone();console.log("reRenderingGraph: ",a,d);g.find(".quizResultsGraph").attr("id",l).append(t.clone());a=g.find(".quizImagePreview");a.attr("src",v(c.id));"url"in c?a.show():a.hide();a=g.find(".quizOptionContainer");
var G=a.find(".quizOption"),k=x(c),h=function(a,b){var l=0;a.id in q&&$.each(k,function(a,c){c.latestAnswer.answer.toLowerCase()!=b.name.toLowerCase()||!Conversations.shouldModifyConversation()&&a.toLowerCase()!=UserSettings.getUsername().toLowerCase()||(l+=1)});return l},n=_.size(k),e=.5*n,p=.25*n;a.html(_.map(c.options,function(a){var b=G.clone();b.find(".quizOptionName").text(a.name);b.find(".quizOptionText").text(a.text);var l=b.find(".quizOptionMeter");Conversations.shouldModifyConversation()?
(a=h(c,a),b.find(".quizOptionAnswerCount").text(a),l.attr("value",a).attr("min",0).attr("max",n).attr("low",p).attr("high",e).attr("optimum",n).text(sprintf("%s out of %s",a,n))):(b.find(".quizOptionCountContainer").remove(),l.remove());return b}));var r=function(a){H(t.clone()[0],640,480,function(b){var l=(new Date).getTime(),c=UserSettings.getUsername(),d=Conversations.getCurrentConversation(),c=sprintf("quizresultsimage%s%s.jpg",c,l.toString()),l=sprintf("%s:%s:%s",d.jid.toString(),c,l),d=sprintf("/uploadDataUri?jid=%s&filename=%s",
d.jid.toString(),encodeURI(l));$.ajax({url:d,type:"POST",success:function(l){l=$(l).find("resourceUrl").text();a(l,b,640,480)},error:function(a){console.log("exception while adding the quizResultsGraph to the slide",a)},data:b,cache:!1,contentType:!1,processData:!1})})};g.find(".quizResultsShouldDisplayOnSlide").unbind("click").on("click",function(){r(function(a,b,l,c){b=Conversations.getCurrentSlideJid();var d=UserSettings.getUsername(),t=(new Date).getTime(),g=sprintf("%s%s%s",b,d,t);sendStanza({type:"image",
author:d,height:c,width:l,identity:g,slide:b,source:a,privacy:"PUBLIC",tag:g,target:"presentationSpace",timestamp:t,x:10,y:10});f.closeAlert();hideBackstage()})});g.find(".quizResultsShouldDisplayOnNextSlide").unbind("click").on("click",function(){r(function(a,b,l,c){b=Conversations.getCurrentConversationJid();newIndex=Conversations.getCurrentSlide().index+1;addImageSlideToConversationAtIndex(b,newIndex,a);f.closeAlert();hideBackstage()})});$("#"+b).html(g)}};p(d.key)});return k}return $("<span/>")}},
{name:"id",type:"text",title:"Actions",readOnly:!0,sorting:!1,itemTemplate:function(a,d){var c=e[d.key],k=C.clone(),n=k.find(".editPollButton");k.find(".answerPollButton").on("click",function(){var a=sprintf("Answer poll: %s",c.question),b=sprintf("quiz_answer_%s",c.id),f=$("<span/>",{id:b}),m=$.jAlert({title:a,closeOnClick:!0,width:"auto",content:f[0].outerHTML});sprintf("answerContainer_%s",c.id);a=A.clone();$("#"+b).append(a);a.find(".quizOptionCount").text(d.optionCount);a.find(".quizOptionCountPluralizer").text(1==
d.optionCount?"":"s");var b=a.find(".quizOptionContainer"),k=b.find(".quizOption").clone();b.html(_.map(c.options,function(a){var b=k.clone();b.find(".quizOptionButton").on("click",function(){console.log("answering:",c,a);answerQuiz(Conversations.getCurrentConversationJid(),c.id,a.name);m.closeAlert()});b.find(".quizOptionName").text(a.name);b.find(".quizOptionText").text(a.text);return b}));b=a.find(".quizImagePreview");b.attr("src",v(c.id));"url"in c?b.show():b.hide()});if(Conversations.shouldModifyConversation())n.on("click",
function(){E(c)});else n.remove();return k}}]});h.jsGrid("sort",{field:"name",order:"desc"});r()});var E=function(a){var b=_.cloneDeep(a),d=sprintf("edit_quiz_%s",a.id),c=$("<span/>",{id:d}),k=sprintf("Edit poll: %s",a.question),n=$.jAlert({title:k,width:"90%",content:c[0].outerHTML}),c=z.clone();c.find(".quizQuestion").val(a.question).on("change",function(){b.question=$(this).val()});var h=c.find(".quizOptionContainer"),g=h.find(".quizOption"),f=function(a){var c=g.clone();c.find(".quizOptionName").text(a.name);
c.find(".quizOptionText").val(a.text).on("change",function(){a.text=$(this).val()});c.find(".quizOptionDelete").on("click",function(){b.options=_.filter(b.options,function(b){return b.name!=a.name});c.remove()});return c};h.html(_.map(b.options,f));c.find(".addOptionButton").on("click",function(){var a="A",c=_.reverse(_.orderBy(b.options,"name"));0<c.length&&(a=c[0].name,a=/^z+$/.test(a)?a.replace(/z/g,"a")+"a":a.slice(0,-1)+String.fromCharCode(a.slice(-1).charCodeAt()+1));a={type:"quizOption",name:a,
text:"",correct:!1,color:Colors.getColorForSeed(a)};console.log("creating new option:",b.options,a);b.options.push(a);a=f(a);h.append(a);a=a.find(".quizOptionText")[0];a.scrollIntoView();a.focus()});var m=c.find(".quizImagePreview");m.attr("src",v(b.id));"url"in b?m.show():m.hide();var e=c.find(".removeSlideImageFromQuiz");e.on("click",function(){m.attr("src",void 0).hide();e.hide();b.url=void 0});"url"in b?e.show():e.hide();c.find(".addSlideImageToQuiz").on("click",function(){WorkQueue.pause();var a=
Conversations.getCurrentConversation(),c=$("<canvas />"),d=board[0].width,f=board[0].height;c.width=d;c.height=f;c.attr("width",d);c.attr("height",f);c.css({width:d,height:f});var g=c[0].getContext("2d");g.fillStyle="white";g.fillRect(0,0,d,f);g.drawImage(board[0],0,0,d,f);var k=c[0].toDataURL("image/jpeg",.4),c=(new Date).getTime(),d=UserSettings.getUsername(),d=sprintf("quizimage%s%s.jpg",d,c.toString()),c=sprintf("%s:%s:%s",a.jid.toString(),d,c),a=sprintf("/uploadDataUri?jid=%s&filename=%s",a.jid.toString(),
encodeURI(c));$.ajax({url:a,type:"POST",success:function(a){a=$(a).find("resourceUrl").text();b.url=a;m.attr("src",k).show();e.show();WorkQueue.gracefullyResume();console.log("created new Image:",a)},error:function(a){console.log("exception while snapshotting the slide for the quizImage",a);WorkQueue.gracefullyResume()},data:k,cache:!1,contentType:!1,processData:!1})});c.find(".updateQuiz").on("click",function(){sendStanza(b);n.closeAlert()});c.find(".deleteQuiz").on("click",function(){b.deleted=
!0;sendStanza(b);n.closeAlert()});$("#"+d).append(c)},F=function(){e={};q={};Conversations.shouldModifyConversation()?$("#quizCreationButton").unbind("click").on("click",function(){var a=(new Date).getTime(),b=UserSettings.getUsername(),d=sprintf("%s_%s",b,a),a={type:"quiz",options:[{type:"quizOption",name:"A",text:"",correct:!1,color:Colors.getColorForSeed("A")},{type:"quizOption",name:"B",text:"",correct:!1,color:Colors.getColorForSeed("B")},{type:"quizOption",name:"C",text:"",correct:!1,color:Colors.getColorForSeed("C")}],
question:"",author:b,created:a,id:d,isDeleted:!1,timestamp:a,audiences:[]};E(a)}).show():$("#quizCreationButton").unbind("click").hide()},x=function(a){if("type"in a&&"quiz"==a.type&&"id"in a){var b={};$.each(q[a.id]||[],function(a,c){if(Conversations.shouldModifyConversation()||c.author.toLowerCase()==UserSettings.getUsername().toLowerCase())b[c.answerer]={latestAnswer:c,answerCount:(b[c.answerer]||{answerCount:0}).answerCount+1}});return b}return{}},D=function(a,b,d){var c=x(a),k=function(a,b){var d=
0;a.id in q&&$.each(c,function(a,c){c.latestAnswer.answer.toLowerCase()!=b.name.toLowerCase()||!Conversations.shouldModifyConversation()&&a.toLowerCase()!=UserSettings.getUsername().toLowerCase()||(d+=1)});return d},e=_.map(a.options,function(b){return{name:b.name,score:k(a,b),color:b.color}}),h=document.createElementNS("http://www.w3.org/2000/svg","svg"),g=d3.select(h).attr("width","100%").attr("height","100%").attr("viewBox","0 0 "+b+" "+d),f=d3.scaleBand().padding(.1).range([30,b-30]).domain(_.map(e,
"name")),m=d3.scaleLinear().range([30,d-30]).domain([_.max(_.map(e,"score"))+1,0]);b=d3.axisBottom(f);var p=d3.axisLeft(m);console.log(g,f.domain(),f.range(),m.domain(),m.range());g.append("g").attr("transform",sprintf("translate(0,%s)",d-30)).call(b);g.append("g").attr("transform",sprintf("translate(%s,0)",30)).call(p);g.append("g").selectAll("rect").data(e).enter().append("rect").attr("x",function(a,b){return f(a.name)}).attr("class","bar").style("fill",function(a,b){return a.color[0]}).attr("y",
function(a){return m(a.score)}).attr("height",function(a){return d-m(a.score)-30}).attr("width",f.bandwidth());return h},H=function(a,b,d,c){try{$(a);var k=(new XMLSerializer).serializeToString(a),e=new Blob([k],{type:"image/svg+xml;charset=utf-8"}),h=URL.createObjectURL(e),g=$("<img />").width(b).height(d);g.on("load",function(){var f=$("<canvas/>");f.width=b;f.height=d;f.attr("width",b);f.attr("height",d);f.css({width:b,height:d});var e=f[0].getContext("2d");e.fillStyle="rgb(255,255,255)";e.fillRect(0,
0,b,d);e.drawImage(g[0],0,0,b,d);e=f[0].toDataURL("image/jpeg",.4);console.log("img:",a,g,h,f,e);c(e)});g.attr("src",h)}catch(f){console.log("exception while converting svg to dataUrl",f)}},y=function(a){try{if("type"in a&&"quizResponse"==a.type){var b=q[a.id];b?b[_.size(b)]=a:b=[a];q[a.id]=b;a.id in e&&(u[a.id]=D(e[a.id],640,480),void 0!=p&&(console.log("reRenderingGraph: ",a,p),p(a.id)))}else"type"in a&&"quiz"==a.type&&(e[a.id]=a,w.id==a.id&&(w=a))}catch(d){console.log("Quizzes.stanzaReceivedFunction exception",
d)}};Progress.onConversationJoin.Quizzes=F;Progress.historyReceived.Quizzes=function(a){try{"type"in a&&"history"==a.type&&(F(),_.forEach(a.quizResponses,y),_.forEach(a.quizzes,y),r())}catch(b){console.log("Quizzes.historyReceivedFunction",b)}};Progress.stanzaReceived.Quizzes=function(a){y(a);r()};return{getCurrentQuiz:function(){return w},getAllQuizzes:function(){return e},getAnswersForQuiz:x,reRender:r}}();
