var Quizzes=function(){var g={},k={},d={},e={},q={},h={},t={},m={},u={};$(function(){e=$("#unansweredQuizListing");q=e.find(".quizItem").clone();h=$("#answeredQuizListing");t=h.find(".quizItem").clone();m=$("#currentQuiz");u=m.find(".currentQuizItem").clone();$("#quizzes").click(function(){showBackstage("quizzes")});var a=$("<div />",{id:"quizCount","class":"icon-txt"});$("#feedbackStatus").prepend(a);a.click(function(){showBackstage("quizzes")});v()});var v=function(){var a=_.size(g);0<a?1==a?($("#quizCount").text(sprintf("%s quiz",
_.size(g))),$("#dedicatedQuizCount").text("This conversation has 1 quiz")):($("#quizCount").text(sprintf("%s quizzes",_.size(g))),$("#dedicatedQuizCount").text(sprintf("This conversation has %s quizzes",a))):($("#quizCount").text(""),$("#dedicatedQuizCount").text("This conversation has no quizzes"))},w=function(){g={};k={};d={};e.empty();h.empty();m.empty();$("#quizCount").text("");Conversations.shouldModifyConversation()?$("#quizCreationButton").unbind("click").on("click",function(){requestCreateQuizDialogue(Conversations.getCurrentConversation())}).show():
$("#quizCreationButton").unbind("click").hide()},z=function(){try{var a=_.sortBy(g,function(a){return a.created}),c=$.map(a,function(a,b){if(void 0!=l(a)[UserSettings.getUsername()])return a}),n=$.map(a,function(a,b){if(void 0==l(a)[UserSettings.getUsername()])return a});h.empty();0<c.length&&$.map(_.filter(c,function(a){return 1!=a.isDeleted}),function(a){x(a,h,t.clone())});e.empty();0<n.length&&$.map(_.filter(n,function(a){return 1!=a.isDeleted}),function(a){x(a,e,q.clone())});$("#currentQuiz").empty();
"type"in d&&"quiz"==d.type&&"isDeleted"in d&&1!=d.isDeleted&&$("#currentQuiz").html(y(d));v()}catch(f){console.log("renderQuizzes exception",f,g)}},l=function(a){if("type"in a&&"quiz"==a.type&&"id"in a){var c={};$.each(k[a.id]||[],function(a,f){if(Conversations.shouldModifyConversation()||f.author.toLowerCase()==UserSettings.getUsername().toLowerCase())c[f.answerer]={latestAnswer:f,answerCount:(c[f.answerer]||{answerCount:0}).answerCount+1}});return c}return{}},x=function(a,c,n){var f=function(b){return sprintf("quiz_summary_%s_%s",
b,a.id)},b=n.find(".quizSummary");b.attr("id",f("container")).on("click",function(){$(".quizSummary").removeClass("active");$(this).addClass("active");d=a;$("#currentQuiz").html(y(a))});b.find(".quizSummaryQuestion").attr("id",f("title")).text(a.question);var g=a.id in k?_.reduce(l(a),function(a,b){return a+("answerCount"in b?b.answerCount:0)},0):0;b.find(".quizSummaryAnswerCount").attr("id",f("answers")).text(sprintf("%s",g));if(Conversations.shouldModifyConversation())b.closest(".quizItem").find(".quizSummaryEditButton").attr("id",
f("editButton")).on("click",function(){requestUpdateQuizDialogue(Conversations.getCurrentConversationJid(),a.id)});else b.closest(".quizItem").find(".quizTeacherControls").remove();c.append(n)},y=function(a){var c=function(a,b){var c=0;a.id in k&&$.each(e,function(a,f){f.latestAnswer.answer.toLowerCase()!=b.name.toLowerCase()||!Conversations.shouldModifyConversation()&&a.toLowerCase()!=UserSettings.getUsername().toLowerCase()||(c+=1)});return c},g=function(a,b){var c="quizOption";a.id in k&&$.each(e,
function(a,f){f.latestAnswer.answer.toLowerCase()==b.name.toLowerCase()&&a.toLowerCase()==UserSettings.getUsername().toLowerCase()&&(c="quizOption activeAnswer active")});return c},f=function(b){return sprintf("quiz_%s_%s",b,a.id)},b=u.clone();b.attr("id",f("container"));b.find(".quizQuestion").text(a.question).attr("id",f("title"));if(Conversations.isAuthor()){b.find(".resultsTitle").show();var d=b.find(".quizResultsGraph");d.show();_.defer(function(){var b={type:"horizontalBar",data:{labels:_.map(a.options,
"name"),datasets:[{data:a.options.map(function(b){return c(a,b)}),borderColor:["black"],backgroundColor:["gray"],borderWidth:1}]},options:{scales:{yAxes:[{stacked:!0,ticks:{}}],xAxes:[{type:"linear",position:"bottom",ticks:{stepSize:1}}]},legend:{display:!1}}};console.log(b);new Chart(d[0].getContext("2d"),b)})}else b.find(".resultsTitle").hide(),b.find(".quizResultsGraph").hide();var e=l(a),h=_.size(e),m=.5*h,p=.25*h;"url"in a?b.find(".quizImagePreview").attr("src",sprintf("/quizProxy/%s/%s",Conversations.getCurrentConversationJid(),
a.id)).show():b.find(".quizImagePreview").hide();b.find(".quizOptionCountContainer");b.find(".quizOptionCount").text(a.options.length);b.find(".quizOptionCountPluralizer").text(1==a.options.length?"":"s");var r=b.find(".quizOptionContainer"),q=r.find(".quizOption").clone();r.empty();$.each(a.options,function(b,d){var e=q.clone();r.append(e);e.attr("id",f("option_"+d.name)).addClass(g(a,d)).on("click",function(){answerQuiz(Conversations.getCurrentConversationJid(),a.id,d.name)});e.find(".quizOptionText").text(d.text);
e.find(".quizOptionName").text(d.name);var k=e.find(".quizOptionMeter");if(Conversations.shouldModifyConversation()){var l=c(a,d);e.find(".quizOptionAnswerCount").text(l);k.attr("value",l).attr("min",0).attr("max",h).attr("low",p).attr("high",m).attr("optimum",h).text(sprintf("%s out of %s",l,h))}else e.find(".quizOptionCountContainer").remove(),k.remove()});Conversations.shouldModifyConversation()?(b.find(".quizShouldDisplayOnNextSlide").on("click",function(){addQuizViewSlideToConversationAtIndex(Conversations.getCurrentConversationJid(),
Conversations.getCurrentSlide().index+1,a.id)}),b.find(".quizResultsShouldDisplayOnNextSlide").on("click",function(){addQuizResultsViewSlideToConversationAtIndex(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlide().index+1,a.id)}),b.find(".deleteQuiz").on("click",function(){requestDeleteQuizDialogue(Conversations.getCurrentConversationJid(),a.id)})):b.find(".currentQuizTeacherControls").hide();return b},p=function(a){try{if("type"in a&&"quizResponse"==a.type){var c=k[a.id];c?
c[_.size(c)]=a:c=[a];k[a.id]=c}else"type"in a&&"quiz"==a.type&&(g[a.id]=a,d.id==a.id&&(d=a))}catch(e){console.log("Quizzes.stanzaReceivedFunction exception",e)}};Progress.onConversationJoin.Quizzes=w;Progress.historyReceived.Quizzes=function(a){try{"type"in a&&"history"==a.type&&(w(),_.forEach(a.quizResponses,p),_.forEach(a.quizzes,p),z())}catch(c){console.log("Quizzes.historyReceivedFunction",c)}};Progress.stanzaReceived.Quizzes=function(a){p(a);z()};return{getCurrentQuiz:function(){return d},getAllQuizzes:function(){return g},
getAnswersForQuiz:l}}();
