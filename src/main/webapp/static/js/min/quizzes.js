var Quizzes=function(){var f={},k={},t={},x={},e={},B={},C={},D={},E={},m=void 0,u=function(){e.jsGrid("loadData");var a=e.jsGrid("getSorting");"field"in a&&e.jsGrid("sort",a)},v=function(a){return sprintf("/quizProxy/%s/%s",Conversations.getCurrentConversationJid(),a)};$(function(){e=$("#quizDatagrid");B=e.find(".editQuizPopup").clone();C=e.find(".answerQuizPopup").clone();D=e.find(".viewResultsPopup").clone();E=e.find(".actionsButtons").clone();e.empty();var a=function(a){jsGrid.Field.call(this,
a)};a.prototype=new jsGrid.Field({sorter:function(a,c){return new Date(a)-new Date(c)},itemTemplate:function(a){return(new Date(a)).toLocaleString()},insertTemplate:function(a){return""},editTemplate:function(a){return""},insertValue:function(){return""},editValue:function(){return""}});jsGrid.fields.dateField=a;var b=function(a){var c=f[a.key],b=sprintf("Results for %s",c.question),g=sprintf("quizResultsPopup_%s",c.id),y=$("<div/>",{id:g}),e=$.jAlert({title:b,width:"auto",content:y[0].outerHTML,
onClose:function(a){m=void 0}});m=function(b){if(b==a.key){b=D.clone();var d=sprintf("quizResultsPopupGraph_%s",c.id),l=$(t[a.key]).clone();b.find(".quizResultsGraph").attr("id",d).append(l.clone());d=b.find(".quizImagePreview");d.attr("src",v(c.id));"url"in c?d.show():d.hide();var d=b.find(".quizOptionContainer"),h=d.find(".quizOption"),q=w(c),z=function(a,b){var c=0;a.id in k&&$.each(q,function(a,h){h.latestAnswer.answer.toLowerCase()!=b.name.toLowerCase()||!Conversations.shouldModifyConversation()&&
a.toLowerCase()!=UserSettings.getUsername().toLowerCase()||(c+=1)});return c},r=_.size(q),y=.5*r,f=.25*r;d.html(_.map(c.options,function(a){var b=h.clone();b.find(".quizOptionName").text(a.name);b.find(".quizOptionText").text(a.text);var d=b.find(".quizOptionMeter");Conversations.shouldModifyConversation()?(a=z(c,a),b.find(".quizOptionAnswerCount").text(a),d.attr("value",a).attr("min",0).attr("max",r).attr("low",f).attr("high",y).attr("optimum",r).text(sprintf("%s out of %s",a,r))):(b.find(".quizOptionCountContainer").remove(),
d.remove());return b}));var F=function(a){var b=l.clone()[0],b=(new XMLSerializer).serializeToString(b),c=(new Date).getTime(),h=UserSettings.getUsername(),d=Conversations.getCurrentConversation(),h=sprintf("quizresultsimage%s%s.jpg",h,c.toString()),c=sprintf("%s:%s:%s",d.jid.toString(),h,c),d=sprintf("/uploadSvg?jid=%s&filename=%s&width=%s&height=%s",d.jid.toString(),encodeURI(c),640,480);$.ajax({url:d,type:"POST",success:function(b){b=$(b).find("resourceUrl").text();a(b,640,480)},error:function(a){console.log("exception while adding the quizResultsGraph to the slide",
a)},data:b,cache:!1,contentType:!1,processData:!1})};b.find(".quizResultsShouldDisplayOnSlide").unbind("click").on("click",function(){F(function(a,b,c){var h=Conversations.getCurrentSlideJid(),d=UserSettings.getUsername(),q=(new Date).getTime(),g=sprintf("%s%s%s",h,d,q);sendStanza({type:"image",author:d,height:c,width:b,identity:g,slide:h,source:a,privacy:"PUBLIC",tag:g,target:"presentationSpace",timestamp:q,x:10,y:10});e.closeAlert();hideBackstage()})});b.find(".quizResultsShouldDisplayOnNextSlide").unbind("click").on("click",
function(){F(function(a,b,c){b=Conversations.getCurrentConversationJid();newIndex=Conversations.getCurrentSlide().index+1;addImageSlideToConversationAtIndex(b,newIndex,a);e.closeAlert();hideBackstage()})});$("#"+g).html(b)}};m(a.key)};e.jsGrid({width:"100%",height:"auto",inserting:!1,editing:!1,sorting:!0,paging:!0,noDataContent:"No polls",controller:{loadData:function(a){var b=_.map(_.keys(f),function(a){var b=f[a],c=k[a];t[a]=G(b,640,480);return{key:a,question:b.question,author:b.author,created:b.created,
id:b.id,answerCount:_.size(c),answers:c,timestamp:b.timestamp,url:b.url,optionCount:_.size(b.options),options:b.options}});"sortField"in a&&(b=_.sortBy(b,function(b){return b[a.sortField]}),"sortOrder"in a&&"desc"==a.sortOrder&&(b=_.reverse(b)));return b}},pageLoading:!1,fields:[{name:"question",type:"text",title:"Question",readOnly:!0},{name:"optionCount",type:"number",title:"Options",readOnly:!0},{name:"url",type:"text",title:"Image",readOnly:!0,itemTemplate:function(a,b){return a?$("<img/>",{src:v(b.id),
style:"width:120px;height:90px"}):$("<span/>")}},{name:"created",type:"dateField",title:"Created",readOnly:!0},{name:"timestamp",type:"dateField",title:"Modified",readOnly:!0},{name:"answerCount",type:"number",title:"Answers",readOnly:!0,itemTemplate:function(a,c){var d=f[c.key];if(Conversations.shouldModifyConversation())return d=$("<div/>"),d.append(t[c.key]),d.css({width:"100%",height:"100%"}),d.on("click",function(){b(c)}),d;d=w(d)[UserSettings.getUsername()];return void 0!=d&&"latestAnswer"in
d?$("<span/>",{text:d.latestAnswer.answer}):$("<span/>",{text:"unanswered"})}},{name:"id",type:"text",title:"Actions",readOnly:!0,sorting:!1,itemTemplate:function(a,c){var d=f[c.key],g=E.clone(),e=g.find(".editPollButton"),k=g.find(".answerPollButton"),p=g.find(".viewAnswersButton");k.on("click",function(){var a=sprintf("Answer poll: %s",d.question),b=sprintf("quiz_answer_%s",d.id),h=$("<span/>",{id:b}),q=$.jAlert({title:a,closeOnClick:!0,width:"auto",content:h[0].outerHTML});sprintf("answerContainer_%s",
d.id);a=C.clone();$("#"+b).append(a);a.find(".quizOptionCount").text(c.optionCount);a.find(".quizOptionCountPluralizer").text(1==c.optionCount?"":"s");var b=a.find(".quizOptionContainer"),z=b.find(".quizOption").clone();b.html(_.map(d.options,function(a){var b=z.clone();b.find(".quizOptionButton").on("click",function(){answerQuiz(Conversations.getCurrentConversationJid(),d.id,a.name);q.closeAlert()});b.find(".quizOptionName").text(a.name);b.find(".quizOptionText").text(a.text);return b}));b=a.find(".quizImagePreview");
b.attr("src",v(d.id));"url"in d?b.show():b.hide()});Conversations.shouldModifyConversation()?(e.on("click",function(){H(d)}),p.on("click",function(){b(c)})):(e.remove(),veiwAnswerButton.remove());return g}}]});e.jsGrid("sort",{field:"name",order:"desc"});u()});var H=function(a){var b=_.cloneDeep(a),e=sprintf("edit_quiz_%s",a.id),c=$("<span/>",{id:e}),d=sprintf("Edit poll: %s",a.question),g=$.jAlert({title:d,width:"90%",content:c[0].outerHTML}),c=B.clone();c.find(".quizQuestion").val(a.question).on("change",
function(){b.question=$(this).val()});var f=c.find(".quizOptionContainer"),k=f.find(".quizOption"),p=function(a){var c=k.clone();c.find(".quizOptionName").text(a.name);c.find(".quizOptionText").val(a.text).on("change",function(){a.text=$(this).val()});c.find(".quizOptionDelete").on("click",function(){b.options=_.filter(b.options,function(b){return b.name!=a.name});c.remove()});return c};f.html(_.map(b.options,p));c.find(".addOptionButton").on("click",function(){var a="A",c=_.reverse(_.orderBy(b.options,
"name"));0<c.length&&(a=c[0].name,a=/^z+$/.test(a)?a.replace(/z/g,"a")+"a":a.slice(0,-1)+String.fromCharCode(a.slice(-1).charCodeAt()+1));a={type:"quizOption",name:a,text:"",correct:!1,color:Colors.getColorForSeed(a)};b.options.push(a);a=p(a);f.append(a);a=a.find(".quizOptionText")[0];a.scrollIntoView();a.focus()});var n=c.find(".quizImagePreview");n.attr("src",v(b.id));"url"in b?n.show():n.hide();var l=c.find(".removeSlideImageFromQuiz");l.on("click",function(){n.attr("src",void 0).hide();l.hide();
b.url=void 0});"url"in b?l.show():l.hide();c.find(".addSlideImageToQuiz").on("click",function(){WorkQueue.pause();var a=Conversations.getCurrentConversation(),c=$("<canvas />"),d=board[0].width,e=board[0].height;c.width=d;c.height=e;c.attr("width",d);c.attr("height",e);c.css({width:d,height:e});var g=c[0].getContext("2d");g.fillStyle="white";g.fillRect(0,0,d,e);g.drawImage(board[0],0,0,d,e);var f=c[0].toDataURL("image/jpeg",.4),c=(new Date).getTime(),d=UserSettings.getUsername(),d=sprintf("quizimage%s%s.jpg",
d,c.toString()),c=sprintf("%s:%s:%s",a.jid.toString(),d,c),a=sprintf("/uploadDataUri?jid=%s&filename=%s",a.jid.toString(),encodeURI(c));$.ajax({url:a,type:"POST",success:function(a){a=$(a).find("resourceUrl").text();b.url=a;n.attr("src",f).show();l.show();WorkQueue.gracefullyResume()},error:function(a){console.log("exception while snapshotting the slide for the quizImage",a);WorkQueue.gracefullyResume()},data:f,cache:!1,contentType:!1,processData:!1})});c.find(".updateQuiz").on("click",function(){sendStanza(b);
g.closeAlert()});c.find(".deleteQuiz").on("click",function(){b.deleted=!0;sendStanza(b);g.closeAlert()});$("#"+e).append(c)},I=function(){f={};k={};Conversations.shouldModifyConversation()?$("#quizCreationButton").unbind("click").on("click",function(){var a=(new Date).getTime(),b=UserSettings.getUsername(),e=sprintf("%s",a),a={type:"quiz",options:[{type:"quizOption",name:"A",text:"",correct:!1,color:Colors.getColorForSeed("A")},{type:"quizOption",name:"B",text:"",correct:!1,color:Colors.getColorForSeed("B")},
{type:"quizOption",name:"C",text:"",correct:!1,color:Colors.getColorForSeed("C")}],question:"",author:b,created:a,id:e,isDeleted:!1,timestamp:a,audiences:[]};H(a)}).show():$("#quizCreationButton").unbind("click").hide()},w=function(a){if("type"in a&&"quiz"==a.type&&"id"in a){var b={};$.each(k[a.id]||[],function(a,c){if(Conversations.shouldModifyConversation()||c.author.toLowerCase()==UserSettings.getUsername().toLowerCase())b[c.answerer]={latestAnswer:c,answerCount:(b[c.answerer]||{answerCount:0}).answerCount+
1}});return b}return{}},G=function(a,b,e){var c=w(a),d=function(a,b){var d=0;a.id in k&&$.each(c,function(a,c){c.latestAnswer.answer.toLowerCase()!=b.name.toLowerCase()||!Conversations.shouldModifyConversation()&&a.toLowerCase()!=UserSettings.getUsername().toLowerCase()||(d+=1)});return d},g=_.map(a.options,function(b){return{name:b.name,score:d(a,b),color:b.color}}),f=document.createElementNS("http://www.w3.org/2000/svg","svg"),m=d3.select(f).attr("width","100%").attr("height","100%").attr("viewBox",
"0 0 "+b+" "+e),p=d3.scaleBand().padding(.1).range([30,b-30]).domain(_.map(g,"name")),n=d3.scaleLinear().range([30,e-30]).domain([_.max(_.map(g,"score"))+1,0]);b=d3.axisBottom(p);var l=d3.axisLeft(n);m.append("g").attr("transform",sprintf("translate(0,%s)",e-30)).call(b);m.append("g").attr("transform",sprintf("translate(%s,0)",30)).call(l);m.append("g").selectAll("rect").data(g).enter().append("rect").attr("x",function(a,b){return p(a.name)}).attr("class","bar").style("fill",function(a,b){return a.color[0]}).attr("y",
function(a){return n(a.score)}).attr("height",function(a){return e-n(a.score)-30}).attr("width",p.bandwidth());return f},A=function(a){try{if("type"in a&&"quizResponse"==a.type){var b=k[a.id];b?b[_.size(b)]=a:b=[a];k[a.id]=b;a.id in f&&(t[a.id]=G(f[a.id],640,480),void 0!=m&&m(a.id))}else"type"in a&&"quiz"==a.type&&(f[a.id]=a,x.id==a.id&&(x=a))}catch(e){console.log("Quizzes.stanzaReceivedFunction exception",e)}};Progress.onConversationJoin.Quizzes=I;Progress.historyReceived.Quizzes=function(a){try{"type"in
a&&"history"==a.type&&(I(),_.forEach(a.quizResponses,A),_.forEach(a.quizzes,A),u())}catch(b){console.log("Quizzes.historyReceivedFunction",b)}};Progress.stanzaReceived.Quizzes=function(a){A(a);u()};return{getCurrentQuiz:function(){return x},getAllQuizzes:function(){return f},getAnswersForQuiz:w,reRender:u}}();
