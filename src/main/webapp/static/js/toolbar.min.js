function devLogAdd(a){$("#devLog").append($("<div />",{text:a}))}function devLogSet(a){$("#devLog").html($("<div />",{text:a}))}var incrementKey=function(a,e){e in a?a[e]++:a[e]=1},highQualityInkIfAvailable=!1,implicitlyExpanding=!1,showGrid=!1,expansion=100,commandMode=!0;
function unregisterPositionHandlers(a){$.each("pointerdown pointermove pointerup pointerout pointerleave pointercancel mouseup mousemove mousedown touchstart touchmove touchend touchcancelled mouseout touchleave gesturechange gesturestart".split(" "),function(e,f){a.unbind(f)});WorkQueue.gracefullyResume()}
function progress(){var a=$("<div />").css({display:"inline-block",position:"relative",width:px(120),height:px(12),"background-color":"gray"}),e=$("<span />").css({position:"absolute",width:0,top:0,left:0,height:"100%","background-color":"green"}).appendTo(a),f=$("<progress />");f.append(a);var m=1,c=0,g=function(){e.css("width",sprintf("%s%%",Math.floor(c/m*100)));f.attr({value:c,max:m})},k={element:f,value:function(a){c=a;g();return k},max:function(c){m=c;g();return k}};return k}
function proportion(a,e){return a/e/(boardWidth/boardHeight)}function scaleScreenToWorld(a){var e;e=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return a*e}function scaleWorldToScreen(a){var e;e=1<proportion(boardWidth,boardHeight)?viewboxWidth/boardWidth:viewboxHeight/boardHeight;return a/e}function screenToWorld(a,e){var f=scaleScreenToWorld(a)+viewboxX,m=scaleScreenToWorld(e)+viewboxY;return{x:f,y:m}}
function worldToScreen(a,e){var f=scaleWorldToScreen(a-viewboxX),m=scaleWorldToScreen(e-viewboxY);return{x:f,y:m}}function detectPointerEvents(){try{return"pointerEnabled"in Navigator&&1==Navigator.pointerEnabled||void 0!=PointerEvent}catch(a){return!1}}
function registerPositionHandlers(a,e,f,m){var c=!1,g=function(c,a){var h=[c.x-10,c.y-10,c.x+10,c.y+10],n=!0;_.each(Modes.canvasInteractables,function(e,g){_.each(e,function(e){a in e&&(e.activated||intersectRect(h,e.bounds))&&(n=n&&e[a](c))})});return n},k=function(c,a){return{shift:c.shiftKey,ctrl:c.ctrlKey,alt:c.altKey,eraser:a}};$.each(a,function(a,z){var h=$(z);h.css({"touch-action":"none"});var n=!1,t={},v=function(b){var A=b.originalEvent.pointerId,r="pen"==b.originalEvent.pointerType&&5==
b.originalEvent.button,c=h.offset(),a=b.pageX-c.left,c=b.pageY-c.top,d=b.originalEvent.pressure||.5,q=screenToWorld(a,c),l=t[A]||{pointerId:A,pointerType:b.originalEvent.pointerType,eraser:r,points:[]};l.points.push({x:q.x,y:q.y,screenX:a,screenY:c,z:d});l.eraser=l.eraser||r;t[A]=l;1<_.size(t)&&(0==n&&_.each(t,function(b){b.points=[_.last(b.points)]}),n=!0);return{pointerType:b.pointerType,eraser:l.eraser,x:a,y:c,z:d,worldPos:q}},p=function(b){var A=b.originalEvent.pointerId,r="pen"==b.originalEvent.pointerType&&
5==b.originalEvent.button,a=h.offset(),d=b.pageX-a.left,a=b.pageY-a.top,l=b.originalEvent.pressure||.5,q=screenToWorld(d,a);delete t[A];n&&0==_.size(t)&&(c=n=!1);return{pointerType:b.pointerType,eraser:r,x:d,y:a,z:l,worldPos:q}};if(detectPointerEvents()){var w=_.throttle(function(){if(1<_.size(t)){takeControlOfViewbox();var b=_.map(_.filter(t,function(b){return 0<_.size(b.points)}),function(b){var c=_.first(b.points);b=_.last(b.points);return[c,b]});t={};var c=_.meanBy(b,function(b){return b[0].x-
b[1].x}),r=_.meanBy(b,function(b){return b[0].y-b[1].y});Pan.translate(scaleWorldToScreen(c),scaleWorldToScreen(r));var c=_.min(_.map(b,function(b){return b[0].y})),a=_.max(_.map(b,function(b){return b[0].y})),r=_.min(_.map(b,function(b){return b[0].x})),d=_.max(_.map(b,function(b){return b[0].x})),c=a-c,r=d-r,d=_.min(_.map(b,function(b){return b[1].y})),a=_.max(_.map(b,function(b){return b[1].y})),l=_.min(_.map(b,function(b){return b[1].x})),b=(_.max(_.map(b,function(b){return b[1].x}))-l+(a-d))/
2;Zoom.scale((r+c)/2/b)}},25);h.bind("pointerdown",function(b){var a=v(b);b.preventDefault();WorkQueue.pause();1!=_.size(t)||n||(c=!0,g(a.worldPos,"down")&&e(a.x,a.y,a.z,a.worldPos,k(b,a.eraser)))});h.bind("pointermove",function(b){var a=v(b);b.preventDefault();(b.originalEvent.pointerType==b.POINTER_TYPE_TOUCH||"touch"==b.originalEvent.pointerType&&1<_.size(t))&&w();1!=_.size(t)||n||g(a.worldPos,"move")&&c&&f(a.x,a.y,a.z,a.worldPos,k(b,a.eraser))});h.bind("pointerup",function(b){var a=p(b);WorkQueue.gracefullyResume();
b.preventDefault();g(a.worldPos,"up")&&c&&!n&&m(a.x,a.y,a.z,a.worldPos,k(b,a.eraser));c=!1});var y=function(b,a){t={};WorkQueue.gracefullyResume();var r=screenToWorld(b,a),d=r.x,r=r.y;d<viewboxX?(takeControlOfViewbox(),Extend.left()):d>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):r<viewboxY?(takeControlOfViewbox(),Extend.up()):r>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),Extend.down());c=!1},d=function(b){p(b);WorkQueue.gracefullyResume();b.preventDefault();c&&y(b.offsetX,
b.offsetY);c=!1;_.each(Modes.canvasInteractables,function(b){b.deactivate&&b.deactivate()})};h.bind("pointerout",d);h.bind("pointerleave",d);h.bind("pointercancel",d)}else{h.bind("mousedown",function(b){WorkQueue.pause();var a=h.offset();c=!0;var r=b.pageX-a.left,a=b.pageY-a.top,d=screenToWorld(r,a);g(d,"down")&&e(r,a,.5,d,k(b));b.preventDefault()});h.bind("mousemove",function(b){var a=h.offset();b.preventDefault();var r=b.pageX-a.left,a=b.pageY-a.top,d=screenToWorld(r,a);g(d,"move")&&c&&f(r,a,.5,
d,k(b))});h.bind("mouseup",function(b){WorkQueue.gracefullyResume();b.preventDefault();var a=h.offset(),d=b.pageX-a.left,a=b.pageY-a.top,l=screenToWorld(d,a);g(l,"up")&&c&&m(d,a,.5,l,k(b));c=!1});var b=function(b,a){WorkQueue.gracefullyResume();var d=screenToWorld(b,a),l=d.x,d=d.y;l<viewboxX?(takeControlOfViewbox(),Extend.left()):l>=viewboxX+viewboxWidth?(takeControlOfViewbox(),Extend.right()):d<viewboxY?(takeControlOfViewbox(),Extend.up()):d>=viewboxY+viewboxHeight&&(takeControlOfViewbox(),Extend.down());
c=!1};h.bind("mouseout",function(a){WorkQueue.gracefullyResume();a.preventDefault();c&&b(a.offsetX,a.offsetY);c=!1});var q,l=function(b){return{x:average(_.map(b,"x")),y:average(_.map(b,"y"))}},x=function(b){var a=[],c=h.offset();$.each(b,function(b,d){a.push({x:d.pageX-c.left,y:d.pageY-c.top,identifier:d.identifier})});return a};h.bind("touchstart",function(b){WorkQueue.pause();b.preventDefault();var a=x(b.originalEvent.touches);if(1==a.length){var a=a[0],d=screenToWorld(a.x,a.y);c=!0;g(d,"down")&&
e(a.x,a.y,.5,d,k(b))}else q=l(a)});h.bind("touchmove",function(b){b.preventDefault();var a=x(b.originalEvent.touches);switch(a.length){case 0:break;case 1:var a=a[0],d=screenToWorld(a.x,a.y);g(d,"move")&&c&&f(a.x,a.y,.5,d,k(b));break;default:b=l(a),a=b.x-q.x,d=b.y-q.y,q=b,takeControlOfViewbox(),Pan.translate(-1*a,-1*d)}});h.bind("touchend",function(a){WorkQueue.gracefullyResume();a.preventDefault();var d=h.offset(),l=a.originalEvent.changedTouches[0],q=l.pageX-d.left,d=l.pageY-d.top,l=screenToWorld(q,
d);g(l,"up")&&c&&(0>q||0>d||q>boardWidth||d>boardHeight?b(q,d):m(q,d,.5,l,k(a)));c=!1});var C=1;h.bind("gesturechange",function(b){WorkQueue.pause();b.preventDefault();c=!1;b=b.originalEvent.scale;takeControlOfViewbox();Zoom.scale(C/b);C=b});h.bind("gestureend",function(){WorkQueue.gracefullyResume();C=1})}});return function(a){c=a}}function aspectConstrainedDimensions(a,e){var f=boardHeight/boardWidth,m={height:e,width:a};e/a>f?m.height=a*f:m.width=e/f;return m}
function aspectConstrainedRect(a,e,f){var m=boardHeight/boardWidth,c={left:a.left,top:a.top,right:a.right,bottom:a.bottom,width:a.width,height:a.height};a.height/a.width>m?(c.height=a.width*m,f&&(e=a.height-c.height,"center"==f?c.top+=e/2:"bottom"==f&&(c.top+=e))):(c.width=a.height/m,e&&(f=a.width-c.width,"center"==e?c.left+=f/2:"right"==e&&(c.left+=f)));c.right=c.left+c.width;c.bottom=c.top+c.height;return c}
function copyBuffer(a){var e=document.createElement("canvas");e.width=a.width;e.height=a.height;e.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,a.width,a.height);return e}function intersectRect(a,e){return"undefined"!=typeof a&&"undefined"!=typeof e?!(e[0]>a[2]||e[2]<a[0]||e[1]>a[3]||e[3]<a[1]):!1}function overlapRect(a,e){return intersectRect(a,e)?(Math.max(a[0],e[0])-Math.min(a[2],e[2]))*(Math.max(a[1],e[1])-Math.min(a[3],e[3])):0}
function rectFromTwoPoints(a,e,f){f=f||0;var m,c,g;a.x<e.x?(m=a.x,g=e.x):(m=e.x,g=a.x);a.y<e.y?(c=a.y,a=e.y):(c=e.y,a=a.y);e=g-m;var k=a-c;e<f&&(g+=f-e,e=g-m);k<f&&(a+=f-k,k=a-c);return{left:m,top:c,right:g,bottom:a,width:e,height:k}}function updateMarquee(a,e,f){e=rectFromTwoPoints(e,f);f=$("#selectionAdorner");jQuery.contains(f,a)||f.append(a);a.is(":visible")||a.show();a.css({left:px(e.left),top:px(e.top),width:px(e.width),height:px(e.height)})}
function clampToView(a){var e=a.x,f=a.y;0>a.x&&(e=0);a.x>boardWidth&&(e=boardWidth);0>a.y&&(f=0);a.y>boardHeight&&(f=boardHeight);return{x:e,y:f}}
var bounceButton=function(a){var e=$(a);e.addClass("activeBrush");setTimeout(function(){e.removeClass("activeBrush")},200)},Modes=function(){var a=function(){$(".activeTool").removeClass("activeTool");$(".activeMode").addClass("inactiveMode").removeClass("activeMode")},e=function(c,e){a();$(c).addClass("activeMode").removeClass("inactiveMode");$(".activeTool").removeClass("activeTool").addClass("inactiveTool");$(e).addClass("activeTool").removeClass("inactiveTool")},f={name:"none",activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.none;a()},deactivate:function(){a();unregisterPositionHandlers(board)}},m=function(a,e){a in Modes.canvasInteractables||(Modes.canvasInteractables[a]=[]);Modes.canvasInteractables[a].push(e);blit()};return{currentMode:f,none:f,canvasInteractables:{},text:function(){var c=function(){},g,k,u,f,h,n,t,v,p,w,y,d,b,q,l,x=function(b){return Modes.text.editorFor({bounds:[b.x,b.y,b.x,b.y],identity:sprintf("%s_%s_%s",UserSettings.getUsername(),Date.now(),_.uniqueId()),privacy:Privacy.getCurrentPrivacy(),
requestedWidth:300,width:300,height:0,x:b.x,y:b.y,type:"multiWordText",author:UserSettings.getUsername(),words:[]})};$(function(){l=$("#textDropdowns");q=$("#fontOptions");g=$("#fontFamilySelector");k=$("#fontSizeSelector");u=$("#fontColorSelector");f=$("#fontBoldSelector");h=$("#fontItalicSelector");n=$("#fontUnderlineSelector");t=$("#justifySelector");v=$("#presetFitToText");p=$("#presetRunToEdge");w=$("#presetNarrow");y=$("#presetWiden");b=$("#presetFullscreen");d=$("#presetCenterOnScreen");var a=
g.find(".fontFamilyOption").clone(),c=k.find(".fontSizeOption").clone(),e=u.find(".fontColorOption").clone();Fonts.getAllFamilies().map(function(b){g.append(a.clone().attr("value",b).text(b))});Fonts.getAllSizes().map(function(b){k.append(c.clone().attr("value",b).text(b))});Colors.getAllNamedColors().map(function(b){u.append(e.clone().attr("value",b.rgb).text(b.name))});var r=function(b){return function(){_.each(boardContent.multiWordTexts,function(a){if(a.doc.isActive){var d=a.doc.selectedRange();
d.setFormatting(b,!0!==d.getFormatting()[b]);0<a.doc.save().length&&sendRichText(a)}})}},B=function(b){return function(){var a=$(this).val();_.each(boardContent.multiWordTexts,function(d){d.doc.isActive&&(console.log(a),d.doc.selectedRange().setFormatting(b,a),0<d.doc.save().length&&sendRichText(d))})}},x=function(b){return function(){_.each(boardContent.multiWordTexts,function(a){if(a.doc.isActive){switch(b){case "runToEdge":var d=screenToWorld(boardWidth,0);a.doc.width(d.x+viewboxX-a.x);break;case "fitToText":a.doc.width(a.doc.frame.actualWidth());
break;case "widen":a.doc.width(1.6*a.doc.frame.actualWidth());break;case "narrow":a.doc.width(.6*a.doc.frame.actualWidth());break;case "centerOnScreen":a.doc.width(screenToWorld(boardWidth,0).x);a.doc.selectedRange().setFormatting("align","center");a.doc.position.x=viewboxX;break;case "fullscreen":a.doc.position.x=viewboxX,a.doc.position.y=viewboxY,a.doc.width(screenToWorld(boardWidth,0).x),a.doc.select(0,a.doc.frame.length-1),a.doc.selectedRange().setFormatting("align","center"),a.doc.selectedRange().setFormatting("bold",
!0),d=a.doc.documentRange().save(),d.push({text:"\n"}),d.push({text:"\n"}),a.doc.load(d),d=a.doc.frame.length-1,a.doc.select(d,d)}a.doc.contentChanged.fire()}})}};f.click(r("bold"));h.click(r("italic"));n.click(r("underline"));g.change(B("font"));k.change(B("size"));u.change(B("color"));t.change(B("align"));v.click(x("fitToText"));p.click(x("runToEdge"));w.click(x("narrow"));y.click(x("widen"));d.click(x("centerOnScreen"));b.click(x("fullscreen"));q.click(function(){l.toggle()})});return{echoesToDisregard:{},
editorFor:function(b){var a=boardContent.multiWordTexts[b.identity];a||(a=boardContent.multiWordTexts[b.identity]=b);if(!a.doc){var d=b.author==UserSettings.getUsername();a.doc=carota.editor.create($("<div />",{id:sprintf("t_%s",b.identity)}).appendTo($("#textInputInvisibleHost"))[0],board[0],d?function(){render(boardContent)}:c);d&&(a.doc.contentChanged(function(){var b=boardContent.multiWordTexts[a.identity];b.privacy=Privacy.getCurrentPrivacy();b.target="presentationSpace";b.slide=Conversations.getCurrentSlideJid();
0<a.doc.save().length&&sendRichText(b);Progress.call("onSelectionChanged",[Modes.select.selected])}),a.doc.selectionChanged(function(b){b=b();f.toggleClass("active",1==b.bold);h.toggleClass("active",1==b.italic);n.toggleClass("active",1==b.underline);k.val(b.size||carota.runs.defaultFormatting.size);g.val(b.font||carota.runs.defaultFormatting.font);u.val(b.color||carota.runs.defaultFormatting.color);t.val(b.align||carota.runs.defaultFormatting.align)}))}a.doc.position={x:b.x,y:b.y};a.doc.width(b.width);
return a},draw:function(b){b&&b.doc&&carota.editor.paint(board[0],b.doc,!0)},activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.text;e("#textTools","#insertText");$(".activeBrush").removeClass("activeBrush");Progress.call("onLayoutUpdated");var b=Date.now(),a=function(b,a,d,c){var l=[c.x-10,c.y-10,c.x+10,c.y+10];b=_.take(_.values(boardContent.multiWordTexts).filter(function(b){return intersectRect(b.doc.calculateBounds(),l)&&b.author==UserSettings.getUsername()}));return 0<
b.length?b[0]:!1},d=function(b,a){var d={x:a.x-b.position.x,y:a.y-b.position.y};return{node:b.byCoordinate(d.x,d.y),relativePos:d}};registerPositionHandlers(board,function(b,c,l,q){if(b=a(b,c,l,q).doc)b.isActive=!0,b.caretVisible=!0,b.mousedownHandler(d(b,q).node)},function(b,c,l,q){(b=a(b,c,l,q).doc)&&b.mousemoveHandler(d(b,q).node)},function(c,l,q,h){var e=Date.now(),n=a(c,l,q,h);_.each(boardContent.multiWordTexts,function(b){b.doc.isActive=b.doc.identity==n.identity;0==b.doc.save().length&&delete boardContent.multiWordTexts[b.identity]});
n?(c=n.doc,h=d(c,h),500>=e-b&&c.dblclickHandler(h.node),b=e,e={multiWordTexts:{}},e.multiWordTexts[n.identity]=n,Modes.select.setSelection(e),c.mouseupHandler(h.node)):(h=x(h),c=h.doc,c.load([]),c.select(0,0),e={multiWordTexts:{}},e.multiWordTexts[h.identity]=boardContent.multiWordTexts[h.identity],Modes.select.setSelection(e),c.mouseupHandler(c.byOrdinal(0)));Progress.historyReceived.ClearMultiTextEchoes=function(){Modes.text.echoesToDisregard={}};Progress.call("onSelectionChanged",[Modes.select.selected])})},
deactivate:function(){Modes.select.clearSelection();a();l.hide();unregisterPositionHandlers(board);blit()}}}(),image:function(){var c={},g=void 0,k=void 0,u=function(){g.hide();var a=k.wrap("<form>").closest("form").get(0);void 0!=a&&a.reset();k.unwrap()},f=function(){if("imageDefinition"==c.type){WorkQueue.pause();var a=Date.now(),h=sprintf("%s%s",UserSettings.getUsername(),a),e=Conversations.getCurrentSlideJid(),h=sprintf("/uploadDataUri?jid=%s&filename=%s",e.toString(),encodeURI(h));$.ajax({url:h,
type:"POST",success:function(h){var g=$(h).find("resourceUrl").text(),k={type:"image",author:UserSettings.getUsername(),timestamp:a,tag:'{"author":"'+UserSettings.getUsername()+'","privacy":"'+Privacy.getCurrentPrivacy()+'","id":"'+g+'","isBackground":false,"zIndex":0,"timestamp":-1}',identity:g,slide:e.toString(),source:$(h).text(),width:c.width,height:c.height,target:"presentationSpace",privacy:Privacy.getCurrentPrivacy(),x:c.x,y:c.y};updateTracking(g,function(){var a=Math.min(k.x,viewboxX),b=Math.min(k.y,
viewboxY),c=Math.max(k.x+k.width,viewboxWidth),l=Math.max(k.y+k.height,viewboxHeight);Modes.select.activate();Modes.select.selected.images[k.identity]=k;IncludeView.specific(a,b,c+50,l+50)});sendStanza(k);u();WorkQueue.gracefullyResume()},error:function(a){console.log(a);u();alert("Upload failed.  This image cannot be processed, either because of image protocol issues or because it exceeds the maximum image size.");WorkQueue.gracefullyResume()},data:c.resizedImage,cache:!1,contentType:!1,processData:!1})}},
h=!1;$(function(){h||(h=!0,g=$("#imageInsertOptions").css({position:"absolute",left:0,top:0}),$("#imageInsertOptionsClose").click(Modes.select.activate),k=$("#imageFileChoice").attr("accept","image/*"),k[0].addEventListener("change",function(a){a=(a.target.files||a.dataTransfer.files)[0];0==a.type.indexOf("image")&&(c.fileUpload=a);a=new FileReader;a.onload=function(a){var h=new Image;h.onload=function(a){a=h.width;var e=h.height,n=$("<canvas/>");n.attr("width",a);n.attr("height",e);n.css({width:px(a),
height:px(e)});n[0].getContext("2d").drawImage(h,0,0,a,e);c.width=a;c.height=e;c.resizedImage=n[0].toDataURL();f()};h.src=a.target.result};a.readAsDataURL(c.fileUpload)},!1),u())});return{activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.image;e("#imageTools","#imageMode");var a=screenToWorld(10,10);c={type:"imageDefinition",screenX:10,screenY:10,x:a.x,y:a.y};Progress.call("onLayoutUpdated");g.show()},deactivate:function(){u();a()}}}(),pan:{name:"pan",activate:function(){updateStatus("PAN");
Modes.currentMode.deactivate();e("#panTools","#panMode");Modes.currentMode=Modes.pan;var a,g;registerPositionHandlers(board,function(e,u,f){takeControlOfViewbox();a=e;g=u},function(e,u,f){Pan.translate(-1*(e-a),-1*(u-g));a=e;g=u},function(a,c,e){})},deactivate:function(){a();unregisterPositionHandlers(board)}},select:function(){var c=!1,g=function(){Modes.select.selected={images:{},text:{},inks:{},multiWordTexts:{}};_.each(["resizeFree","resizeAspectLocked","manualMove"],function(a){delete Modes.canvasInteractables[a];
delete Progress.totalSelectionChanged[a];delete Progress.onSelectionChanged[a];delete Progress.onViewboxChanged[a]});Progress.call("onSelectionChanged",[Modes.select.selected])},k=_.debounce(function(){var a=!1;_.forEach(["images","texts","inks","highlighters","multiWordTexts"],function(c){var e="highlighters"==c?"inks":c;if(Modes&&Modes.select&&Modes.select.selected&&e in Modes.select.selected){var g=Modes.select.selected[e];_.forEach(g,function(p){g&&c in boardContent&&p.identity in boardContent[c]?
g[p.identity]=boardContent[c][p.identity]:(a=!0,"inks"==e?"highlighters"==c&&p.identity in g&&1==g[p.identity].isHighlighter?delete g[p.identity]:"inks"==c&&p.identity in g&&0==g[p.identity].isHighlighter&&delete g[p.identity]:delete g[p.identity])})}});a&&Progress.call("onSelectionChanged",[Modes.select.selected])},100),f=function(){if(void 0!=Modes.select.selected&&c){var a=Modes.select.selected;banContent(Conversations.getCurrentConversationJid(),Conversations.getCurrentSlideJid(),_.uniq(_.map(a.inks,
function(a){return a.identity})),_.uniq(_.map(a.texts,function(a){return a.identity})),_.uniq(_.map(a.multiWordTexts,function(a){return a.identity})),_.uniq(_.map(a.images,function(a){return a.identity})))}g()},z=function(){(c=Conversations.shouldModifyConversation()?!c:!1)?$("#administerContent").removeClass("disabledButton"):$("#administerContent").addClass("disabledButton");g()};Progress.onBoardContentChanged.ModesSelect=k;Progress.onViewboxChanged.ModesSelect=k;Progress.onSelectionChanged.ModesSelect=
function(a){a&&(Modes.select.selected=a,"images"in a&&0<_.size(a.images)||"inks"in a&&0<_.size(a.inks)||"texts"in a&&0<_.size(a.texts)||"multiWordTexts"in a&&0<_.size(a.multiWordTexts)?($("#delete").removeClass("disabledButton"),$("#resize").removeClass("disabledButton"),c?$("#ban").removeClass("disabledButton"):$("#ban").addClass("disabledButton")):($("#delete").addClass("disabledButton"),$("#resize").addClass("disabledButton"),$("#ban").addClass("disabledButton")),"Conversations"in window&&Conversations.shouldModifyConversation()?
($("#ban").show(),$("#administerContent").show()):($("#ban").hide(),$("#administerContent").hide()),c?$("#administerContent").removeClass("disabledButton"):$("#administerContent").addClass("disabledButton"),Modes.currentMode==Modes.select&&($("#selectionAdorner").empty(),_.forEach(boardContent.multiWordTexts,function(a){a.bounds=a.doc.calculateBounds()})))};Progress.historyReceived.ModesSelect=g;Progress.conversationDetailsReceived.ModesSelect=function(a){c&&Conversations.shouldModifyConversation()&&
(c=!1);Conversations.shouldModifyConversation()?($("#ban").show(),$("#administerContent").show(),$("#administerContent").bind("click",z),$("#ban").bind("click",f)):($("#ban").hide(),$("#administerContent").hide(),$("#administerContent").unbind("click"),$("#ban").unbind("click"));c?$("#administerContent").removeClass("disabledButton"):$("#administerContent").addClass("disabledButton")};return{name:"select",selected:{images:{},texts:{},inks:{},multiWordTexts:{}},resizeHandleSize:40,setSelection:function(a){Modes.select.clearSelection();
Modes.select.selected=_.merge(Modes.select.selected,a);Modes.select.addHandles()},addHandles:function(){var a=function(){var a=scale();return Modes.select.resizeHandleSize/a},c=a(),e=function(a){return function(b){a(b);blit()}},g=function(a){return function(){a();blit()}},p=function(){var d=function(b){if(!p.activated){b=b||Modes.select.totalSelectedBounds();var d=a(),c=b.x+d/2;p.bounds=[c-d/2,b.y-d,c+d/2,b.y]}};Progress.onSelectionChanged.manualMove=g(d);Progress.totalSelectionChanged.manualMove=
e(d);return{activated:!1,originalHeight:1,originalWidth:1,down:function(b){p.activated=!0;Modes.select.dragging=!0;Modes.select.resizing=!1;Modes.select.totalSelectedBounds();Modes.select.offset=b;Modes.select.marqueeWorldOrigin=b;blit();return!1},move:function(b){p.activated&&(p.bounds=[b.x-c,b.y,b.x+c,b.y],Modes.select.offset=b,blit());return!1},deactivate:function(){p.activated=!1;Modes.select.dragging=!1},up:function(b){p.deactivate();var a=batchTransform(),d=b.x-Modes.select.marqueeWorldOrigin.x;
b=b.y-Modes.select.marqueeWorldOrigin.y;a.xTranslate=d;a.yTranslate=b;a.inkIds=_.keys(Modes.select.selected.inks);a.textIds=_.keys(Modes.select.selected.texts);a.imageIds=_.keys(Modes.select.selected.images);a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);Modes.select.dragging=!1;sendStanza(a);blit();a=Modes.select.totalSelectedBounds();Progress.call("totalSelectionChanged",[{x:a.x+d,y:a.y+b,x2:a.x2+d,y2:a.y2+b}]);return!1},render:function(a){if(p.bounds){var d=worldToScreen(p.bounds[0],
p.bounds[1]),c=worldToScreen(p.bounds[2],p.bounds[3]).x-d.x,e=d.x,d=d.y;a.globalAlpha=.3;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.fillRect(e,d,c,c);a.strokeRect(e,d,c,c);a.font=sprintf("%spx FontAwesome",c);a.fillStyle="black";a.fillText("\uf047",e,d+c-4)}}}}(),k=function(){var d=function(b){if(!k.activated){b=b||Modes.select.totalSelectedBounds();var d=a(),c=b.x2;k.bounds=[c,b.y,c+d,b.y+d]}};Progress.onSelectionChanged.resizeAspectLocked=g(d);Progress.totalSelectionChanged.resizeAspectLocked=
e(d);return{activated:!1,originalHeight:1,originalWidth:1,down:function(a){k.activated=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();return!1},move:function(a){if(k.activated){k.bounds=[a.x-c,k.bounds[1],a.x+c,k.bounds[3]];var d=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x,y:d.y+(a.x-d.x)/(d.x2-d.x)*d.height};blit()}return!1},deactivate:function(){k.activated=!1;Modes.select.resizing=!1},up:function(a){k.deactivate();
var d=batchTransform(),c=Modes.select.totalSelectedBounds();d.xScale=(a.x-c.x)/(c.x2-c.x);d.yScale=d.xScale;d.xOrigin=c.x;d.yOrigin=c.y;d.inkIds=_.keys(Modes.select.selected.inks);d.textIds=_.keys(Modes.select.selected.texts);d.imageIds=_.keys(Modes.select.selected.images);d.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);sendStanza(d);a=Modes.select.totalSelectedBounds();Progress.call("totalSelectionChanged",[{x:a.x,y:a.y,x2:a.x+a.width*d.xScale,y2:a.y+a.height*d.yScale}]);blit();return!1},
render:function(a){if(k.bounds){var d=worldToScreen(k.bounds[0],k.bounds[1]),c=worldToScreen(k.bounds[2],k.bounds[3]).x-d.x,e=c/10,h=-1*c;a.globalAlpha=.3;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(d.x,d.y);a.rotate(90*Math.PI/180);a.fillRect(0,h,c,c);a.strokeRect(0,h,c,c);a.font=sprintf("%spx FontAwesome",c);a.fillStyle="black";a.fillText("\uf0b2",e,-1*e)}}}}(),f=function(){var d=function(b){if(!f.activated){b=b||Modes.select.totalSelectedBounds();var d=
a(),c=b.x2;f.bounds=[c,b.y2-d,c+d,b.y2]}};Progress.onSelectionChanged.resizeFree=g(d);Progress.totalSelectionChanged.resizeFree=e(d);return{activated:!1,down:function(a){f.activated=!0;Modes.select.dragging=!1;Modes.select.resizing=!0;a=Modes.select.totalSelectedBounds();Modes.select.offset={x:a.x2,y:a.y2};blit();return!1},move:function(a){f.activated&&(f.bounds=[a.x-c,a.y-c,a.x+c,a.y+c],Modes.select.offset={x:a.x,y:a.y},blit());return!1},deactivate:function(){f.activated=!1;Modes.select.resizing=
!1},up:function(a){f.deactivate();var d=batchTransform(),c=Modes.select.totalSelectedBounds(),e=c.y2-c.y,h=a.y-c.y;d.xScale=(a.x-c.x)/(c.x2-c.x);d.yScale=h/e;d.xOrigin=c.x;d.yOrigin=c.y;d.inkIds=_.keys(Modes.select.selected.inks);d.textIds=_.keys(Modes.select.selected.texts);d.imageIds=_.keys(Modes.select.selected.images);d.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts);a=Modes.select.totalSelectedBounds();Progress.call("totalSelectionChanged",[{x:a.x,y:a.y,x2:a.x+a.width*d.xScale,
y2:a.y+a.height*d.yScale}]);sendStanza(d);blit();return!1},render:function(a){if(f.bounds){var d=worldToScreen(f.bounds[0],f.bounds[1]),c=worldToScreen(f.bounds[2],f.bounds[3]).x-d.x,e=c/10,h=-1*c;a.globalAlpha=.3;a.setLineDash([]);a.strokeStyle="black";a.fillStyle="white";a.strokeWidth=2;a.translate(d.x,d.y);a.rotate(90*Math.PI/180);a.fillRect(0,h,c,c);a.strokeRect(0,h,c,c);a.font=sprintf("%spx FontAwesome",c);a.fillStyle="black";a.fillText("\uf065",e,-1*e)}}}}();m("manualMove",p);m("resizeFree",
f);m("resizeAspectLocked",k)},totalSelectedBounds:function(){var a={x:Infinity,y:Infinity,x2:-Infinity,y2:-Infinity},c=function(c){c=c.bounds;a.x=Math.min(a.x,c[0]);a.y=Math.min(a.y,c[1]);a.x2=Math.max(a.x2,c[2]);a.y2=Math.max(a.y2,c[3])};_.forEach(Modes.select.selected.inks,c);_.forEach(Modes.select.selected.texts,c);_.forEach(Modes.select.selected.images,c);_.forEach(Modes.select.selected.multiWordTexts,function(a){a.bounds=a.doc.calculateBounds();c(a)});a.width=a.x2-a.x;a.height=a.y2-a.y;a.tl=
worldToScreen(a.x,a.y);a.br=worldToScreen(a.x2,a.y2);return a},offset:{x:0,y:0},marqueeWorldOrigin:{x:0,y:0},resizing:!1,dragging:!1,clearSelection:g,activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.select;e("#selectTools","#selectMode");var a={x:0,y:0},k=$("<div/>",{id:"selectMarquee"}),m=$("#selectionAdorner");$("#delete").bind("click",function(){if(void 0!=Modes.select.selected){var a=batchTransform();a.isDeleted=!0;"inks"in Modes.select.selected&&(a.inkIds=_.keys(Modes.select.selected.inks));
"texts"in Modes.select.selected&&(a.textIds=_.keys(Modes.select.selected.texts));"images"in Modes.select.selected&&(a.imageIds=_.keys(Modes.select.selected.images));"multiWordTexts"in Modes.select.selected&&(a.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts));sendStanza(a)}g()});$("#administerContent").bind("click",z);$("#ban").bind("click",f);var v=function(a){a("images");a("texts");a("multiWordTexts");a("inks")};Modes.select.dragging=!1;Modes.select.resizing=!1;registerPositionHandlers(board,
function(c,e,g,d,b){Modes.select.resizing=!1;Modes.select.dragging=!1;a={x:c,y:e};Modes.select.marqueeWorldOrigin=d;if(!b.ctrl&&Infinity!=Modes.select.totalSelectedBounds().x){c=10/scale();var f=[d.x-c,d.y-c,d.x+c,d.y+c];Modes.select.dragging=_.some(["images","texts","inks","multiWordTexts"],function(a){return _.some(Modes.select.selected[a],function(a){return a?intersectRect(a.bounds,f):!1})})}Modes.select.dragging?(Modes.select.offset=d,updateStatus("SELECT -> DRAG")):Modes.select.resizing?updateStatus("SELECT -> RESIZE"):
(m.empty(),m.append(k),k.show(),updateMarquee(k,a,a))},function(c,e,g,d,b){c={x:c,y:e};Modes.select.offset=d;Modes.select.dragging?blit():Modes.select.resizing?blit():updateMarquee(k,a,c)},function(a,e,g,d,b){WorkQueue.gracefullyResume();a=d.x-Modes.select.marqueeWorldOrigin.x;e=d.y-Modes.select.marqueeWorldOrigin.y;15>Math.abs(a)+Math.abs(e)&&(Modes.select.dragging=!1);if(Modes.select.dragging)d=Modes.select.totalSelectedBounds(),Progress.call("totalSelectionChanged",[{x:d.x+a,y:d.y+e,x2:d.x2+a,
y2:d.y2+e}]),d=batchTransform(),d.xTranslate=a,d.yTranslate=e,d.inkIds=_.keys(Modes.select.selected.inks),d.textIds=_.keys(Modes.select.selected.texts),d.imageIds=_.keys(Modes.select.selected.images),d.multiWordTextIds=_.keys(Modes.select.selected.multiWordTexts),Modes.select.dragging=!1,sendStanza(d);else{Modes.select.clearSelection();d=rectFromTwoPoints(Modes.select.marqueeWorldOrigin,d,2);var h=[d.left,d.top,d.right,d.bottom],l={images:{},texts:{},inks:{},multiWordTexts:{}},f={},u={};v(function(a){$.each(boardContent[a],
function(b,d){if(!("bounds"in d)&&"type"in d)switch(d.type){case "text":prerenderText(d);break;case "image":prerenderImage(d);break;case "ink":prerenderInk(d);break;default:d.bounds=[NaN,NaN,NaN,NaN]}1<=overlapRect(h,d.bounds)&&(incrementKey(f,d.author),incrementKey(u,"any"),c?d.author!=UserSettings.getUsername()&&(l[a][d.identity]=d):d.author==UserSettings.getUsername()&&(l[a][d.identity]=d))})});$.each(boardContent.highlighters,function(a,b){intersectRect(b.bounds,h)&&(incrementKey(f,b.author),
c?b.author!=UserSettings.getUsername()&&(l.inks[b.identity]=b):b.author==UserSettings.getUsername()&&(l.inks[b.identity]=b))});v(function(a){$.each(l[a],function(b,d){b in Modes.select.selected[a]?delete Modes.select.selected[a][b]:Modes.select.selected[a][b]=d})});u.any?Modes.select.addHandles():Modes.select.selected=l;var z=sprintf("Selected %s images, %s texts, %s inks, %s rich texts ",_.keys(Modes.select.selected.images).length,_.keys(Modes.select.selected.texts).length,_.keys(Modes.select.selected.multiWordTexts).length,
_.keys(Modes.select.selected.inks).length);$.each(f,function(a,b){z+=sprintf("%s:%s ",a,b)});Progress.call("onSelectionChanged",[Modes.select.selected])}k.css({width:0,height:0}).hide();blit()})},deactivate:function(){unregisterPositionHandlers(board);a();g();$("#delete").unbind("click");$("#resize").unbind("click");$("#selectionAdorner").empty();$("#selectMarquee").hide();$("#administerContent").unbind("click");$("#ban").unbind("click")}}}(),zoom:{name:"zoom",activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.zoom;e("#zoomTools","#zoomMode");var a=$("<div />",{id:"zoomMarquee"}),g,k={x:0,y:0};registerPositionHandlers(board,function(e,f,h,n){takeControlOfViewbox();g=n;a.show();a.appendTo($("#selectionAdorner"));k={x:e,y:f};updateMarquee(a,k,k)},function(e,g,h,f){e={x:e,y:g};g=rectFromTwoPoints(e,k);h="left";f="top";e.x==g.left&&(h="right");e.y==g.top&&(f="bottom");e=aspectConstrainedRect(g,h,f);updateMarquee(a,{x:e.right,y:e.bottom},{x:e.left,y:e.top})},function(e,k,f,n){WorkQueue.gracefullyResume();
a.hide();e={x:contentOffsetX+n.x,y:contentOffsetY+n.y};k=rectFromTwoPoints(e,{x:contentOffsetX+g.x,y:contentOffsetY+g.y});2500>scale()*k.width*k.height||(f="left",n="top",e.x==k.left&&(f="right"),e.y==k.top&&(n="bottom"),e=aspectConstrainedRect(k,f,n),IncludeView.specific(e.left,e.top,e.width,e.height))})},deactivate:function(){a();$("#zoomMarquee").remove();unregisterPositionHandlers(board)}},feedback:function(){var c=function(){switch(currentBackstage){case "quizzes":$("#quizzesButton").addClass(active);
break;case "submissions":$("#submissionButton").addClass(active)}};Progress.onConversationJoin.setConversationRole=function(){c()};Progress.conversationDetailsReceived.respectNewPermissions=c;return{name:"feedback",activate:function(){Modes.currentMode.deactivate();Modes.currentMode=Modes.feedback;c();e("#feedbackTools","#feedbackMode");registerPositionHandlers(board,function(a,c,e,f){},function(a,c,e,f){},function(a,c,e,f){});c()},deactivate:function(){a();unregisterPositionHandlers(board);Progress.call("onLayoutUpdated")}}}(),
draw:function(){var c=Brushes.getDefaultBrushes(),g,f=!1,m=!1;return{name:"draw",brushes:_.map(c,function(a){return _.clone(a)}),activate:function(){boardContext.setLineDash([]);if(Modes.currentMode!=Modes.draw){Modes.currentMode.deactivate();Modes.currentMode=Modes.draw;var a=function(){},h=void 0,n=void 0,t=function(a){Modes.draw.brushes[a.index]=a};$(".activeBrush").removeClass("activeBrush");var v=function(){var d=$("#drawTools");_.each(d.find(".pen"),function(b,d){var c=Modes.draw.brushes[d],
e=$(b).css({color:c.color}).click(function(){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");g=c;t(c);Modes.draw.drawingAttributes=g;f=!1;a(c)});e.find(".widthIndicator").text(c.width);c==g&&e.addClass("activeBrush")})},a=function(d){var b=$("#colors .dots"),c=$("#sizes .dots"),e=Colors.getAllNamedColors(),f=Brushes.getAllBrushSizes();c.empty();f.map(function(b){var e=h.clone();c.append(e);e.click(function(){d.width=b;t(d);g=d;v();a(d)});var f=Canvas.circle(d.color,b,
50);b==d.width&&e.addClass("activeTool");e.prepend(f);f=b.toString()+"px";e.find(".sizeDotName").append(f)});b.empty();e.map(function(c){var e=n.clone();b.append(e);e.on("click",function(){d.color=c.rgb;g=d;t(d);v();a(d)});e.css("color",c.rgb);"rgb"in c&&c.rgb==d.color&&e.addClass("activeTool");var f=c.name;e.find(".colorDotName").append(f)});e=$("#setPenToHighlighter").unbind("click").on("click",function(){d.isHighlighter=!0;g=d;t(d);v();a(d)});f=$("#setPenToPen").unbind("click").on("click",function(){d.isHighlighter=
!1;g=d;t(d);v();a(d)});"isHighlighter"in g&&g.isHighlighter?(e.addClass("activeTool").addClass("active"),f.removeClass("activeTool").removeClass("active")):(f.addClass("activeTool").addClass("active"),e.removeClass("activeTool").removeClass("active"));Progress.call("onLayoutUpdated")};$("#resetPenButton").empty().text("reset pen").click(function(){var d=_.find(c,function(a){return a.id==g.id});void 0!=d&&(g.width=d.width,g.color=d.color,g.isHighlighter=d.isHighlighter,v(),a(g))});if(!m){m=!0;h=$("#penSize .sizeDot").clone();
n=$("#penColor .colorDot").clone();g=Modes.draw.brushes[0];v();a(g);Modes.draw.drawingAttributes=g;var p=$("#drawTools");p.find(".eraser").click(function(a){$(".activeBrush").removeClass("activeBrush");$(this).addClass("activeBrush");f=!0});p.find(".advancedTools").on("click",function(){a(g);showBackstage("customizeBrush")})}e("#drawTools","#drawMode");var w=[],y=[];$(".activeBrush").removeClass("activeBrush");f?$("#drawTools").find(".eraser").addClass("activeBrush"):_.each($("#drawTools").find(".pen"),
function(a,b){b+1==g.id&&$(a).addClass("activeBrush")});registerPositionHandlers(board,function(a,b,c,e,g){y=[];f||g.eraser||(boardContext.strokeStyle=Modes.draw.drawingAttributes.color,w=[a,b,256*c])},function(a,b,c,e,g){if(f||g.eraser){var h=[e.x-10,e.y-10,e.x+10,e.y+10];a=function(a){$.each(a,function(b,c){if(c.author==UserSettings.getUsername()&&intersectRect(c.bounds,h)){delete a[c.identity];y.push(c.identity);var d=c.bounds,e=worldToScreen(d[0],d[1]),d=worldToScreen(d[2],d[3]);boardContext.fillRect(e.x,
e.y,d.x-e.x,d.y-e.y)}})};boardContext.globalAlpha=.4;boardContext.fillStyle="red";a(boardContent.inks);a(boardContent.highlighters);boardContext.globalAlpha=1}else e=Modes.draw.drawingAttributes.width*c,boardContext.beginPath(),boardContext.lineCap="round",boardContext.lineWidth=e,e=_.takeRight(w,3),boardContext.moveTo(e[0],e[1]),boardContext.lineTo(a,b),boardContext.stroke(),w=w.concat([a,b,256*c])},function(a,b,c,e,g){f||g.eraser?(a=batchTransform(),a.isDeleted=!0,a.inkIds=y,sendStanza(a)):(e=Modes.draw.drawingAttributes.width*
c,boardContext.lineWidth=e,boardContext.beginPath(),boardContext.lineWidth=e,boardContext.lineCap="round",e=_.takeRight(w,3),boardContext.moveTo(e[0],e[1]),boardContext.lineTo(a,b),boardContext.stroke(),w=w.concat([a,b,256*c]),strokeCollected(w.join(" ")))})}},deactivate:function(){$(".activeBrush").removeClass("activeBrush");a();WorkQueue.gracefullyResume();unregisterPositionHandlers(board);"customizeBrushPopup"==window.currentBackstage&&window.hideBackstage()}}}(),erase:{activate:function(){Modes.currentMode.deactivate();
Modes.currentMode=Modes.erase;registerPositionHandlers(board,function(a,e,f,m){},function(a,e,f,m){},function(a,e,f,m){})},deactivate:function(){unregisterPositionHandlers(board)}}}}();
